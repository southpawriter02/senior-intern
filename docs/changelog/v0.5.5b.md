# v0.5.5b - Terminal Search Service

**Released**: 2026-01-18
**Parent**: v0.5.5 Polish & Integration

## Summary

Implementation of the terminal search service providing pattern matching, navigation, and viewport filtering for terminal buffer content.

## New Components

### Interface

| File | Location | Purpose |
|------|----------|---------|
| `ITerminalSearchService.cs` | `src/AIntern.Core/Interfaces/` | Service interface with 8 methods |

### Implementation

| File | Location | Purpose |
|------|----------|---------|
| `TerminalSearchService.cs` | `src/AIntern.Services/Terminal/` | Full implementation |

## Interface Methods

| Method | Description |
|--------|-------------|
| `SearchAsync` | Search buffer with query, state, options, and cancellation support |
| `IncrementalSearchAsync` | Convenience method for fresh searches with default options |
| `NavigateNext` | Navigate to next result with wrap-around |
| `NavigatePrevious` | Navigate to previous result with wrap-around |
| `NavigateToIndex` | Jump to specific result by index (clamped) |
| `NavigateToLine` | Find and navigate to nearest result on line |
| `ClearSearch` | Reset search state to empty |
| `ValidateRegexPattern` | Validate regex syntax before search |
| `GetVisibleResults` | Filter results to viewport for rendering |

## Key Features

### Search Modes
- **Plain text search** with `StringComparison.Ordinal` / `OrdinalIgnoreCase`
- **Regex search** with compiled patterns and timeout protection
- **Case sensitivity** toggle via `TerminalSearchState.CaseSensitive`
- **Scrollback inclusion** via `TerminalSearchState.IncludeScrollback`

### Background Execution
- Search runs on `Task.Run()` for responsive UI
- Cancellation check every 100 lines for responsiveness
- `CancellationToken` support throughout

### Result Limiting
- `MaxResults` prevents memory issues with large buffers
- Stops search early when limit reached
- Configurable per search via `TerminalSearchOptions`

### Navigation
- `WrapAround` support for circular navigation
- Index clamping prevents out-of-range errors
- Nearest-result finding by line index

### Validation
- Regex pattern validation before execution
- Error messages returned in state
- Timeout protection for complex patterns

## Files Modified

### TerminalBuffer Extensions

| Property/Method | Description |
|-----------------|-------------|
| `TotalLineCount` | Alias for TotalLines (search compatibility) |
| `FirstVisibleLine` | Index of first visible line |
| `VisibleLineCount` | Number of visible lines |
| `GetLineText(int)` | Get text by absolute line index |
| `GetLineTexts(int, int)` | Get range of line texts |
| `GetAllTextContent(bool)` | Get all buffer text |

### DI Registration

Updated `TerminalServiceExtensions.cs` to register:
```csharp
services.AddSingleton<ITerminalSearchService, TerminalSearchService>();
```

## Unit Tests

| Test Category | Count |
|---------------|-------|
| Query Validation | 3 |
| Plain Text Search | 4 |
| Regex Search | 2 |
| Results Limiting | 1 |
| Cancellation | 1 |
| Empty Buffer | 1 |
| State Updates | 2 |
| Incremental Search | 1 |
| NavigateNext | 4 |
| NavigatePrevious | 3 |
| NavigateToIndex | 3 |
| NavigateToLine | 1 |
| ClearSearch | 1 |
| ValidateRegexPattern | 5 |
| GetVisibleResults | 2 |
| **Total** | **36** |

## File Manifest

### Created Files

```
src/AIntern.Core/Interfaces/
└── ITerminalSearchService.cs

src/AIntern.Services/Terminal/
└── TerminalSearchService.cs

tests/AIntern.Services.Tests/Terminal/
└── TerminalSearchServiceTests.cs
```

### Modified Files

```
src/AIntern.Core/Models/Terminal/TerminalBuffer.cs
  - Added search support properties (TotalLineCount, FirstVisibleLine, VisibleLineCount)
  - Added GetLineText(), GetLineTexts(), GetAllTextContent() methods

src/AIntern.Services/Terminal/TerminalServiceExtensions.cs
  - Added ITerminalSearchService → TerminalSearchService registration
```

## Dependencies

- **From v0.5.5a**: TerminalSearchResult, TerminalSearchState, TerminalSearchOptions
- **From v0.5.1**: TerminalBuffer, TerminalLine

## Next Steps

- v0.5.5c: Terminal Search UI (search bar component, keyboard shortcuts)
