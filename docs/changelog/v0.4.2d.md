# v0.4.2d: Diff ViewModels

**Release Date:** January 16, 2026  
**Type:** Feature (Diff Engine)  
**Parent:** v0.4.2 Diff Engine

---

## Overview

v0.4.2d implements MVVM ViewModels for the diff viewer UI. These ViewModels serve as the bridge between the diff computation engine (v0.4.2a-c) and the UI layer, providing data binding, commands, and state management for side-by-side diff visualization.

---

## New Files

| File | Purpose | Lines |
|------|---------|-------|
| `DiffLineViewModel.cs` | Single line ViewModel with inline segments | ~200 |
| `DiffHunkViewModel.cs` | Hunk ViewModel with side-by-side alignment | ~270 |
| `DiffViewerViewModel.cs` | Main coordinator with navigation/actions | ~380 |

### Unit Tests
| File | Test Count |
|------|------------|
| `DiffLineViewModelTests.cs` | 18 |
| `DiffHunkViewModelTests.cs` | 11 |
| `DiffViewerViewModelTests.cs` | 34 |
| **Total** | **63** |

---

## Key Features

### 1. DiffViewerViewModel

Main coordinator with:
- **LoadDiffAsync** - Async diff loading from CodeBlock
- **Navigation Commands** - Next/Previous/First/Last/GoTo hunk
- **Toggle Commands** - Inline changes, word wrap, sync scroll, line numbers
- **Action Commands** - Apply, Reject, Copy
- **Events** - HunkNavigationRequested, ApplyRequested, RejectRequested

### 2. DiffHunkViewModel

Side-by-side alignment with:
- **BuildSideBySideLines** - Aligns Removed/Added line pairs
- **Placeholder Lines** - Maintains visual alignment
- **Inline Segment Integration** - Via IInlineDiffService

### 3. DiffLineViewModel

Presentation-ready model with:
- **Factory Methods** - `Placeholder()`, `FromDiffLine()`
- **Computed Properties** - `IsAdded`, `IsRemoved`, `Prefix`, `ChangeClass`
- **Inline Segment Access** - `GetSegmentAtColumn()`

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    ViewModel Hierarchy                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  DiffViewerViewModel                                             │
│    ├── Properties: DiffResult, FilePath, ShowInlineChanges, ... │
│    ├── Commands: NextHunk, PreviousHunk, ToggleInlineChanges,...│
│    ├── Events: HunkNavigationRequested, ApplyRequested          │
│    │                                                             │
│    └── ObservableCollection<DiffHunkViewModel> Hunks            │
│              │                                                   │
│              ├── OriginalLines: ObservableCollection<DiffLineVM>│
│              └── ProposedLines: ObservableCollection<DiffLineVM>│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Commands Summary

| Category | Commands |
|----------|----------|
| **Navigation** | NextHunk, PreviousHunk, FirstHunk, LastHunk, GoToHunk |
| **Toggle** | ToggleInlineChanges, ToggleWordWrap, ToggleSynchronizedScroll, ToggleLineNumbers |
| **Actions** | RequestApply, RequestReject, CopyProposed, CopyOriginal |

---

## DI Registration

```csharp
// Transient - each diff view gets independent state
services.AddTransient<DiffViewerViewModel>();
```

---

## Dependencies

| Version | Dependency |
|---------|------------|
| v0.4.2a | DiffResult, DiffHunk, DiffLine, DiffStats |
| v0.4.2b | IDiffService |
| v0.4.2c | IInlineDiffService, InlineSegment |
| CommunityToolkit.Mvvm | ObservableProperty, RelayCommand |

---

## Test Coverage

- **DiffLineViewModelTests**: Factory methods, computed properties, segment access
- **DiffHunkViewModelTests**: Construction, statistics, side-by-side building
- **DiffViewerViewModelTests**: Loading, navigation, toggles, events, clearing

---

## Next Steps

**v0.4.2e: Diff Viewer UI** - Avalonia controls for displaying diff results
