# Changelog v0.2.1d

**Release Date:** 2026-01-12

Repository layer implementation - establishing the data access pattern with full CRUD operations for all entities.

---

## Highlights

- Three repository interfaces defining complete CRUD operations
- Three repository implementations with EF Core and exhaustive logging
- Archive/unarchive and pin/unpin operations for conversations
- Message-level operations including GetMessagesAsync and DeleteMessageAsync
- Search functionality across all repositories
- 29 new unit tests with SQLite in-memory database

---

## Repository Interfaces

### IConversationRepository

**Location:** `src/AIntern.Data/Repositories/IConversationRepository.cs`

| Operation | Method | Description |
|-----------|--------|-------------|
| Create | `CreateAsync` | Creates a new conversation |
| Read | `GetByIdAsync`, `GetByIdWithMessagesAsync` | Retrieves with optional messages |
| Update | `UpdateAsync` | Updates conversation metadata |
| Delete | `DeleteAsync` | Deletes with cascade delete of messages |
| List | `GetRecentAsync`, `SearchAsync` | Paginated retrieval |
| Flags | `ArchiveAsync`, `UnarchiveAsync`, `PinAsync`, `UnpinAsync` | Soft delete and pinning |
| Messages | `AddMessageAsync`, `UpdateMessageAsync`, `DeleteMessageAsync` | Message-level operations |
| Stats | `GetMessageCountAsync`, `ExistsAsync` | Quick lookups |

---

### ISystemPromptRepository

**Location:** `src/AIntern.Data/Repositories/ISystemPromptRepository.cs`

| Operation | Method | Description |
|-----------|--------|-------------|
| Create | `CreateAsync` | Creates a new system prompt |
| Read | `GetByIdAsync`, `GetByNameAsync` | Retrieves by ID or unique name |
| Update | `UpdateAsync`, `IncrementUsageCountAsync` | Updates and usage tracking |
| Delete | `DeleteAsync` | Deletes if not in use |
| List | `GetAllAsync`, `GetByCategoryAsync`, `GetActiveAsync` | Filtered retrieval |
| Default | `GetDefaultAsync`, `SetDefaultAsync` | Default prompt management |
| Stats | `ExistsAsync` | Quick lookup |

---

### IInferencePresetRepository

**Location:** `src/AIntern.Data/Repositories/IInferencePresetRepository.cs`

| Operation | Method | Description |
|-----------|--------|-------------|
| Create | `CreateAsync` | Creates a new inference preset |
| Read | `GetByIdAsync`, `GetByNameAsync` | Retrieves by ID or unique name |
| Update | `UpdateAsync` | Updates preset parameters |
| Delete | `DeleteAsync` | Deletes if not built-in |
| List | `GetAllAsync` | Retrieves all presets |
| Default | `GetDefaultAsync`, `SetDefaultAsync` | Default preset management |
| Stats | `ExistsAsync` | Quick lookup |

---

## Repository Implementations

### ConversationRepository

**Location:** `src/AIntern.Data/Repositories/ConversationRepository.cs` (~430 lines)

**Features:**
- Full CRUD with eager loading options
- Automatic SequenceNumber assignment for messages
- Denormalized statistics updates (MessageCount, TotalTokenCount)
- Paginated recent conversations with archive/pin filtering

---

### SystemPromptRepository

**Location:** `src/AIntern.Data/Repositories/SystemPromptRepository.cs` (~350 lines)

**Features:**
- Unique name enforcement
- Usage count tracking
- Category-based filtering
- Single default prompt enforcement

---

### InferencePresetRepository

**Location:** `src/AIntern.Data/Repositories/InferencePresetRepository.cs` (~320 lines)

**Features:**
- Unique name enforcement
- Built-in preset protection
- Single default preset enforcement

---

## Files Changed

### New Files (6)

| Path | Lines | Description |
|------|-------|-------------|
| `src/AIntern.Data/Repositories/IConversationRepository.cs` | ~290 | Conversation repository interface |
| `src/AIntern.Data/Repositories/ISystemPromptRepository.cs` | ~230 | System prompt repository interface |
| `src/AIntern.Data/Repositories/IInferencePresetRepository.cs` | ~200 | Inference preset repository interface |
| `src/AIntern.Data/Repositories/ConversationRepository.cs` | ~430 | Conversation repository implementation |
| `src/AIntern.Data/Repositories/SystemPromptRepository.cs` | ~350 | System prompt repository implementation |
| `src/AIntern.Data/Repositories/InferencePresetRepository.cs` | ~320 | Inference preset repository implementation |

---

## Unit Tests

**Location:** `tests/AIntern.Data.Tests/Repositories/`

### Test Summary (29 tests)

| Repository | Count | Coverage |
|------------|-------|----------|
| ConversationRepositoryTests | 12 | CRUD, messages, archive, pin |
| SystemPromptRepositoryTests | 9 | CRUD, default, category |
| InferencePresetRepositoryTests | 8 | CRUD, default, built-in |

---

## Verification

### Build

```bash
dotnet build AIntern.sln
# Build succeeded. 0 Warning(s) 0 Error(s)
```

### Tests

```bash
dotnet test
# Total tests: 120
# Passed: 120
```

---

## Metrics

| Metric | Value |
|--------|-------|
| New Source Files | 6 |
| New Test Files | 3 |
| New Tests | 29 |
| Total Tests | 120 |
| Interface Methods | ~45 |
| Documentation Files | 1 |

---

## Next Steps

This release prepares for v0.2.1e which will add:

- DatabaseInitializer for migrations and seeding
- Built-in system prompts and inference presets
- Database backup before migrations
- Seed data verification
