# Changelog v0.2.2a

**Release Date:** 2026-01-12

Service layer for conversation persistence - establishing the bridge between UI and database with auto-save, event-driven updates, and domain model enhancements.

---

## Highlights

- DatabaseConversationService with full CRUD operations and auto-save
- 500ms debounced auto-save using System.Timers.Timer
- Thread-safe save operations via SemaphoreSlim
- Title auto-generation from first user message
- Bidirectional entity â†” domain model mapping
- Event-driven UI synchronization (3 events)
- Domain model updates for persistence tracking

---

## DatabaseConversationService

**Location:** `src/AIntern.Services/DatabaseConversationService.cs` (~790 lines)

### Features

| Feature | Description |
|---------|-------------|
| Auto-Save | 500ms debounce timer prevents excessive writes |
| Thread Safety | SemaphoreSlim(1,1) serializes save operations |
| Title Generation | Auto-generates from first user message (max 50 chars) |
| Entity Mapping | Converts between domain models and EF Core entities |
| Message Sync | Detects added/updated/removed messages on save |
| Exhaustive Logging | Entry/exit patterns with stopwatch timing |

### Interface Methods

| Category | Methods |
|----------|---------|
| State | `CurrentConversation`, `HasUnsavedChanges`, `HasActiveConversation` |
| Messages | `AddMessage`, `UpdateMessage`, `RemoveMessage`, `ClearConversation`, `GetMessages` |
| CRUD | `CreateNewConversationAsync`, `LoadConversationAsync`, `SaveCurrentConversationAsync`, `DeleteConversationAsync`, `RenameConversationAsync` |
| Flags | `ArchiveConversationAsync`, `UnarchiveConversationAsync`, `PinConversationAsync`, `UnpinConversationAsync` |
| List | `GetRecentConversationsAsync`, `SearchConversationsAsync` |

---

## Domain Model Updates

### Conversation.cs (Modified)

| Addition | Description |
|----------|-------------|
| `IsPersisted` | Tracks if saved to database |
| `HasUnsavedChanges` | Dirty flag for auto-save |
| `AddMessage()` | Assigns SequenceNumber, sets dirty |
| `UpdateMessage()` | Applies action, sets dirty |
| `RemoveMessage()` | Removes and re-sequences |
| `ClearMessages()` | Clears all messages |
| `LoadMessages()` | Internal: populates from DB |
| `MarkAsSaved()` | Internal: clears dirty flag |

### ChatMessage.cs (Modified)

| Addition | Description |
|----------|-------------|
| `SequenceNumber` | Ordering within conversation |

---

## New Models

### ConversationSummary

**Location:** `src/AIntern.Core/Models/ConversationSummary.cs`

Lightweight record for sidebar display with `GetDateGroup()` method.

### DateGroup Enum

**Location:** `src/AIntern.Core/Enums/DateGroup.cs`

Values: `Today`, `Yesterday`, `Previous7Days`, `Previous30Days`, `Older`

---

## Event Args

| Class | Event | Purpose |
|-------|-------|---------|
| `ConversationChangedEventArgs` | `ConversationChanged` | Created, Loaded, Saved, MessageAdded, etc. |
| `ConversationListChangedEventArgs` | `ConversationListChanged` | Sidebar refresh triggers |
| `SaveStateChangedEventArgs` | `SaveStateChanged` | Save progress UI indicators |

---

## Files Changed

### New Files (6)

| Path | Lines | Description |
|------|-------|-------------|
| `src/AIntern.Services/DatabaseConversationService.cs` | ~790 | Main service implementation |
| `src/AIntern.Core/Models/ConversationSummary.cs` | ~130 | Sidebar list model |
| `src/AIntern.Core/Enums/DateGroup.cs` | ~30 | Date grouping enum |
| `src/AIntern.Core/Events/ConversationChangedEventArgs.cs` | ~70 | State change events |
| `src/AIntern.Core/Events/ConversationListChangedEventArgs.cs` | ~70 | List refresh events |
| `src/AIntern.Core/Events/SaveStateChangedEventArgs.cs` | ~55 | Save progress events |

### Modified Files (4)

| Path | Change |
|------|--------|
| `src/AIntern.Core/Models/Conversation.cs` | Persistence tracking, message methods |
| `src/AIntern.Core/Models/ChatMessage.cs` | Added SequenceNumber |
| `src/AIntern.Core/Interfaces/IConversationService.cs` | Expanded with CRUD, list, flag operations |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | DatabaseConversationService registration |

### Removed Files (1)

| Path | Reason |
|------|--------|
| `src/AIntern.Services/ConversationService.cs` | Replaced by DatabaseConversationService |

---

## Unit Tests

### Updated Tests

**Location:** `tests/AIntern.Core.Tests/Models/ConversationTests.cs`

| Test | Description |
|------|-------------|
| `AddMessage_AddsToCollectionAndAssignsSequenceNumber` | Verifies SequenceNumber assignment |
| `RemoveMessage_ResequencesRemainingMessages` | Verifies re-sequencing |
| `MarkAsSaved_ClearsDirtyFlagAndSetsPersisted` | Verifies persistence flags |
| `LoadMessages_PopulatesMessagesOrderedBySequence` | Verifies ordering |

---

## Verification

### Build

```bash
dotnet build --warnaserror
# Build succeeded. 0 Warning(s) 0 Error(s)
```

### Tests

```bash
dotnet test
# Total tests: 120
# Passed: 120, Failed: 0, Skipped: 0
```

---

## Metrics

| Metric | Value |
|--------|-------|
| New Source Files | 6 |
| Modified Source Files | 4 |
| Removed Source Files | 1 |
| Lines Added | ~1,100 |
| Total Tests | 120 |

---

## Integration Notes

### DI Registration

```csharp
services.AddSingleton<IConversationService>(sp =>
{
    var scope = sp.CreateScope();
    return new DatabaseConversationService(
        scope.ServiceProvider.GetRequiredService<IConversationRepository>(),
        scope.ServiceProvider.GetRequiredService<ISystemPromptRepository>(),
        sp.GetRequiredService<ILogger<DatabaseConversationService>>());
});
```

### InternalsVisibleTo

Added to `AIntern.Core.csproj`:
- `AIntern.Core.Tests`
- `AIntern.Services`

---

## Next Steps

This completes the v0.2.2a service layer. v0.2.2b will add:

- Conversation sidebar ViewModel
- UI binding for conversation list
- Create/Load/Delete conversation commands
