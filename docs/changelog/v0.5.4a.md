# v0.5.4a: Command Block Models

**Date**: 2026-01-18

Implements the core model classes for command extraction, execution tracking, and terminal output capture.

## Added

### Value Types (Structs)
- **`TextRange`** - `readonly record struct` for character positions
  - Start, End properties (0-based)
  - Computed: Length, IsValid, IsEmpty
  - Methods: Extract(), Contains(), Overlaps(), Offset(), Union(), Intersect()

### Enumerations
- **`CommandBlockStatus`** - Command execution lifecycle states
  - Pending, Copied, SentToTerminal, Executing, Executed, Failed, Cancelled
  - Extensions: IsTerminal(), WasAttempted(), IsRunning(), CanExecute(), ToDisplayString(), ToIconName(), ToColorKey()

- **`OutputCaptureMode`** - Terminal output capture strategies
  - FullBuffer, LastCommand, Selection, LastNLines, Manual
  - Extensions: ToDescription(), GetDefaultMaxCharacters(), GetEstimatedMaxTokens(), RequiresUserInteraction()

### Reference Types (Classes)
- **`CommandBlock`** - Sealed class for executable commands from AI responses
  - Identity: Id, MessageId, SequenceNumber
  - Content: Command, Language, Description, WorkingDirectory
  - Detection: DetectedShellType, ConfidenceScore, IsPotentiallyDangerous, DangerWarning
  - Execution: Status, ExecutedAt, ExecutedInSessionId, OutputCaptureId
  - Source mapping: SourceRange (TextRange), ExtractedAt
  - Computed: IsMultiLine, LineCount, FirstLine, IsCompleted, CanRun, IsRunning
  - Methods: MarkCopied(), MarkSentToTerminal(), MarkExecuting(), MarkCompleted(), MarkCancelled(), ToDisplaySummary()

- **`TerminalOutputCapture`** - Sealed class for captured terminal output
  - Identity: Id, SessionId, SessionName, CommandBlockId
  - Content: Command, Output, IsTruncated, OriginalLength, ExitCode
  - Timing: StartedAt, CompletedAt, Duration
  - Context: WorkingDirectory, CaptureMode
  - Computed: EstimatedTokens, IsSuccess, LineCount, HasOutput
  - Methods: ToContextString(), ToSummary(), Truncate()

- **`CommandExtractionResult`** - Sealed class for extraction results
  - Collections: Commands, Warnings
  - Computed: HasCommands, CommandCount, DangerousCommandCount, HasDangerousCommands, HasWarnings, MultiLineCommandCount, AverageConfidence, DetectedShellTypes
  - Factory: Empty, Single(), From()
  - Methods: GetCommandsByShellType(), GetHighConfidenceCommands(), GetSafeCommands()

## Testing
- Added 6 test files with 62 new tests in `tests/AIntern.Core.Tests/Models/Terminal/`
- All 150 Core tests pass (100% pass rate)

## Files Changed

| File | Status |
|------|--------|
| `src/AIntern.Core/Models/Terminal/TextRange.cs` | Added |
| `src/AIntern.Core/Models/Terminal/CommandBlockStatus.cs` | Added |
| `src/AIntern.Core/Models/Terminal/OutputCaptureMode.cs` | Added |
| `src/AIntern.Core/Models/Terminal/CommandBlock.cs` | Added |
| `src/AIntern.Core/Models/Terminal/TerminalOutputCapture.cs` | Added |
| `src/AIntern.Core/Models/Terminal/CommandExtractionResult.cs` | Added |
| `tests/AIntern.Core.Tests/Models/Terminal/TextRangeTests.cs` | Added |
| `tests/AIntern.Core.Tests/Models/Terminal/CommandBlockStatusTests.cs` | Added |
| `tests/AIntern.Core.Tests/Models/Terminal/OutputCaptureModeTests.cs` | Added |
| `tests/AIntern.Core.Tests/Models/Terminal/CommandBlockTests.cs` | Added |
| `tests/AIntern.Core.Tests/Models/Terminal/TerminalOutputCaptureTests.cs` | Added |
| `tests/AIntern.Core.Tests/Models/Terminal/CommandExtractionResultTests.cs` | Added |

## Dependencies
- Uses existing `ShellType` enum from `IShellDetectionService.cs`
- No new external dependencies

## Next Steps
- **v0.5.4b**: Implement `ICommandExtractorService` for parsing commands from markdown
