# v0.4.2a: Diff Models

**Release Date:** January 16, 2026  
**Type:** Feature (Diff Engine Foundation)  
**Parent:** v0.4.2 Diff Engine

---

## Overview

v0.4.2a defines the foundational data models for representing computed diffs between original file content and LLM-proposed changes. These models form the core data structures used throughout the diff visualization and application workflow.

---

## New Files

### Core Models
| File | Purpose | Lines |
|------|---------|-------|
| `src/AIntern.Core/Models/DiffResult.cs` | Top-level diff container | ~180 |
| `src/AIntern.Core/Models/DiffHunk.cs` | Contiguous change group | ~145 |
| `src/AIntern.Core/Models/DiffLine.cs` | Individual line with enums | ~210 |
| `src/AIntern.Core/Models/InlineChange.cs` | Character-level change | ~105 |
| `src/AIntern.Core/Models/DiffStats.cs` | Summary statistics record | ~140 |

### Unit Tests
| File | Test Count |
|------|------------|
| `tests/AIntern.Core.Tests/Models/DiffResultTests.cs` | 15 |
| `tests/AIntern.Core.Tests/Models/DiffHunkTests.cs` | 10 |
| `tests/AIntern.Core.Tests/Models/DiffLineTests.cs` | 13 |
| `tests/AIntern.Core.Tests/Models/InlineChangeTests.cs` | 6 |
| `tests/AIntern.Core.Tests/Models/DiffStatsTests.cs` | 17 |
| **Total** | **61** |

---

## Key Features

### 1. DiffResult

Top-level container for diff computation:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ DiffResult                                                               │
│  Id: Guid                                                               │
│  OriginalFilePath: string                                               │
│  OriginalContent / ProposedContent: string                              │
│  Hunks: IReadOnlyList<DiffHunk>                                         │
│  Stats: DiffStats                                                       │
│  IsNewFile, IsDeleteFile, IsBinaryFile: bool                            │
│  SourceBlockId: Guid? (links to CodeBlock from v0.4.1)                  │
└─────────────────────────────────────────────────────────────────────────┘
```

**Static Factories:**
- `NoChanges(path, content)` - identical files
- `NewFile(path, content, hunks, stats)` - file creation
- `DeleteFile(path, original, hunks, stats)` - file deletion
- `BinaryFile(path)` - non-diffable binary

**Computed Properties:**
- `HasChanges` - any actual differences exist
- `IsApplicable` - can be applied (not binary + has changes)
- `FileName` - extracted from path

---

### 2. DiffHunk

Contiguous group of changes with unified diff header:

```
@@ -10,5 +10,7 @@ public void ProcessData()
 context line
-removed line
+added line
+another added line
 context line
```

**Properties:**
- `OriginalStartLine`, `OriginalLineCount` (1-based)
- `ProposedStartLine`, `ProposedLineCount` (1-based)
- `Lines: IReadOnlyList<DiffLine>`
- `ContextHeader: string?` (function/class name)

**Computed:**
- `Header` - "@@ -start,count +start,count @@"
- `FullHeader` - includes context if available
- `AddedLines`, `RemovedLines`, `ModifiedLines` - filtered enumerables
- `IsInsertOnly`, `IsDeleteOnly` - pure operation detection

---

### 3. DiffLine

Individual line with change classification:

| Property | Type | Description |
|----------|------|-------------|
| OriginalLineNumber | int? | null if added |
| ProposedLineNumber | int? | null if removed |
| Content | string | line text |
| Type | DiffLineType | classification |
| InlineChanges | IReadOnlyList? | character diffs |
| PairedLine | DiffLine? | for modifications |

**DiffLineType Enum:**
- `Unchanged` (prefix: ` `)
- `Added` (prefix: `+`)
- `Removed` (prefix: `-`)
- `Modified` (prefix: `~`)

**DiffSide Enum:**
- `Original` - left side
- `Proposed` - right side

---

### 4. InlineChange

Character-level changes within modified lines:

```
Original: "var count = 10;"
Proposed: "var count = 20;"

InlineChanges: [Removed(12, "10"), Added(12, "20")]
```

| Property | Type | Description |
|----------|------|-------------|
| StartColumn | int | 0-based position |
| Length | int | span length |
| Text | string | changed text |
| Type | InlineChangeType | Added/Removed/Unchanged |

**Computed:**
- `EndColumn` - StartColumn + Length
- `IsChange` - not unchanged

---

### 5. DiffStats

Summary statistics record with value equality:

| Property | Description |
|----------|-------------|
| TotalLines | sum of all |
| AddedLines | additions only |
| RemovedLines | deletions only |
| ModifiedLines | modifications |
| UnchangedLines | context |

**Computed:**
- `NetChange` - added - removed
- `ChangePercentage` - (changed / total) * 100
- `ChangedLines` - added + removed + modified
- `Summary` - "+5 -2 ~1" format
- `VerboseSummary` - "5 additions, 2 deletions" format
- `HasChanges` - any non-zero change count

---

## Model Relationships

```
DiffResult ──────────────┬──────────────── DiffStats (1:1)
     │                   │
     │ Hunks (1:N)       │
     ▼                   │
DiffHunk ─────────────── │
     │                   │
     │ Lines (1:N)       │
     ▼                   │
DiffLine ─────────────── │
     │                   │
     │ InlineChanges     │
     │ (optional 1:N)    │
     ▼                   │
InlineChange ────────────┘
```

---

## Test Coverage

| Test Category | Count | Coverage |
|---------------|-------|----------|
| DiffResultTests | 15 | All factories + computed props |
| DiffHunkTests | 10 | Headers + line filtering |
| DiffLineTests | 13 | All types + static factories |
| InlineChangeTests | 6 | Column math + factories |
| DiffStatsTests | 17 | All computed + record equality |
| **Total** | **61** | |

---

## Dependencies

| Dependency | Usage |
|------------|-------|
| v0.4.1a | `SourceBlockId` links to `CodeBlock` |

---

## Breaking Changes

None - v0.4.2a is purely additive.

---

## Next Steps

- **v0.4.2b: Diff Service** - Create `IDiffService` interface and DiffPlex-based implementation
