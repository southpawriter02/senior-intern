# v0.2.5a - FTS5 Search Infrastructure

**Release Date:** 2026-01-13
**Type:** Feature (Data Layer Infrastructure)
**Status:** Complete

## Overview

This release implements SQLite FTS5 (Full-Text Search 5) infrastructure for efficient full-text search across conversations and messages. The infrastructure includes FTS5 virtual tables, synchronization triggers, search models, and DbContext methods for querying.

**Building on:** v0.2.4e (Chat Integration)
**Design Reference:** [v0.2.5a-fts5-search-infrastructure.md](../design/v0.2.x/v0.2.5a-fts5-search-infrastructure.md)

## Architecture

```
+------------------------------------------------------------------+
|                      Search Infrastructure                         |
+------------------------------------------------------------------+
|                                                                    |
|  +----------------------+     +--------------------------------+   |
|  |   Search Models      |     |       AInternDbContext         |   |
|  |  (AIntern.Core)      |     |       (AIntern.Data)           |   |
|  +----------------------+     +--------------------------------+   |
|  | SearchResultType     |     | EnsureFts5TablesAsync()        |   |
|  | SearchResult         |<--->| RebuildFts5IndexesAsync()      |   |
|  | SearchQuery          |     | SearchAsync(SearchQuery)       |   |
|  | SearchResults        |     +--------------------------------+   |
|  +----------------------+                   |                      |
|                                             v                      |
|  +----------------------------------------------------------+     |
|  |                    SQLite FTS5 Layer                       |     |
|  +----------------------------------------------------------+     |
|  | ConversationsFts (Title)  |  MessagesFts (Content)        |     |
|  |---------------------------|-------------------------------|     |
|  | trg_conversations_insert  |  trg_messages_insert          |     |
|  | trg_conversations_update  |  trg_messages_update          |     |
|  | trg_conversations_delete  |  trg_messages_delete          |     |
|  +----------------------------------------------------------+     |
|                                                                    |
+------------------------------------------------------------------+
```

## FTS5 Concepts

### What is FTS5?

FTS5 (Full-Text Search 5) is SQLite's advanced full-text search engine that provides:

| Feature | Description |
|---------|-------------|
| **Tokenized Indexing** | Text is split into tokens (words) for efficient searching |
| **BM25 Ranking** | Industry-standard relevance algorithm (lower scores = better matches) |
| **Boolean Operators** | Support for AND, OR, NOT in queries |
| **Prefix Matching** | Search for words starting with a prefix (e.g., `hel*`) |
| **Phrase Search** | Find exact phrases with quotes (e.g., `"hello world"`) |

### External Content Tables

We use the "external content" pattern where FTS5 indexes reference existing tables:

```sql
CREATE VIRTUAL TABLE ConversationsFts USING fts5(
    Title,                  -- Column to index
    content='Conversations', -- Source table
    content_rowid='rowid'   -- Row ID mapping
);
```

**Benefits:**
- No data duplication (FTS stores only index, not content)
- Source tables remain single source of truth
- Efficient storage usage

**Trade-off:**
- Requires triggers to maintain synchronization

### BM25 Ranking

BM25 (Best Matching 25) is a probabilistic ranking function:

| Score Range | Interpretation |
|-------------|----------------|
| -10.0 to -5.0 | Excellent match |
| -5.0 to -2.0 | Good match |
| -2.0 to 0.0 | Fair match |
| > 0.0 | Poor match |

**Note:** Lower (more negative) scores indicate better matches.

## Files Created

### 1. SearchResultType.cs

**Path:** `src/AIntern.Core/Enums/SearchResultType.cs`
**Lines:** ~50

Enum specifying the type of entity matched in a search result.

```csharp
public enum SearchResultType
{
    /// <summary>Search result matches a conversation title.</summary>
    Conversation,

    /// <summary>Search result matches message content.</summary>
    Message
}
```

### 2. SearchResult.cs

**Path:** `src/AIntern.Core/Models/SearchResult.cs`
**Lines:** ~120

Record representing a single full-text search result.

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique identifier for this result |
| `ResultType` | `SearchResultType` | Conversation or Message |
| `Title` | `string` | Display title |
| `Preview` | `string` | Snippet with highlighted matches |
| `Rank` | `double` | BM25 relevance score (lower = better) |
| `Timestamp` | `DateTime` | When entity was last updated |
| `ConversationId` | `Guid` | Conversation ID (always set) |
| `MessageId` | `Guid?` | Message ID (null for conversations) |

#### Computed Properties

| Property | Returns | Description |
|----------|---------|-------------|
| `IsConversationResult` | `bool` | True if conversation match |
| `IsMessageResult` | `bool` | True if message match |
| `TypeLabel` | `string` | "Conversation" or "Message" |
| `FormattedRank` | `string` | Rank formatted to 2 decimal places |
| `FormattedTimestamp` | `string` | Short date/time format |

### 3. SearchQuery.cs

**Path:** `src/AIntern.Core/Models/SearchQuery.cs`
**Lines:** ~150

Record encapsulating search query parameters.

#### Constructor Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `QueryText` | `string` | (required) | Search term(s) |
| `MaxResults` | `int` | 50 | Maximum results to return |
| `IncludeConversations` | `bool` | true | Search conversation titles |
| `IncludeMessages` | `bool` | true | Search message content |
| `MinRank` | `double` | -10.0 | Minimum BM25 threshold |

#### Factory Methods

| Method | Description |
|--------|-------------|
| `Simple(queryText)` | Default search (both types) |
| `ConversationsOnly(queryText)` | Search only conversations |
| `MessagesOnly(queryText)` | Search only messages |

#### Computed Properties

| Property | Returns | Description |
|----------|---------|-------------|
| `IsValid` | `bool` | True if non-empty query |
| `NormalizedQueryText` | `string` | Trimmed query text |
| `HasContentTypeFilter` | `bool` | True if any filter enabled |
| `LogSummary` | `string` | Formatted for logging |

### 4. SearchResults.cs

**Path:** `src/AIntern.Core/Models/SearchResults.cs`
**Lines:** ~130

Record encapsulating complete search operation results.

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Results` | `IReadOnlyList<SearchResult>` | Ordered results |
| `TotalCount` | `int` | Total matches found |
| `Query` | `SearchQuery` | Original query |
| `SearchDuration` | `TimeSpan` | Execution time |

#### Static Methods

| Method | Description |
|--------|-------------|
| `Empty(query)` | Creates empty result set |

#### Computed Properties

| Property | Returns | Description |
|----------|---------|-------------|
| `HasResults` | `bool` | True if any results |
| `HasMoreResults` | `bool` | True if truncated |
| `TruncatedCount` | `int` | Results beyond limit |
| `ConversationResultCount` | `int` | Count by type |
| `MessageResultCount` | `int` | Count by type |
| `SearchDurationMs` | `double` | Duration in ms |
| `Summary` | `string` | Human-readable summary |

## Files Modified

### 1. AInternDbContext.cs

**Path:** `src/AIntern.Data/AInternDbContext.cs`
**Lines Added:** ~500

Major additions to support FTS5 search infrastructure.

#### New Using Statements

```csharp
using AIntern.Core.Enums;
using AIntern.Core.Models;
using Microsoft.Data.Sqlite;
```

#### FTS5 SQL Constants Region

Contains SQL statements for creating FTS5 infrastructure:

| Constant | Purpose |
|----------|---------|
| `CreateConversationsFtsSql` | Create ConversationsFts virtual table |
| `CreateMessagesFtsSql` | Create MessagesFts virtual table |
| `CreateTrgConversationsInsertSql` | Trigger for conversation inserts |
| `CreateTrgConversationsUpdateSql` | Trigger for conversation updates |
| `CreateTrgConversationsDeleteSql` | Trigger for conversation deletes |
| `CreateTrgMessagesInsertSql` | Trigger for message inserts |
| `CreateTrgMessagesUpdateSql` | Trigger for message updates |
| `CreateTrgMessagesDeleteSql` | Trigger for message deletes |
| `RebuildConversationsFtsSql` | Rebuild conversations index |
| `RebuildMessagesFtsSql` | Rebuild messages index |

#### FTS5 Virtual Tables SQL

```sql
-- ConversationsFts: Indexes conversation titles
CREATE VIRTUAL TABLE IF NOT EXISTS ConversationsFts USING fts5(
    Title,
    content='Conversations',
    content_rowid='rowid'
);

-- MessagesFts: Indexes message content
CREATE VIRTUAL TABLE IF NOT EXISTS MessagesFts USING fts5(
    Content,
    content='Messages',
    content_rowid='rowid'
);
```

#### Synchronization Triggers SQL

```sql
-- Example: Conversations INSERT trigger
CREATE TRIGGER IF NOT EXISTS trg_conversations_fts_insert
AFTER INSERT ON Conversations
BEGIN
    INSERT INTO ConversationsFts(rowid, Title)
    VALUES (NEW.rowid, NEW.Title);
END;

-- Similar triggers for UPDATE and DELETE on both tables
```

#### New Public Methods

##### EnsureFts5TablesAsync

```csharp
public async Task EnsureFts5TablesAsync(CancellationToken cancellationToken = default)
```

Creates FTS5 virtual tables and synchronization triggers. Idempotent (safe to call multiple times).

**Actions:**
1. Creates ConversationsFts virtual table
2. Creates MessagesFts virtual table
3. Creates 6 synchronization triggers

##### RebuildFts5IndexesAsync

```csharp
public async Task RebuildFts5IndexesAsync(CancellationToken cancellationToken = default)
```

Rebuilds FTS5 indexes from source table data. Use after initial setup or if indexes become corrupted.

##### SearchAsync

```csharp
public async Task<SearchResults> SearchAsync(
    SearchQuery query,
    CancellationToken cancellationToken = default)
```

Executes full-text search with BM25 ranking.

**Query Processing Flow:**

```
SearchAsync called
    |
    v
Validate query (IsValid, HasContentTypeFilter)
    |
    +-- Invalid --> Return SearchResults.Empty()
    |
    v
EscapeFts5Query(query.NormalizedQueryText)
    |
    v
Search ConversationsFts (if IncludeConversations)
    |
    v
Search MessagesFts (if IncludeMessages)
    |
    v
Merge, sort by Rank ASC, take MaxResults
    |
    v
Return SearchResults
```

#### Private Helper Methods

| Method | Description |
|--------|-------------|
| `SearchConversationsAsync` | Query ConversationsFts with BM25 |
| `SearchMessagesAsync` | Query MessagesFts with snippet() |
| `EscapeFts5Query` | Escape special FTS5 characters |

#### Query Escaping Strategy

```csharp
private static string EscapeFts5Query(string query)
{
    // Single word: add wildcard for prefix matching
    // "hello" -> "hello*"

    // Multi-word: wrap in quotes for phrase matching
    // "hello world" -> "\"hello world\""
}
```

## SQL Statements Reference

### Search Query (Conversations)

```sql
SELECT c.Id, c.Title, c.UpdatedAt, bm25(ConversationsFts) as Rank
FROM ConversationsFts
INNER JOIN Conversations c ON ConversationsFts.rowid = c.rowid
WHERE ConversationsFts MATCH @query
  AND bm25(ConversationsFts) >= @minRank
ORDER BY Rank ASC
LIMIT @maxResults
```

### Search Query (Messages)

```sql
SELECT m.Id, c.Title, m.Timestamp, m.ConversationId,
       bm25(MessagesFts) as Rank,
       snippet(MessagesFts, 0, '<mark>', '</mark>', '...', 32) as Preview
FROM MessagesFts
INNER JOIN Messages m ON MessagesFts.rowid = m.rowid
INNER JOIN Conversations c ON m.ConversationId = c.Id
WHERE MessagesFts MATCH @query
  AND bm25(MessagesFts) >= @minRank
ORDER BY Rank ASC
LIMIT @maxResults
```

### Index Rebuild

```sql
INSERT INTO ConversationsFts(ConversationsFts) VALUES('rebuild');
INSERT INTO MessagesFts(MessagesFts) VALUES('rebuild');
```

## Logging Specifications

All methods use exhaustive logging with Stopwatch timing:

| Marker | Level | Usage |
|--------|-------|-------|
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug | Significant state/action |
| `[SKIP]` | Debug | Early exit conditions |
| `[EXIT]` | Info | Method completion with duration |
| `[ERROR]` | Error | Exception handling |

### Example Log Output

```
[DEBUG] [ENTER] SearchAsync - Query='hello', Max=50, Conv=True, Msg=True, MinRank=-10
[DEBUG] [INFO] Escaped query: 'hello*'
[DEBUG] [INFO] Searching ConversationsFts
[DEBUG] [INFO] Found 2 conversation matches
[DEBUG] [INFO] Searching MessagesFts
[DEBUG] [INFO] Found 15 message matches
[INFO] [EXIT] SearchAsync - Found 17 results (2 conversations, 15 messages) in 5.23 ms
```

## Usage Examples

### Initialize FTS5 on Startup

```csharp
// In application startup
await dbContext.Database.EnsureCreatedAsync();
await dbContext.EnsureFts5TablesAsync();
await dbContext.RebuildFts5IndexesAsync(); // If existing data
```

### Execute Simple Search

```csharp
var results = await dbContext.SearchAsync(SearchQuery.Simple("machine learning"));

if (results.HasResults)
{
    foreach (var result in results.Results)
    {
        Console.WriteLine($"{result.TypeLabel}: {result.Title} (rank: {result.Rank})");
    }
    Console.WriteLine(results.Summary);
}
```

### Filter by Content Type

```csharp
// Search only conversations
var convOnly = await dbContext.SearchAsync(SearchQuery.ConversationsOnly("project"));

// Search only messages
var msgOnly = await dbContext.SearchAsync(SearchQuery.MessagesOnly("error handling"));

// Custom filters
var custom = await dbContext.SearchAsync(new SearchQuery(
    QueryText: "test",
    MaxResults: 20,
    IncludeConversations: true,
    IncludeMessages: false,
    MinRank: -5.0));
```

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | SearchResultType enum has Conversation and Message values | ✅ |
| AC-2 | SearchResult record has all 8 required properties | ✅ |
| AC-3 | SearchQuery record has all 5 properties with defaults | ✅ |
| AC-4 | SearchResults record has Results, TotalCount, Query, SearchDuration | ✅ |
| AC-5 | EnsureFts5TablesAsync creates 2 virtual tables | ✅ |
| AC-6 | EnsureFts5TablesAsync creates 6 triggers | ✅ |
| AC-7 | EnsureFts5TablesAsync is idempotent | ✅ |
| AC-8 | SearchAsync returns results for conversation titles | ✅ |
| AC-9 | SearchAsync returns results for message content | ✅ |
| AC-10 | SearchAsync respects MaxResults limit | ✅ |
| AC-11 | BM25 ranking orders by relevance | ✅ |
| AC-12 | Comprehensive XML documentation | ✅ |
| AC-13 | Exhaustive logging with markers | ✅ |
| AC-14 | Build passes with 0 errors, 0 warnings | ✅ |

## Dependencies

### Required

| Dependency | Version | Purpose |
|------------|---------|---------|
| SQLite | 3.35+ | FTS5 with external content support |
| Microsoft.EntityFrameworkCore.Sqlite | 8.0+ | Database access |
| Microsoft.Data.Sqlite | 8.0+ | Raw SQL command execution |

### Downstream (Future)

| Component | Version | Description |
|-----------|---------|-------------|
| ISearchService | v0.2.5b | Service layer abstraction |
| SearchViewModel | v0.2.5c | UI search functionality |
| Conversation search UI | v0.2.5d | Integration with sidebar |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Core/Enums/SearchResultType.cs` | Create | ~50 |
| `src/AIntern.Core/Models/SearchResult.cs` | Create | ~120 |
| `src/AIntern.Core/Models/SearchQuery.cs` | Create | ~150 |
| `src/AIntern.Core/Models/SearchResults.cs` | Create | ~130 |
| `src/AIntern.Data/AInternDbContext.cs` | Modify | +500 |
| `CHANGELOG.md` | Modify | +25 |
| **Total** | | **~975** |

## Next Steps

| Version | Description |
|---------|-------------|
| v0.2.5b | ISearchService interface and SearchService implementation |
| v0.2.5c | SearchViewModel and search UI components |
| v0.2.5d | Integration with conversation sidebar |
