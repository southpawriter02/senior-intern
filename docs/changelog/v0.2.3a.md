# v0.2.3a Changelog - Models & Repository

**Release Date:** 2026-01-13
**Version:** v0.2.3a
**Status:** Complete

---

## Overview

This release creates the domain models for inference parameters (`InferenceSettings`, `InferencePreset`), defines parameter constants for UI sliders (`ParameterConstants`), enhances the `InferencePresetEntity` with missing fields, and adds repository methods for category-based queries and usage tracking.

**Building on:** v0.2.2e (Polish & Edge Cases)
**Design Reference:** [v0.2.3a-models-repository.md](../design/v0.2.x/v0.2.3a-models-repository.md)

---

## New Files

### ParameterConstants.cs

**Path:** `src/AIntern.Core/ParameterConstants.cs`

Static constants defining valid ranges and defaults for all 7 inference parameters (~270 lines).

**Nested Classes:**
```csharp
public static class ParameterConstants
{
    public static class Temperature    // Min: 0.0f, Max: 2.0f, Default: 0.7f, Step: 0.1f
    public static class TopP           // Min: 0.0f, Max: 1.0f, Default: 0.9f, Step: 0.05f
    public static class TopK           // Min: 0, Max: 100, Default: 40, Step: 5
    public static class RepetitionPenalty // Min: 1.0f, Max: 2.0f, Default: 1.1f, Step: 0.05f
    public static class MaxTokens      // Min: 64, Max: 8192, Default: 2048, Step: 64
    public static class ContextSize    // Min: 512, Max: 32768, Default: 4096, Step: 512
    public static class Seed           // Min: -1, Max: int.MaxValue, Default: -1
}
```

**Usage:**
- UI slider configuration (min, max, step)
- Validation logic in `InferenceSettings.Validate()`
- Default values for new presets

---

### ValidationResult.cs

**Path:** `src/AIntern.Core/ValidationResult.cs`

Immutable record type for validation results (~130 lines).

**Public API:**
```csharp
public sealed record ValidationResult(bool IsValid, IReadOnlyList<string> Errors)
{
    // Factory methods
    public static ValidationResult Success { get; }
    public static ValidationResult Failure(params string[] errors)
    public static ValidationResult Failure(IReadOnlyList<string> errors)

    // Helper methods
    public string? FirstError { get; }
    public string GetAllErrors(string separator = "\n")
}
```

**Usage:**
```csharp
var options = new InferenceSettings { Temperature = 3.0f };
var result = options.Validate();

if (!result.IsValid)
{
    Console.WriteLine(result.GetAllErrors());
    // Output: "Temperature must be between 0 and 2. Current value: 3"
}
```

---

### InferenceSettings.cs

**Path:** `src/AIntern.Core/Models/InferenceSettings.cs`

Value object encapsulating all inference parameters with validation (~325 lines).

**Properties:**
```csharp
public sealed class InferenceSettings
{
    // Sampling Parameters
    public float Temperature { get; set; }        // 0.0-2.0, default 0.7
    public float TopP { get; set; }               // 0.0-1.0, default 0.9
    public int TopK { get; set; }                 // 0-100, default 40
    public float RepetitionPenalty { get; set; }  // 1.0-2.0, default 1.1
    public int Seed { get; set; }                 // -1 or 0+, default -1

    // Length Parameters
    public int MaxTokens { get; set; }            // 64-8192, default 2048
    public uint ContextSize { get; set; }         // 512-32768, default 4096

    // Methods
    public InferenceSettings Clone()
    public ValidationResult Validate()
}
```

**Clone Method:**
```csharp
public InferenceSettings Clone() => new()
{
    Temperature = Temperature,
    TopP = TopP,
    TopK = TopK,
    RepetitionPenalty = RepetitionPenalty,
    Seed = Seed,
    MaxTokens = MaxTokens,
    ContextSize = ContextSize
};
```

**Validation:**
- Checks all parameters against `ParameterConstants` ranges
- Returns `ValidationResult` with detailed error messages
- Used before applying inference settings

---

### InferencePreset.cs

**Path:** `src/AIntern.Core/Models/InferencePreset.cs`

Domain model representing a named configuration of inference options (~320 lines).

**Well-Known Preset IDs:**
```csharp
public static readonly Guid PrecisePresetId = new("00000001-0000-0000-0000-000000000001");
public static readonly Guid BalancedPresetId = new("00000001-0000-0000-0000-000000000002");
public static readonly Guid CreativePresetId = new("00000001-0000-0000-0000-000000000003");
public static readonly Guid LongFormPresetId = new("00000001-0000-0000-0000-000000000004");
public static readonly Guid CodeReviewPresetId = new("00000001-0000-0000-0000-000000000005");
```

**Properties:**
```csharp
public Guid Id { get; set; }
public string Name { get; set; }
public string? Description { get; set; }
public string? Category { get; set; }
public bool IsBuiltIn { get; set; }
public bool IsDefault { get; set; }
public int UsageCount { get; set; }
public DateTime CreatedAt { get; set; }
public DateTime UpdatedAt { get; set; }
public InferenceSettings Options { get; set; }
```

**Factory Method:**
```csharp
public static InferencePreset FromOptions(string name, InferenceSettings options)
{
    return new InferencePreset
    {
        Id = Guid.NewGuid(),
        Name = name,
        Options = options.Clone(),  // Clone to prevent external mutation
        IsBuiltIn = false,
        IsDefault = false,
        UsageCount = 0,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow
    };
}
```

**Entity Mapping:**
```csharp
public InferencePresetEntity ToEntity()
{
    // Flattens Options into entity properties
}

public static InferencePreset FromEntity(InferencePresetEntity entity)
{
    // Reconstructs Options from entity properties
}
```

---

## Modified Files

### InferencePresetEntity.cs

**Path:** `src/AIntern.Core/Entities/InferencePresetEntity.cs`

Added 3 new properties for seed, category, and usage tracking (~35 lines added).

**New Properties:**
```csharp
#region Sampling Parameters (after RepeatPenalty)

/// <summary>
/// Gets or sets the random seed for reproducible generation.
/// </summary>
/// <remarks>
/// -1: Use a random seed each generation (non-reproducible)
/// 0+: Use the specified seed for reproducible output
/// Default: -1 (random)
/// </remarks>
public int Seed { get; set; } = -1;

#endregion

#region Metadata (new region)

/// <summary>
/// Gets or sets the category for grouping presets.
/// </summary>
/// <remarks>
/// Categories help organize presets in the UI.
/// Common categories: "General", "Code", "Creative", "Technical"
/// Maximum length: 50 characters (enforced by EF Core config in v0.2.3a).
/// Null indicates no category assignment.
/// </remarks>
public string? Category { get; set; }

/// <summary>
/// Gets or sets the number of times this preset has been used.
/// </summary>
/// <remarks>
/// Incremented each time the preset is selected for a new message.
/// Used for analytics and "most used" sorting in the UI.
/// Default: 0
/// </remarks>
public int UsageCount { get; set; }

#endregion
```

---

### InferencePresetConfiguration.cs

**Path:** `src/AIntern.Data/Configurations/InferencePresetConfiguration.cs`

Added EF Core configuration for new columns and index (~60 lines added).

**New Constants:**
```csharp
public const int CategoryMaxLength = 50;
public const int DefaultSeed = -1;
public const int DefaultUsageCount = 0;
private const string IndexCategory = "IX_InferencePresets_Category";
```

**New Property Configurations:**
```csharp
// Seed parameter - controls reproducibility
builder.Property(ip => ip.Seed)
    .IsRequired()
    .HasDefaultValue(DefaultSeed)
    .HasComment("Random seed for reproducible generation. -1 = random each time, 0+ = reproducible.");

// Category for grouping
builder.Property(ip => ip.Category)
    .HasMaxLength(CategoryMaxLength)
    .HasComment("Optional category for organizing presets (e.g., 'General', 'Code', 'Creative').");

// Usage tracking
builder.Property(ip => ip.UsageCount)
    .IsRequired()
    .HasDefaultValue(DefaultUsageCount)
    .HasComment("Number of times this preset has been used for generation.");
```

**New Index:**
```csharp
// Index for category-based filtering (added in v0.2.3a).
builder.HasIndex(ip => ip.Category)
    .HasDatabaseName(IndexCategory);
```

---

### IInferencePresetRepository.cs

**Path:** `src/AIntern.Data/Repositories/IInferencePresetRepository.cs`

Added 3 new method signatures (~100 lines added).

**New Methods:**
```csharp
/// <summary>
/// Retrieves all inference presets in a specific category.
/// </summary>
Task<IReadOnlyList<InferencePresetEntity>> GetByCategoryAsync(
    string category,
    CancellationToken cancellationToken = default);

/// <summary>
/// Increments the usage count for a preset.
/// </summary>
Task IncrementUsageAsync(Guid id, CancellationToken cancellationToken = default);

/// <summary>
/// Seeds the built-in presets if none exist.
/// </summary>
Task SeedBuiltInPresetsAsync(CancellationToken cancellationToken = default);
```

---

### InferencePresetRepository.cs

**Path:** `src/AIntern.Data/Repositories/InferencePresetRepository.cs`

Implemented 3 new methods and updated DuplicateAsync (~200 lines added).

**GetByCategoryAsync:**
```csharp
public async Task<IReadOnlyList<InferencePresetEntity>> GetByCategoryAsync(
    string category,
    CancellationToken cancellationToken = default)
{
    var stopwatch = Stopwatch.StartNew();
    _logger.LogDebug("[ENTER] GetByCategoryAsync - Category: {Category}", category);

    var presets = await _context.InferencePresets
        .AsNoTracking()
        .Where(p => p.Category == category)
        .OrderBy(p => p.Name)
        .ToListAsync(cancellationToken);

    stopwatch.Stop();
    _logger.LogDebug(
        "[EXIT] GetByCategoryAsync - Category: {Category}, Count: {Count}, Duration: {DurationMs}ms",
        category, presets.Count, stopwatch.ElapsedMilliseconds);

    return presets;
}
```

**IncrementUsageAsync:**
```csharp
public async Task IncrementUsageAsync(Guid id, CancellationToken cancellationToken = default)
{
    // Uses ExecuteUpdateAsync for efficiency - no entity load required
    var affected = await _context.InferencePresets
        .Where(p => p.Id == id)
        .ExecuteUpdateAsync(setters => setters
            .SetProperty(p => p.UsageCount, p => p.UsageCount + 1)
            .SetProperty(p => p.UpdatedAt, DateTime.UtcNow),
            cancellationToken);

    if (affected == 0)
    {
        _logger.LogWarning("IncrementUsageAsync - Preset not found: {PresetId}", id);
    }
}
```

**SeedBuiltInPresetsAsync:**
- Idempotent: Only seeds if no built-in presets exist
- Creates 5 presets with well-known GUIDs
- Sets "Balanced" as default
- Full logging throughout

**Updated DuplicateAsync:**
```csharp
// Now includes Category, Seed, and UsageCount (reset to 0)
var duplicate = new InferencePresetEntity
{
    Id = Guid.NewGuid(),
    Name = newName,
    Description = source.Description,
    Category = source.Category,        // New
    Temperature = source.Temperature,
    TopP = source.TopP,
    TopK = source.TopK,
    RepeatPenalty = source.RepeatPenalty,
    Seed = source.Seed,                // New
    MaxTokens = source.MaxTokens,
    ContextSize = source.ContextSize,
    IsDefault = false,
    IsBuiltIn = false,
    UsageCount = 0                     // New (reset for duplicates)
};
```

---

### DatabaseInitializer.cs

**Path:** `src/AIntern.Data/DatabaseInitializer.cs`

Updated CreateDefaultInferencePresets to include new properties and 5th preset (~60 lines changed).

**Updated Presets:**
| Preset | Category | ID |
|--------|----------|-----|
| Balanced (default) | General | 00000001-0000-0000-0000-000000000002 |
| Precise | Code | 00000001-0000-0000-0000-000000000001 |
| Creative | Creative | 00000001-0000-0000-0000-000000000003 |
| Long-form | Technical | 00000001-0000-0000-0000-000000000004 |
| Code Review (new) | Code | 00000001-0000-0000-0000-000000000005 |

**Code Review Preset:**
```csharp
new()
{
    Id = new Guid("00000001-0000-0000-0000-000000000005"),
    Name = "Code Review",
    Description = "Optimized for code review and analysis. Low temperature for consistent feedback, extended context for reviewing larger files.",
    Category = "Code",
    Temperature = 0.3f,
    TopP = 0.85f,
    TopK = 30,
    RepeatPenalty = 1.1f,
    Seed = -1,
    MaxTokens = 2048,
    ContextSize = 8192,
    IsDefault = false,
    IsBuiltIn = true,
    UsageCount = 0
}
```

---

## Built-in Presets Summary

| Preset | Temperature | TopP | TopK | MaxTokens | Context | Category | Use Case |
|--------|-------------|------|------|-----------|---------|----------|----------|
| Balanced | 0.7 | 0.9 | 40 | 2048 | 4096 | General | Default, general use |
| Precise | 0.2 | 0.8 | 20 | 1024 | 4096 | Code | Factual, deterministic |
| Creative | 1.2 | 0.95 | 60 | 4096 | 8192 | Creative | Brainstorming, writing |
| Long-form | 0.7 | 0.9 | 40 | 8192 | 16384 | Technical | Detailed explanations |
| Code Review | 0.3 | 0.85 | 30 | 2048 | 8192 | Code | Code analysis |

---

## Parameter Constants Reference

| Parameter | Min | Max | Default | Step | Type |
|-----------|-----|-----|---------|------|------|
| Temperature | 0.0 | 2.0 | 0.7 | 0.1 | float |
| TopP | 0.0 | 1.0 | 0.9 | 0.05 | float |
| TopK | 0 | 100 | 40 | 5 | int |
| RepetitionPenalty | 1.0 | 2.0 | 1.1 | 0.05 | float |
| MaxTokens | 64 | 8192 | 2048 | 64 | int |
| ContextSize | 512 | 32768 | 4096 | 512 | uint |
| Seed | -1 | int.Max | -1 | - | int |

---

## Logging Specifications

All new code follows exhaustive logging patterns:

| Level | Format | Usage |
|-------|--------|-------|
| Debug | `[ENTER] MethodName - Param: {Value}` | Method entry with parameters |
| Debug | `[INFO] Description` | State changes, intermediate steps |
| Debug | `[SKIP] Reason` | Operations skipped (no-op conditions) |
| Debug | `[EXIT] MethodName - Result: {Value}, Duration: {Ms}ms` | Method exit with timing |
| Information | Description | User-visible actions, significant events |
| Warning | `[WARN] Description` | Recoverable issues, unexpected states |
| Error | `[ERROR] Description: {Message}` | Failures with exception details |

**Example Log Output:**
```
[ENTER] GetByCategoryAsync - Category: Code
[EXIT] GetByCategoryAsync - Category: Code, Count: 2, Duration: 15ms

[ENTER] IncrementUsageAsync - PresetId: 00000001-0000-0000-0000-000000000002
[EXIT] IncrementUsageAsync - PresetId: 00000001-0000-0000-0000-000000000002, Duration: 8ms

[ENTER] SeedBuiltInPresetsAsync
[SKIP] SeedBuiltInPresetsAsync - Built-in presets already exist, Duration: 5ms
```

---

## Entity-Domain Mapping

```
┌─────────────────────────────┐      ┌─────────────────────────────┐
│    InferencePresetEntity    │      │      InferencePreset        │
├─────────────────────────────┤      ├─────────────────────────────┤
│ Id                          │◄────►│ Id                          │
│ Name                        │◄────►│ Name                        │
│ Description                 │◄────►│ Description                 │
│ Category                    │◄────►│ Category                    │
│ Temperature                 │      │                             │
│ TopP                        │      │ Options.Temperature         │
│ TopK                        │◄────►│ Options.TopP                │
│ RepeatPenalty               │      │ Options.TopK                │
│ Seed                        │      │ Options.RepetitionPenalty   │
│ MaxTokens                   │      │ Options.Seed                │
│ ContextSize                 │      │ Options.MaxTokens           │
│ IsDefault                   │◄────►│ Options.ContextSize         │
│ IsBuiltIn                   │◄────►│ IsDefault                   │
│ UsageCount                  │◄────►│ IsBuiltIn                   │
│ CreatedAt                   │◄────►│ UsageCount                  │
│ UpdatedAt                   │◄────►│ CreatedAt                   │
└─────────────────────────────┘      │ UpdatedAt                   │
                                     └─────────────────────────────┘
```

**Note:** Entity uses `RepeatPenalty`, domain model uses `RepetitionPenalty` (mapped in ToEntity/FromEntity).

---

## Verification Checklist

| Check | Result |
|-------|--------|
| Build | 0 errors, 0 warnings |
| ParameterConstants accessible | All constants available |
| ValidationResult.Success | Returns cached successful result |
| ValidationResult.Failure | Returns result with errors |
| InferenceSettings defaults | All match ParameterConstants.X.Default |
| InferenceSettings.Clone() | Creates independent copy |
| InferenceSettings.Validate() | Catches out-of-range values |
| InferencePreset.FromOptions() | Clones options correctly |
| InferencePreset.ToEntity() | Flattens options to entity |
| InferencePreset.FromEntity() | Reconstructs options from entity |
| InferencePresetEntity.Seed | Property exists with default -1 |
| InferencePresetEntity.Category | Property exists, nullable |
| InferencePresetEntity.UsageCount | Property exists with default 0 |
| GetByCategoryAsync | Returns filtered presets |
| IncrementUsageAsync | Increases UsageCount by 1 |
| SeedBuiltInPresetsAsync | Creates 5 presets when none exist |
| DatabaseInitializer | Creates 5 presets with categories |

---

## Files Summary

| File | Action | Lines Changed |
|------|--------|---------------|
| `src/AIntern.Core/ParameterConstants.cs` | Created | ~270 |
| `src/AIntern.Core/ValidationResult.cs` | Created | ~130 |
| `src/AIntern.Core/Models/InferenceSettings.cs` | Created | ~325 |
| `src/AIntern.Core/Models/InferencePreset.cs` | Created | ~320 |
| `src/AIntern.Core/Entities/InferencePresetEntity.cs` | Modified | +35 |
| `src/AIntern.Data/Configurations/InferencePresetConfiguration.cs` | Modified | +60 |
| `src/AIntern.Data/Repositories/IInferencePresetRepository.cs` | Modified | +100 |
| `src/AIntern.Data/Repositories/InferencePresetRepository.cs` | Modified | +200 |
| `src/AIntern.Data/DatabaseInitializer.cs` | Modified | +60 |
| **Total** | | ~1,500 |

---

## Dependencies

- **Microsoft.EntityFrameworkCore** - DbContext, EF Core operations
- **Microsoft.Extensions.Logging** - ILogger for diagnostic output
- **System.Diagnostics** - Stopwatch for timing

---

## Next Steps

- **v0.2.3b**: Create InferenceSettingsViewModel with bindable properties
- **v0.2.3c**: Build ParameterSlider control and PresetSelector
- **v0.2.3d**: Wire UI to service layer with live preview
