# v0.5.5g - Shell Profile Editor

**Released:** 2026-01-19

## Summary

Implements the Shell Profile Editor dialog for creating and editing shell profiles with comprehensive validation, auto-detection, and environment variable management. Integrates with the Terminal Settings Panel to provide a complete profile editing workflow.

## Features

### ShellProfileEditorViewModel

- **Validation**: Real-time validation of profile name (required) and shell path (required, must exist)
- **Shell Detection**: Auto-detects shell type from path using `IShellDetectionService`
- **Version Detection**: Async version detection with loading indicator
- **Path Detection**: Find shell executables in system PATH via Detect button
- **Environment Variables**: Multiline KEY=VALUE parsing and formatting
- **Commands**: `Save`, `Cancel`, `BrowseShellPath`, `BrowseWorkingDirectory`, `DetectFromPath`, `ClearWorkingDirectory`, `AddEnvironmentVariable`
- **Events**: `SaveRequested`, `CancelRequested` for dialog result handling

### ShellProfileEditor.axaml

- **Modal Dialog**: 520x640 window, resizable (min 400x500), centered on owner
- **Profile Name Section**: Required field with validation error display
- **Shell Path Section**: Path input with Browse, Detect buttons; version display with loading indicator
- **Shell Type Section**: Dropdown with auto-detected selection, override capability
- **Arguments Section**: Shell startup arguments
- **Working Directory Section**: Browse and clear buttons, optional field
- **Environment Variables Section**: Multiline textbox with Add button, KEY=VALUE format
- **Options Section**: Login shell checkbox, ConPTY checkbox (Windows only)
- **Action Bar**: Cancel button (left), validation status (center), Save button (right, disabled when invalid)
- **Keyboard Shortcuts**: Escape to cancel

### ShellProfileEditor.axaml.cs

- **Lifecycle Management**: Subscribe/unsubscribe to ViewModel events on load/unload
- **Static ShowAsync**: Convenience method for showing dialog and returning result
- **Result Handling**: Close with profile on save, null on cancel
- **Keyboard Handling**: Escape key intercept for cancel

### TerminalSettingsPanel Integration

- Subscribes to `ProfileEditRequested` event from TerminalSettingsViewModel
- Opens ShellProfileEditor dialog for new or existing profiles
- Handles dialog result: updates profile on save, removes placeholder on cancel (for new profiles)
- Service resolution from DI container

## Files Changed

### New Files
| File | Description |
|------|-------------|
| `src/AIntern.Desktop/ViewModels/ShellProfileEditorViewModel.cs` | Editor ViewModel with validation, detection, and commands |
| `src/AIntern.Desktop/Views/ShellProfileEditor.axaml` | Modal dialog XAML layout |
| `src/AIntern.Desktop/Views/ShellProfileEditor.axaml.cs` | Dialog code-behind with lifecycle and result handling |
| `tests/AIntern.Desktop.Tests/ViewModels/ShellProfileEditorViewModelTests.cs` | Comprehensive unit tests (30+ tests) |

### Modified Files
| File | Changes |
|------|---------|
| `src/AIntern.Desktop/Views/TerminalSettingsPanel.axaml.cs` | Added profile editor integration with event handling |

## API Reference

### ShellProfileEditorViewModel

```csharp
// Constructor
public ShellProfileEditorViewModel(
    IShellDetectionService shellDetectionService,
    ILogger<ShellProfileEditorViewModel> logger)

// Loading
public void LoadProfile(ShellProfile profile)
public async Task InitializeNewProfileAsync()

// Profile retrieval
public ShellProfile GetProfile()

// Observable Properties
public string ProfileName { get; set; }
public string ShellPath { get; set; }
public ShellType ShellType { get; set; }
public string Arguments { get; set; }
public string WorkingDirectory { get; set; }
public string EnvironmentVariables { get; set; }
public bool IsLoginShell { get; set; }
public bool UseConPty { get; set; }
public bool IsValid { get; }
public bool IsEditMode { get; }
public bool IsBuiltIn { get; }
public string? NameError { get; }
public string? PathError { get; }
public string? DetectedVersion { get; }
public bool IsDetectingVersion { get; }
public string WindowTitle { get; }

// Events
public event EventHandler<ShellProfile>? SaveRequested;
public event EventHandler? CancelRequested;
```

### ShellProfileEditor

```csharp
// Static helper for showing dialog
public static async Task<ShellProfile?> ShowAsync(
    Window owner,
    ShellProfileEditorViewModel viewModel)
```

## Dependencies

- v0.5.5f: `TerminalSettingsViewModel`, `TerminalSettingsPanel`
- v0.5.3c: `ShellProfile` model
- v0.5.3a: `IShellDetectionService`, `ShellType`

## Testing

### ShellProfileEditorViewModelTests (30+ tests)

**Constructor Tests**
- `Constructor_NullShellDetectionService_ThrowsArgumentNullException`
- `Constructor_NullLogger_ThrowsArgumentNullException`
- `Constructor_ValidDependencies_CreatesInstance`
- `Constructor_InitializesShellTypesList`

**LoadProfile Tests**
- `LoadProfile_PopulatesAllFields`
- `LoadProfile_SetsIsEditModeTrue`
- `LoadProfile_BuiltInProfile_SetsIsBuiltInTrue`
- `LoadProfile_ParsesEnvironmentVariablesCorrectly`
- `LoadProfile_PreservesProfileId`
- `LoadProfile_EmptyEnvironment_HandlesGracefully`

**InitializeNewProfileAsync Tests**
- `InitializeNewProfileAsync_SetsDefaultShellPath`
- `InitializeNewProfileAsync_DetectsShellType`
- `InitializeNewProfileAsync_SetsIsEditModeFalse`

**Validation Tests**
- `Validate_EmptyName_SetsNameError`
- `Validate_WhitespaceOnlyName_SetsNameError`
- `Validate_EmptyShellPath_SetsPathError`
- `Validate_InvalidShellPath_SetsPathError`
- `Validate_ValidConfiguration_ClearsAllErrors`
- `Validate_ValidConfiguration_SetsIsValidTrue`

**Shell Detection Tests**
- `OnShellPathChanged_DetectsShellType`
- `OnShellPathChanged_StartsVersionDetection`
- `DetectVersionAsync_SetsDetectedVersion`
- `DetectFromPath_FindsExecutable`
- `DetectFromPath_NotFound_KeepsOriginalPath`

**GetProfile Tests**
- `GetProfile_ReturnsConfiguredProfile`
- `GetProfile_ParsesEnvironmentVariables`
- `GetProfile_PreservesOriginalId`
- `GetProfile_TrimsWhitespace`
- `GetProfile_NewProfile_GeneratesNewId`

**Command Tests**
- `SaveCommand_WhenValid_RaisesSaveRequested`
- `SaveCommand_WhenInvalid_DoesNotRaiseSaveRequested`
- `CancelCommand_RaisesCancelRequested`
- `ClearWorkingDirectoryCommand_ClearsWorkingDirectory`
- `AddEnvironmentVariableCommand_AddsTemplate`
- `AddEnvironmentVariableCommand_AppendsToExisting`

**Environment Variable Parsing Tests**
- `ParseEnvironmentVariables_ParsesValidKeyValuePairs`
- `ParseEnvironmentVariables_IgnoresEmptyLines`
- `ParseEnvironmentVariables_IgnoresLinesWithoutEquals`
- `ParseEnvironmentVariables_HandlesValuesWithEquals`
- `ParseEnvironmentVariables_TrimsWhitespace`
- `FormatEnvironmentVariables_FormatsCorrectly`

**Window Title Tests**
- `WindowTitle_NewProfile_ReturnsNewProfileTitle`
- `WindowTitle_EditMode_IncludesProfileName`

**Property Notification Tests**
- `ProfileName_Change_RaisesPropertyChanged`
- `ShellPath_Change_RaisesMultiplePropertyChanges`

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | Dialog opens for new profile with empty fields | ✓ |
| AC-2 | Dialog opens for edit with existing data loaded | ✓ |
| AC-3 | Profile name validation (required, error displayed) | ✓ |
| AC-4 | Shell path validation (required, exists, error displayed) | ✓ |
| AC-5 | Browse button opens file picker, sets path | ✓ |
| AC-6 | Working directory browse opens folder picker | ✓ |
| AC-7 | Shell type auto-detected from path | ✓ |
| AC-8 | Version displayed when detectable | ✓ |
| AC-9 | Environment variables parsed from KEY=VALUE format | ✓ |
| AC-10 | Login shell checkbox works | ✓ |
| AC-11 | ConPTY option visible only on Windows | ✓ |
| AC-12 | Save button disabled when validation fails | ✓ |
| AC-13 | Save returns profile to parent, closes dialog | ✓ |
| AC-14 | Cancel closes dialog without returning profile | ✓ |
| AC-15 | All tests pass | ✓ |
| AC-16 | Comprehensive XML documentation | ✓ |
| AC-17 | Changelog entries created | ✓ |

## Breaking Changes

None.
