# Changelog v0.2.1e

**Release Date:** 2026-01-12

Database initialization and seeding - establishing migration management, backup systems, and built-in data for system prompts and inference presets.

---

## Highlights

- DatabaseInitializer for migration execution and seed data management
- Automatic database backup before migrations
- Built-in system prompts (Default Assistant, Code Assistant, Writing Assistant)
- Built-in inference presets (Balanced, Creative, Precise, Fast)
- DI registration via DataServiceCollectionExtensions
- 5 new unit tests for initialization logic

---

## DatabaseInitializer

**Location:** `src/AIntern.Data/DatabaseInitializer.cs` (~520 lines)

### Features

| Feature | Description |
|---------|-------------|
| Migration Execution | Applies pending EF Core migrations on startup |
| Backup Before Migration | Creates `.bak` copy before schema changes |
| Seed Data | Ensures built-in prompts and presets exist |
| Idempotent Seeding | Safe to run multiple times without duplicates |
| Exhaustive Logging | Entry/exit patterns with stopwatch timing |

### Initialization Flow

```
InitializeAsync()
    ├─ CheckPendingMigrations()
    ├─ BackupDatabaseIfNeeded()
    ├─ ApplyMigrations()
    ├─ SeedSystemPromptsAsync()
    └─ SeedInferencePresetsAsync()
```

---

## Built-In System Prompts

| Name | Category | Description |
|------|----------|-------------|
| Default Assistant | General | Balanced, helpful AI assistant |
| Code Assistant | Development | Programming and debugging focus |
| Writing Assistant | Creative | Writing, editing, and composition |

**Properties:** `IsBuiltIn = true`, `IsActive = true`

---

## Built-In Inference Presets

| Name | Temperature | TopP | MaxTokens | Use Case |
|------|-------------|------|-----------|----------|
| Balanced | 0.7 | 0.9 | 2048 | General use |
| Creative | 0.9 | 0.95 | 3072 | Creative writing |
| Precise | 0.3 | 0.8 | 2048 | Factual accuracy |
| Fast | 0.7 | 0.9 | 512 | Quick responses |

**Properties:** `IsBuiltIn = true`

---

## DI Registration

**Location:** `src/AIntern.Data/DataServiceCollectionExtensions.cs` (~140 lines)

```csharp
services.AddDataServices()
```

Registers:
- `AInternDbContext` (Scoped)
- `IConversationRepository` → `ConversationRepository` (Scoped)
- `ISystemPromptRepository` → `SystemPromptRepository` (Scoped)
- `IInferencePresetRepository` → `InferencePresetRepository` (Scoped)
- `DatabaseInitializer` (Scoped)

---

## Files Changed

### New Files (2)

| Path | Lines | Description |
|------|-------|-------------|
| `src/AIntern.Data/DatabaseInitializer.cs` | ~520 | Migration and seeding coordinator |
| `src/AIntern.Data/DataServiceCollectionExtensions.cs` | ~140 | DI registration extensions |

### Modified Files (1)

| Path | Change |
|------|--------|
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Calls `AddDataServices()` |

---

## Unit Tests

**Location:** `tests/AIntern.Data.Tests/DatabaseInitializerTests.cs`

### Test Summary (5 tests)

| Test | Description |
|------|-------------|
| `InitializeAsync_AppliesMigrations` | Verifies migration execution |
| `InitializeAsync_SeedsSystemPrompts` | Verifies 3 built-in prompts created |
| `InitializeAsync_SeedsInferencePresets` | Verifies 4 built-in presets created |
| `InitializeAsync_IsIdempotent` | Verifies no duplicates on re-run |
| `InitializeAsync_CreatesBackup` | Verifies backup file creation |

---

## Verification

### Build

```bash
dotnet build AIntern.sln
# Build succeeded. 0 Warning(s) 0 Error(s)
```

### Tests

```bash
dotnet test
# Total tests: 120
# Passed: 120
```

---

## Metrics

| Metric | Value |
|--------|-------|
| New Source Files | 2 |
| New Test Files | 1 |
| New Tests | 5 |
| Total Tests | 120 |
| Built-In Prompts | 3 |
| Built-In Presets | 4 |

---

## Next Steps

This completes the v0.2.1 database foundation series. v0.2.2a will add:

- DatabaseConversationService for persistence
- Auto-save with debouncing
- Domain model updates for persistence tracking
- Service events for UI synchronization
