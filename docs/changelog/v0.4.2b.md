# v0.4.2b: Diff Service

**Release Date:** January 16, 2026  
**Type:** Feature (Diff Engine)  
**Parent:** v0.4.2 Diff Engine

---

## Overview

v0.4.2b implements the core diff computation service using the DiffPlex library. This service transforms original and proposed content into structured `DiffResult` objects with hunks, statistics, and metadata for visualization in the diff viewer UI.

---

## New Files

### Core Interfaces & Models
| File | Purpose | Lines |
|------|---------|-------|
| `src/AIntern.Core/Interfaces/IDiffService.cs` | Diff computation interface | ~95 |
| `src/AIntern.Core/Models/DiffOptions.cs` | Configuration options model | ~115 |

### Service Implementation
| File | Purpose | Lines |
|------|---------|-------|
| `src/AIntern.Services/DiffService.cs` | DiffPlex-based implementation | ~590 |

### Unit Tests
| File | Test Count |
|------|------------|
| `tests/AIntern.Core.Tests/Models/DiffOptionsTests.cs` | 5 |
| `tests/AIntern.Services.Tests/DiffServiceTests.cs` | 24 |
| **Total** | **29** |

---

## Key Features

### 1. IDiffService Interface

Provides both synchronous and asynchronous diff computation:

**Synchronous Methods:**
- `ComputeDiff(original, proposed)` - Basic string diff
- `ComputeDiff(original, proposed, filePath)` - With file context
- `ComputeDiff(original, proposed, filePath, options)` - With custom options
- `ComputeNewFileDiff(proposed, filePath)` - All lines added
- `ComputeDeleteFileDiff(original, filePath)` - All lines removed

**Asynchronous Methods:**
- `ComputeDiffForBlockAsync(block, workspace, ct)` - Reads file and computes diff
- `ComputeMergedDiffAsync(blocks, workspace, ct)` - Multiple blocks to same file

### 2. DiffOptions Model

| Option | Default | Description |
|--------|---------|-------------|
| ContextLines | 3 | Unchanged lines around changes |
| ComputeInlineDiffs | true | Character-level inline diffs |
| IgnoreWhitespace | false | Skip whitespace-only changes |
| IgnoreCase | false | Case-insensitive comparison |
| TrimTrailingWhitespace | true | Normalize trailing whitespace |
| HunkSeparationThreshold | 6 | Lines between separate hunks |
| MaxInlineDiffLineLength | 500 | Skip inline for long lines |
| InlineDiffSimilarityThreshold | 0.3 | Min similarity for inline diff |

**Preset Configurations:**
- `DiffOptions.Default` - Standard settings
- `DiffOptions.Compact` - Fewer context lines (1)
- `DiffOptions.Full` - More context lines (10)
- `DiffOptions.IgnoreWhitespaceOptions` - Whitespace insensitive

### 3. DiffService Implementation

Uses DiffPlex library for line-level diff computation:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Diff Computation Flow                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Input: originalContent, proposedContent, filePath, options              │
│                         │                                                │
│                         ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 1: Preprocessing                                            │    │
│  │   • NormalizeLineEndings() → \r\n → \n                          │    │
│  │   • TrimTrailingWhitespace() (if enabled)                       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                         │                                                │
│                         ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 2: Identity Check                                           │    │
│  │   • if (original == proposed) → NoChanges                       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                         │                                                │
│                         ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 3: DiffPlex Computation                                     │    │
│  │   • SideBySideDiffBuilder.BuildDiffModel()                      │    │
│  │   • Returns aligned OldText.Lines ↔ NewText.Lines               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                         │                                                │
│                         ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 4: Build Hunks                                              │    │
│  │   • Group changes with context lines                            │    │
│  │   • Separate hunks when unchanged > threshold                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                         │                                                │
│                         ▼                                                │
│                    DiffResult                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Modified Files

| File | Changes |
|------|---------|
| `Directory.Packages.props` | Added DiffPlex 1.7.2 package |
| `src/AIntern.Services/AIntern.Services.csproj` | Added DiffPlex PackageReference |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Registered IDiffService |

---

## Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| DiffPlex | 1.7.2 | Line-level diff computation |

### Prior Version Dependencies
| Version | Dependency |
|---------|------------|
| v0.4.2a | DiffResult, DiffHunk, DiffLine, DiffStats models |
| v0.4.1a | CodeBlock, CodeBlockType for async methods |
| v0.3.1d | IFileSystemService for file operations |

---

## Test Coverage

| Test Category | Count | Coverage |
|---------------|-------|----------|
| DiffOptionsTests | 5 | Default, Compact, Full, IgnoreWhitespace, Custom |
| DiffServiceTests (Sync) | 10 | ComputeDiff variants, edge cases |
| DiffServiceTests (Async) | 7 | Block diff, merged diff, error handling |
| DiffServiceTests (Hunks) | 7 | Hunk building, context lines |
| **Total** | **29** | |

---

## Usage Examples

### Basic Diff
```csharp
var service = new DiffService(fileSystemService);
var result = service.ComputeDiff(
    "line1\nline2\nline3",
    "line1\nmodified\nline3",
    "example.cs");

// result.HasChanges = true
// result.Stats.Summary = "+1 -1"
```

### Diff with Options
```csharp
var options = new DiffOptions
{
    ContextLines = 5,
    IgnoreWhitespace = true
};

var result = service.ComputeDiff(original, proposed, "file.cs", options);
```

### Diff for Code Block
```csharp
var block = new CodeBlock
{
    Content = "new content",
    TargetFilePath = "src/MyClass.cs",
    BlockType = CodeBlockType.CompleteFile
};

var result = await service.ComputeDiffForBlockAsync(block, workspacePath);
```

---

## Breaking Changes

None - v0.4.2b is purely additive.

---

## Next Steps

- **v0.4.2c: Inline Diff Service** - Compute character-level changes within modified lines
- **v0.4.2d: Diff Viewer UI** - Visual display of diff results
