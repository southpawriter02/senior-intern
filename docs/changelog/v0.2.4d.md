# v0.2.4d - Editor Window UI

**Release Date:** 2026-01-13
**Type:** Feature (UI Layer)
**Status:** Complete

## Overview

This release implements the `SystemPromptEditorWindow` - a full editor dialog for managing system prompts. The window features a split-pane layout with a prompt list sidebar and a full content editor, keyboard shortcuts, and unsaved changes handling.

**Building on:** v0.2.4c (Editor ViewModels)
**Design Reference:** [v0.2.4d-editor-window-ui.md](../design/v0.2.x/v0.2.4d-editor-window-ui.md)

## Architecture

```
+---------------------------------------------------------------------+
|                   SystemPromptEditorWindow (900x650)                 |
+---------------------------------------------------------------------+
|                                                                      |
|  +---------------------------+--------------------------------------+
|  |     Left Panel (260px)    |          Right Panel (Editor)        |
|  |  +---------------------+  |  +--------------------------------+  |
|  |  | My Prompts [+ New]  |  |  | Name: [____________________]   |  |
|  |  +---------------------+  |  | Description: [_______________] |  |
|  |  | * Default Prompt    |  |  +--------------------------------+  |
|  |  |   Custom Prompt 1   |  |  |                                |  |
|  |  |   Custom Prompt 2   |  |  |     System Prompt Content      |  |
|  |  +---------------------+  |  |     (Monospace, AcceptsReturn) |  |
|  |  | Templates           |  |  |                                |  |
|  |  +---------------------+  |  +--------------------------------+  |
|  |  | Chat  Default       |  |  | 847 chars | ~212 tokens | Mod  |  |
|  |  | Code  Technical     |  |  +--------------------------------+  |
|  |  +---------------------+  |                                      |
|  +---------------------------+--------------------------------------+
|  +------------------------------------------------------------------+
|  |              Action Bar (Delete, Dup, Default | Discard, Save)   |
|  +------------------------------------------------------------------+
|                                                                      |
+---------------------------------------------------------------------+
```

## Files Created

### 1. SystemPromptEditorWindow.axaml

**Path:** `src/AIntern.Desktop/Views/SystemPromptEditorWindow.axaml`
**Lines:** 455 (includes Window.Styles section)

The main XAML file defining the editor window layout and data bindings.

#### Window Configuration

| Property | Value | Description |
|----------|-------|-------------|
| `Width` | 900 | Initial width in pixels |
| `Height` | 650 | Initial height in pixels |
| `MinWidth` | 700 | Minimum resizable width |
| `MinHeight` | 500 | Minimum resizable height |
| `WindowStartupLocation` | CenterOwner | Centers on parent window |
| `Background` | WindowBackground | Theme-aware background |

#### DataTemplates

| Template | Purpose | Bound To |
|----------|---------|----------|
| `UserPromptItemTemplate` | User-created prompts in sidebar | `SystemPromptViewModel` |
| `TemplateItemTemplate` | Built-in templates in sidebar | `SystemPromptViewModel` |

#### Window.Styles Section

The window contains local styles for prompt list items:

| Style Selector | Purpose |
|----------------|---------|
| `Border.prompt-item` | Base style for user prompt items |
| `Border.prompt-item:pointerover` | Hover state |
| `Border.prompt-item.selected` | Selected item highlight |
| `Border.template-item` | Base style for template items |
| `Border.template-item:pointerover` | Hover state |

##### UserPromptItemTemplate Features

- Default star indicator (`StarIcon`) when `IsDefault=true`
- Prompt name with `FontWeight="SemiBold"`
- Usage count badge with `StringFormat='Used {0}x'`
- Content preview with `TextTrimming="CharacterEllipsis"`
- Selection state via `Classes.selected="{Binding IsSelected}"`

##### TemplateItemTemplate Features

- Category icon (`PromptIcon`) in bordered container
- Name with `FontWeight="SemiBold"`
- Category badge with muted background
- Description text below name

#### Layout Structure

```
Window
└── Panel
    ├── Grid (RowDefinitions="*,Auto")
    │   ├── Grid (Row 0, ColumnDefinitions="260,*")
    │   │   ├── Border (Col 0) - Left Panel: Sidebar
    │   │   │   └── Grid (RowDefinitions="Auto,*,Auto,Auto")
    │   │   │       ├── Grid (Row 0) - "My Prompts" header + New button
    │   │   │       ├── ScrollViewer (Row 1) - User prompts ListBox
    │   │   │       ├── TextBlock (Row 2) - "Templates" header
    │   │   │       └── ScrollViewer (Row 3) - Templates ListBox
    │   │   └── Grid (Col 1) - Right Panel: Editor
    │   │       ├── StackPanel (Row 0) - Name field + validation
    │   │       ├── StackPanel (Row 1) - Description field
    │   │       ├── Grid (Row 2) - Content editor + "Create Copy" link
    │   │       └── Border (Row 3) - Stats footer
    │   └── Border (Row 1) - Bottom action bar
    ├── Border - Loading overlay (ZIndex="100")
    └── Border - Error banner (ZIndex="99")
```

#### Data Bindings

| UI Element | Binding | Mode | Description |
|------------|---------|------|-------------|
| User prompts ListBox | `ItemsSource="{Binding UserPrompts}"` | OneWay | User-created prompts |
| Templates ListBox | `ItemsSource="{Binding Templates}"` | OneWay | Built-in templates |
| Both ListBoxes | `SelectedItem="{Binding SelectedPrompt}"` | TwoWay | Selection sync |
| Name TextBox | `Text="{Binding PromptName}"` | TwoWay | Editable name |
| Description TextBox | `Text="{Binding PromptDescription}"` | TwoWay | Editable description |
| Content TextBox | `Text="{Binding EditorContent}"` | TwoWay | Prompt content |
| Character count | `Text="{Binding CharacterCountText}"` | OneWay | Stats display |
| Token count | `Text="{Binding TokenCountText}"` | OneWay | Stats display |
| Modified indicator | `IsVisible="{Binding IsDirty}"` | OneWay | Dirty state |
| Read-only fields | `IsReadOnly="{Binding !CanEdit}"` | OneWay | Template protection |
| Loading overlay | `IsVisible="{Binding IsLoading}"` | OneWay | Async state |
| Error banner | `IsVisible` + StringConverters | OneWay | Error display |

#### Command Bindings

| Button | Command | Style | Visibility |
|--------|---------|-------|------------|
| "+ New" | `CreateNewPromptCommand` | IconButton | Always |
| "Delete" | `DeletePromptCommand` | DestructiveButton | `CanDelete` |
| "Duplicate" | `DuplicatePromptCommand` | SubtleButton | `CanDuplicate` |
| "Set as Default" | `SetAsDefaultCommand` | SubtleButton | `CanSetDefault` |
| "Create Copy to Edit" | `CreateFromTemplateCommand` | LinkButton | `!CanEdit` |
| "Discard" | `DiscardChangesCommand` | SubtleButton | `IsDirty` |
| "Save" | `SavePromptCommand` | AccentButton | Always (disabled via CanExecute) |

### 2. SystemPromptEditorWindow.axaml.cs

**Path:** `src/AIntern.Desktop/Views/SystemPromptEditorWindow.axaml.cs`
**Lines:** 377

Code-behind providing lifecycle management, keyboard shortcuts, and unsaved changes handling.

#### Class Definition

```csharp
public partial class SystemPromptEditorWindow : Window, IDisposable
```

#### Fields

| Field | Type | Description |
|-------|------|-------------|
| `_logger` | `ILogger<SystemPromptEditorWindow>?` | Optional diagnostic logger |
| `_isClosingFromCode` | `bool` | Flag to prevent dialog re-entry |
| `_isDisposed` | `bool` | Disposal tracking |

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `ViewModel` | `SystemPromptEditorViewModel?` | Typed DataContext accessor |

#### Constructors

| Constructor | Purpose |
|-------------|---------|
| `SystemPromptEditorWindow()` | XAML designer and DI container |
| `SystemPromptEditorWindow(ILogger?)` | Explicit logging support |

#### Lifecycle Methods

##### OnOpened

```csharp
protected override async void OnOpened(EventArgs e)
```

- Calls `base.OnOpened(e)` first
- Initializes ViewModel via `await ViewModel.InitializeAsync()`
- Logs entry/exit with duration
- Handles exceptions gracefully

##### OnClosing

```csharp
protected override async void OnClosing(WindowClosingEventArgs e)
```

Unsaved changes flow:
```
OnClosing triggered
    |
    v
_isClosingFromCode? --Yes--> Allow close
    |
    No
    |
    v
IsDirty == true? --No--> Allow close
    |
    Yes
    |
    v
e.Cancel = true
Show UnsavedChangesDialog
    |
    +-- Save --> Save then _isClosingFromCode=true, Close()
    +-- DontSave --> _isClosingFromCode=true, Close()
    +-- Cancel --> Stay open (do nothing)
```

#### Keyboard Handling

##### OnKeyDown

```csharp
protected override void OnKeyDown(KeyEventArgs e)
```

| Shortcut | Action | Implementation |
|----------|--------|----------------|
| Ctrl+S | Save | `SavePromptCommand.ExecuteAsync(null)` if `CanExecute` |
| Ctrl+N | New | `CreateNewPromptCommand.ExecuteAsync(null)` if `CanExecute` |
| Escape | Discard or Close | If `IsDirty`: discard; else: `Close()` |

#### Disposal

```csharp
public void Dispose()
```

- Guards against double disposal
- Disposes ViewModel if `IDisposable`
- Logs disposal lifecycle

## Files Modified

### 1. Icons.axaml

**Path:** `src/AIntern.Desktop/Resources/Icons.axaml`
**Changes:** Added 4 new icons (+27 lines)

#### New Icons

| Key | ViewBox | Description |
|-----|---------|-------------|
| `StarIcon` | 0 0 24 24 | Filled star for default prompt indicator |
| `CopyIcon` | 0 0 24 24 | Overlapping documents for duplicate action |
| `DefaultIcon` | 0 0 24 24 | Checkmark in circle for set default action |
| `PromptIcon` | 0 0 24 24 | Chat bubble with dots for template list |

```xml
<!-- System Prompt Editor Icons (v0.2.4d) -->
<StreamGeometry x:Key="StarIcon">M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z</StreamGeometry>
<StreamGeometry x:Key="CopyIcon">M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z</StreamGeometry>
<StreamGeometry x:Key="DefaultIcon">M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z</StreamGeometry>
<StreamGeometry x:Key="PromptIcon">M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z</StreamGeometry>
```

### 2. Dark.axaml

**Path:** `src/AIntern.Desktop/Themes/Dark.axaml`
**Changes:** Added editor ControlThemes (+31 lines)

> **Note:** The selector-based styles (prompt-item, template-item) are defined in `Window.Styles`
> within SystemPromptEditorWindow.axaml since Avalonia ResourceDictionaries cannot contain
> standalone Style elements with selectors.

#### New ControlThemes

##### CodeEditorTextBox

| Property | Value | Purpose |
|----------|-------|---------|
| `Background` | InputBackground | Dark editor background |
| `Foreground` | TextPrimary | Light text |
| `FontFamily` | Cascadia Code, Consolas, monospace | Monospace font |
| `FontSize` | 13 | Readable code size |
| `BorderBrush` | BorderBrush | Subtle border |
| `BorderThickness` | 1 | Thin border |
| `CornerRadius` | 4 | Rounded corners |
| `Padding` | 12 | Comfortable spacing |
| `AcceptsReturn` | True | Multiline support |
| `TextWrapping` | Wrap | Soft wrap |

Focus/hover states:
```xml
<Style Selector="^:focus">
    <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
</Style>
<Style Selector="^:pointerover">
    <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
</Style>
```

##### LinkButton

| Property | Value | Purpose |
|----------|-------|---------|
| `Background` | Transparent | No button chrome |
| `BorderThickness` | 0 | No border |
| `Foreground` | AccentBrush | Link-style blue |
| `Padding` | 0 | Tight fit |
| `Cursor` | Hand | Clickable indicator |
| `FontSize` | 12 | Subtle size |

Hover state:
```xml
<Style Selector="^:pointerover">
    <Setter Property="Foreground" Value="{DynamicResource AccentHoverBrush}" />
</Style>
```

## Logging Specifications

All code-behind methods use exhaustive logging with standard markers:

| Marker | Level | Usage |
|--------|-------|-------|
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug | Significant state changes or actions |
| `[SKIP]` | Debug | No-op conditions (early returns) |
| `[EXIT]` | Debug | Method completion with duration |
| `[ERROR]` | Error | Exception handling |
| `[INIT]` | Debug | Constructor completion |
| `[DISPOSE]` | Debug | Resource cleanup |

### Example Log Output

```
[INIT] SystemPromptEditorWindow constructor called
[INIT] SystemPromptEditorWindow InitializeComponent completed
[ENTER] OnOpened
[INFO] Initializing SystemPromptEditorViewModel
[INFO] SystemPromptEditorWindow initialized successfully
[EXIT] OnOpened - Duration: 45ms
[ENTER] OnKeyDown - Key: S, Modifiers: Control
[INFO] Ctrl+S pressed - invoking SavePromptCommand
[EXIT] OnKeyDown - Duration: 2ms
[ENTER] OnClosing - IsDirty: True, IsClosingFromCode: False
[INFO] Unsaved changes detected, showing dialog
[INFO] User chose Save, saving prompt
[EXIT] OnClosing - Duration: 1250ms
[DISPOSE] SystemPromptEditorWindow - Disposing
[DISPOSE] SystemPromptEditorWindow - Disposal complete
```

## Keyboard Shortcuts

| Shortcut | Action | Condition |
|----------|--------|-----------|
| Ctrl+S | Save current prompt | `CanSave` (valid name, content, dirty) |
| Ctrl+N | Create new prompt | Always available |
| Escape | Discard changes | When `IsDirty=true` |
| Escape | Close window | When not dirty |

## Unsaved Changes Dialog Flow

When the user attempts to close with unsaved changes:

1. **Close triggered** (X button, Alt+F4, `Close()` call)
2. **OnClosing handler fires**
3. **Check `_isClosingFromCode`** - if true, allow close (we already handled it)
4. **Check `IsDirty`** - if false, allow close (nothing to save)
5. **Cancel the close** (`e.Cancel = true`)
6. **Show UnsavedChangesDialog** with prompt name
7. **Handle result:**
   - **Save**: Execute save command, set flag, close
   - **Don't Save**: Set flag, close without saving
   - **Cancel**: Stay open (do nothing)

## Theme Resources Used

| Resource | Usage |
|----------|-------|
| `WindowBackground` | Window background color |
| `SidebarBackground` | Left panel background |
| `BorderBrush` | Panel dividers |
| `TextPrimary` | Main text color |
| `TextMuted` | Secondary/subtitle text |
| `AccentBrush` | Default star, links, save button |
| `ControlBackground` | Category badges, icon containers |
| `InputBackground` | Text input backgrounds |
| `PanelBackgroundColor` | Action bar background |
| `ErrorBackground` | Error banner background |
| `ErrorForeground` | Error banner text |
| `ConversationItemSelectedBackground` | Selected item highlight |

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | Window opens at 900x650, resizable to min 700x500 | Implemented |
| AC-2 | Left panel shows user prompts and templates sections | Implemented |
| AC-3 | User prompts show star for default, usage count | Implemented |
| AC-4 | Templates show category badge and description | Implemented |
| AC-5 | Editor shows name, description, content fields | Implemented |
| AC-6 | Content editor uses monospace font | Implemented |
| AC-7 | Stats footer shows character and token counts | Implemented |
| AC-8 | "Modified" indicator shows when IsDirty=true | Implemented |
| AC-9 | Built-in templates show read-only state | Implemented |
| AC-10 | Ctrl+S saves, Ctrl+N creates new | Implemented |
| AC-11 | Escape discards if dirty, closes if not | Implemented |
| AC-12 | Unsaved changes dialog on close | Implemented |
| AC-13 | Build passes with 0 errors, 0 warnings | Verified |

## ViewModel Modifications

### SystemPromptEditorViewModel

**Path:** `src/AIntern.Desktop/ViewModels/SystemPromptEditorViewModel.cs`
**Changes:** Added ClearErrorMessageCommand (+16 lines)

Added a new command for dismissing the error banner in the UI:

```csharp
/// <summary>
/// Clears the current error message.
/// </summary>
/// <remarks>
/// <para>
/// Used by the error banner dismiss button in the UI.
/// Added in v0.2.4d.
/// </para>
/// </remarks>
[RelayCommand]
private void ClearErrorMessage()
{
    _logger?.LogDebug("[INFO] ClearErrorMessage - Clearing error from UI");
    ClearError();
}
```

This command exposes the protected `ClearError()` method from `ViewModelBase` to the UI layer via a bindable command.

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Desktop/Resources/Icons.axaml` | Modified | +27 |
| `src/AIntern.Desktop/Themes/Dark.axaml` | Modified | +31 |
| `src/AIntern.Desktop/Views/SystemPromptEditorWindow.axaml` | Created | 455 |
| `src/AIntern.Desktop/Views/SystemPromptEditorWindow.axaml.cs` | Created | 377 |
| `src/AIntern.Desktop/ViewModels/SystemPromptEditorViewModel.cs` | Modified | +16 |
| **Total** | | ~906 |

## Next Steps (v0.2.4e+)

| Version | Description |
|---------|-------------|
| v0.2.4e | System prompt selector dropdown in chat header |
| v0.2.4f | Integration testing and polish |

## Related Documentation

- [v0.2.4-system-prompt-editor.md](../design/v0.2.x/v0.2.4-system-prompt-editor.md) - Feature overview
- [v0.2.4a.md](v0.2.4a.md) - Models & Repository changelog
- [v0.2.4b.md](v0.2.4b.md) - System Prompt Service changelog
- [v0.2.4c.md](v0.2.4c.md) - Editor ViewModels changelog
- [v0.2.4d-editor-window-ui.md](../design/v0.2.x/v0.2.4d-editor-window-ui.md) - Design specification
