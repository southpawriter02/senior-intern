# v0.5.5c - Terminal Search UI

**Released:** 2026-01-18

## Overview

This release adds the Terminal Search UI components, providing a floating search bar with debounced incremental search, navigation commands, and SkiaSharp-based result highlighting within the terminal renderer.

## Features

### TerminalSearchBarViewModel

A comprehensive ViewModel managing the search bar state:

- **Debounced Search**: 150ms delay prevents excessive search operations during typing
- **Search Query**: Observable property triggering debounced search on change
- **Option Toggles**: Case sensitivity and regex mode with immediate re-search
- **Navigation Commands**: NextSearchResult, PreviousSearchResult, CloseSearch
- **Error Handling**: Displays regex pattern errors to users
- **Scroll Integration**: `ScrollToResultRequested` event for viewport scrolling

**File:** `src/AIntern.Desktop/ViewModels/TerminalSearchBarViewModel.cs`

```csharp
public partial class TerminalSearchBarViewModel : ViewModelBase, IDisposable
{
    // Observable properties
    [ObservableProperty] private string _searchQuery = string.Empty;
    [ObservableProperty] private bool _isSearchVisible;
    [ObservableProperty] private bool _caseSensitive;
    [ObservableProperty] private bool _useRegex;
    [ObservableProperty] private TerminalSearchState _searchState = TerminalSearchState.Empty;
    [ObservableProperty] private bool _isSearching;
    [ObservableProperty] private string _searchResultsText = string.Empty;
    [ObservableProperty] private string? _errorMessage;

    // Commands
    public IRelayCommand NextSearchResultCommand { get; }
    public IRelayCommand PreviousSearchResultCommand { get; }
    public IRelayCommand CloseSearchCommand { get; }
    public IRelayCommand ToggleCaseSensitiveCommand { get; }
    public IRelayCommand ToggleRegexCommand { get; }

    // Events
    public event EventHandler<TerminalSearchResult>? ScrollToResultRequested;
    public event EventHandler? SearchOpened;
    public event EventHandler? SearchClosed;
}
```

### TerminalSearchBar XAML Control

A floating search bar positioned at top-right of the terminal:

**File:** `src/AIntern.Desktop/Views/TerminalSearchBar.axaml`

```
┌──────────────────────────────────────────────────────────────────┐
│ [Search Input............]  0 / 0  [Aa] [.*]  [↑] [↓]  [✕]      │
│  ↑                          ↑       ↑    ↑     ↑   ↑    ↑        │
│  TextBox                    Results Case Regex Prev Next Close   │
└──────────────────────────────────────────────────────────────────┘
```

Features:
- TextBox with placeholder text and keyboard shortcuts
- Results count display (e.g., "3 of 15")
- Toggle buttons for case sensitivity and regex mode
- Navigation buttons with ChevronUp/ChevronDown icons
- Close button to dismiss search bar
- Spinning loader icon during active search
- Error message display area

### TerminalSearchBar Code-Behind

Keyboard shortcuts implemented in code-behind:

**File:** `src/AIntern.Desktop/Views/TerminalSearchBar.axaml.cs`

| Shortcut       | Action                    |
|----------------|---------------------------|
| `Enter`        | Navigate to next result   |
| `Shift+Enter`  | Navigate to previous result |
| `Escape`       | Close search bar          |
| `Alt+C`        | Toggle case sensitivity   |
| `Alt+R`        | Toggle regex mode         |
| `F3`           | Navigate to next result   |
| `Shift+F3`     | Navigate to previous result |

Auto-focus behavior: When search bar becomes visible, it automatically focuses the search input and selects all text.

### TerminalRenderer Extensions

Extended the SkiaSharp renderer with search highlighting:

**File:** `src/AIntern.Desktop/Controls/Terminal/TerminalRenderer.cs`

New public members:
```csharp
public TerminalSearchState? SearchState { get; private set; }

public void SetSearchState(TerminalSearchState? state);
public void SetHighlightStyle(SearchHighlightStyle style);
public void ScrollToResult(TerminalSearchResult result);
```

Internal rendering:
- `RenderSearchHighlights()` method draws overlays for all visible results
- Regular matches: Semi-transparent yellow background
- Current match: Opaque orange background with border
- Viewport-aware rendering (only draws visible results)

### TerminalPanel Integration

Updated TerminalPanel with search bar:

**Files:**
- `src/AIntern.Desktop/Views/TerminalPanel.axaml` - Added `TerminalSearchBar` overlay
- `src/AIntern.Desktop/ViewModels/TerminalPanelViewModel.cs` - Added `SearchBarViewModel` property and `OpenSearchCommand`

### Theme Resources

Added search bar colors to Dark theme:

**File:** `src/AIntern.Desktop/Themes/Dark.axaml`

```xml
<!-- Terminal Search Bar Colors (v0.5.5c) -->
<Color x:Key="SearchBarBackgroundColor">#1E1E2E</Color>
<Color x:Key="SearchBarBorderColor">#313244</Color>
<Color x:Key="SearchMatchBackgroundColor">#FFFF00</Color>
<Color x:Key="SearchCurrentMatchBackgroundColor">#FF8C00</Color>
<Color x:Key="SearchCurrentMatchBorderColor">#FF4500</Color>
```

## Unit Tests

Created `TerminalSearchBarViewModelTests.cs` with 24 test cases covering:

- Constructor validation
- Property change notifications
- OpenSearch/CloseSearch commands
- Toggle commands (case sensitivity, regex)
- SetBuffer functionality
- NavigateToLine event handling
- Search state initialization
- Navigation command execution
- Dispose behavior

## Dependencies

- **v0.5.5a**: Terminal Search Models (`TerminalSearchResult`, `TerminalSearchState`, `SearchHighlightStyle`)
- **v0.5.5b**: Terminal Search Service (`ITerminalSearchService`)

## API Changes

### TerminalPanelViewModel

Constructor signature changed:

```diff
 public TerminalPanelViewModel(
     ITerminalService terminalService,
+    ITerminalSearchService? searchService = null,
     IWorkspaceService? workspaceService = null,
     ILogger<TerminalPanelViewModel>? logger = null)
```

New properties:
```csharp
public TerminalSearchBarViewModel? SearchBarViewModel { get; }
```

New commands:
```csharp
public IRelayCommand OpenSearchCommand { get; }
```

## Files Changed

### New Files
| File | Description |
|------|-------------|
| `src/AIntern.Desktop/ViewModels/TerminalSearchBarViewModel.cs` | Search bar ViewModel |
| `src/AIntern.Desktop/Views/TerminalSearchBar.axaml` | Search bar XAML |
| `src/AIntern.Desktop/Views/TerminalSearchBar.axaml.cs` | Search bar code-behind |
| `tests/AIntern.Desktop.Tests/ViewModels/TerminalSearchBarViewModelTests.cs` | Unit tests |

### Modified Files
| File | Changes |
|------|---------|
| `src/AIntern.Desktop/Controls/Terminal/TerminalRenderer.cs` | Search state, highlight rendering |
| `src/AIntern.Desktop/ViewModels/TerminalPanelViewModel.cs` | SearchBarViewModel, OpenSearchCommand |
| `src/AIntern.Desktop/Views/TerminalPanel.axaml` | TerminalSearchBar overlay |
| `src/AIntern.Desktop/Themes/Dark.axaml` | Search bar color resources |
| `tests/AIntern.Desktop.Tests/ViewModels/MainWindowViewModelTests.cs` | Constructor update |

## Verification

```bash
# Build
dotnet build src/AIntern.Desktop --no-restore
# 0 errors, 15 warnings

# Run TerminalSearchBarViewModel tests
dotnet test tests/AIntern.Desktop.Tests --filter "TerminalSearchBarViewModelTests"
# Passed: 24

# Run all Desktop tests
dotnet test tests/AIntern.Desktop.Tests --no-restore
# Passed: 1,843
```

## What's Next

- **v0.5.5d**: Global keyboard shortcut (Ctrl+F) integration in MainWindow
- **v0.5.5e**: Search scrollbar markers (minimap indicators)
