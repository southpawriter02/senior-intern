# v0.5.4d - Output Capture System

**Released**: 2026-01-18

---

## Overview

Captures terminal output for AI context with ANSI stripping, truncation, and per-session history.

---

## Added

### Models (`AIntern.Core/Models/Terminal/`)

- **TruncationMode** - Enum with 3 modes + extension methods
  - `KeepStart`, `KeepEnd`, `KeepBoth`
  - `GetIndicator()`, `ToDescription()` extensions

- **OutputCaptureSettings** - Capture configuration
  - `MaxCaptureLength` (default: 8000)
  - `MaxCaptureLines` (default: 500)
  - `TruncationMode` (default: KeepEnd)
  - `StripAnsiSequences` (default: true)
  - `NormalizeLineEndings` (default: true)
  - `CaptureHistorySize` (default: 20)
  - Factory methods: `ForAIContext()`, `ForFullCapture()`, `Raw()`

### Interface (`AIntern.Core/Interfaces/`)

- **IOutputCaptureService** - 10 methods + Settings property
  - Stream: `StartCapture()`, `StopCaptureAsync()`, `IsCaptureActive()`
  - Buffer: `CaptureBufferAsync()`, `CaptureSelectionAsync()`
  - History: `GetRecentCaptures()`, `GetCapture()`, `ClearHistory()`
  - Config: `Configure()`, `Settings`

### Implementation (`AIntern.Services/Terminal/`)

- **OutputCaptureService** - Full implementation
  - ConcurrentDictionary for thread-safe state
  - Terminal output event subscription
  - Source-generated regex for ANSI stripping
  - Three truncation strategies
  - Per-session capture history with pruning
  - CaptureContext nested class for stream capture

---

## Unit Tests

28 tests in `OutputCaptureServiceTests.cs`:

| Category | Tests |
|----------|-------|
| StartCapture | 2 |
| StopCapture | 3 |
| OnOutputReceived | 1 |
| Buffer Capture | 2 |
| Output Processing | 3 |
| Truncation | 4 |
| History | 5 |
| Configuration | 2 |
| TruncationMode Extensions | 6 |

---

## Files Changed

| File | Status |
|------|--------|
| `AIntern.Core/Models/Terminal/TruncationMode.cs` | Added |
| `AIntern.Core/Models/Terminal/OutputCaptureSettings.cs` | Added |
| `AIntern.Core/Interfaces/IOutputCaptureService.cs` | Added |
| `AIntern.Services/Terminal/OutputCaptureService.cs` | Added |
| `AIntern.Services/Terminal/TerminalServiceExtensions.cs` | Modified |
| `AIntern.Services.Tests/Terminal/OutputCaptureServiceTests.cs` | Added |

---

## Next Steps

- v0.5.4e: Command Integration UI (buttons, status, output display)
- v0.5.5: Terminal Polish (settings, themes, keyboard shortcuts)
