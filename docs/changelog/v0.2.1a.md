# Changelog v0.2.1a

**Release Date:** 2026-01-12

Project Setup for Memory Management phase - establishing the data persistence layer with Entity Framework Core and cross-platform database path resolution.

---

## Highlights

- New AIntern.Data class library for data persistence
- Entity Framework Core with SQLite provider
- Cross-platform database path resolution (Windows, macOS, Linux)
- XDG Base Directory Specification compliance on Linux
- Comprehensive logging via Microsoft.Extensions.Logging
- Comprehensive unit test coverage (33 tests)

---

## Project Structure

### Solution Organization

```
AIntern.sln
├── src/
│   ├── AIntern.Core/           # Domain models and interfaces
│   ├── AIntern.Data/           # Data persistence layer (NEW)
│   ├── AIntern.Services/       # Service implementations
│   └── AIntern.Desktop/        # Avalonia UI application
├── tests/
│   ├── AIntern.Core.Tests/     # Unit tests for Core
│   ├── AIntern.Data.Tests/     # Unit tests for Data (NEW)
│   └── AIntern.Services.Tests/ # Unit tests for Services
└── docs/
    └── changelog/
        └── v0.2.1a.md          # This file
```

### Layer Dependencies

```
┌─────────────────────────────────────┐
│          AIntern.Desktop            │  ← Presentation (Avalonia)
├─────────────────────────────────────┤
│          AIntern.Services           │  ← Business Logic
├─────────────────────────────────────┤
│            AIntern.Data             │  ← Data Persistence (NEW)
├─────────────────────────────────────┤
│            AIntern.Core             │  ← Domain (zero dependencies)
└─────────────────────────────────────┘
```

---

## New Packages

Added to `Directory.Packages.props`:

| Package | Version | Purpose |
|---------|---------|---------|
| `Microsoft.EntityFrameworkCore` | 8.0.11 | ORM framework |
| `Microsoft.EntityFrameworkCore.Sqlite` | 8.0.11 | SQLite database provider |
| `Microsoft.EntityFrameworkCore.Design` | 8.0.11 | EF Core design-time tools |

---

## DatabasePathResolver

New sealed class providing cross-platform database path resolution.

### Platform Paths

| Platform | App Data Directory |
|----------|-------------------|
| Windows | `%APPDATA%\AIntern\` |
| macOS | `~/Library/Application Support/AIntern/` |
| Linux | `$XDG_DATA_HOME/AIntern/` or `~/.local/share/AIntern/` |

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `AppDataDirectory` | `string` | Platform-specific application data directory |
| `DatabasePath` | `string` | Full path to `aintern.db` |
| `LogsDirectory` | `string` | Path to logs subdirectory |
| `BackupsDirectory` | `string` | Path to backups subdirectory |
| `ConnectionString` | `string` | SQLite connection string for EF Core |
| `DatabaseExists` | `bool` | Whether the database file exists |

### Methods

| Method | Return Type | Description |
|--------|-------------|-------------|
| `GetBackupPath()` | `string` | Timestamped backup path (e.g., `aintern_backup_20260112_153045.db`) |
| `GetLogFilePath(DateTime?)` | `string` | Date-based log file path (e.g., `aintern_20260112.log`) |

### Directory Structure Created

```
AIntern/
├── aintern.db          # SQLite database
├── logs/               # Application logs
└── backups/            # Database backups
```

### XDG Compliance (Linux)

The resolver follows the XDG Base Directory Specification:

1. Checks `$XDG_DATA_HOME` environment variable first
2. Falls back to `~/.local/share` if not set
3. Appends `AIntern` subdirectory

### Code Example

```csharp
var resolver = new DatabasePathResolver();

// Access paths
Console.WriteLine(resolver.AppDataDirectory);   // /Users/user/Library/Application Support/AIntern
Console.WriteLine(resolver.DatabasePath);       // .../AIntern/aintern.db
Console.WriteLine(resolver.ConnectionString);   // Data Source=/Users/user/.../aintern.db

// Generate timestamped paths
var backupPath = resolver.GetBackupPath();      // .../backups/aintern_backup_20260112_153045.db
var logPath = resolver.GetLogFilePath();        // .../logs/aintern_20260112.log
```

### Logging Support

DatabasePathResolver supports dependency injection of `ILogger<DatabasePathResolver>`:

```csharp
// With logging (via DI)
var resolver = new DatabasePathResolver(logger);

// Without logging (uses NullLogger)
var resolver = new DatabasePathResolver();
```

Log levels used:
- **Debug**: Platform detection, path resolution details, directory existence checks
- **Information**: Resolved paths, directory creation, initialization success
- **Error**: Permission denied, I/O errors, unsupported platform

---

## Unit Tests

### AIntern.Data.Tests

33 unit tests organized by region:

| Region | Test Count | Coverage |
|--------|------------|----------|
| Constructor Tests | 4 | Instantiation, directory creation |
| AppDataDirectory Tests | 3 | Non-empty, ends with AIntern, absolute path |
| DatabasePath Tests | 4 | Non-empty, filename, within app data, absolute |
| ConnectionString Tests | 3 | Format, contains filename, exact match |
| LogsDirectory Tests | 2 | Within app data, ends with logs |
| BackupsDirectory Tests | 2 | Within app data, ends with backups |
| GetBackupPath Tests | 4 | Within backups, extension, timestamp, uniqueness |
| GetLogFilePath Tests | 4 | Within logs, extension, today's date, custom date |
| DatabaseExists Tests | 2 | False when not created, true when exists |
| Platform-Specific Tests | 3 | Windows, macOS, Linux path conventions |
| Consistency Tests | 2 | Multiple instances, path separators |

### Test Patterns

- Arrange-Act-Assert pattern throughout
- Platform-specific tests skip on non-matching platforms
- File cleanup in `finally` blocks for database existence tests
- XML documentation on all test methods

---

## Files Changed

### New Files

| Path | Description |
|------|-------------|
| `src/AIntern.Data/AIntern.Data.csproj` | Data layer project file |
| `src/AIntern.Data/DatabasePathResolver.cs` | Cross-platform path resolver |
| `tests/AIntern.Data.Tests/AIntern.Data.Tests.csproj` | Test project file |
| `tests/AIntern.Data.Tests/DatabasePathResolverTests.cs` | Unit tests |
| `docs/changelog/v0.2.1a.md` | This changelog |

### Modified Files

| Path | Changes |
|------|---------|
| `Directory.Build.props` | Target framework updated to .NET 9.0 |
| `Directory.Packages.props` | Added Entity Framework Core packages |
| `AIntern.sln` | Added AIntern.Data and AIntern.Data.Tests projects |
| `src/AIntern.Services/AIntern.Services.csproj` | Added reference to AIntern.Data |
| `src/AIntern.Desktop/AIntern.Desktop.csproj` | Added reference to AIntern.Data |
| `CHANGELOG.md` | Added v0.2.1a entry |

---

## Build Configuration

### Target Framework Change

Updated from .NET 8.0 to .NET 9.0 in `Directory.Build.props` to match installed runtime.

### Project References

```xml
<!-- AIntern.Data.csproj -->
<ProjectReference Include="..\AIntern.Core\AIntern.Core.csproj" />

<!-- AIntern.Services.csproj -->
<ProjectReference Include="..\AIntern.Data\AIntern.Data.csproj" />

<!-- AIntern.Desktop.csproj -->
<ProjectReference Include="..\AIntern.Data\AIntern.Data.csproj" />
```

---

## Verification

### Build

```bash
dotnet build AIntern.sln
# Build succeeded. 0 Warning(s) 0 Error(s)
```

### Tests

```bash
dotnet test
# Total tests: 43
# Passed: 43
# - AIntern.Core.Tests: 9 passed
# - AIntern.Services.Tests: 1 passed
# - AIntern.Data.Tests: 33 passed
```

### Solution List

```bash
dotnet sln AIntern.sln list
# src/AIntern.Core/AIntern.Core.csproj
# src/AIntern.Data/AIntern.Data.csproj
# src/AIntern.Desktop/AIntern.Desktop.csproj
# src/AIntern.Services/AIntern.Services.csproj
# tests/AIntern.Core.Tests/AIntern.Core.Tests.csproj
# tests/AIntern.Data.Tests/AIntern.Data.Tests.csproj
# tests/AIntern.Services.Tests/AIntern.Services.Tests.csproj
```

---

## Metrics

| Metric | Value |
|--------|-------|
| Projects | 7 (4 src + 3 tests) |
| New Source Files | 2 |
| New Test Files | 1 |
| New Tests | 33 |
| Total Tests | 43 |
| NuGet Packages Added | 3 |

---

## Next Steps

This release establishes the foundation for v0.2.1b which will add:

- `AInternDbContext` - Entity Framework Core DbContext
- Entity configurations for Conversation and ChatMessage
- Database migrations
- Repository pattern implementation
