# v0.5.5i - History Management

**Released:** 2026-01-19

## Summary

Implements terminal command history management with SQLite persistence, search functionality, and multi-format export. Commands are tracked per-session with metadata including working directory, exit code, and duration. Provides deduplicated command retrieval for autocomplete and session-level grouping for history browsing.

## Features

### TerminalHistoryEntry Model

- **Immutable Design**: Uses `init` properties for creation-time-only values
- **Auto-Generated ID**: Unique GUID generated for each entry
- **Metadata Capture**: Command text, execution timestamp, working directory, exit code, duration, profile ID
- **Computed Properties**: `IsSuccess` (exit code 0), `RelativeTime` (human-readable), `DurationDisplay` (formatted)
- **Factory Methods**: `Create()` for convenient construction, `Empty` for placeholders

### TerminalSessionHistory Model

- **Session Grouping**: Aggregates commands by terminal session ID
- **Timing Tracking**: StartedAt, EndedAt, Duration calculation
- **Statistics**: SuccessfulCommandCount, FailedCommandCount
- **Display Helpers**: DurationDisplay, StartedAtDisplay formatted for UI

### HistoryExportFormat Enum

- **Json**: Full metadata export as JSON array with indentation
- **Csv**: CSV with header row, proper quote escaping
- **Text**: Plain text with one command per line (bash history compatible)

### ITerminalHistoryService Interface

- **Command Management**: AddCommandAsync, GetRecentCommandsAsync, GetSessionHistoryAsync
- **Search Operations**: SearchHistoryAsync with LIKE matching, GetUniqueCommandsAsync for autocomplete
- **History Cleanup**: ClearAllHistoryAsync, ClearHistoryOlderThanAsync
- **Session Records**: GetSessionRecordsAsync for session-level browsing
- **Export Operations**: ExportHistoryAsync with format selection
- **Statistics**: GetTotalCommandCountAsync
- **Events**: HistoryChanged for add/clear notifications

### TerminalHistoryService Implementation

- **DbContextFactory Pattern**: Uses `IDbContextFactory<AInternDbContext>` for scoped contexts from singleton
- **Thread Safety**: SemaphoreSlim for write operation synchronization
- **Comprehensive Logging**: Debug entry/exit, Info for operations, Error with context
- **Entity Mapping**: Converts between `TerminalHistoryEntity` and `TerminalHistoryEntry`

### Database Schema

- **Table**: TerminalHistory
- **Columns**: Id (PK), SessionId, Command, ExecutedAt, WorkingDirectory, ExitCode, DurationMs, ProfileId
- **Indexes**: SessionId, ExecutedAt, Command for optimized queries

## Files Changed

### New Files
| File | Description |
|------|-------------|
| `src/AIntern.Core/Models/Terminal/TerminalHistoryEntry.cs` | History entry model with computed properties |
| `src/AIntern.Core/Models/Terminal/TerminalSessionHistory.cs` | Session-level grouping model |
| `src/AIntern.Core/Models/Terminal/HistoryExportFormat.cs` | Export format enum (Json, Csv, Text) |
| `src/AIntern.Core/Interfaces/ITerminalHistoryService.cs` | Service interface with events |
| `src/AIntern.Core/Entities/TerminalHistoryEntity.cs` | Database entity for EF Core |
| `src/AIntern.Data/Configurations/TerminalHistoryConfiguration.cs` | EF Core table configuration |
| `src/AIntern.Services/Terminal/TerminalHistoryService.cs` | Full service implementation |
| `tests/AIntern.Services.Tests/Terminal/TerminalHistoryServiceTests.cs` | Service unit tests (35+) |
| `tests/AIntern.Core.Tests/Models/Terminal/TerminalHistoryEntryTests.cs` | Model unit tests (25+) |
| `tests/AIntern.Core.Tests/Models/Terminal/TerminalSessionHistoryTests.cs` | Session model unit tests (15+) |

### Modified Files
| File | Changes |
|------|---------|
| `src/AIntern.Data/AInternDbContext.cs` | Added `TerminalHistory` DbSet property |
| `src/AIntern.Services/Terminal/TerminalServiceExtensions.cs` | Registered `ITerminalHistoryService` as singleton |

## API Reference

### TerminalHistoryEntry

```csharp
public sealed class TerminalHistoryEntry
{
    // Properties
    public string Id { get; init; }                  // Auto-generated GUID
    public string Command { get; init; }             // The executed command
    public DateTime ExecutedAt { get; init; }        // UTC execution time
    public string? WorkingDirectory { get; init; }   // CWD at execution
    public int? ExitCode { get; init; }              // 0 = success
    public TimeSpan? Duration { get; init; }         // Execution duration
    public string? ProfileId { get; init; }          // Shell profile ID

    // Computed Properties
    public bool IsSuccess { get; }                   // ExitCode == 0
    public string RelativeTime { get; }              // "5m ago", "2h ago"
    public string? DurationDisplay { get; }          // "150ms", "1.5s"

    // Factory Methods
    public static TerminalHistoryEntry Create(
        string command,
        string? workingDirectory = null,
        int? exitCode = null,
        TimeSpan? duration = null,
        string? profileId = null);
    public static TerminalHistoryEntry Empty { get; }
}
```

### TerminalSessionHistory

```csharp
public sealed class TerminalSessionHistory
{
    // Properties
    public string SessionId { get; init; }
    public DateTime StartedAt { get; init; }
    public DateTime? EndedAt { get; set; }
    public string? ProfileId { get; init; }
    public string? ProfileName { get; init; }
    public List<TerminalHistoryEntry> Commands { get; init; }

    // Computed Properties
    public int CommandCount { get; }
    public TimeSpan Duration { get; }
    public bool IsActive { get; }
    public string DurationDisplay { get; }
    public string StartedAtDisplay { get; }
    public int SuccessfulCommandCount { get; }
    public int FailedCommandCount { get; }

    // Factory Methods
    public static TerminalSessionHistory Create(
        string sessionId,
        string? profileId = null,
        string? profileName = null);
    public static TerminalSessionHistory Empty { get; }
}
```

### ITerminalHistoryService

```csharp
public interface ITerminalHistoryService
{
    // Command Management
    Task AddCommandAsync(string sessionId, TerminalHistoryEntry entry);
    Task<IReadOnlyList<TerminalHistoryEntry>> GetRecentCommandsAsync(int count = 100);
    Task<IReadOnlyList<TerminalHistoryEntry>> GetSessionHistoryAsync(string sessionId);

    // Search Operations
    Task<IReadOnlyList<TerminalHistoryEntry>> SearchHistoryAsync(string query, int maxResults = 50);
    Task<IReadOnlyList<string>> GetUniqueCommandsAsync(int count = 100);

    // History Cleanup
    Task ClearAllHistoryAsync();
    Task ClearHistoryOlderThanAsync(DateTime cutoffDate);

    // Session Records
    Task<IReadOnlyList<TerminalSessionHistory>> GetSessionRecordsAsync(int count = 20);

    // Export Operations
    Task ExportHistoryAsync(string filePath, HistoryExportFormat format);

    // Statistics
    Task<int> GetTotalCommandCountAsync();

    // Events
    event EventHandler<HistoryChangedEventArgs>? HistoryChanged;
}
```

## Dependencies

- v0.5.5f: `TerminalServiceExtensions` for service registration
- v0.3.1b: `AInternDbContext` for database access
- Entity Framework Core 8.0+ for database operations

## Testing

### TerminalHistoryServiceTests (35+ tests)

**Constructor Tests**
- `Constructor_NullDbContextFactory_ThrowsArgumentNullException`
- `Constructor_NullLogger_ThrowsArgumentNullException`
- `Constructor_ValidDependencies_CreatesInstance`

**AddCommandAsync Tests**
- `AddCommandAsync_ValidEntry_PersistsToDatabase`
- `AddCommandAsync_EmptyCommand_Skipped`
- `AddCommandAsync_WhitespaceOnlyCommand_Skipped`
- `AddCommandAsync_RaisesHistoryChangedEvent`
- `AddCommandAsync_MultipleEntries_AllPersisted`
- `AddCommandAsync_NullSessionId_ThrowsArgumentNullException`
- `AddCommandAsync_NullEntry_ThrowsArgumentNullException`
- `AddCommandAsync_PreservesAllMetadata`

**GetRecentCommandsAsync Tests**
- `GetRecentCommandsAsync_ReturnsNewestFirst`
- `GetRecentCommandsAsync_RespectsCountLimit`
- `GetRecentCommandsAsync_EmptyDatabase_ReturnsEmptyList`

**GetSessionHistoryAsync Tests**
- `GetSessionHistoryAsync_ReturnsChronologically`
- `GetSessionHistoryAsync_OnlyReturnsMatchingSession`
- `GetSessionHistoryAsync_UnknownSession_ReturnsEmpty`

**SearchHistoryAsync Tests**
- `SearchHistoryAsync_FindsPartialMatches`
- `SearchHistoryAsync_EmptyQuery_ReturnsEmpty`
- `SearchHistoryAsync_WhitespaceQuery_ReturnsEmpty`
- `SearchHistoryAsync_CaseInsensitive`
- `SearchHistoryAsync_RespectsMaxResults`
- `SearchHistoryAsync_NoMatches_ReturnsEmpty`

**ClearHistoryAsync Tests**
- `ClearAllHistoryAsync_DeletesAllEntries`
- `ClearAllHistoryAsync_RaisesHistoryChangedEvent`
- `ClearHistoryOlderThanAsync_OnlyDeletesOldEntries`
- `ClearHistoryOlderThanAsync_PreservesNewEntries`

**GetUniqueCommandsAsync Tests**
- `GetUniqueCommandsAsync_ReturnsDeduplicated`
- `GetUniqueCommandsAsync_RespectsCount`
- `GetUniqueCommandsAsync_MostRecentFirst`

**GetTotalCommandCountAsync Tests**
- `GetTotalCommandCountAsync_ReturnsCorrectCount`
- `GetTotalCommandCountAsync_EmptyDatabase_ReturnsZero`

**Export Tests**
- `ExportHistoryAsync_Json_ValidFormat`
- `ExportHistoryAsync_Csv_ValidFormat`
- `ExportHistoryAsync_Text_OneCommandPerLine`
- `ExportHistoryAsync_NullPath_ThrowsArgumentException`
- `ExportHistoryAsync_EmptyPath_ThrowsArgumentException`
- `ExportHistoryAsync_InvalidFormat_ThrowsArgumentOutOfRangeException`

**Dispose Tests**
- `Dispose_CanBeCalledMultipleTimes`

### TerminalHistoryEntryTests (25+ tests)

**Property Default Tests**
- `Id_DefaultsToNewGuid`
- `Id_IsUniquePerInstance`
- `ExecutedAt_DefaultsToUtcNow`
- `Command_DefaultsToEmptyString`
- `OptionalProperties_DefaultToNull`

**IsSuccess Tests**
- `IsSuccess_TrueWhenExitCodeZero`
- `IsSuccess_FalseWhenExitCodeNonZero`
- `IsSuccess_FalseWhenExitCodeNull`

**RelativeTime Tests**
- `RelativeTime_JustNow_ReturnsJustNow`
- `RelativeTime_FewSecondsAgo_ReturnsJustNow`
- `RelativeTime_FewMinutesAgo_ReturnsMinutes`
- `RelativeTime_FewHoursAgo_ReturnsHours`
- `RelativeTime_FewDaysAgo_ReturnsDays`
- `RelativeTime_FewWeeksAgo_ReturnsWeeks`
- `RelativeTime_OverAMonthAgo_ReturnsDate`
- `RelativeTime_FutureDate_ReturnsJustNow`

**DurationDisplay Tests**
- `DurationDisplay_Null_ReturnsNull`
- `DurationDisplay_Milliseconds_FormatsCorrectly`
- `DurationDisplay_Seconds_FormatsCorrectly`
- `DurationDisplay_Minutes_FormatsCorrectly`

**Factory Method Tests**
- `Create_SetsAllProperties`
- `Create_GeneratesNewId`
- `Create_CommandOnly_SetsDefaults`
- `Empty_CreatesDefaultInstance`

### TerminalSessionHistoryTests (15+ tests)

**Property Default Tests**
- `SessionId_DefaultsToEmptyString`
- `StartedAt_DefaultsToUtcNow`
- `EndedAt_DefaultsToNull`
- `Commands_DefaultsToEmptyList`

**Computed Property Tests**
- `CommandCount_EmptyList_ReturnsZero`
- `CommandCount_WithCommands_ReturnsCount`
- `IsActive_EndedAtNull_ReturnsTrue`
- `IsActive_EndedAtSet_ReturnsFalse`
- `Duration_ActiveSession_CalculatesFromNow`
- `Duration_EndedSession_CalculatesExactDuration`
- `SuccessfulCommandCount_CountsExitCodeZero`
- `FailedCommandCount_CountsNonZeroExitCodes`

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | Commands are persisted to SQLite via EF Core | ✓ |
| AC-2 | Recent commands return newest first | ✓ |
| AC-3 | Session history returns chronologically | ✓ |
| AC-4 | Search finds partial matches (case-insensitive) | ✓ |
| AC-5 | Clear all deletes everything | ✓ |
| AC-6 | Clear older than removes only old entries | ✓ |
| AC-7 | Session records group by session ID | ✓ |
| AC-8 | Export JSON is valid, parseable JSON | ✓ |
| AC-9 | Export CSV has proper headers and escaping | ✓ |
| AC-10 | Export Text has one command per line | ✓ |
| AC-11 | HistoryChanged event fires on add and clear | ✓ |
| AC-12 | Thread-safe write operations via SemaphoreSlim | ✓ |
| AC-13 | Unique commands are deduplicated | ✓ |
| AC-14 | All tests pass (75+) | ✓ |
| AC-15 | Comprehensive XML documentation | ✓ |
| AC-16 | Changelog entries created | ✓ |

## Breaking Changes

None.

## Database Schema

```
TerminalHistory Table:
┌──────────────────────────────────────────────────────────────────────────────┐
│ Column             │ Type         │ Constraints                              │
├──────────────────────────────────────────────────────────────────────────────┤
│ Id                 │ TEXT(36)     │ PRIMARY KEY                              │
│ SessionId          │ TEXT(36)     │ NOT NULL, INDEXED                        │
│ Command            │ TEXT         │ NOT NULL, INDEXED                        │
│ ExecutedAt         │ DATETIME     │ NOT NULL, INDEXED                        │
│ WorkingDirectory   │ TEXT(1024)   │ NULL                                     │
│ ExitCode           │ INTEGER      │ NULL                                     │
│ DurationMs         │ REAL         │ NULL                                     │
│ ProfileId          │ TEXT(36)     │ NULL                                     │
└──────────────────────────────────────────────────────────────────────────────┘

Indexes:
- IX_TerminalHistory_SessionId   (session-specific queries)
- IX_TerminalHistory_ExecutedAt  (time-based ordering, cleanup)
- IX_TerminalHistory_Command     (search operations)
```

## Export Format Examples

### JSON Export
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "command": "git status",
    "executedAt": "2026-01-19T14:30:00Z",
    "workingDirectory": "/home/user/project",
    "exitCode": 0,
    "durationMs": 150.5,
    "profileId": "bash-default"
  }
]
```

### CSV Export
```csv
Command,ExecutedAt,WorkingDirectory,ExitCode,DurationMs
"git status",2026-01-19T14:30:00Z,"/home/user/project",0,150
"echo ""hello""",2026-01-19T14:31:00Z,"/home/user",0,5
```

### Text Export
```
git status
npm install
dotnet build
```
