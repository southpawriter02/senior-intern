# v0.3.4a: Token Estimation Service

**Released:** 2026-01-15

## Summary

This version implements the Token Estimation Service, providing accurate token counting
for context attachment. Three estimation algorithms are available with different
speed/accuracy trade-offs.

## New Files

| File | Description |
|------|-------------|
| `ITokenEstimationService.cs` | Interface for token estimation |
| `TokenEstimationMethod.cs` | Enum for algorithm selection |
| `TokenUsageBreakdown.cs` | Usage tracking model |
| `ContextLimitsConfig.cs` | Configurable limits |
| `TokenEstimationService.cs` | Multi-algorithm implementation |
| `TokenEstimationServiceTests.cs` | 36 unit tests |

## Modified Files

| File | Changes |
|------|---------|
| `AppSettings.cs` | Added ContextLimits property |

---

## Estimation Algorithms

| Method | Speed | Accuracy | Best For |
|--------|-------|----------|----------|
| CharacterBased | O(1) | Low | Quick estimates, typing |
| WordBased | O(n) | Medium | Default, mixed content |
| BpeApproximate | O(n×m) | High | Code, final counts |

### Algorithm Details

**CharacterBased**: `tokens = length / 3.5`

**WordBased**: Considers words, punctuation, newlines, whitespace:
```
tokens = (words / 0.75) + (punct × 0.5) + (newlines × 0.5) + (whitespace × 0.3)
```

**BpeApproximate**: Matches common programming tokens, estimates subword splits

---

## Key Features

### Token Estimation

```csharp
var service = new TokenEstimationService();

// Default (WordBased)
int tokens = service.EstimateTokens(content);

// Specific method
int tokens = service.EstimateTokens(content, TokenEstimationMethod.BpeApproximate);
```

### Limit Checking

```csharp
bool wouldExceed = service.WouldExceedLimit(currentTokens, newContent);
int limit = service.GetRecommendedContextLimit(); // 8000
```

### Truncation

```csharp
string truncated = service.TruncateToTokenLimit(content, maxTokens);
// Respects word boundaries, appends "... (truncated)"
```

### Usage Breakdown

```csharp
var breakdown = service.GetUsageBreakdown(new[] { file1, file2 });
// TotalTokens, UsagePercentage, IsOverLimit, RemainingTokens
// Per-item: Items[0].Label, Items[0].Tokens
```

---

## Configuration

```csharp
var config = new ContextLimitsConfig
{
    MaxFilesAttached = 10,      // Max files
    MaxTokensPerFile = 4000,    // Per-file limit
    MaxTotalContextTokens = 8000, // Total budget
    MaxFileSizeBytes = 500_000,   // 500KB
    WarningThreshold = 0.8,       // 80%
    MaxPreviewLines = 20,
    MaxPreviewCharacters = 500
};
```

---

## Unit Tests

36 tests covering:
- All estimation methods (12 tests)
- Limit checking (3 tests)
- Truncation (4 tests)
- Usage breakdown (4 tests)
- TokenUsageBreakdown properties (7 tests)
- ContextLimitsConfig (2 tests)
- Edge cases (4 tests)

## Build Results

- **Errors:** 0
- **Warnings:** 1 (pre-existing)
- **New Tests:** 36 passed

---

## Related Versions

- v0.3.4b: Context Attachment ViewModel (next)
- v0.3.3g: Dialogs & Integration
