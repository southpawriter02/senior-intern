# v0.4.3b: File Change Service

**Release Date:** January 16, 2026  
**Type:** Feature (Apply Changes Workflow)  
**Parent:** v0.4.3 Apply Changes Workflow

---

## Overview

v0.4.3b introduces the File Change Service - the central orchestrator for applying code changes to the filesystem with undo support, conflict detection, and change history tracking.

---

## New Files

| File | Purpose |
|------|---------|
| `Interfaces/IBackupService.cs` | Backup service contract |
| `Interfaces/IFileChangeService.cs` | File change service contract |
| `Services/FileChangeService.cs` | Main implementation (600+ LOC) |

---

## Interface: IFileChangeService

### Apply Operations
| Method | Description |
|--------|-------------|
| `ApplyCodeBlockAsync` | Apply single code block to filesystem |
| `ApplyCodeBlocksAsync` | Apply multiple blocks (merged per file) |
| `ApplyDiffAsync` | Apply pre-computed diff |

### Preview & Conflict
| Method | Description |
|--------|-------------|
| `PreviewApplyAsync` | Generate preview without modifications |
| `CheckForConflictsAsync` | Detect file modifications since last apply |

### Undo & History
| Method | Description |
|--------|-------------|
| `UndoLastChangeAsync` | Undo most recent change to file |
| `UndoChangeAsync` | Undo specific change by ID |
| `CanUndo` | Check if undo available |
| `GetChangeHistory` | Get change records for file |
| `GetPendingUndos` | Get all undoable changes |

### Events
| Event | Description |
|-------|-------------|
| `FileChanged` | File successfully changed |
| `ChangeFailed` | Apply operation failed |
| `ChangeUndone` | Change successfully undone |
| `ConflictDetected` | Conflict detected during apply |

---

## Implementation Features

- **Thread Safety**: SemaphoreSlim for apply lock, ConcurrentDictionary for history
- **Conflict Detection**: SHA-256 hash comparison
- **Line Ending Preservation**: Detects and preserves original style
- **Error Handling**: Maps exceptions to specific ApplyResultType values
- **History Pruning**: Automatic limit of 50 records per file

---

## Tests

- 18 new unit tests in `FileChangeServiceTests.cs`

---

## Verification

- ✅ Build succeeds (0 errors)
- ✅ 18 tests pass
