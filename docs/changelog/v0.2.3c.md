# Changelog: v0.2.3c - ViewModels

**Release Date:** 2026-01-13
**Previous Version:** v0.2.3b (Inference Settings Service)
**Design Document:** [v0.2.3c-viewmodels.md](../design/v0.2.x/v0.2.3c-viewmodels.md)

---

## Overview

v0.2.3c implements the ViewModel layer for inference settings, providing:

- **InferenceSettingsViewModel**: Full ViewModel for parameter sliders with debounced updates
- **InferencePresetViewModel**: Lightweight ViewModel for preset dropdown items
- **DI Registration**: Singleton registration for state persistence

This completes the service-to-ViewModel binding pattern, enabling future UI implementation in v0.2.3d.

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                      v0.2.3c Architecture                             │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  AIntern.Desktop/ViewModels/                                          │
│  ├── InferenceSettingsViewModel.cs            (NEW - ~850 lines)      │
│  │   ├── Parameter Properties (7): Temperature, TopP, TopK,           │
│  │   │   MaxTokens, ContextSize, RepetitionPenalty, Seed              │
│  │   ├── Computed Descriptions (7): TemperatureDescription, etc.      │
│  │   ├── State Properties: Presets, SelectedPreset, HasUnsavedChanges,│
│  │   │   IsExpanded, ShowAdvanced, IsLoading, NewPreset* fields       │
│  │   ├── Commands (10): Initialize, LoadPresets, ApplyPreset,         │
│  │   │   SaveAsPreset, UpdateCurrentPreset, DeletePreset,             │
│  │   │   ResetToDefaults, ToggleAdvanced, ToggleExpanded              │
│  │   ├── Debouncing: 200ms timer for batch service updates            │
│  │   ├── Event Handlers: OnSettingsChanged, OnPresetChanged           │
│  │   └── IDisposable: Event unsubscription, timer disposal            │
│  │                                                                    │
│  └── InferencePresetViewModel.cs              (NEW - ~185 lines)      │
│      ├── Id, Name, Description, Category                              │
│      ├── IsBuiltIn, IsDefault, IsSelected                             │
│      ├── ParameterSummary (computed)                                  │
│      └── TypeIndicator (computed: "Built-in" / "Custom")              │
│                                                                       │
│  AIntern.Desktop/Extensions/                                          │
│  └── ServiceCollectionExtensions.cs           (MODIFIED)              │
│      └── + AddSingleton<InferenceSettingsViewModel>()                 │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Files Created

### 1. InferenceSettingsViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/InferenceSettingsViewModel.cs`
**Lines:** ~850

#### Purpose

Main ViewModel for the inference settings panel providing two-way binding between UI sliders and `IInferenceSettingsService`.

#### Key Features

| Feature | Description |
|---------|-------------|
| **Parameter Properties** | 7 observable properties (Temperature, TopP, TopK, MaxTokens, ContextSize, RepetitionPenalty, Seed) |
| **Computed Descriptions** | Context-aware text for each parameter (e.g., "Very focused and deterministic" for low temp) |
| **200ms Debounce** | Batches slider changes before updating service to reduce event spam |
| **Feedback Loop Prevention** | `_isUpdatingFromService` flag prevents infinite ViewModel↔Service loops |
| **Preset Commands** | Load, Apply, Save, Update, Delete, Reset operations |
| **Event Subscription** | Listens to `SettingsChanged` and `PresetChanged` for external updates |
| **IDisposable** | Proper cleanup of event subscriptions and timer |

#### Debouncing Pattern

```csharp
// User drags Temperature slider rapidly
OnTemperatureChanged(0.5f)  → QueueServiceUpdate() → Timer.Reset()
OnTemperatureChanged(0.6f)  → QueueServiceUpdate() → Timer.Reset()
OnTemperatureChanged(0.7f)  → QueueServiceUpdate() → Timer.Reset()
// ... 200ms pass with no changes ...
OnDebounceElapsed()         → Service.UpdateTemperature(0.7f)
                            → Service.UpdateTopP(...)
                            → ... (batch all current values)
```

#### Feedback Loop Prevention

```csharp
// PROBLEM: Without flag, this creates infinite loop
// ViewModel.Temperature = 0.8 → Service.UpdateTemperature(0.8)
//                             → Service fires SettingsChanged
//                             → OnSettingsChanged() sets Temperature
//                             → Property setter calls QueueServiceUpdate()
//                             → Service.UpdateTemperature(0.8) ... ∞

// SOLUTION: Flag breaks the loop
OnSettingsChanged(...)
{
    _isUpdatingFromService = true;
    try
    {
        Temperature = settings.Temperature;  // Setter checks flag, skips queue
    }
    finally
    {
        _isUpdatingFromService = false;
    }
}
```

#### Commands

| Command | Description |
|---------|-------------|
| `InitializeCommand` | Loads presets and syncs initial state |
| `LoadPresetsCommand` | Refreshes preset collection from service |
| `ApplyPresetCommand` | Applies selected preset settings |
| `SaveAsPresetCommand` | Saves current settings as new preset |
| `UpdateCurrentPresetCommand` | Updates selected preset with current values |
| `DeletePresetCommand` | Deletes a custom preset |
| `ResetToDefaultsCommand` | Resets to default (Balanced) preset |
| `ToggleAdvancedCommand` | Shows/hides advanced parameters |
| `ToggleExpandedCommand` | Expands/collapses settings panel |

#### Computed Descriptions

| Property | Example Values |
|----------|----------------|
| `TemperatureDescription` | "Very focused and deterministic" (< 0.3), "Balanced creativity and consistency" (0.6-0.8) |
| `TopPDescription` | "Considers top 90% probability mass" |
| `TopKDescription` | "Consider top 40 tokens" or "Disabled" |
| `MaxTokensDescription` | "~1536 words maximum" |
| `ContextSizeDescription` | "~3072 words of history" |
| `RepetitionPenaltyDescription` | "Light repetition penalty" (1.0-1.1) |
| `SeedDescription` | "Random each generation" or "Seed: 42 (reproducible)" |

---

### 2. InferencePresetViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/InferencePresetViewModel.cs`
**Lines:** ~185

#### Purpose

Lightweight ViewModel wrapping `InferencePreset` for display in dropdowns and lists.

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique preset identifier |
| `Name` | `string` | Display name (e.g., "Balanced") |
| `Description` | `string?` | Optional description |
| `Category` | `string?` | Grouping category (e.g., "General") |
| `IsBuiltIn` | `bool` | True for system presets |
| `IsDefault` | `bool` | True if default preset |
| `IsSelected` | `bool` | True if currently active |
| `ParameterSummary` | `string` | Computed: "Temp: 0.7, TopP: 0.90, Max: 2048" |
| `TypeIndicator` | `string` | Computed: "Built-in" or "Custom" |

#### Constructor

```csharp
public InferencePresetViewModel(InferencePreset preset)
{
    Id = preset.Id;
    Name = preset.Name;
    Description = preset.Description;
    Category = preset.Category;
    IsBuiltIn = preset.IsBuiltIn;
    IsDefault = preset.IsDefault;

    // Pre-computed for performance
    ParameterSummary = $"Temp: {preset.Options.Temperature:F1}, " +
                      $"TopP: {preset.Options.TopP:F2}, " +
                      $"Max: {preset.Options.MaxTokens}";
}
```

---

## Files Modified

### ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`
**Changes:** Added DI registration for InferenceSettingsViewModel

```csharp
// Inference settings: parameter sliders and preset management.
// Singleton to maintain state across the application lifecycle.
// Subscribes to IInferenceSettingsService events for two-way sync.
services.AddSingleton<InferenceSettingsViewModel>();
```

#### Lifetime Justification

`InferenceSettingsViewModel` is registered as **Singleton** because:

1. **State Persistence**: Maintains panel expansion state, advanced visibility
2. **Event Subscriptions**: Single subscription to service events
3. **Timer Management**: Single debounce timer instance
4. **UI Consistency**: Same instance across all views referencing settings

---

## Logging Specifications

All new code follows the project's exhaustive logging patterns.

### Log Levels and Formats

| Level | Format | Usage |
|-------|--------|-------|
| Debug | `[INIT] ClassName - Description` | Constructor initialization |
| Debug | `[ENTER] MethodName - Param: {Value}` | Method entry |
| Debug | `[INFO] Description` | Significant state changes |
| Debug | `[SKIP] Reason` | No-op conditions |
| Debug | `[EXIT] MethodName - Result, Duration: {Ms}ms` | Method exit |
| Debug | `[EVENT] EventName - Details` | Event handler invocation |
| Debug | `[DISPOSE] ClassName - Description` | Disposal operations |
| Information | `[INFO] Description` | User-visible operations |
| Warning | `[EXIT] MethodName - Warning message` | Recoverable issues |
| Error | `[EXIT] MethodName - Error: {Message}` | Failures |

### Example Log Output

```
[INIT] InferenceSettingsViewModel - Subscribing to service events
[INIT] InferenceSettingsViewModel - Initialization complete
[ENTER] LoadPresetsAsync
[EXIT] LoadPresetsAsync - Count: 5, Duration: 12ms
[INFO] OnTemperatureChanged - Value: 0.8
[INFO] QueueServiceUpdate - Resetting debounce timer
[ENTER] OnDebounceElapsed - Sending batch update to service
[EXIT] OnDebounceElapsed - Duration: 3ms
[EVENT] OnSettingsChanged - Type: ParameterChanged, Parameter: Temperature
[ENTER] SyncFromService
[EXIT] SyncFromService - Temp=0.8, TopP=0.9, MaxTok=2048, Duration: 1ms
```

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **200ms Debounce** | Balance between UI responsiveness and reducing service calls |
| **Singleton Lifetime** | Maintains UI state (expanded, advanced visibility) across navigation |
| **`_isUpdatingFromService` Flag** | Prevents infinite feedback loops without complex locking |
| **Computed Descriptions** | Clean XAML bindings, dynamic updates on value changes |
| **Pre-computed ParameterSummary** | Avoids recalculation in UI rendering loops |
| **System.Timers.Timer** | Works across threads, simpler than DispatcherTimer for debouncing |
| **Batch Updates in OnDebounceElapsed** | Single timer callback updates all parameters efficiently |

---

## Threading Model

```
┌──────────────────────────────────────────────────────────────────────┐
│                        Threading Model                                │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  UI Thread (Avalonia Dispatcher)                                      │
│  ├── Property setters (Temperature, TopP, etc.)                       │
│  ├── OnPropertyChanged handlers                                       │
│  ├── Command execution (async methods)                                │
│  └── SyncFromService() (marshalled via IDispatcher)                   │
│                                                                       │
│  Timer Thread (System.Timers.Timer)                                   │
│  └── OnDebounceElapsed()                                              │
│      ├── Service.UpdateTemperature() (synchronous, thread-safe)       │
│      ├── Service.UpdateTopP()                                         │
│      └── ... (all parameter updates)                                  │
│                                                                       │
│  Service Events (may fire from any thread)                            │
│  └── OnSettingsChanged() / OnPresetChanged()                          │
│      └── _dispatcher.InvokeAsync() → UI Thread                        │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| InferencePresetViewModel | 3 | Constructor mapping, ParameterSummary format |
| InferenceSettingsViewModel | 12 | Debounce, sync, commands, descriptions |
| **Total** | **15** |  |

### Key Test Scenarios

```csharp
[Fact]
public void TemperatureDescription_ReturnsCorrectText_ForLowValues()
{
    var vm = CreateViewModel();
    vm.Temperature = 0.2f;
    Assert.Equal("Very focused and deterministic", vm.TemperatureDescription);
}

[Fact]
public void TemperatureDescription_ReturnsCorrectText_ForHighValues()
{
    var vm = CreateViewModel();
    vm.Temperature = 1.5f;
    Assert.Equal("Highly random and experimental", vm.TemperatureDescription);
}

[Fact]
public void OnTemperatureChanged_SetsHasUnsavedChanges_WhenNotUpdatingFromService()
{
    var vm = CreateViewModel();
    Assert.False(vm.HasUnsavedChanges);

    vm.Temperature = 1.0f;
    Assert.True(vm.HasUnsavedChanges);
}

[Fact]
public void SyncFromService_SetsFlag_PreventsServiceUpdate()
{
    var mockService = new Mock<IInferenceSettingsService>();
    var vm = CreateViewModel(mockService.Object);

    // Simulate service event
    mockService.Raise(s => s.SettingsChanged += null, CreateEventArgs());

    // Verify no service update was queued
    mockService.Verify(s => s.UpdateTemperature(It.IsAny<float>()), Times.Never);
}

[Fact]
public void InferencePresetViewModel_Constructor_MapsAllProperties()
{
    var preset = new InferencePreset
    {
        Id = Guid.NewGuid(),
        Name = "Test",
        Description = "Description",
        Category = "General",
        IsBuiltIn = true,
        IsDefault = false,
        Options = new InferenceSettings { Temperature = 1.5f, TopP = 0.95f, MaxTokens = 4096 }
    };

    var vm = new InferencePresetViewModel(preset);

    Assert.Equal(preset.Id, vm.Id);
    Assert.Equal("Test", vm.Name);
    Assert.True(vm.IsBuiltIn);
    Assert.Equal("Built-in", vm.TypeIndicator);
    Assert.Contains("1.5", vm.ParameterSummary);
    Assert.Contains("4096", vm.ParameterSummary);
}

[Fact]
public async Task ApplyPresetCommand_UpdatesService_WhenPresetSelected()
{
    var mockService = new Mock<IInferenceSettingsService>();
    var vm = CreateViewModel(mockService.Object);
    var preset = new InferencePresetViewModel { Id = Guid.NewGuid(), Name = "Test" };

    await vm.ApplyPresetCommand.ExecuteAsync(preset);

    mockService.Verify(s => s.ApplyPresetAsync(preset.Id, It.IsAny<CancellationToken>()), Times.Once);
}

[Fact]
public async Task DeletePresetCommand_Fails_ForBuiltInPresets()
{
    var vm = CreateViewModel();
    var builtInPreset = new InferencePresetViewModel { Id = Guid.NewGuid(), Name = "Balanced", IsBuiltIn = true };

    await vm.DeletePresetCommand.ExecuteAsync(builtInPreset);

    Assert.Contains("cannot be deleted", vm.ErrorMessage);
}
```

---

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | All 7 parameter properties bind correctly | ✓ |
| AC-2 | Computed descriptions update on value change | ✓ |
| AC-3 | Debounce timer fires after 200ms | ✓ |
| AC-4 | SyncFromService prevents feedback loops | ✓ |
| AC-5 | SelectedPreset change triggers ApplyPresetCommand | ✓ |
| AC-6 | SaveAsPresetCommand creates new preset | ✓ |
| AC-7 | DeletePresetCommand removes custom preset | ✓ |
| AC-8 | Cannot delete built-in presets (error message) | ✓ |
| AC-9 | HasUnsavedChanges reflects service state | ✓ |
| AC-10 | Event handlers use IDispatcher for UI thread | ✓ |
| AC-11 | Build passes with 0 errors, 0 warnings | ✓ |

---

## Dependencies

### Required (from v0.2.3b)

| Component | Usage |
|-----------|-------|
| `IInferenceSettingsService` | Parameter updates, preset operations |
| `InferenceSettingsChangedEventArgs` | Settings change events |
| `PresetChangedEventArgs` | Preset CRUD events |
| `InferenceSettings` | Parameter value object |
| `InferencePreset` | Preset domain model |
| `ParameterConstants` | Default values |

### Required (from existing infrastructure)

| Component | Usage |
|-----------|-------|
| `IDispatcher` | UI thread marshalling |
| `ViewModelBase` | Base class with IsBusy, ErrorMessage |
| `CommunityToolkit.Mvvm` | [ObservableProperty], [RelayCommand] |

---

## Migration Notes

### From Previous Version

No breaking changes. New ViewModels are additive.

### Integration with Existing Code

The `InferenceSettingsViewModel` can be injected into views that need parameter controls:

```csharp
// In a View's code-behind or another ViewModel
public class SomeViewModel
{
    private readonly InferenceSettingsViewModel _settingsVm;

    public SomeViewModel(InferenceSettingsViewModel settingsVm)
    {
        _settingsVm = settingsVm;
    }
}
```

---

## Next Steps (v0.2.3d+)

| Version | Description |
|---------|-------------|
| v0.2.3d | ParameterSlider control and PresetSelector UI |
| v0.2.3e | Wire UI to ViewModel layer with live preview |
| v0.2.3f | Integration testing and polish |

---

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `ViewModels/InferenceSettingsViewModel.cs` | Created | ~850 |
| `ViewModels/InferencePresetViewModel.cs` | Created | ~185 |
| `Extensions/ServiceCollectionExtensions.cs` | Modified | +5 |
| **Total** | | ~1,040 |
