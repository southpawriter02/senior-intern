# Design Specification: AIntern v0.2.1c "DbContext & Configuration"

## Executive Summary

This document provides a detailed implementation specification for v0.2.1c, which implements the Entity Framework Core DbContext with Fluent API configurations. This creates the database schema mapping for all entities defined in v0.2.1b.

### v0.2.1c Scope

- Create `SeniorInternDbContext` with DbSet properties
- Implement entity type configurations using Fluent API
- Define table names, column constraints, and indexes
- Configure entity relationships and delete behaviors
- Set up automatic timestamp management
- Prepare for EF Core migrations

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| SeniorInternDbContext | Main EF Core DbContext with 4 DbSets and timestamp automation |
| ConversationConfiguration | Fluent API config with indexes for list queries |
| MessageConfiguration | Fluent API config with unique sequence constraint |
| SystemPromptConfiguration | Fluent API config with unique name constraint |
| InferencePresetConfiguration | Fluent API config with parameter defaults |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.1c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  DbContext & Configuration                                        │
│  ├── SeniorInternDbContext                                        │
│  │   ├── DbSet<ConversationEntity>                                │
│  │   ├── DbSet<MessageEntity>                                     │
│  │   ├── DbSet<SystemPromptEntity>                                │
│  │   ├── DbSet<InferencePresetEntity>                             │
│  │   ├── Dual constructors (DI + parameterless)                   │
│  │   └── Automatic timestamp management                           │
│  │                                                                │
│  ├── Entity Configurations                                        │
│  │   ├── ConversationConfiguration (6 indexes)                    │
│  │   ├── MessageConfiguration (4 indexes, 1 unique)               │
│  │   ├── SystemPromptConfiguration (6 indexes, 1 unique)          │
│  │   └── InferencePresetConfiguration (3 indexes, 1 unique)       │
│  │                                                                │
│  └── Relationships                                                │
│      ├── SystemPrompt → Conversations (1:N, SetNull)              │
│      └── Conversation → Messages (1:N, Cascade)                   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Database Schema

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              SystemPrompts                               │
├─────────────────────────────────────────────────────────────────────────┤
│ PK   Id              BLOB         NOT NULL                               │
│      Name            TEXT(100)    NOT NULL    UNIQUE                     │
│      Description     TEXT(500)    NULL                                   │
│      Content         TEXT         NOT NULL                               │
│      Category        TEXT(50)     NOT NULL    DEFAULT 'General'          │
│      CreatedAt       TEXT         NOT NULL                               │
│      UpdatedAt       TEXT         NOT NULL                               │
│      IsDefault       INTEGER      NOT NULL    DEFAULT 0                  │
│      IsBuiltIn       INTEGER      NOT NULL    DEFAULT 0                  │
│      IsActive        INTEGER      NOT NULL    DEFAULT 1                  │
│      UsageCount      INTEGER      NOT NULL    DEFAULT 0                  │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ 1:N (ON DELETE SET NULL)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              Conversations                               │
├─────────────────────────────────────────────────────────────────────────┤
│ PK   Id              BLOB         NOT NULL                               │
│ FK   SystemPromptId  BLOB         NULL        -> SystemPrompts(Id)       │
│      Title           TEXT(200)    NOT NULL    DEFAULT 'New Conversation' │
│      ModelPath       TEXT(500)    NULL                                   │
│      ModelName       TEXT(100)    NULL                                   │
│      CreatedAt       TEXT         NOT NULL                               │
│      UpdatedAt       TEXT         NOT NULL                               │
│      IsArchived      INTEGER      NOT NULL    DEFAULT 0                  │
│      IsPinned        INTEGER      NOT NULL    DEFAULT 0                  │
│      MessageCount    INTEGER      NOT NULL    DEFAULT 0                  │
│      TotalTokenCount INTEGER      NOT NULL    DEFAULT 0                  │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ 1:N (ON DELETE CASCADE)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                Messages                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ PK   Id              BLOB         NOT NULL                               │
│ FK   ConversationId  BLOB         NOT NULL    -> Conversations(Id)       │
│      Role            INTEGER      NOT NULL    (0=System,1=User,2=Asst)   │
│      Content         TEXT         NOT NULL                               │
│      SequenceNumber  INTEGER      NOT NULL    UNIQUE(ConversationId)     │
│      Timestamp       TEXT         NOT NULL                               │
│      EditedAt        TEXT         NULL                                   │
│      TokenCount      INTEGER      NULL                                   │
│      GenerationTimeMs INTEGER     NULL                                   │
│      TokensPerSecond REAL         NULL                                   │
│      IsEdited        INTEGER      NOT NULL    DEFAULT 0                  │
│      IsComplete      INTEGER      NOT NULL    DEFAULT 1                  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                            InferencePresets                              │
├─────────────────────────────────────────────────────────────────────────┤
│ PK   Id              BLOB         NOT NULL                               │
│      Name            TEXT(100)    NOT NULL    UNIQUE                     │
│      Description     TEXT(500)    NULL                                   │
│      Temperature     REAL         NOT NULL    DEFAULT 0.7                │
│      TopP            REAL         NOT NULL    DEFAULT 0.9                │
│      TopK            INTEGER      NOT NULL    DEFAULT 40                 │
│      RepeatPenalty   REAL         NOT NULL    DEFAULT 1.1                │
│      MaxTokens       INTEGER      NOT NULL    DEFAULT 2048               │
│      ContextSize     INTEGER      NOT NULL    DEFAULT 4096               │
│      IsDefault       INTEGER      NOT NULL    DEFAULT 0                  │
│      IsBuiltIn       INTEGER      NOT NULL    DEFAULT 0                  │
│      CreatedAt       TEXT         NOT NULL                               │
│      UpdatedAt       TEXT         NOT NULL                               │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Prerequisites

Before implementing v0.2.1c, ensure:
- v0.2.1a is complete (Data project with EF Core packages)
- v0.2.1b is complete (Entity classes in Core project)
- Solution builds successfully

---

## Directory Structure

After v0.2.1c implementation:

```
src/SeniorIntern.Data/
├── SeniorIntern.Data.csproj
├── DatabasePathResolver.cs          (from v0.2.1a)
├── SeniorInternDbContext.cs          (NEW)
└── Configurations/
    ├── ConversationConfiguration.cs  (NEW)
    ├── MessageConfiguration.cs       (NEW)
    ├── SystemPromptConfiguration.cs  (NEW)
    └── InferencePresetConfiguration.cs (NEW)
```

---

## Implementation Details

### Task 1: Create SeniorInternDbContext

**File:** `src/SeniorIntern.Data/SeniorInternDbContext.cs`

The DbContext manages four entity sets with automatic timestamp management via SaveChanges overrides.

**Key Features:**
- Expression-bodied DbSet properties using `Set<T>()`
- Dual constructors (options-based for DI, parameterless for design-time)
- Auto-discovery of configurations via `ApplyConfigurationsFromAssembly`
- Automatic CreatedAt/UpdatedAt timestamp updates

See **Appendix A** for full implementation.

---

### Task 2-5: Entity Configurations

Each entity has a dedicated `IEntityTypeConfiguration<T>` class in the `Configurations/` directory.

| Configuration | Table | Unique Constraints | Key Indexes |
|--------------|-------|-------------------|-------------|
| ConversationConfiguration | Conversations | - | UpdatedAt, IsArchived, IsPinned, composite list |
| MessageConfiguration | Messages | (ConversationId, SequenceNumber) | ConversationId, Timestamp, Role |
| SystemPromptConfiguration | SystemPrompts | Name | IsDefault, Category, IsActive, UsageCount |
| InferencePresetConfiguration | InferencePresets | Name | IsDefault, composite list |

See **Appendix B-E** for full implementations.

---

## Delete Behavior Summary

| Relationship | Delete Behavior | Explanation |
|--------------|-----------------|-------------|
| SystemPrompt → Conversations | SetNull | Deleting a prompt sets `SystemPromptId` to null |
| Conversation → Messages | Cascade | Deleting a conversation deletes all its messages |

---

## Index Strategy

| Query Pattern | Supporting Index |
|---------------|------------------|
| List conversations (non-archived, sorted) | `IX_Conversations_List` |
| Get messages for conversation | `IX_Messages_ConversationId` |
| Ensure message ordering | `IX_Messages_ConversationId_SequenceNumber` (unique) |
| Find default system prompt | `IX_SystemPrompts_IsDefault` |
| List active system prompts | `IX_SystemPrompts_ActiveList` |
| Find default inference preset | `IX_InferencePresets_IsDefault` |

---

## SQLite Type Mappings

| C# Type | SQLite Type | Notes |
|---------|-------------|-------|
| `Guid` | BLOB | 16-byte binary |
| `string` | TEXT | UTF-8 encoded |
| `DateTime` | TEXT | ISO 8601 format |
| `bool` | INTEGER | 0/1 |
| `int` | INTEGER | 32-bit signed |
| `float` | REAL | 64-bit floating point |
| `enum` | INTEGER | Underlying int value |

---

## Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| SeniorInternDbContext | Debug | Configuration loaded, timestamps updated |
| SeniorInternDbContext | Information | Migration applied, database created |
| SeniorInternDbContext | Warning | Design-time fallback used |
| SeniorInternDbContext | Error | Save failure, connection error |

---

## Unit Testing Requirements

### Test Summary

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| SeniorInternDbContext | 8 | DbSet access, timestamps, configuration loading |
| ConversationConfiguration | 4 | Indexes, relationships, constraints |
| MessageConfiguration | 4 | Unique constraint, FK, enum storage |
| SystemPromptConfiguration | 3 | Unique name, defaults |
| InferencePresetConfiguration | 3 | Parameter defaults, unique name |
| **Total** | **22** | |

### Key Test Scenarios

```csharp
[Fact]
public async Task SaveChangesAsync_SetsCreatedAtOnAdd()
{
    // Arrange
    using var context = CreateInMemoryContext();
    var conversation = new ConversationEntity { Id = Guid.NewGuid(), Title = "Test" };
    
    // Act
    context.Conversations.Add(conversation);
    await context.SaveChangesAsync();
    
    // Assert
    Assert.NotEqual(default, conversation.CreatedAt);
    Assert.Equal(conversation.CreatedAt, conversation.UpdatedAt);
}

[Fact]
public async Task SaveChangesAsync_UpdatesUpdatedAtOnModify()
{
    // Arrange
    using var context = CreateInMemoryContext();
    var conversation = new ConversationEntity { Id = Guid.NewGuid() };
    context.Conversations.Add(conversation);
    await context.SaveChangesAsync();
    var originalUpdatedAt = conversation.UpdatedAt;
    
    await Task.Delay(10); // Ensure time difference
    
    // Act
    conversation.Title = "Modified";
    await context.SaveChangesAsync();
    
    // Assert
    Assert.True(conversation.UpdatedAt > originalUpdatedAt);
}

[Fact]
public async Task DeleteConversation_CascadeDeletesMessages()
{
    // Arrange
    using var context = CreateInMemoryContext();
    var conversation = new ConversationEntity { Id = Guid.NewGuid() };
    var message = new MessageEntity 
    { 
        Id = Guid.NewGuid(), 
        ConversationId = conversation.Id,
        Role = MessageRole.User,
        Content = "Test"
    };
    context.Conversations.Add(conversation);
    context.Messages.Add(message);
    await context.SaveChangesAsync();
    
    // Act
    context.Conversations.Remove(conversation);
    await context.SaveChangesAsync();
    
    // Assert
    Assert.Empty(context.Messages);
}
```

---

## Use Cases

### UC-001: Initialize Database on First Run

| Attribute | Value |
|-----------|-------|
| **Actor** | Application Startup |
| **Trigger** | First application launch |
| **Success Scenario** | Database created with all tables and indexes |
| **Postcondition** | SQLite database exists at platform-specific path |

### UC-002: Save Entity with Automatic Timestamps

| Attribute | Value |
|-----------|-------|
| **Actor** | Any service calling SaveChanges |
| **Trigger** | Entity added or modified |
| **Success Scenario** | CreatedAt/UpdatedAt set automatically |

---

## Deliverable Checklist

### Data Layer (SeniorIntern.Data)
- [x] SeniorInternDbContext.cs
- [x] Configurations/ConversationConfiguration.cs
- [x] Configurations/MessageConfiguration.cs
- [x] Configurations/SystemPromptConfiguration.cs
- [x] Configurations/InferencePresetConfiguration.cs

### Tests
- [ ] SeniorIntern.Data.Tests - DbContext and configuration tests

---

## Files Summary

### Files to Create (5)

| File | Purpose | Lines (approx) |
|------|---------|----------------|
| `SeniorInternDbContext.cs` | Main DbContext class | 200 |
| `Configurations/ConversationConfiguration.cs` | Conversation mapping | 100 |
| `Configurations/MessageConfiguration.cs` | Message mapping | 90 |
| `Configurations/SystemPromptConfiguration.cs` | System prompt mapping | 95 |
| `Configurations/InferencePresetConfiguration.cs` | Inference preset mapping | 85 |

### Directories to Create

| Directory | Purpose |
|-----------|---------|
| `src/SeniorIntern.Data/Configurations/` | Entity configuration classes |

---

## Verification Steps

### Step 1: Verify Compilation

```bash
dotnet build src/SeniorIntern.Data
```

### Step 2: Create Initial Migration

```bash
cd src/SeniorIntern.Data
dotnet ef migrations add InitialCreate --output-dir Migrations
```

### Step 3: Verify Migration Content

Check for 4 CreateTable calls, foreign keys, and indexes.

### Step 4: Generate SQL Script (Optional)

```bash
dotnet ef migrations script --output schema.sql
```

---

## Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | DbContext compiles | `dotnet build` succeeds |
| AC-2 | All configurations compile | No errors in Configurations/ |
| AC-3 | Initial migration generates | `dotnet ef migrations add` succeeds |
| AC-4 | Migration creates 4 tables | Review migration file |
| AC-5 | Foreign keys are correct | FK_Messages_Conversations, FK_Conversations_SystemPrompts |
| AC-6 | Delete behaviors are correct | Cascade for Messages, SetNull for SystemPrompt |
| AC-7 | Unique constraints exist | Name columns on SystemPrompts and InferencePresets |
| AC-8 | Indexes are created | All IX_ indexes in migration |
| AC-9 | Timestamps auto-update | SaveChanges sets CreatedAt/UpdatedAt |
| AC-10 | Default values are set | Verify in migration SQL |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Migration generation fails | Low | High | Ensure EF Core tools installed; verify entity configs |
| Index naming conflicts | Low | Low | Use explicit `HasDatabaseName()` |
| SQLite type mismatch | Low | Medium | Follow EF Core SQLite conventions |
| Timestamp race conditions | Low | Low | Use UTC time consistently |

---

## Design Decisions

### Decision 1: Separate Configuration Classes

**Decision:** Use `IEntityTypeConfiguration<T>` per entity.
**Rationale:** Better organization, easier maintenance, auto-discovery support.

### Decision 2: Explicit Index Names

**Decision:** Specify `HasDatabaseName()` for all indexes.
**Rationale:** Predictable names, easier debugging.

### Decision 3: Parameterless Constructor

**Decision:** Include parameterless DbContext constructor.
**Rationale:** Required for EF Core design-time tools and unit testing.

### Decision 4: Table Comments

**Decision:** Add `HasComment()` to tables and columns.
**Rationale:** Self-documenting schema.

---

## Future Considerations

| Item | Target Version | Rationale |
|------|----------------|-----------|
| Query logging | v0.2.5+ | Performance monitoring |
| Connection pooling | v0.3.0+ | Scalability |
| Read replicas | v0.5.0+ | Advanced deployment |

---

## Timeline Estimate

| Version | Estimated Effort | Key Deliverables |
|---------|------------------|------------------|
| v0.2.1c | 0.5-1 day | DbContext, 4 configurations, initial migration |

---

## Next Steps

After completing v0.2.1c, proceed to:

**v0.2.1d: Repository Layer**
- Create repository interfaces
- Implement repository classes
- Add specialized query methods
- Register with DI

---

## Appendix: Migration Commands Reference

```bash
# Create migration
dotnet ef migrations add <Name> --project src/SeniorIntern.Data

# Remove last migration
dotnet ef migrations remove --project src/SeniorIntern.Data

# Apply migrations
dotnet ef database update --project src/SeniorIntern.Data

# Generate SQL
dotnet ef migrations script --project src/SeniorIntern.Data --output schema.sql
```

---

## References

- [EF Core DbContext](https://learn.microsoft.com/en-us/ef/core/dbcontext-configuration/)
- [EF Core Fluent API](https://learn.microsoft.com/en-us/ef/core/modeling/)
- [SQLite EF Core Provider](https://learn.microsoft.com/en-us/ef/core/providers/sqlite/)
- [EF Core Migrations](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
