# Design Specification: The Senior Intern v0.2.4a "Models & Repository"

## Executive Summary

This document provides a detailed implementation specification for v0.2.4a, which defines the system prompt domain model, enhances the database entity, implements the repository with full CRUD support, and creates a library of built-in system prompt templates.

### v0.2.4a Scope (from v0.2.4 Design Document)

- Create `SystemPrompt` domain model with validation
- Enhance `SystemPromptEntity` for database storage
- Create EF Core configuration for the entity
- Implement `ISystemPromptRepository` interface and repository
- Create `SystemPromptTemplates` static class with 8 built-in templates
- Seed built-in templates on initialization

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| SystemPrompt | Domain model with validation and Duplicate() |
| SystemPromptEntity | Enhanced EF Core entity |
| SystemPromptConfiguration | EF Core fluent configuration |
| ISystemPromptRepository | Repository interface |
| SystemPromptRepository | Full implementation with seeding |
| SystemPromptTemplates | 8 built-in prompt templates |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.4a Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  SystemPrompt (Domain Model)                                      │
│  ├── Properties                                                   │
│  │   ├── Id (Guid)                                                │
│  │   ├── Name (string, required, max 100)                         │
│  │   ├── Content (string, required, max 50000)                    │
│  │   ├── Description (string?, max 500)                           │
│  │   ├── Category (string: "Custom", "General", "Code", etc.)     │
│  │   ├── Tags (IReadOnlyList<string>)                             │
│  │   ├── IsBuiltIn, IsDefault (bool)                              │
│  │   ├── CreatedAt, UpdatedAt (DateTime)                          │
│  │   └── UsageCount (int)                                         │
│  ├── Computed Properties                                          │
│  │   ├── CharacterCount → Content.Length                          │
│  │   └── EstimatedTokenCount → CharacterCount / 4                 │
│  └── Methods                                                      │
│      ├── Duplicate(newName?) → SystemPrompt                       │
│      └── Validate() → ValidationResult                            │
│                                                                   │
│  ISystemPromptRepository                                          │
│  ├── Query Methods                                                │
│  │   ├── GetAllAsync()                                            │
│  │   ├── GetUserPromptsAsync() (non-built-in)                     │
│  │   ├── GetBuiltInPromptsAsync() (templates)                     │
│  │   ├── GetByCategoryAsync(category)                             │
│  │   ├── GetByIdAsync(id)                                         │
│  │   ├── GetByNameAsync(name)                                     │
│  │   ├── GetDefaultAsync()                                        │
│  │   └── SearchAsync(query)                                       │
│  ├── Mutation Methods                                             │
│  │   ├── CreateAsync(prompt)                                      │
│  │   ├── UpdateAsync(prompt)                                      │
│  │   ├── DeleteAsync(id)                                          │
│  │   ├── SetAsDefaultAsync(id)                                    │
│  │   └── IncrementUsageAsync(id)                                  │
│  └── Utilities                                                    │
│      ├── NameExistsAsync(name, excludeId?)                        │
│      └── SeedBuiltInPromptsAsync()                                │
│                                                                   │
│  SystemPromptTemplates (Built-in Library)                         │
│  ├── Default Assistant (general, helpful, default)                │
│  ├── The Senior Intern (snarky, coding, humor)                    │
│  ├── Code Expert (precise, technical)                             │
│  ├── Technical Writer (documentation)                             │
│  ├── Rubber Duck (debugging questions)                            │
│  ├── Socratic Tutor (teaching through questions)                  │
│  ├── Code Reviewer (PR review focused)                            │
│  └── Debugger (systematic debugging)                              │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Model Relationships

```
┌─────────────────────────────────────────────────────────────────┐
│                    Model Layer Architecture                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Domain Model                         Entity                     │
│  ┌────────────────────────┐           ┌────────────────────────┐ │
│  │     SystemPrompt       │  ◄─────►  │  SystemPromptEntity    │ │
│  │  - Id                  │  Mapping  │  - Id                  │ │
│  │  - Name                │           │  - Name                │ │
│  │  - Content             │           │  - Content             │ │
│  │  - Description         │           │  - Description         │ │
│  │  - Category            │           │  - Category            │ │
│  │  - Tags (list)         │           │  - TagsJson (string)   │ │
│  │  - IsBuiltIn           │           │  - IsBuiltIn           │ │
│  │  - IsDefault           │           │  - IsDefault           │ │
│  │  - CharacterCount ←────┼── computed│                        │ │
│  │  - EstimatedTokens ←───┼── computed│                        │ │
│  │  + Duplicate()         │           │                        │ │
│  │  + Validate()          │           │                        │ │
│  └────────────────────────┘           └────────────────────────┘ │
│                                                   │              │
│                                                   │ FK nullable  │
│                                                   ▼              │
│                                       ┌────────────────────────┐ │
│                                       │  ConversationEntity    │ │
│                                       │  - SystemPromptId?     │ │
│                                       └────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Built-in Templates Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                  Built-in Template Categories                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Category: General                                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ★ Default Assistant (IsDefault=true)                      │   │
│  │   "A balanced, helpful assistant for general tasks"       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Category: Creative                                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   The Senior Intern                                       │   │
│  │   "Technically brilliant with a dash of sarcasm"          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Category: Code                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   Code Expert          "Precise, technical responses"     │   │
│  │   Rubber Duck          "Debugging through questions"      │   │
│  │   Code Reviewer        "Focused PR/code review"           │   │
│  │   Debugger             "Systematic debugging assistant"   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Category: Technical                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │   Technical Writer     "Documentation specialist"         │   │
│  │   Socratic Tutor       "Teaching through questions"       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Well-Known GUIDs (for stable reference):                        │
│  00000002-0000-0000-0000-000000000001  Default Assistant         │
│  00000002-0000-0000-0000-000000000002  The Senior Intern         │
│  00000002-0000-0000-0000-000000000003  Code Expert               │
│  00000002-0000-0000-0000-000000000004  Technical Writer          │
│  00000002-0000-0000-0000-000000000005  Rubber Duck               │
│  00000002-0000-0000-0000-000000000006  Socratic Tutor            │
│  00000002-0000-0000-0000-000000000007  Code Reviewer             │
│  00000002-0000-0000-0000-000000000008  Debugger                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Models/
│   ├── SystemPrompt.cs                               (NEW)
│   └── ValidationResult.cs                           (NEW or shared)
├── Entities/
│   └── SystemPromptEntity.cs                         (UPDATE)
└── Templates/
    └── SystemPromptTemplates.cs                      (NEW)

src/SeniorIntern.Data/
├── Configurations/
│   └── SystemPromptConfiguration.cs                  (NEW)
└── Repositories/
    ├── ISystemPromptRepository.cs                    (NEW)
    └── SystemPromptRepository.cs                     (NEW)
```

---

## Implementation Details

### Task 1: Create SystemPrompt Domain Model

**File:** `src/SeniorIntern.Core/Models/SystemPrompt.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Domain model for a system prompt.</summary>
public sealed class SystemPrompt
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string Content { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Category { get; set; } = "Custom";
    public IReadOnlyList<string> Tags { get; set; } = Array.Empty<string>();
    public bool IsBuiltIn { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public int UsageCount { get; set; }

    /// <summary>Character count of the content.</summary>
    public int CharacterCount => Content?.Length ?? 0;

    /// <summary>Estimated token count (~4 chars per token).</summary>
    public int EstimatedTokenCount => CharacterCount / 4;

    /// <summary>Creates a copy with a new ID.</summary>
    public SystemPrompt Duplicate(string? newName = null) => new()
    {
        Id = Guid.NewGuid(),
        Name = newName ?? $"{Name} (Copy)",
        Content = Content,
        Description = Description,
        Category = "Custom",
        Tags = Tags.ToList(),
        IsBuiltIn = false,
        IsDefault = false,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow
    };

    /// <summary>Validates the prompt.</summary>
    public ValidationResult Validate()
    {
        var errors = new List<string>();
        if (string.IsNullOrWhiteSpace(Name)) errors.Add("Name is required");
        if (Name?.Length > 100) errors.Add("Name must be 100 characters or less");
        if (string.IsNullOrWhiteSpace(Content)) errors.Add("Content is required");
        if (Content?.Length > 50000) errors.Add("Content must be 50,000 characters or less");
        if (Description?.Length > 500) errors.Add("Description must be 500 characters or less");
        return new ValidationResult(errors.Count == 0, errors);
    }
}

/// <summary>Validation result.</summary>
public sealed record ValidationResult(bool IsValid, IReadOnlyList<string> Errors);
```

---

### Task 2: Update SystemPromptEntity

**File:** `src/SeniorIntern.Core/Entities/SystemPromptEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>Database entity for system prompts.</summary>
public sealed class SystemPromptEntity
{
    public Guid Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string Content { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Category { get; set; } = "Custom";
    public string? TagsJson { get; set; }  // JSON array of strings
    public bool IsBuiltIn { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public int UsageCount { get; set; }

    // Navigation property
    public ICollection<ConversationEntity> Conversations { get; set; } = new List<ConversationEntity>();
}
```

---

### Task 3: Create EF Core Configuration

**File:** `src/SeniorIntern.Data/Configurations/SystemPromptConfiguration.cs`

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

public sealed class SystemPromptConfiguration : IEntityTypeConfiguration<SystemPromptEntity>
{
    public void Configure(EntityTypeBuilder<SystemPromptEntity> builder)
    {
        builder.ToTable("SystemPrompts");
        builder.HasKey(e => e.Id);

        builder.Property(e => e.Name).IsRequired().HasMaxLength(100);
        builder.Property(e => e.Content).IsRequired().HasMaxLength(50000);
        builder.Property(e => e.Description).HasMaxLength(500);
        builder.Property(e => e.Category).IsRequired().HasMaxLength(50).HasDefaultValue("Custom");
        builder.Property(e => e.TagsJson).HasMaxLength(1000);
        builder.Property(e => e.CreatedAt).IsRequired();
        builder.Property(e => e.UpdatedAt).IsRequired();

        builder.HasIndex(e => e.Name).IsUnique();
        builder.HasIndex(e => e.IsDefault);
        builder.HasIndex(e => e.Category);
    }
}
```

---

### Task 4: Create ISystemPromptRepository Interface

**File:** `src/SeniorIntern.Data/Repositories/ISystemPromptRepository.cs`

```csharp
namespace SeniorIntern.Data.Repositories;

using SeniorIntern.Core.Entities;

public interface ISystemPromptRepository
{
    // Query methods
    Task<IReadOnlyList<SystemPromptEntity>> GetAllAsync(CancellationToken ct = default);
    Task<IReadOnlyList<SystemPromptEntity>> GetUserPromptsAsync(CancellationToken ct = default);
    Task<IReadOnlyList<SystemPromptEntity>> GetBuiltInPromptsAsync(CancellationToken ct = default);
    Task<IReadOnlyList<SystemPromptEntity>> GetByCategoryAsync(string category, CancellationToken ct = default);
    Task<SystemPromptEntity?> GetByIdAsync(Guid id, CancellationToken ct = default);
    Task<SystemPromptEntity?> GetByNameAsync(string name, CancellationToken ct = default);
    Task<SystemPromptEntity?> GetDefaultAsync(CancellationToken ct = default);
    Task<IReadOnlyList<SystemPromptEntity>> SearchAsync(string query, CancellationToken ct = default);

    // Mutation methods
    Task<SystemPromptEntity> CreateAsync(SystemPromptEntity prompt, CancellationToken ct = default);
    Task UpdateAsync(SystemPromptEntity prompt, CancellationToken ct = default);
    Task DeleteAsync(Guid id, CancellationToken ct = default);
    Task SetAsDefaultAsync(Guid id, CancellationToken ct = default);
    Task IncrementUsageAsync(Guid id, CancellationToken ct = default);

    // Utilities
    Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default);
    Task SeedBuiltInPromptsAsync(CancellationToken ct = default);
}
```

---

### Task 5: Implement SystemPromptRepository

**File:** `src/SeniorIntern.Data/Repositories/SystemPromptRepository.cs`

Key implementation patterns:

```csharp
namespace SeniorIntern.Data.Repositories;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Templates;

public sealed class SystemPromptRepository : ISystemPromptRepository
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<SystemPromptRepository> _logger;

    // Constructor...

    public async Task<IReadOnlyList<SystemPromptEntity>> GetAllAsync(CancellationToken ct = default)
    {
        return await _context.SystemPrompts
            .OrderByDescending(p => p.IsDefault)
            .ThenBy(p => p.IsBuiltIn)
            .ThenBy(p => p.Category)
            .ThenBy(p => p.Name)
            .ToListAsync(ct);
    }

    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        var prompt = await _context.SystemPrompts.FindAsync(new object[] { id }, ct);
        if (prompt == null) return;
        if (prompt.IsBuiltIn) throw new InvalidOperationException("Cannot delete built-in prompts");

        // Clear SystemPromptId from conversations using this prompt
        var conversations = await _context.Conversations
            .Where(c => c.SystemPromptId == id).ToListAsync(ct);
        foreach (var conv in conversations) conv.SystemPromptId = null;

        _context.SystemPrompts.Remove(prompt);
        await _context.SaveChangesAsync(ct);
    }

    public async Task SetAsDefaultAsync(Guid id, CancellationToken ct = default)
    {
        var currentDefault = await _context.SystemPrompts.FirstOrDefaultAsync(p => p.IsDefault, ct);
        if (currentDefault != null) currentDefault.IsDefault = false;

        var newDefault = await _context.SystemPrompts.FindAsync(new object[] { id }, ct);
        if (newDefault != null)
        {
            newDefault.IsDefault = true;
            await _context.SaveChangesAsync(ct);
        }
    }

    public async Task SeedBuiltInPromptsAsync(CancellationToken ct = default)
    {
        if (await _context.SystemPrompts.AnyAsync(p => p.IsBuiltIn, ct)) return;
        var templates = SystemPromptTemplates.GetAllTemplates();
        _context.SystemPrompts.AddRange(templates);
        await _context.SaveChangesAsync(ct);
        _logger.LogInformation("Seeded {Count} built-in system prompts", templates.Count);
    }
}
```

---

### Task 6: Create SystemPromptTemplates

**File:** `src/SeniorIntern.Core/Templates/SystemPromptTemplates.cs`

```csharp
namespace SeniorIntern.Core.Templates;

using SeniorIntern.Core.Entities;
using System.Text.Json;

public static class SystemPromptTemplates
{
    public static IReadOnlyList<SystemPromptEntity> GetAllTemplates() => new List<SystemPromptEntity>
    {
        CreateDefaultAssistant(),
        CreateSnarkyIntern(),
        CreateCodeExpert(),
        CreateTechnicalWriter(),
        CreateRubberDuck(),
        CreateSocraticTutor(),
        CreateCodeReviewer(),
        CreateDebugger()
    };

    private static SystemPromptEntity CreateDefaultAssistant() => new()
    {
        Id = Guid.Parse("00000002-0000-0000-0000-000000000001"),
        Name = "Default Assistant",
        Description = "A balanced, helpful assistant for general conversations.",
        Category = "General",
        TagsJson = JsonSerializer.Serialize(new[] { "general", "helpful", "balanced" }),
        IsBuiltIn = true,
        IsDefault = true,
        Content = """
            You are a helpful AI assistant. You provide clear, accurate, and 
            well-structured responses to help users with their questions and tasks.
            
            Guidelines:
            - Be concise but thorough
            - Ask clarifying questions when the request is ambiguous
            - Provide examples when they would be helpful
            - Acknowledge when you're uncertain
            """
    };

    private static SystemPromptEntity CreateSnarkyIntern() => new()
    {
        Id = Guid.Parse("00000002-0000-0000-0000-000000000002"),
        Name = "The Senior Intern",
        Description = "Technically brilliant with a dash of sarcasm.",
        Category = "Creative",
        // ... full content
    };

    // Additional templates: CodeExpert, TechnicalWriter, RubberDuck, 
    // SocraticTutor, CodeReviewer, Debugger...
}
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| SystemPrompt | 6 | Validate(), Duplicate(), CharacterCount |
| SystemPromptRepository | 14 | CRUD, search, seeding, constraints |
| SystemPromptTemplates | 3 | All templates present, valid structure |
| **Total** | **23** | |

### Key Test Scenarios

```csharp
[Fact]
public void Validate_ReturnsErrors_WhenNameEmpty()
{
    var prompt = new SystemPrompt { Name = "", Content = "Test" };
    var result = prompt.Validate();
    Assert.False(result.IsValid);
    Assert.Contains("Name is required", result.Errors);
}

[Fact]
public void Duplicate_CreatesNewId_AndResetsFlags()
{
    var original = new SystemPrompt { Name = "Test", IsBuiltIn = true, IsDefault = true };
    var copy = original.Duplicate();
    Assert.NotEqual(original.Id, copy.Id);
    Assert.Equal("Test (Copy)", copy.Name);
    Assert.False(copy.IsBuiltIn);
    Assert.False(copy.IsDefault);
}

[Fact]
public async Task DeleteAsync_ThrowsForBuiltIn()
{
    await SeedBuiltIn();
    var builtIn = await _repo.GetByNameAsync("Default Assistant");
    await Assert.ThrowsAsync<InvalidOperationException>(() => _repo.DeleteAsync(builtIn!.Id));
}

[Fact]
public async Task SetAsDefaultAsync_ClearsPreviousDefault()
{
    await SeedBuiltIn();
    var codeExpert = await _repo.GetByNameAsync("Code Expert");
    await _repo.SetAsDefaultAsync(codeExpert!.Id);
    var original = await _repo.GetByNameAsync("Default Assistant");
    Assert.False(original!.IsDefault);
    Assert.True(codeExpert.IsDefault);
}
```

---

## Files Summary

### Files to Create (6)

| File | Lines (approx) |
|------|----------------|
| `Core/Models/SystemPrompt.cs` | 60 |
| `Core/Templates/SystemPromptTemplates.cs` | 250 |
| `Data/Configurations/SystemPromptConfiguration.cs` | 30 |
| `Data/Repositories/ISystemPromptRepository.cs` | 40 |
| `Data/Repositories/SystemPromptRepository.cs` | 180 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Core/Entities/SystemPromptEntity.cs` | Add TagsJson, navigation property |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | SystemPrompt model validates name/content/description lengths |
| AC-2 | Duplicate() creates independent copy with new ID |
| AC-3 | CharacterCount and EstimatedTokenCount compute correctly |
| AC-4 | Repository CRUD operations work correctly |
| AC-5 | Cannot delete or modify built-in prompts |
| AC-6 | Search finds prompts by name, description, or content |
| AC-7 | SetAsDefaultAsync clears previous default |
| AC-8 | SeedBuiltInPromptsAsync creates all 8 templates |
| AC-9 | Well-known GUIDs are stable across runs |
| AC-10 | Name uniqueness enforced |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Tags stored as JSON | Simple, no extra table needed |
| Well-known GUIDs | Stable references for built-in templates |
| ~4 chars/token estimate | Simple approximation, good enough for UI |
| Nullable SystemPromptId on Conversation | Conversations can exist without prompts |
| Clear prompt association on delete | Orphan conversations remain functional |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.4a | 0.5-1 day |
