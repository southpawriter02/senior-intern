# Design Specification: The Senior Intern v0.2.5 "Polish & Integration"

## Executive Summary

This document provides a comprehensive design specification for v0.2.5, the final sub-version of the v0.2.0 "Memory Management" release. This version focuses on global search functionality, export features, settings migration from v0.1.0, keyboard shortcuts, and status bar enhancements to deliver a polished, production-ready experience.

### v0.2.5 Scope (from v0.2.0 Design Document)
- Global search with SQLite FTS5 for conversations and messages
- Export features in multiple formats (Markdown, JSON, Plain Text, HTML)
- Settings migration from v0.1.0 to v0.2.0
- Keyboard shortcuts for common operations
- Enhanced status bar with model info, token counts, and save indicators

### Dependencies
- **v0.2.1** must be complete (database foundation)
- **v0.2.2** must be complete (conversation persistence)
- **v0.2.3** must be complete (parameter controls)
- **v0.2.4** must be complete (system prompt editor)

---

## Sub-Part Breakdown

| Part | Name | Focus |
|------|------|-------|
| v0.2.5a | FTS5 Search Infrastructure | FTS5 virtual tables, search models, repository extensions |
| v0.2.5b | Search Service | ISearchService implementation, ranking, highlighting |
| v0.2.5c | Export Service | IExportService, format exporters, options |
| v0.2.5d | Migration Service | IMigrationService, v0.1.0 â†’ v0.2.0 migration |
| v0.2.5e | Search UI | SearchDialog, SearchViewModel, keyboard integration |
| v0.2.5f | Export UI | ExportDialog, ExportViewModel, format preview |
| v0.2.5g | Status Bar & Shortcuts | Enhanced StatusBarViewModel, global keyboard shortcuts |

---

## Architecture Overview

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              User Interface                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         MainWindow                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚                    Keyboard Shortcuts                        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  Ctrl+K â†’ SearchDialog    Ctrl+N â†’ New Conversation         â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  Ctrl+E â†’ ExportDialog    Ctrl+P â†’ System Prompt Editor     â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ SearchDialog    â”‚  â”‚ ExportDialog                            â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â—‹ Markdown  â—‹ JSON  â—‹ Text  â—‹ HTML     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”‚ğŸ” Search... â”‚ â”‚  â”‚ â˜‘ Timestamps  â˜‘ System Prompt          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”‚Conversationsâ”‚ â”‚  â”‚ â”‚ Preview...                      â”‚    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”‚ â””â”€ Result 1 â”‚ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”‚ â””â”€ Result 2 â”‚ â”‚  â”‚                    [Cancel] [Export]   â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ â”‚Messages     â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚  â”‚ â”‚ â””â”€ Result 1 â”‚ â”‚                                                â”‚    â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ Status Bar                                                   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ Model: llama-3.gguf â”‚ Tokens: 234 (12.3 tok/s) â”‚ âœ“ Saved â”‚ T:0.7â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                             â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SearchViewModel  â”‚     â”‚  ExportViewModel  â”‚     â”‚ StatusBarViewModelâ”‚
â”‚  - Query          â”‚     â”‚  - Format         â”‚     â”‚  - ModelName      â”‚
â”‚  - Results        â”‚     â”‚  - Options        â”‚     â”‚  - TokenCount     â”‚
â”‚  - SelectedItem   â”‚     â”‚  - Preview        â”‚     â”‚  - TokenSpeed     â”‚
â”‚  - SearchCommand  â”‚     â”‚  - ExportCommand  â”‚     â”‚  - IsSaved        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚                             â”‚
        â–¼                             â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ISearchService   â”‚     â”‚  IExportService   â”‚     â”‚  ILlmService      â”‚
â”‚  - SearchAsync    â”‚     â”‚  - ExportAsync    â”‚     â”‚  - TokenStats     â”‚
â”‚  - IndexAsync     â”‚     â”‚  - GeneratePreviewâ”‚     â”‚  - ModelState     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚
        â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SeniorInternDbContext                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Conversations (FTS5)â”‚  â”‚ Messages (FTS5)                      â”‚    â”‚
â”‚  â”‚ - Title indexed     â”‚  â”‚ - Content indexed                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Migration Flow

```
Application Startup
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMigrationService   â”‚
â”‚ .MigrateIfNeeded()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     No      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for v0.1.0    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Continue startup    â”‚
â”‚ settings.json?      â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Yes
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backup settings.jsonâ”‚
â”‚ â†’ settings.v1.bak   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parse v0.1.0 format â”‚
â”‚ (flat JSON)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create v0.2.0 DB    â”‚
â”‚ with migrated data  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create default      â”‚
â”‚ presets & prompts   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stamp version in DB â”‚
â”‚ (MigrationComplete) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## v0.2.5a: FTS5 Search Infrastructure

### Objective
Set up SQLite FTS5 virtual tables for full-text search on conversations and messages.

### FTS5 Migration

```csharp
// Migrations/XXXXXXXX_AddFts5SearchTables.cs
public partial class AddFts5SearchTables : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // Create FTS5 virtual table for conversations
        migrationBuilder.Sql(@"
            CREATE VIRTUAL TABLE IF NOT EXISTS ConversationsFts USING fts5(
                Title,
                content='Conversations',
                content_rowid='Id'
            );
        ");

        // Create FTS5 virtual table for messages
        migrationBuilder.Sql(@"
            CREATE VIRTUAL TABLE IF NOT EXISTS MessagesFts USING fts5(
                Content,
                content='Messages',
                content_rowid='Id'
            );
        ");

        // Triggers to keep FTS tables in sync
        migrationBuilder.Sql(@"
            CREATE TRIGGER Conversations_ai AFTER INSERT ON Conversations BEGIN
                INSERT INTO ConversationsFts(rowid, Title) VALUES (new.Id, new.Title);
            END;
        ");

        migrationBuilder.Sql(@"
            CREATE TRIGGER Conversations_ad AFTER DELETE ON Conversations BEGIN
                INSERT INTO ConversationsFts(ConversationsFts, rowid, Title)
                VALUES('delete', old.Id, old.Title);
            END;
        ");

        migrationBuilder.Sql(@"
            CREATE TRIGGER Conversations_au AFTER UPDATE ON Conversations BEGIN
                INSERT INTO ConversationsFts(ConversationsFts, rowid, Title)
                VALUES('delete', old.Id, old.Title);
                INSERT INTO ConversationsFts(rowid, Title) VALUES (new.Id, new.Title);
            END;
        ");

        migrationBuilder.Sql(@"
            CREATE TRIGGER Messages_ai AFTER INSERT ON Messages BEGIN
                INSERT INTO MessagesFts(rowid, Content) VALUES (new.Id, new.Content);
            END;
        ");

        migrationBuilder.Sql(@"
            CREATE TRIGGER Messages_ad AFTER DELETE ON Messages BEGIN
                INSERT INTO MessagesFts(MessagesFts, rowid, Content)
                VALUES('delete', old.Id, old.Content);
            END;
        ");

        migrationBuilder.Sql(@"
            CREATE TRIGGER Messages_au AFTER UPDATE ON Messages BEGIN
                INSERT INTO MessagesFts(MessagesFts, rowid, Content)
                VALUES('delete', old.Id, old.Content);
                INSERT INTO MessagesFts(rowid, Content) VALUES (new.Id, new.Content);
            END;
        ");

        // Populate FTS tables with existing data
        migrationBuilder.Sql(@"
            INSERT INTO ConversationsFts(rowid, Title)
            SELECT Id, Title FROM Conversations;
        ");

        migrationBuilder.Sql(@"
            INSERT INTO MessagesFts(rowid, Content)
            SELECT Id, Content FROM Messages;
        ");
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Messages_au;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Messages_ad;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Messages_ai;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Conversations_au;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Conversations_ad;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Conversations_ai;");
        migrationBuilder.Sql("DROP TABLE IF EXISTS MessagesFts;");
        migrationBuilder.Sql("DROP TABLE IF EXISTS ConversationsFts;");
    }
}
```

### Search Models

```csharp
// src/SeniorIntern.Core/Models/SearchResult.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// Represents a search result item with relevance ranking.
/// </summary>
public sealed class SearchResult
{
    public required Guid Id { get; init; }
    public required SearchResultType Type { get; init; }
    public required string Title { get; init; }
    public required string Snippet { get; init; }
    public required string HighlightedSnippet { get; init; }
    public required double Rank { get; init; }
    public required DateTime Timestamp { get; init; }

    // For message results, the parent conversation
    public Guid? ConversationId { get; init; }
    public string? ConversationTitle { get; init; }
}

public enum SearchResultType
{
    Conversation,
    Message
}
```

```csharp
// src/SeniorIntern.Core/Models/SearchQuery.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// Represents a search query with options.
/// </summary>
public sealed class SearchQuery
{
    public required string Text { get; init; }
    public SearchResultType? FilterType { get; init; }
    public int MaxResults { get; init; } = 50;
    public int SnippetLength { get; init; } = 150;
}
```

```csharp
// src/SeniorIntern.Core/Models/SearchResults.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// Container for grouped search results.
/// </summary>
public sealed class SearchResults
{
    public required IReadOnlyList<SearchResult> Conversations { get; init; }
    public required IReadOnlyList<SearchResult> Messages { get; init; }
    public required int TotalCount { get; init; }
    public required TimeSpan SearchDuration { get; init; }
}
```

### Files to Create (v0.2.5a)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Models/SearchResult.cs` | Search result model |
| `src/SeniorIntern.Core/Models/SearchQuery.cs` | Search query model |
| `src/SeniorIntern.Core/Models/SearchResults.cs` | Grouped results container |
| `src/SeniorIntern.Data/Migrations/XXXXXXXX_AddFts5SearchTables.cs` | FTS5 migration |

### Files to Modify (v0.2.5a)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Data/SeniorInternDbContext.cs` | Add raw SQL methods for FTS5 queries |

---

## v0.2.5b: Search Service

### Objective
Implement the search service with FTS5 queries, ranking, and snippet highlighting.

### ISearchService Interface

```csharp
// src/SeniorIntern.Core/Interfaces/ISearchService.cs
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>
/// Provides full-text search functionality across conversations and messages.
/// </summary>
public interface ISearchService
{
    /// <summary>
    /// Searches conversations and messages using FTS5.
    /// </summary>
    Task<SearchResults> SearchAsync(
        SearchQuery query,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// Rebuilds the FTS5 index (for maintenance).
    /// </summary>
    Task RebuildIndexAsync(CancellationToken cancellationToken = default);

    /// <summary>
    /// Gets search suggestions based on recent searches.
    /// </summary>
    Task<IReadOnlyList<string>> GetSuggestionsAsync(
        string prefix,
        int maxSuggestions = 5,
        CancellationToken cancellationToken = default);
}
```

### SearchService Implementation

```csharp
// src/SeniorIntern.Services/SearchService.cs
namespace SeniorIntern.Services;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data;
using System.Diagnostics;
using System.Text.RegularExpressions;

public sealed partial class SearchService : ISearchService
{
    private readonly SeniorInternDbContext _dbContext;
    private readonly ILogger<SearchService> _logger;
    private readonly List<string> _recentSearches = new(capacity: 20);
    private readonly object _recentSearchesLock = new();

    public SearchService(
        SeniorInternDbContext dbContext,
        ILogger<SearchService> logger)
    {
        _dbContext = dbContext;
        _logger = logger;
    }

    public async Task<SearchResults> SearchAsync(
        SearchQuery query,
        CancellationToken cancellationToken = default)
    {
        ArgumentNullException.ThrowIfNull(query);

        if (string.IsNullOrWhiteSpace(query.Text))
        {
            return new SearchResults
            {
                Conversations = [],
                Messages = [],
                TotalCount = 0,
                SearchDuration = TimeSpan.Zero
            };
        }

        var stopwatch = Stopwatch.StartNew();
        var sanitizedQuery = SanitizeFtsQuery(query.Text);

        _logger.LogDebug("Searching for: {Query}", sanitizedQuery);

        // Track recent search
        TrackRecentSearch(query.Text);

        var conversations = new List<SearchResult>();
        var messages = new List<SearchResult>();

        // Search conversations if not filtered to messages only
        if (query.FilterType is null or SearchResultType.Conversation)
        {
            conversations = await SearchConversationsAsync(
                sanitizedQuery,
                query.MaxResults / 2,
                query.SnippetLength,
                cancellationToken);
        }

        // Search messages if not filtered to conversations only
        if (query.FilterType is null or SearchResultType.Message)
        {
            messages = await SearchMessagesAsync(
                sanitizedQuery,
                query.MaxResults / 2,
                query.SnippetLength,
                cancellationToken);
        }

        stopwatch.Stop();

        _logger.LogInformation(
            "Search completed in {Duration}ms: {ConvCount} conversations, {MsgCount} messages",
            stopwatch.ElapsedMilliseconds,
            conversations.Count,
            messages.Count);

        return new SearchResults
        {
            Conversations = conversations,
            Messages = messages,
            TotalCount = conversations.Count + messages.Count,
            SearchDuration = stopwatch.Elapsed
        };
    }

    private async Task<List<SearchResult>> SearchConversationsAsync(
        string query,
        int maxResults,
        int snippetLength,
        CancellationToken cancellationToken)
    {
        // FTS5 query with BM25 ranking and snippet highlighting
        var sql = @"
            SELECT
                c.Id,
                c.Title,
                snippet(ConversationsFts, 0, '<mark>', '</mark>', '...', {0}) as Snippet,
                bm25(ConversationsFts) as Rank,
                c.UpdatedAt
            FROM ConversationsFts
            INNER JOIN Conversations c ON c.Id = ConversationsFts.rowid
            WHERE ConversationsFts MATCH {1}
            ORDER BY Rank
            LIMIT {2}";

        var results = new List<SearchResult>();

        await using var command = _dbContext.Database.GetDbConnection().CreateCommand();
        command.CommandText = string.Format(sql, snippetLength / 10, "{0}", maxResults);

        var param = command.CreateParameter();
        param.ParameterName = "{0}";
        param.Value = query;
        command.Parameters.Add(param);

        await _dbContext.Database.OpenConnectionAsync(cancellationToken);

        try
        {
            await using var reader = await command.ExecuteReaderAsync(cancellationToken);
            while (await reader.ReadAsync(cancellationToken))
            {
                var title = reader.GetString(1);
                var snippet = reader.GetString(2);

                results.Add(new SearchResult
                {
                    Id = reader.GetGuid(0),
                    Type = SearchResultType.Conversation,
                    Title = title,
                    Snippet = StripHtmlTags(snippet),
                    HighlightedSnippet = snippet,
                    Rank = Math.Abs(reader.GetDouble(3)), // BM25 returns negative
                    Timestamp = reader.GetDateTime(4)
                });
            }
        }
        finally
        {
            await _dbContext.Database.CloseConnectionAsync();
        }

        return results;
    }

    private async Task<List<SearchResult>> SearchMessagesAsync(
        string query,
        int maxResults,
        int snippetLength,
        CancellationToken cancellationToken)
    {
        var sql = @"
            SELECT
                m.Id,
                m.Content,
                snippet(MessagesFts, 0, '<mark>', '</mark>', '...', {0}) as Snippet,
                bm25(MessagesFts) as Rank,
                m.Timestamp,
                m.ConversationId,
                c.Title as ConversationTitle
            FROM MessagesFts
            INNER JOIN Messages m ON m.Id = MessagesFts.rowid
            INNER JOIN Conversations c ON c.Id = m.ConversationId
            WHERE MessagesFts MATCH {1}
            ORDER BY Rank
            LIMIT {2}";

        var results = new List<SearchResult>();

        await using var command = _dbContext.Database.GetDbConnection().CreateCommand();
        command.CommandText = string.Format(sql, snippetLength / 10, "{0}", maxResults);

        var param = command.CreateParameter();
        param.ParameterName = "{0}";
        param.Value = query;
        command.Parameters.Add(param);

        await _dbContext.Database.OpenConnectionAsync(cancellationToken);

        try
        {
            await using var reader = await command.ExecuteReaderAsync(cancellationToken);
            while (await reader.ReadAsync(cancellationToken))
            {
                var snippet = reader.GetString(2);

                results.Add(new SearchResult
                {
                    Id = reader.GetGuid(0),
                    Type = SearchResultType.Message,
                    Title = TruncateContent(reader.GetString(1), 50),
                    Snippet = StripHtmlTags(snippet),
                    HighlightedSnippet = snippet,
                    Rank = Math.Abs(reader.GetDouble(3)),
                    Timestamp = reader.GetDateTime(4),
                    ConversationId = reader.GetGuid(5),
                    ConversationTitle = reader.GetString(6)
                });
            }
        }
        finally
        {
            await _dbContext.Database.CloseConnectionAsync();
        }

        return results;
    }

    public async Task RebuildIndexAsync(CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Rebuilding FTS5 indexes...");

        await _dbContext.Database.ExecuteSqlRawAsync(
            "INSERT INTO ConversationsFts(ConversationsFts) VALUES('rebuild');",
            cancellationToken);

        await _dbContext.Database.ExecuteSqlRawAsync(
            "INSERT INTO MessagesFts(MessagesFts) VALUES('rebuild');",
            cancellationToken);

        _logger.LogInformation("FTS5 indexes rebuilt successfully");
    }

    public Task<IReadOnlyList<string>> GetSuggestionsAsync(
        string prefix,
        int maxSuggestions = 5,
        CancellationToken cancellationToken = default)
    {
        if (string.IsNullOrWhiteSpace(prefix))
        {
            return Task.FromResult<IReadOnlyList<string>>([]);
        }

        lock (_recentSearchesLock)
        {
            var suggestions = _recentSearches
                .Where(s => s.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
                .Distinct()
                .Take(maxSuggestions)
                .ToList();

            return Task.FromResult<IReadOnlyList<string>>(suggestions);
        }
    }

    private void TrackRecentSearch(string query)
    {
        lock (_recentSearchesLock)
        {
            _recentSearches.Remove(query);
            _recentSearches.Insert(0, query);

            while (_recentSearches.Count > 20)
            {
                _recentSearches.RemoveAt(_recentSearches.Count - 1);
            }
        }
    }

    private static string SanitizeFtsQuery(string query)
    {
        // Escape special FTS5 characters and wrap terms in quotes for phrase matching
        var sanitized = query
            .Replace("\"", "\"\"")
            .Replace("*", "")
            .Replace("(", "")
            .Replace(")", "");

        // Split into terms and add prefix matching
        var terms = sanitized.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return string.Join(" ", terms.Select(t => $"\"{t}\"*"));
    }

    private static string StripHtmlTags(string html)
    {
        return StripHtmlRegex().Replace(html, string.Empty);
    }

    private static string TruncateContent(string content, int maxLength)
    {
        if (content.Length <= maxLength)
            return content;

        return content[..maxLength] + "...";
    }

    [GeneratedRegex("<[^>]+>")]
    private static partial Regex StripHtmlRegex();
}
```

### Files to Create (v0.2.5b)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Interfaces/ISearchService.cs` | Search service interface |
| `src/SeniorIntern.Services/SearchService.cs` | Search service implementation |

### Files to Modify (v0.2.5b)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Register ISearchService |

---

## v0.2.5c: Export Service

### Objective
Implement export functionality supporting multiple formats with customizable options.

### Export Models

```csharp
// src/SeniorIntern.Core/Models/ExportOptions.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// Options for exporting conversations.
/// </summary>
public sealed class ExportOptions
{
    public ExportFormat Format { get; set; } = ExportFormat.Markdown;
    public bool IncludeTimestamps { get; set; } = true;
    public bool IncludeSystemPrompt { get; set; } = true;
    public bool IncludeTokenCounts { get; set; } = false;
    public bool IncludeMetadata { get; set; } = true;
}

public enum ExportFormat
{
    Markdown,
    Json,
    PlainText,
    Html
}
```

```csharp
// src/SeniorIntern.Core/Models/ExportResult.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// Result of an export operation.
/// </summary>
public sealed class ExportResult
{
    public required bool Success { get; init; }
    public required string Content { get; init; }
    public required string SuggestedFileName { get; init; }
    public required string MimeType { get; init; }
    public string? ErrorMessage { get; init; }
}
```

### IExportService Interface

```csharp
// src/SeniorIntern.Core/Interfaces/IExportService.cs
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>
/// Provides conversation export functionality in multiple formats.
/// </summary>
public interface IExportService
{
    /// <summary>
    /// Exports a conversation to the specified format.
    /// </summary>
    Task<ExportResult> ExportAsync(
        Guid conversationId,
        ExportOptions options,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// Generates a preview of the export without saving.
    /// </summary>
    Task<string> GeneratePreviewAsync(
        Guid conversationId,
        ExportOptions options,
        int maxLength = 500,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// Gets the file extension for a format.
    /// </summary>
    string GetFileExtension(ExportFormat format);

    /// <summary>
    /// Gets the MIME type for a format.
    /// </summary>
    string GetMimeType(ExportFormat format);
}
```

### ExportService Implementation

```csharp
// src/SeniorIntern.Services/ExportService.cs
namespace SeniorIntern.Services;

using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data.Repositories;
using System.Text;
using System.Text.Json;
using System.Web;

public sealed class ExportService : IExportService
{
    private readonly IConversationRepository _conversationRepository;
    private readonly ILogger<ExportService> _logger;

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    public ExportService(
        IConversationRepository conversationRepository,
        ILogger<ExportService> logger)
    {
        _conversationRepository = conversationRepository;
        _logger = logger;
    }

    public async Task<ExportResult> ExportAsync(
        Guid conversationId,
        ExportOptions options,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var conversation = await _conversationRepository
                .GetByIdWithMessagesAsync(conversationId, cancellationToken);

            if (conversation is null)
            {
                return new ExportResult
                {
                    Success = false,
                    Content = string.Empty,
                    SuggestedFileName = string.Empty,
                    MimeType = string.Empty,
                    ErrorMessage = "Conversation not found"
                };
            }

            var content = options.Format switch
            {
                ExportFormat.Markdown => ExportToMarkdown(conversation, options),
                ExportFormat.Json => ExportToJson(conversation, options),
                ExportFormat.PlainText => ExportToPlainText(conversation, options),
                ExportFormat.Html => ExportToHtml(conversation, options),
                _ => throw new ArgumentOutOfRangeException(nameof(options.Format))
            };

            var safeTitle = SanitizeFileName(conversation.Title);
            var extension = GetFileExtension(options.Format);

            _logger.LogInformation(
                "Exported conversation {Id} to {Format}",
                conversationId,
                options.Format);

            return new ExportResult
            {
                Success = true,
                Content = content,
                SuggestedFileName = $"{safeTitle}{extension}",
                MimeType = GetMimeType(options.Format)
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to export conversation {Id}", conversationId);

            return new ExportResult
            {
                Success = false,
                Content = string.Empty,
                SuggestedFileName = string.Empty,
                MimeType = string.Empty,
                ErrorMessage = ex.Message
            };
        }
    }

    public async Task<string> GeneratePreviewAsync(
        Guid conversationId,
        ExportOptions options,
        int maxLength = 500,
        CancellationToken cancellationToken = default)
    {
        var result = await ExportAsync(conversationId, options, cancellationToken);

        if (!result.Success)
            return $"Error: {result.ErrorMessage}";

        if (result.Content.Length <= maxLength)
            return result.Content;

        return result.Content[..maxLength] + "\n\n... (truncated)";
    }

    public string GetFileExtension(ExportFormat format) => format switch
    {
        ExportFormat.Markdown => ".md",
        ExportFormat.Json => ".json",
        ExportFormat.PlainText => ".txt",
        ExportFormat.Html => ".html",
        _ => ".txt"
    };

    public string GetMimeType(ExportFormat format) => format switch
    {
        ExportFormat.Markdown => "text/markdown",
        ExportFormat.Json => "application/json",
        ExportFormat.PlainText => "text/plain",
        ExportFormat.Html => "text/html",
        _ => "text/plain"
    };

    private static string ExportToMarkdown(
        ConversationEntity conversation,
        ExportOptions options)
    {
        var sb = new StringBuilder();

        sb.AppendLine($"# {conversation.Title}");
        sb.AppendLine();

        if (options.IncludeMetadata)
        {
            sb.AppendLine($"**Created:** {conversation.CreatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine($"**Last Updated:** {conversation.UpdatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine();
        }

        if (options.IncludeSystemPrompt && !string.IsNullOrEmpty(conversation.SystemPrompt))
        {
            sb.AppendLine("## System Prompt");
            sb.AppendLine();
            sb.AppendLine(conversation.SystemPrompt);
            sb.AppendLine();
        }

        sb.AppendLine("## Conversation");
        sb.AppendLine();

        foreach (var message in conversation.Messages.OrderBy(m => m.Timestamp))
        {
            var roleLabel = message.Role switch
            {
                MessageRole.User => "**User**",
                MessageRole.Assistant => "**Assistant**",
                MessageRole.System => "**System**",
                _ => "**Unknown**"
            };

            if (options.IncludeTimestamps)
            {
                sb.AppendLine($"{roleLabel} ({message.Timestamp:HH:mm}):");
            }
            else
            {
                sb.AppendLine($"{roleLabel}:");
            }

            sb.AppendLine();
            sb.AppendLine(message.Content);

            if (options.IncludeTokenCounts && message.TokenCount.HasValue)
            {
                sb.AppendLine();
                sb.AppendLine($"*Tokens: {message.TokenCount}*");
            }

            sb.AppendLine();
            sb.AppendLine("---");
            sb.AppendLine();
        }

        sb.AppendLine();
        sb.AppendLine("*Exported from The Senior Intern*");

        return sb.ToString();
    }

    private static string ExportToJson(
        ConversationEntity conversation,
        ExportOptions options)
    {
        var export = new
        {
            title = conversation.Title,
            createdAt = conversation.CreatedAt,
            updatedAt = conversation.UpdatedAt,
            systemPrompt = options.IncludeSystemPrompt ? conversation.SystemPrompt : null,
            messages = conversation.Messages
                .OrderBy(m => m.Timestamp)
                .Select(m => new
                {
                    role = m.Role.ToString().ToLowerInvariant(),
                    content = m.Content,
                    timestamp = options.IncludeTimestamps ? m.Timestamp : (DateTime?)null,
                    tokenCount = options.IncludeTokenCounts ? m.TokenCount : null
                })
                .ToList(),
            exportedAt = DateTime.UtcNow,
            exportedBy = "The Senior Intern"
        };

        return JsonSerializer.Serialize(export, JsonOptions);
    }

    private static string ExportToPlainText(
        ConversationEntity conversation,
        ExportOptions options)
    {
        var sb = new StringBuilder();

        sb.AppendLine(conversation.Title);
        sb.AppendLine(new string('=', conversation.Title.Length));
        sb.AppendLine();

        if (options.IncludeMetadata)
        {
            sb.AppendLine($"Created: {conversation.CreatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine($"Updated: {conversation.UpdatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine();
        }

        if (options.IncludeSystemPrompt && !string.IsNullOrEmpty(conversation.SystemPrompt))
        {
            sb.AppendLine("System Prompt:");
            sb.AppendLine(conversation.SystemPrompt);
            sb.AppendLine();
        }

        foreach (var message in conversation.Messages.OrderBy(m => m.Timestamp))
        {
            var roleLabel = message.Role.ToString().ToUpperInvariant();

            if (options.IncludeTimestamps)
            {
                sb.AppendLine($"[{message.Timestamp:HH:mm}] {roleLabel}:");
            }
            else
            {
                sb.AppendLine($"{roleLabel}:");
            }

            sb.AppendLine(message.Content);

            if (options.IncludeTokenCounts && message.TokenCount.HasValue)
            {
                sb.AppendLine($"(Tokens: {message.TokenCount})");
            }

            sb.AppendLine();
        }

        return sb.ToString();
    }

    private static string ExportToHtml(
        ConversationEntity conversation,
        ExportOptions options)
    {
        var sb = new StringBuilder();

        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html lang=\"en\">");
        sb.AppendLine("<head>");
        sb.AppendLine("  <meta charset=\"UTF-8\">");
        sb.AppendLine($"  <title>{HttpUtility.HtmlEncode(conversation.Title)}</title>");
        sb.AppendLine("  <style>");
        sb.AppendLine("    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: #e0e0e0; }");
        sb.AppendLine("    h1 { color: #00d9ff; border-bottom: 2px solid #00d9ff; padding-bottom: 10px; }");
        sb.AppendLine("    .metadata { color: #888; font-size: 0.9em; margin-bottom: 20px; }");
        sb.AppendLine("    .system-prompt { background: #2d2d44; padding: 15px; border-radius: 8px; margin-bottom: 20px; }");
        sb.AppendLine("    .message { margin-bottom: 20px; padding: 15px; border-radius: 8px; }");
        sb.AppendLine("    .message.user { background: #16213e; border-left: 4px solid #00d9ff; }");
        sb.AppendLine("    .message.assistant { background: #1f1f3a; border-left: 4px solid #7b68ee; }");
        sb.AppendLine("    .message.system { background: #2d2d44; border-left: 4px solid #ffd700; }");
        sb.AppendLine("    .role { font-weight: bold; margin-bottom: 8px; }");
        sb.AppendLine("    .timestamp { color: #888; font-size: 0.85em; }");
        sb.AppendLine("    .tokens { color: #666; font-size: 0.8em; font-style: italic; }");
        sb.AppendLine("    .footer { margin-top: 40px; text-align: center; color: #666; font-size: 0.85em; }");
        sb.AppendLine("    pre { background: #0d0d1a; padding: 10px; border-radius: 4px; overflow-x: auto; }");
        sb.AppendLine("    code { font-family: 'Fira Code', Consolas, monospace; }");
        sb.AppendLine("  </style>");
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");

        sb.AppendLine($"  <h1>{HttpUtility.HtmlEncode(conversation.Title)}</h1>");

        if (options.IncludeMetadata)
        {
            sb.AppendLine("  <div class=\"metadata\">");
            sb.AppendLine($"    <p>Created: {conversation.CreatedAt:yyyy-MM-dd HH:mm} | Updated: {conversation.UpdatedAt:yyyy-MM-dd HH:mm}</p>");
            sb.AppendLine("  </div>");
        }

        if (options.IncludeSystemPrompt && !string.IsNullOrEmpty(conversation.SystemPrompt))
        {
            sb.AppendLine("  <div class=\"system-prompt\">");
            sb.AppendLine("    <strong>System Prompt:</strong>");
            sb.AppendLine($"    <p>{HttpUtility.HtmlEncode(conversation.SystemPrompt)}</p>");
            sb.AppendLine("  </div>");
        }

        foreach (var message in conversation.Messages.OrderBy(m => m.Timestamp))
        {
            var roleClass = message.Role.ToString().ToLowerInvariant();
            var roleLabel = message.Role.ToString();

            sb.AppendLine($"  <div class=\"message {roleClass}\">");
            sb.Append($"    <div class=\"role\">{roleLabel}");

            if (options.IncludeTimestamps)
            {
                sb.Append($" <span class=\"timestamp\">({message.Timestamp:HH:mm})</span>");
            }

            sb.AppendLine("</div>");

            // Convert markdown-style code blocks to HTML
            var content = ConvertMarkdownCodeToHtml(HttpUtility.HtmlEncode(message.Content));
            sb.AppendLine($"    <div class=\"content\">{content}</div>");

            if (options.IncludeTokenCounts && message.TokenCount.HasValue)
            {
                sb.AppendLine($"    <div class=\"tokens\">Tokens: {message.TokenCount}</div>");
            }

            sb.AppendLine("  </div>");
        }

        sb.AppendLine("  <div class=\"footer\">");
        sb.AppendLine($"    <p>Exported from The Senior Intern on {DateTime.Now:yyyy-MM-dd HH:mm}</p>");
        sb.AppendLine("  </div>");
        sb.AppendLine("</body>");
        sb.AppendLine("</html>");

        return sb.ToString();
    }

    private static string ConvertMarkdownCodeToHtml(string content)
    {
        // Simple conversion of ```code``` blocks to <pre><code>
        return System.Text.RegularExpressions.Regex.Replace(
            content,
            @"```(\w*)\n(.*?)```",
            "<pre><code>$2</code></pre>",
            System.Text.RegularExpressions.RegexOptions.Singleline);
    }

    private static string SanitizeFileName(string fileName)
    {
        var invalid = Path.GetInvalidFileNameChars();
        var sanitized = string.Join("_", fileName.Split(invalid));

        // Limit length
        if (sanitized.Length > 50)
            sanitized = sanitized[..50];

        return sanitized;
    }
}
```

### Files to Create (v0.2.5c)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Models/ExportOptions.cs` | Export options model |
| `src/SeniorIntern.Core/Models/ExportResult.cs` | Export result model |
| `src/SeniorIntern.Core/Interfaces/IExportService.cs` | Export service interface |
| `src/SeniorIntern.Services/ExportService.cs` | Export service implementation |

### Files to Modify (v0.2.5c)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Register IExportService |

---

## v0.2.5d: Migration Service

### Objective
Implement settings migration from v0.1.0 (JSON file) to v0.2.0 (SQLite database).

### Migration Models

```csharp
// src/SeniorIntern.Core/Models/MigrationResult.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// Result of a migration operation.
/// </summary>
public sealed record MigrationResult(
    bool Success,
    Version FromVersion,
    Version ToVersion,
    IReadOnlyList<string> MigrationSteps,
    string? ErrorMessage
);
```

```csharp
// src/SeniorIntern.Core/Models/LegacySettings.cs
namespace SeniorIntern.Core.Models;

/// <summary>
/// v0.1.0 settings format (for migration).
/// </summary>
internal sealed class LegacySettings
{
    public string? LastModelPath { get; set; }
    public uint DefaultContextSize { get; set; } = 4096;
    public int DefaultGpuLayers { get; set; } = -1;
    public float Temperature { get; set; } = 0.7f;
    public string Theme { get; set; } = "Dark";
}
```

### IMigrationService Interface

```csharp
// src/SeniorIntern.Core/Interfaces/IMigrationService.cs
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>
/// Handles migration between application versions.
/// </summary>
public interface IMigrationService
{
    /// <summary>
    /// Checks if migration is required and performs it if needed.
    /// </summary>
    Task<MigrationResult> MigrateIfNeededAsync(
        CancellationToken cancellationToken = default);

    /// <summary>
    /// Gets the current application version from the database.
    /// </summary>
    Version GetCurrentVersion();

    /// <summary>
    /// Checks if migration is required without performing it.
    /// </summary>
    bool IsMigrationRequired();
}
```

### MigrationService Implementation

```csharp
// src/SeniorIntern.Services/MigrationService.cs
namespace SeniorIntern.Services;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Core.Templates;
using SeniorIntern.Data;
using SeniorIntern.Data.Repositories;
using System.Text.Json;

public sealed class MigrationService : IMigrationService
{
    private static readonly Version CurrentVersion = new(0, 2, 0);
    private static readonly Version LegacyVersion = new(0, 1, 0);

    private readonly SeniorInternDbContext _dbContext;
    private readonly ISystemPromptRepository _systemPromptRepository;
    private readonly IInferencePresetRepository _presetRepository;
    private readonly ILogger<MigrationService> _logger;
    private readonly string _settingsPath;
    private readonly string _backupPath;

    public MigrationService(
        SeniorInternDbContext dbContext,
        ISystemPromptRepository systemPromptRepository,
        IInferencePresetRepository presetRepository,
        ILogger<MigrationService> logger)
    {
        _dbContext = dbContext;
        _systemPromptRepository = systemPromptRepository;
        _presetRepository = presetRepository;
        _logger = logger;

        var appData = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var appFolder = Path.Combine(appData, "SeniorIntern");
        _settingsPath = Path.Combine(appFolder, "settings.json");
        _backupPath = Path.Combine(appFolder, "settings.v1.json.bak");
    }

    public async Task<MigrationResult> MigrateIfNeededAsync(
        CancellationToken cancellationToken = default)
    {
        var steps = new List<string>();

        try
        {
            // Check if migration is needed
            if (!IsMigrationRequired())
            {
                _logger.LogInformation("No migration required");
                return new MigrationResult(
                    Success: true,
                    FromVersion: CurrentVersion,
                    ToVersion: CurrentVersion,
                    MigrationSteps: ["No migration needed"],
                    ErrorMessage: null
                );
            }

            _logger.LogInformation("Starting migration from v0.1.0 to v0.2.0");

            // Step 1: Backup existing settings
            steps.Add("Backing up v0.1.0 settings");
            await BackupLegacySettingsAsync(cancellationToken);

            // Step 2: Read legacy settings
            steps.Add("Reading legacy settings");
            var legacySettings = await ReadLegacySettingsAsync(cancellationToken);

            // Step 3: Ensure database is created and migrated
            steps.Add("Ensuring database exists");
            await _dbContext.Database.MigrateAsync(cancellationToken);

            // Step 4: Migrate settings to new schema
            steps.Add("Migrating settings to database");
            await MigrateSettingsAsync(legacySettings, cancellationToken);

            // Step 5: Create default system prompts
            steps.Add("Creating default system prompts");
            await CreateDefaultSystemPromptsAsync(cancellationToken);

            // Step 6: Create default inference presets
            steps.Add("Creating default inference presets");
            await CreateDefaultPresetsAsync(cancellationToken);

            // Step 7: Mark migration complete
            steps.Add("Marking migration complete");
            await MarkMigrationCompleteAsync(cancellationToken);

            _logger.LogInformation("Migration completed successfully");

            return new MigrationResult(
                Success: true,
                FromVersion: LegacyVersion,
                ToVersion: CurrentVersion,
                MigrationSteps: steps,
                ErrorMessage: null
            );
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Migration failed");

            steps.Add($"FAILED: {ex.Message}");

            return new MigrationResult(
                Success: false,
                FromVersion: LegacyVersion,
                ToVersion: CurrentVersion,
                MigrationSteps: steps,
                ErrorMessage: ex.Message
            );
        }
    }

    public Version GetCurrentVersion()
    {
        try
        {
            var versionRecord = _dbContext.Set<AppVersionEntity>()
                .FirstOrDefault();

            if (versionRecord is null)
                return LegacyVersion;

            return new Version(
                versionRecord.Major,
                versionRecord.Minor,
                versionRecord.Patch);
        }
        catch
        {
            return LegacyVersion;
        }
    }

    public bool IsMigrationRequired()
    {
        // Check if legacy settings file exists
        if (!File.Exists(_settingsPath))
            return false;

        // Check if database already has version stamp
        try
        {
            var dbExists = _dbContext.Database.CanConnect();
            if (!dbExists)
                return true;

            var version = GetCurrentVersion();
            return version < CurrentVersion;
        }
        catch
        {
            return true;
        }
    }

    private async Task BackupLegacySettingsAsync(CancellationToken cancellationToken)
    {
        if (File.Exists(_settingsPath))
        {
            var content = await File.ReadAllTextAsync(_settingsPath, cancellationToken);
            await File.WriteAllTextAsync(_backupPath, content, cancellationToken);
            _logger.LogInformation("Backed up settings to {Path}", _backupPath);
        }
    }

    private async Task<LegacySettings?> ReadLegacySettingsAsync(
        CancellationToken cancellationToken)
    {
        if (!File.Exists(_settingsPath))
            return null;

        var json = await File.ReadAllTextAsync(_settingsPath, cancellationToken);
        return JsonSerializer.Deserialize<LegacySettings>(json);
    }

    private async Task MigrateSettingsAsync(
        LegacySettings? legacy,
        CancellationToken cancellationToken)
    {
        if (legacy is null)
            return;

        // Create new AppSettings entity with migrated values
        var settings = new AppSettingsEntity
        {
            LastModelPath = legacy.LastModelPath,
            DefaultContextSize = legacy.DefaultContextSize,
            DefaultGpuLayers = legacy.DefaultGpuLayers,
            Theme = legacy.Theme,
            // New v0.2.0 defaults
            DefaultTemperature = legacy.Temperature,
            DefaultTopP = 0.9f,
            DefaultMaxTokens = 2048
        };

        _dbContext.Set<AppSettingsEntity>().Add(settings);
        await _dbContext.SaveChangesAsync(cancellationToken);
    }

    private async Task CreateDefaultSystemPromptsAsync(
        CancellationToken cancellationToken)
    {
        var existingCount = await _dbContext.Set<SystemPromptEntity>()
            .CountAsync(cancellationToken);

        if (existingCount > 0)
            return;

        var templates = SystemPromptTemplates.GetAllTemplates();

        foreach (var template in templates)
        {
            await _systemPromptRepository.CreateAsync(new SystemPromptEntity
            {
                Name = template.Name,
                Content = template.Content,
                Description = template.Description,
                IsBuiltIn = true,
                IsDefault = template.Name == "The Senior Intern",
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            }, cancellationToken);
        }
    }

    private async Task CreateDefaultPresetsAsync(
        CancellationToken cancellationToken)
    {
        var existingCount = await _dbContext.Set<InferencePresetEntity>()
            .CountAsync(cancellationToken);

        if (existingCount > 0)
            return;

        var presets = new[]
        {
            new InferencePresetEntity
            {
                Name = "Precise",
                Temperature = 0.3f,
                TopP = 0.85f,
                MaxTokens = 2048,
                Description = "Low creativity, focused responses",
                IsBuiltIn = true
            },
            new InferencePresetEntity
            {
                Name = "Balanced",
                Temperature = 0.7f,
                TopP = 0.9f,
                MaxTokens = 2048,
                Description = "Balanced creativity and coherence",
                IsBuiltIn = true,
                IsDefault = true
            },
            new InferencePresetEntity
            {
                Name = "Creative",
                Temperature = 1.0f,
                TopP = 0.95f,
                MaxTokens = 4096,
                Description = "High creativity, varied responses",
                IsBuiltIn = true
            },
            new InferencePresetEntity
            {
                Name = "Long-form",
                Temperature = 0.7f,
                TopP = 0.9f,
                MaxTokens = 8192,
                Description = "Extended responses for detailed work",
                IsBuiltIn = true
            }
        };

        foreach (var preset in presets)
        {
            preset.CreatedAt = DateTime.UtcNow;
            await _presetRepository.CreateAsync(preset, cancellationToken);
        }
    }

    private async Task MarkMigrationCompleteAsync(CancellationToken cancellationToken)
    {
        var versionEntity = new AppVersionEntity
        {
            Major = CurrentVersion.Major,
            Minor = CurrentVersion.Minor,
            Patch = CurrentVersion.Build,
            MigratedAt = DateTime.UtcNow
        };

        _dbContext.Set<AppVersionEntity>().Add(versionEntity);
        await _dbContext.SaveChangesAsync(cancellationToken);
    }
}
```

### AppVersionEntity

```csharp
// src/SeniorIntern.Core/Entities/AppVersionEntity.cs
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Tracks application version for migration purposes.
/// </summary>
public sealed class AppVersionEntity
{
    public int Id { get; set; }
    public int Major { get; set; }
    public int Minor { get; set; }
    public int Patch { get; set; }
    public DateTime MigratedAt { get; set; }
}
```

### Files to Create (v0.2.5d)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Models/MigrationResult.cs` | Migration result model |
| `src/SeniorIntern.Core/Models/LegacySettings.cs` | v0.1.0 settings format |
| `src/SeniorIntern.Core/Entities/AppVersionEntity.cs` | Version tracking entity |
| `src/SeniorIntern.Core/Interfaces/IMigrationService.cs` | Migration service interface |
| `src/SeniorIntern.Services/MigrationService.cs` | Migration service implementation |

### Files to Modify (v0.2.5d)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Data/SeniorInternDbContext.cs` | Add AppVersionEntity DbSet |
| `src/SeniorIntern.Data/Configurations/AppVersionConfiguration.cs` | Entity configuration |
| `src/SeniorIntern.Desktop/App.axaml.cs` | Run migration on startup |

---

## v0.2.5e: Search UI

### Objective
Create the search dialog with keyboard shortcut integration and result navigation.

### SearchViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/SearchViewModel.cs
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using System.Collections.ObjectModel;

public partial class SearchViewModel : ViewModelBase
{
    private readonly ISearchService _searchService;
    private readonly IConversationService _conversationService;
    private CancellationTokenSource? _searchCts;
    private readonly System.Timers.Timer _debounceTimer;

    [ObservableProperty]
    private string _query = string.Empty;

    [ObservableProperty]
    private bool _isSearching;

    [ObservableProperty]
    private string _searchStatus = string.Empty;

    [ObservableProperty]
    private SearchResult? _selectedResult;

    [ObservableProperty]
    private SearchResultType? _filterType;

    public ObservableCollection<SearchResult> ConversationResults { get; } = [];
    public ObservableCollection<SearchResult> MessageResults { get; } = [];

    public event EventHandler<Guid>? NavigateToConversation;
    public event EventHandler? CloseRequested;

    public SearchViewModel(
        ISearchService searchService,
        IConversationService conversationService)
    {
        _searchService = searchService;
        _conversationService = conversationService;

        _debounceTimer = new System.Timers.Timer(300);
        _debounceTimer.Elapsed += async (s, e) => await ExecuteSearchAsync();
        _debounceTimer.AutoReset = false;
    }

    partial void OnQueryChanged(string value)
    {
        _debounceTimer.Stop();

        if (string.IsNullOrWhiteSpace(value))
        {
            ConversationResults.Clear();
            MessageResults.Clear();
            SearchStatus = string.Empty;
            return;
        }

        _debounceTimer.Start();
    }

    private async Task ExecuteSearchAsync()
    {
        _searchCts?.Cancel();
        _searchCts = new CancellationTokenSource();

        try
        {
            IsSearching = true;
            SearchStatus = "Searching...";

            var results = await _searchService.SearchAsync(
                new SearchQuery
                {
                    Text = Query,
                    FilterType = FilterType,
                    MaxResults = 50
                },
                _searchCts.Token);

            await Avalonia.Threading.Dispatcher.UIThread.InvokeAsync(() =>
            {
                ConversationResults.Clear();
                MessageResults.Clear();

                foreach (var result in results.Conversations)
                    ConversationResults.Add(result);

                foreach (var result in results.Messages)
                    MessageResults.Add(result);

                SearchStatus = $"Found {results.TotalCount} results in {results.SearchDuration.TotalMilliseconds:F0}ms";
            });
        }
        catch (OperationCanceledException)
        {
            // Expected on new search
        }
        catch (Exception ex)
        {
            SearchStatus = $"Error: {ex.Message}";
        }
        finally
        {
            IsSearching = false;
        }
    }

    [RelayCommand]
    private void SelectResult(SearchResult? result)
    {
        if (result is null)
            return;

        var conversationId = result.Type == SearchResultType.Conversation
            ? result.Id
            : result.ConversationId!.Value;

        NavigateToConversation?.Invoke(this, conversationId);
        CloseRequested?.Invoke(this, EventArgs.Empty);
    }

    [RelayCommand]
    private void SetFilter(SearchResultType? type)
    {
        FilterType = type;
        if (!string.IsNullOrWhiteSpace(Query))
        {
            _debounceTimer.Stop();
            _debounceTimer.Start();
        }
    }

    [RelayCommand]
    private void Close()
    {
        CloseRequested?.Invoke(this, EventArgs.Empty);
    }

    [RelayCommand]
    private void NavigateUp()
    {
        // Navigate to previous result
        var allResults = ConversationResults.Concat(MessageResults).ToList();
        if (allResults.Count == 0) return;

        var currentIndex = SelectedResult is null ? 0 : allResults.IndexOf(SelectedResult);
        var newIndex = Math.Max(0, currentIndex - 1);
        SelectedResult = allResults[newIndex];
    }

    [RelayCommand]
    private void NavigateDown()
    {
        // Navigate to next result
        var allResults = ConversationResults.Concat(MessageResults).ToList();
        if (allResults.Count == 0) return;

        var currentIndex = SelectedResult is null ? -1 : allResults.IndexOf(SelectedResult);
        var newIndex = Math.Min(allResults.Count - 1, currentIndex + 1);
        SelectedResult = allResults[newIndex];
    }
}
```

### SearchDialog.axaml

```xml
<!-- src/SeniorIntern.Desktop/Views/SearchDialog.axaml -->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
        x:Class="SeniorIntern.Desktop.Views.SearchDialog"
        x:DataType="vm:SearchViewModel"
        Title="Search"
        Width="600"
        Height="500"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        ShowInTaskbar="False"
        SystemDecorations="BorderOnly"
        Background="{DynamicResource SystemChromeMediumColor}">

    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding CloseCommand}" />
        <KeyBinding Gesture="Up" Command="{Binding NavigateUpCommand}" />
        <KeyBinding Gesture="Down" Command="{Binding NavigateDownCommand}" />
        <KeyBinding Gesture="Enter" Command="{Binding SelectResultCommand}"
                    CommandParameter="{Binding SelectedResult}" />
    </Window.KeyBindings>

    <Border BorderBrush="{DynamicResource SystemAccentColor}"
            BorderThickness="1"
            CornerRadius="8">
        <Grid RowDefinitions="Auto,Auto,*,Auto">

            <!-- Search Input -->
            <Border Grid.Row="0"
                    Background="{DynamicResource SystemChromeLowColor}"
                    Padding="16">
                <Grid ColumnDefinitions="Auto,*">
                    <PathIcon Grid.Column="0"
                              Data="M10 2a8 8 0 105.293 14.293l4.707 4.707 1.414-1.414-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"
                              Foreground="{DynamicResource SystemAccentColor}"
                              Width="20" Height="20"
                              Margin="0,0,12,0" />
                    <TextBox Grid.Column="1"
                             Text="{Binding Query, Mode=TwoWay}"
                             Watermark="Search conversations and messages..."
                             FontSize="16"
                             BorderThickness="0"
                             Background="Transparent"
                             x:Name="SearchInput" />
                </Grid>
            </Border>

            <!-- Filter Tabs -->
            <StackPanel Grid.Row="1"
                        Orientation="Horizontal"
                        Margin="16,8"
                        Spacing="8">
                <RadioButton Content="All"
                             IsChecked="{Binding FilterType, Converter={x:Static ObjectConverters.IsNull}}"
                             Command="{Binding SetFilterCommand}"
                             CommandParameter="{x:Null}"
                             GroupName="SearchFilter" />
                <RadioButton Content="Conversations"
                             Command="{Binding SetFilterCommand}"
                             GroupName="SearchFilter">
                    <RadioButton.CommandParameter>
                        <x:Static Member="vm:SearchResultType.Conversation" />
                    </RadioButton.CommandParameter>
                </RadioButton>
                <RadioButton Content="Messages"
                             Command="{Binding SetFilterCommand}"
                             GroupName="SearchFilter">
                    <RadioButton.CommandParameter>
                        <x:Static Member="vm:SearchResultType.Message" />
                    </RadioButton.CommandParameter>
                </RadioButton>
            </StackPanel>

            <!-- Results -->
            <ScrollViewer Grid.Row="2" Padding="8">
                <StackPanel Spacing="16">

                    <!-- Conversation Results -->
                    <StackPanel IsVisible="{Binding ConversationResults.Count}">
                        <TextBlock Text="Conversations"
                                   FontWeight="SemiBold"
                                   Margin="8,0,0,8"
                                   Foreground="{DynamicResource SystemBaseMediumColor}" />
                        <ItemsControl ItemsSource="{Binding ConversationResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:SearchResult">
                                    <Button Command="{Binding $parent[Window].((vm:SearchViewModel)DataContext).SelectResultCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Stretch"
                                            Background="Transparent"
                                            Padding="12,8"
                                            Margin="0,2">
                                        <Grid RowDefinitions="Auto,Auto">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                <TextBlock Text="ğŸ“" Margin="0,0,8,0" />
                                                <TextBlock Text="{Binding Title}"
                                                           FontWeight="Medium" />
                                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:g}'}"
                                                           Foreground="{DynamicResource SystemBaseMediumColor}"
                                                           Margin="12,0,0,0" />
                                            </StackPanel>
                                            <TextBlock Grid.Row="1"
                                                       Text="{Binding Snippet}"
                                                       TextTrimming="CharacterEllipsis"
                                                       Foreground="{DynamicResource SystemBaseMediumColor}"
                                                       Margin="26,4,0,0" />
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Message Results -->
                    <StackPanel IsVisible="{Binding MessageResults.Count}">
                        <TextBlock Text="Messages"
                                   FontWeight="SemiBold"
                                   Margin="8,0,0,8"
                                   Foreground="{DynamicResource SystemBaseMediumColor}" />
                        <ItemsControl ItemsSource="{Binding MessageResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:SearchResult">
                                    <Button Command="{Binding $parent[Window].((vm:SearchViewModel)DataContext).SelectResultCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Stretch"
                                            Background="Transparent"
                                            Padding="12,8"
                                            Margin="0,2">
                                        <Grid RowDefinitions="Auto,Auto,Auto">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                <TextBlock Text="ğŸ’¬" Margin="0,0,8,0" />
                                                <TextBlock Text="{Binding Snippet}"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxWidth="400" />
                                            </StackPanel>
                                            <StackPanel Grid.Row="1"
                                                        Orientation="Horizontal"
                                                        Margin="26,4,0,0">
                                                <TextBlock Text="in: "
                                                           Foreground="{DynamicResource SystemBaseMediumColor}" />
                                                <TextBlock Text="{Binding ConversationTitle}"
                                                           Foreground="{DynamicResource SystemAccentColor}" />
                                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:g}'}"
                                                           Foreground="{DynamicResource SystemBaseMediumColor}"
                                                           Margin="12,0,0,0" />
                                            </StackPanel>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Empty State -->
                    <TextBlock Text="No results found"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource SystemBaseMediumColor}"
                               Margin="0,40"
                               IsVisible="{Binding !ConversationResults.Count}"
                               IsVisible.1="{Binding !MessageResults.Count}"
                               IsVisible.2="{Binding Query.Length}" />
                </StackPanel>
            </ScrollViewer>

            <!-- Status Bar -->
            <Border Grid.Row="3"
                    Background="{DynamicResource SystemChromeLowColor}"
                    Padding="16,8">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="{Binding SearchStatus}"
                               Foreground="{DynamicResource SystemBaseMediumColor}" />
                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="16">
                        <TextBlock Text="â†‘â†“ Navigate"
                                   Foreground="{DynamicResource SystemBaseMediumColor}" />
                        <TextBlock Text="Enter Select"
                                   Foreground="{DynamicResource SystemBaseMediumColor}" />
                        <TextBlock Text="Esc Close"
                                   Foreground="{DynamicResource SystemBaseMediumColor}" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
```

### SearchDialog.axaml.cs

```csharp
// src/SeniorIntern.Desktop/Views/SearchDialog.axaml.cs
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;
using Avalonia.Input;
using SeniorIntern.Desktop.ViewModels;

public partial class SearchDialog : Window
{
    public SearchDialog()
    {
        InitializeComponent();
    }

    public SearchDialog(SearchViewModel viewModel) : this()
    {
        DataContext = viewModel;
        viewModel.CloseRequested += (s, e) => Close();
    }

    protected override void OnOpened(EventArgs e)
    {
        base.OnOpened(e);

        // Focus the search input
        var searchInput = this.FindControl<TextBox>("SearchInput");
        searchInput?.Focus();
    }
}
```

### Files to Create (v0.2.5e)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/SearchViewModel.cs` | Search dialog ViewModel |
| `src/SeniorIntern.Desktop/Views/SearchDialog.axaml` | Search dialog view |
| `src/SeniorIntern.Desktop/Views/SearchDialog.axaml.cs` | Search dialog code-behind |

### Files to Modify (v0.2.5e)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add OpenSearchCommand |
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add Ctrl+K key binding |

---

## v0.2.5f: Export UI

### Objective
Create the export dialog with format selection, options, and preview.

### ExportViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/ExportViewModel.cs
namespace SeniorIntern.Desktop.ViewModels;

using Avalonia.Platform.Storage;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;

public partial class ExportViewModel : ViewModelBase
{
    private readonly IExportService _exportService;
    private readonly IStorageProvider _storageProvider;
    private readonly Guid _conversationId;

    [ObservableProperty]
    private ExportFormat _selectedFormat = ExportFormat.Markdown;

    [ObservableProperty]
    private bool _includeTimestamps = true;

    [ObservableProperty]
    private bool _includeSystemPrompt = true;

    [ObservableProperty]
    private bool _includeTokenCounts;

    [ObservableProperty]
    private string _preview = string.Empty;

    [ObservableProperty]
    private bool _isExporting;

    [ObservableProperty]
    private string? _errorMessage;

    public event EventHandler? CloseRequested;

    public ExportViewModel(
        IExportService exportService,
        IStorageProvider storageProvider,
        Guid conversationId)
    {
        _exportService = exportService;
        _storageProvider = storageProvider;
        _conversationId = conversationId;
    }

    public async Task InitializeAsync()
    {
        await UpdatePreviewAsync();
    }

    partial void OnSelectedFormatChanged(ExportFormat value) => _ = UpdatePreviewAsync();
    partial void OnIncludeTimestampsChanged(bool value) => _ = UpdatePreviewAsync();
    partial void OnIncludeSystemPromptChanged(bool value) => _ = UpdatePreviewAsync();
    partial void OnIncludeTokenCountsChanged(bool value) => _ = UpdatePreviewAsync();

    private async Task UpdatePreviewAsync()
    {
        try
        {
            Preview = await _exportService.GeneratePreviewAsync(
                _conversationId,
                CreateOptions(),
                maxLength: 500);
        }
        catch (Exception ex)
        {
            Preview = $"Error generating preview: {ex.Message}";
        }
    }

    [RelayCommand]
    private async Task ExportAsync()
    {
        try
        {
            IsExporting = true;
            ErrorMessage = null;

            var options = CreateOptions();
            var result = await _exportService.ExportAsync(_conversationId, options);

            if (!result.Success)
            {
                ErrorMessage = result.ErrorMessage;
                return;
            }

            // Show save file dialog
            var file = await _storageProvider.SaveFilePickerAsync(new FilePickerSaveOptions
            {
                Title = "Export Conversation",
                SuggestedFileName = result.SuggestedFileName,
                FileTypeChoices = new[]
                {
                    new FilePickerFileType(GetFormatName(SelectedFormat))
                    {
                        Patterns = new[] { $"*{_exportService.GetFileExtension(SelectedFormat)}" },
                        MimeTypes = new[] { result.MimeType }
                    }
                }
            });

            if (file is null)
                return;

            await using var stream = await file.OpenWriteAsync();
            await using var writer = new System.IO.StreamWriter(stream);
            await writer.WriteAsync(result.Content);

            CloseRequested?.Invoke(this, EventArgs.Empty);
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsExporting = false;
        }
    }

    [RelayCommand]
    private void Cancel()
    {
        CloseRequested?.Invoke(this, EventArgs.Empty);
    }

    private ExportOptions CreateOptions() => new()
    {
        Format = SelectedFormat,
        IncludeTimestamps = IncludeTimestamps,
        IncludeSystemPrompt = IncludeSystemPrompt,
        IncludeTokenCounts = IncludeTokenCounts
    };

    private static string GetFormatName(ExportFormat format) => format switch
    {
        ExportFormat.Markdown => "Markdown",
        ExportFormat.Json => "JSON",
        ExportFormat.PlainText => "Plain Text",
        ExportFormat.Html => "HTML",
        _ => "File"
    };
}
```

### ExportDialog.axaml

```xml
<!-- src/SeniorIntern.Desktop/Views/ExportDialog.axaml -->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
        x:Class="SeniorIntern.Desktop.Views.ExportDialog"
        x:DataType="vm:ExportViewModel"
        Title="Export Conversation"
        Width="550"
        Height="500"
        WindowStartupLocation="CenterOwner"
        CanResize="False">

    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding CancelCommand}" />
    </Window.KeyBindings>

    <Grid RowDefinitions="*,Auto" Margin="20">

        <!-- Content -->
        <ScrollViewer Grid.Row="0">
            <StackPanel Spacing="20">

                <!-- Format Selection -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Format" FontWeight="SemiBold" />
                    <StackPanel Spacing="4">
                        <RadioButton Content="Markdown (.md)"
                                     IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Markdown}"
                                     GroupName="Format" />
                        <RadioButton Content="JSON (.json)"
                                     IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Json}"
                                     GroupName="Format" />
                        <RadioButton Content="Plain Text (.txt)"
                                     IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=PlainText}"
                                     GroupName="Format" />
                        <RadioButton Content="HTML (.html)"
                                     IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Html}"
                                     GroupName="Format" />
                    </StackPanel>
                </StackPanel>

                <!-- Options -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Options" FontWeight="SemiBold" />
                    <CheckBox Content="Include timestamps"
                              IsChecked="{Binding IncludeTimestamps}" />
                    <CheckBox Content="Include system prompt"
                              IsChecked="{Binding IncludeSystemPrompt}" />
                    <CheckBox Content="Include token counts"
                              IsChecked="{Binding IncludeTokenCounts}" />
                </StackPanel>

                <!-- Preview -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Preview" FontWeight="SemiBold" />
                    <Border Background="{DynamicResource SystemChromeLowColor}"
                            BorderBrush="{DynamicResource SystemBaseMediumColor}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="12"
                            MinHeight="150"
                            MaxHeight="200">
                        <ScrollViewer>
                            <TextBlock Text="{Binding Preview}"
                                       FontFamily="Consolas, Menlo, monospace"
                                       FontSize="12"
                                       TextWrapping="Wrap" />
                        </ScrollViewer>
                    </Border>
                </StackPanel>

                <!-- Error Message -->
                <TextBlock Text="{Binding ErrorMessage}"
                           Foreground="Red"
                           IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                           TextWrapping="Wrap" />
            </StackPanel>
        </ScrollViewer>

        <!-- Buttons -->
        <StackPanel Grid.Row="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Spacing="12"
                    Margin="0,20,0,0">
            <Button Content="Cancel"
                    Command="{Binding CancelCommand}"
                    MinWidth="80" />
            <Button Content="Export"
                    Command="{Binding ExportCommand}"
                    IsEnabled="{Binding !IsExporting}"
                    Classes="accent"
                    MinWidth="80" />
        </StackPanel>
    </Grid>
</Window>
```

### ExportDialog.axaml.cs

```csharp
// src/SeniorIntern.Desktop/Views/ExportDialog.axaml.cs
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;
using SeniorIntern.Desktop.ViewModels;

public partial class ExportDialog : Window
{
    public ExportDialog()
    {
        InitializeComponent();
    }

    public ExportDialog(ExportViewModel viewModel) : this()
    {
        DataContext = viewModel;
        viewModel.CloseRequested += (s, e) => Close();
    }

    protected override async void OnOpened(EventArgs e)
    {
        base.OnOpened(e);

        if (DataContext is ExportViewModel vm)
        {
            await vm.InitializeAsync();
        }
    }
}
```

### Files to Create (v0.2.5f)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/ExportViewModel.cs` | Export dialog ViewModel |
| `src/SeniorIntern.Desktop/Views/ExportDialog.axaml` | Export dialog view |
| `src/SeniorIntern.Desktop/Views/ExportDialog.axaml.cs` | Export dialog code-behind |
| `src/SeniorIntern.Desktop/Converters/EnumBoolConverter.cs` | Enum to bool converter for radio buttons |

### Files to Modify (v0.2.5f)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add ExportCommand |
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add Ctrl+E key binding |

---

## v0.2.5g: Status Bar & Shortcuts

### Objective
Enhance the status bar with model info, token metrics, and save indicators. Implement global keyboard shortcuts.

### StatusBarViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/StatusBarViewModel.cs
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Interfaces;
using System.Diagnostics;

public partial class StatusBarViewModel : ViewModelBase, IDisposable
{
    private readonly ILlmService _llmService;
    private readonly IConversationService _conversationService;
    private readonly IInferenceSettingsService _inferenceSettings;
    private readonly Stopwatch _generationStopwatch = new();
    private int _tokenCount;

    [ObservableProperty]
    private string _modelName = "No model loaded";

    [ObservableProperty]
    private bool _isModelLoaded;

    [ObservableProperty]
    private string _tokenDisplay = string.Empty;

    [ObservableProperty]
    private bool _isGenerating;

    [ObservableProperty]
    private SaveStatus _saveStatus = SaveStatus.Saved;

    [ObservableProperty]
    private float _temperature;

    public event EventHandler? ModelClicked;
    public event EventHandler? TemperatureClicked;

    public StatusBarViewModel(
        ILlmService llmService,
        IConversationService conversationService,
        IInferenceSettingsService inferenceSettings)
    {
        _llmService = llmService;
        _conversationService = conversationService;
        _inferenceSettings = inferenceSettings;

        // Subscribe to events
        _llmService.ModelStateChanged += OnModelStateChanged;
        _llmService.TokenGenerated += OnTokenGenerated;
        _conversationService.SaveStatusChanged += OnSaveStatusChanged;
        _inferenceSettings.SettingsChanged += OnInferenceSettingsChanged;

        // Initialize
        UpdateModelDisplay();
        Temperature = _inferenceSettings.CurrentOptions.Temperature;
    }

    private void OnModelStateChanged(object? sender, ModelStateChangedEventArgs e)
    {
        UpdateModelDisplay();
    }

    private void OnTokenGenerated(object? sender, TokenGeneratedEventArgs e)
    {
        _tokenCount++;

        if (!IsGenerating)
        {
            IsGenerating = true;
            _generationStopwatch.Restart();
        }

        UpdateTokenDisplay();
    }

    private void OnSaveStatusChanged(object? sender, SaveStatusChangedEventArgs e)
    {
        SaveStatus = e.Status;
    }

    private void OnInferenceSettingsChanged(object? sender, EventArgs e)
    {
        Temperature = _inferenceSettings.CurrentOptions.Temperature;
    }

    private void UpdateModelDisplay()
    {
        IsModelLoaded = _llmService.IsModelLoaded;

        if (IsModelLoaded && _llmService.CurrentModelPath is not null)
        {
            ModelName = Path.GetFileName(_llmService.CurrentModelPath);
        }
        else
        {
            ModelName = "No model loaded";
        }
    }

    private void UpdateTokenDisplay()
    {
        var elapsed = _generationStopwatch.Elapsed.TotalSeconds;
        var tokensPerSecond = elapsed > 0 ? _tokenCount / elapsed : 0;

        TokenDisplay = $"{_tokenCount} ({tokensPerSecond:F1} tok/s)";
    }

    public void ResetTokenCount()
    {
        _tokenCount = 0;
        IsGenerating = false;
        _generationStopwatch.Reset();
        TokenDisplay = string.Empty;
    }

    public void GenerationComplete()
    {
        _generationStopwatch.Stop();
        IsGenerating = false;
        UpdateTokenDisplay();
    }

    [RelayCommand]
    private void OnModelClick()
    {
        ModelClicked?.Invoke(this, EventArgs.Empty);
    }

    [RelayCommand]
    private void OnTemperatureClick()
    {
        TemperatureClicked?.Invoke(this, EventArgs.Empty);
    }

    public void Dispose()
    {
        _llmService.ModelStateChanged -= OnModelStateChanged;
        _llmService.TokenGenerated -= OnTokenGenerated;
        _conversationService.SaveStatusChanged -= OnSaveStatusChanged;
        _inferenceSettings.SettingsChanged -= OnInferenceSettingsChanged;
    }
}

public enum SaveStatus
{
    Saved,
    Unsaved,
    Saving
}
```

### Status Bar XAML Update

```xml
<!-- Update to MainWindow.axaml - Status Bar section -->
<Border Grid.Row="2"
        Background="{DynamicResource SystemChromeLowColor}"
        Height="28"
        Padding="12,0">
    <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">

        <!-- Model Name (Clickable) -->
        <Button Grid.Column="0"
                Command="{Binding StatusBar.OnModelClickCommand}"
                Background="Transparent"
                Padding="8,4"
                ToolTip.Tip="Click to change model">
            <StackPanel Orientation="Horizontal" Spacing="6">
                <TextBlock Text="Model:"
                           Foreground="{DynamicResource SystemBaseMediumColor}" />
                <TextBlock Text="{Binding StatusBar.ModelName}"
                           Foreground="{Binding StatusBar.IsModelLoaded, Converter={StaticResource BoolToColorConverter}}" />
            </StackPanel>
        </Button>

        <Border Grid.Column="1"
                Width="1"
                Background="{DynamicResource SystemBaseMediumColor}"
                Margin="8,4" />

        <!-- Token Counter -->
        <StackPanel Grid.Column="2"
                    Orientation="Horizontal"
                    Spacing="6"
                    IsVisible="{Binding StatusBar.TokenDisplay, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <TextBlock Text="Tokens:"
                       Foreground="{DynamicResource SystemBaseMediumColor}" />
            <TextBlock Text="{Binding StatusBar.TokenDisplay}"
                       Foreground="{DynamicResource SystemAccentColor}" />
        </StackPanel>

        <!-- Save Status -->
        <StackPanel Grid.Column="3"
                    Orientation="Horizontal"
                    Spacing="4"
                    Margin="8,0">
            <TextBlock Text="{Binding StatusBar.SaveStatus, Converter={StaticResource SaveStatusConverter}}"
                       Foreground="{Binding StatusBar.SaveStatus, Converter={StaticResource SaveStatusColorConverter}}" />
        </StackPanel>

        <Border Grid.Column="3"
                Width="1"
                Background="{DynamicResource SystemBaseMediumColor}"
                Margin="8,4" />

        <!-- Temperature (Clickable) -->
        <Button Grid.Column="4"
                Command="{Binding StatusBar.OnTemperatureClickCommand}"
                Background="Transparent"
                Padding="8,4"
                ToolTip.Tip="Click to adjust temperature">
            <StackPanel Orientation="Horizontal" Spacing="4">
                <TextBlock Text="T:"
                           Foreground="{DynamicResource SystemBaseMediumColor}" />
                <TextBlock Text="{Binding StatusBar.Temperature, StringFormat='{}{0:F1}'}"
                           Foreground="{DynamicResource SystemAccentColor}" />
            </StackPanel>
        </Button>
    </Grid>
</Border>
```

### Keyboard Shortcuts Configuration

```csharp
// Update to MainWindow.axaml.cs
public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
        ConfigureKeyboardShortcuts();
    }

    private void ConfigureKeyboardShortcuts()
    {
        // Global keyboard shortcuts
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.K, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.OpenSearchCommand.Execute(null))
        });

        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.N, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.NewConversationCommand.Execute(null))
        });

        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.E, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.ExportCommand.Execute(null))
        });

        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.OemComma, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.OpenSettingsCommand.Execute(null))
        });

        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.P, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.OpenSystemPromptEditorCommand.Execute(null))
        });

        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.S, KeyModifiers.Control | KeyModifiers.Shift),
            Command = new RelayCommand(() => ViewModel?.SaveConversationCommand.Execute(null))
        });
    }

    private MainWindowViewModel? ViewModel => DataContext as MainWindowViewModel;
}
```

### MainWindowViewModel Updates

```csharp
// Additional commands for MainWindowViewModel
public partial class MainWindowViewModel : ViewModelBase
{
    // ... existing code ...

    [ObservableProperty]
    private StatusBarViewModel _statusBar;

    [RelayCommand]
    private async Task OpenSearchAsync()
    {
        var viewModel = new SearchViewModel(_searchService, _conversationService);
        viewModel.NavigateToConversation += async (s, id) =>
        {
            await LoadConversationAsync(id);
        };

        var dialog = new SearchDialog(viewModel);
        await dialog.ShowDialog(GetMainWindow());
    }

    [RelayCommand]
    private async Task NewConversationAsync()
    {
        var conversation = await _conversationService.CreateAsync();
        await LoadConversationAsync(conversation.Id);
    }

    [RelayCommand]
    private async Task ExportAsync()
    {
        if (CurrentConversationId is null)
            return;

        var viewModel = new ExportViewModel(
            _exportService,
            GetMainWindow().StorageProvider,
            CurrentConversationId.Value);

        var dialog = new ExportDialog(viewModel);
        await dialog.ShowDialog(GetMainWindow());
    }

    [RelayCommand]
    private void OpenSettings()
    {
        // Toggle settings panel visibility
        IsSettingsPanelOpen = !IsSettingsPanelOpen;
    }

    [RelayCommand]
    private async Task OpenSystemPromptEditorAsync()
    {
        var viewModel = new SystemPromptEditorViewModel(_systemPromptService);
        var dialog = new SystemPromptEditorWindow(viewModel);
        await dialog.ShowDialog(GetMainWindow());
    }

    [RelayCommand]
    private async Task SaveConversationAsync()
    {
        if (CurrentConversationId.HasValue)
        {
            await _conversationService.SaveAsync(CurrentConversationId.Value);
        }
    }

    private Window GetMainWindow()
    {
        return (Application.Current?.ApplicationLifetime as IClassicDesktopStyleApplicationLifetime)
            ?.MainWindow!;
    }
}
```

### Files to Create (v0.2.5g)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/StatusBarViewModel.cs` | Status bar ViewModel |
| `src/SeniorIntern.Desktop/Converters/SaveStatusConverter.cs` | Save status to text/color |
| `src/SeniorIntern.Desktop/Converters/BoolToColorConverter.cs` | Bool to accent color |

### Files to Modify (v0.2.5g)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Update status bar, add key bindings |
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml.cs` | Add keyboard shortcut configuration |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add StatusBarViewModel, shortcut commands |
| `src/SeniorIntern.Core/Events/LlmEvents.cs` | Add TokenGeneratedEventArgs |

---

## Files Summary

### Files to Create (24 total)

| Part | File | Purpose |
|------|------|---------|
| v0.2.5a | `src/SeniorIntern.Core/Models/SearchResult.cs` | Search result model |
| v0.2.5a | `src/SeniorIntern.Core/Models/SearchQuery.cs` | Search query model |
| v0.2.5a | `src/SeniorIntern.Core/Models/SearchResults.cs` | Grouped results container |
| v0.2.5a | `src/SeniorIntern.Data/Migrations/XXXXXXXX_AddFts5SearchTables.cs` | FTS5 migration |
| v0.2.5b | `src/SeniorIntern.Core/Interfaces/ISearchService.cs` | Search service interface |
| v0.2.5b | `src/SeniorIntern.Services/SearchService.cs` | Search service implementation |
| v0.2.5c | `src/SeniorIntern.Core/Models/ExportOptions.cs` | Export options model |
| v0.2.5c | `src/SeniorIntern.Core/Models/ExportResult.cs` | Export result model |
| v0.2.5c | `src/SeniorIntern.Core/Interfaces/IExportService.cs` | Export service interface |
| v0.2.5c | `src/SeniorIntern.Services/ExportService.cs` | Export service implementation |
| v0.2.5d | `src/SeniorIntern.Core/Models/MigrationResult.cs` | Migration result model |
| v0.2.5d | `src/SeniorIntern.Core/Models/LegacySettings.cs` | v0.1.0 settings format |
| v0.2.5d | `src/SeniorIntern.Core/Entities/AppVersionEntity.cs` | Version tracking entity |
| v0.2.5d | `src/SeniorIntern.Core/Interfaces/IMigrationService.cs` | Migration service interface |
| v0.2.5d | `src/SeniorIntern.Services/MigrationService.cs` | Migration service implementation |
| v0.2.5e | `src/SeniorIntern.Desktop/ViewModels/SearchViewModel.cs` | Search dialog ViewModel |
| v0.2.5e | `src/SeniorIntern.Desktop/Views/SearchDialog.axaml` | Search dialog view |
| v0.2.5e | `src/SeniorIntern.Desktop/Views/SearchDialog.axaml.cs` | Search dialog code-behind |
| v0.2.5f | `src/SeniorIntern.Desktop/ViewModels/ExportViewModel.cs` | Export dialog ViewModel |
| v0.2.5f | `src/SeniorIntern.Desktop/Views/ExportDialog.axaml` | Export dialog view |
| v0.2.5f | `src/SeniorIntern.Desktop/Views/ExportDialog.axaml.cs` | Export dialog code-behind |
| v0.2.5f | `src/SeniorIntern.Desktop/Converters/EnumBoolConverter.cs` | Enum to bool converter |
| v0.2.5g | `src/SeniorIntern.Desktop/ViewModels/StatusBarViewModel.cs` | Status bar ViewModel |
| v0.2.5g | `src/SeniorIntern.Desktop/Converters/SaveStatusConverter.cs` | Save status converters |

### Files to Modify (9 total)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Data/SeniorInternDbContext.cs` | Add FTS5 raw SQL methods, AppVersionEntity DbSet |
| `src/SeniorIntern.Data/Configurations/AppVersionConfiguration.cs` | Entity configuration |
| `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Register new services |
| `src/SeniorIntern.Desktop/App.axaml.cs` | Run migration on startup |
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Update status bar, add key bindings |
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml.cs` | Add keyboard shortcut configuration |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add StatusBarViewModel, shortcut commands |
| `src/SeniorIntern.Core/Events/LlmEvents.cs` | Add TokenGeneratedEventArgs |
| `src/SeniorIntern.Desktop/Themes/Dark.axaml` | Add status bar styles |

---

## Testing Strategy

### Unit Tests

```csharp
// tests/SeniorIntern.Services.Tests/SearchServiceTests.cs
public class SearchServiceTests
{
    [Fact]
    public async Task SearchAsync_WithValidQuery_ReturnsResults()
    {
        // Arrange
        var dbContext = CreateInMemoryDbContext();
        var service = new SearchService(dbContext, NullLogger<SearchService>.Instance);

        // Add test data
        await SeedTestConversations(dbContext);

        // Act
        var results = await service.SearchAsync(new SearchQuery { Text = "test" });

        // Assert
        Assert.True(results.TotalCount > 0);
    }

    [Fact]
    public async Task SearchAsync_WithEmptyQuery_ReturnsEmpty()
    {
        // ...
    }

    [Fact]
    public async Task SearchAsync_SanitizesSpecialCharacters()
    {
        // ...
    }
}
```

```csharp
// tests/SeniorIntern.Services.Tests/ExportServiceTests.cs
public class ExportServiceTests
{
    [Theory]
    [InlineData(ExportFormat.Markdown)]
    [InlineData(ExportFormat.Json)]
    [InlineData(ExportFormat.PlainText)]
    [InlineData(ExportFormat.Html)]
    public async Task ExportAsync_AllFormats_ProducesValidOutput(ExportFormat format)
    {
        // ...
    }

    [Fact]
    public async Task ExportAsync_WithOptions_RespectsIncludeFlags()
    {
        // ...
    }
}
```

```csharp
// tests/SeniorIntern.Services.Tests/MigrationServiceTests.cs
public class MigrationServiceTests
{
    [Fact]
    public async Task MigrateIfNeededAsync_WithLegacySettings_MigratesSuccessfully()
    {
        // ...
    }

    [Fact]
    public async Task MigrateIfNeededAsync_WithNoLegacySettings_SkipsMigration()
    {
        // ...
    }

    [Fact]
    public async Task MigrateIfNeededAsync_BackupsOriginalFile()
    {
        // ...
    }
}
```

### Integration Tests

```csharp
// tests/SeniorIntern.Integration.Tests/SearchIntegrationTests.cs
public class SearchIntegrationTests : IClassFixture<DatabaseFixture>
{
    [Fact]
    public async Task Fts5Search_FindsConversationsByTitle()
    {
        // ...
    }

    [Fact]
    public async Task Fts5Search_FindsMessagesByContent()
    {
        // ...
    }

    [Fact]
    public async Task Fts5Search_RanksResultsByRelevance()
    {
        // ...
    }
}
```

### UI Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/SearchDialogTests.cs
public class SearchDialogTests
{
    [Fact]
    public void SearchDialog_DebouncesProperly()
    {
        // ...
    }

    [Fact]
    public void SearchDialog_KeyboardNavigation_Works()
    {
        // ...
    }
}
```

---

## Acceptance Criteria

### v0.2.5a - FTS5 Search Infrastructure
- [ ] FTS5 virtual tables created for Conversations and Messages
- [ ] Triggers maintain FTS index sync on CRUD operations
- [ ] Search models properly defined

### v0.2.5b - Search Service
- [ ] SearchAsync returns grouped results (conversations + messages)
- [ ] Results include highlighted snippets
- [ ] Results ranked by BM25 relevance
- [ ] Search is debounced (300ms)
- [ ] Query sanitization prevents FTS5 injection

### v0.2.5c - Export Service
- [ ] Markdown export produces valid .md file
- [ ] JSON export produces valid, parseable JSON
- [ ] Plain text export produces readable transcript
- [ ] HTML export produces styled, viewable HTML
- [ ] All export options (timestamps, system prompt, tokens) respected

### v0.2.5d - Migration Service
- [ ] Detects existing v0.1.0 settings.json
- [ ] Backs up original settings before migration
- [ ] Migrates settings to v0.2.0 database schema
- [ ] Creates default system prompts and presets
- [ ] Stamps version in database
- [ ] Handles missing/corrupt settings gracefully

### v0.2.5e - Search UI
- [ ] Ctrl+K opens search dialog
- [ ] Search input auto-focused on open
- [ ] Results grouped by type (Conversations, Messages)
- [ ] Keyboard navigation (â†‘â†“) works
- [ ] Enter selects result and navigates
- [ ] Esc closes dialog
- [ ] Filter tabs work (All, Conversations, Messages)

### v0.2.5f - Export UI
- [ ] Ctrl+E opens export dialog
- [ ] Format selection updates preview
- [ ] Options toggle updates preview
- [ ] Export saves file to user-selected location
- [ ] File extension matches selected format

### v0.2.5g - Status Bar & Shortcuts
- [ ] Model name displayed (clickable â†’ model selector)
- [ ] Token count shows during generation with tok/s
- [ ] Save indicator shows âœ“ Saved / â—‹ Unsaved
- [ ] Temperature displayed (clickable â†’ settings)
- [ ] All keyboard shortcuts functional:
  - [ ] Ctrl+K â†’ Search
  - [ ] Ctrl+N â†’ New conversation
  - [ ] Ctrl+E â†’ Export
  - [ ] Ctrl+, â†’ Settings
  - [ ] Ctrl+P â†’ System prompt editor
  - [ ] Ctrl+Shift+S â†’ Save conversation

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| FTS5 not available in SQLite build | Low | High | Use Microsoft.Data.Sqlite which includes FTS5 |
| Large search results slow UI | Medium | Medium | Pagination, virtualized list, result limits |
| Export of large conversations slow | Medium | Low | Async with progress indicator |
| Migration corrupts settings | Low | High | Backup before migrate, rollback on error |
| Keyboard shortcuts conflict with OS | Medium | Low | Use platform-appropriate modifiers (Cmd on macOS) |

---

## Performance Considerations

### Search Performance
- FTS5 indexes are automatically maintained via triggers
- BM25 ranking is computed by SQLite (efficient)
- Limit results to 50 by default
- Debounce input (300ms) to reduce queries

### Export Performance
- Stream large exports instead of building in memory
- Generate preview with truncated content
- Async file writing

### Status Bar Performance
- Token counting uses lightweight events
- Rate calculation updated every token (not batched)
- Save status uses debounced auto-save (2s delay)

---

## References

- [SQLite FTS5 Extension](https://www.sqlite.org/fts5.html)
- [BM25 Ranking Algorithm](https://en.wikipedia.org/wiki/Okapi_BM25)
- [Avalonia Keyboard Handling](https://docs.avaloniaui.net/docs/input/keyboard)
- [CommunityToolkit.Mvvm](https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/)
