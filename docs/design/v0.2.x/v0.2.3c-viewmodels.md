# Design Specification: The Senior Intern v0.2.3c "ViewModels"

## Executive Summary

This document provides a detailed implementation specification for v0.2.3c, which creates the ViewModels for the inference settings panel. This includes `InferenceSettingsViewModel` for parameter binding with debounced updates and `InferencePresetViewModel` for preset display in dropdowns.

### v0.2.3c Scope (from v0.2.3 Design Document)

- Create `InferenceSettingsViewModel` with parameter properties and commands
- Create `InferencePresetViewModel` for preset items
- Implement debounced service updates (200ms)
- Computed description properties for real-time feedback
- Event subscription for two-way sync with service
- Preset CRUD commands

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| InferenceSettingsViewModel | Full settings panel ViewModel |
| InferencePresetViewModel | Preset item ViewModel for dropdown |
| DI Registration | ViewModel wiring |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.3c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  InferenceSettingsViewModel                                       │
│  ├── Parameter Properties (with OnChanged handlers)              │
│  │   ├── Temperature (float)                                      │
│  │   ├── TopP (float)                                             │
│  │   ├── MaxTokens (int)                                          │
│  │   ├── ContextSize (uint)                                       │
│  │   ├── RepetitionPenalty (float)                                │
│  │   └── TopK (int)                                               │
│  │                                                                │
│  ├── Computed Descriptions                                        │
│  │   ├── TemperatureDescription (contextual text)                 │
│  │   ├── TopPDescription ("top X% probability")                   │
│  │   ├── MaxTokensDescription ("~X words")                        │
│  │   ├── ContextSizeDescription ("~X words history")              │
│  │   ├── RepetitionPenaltyDescription (light/moderate/strong)     │
│  │   └── TopKDescription ("top X tokens")                         │
│  │                                                                │
│  ├── State Properties                                             │
│  │   ├── Presets (ObservableCollection)                           │
│  │   ├── SelectedPreset                                           │
│  │   ├── HasUnsavedChanges                                        │
│  │   ├── IsExpanded, ShowAdvanced                                 │
│  │   ├── IsLoading, ErrorMessage                                  │
│  │   └── _isUpdatingFromService (sync flag)                       │
│  │                                                                │
│  ├── Commands                                                     │
│  │   ├── LoadPresetsAsync                                         │
│  │   ├── ApplyPresetAsync(preset)                                 │
│  │   ├── SaveAsPresetAsync                                        │
│  │   ├── UpdateCurrentPresetAsync                                 │
│  │   ├── DeletePresetAsync(preset)                                │
│  │   ├── ResetToDefaultsAsync                                     │
│  │   ├── ToggleAdvanced                                           │
│  │   └── ToggleExpanded                                           │
│  │                                                                │
│  ├── Debouncing                                                   │
│  │   ├── _debounceTimer (200ms)                                   │
│  │   ├── QueueServiceUpdate() on property change                  │
│  │   └── OnDebounceElapsed() → batch update service               │
│  │                                                                │
│  └── Event Handlers                                               │
│      ├── OnSettingsChanged → SyncFromService()                    │
│      └── OnPresetChanged → LoadPresetsAsync()                     │
│                                                                   │
│  InferencePresetViewModel                                         │
│  ├── Id, Name, Description, Category                              │
│  ├── IsBuiltIn, IsDefault, IsSelected                             │
│  ├── ParameterSummary ("Temp: 0.7, TopP: 0.9...")                 │
│  └── TypeIndicator ("Built-in" / "Custom")                        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### ViewModel-Service Binding

```
┌─────────────────────────────────────────────────────────────────┐
│                ViewModel-Service Two-Way Binding                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │              InferenceSettingsViewModel                    │  │
│  │  ┌────────────────────────────────────────────────────┐   │  │
│  │  │ Observable Properties                              │   │  │
│  │  │ Temperature, TopP, MaxTokens, ContextSize...       │   │  │
│  │  └────────────────────┬───────────────────────────────┘   │  │
│  │                       │                                    │  │
│  │  User changes slider ─┤                                    │  │
│  │                       │                                    │  │
│  │         ┌─────────────▼──────────────┐                    │  │
│  │         │ OnPropertyChanged()         │                    │  │
│  │         │ 1. If updating from service → skip              │  │
│  │         │ 2. Update description property                  │  │
│  │         │ 3. QueueServiceUpdate()                         │  │
│  │         └─────────────┬──────────────┘                    │  │
│  │                       │                                    │  │
│  │         ┌─────────────▼──────────────┐                    │  │
│  │         │ Debounce Timer (200ms)      │                    │  │
│  │         └─────────────┬──────────────┘                    │  │
│  │                       │ elapsed                            │  │
│  │         ┌─────────────▼──────────────┐                    │  │
│  │         │ OnDebounceElapsed()         │                    │  │
│  │         │ Batch update all params     │                    │  │
│  │         └─────────────┬──────────────┘                    │  │
│  └───────────────────────┼────────────────────────────────────┘  │
│                          │                                       │
│                          ▼                                       │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │            IInferenceSettingsService                       │  │
│  │  UpdateTemperature(), UpdateTopP(), etc.                   │  │
│  │                          │                                 │  │
│  │             Fires SettingsChanged event                    │  │
│  │                          │                                 │  │
│  └──────────────────────────┼─────────────────────────────────┘  │
│                             │                                    │
│                             ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ViewModel.OnSettingsChanged()                             │  │
│  │  1. Set _isUpdatingFromService = true                      │  │
│  │  2. Sync all properties from service                       │  │
│  │  3. Set _isUpdatingFromService = false                     │  │
│  │  (Prevents feedback loop)                                  │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Preset Selection Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Preset Selection Flow                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User selects "Creative" from dropdown                           │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ OnSelectedPresetChanged(value)                            │    │
│  │  - Check if updating from service → skip                  │    │
│  │  - Call ApplyPresetAsync(value)                           │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ApplyPresetAsync()                                        │    │
│  │  - Set IsLoading = true                                   │    │
│  │  - await _settingsService.ApplyPresetAsync(id)            │    │
│  │  - Set IsLoading = false                                  │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Service fires SettingsChanged event                       │    │
│  │ ViewModel.OnSettingsChanged() called                      │    │
│  │  - SyncFromService() updates all sliders                  │    │
│  │  - Temperature → 1.2, TopP → 0.95, etc.                   │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  UI reflects "Creative" preset values                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
├── ViewModels/
│   ├── InferenceSettingsViewModel.cs                 (NEW)
│   └── InferencePresetViewModel.cs                   (NEW)
└── Extensions/
    └── ServiceCollectionExtensions.cs                (UPDATE)
```

---

## Implementation Details

### Task 1: Create InferencePresetViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/InferencePresetViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using SeniorIntern.Core.Models;

/// <summary>ViewModel for a preset in the dropdown.</summary>
public partial class InferencePresetViewModel : ViewModelBase
{
    public Guid Id { get; init; }

    [ObservableProperty] private string _name = string.Empty;
    [ObservableProperty] private string? _description;
    [ObservableProperty] private string? _category;
    [ObservableProperty] private bool _isBuiltIn;
    [ObservableProperty] private bool _isDefault;
    [ObservableProperty] private bool _isSelected;

    /// <summary>Summary of key parameters.</summary>
    public string ParameterSummary { get; init; } = string.Empty;

    /// <summary>"Built-in" or "Custom".</summary>
    public string TypeIndicator => IsBuiltIn ? "Built-in" : "Custom";

    public InferencePresetViewModel() { }

    public InferencePresetViewModel(InferencePreset preset)
    {
        Id = preset.Id;
        Name = preset.Name;
        Description = preset.Description;
        Category = preset.Category;
        IsBuiltIn = preset.IsBuiltIn;
        IsDefault = preset.IsDefault;
        ParameterSummary = $"Temp: {preset.Options.Temperature:F1}, " +
                          $"TopP: {preset.Options.TopP:F2}, " +
                          $"Max: {preset.Options.MaxTokens}";
    }
}
```

---

### Task 2: Create InferenceSettingsViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/InferenceSettingsViewModel.cs`

Key sections:

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using System.Collections.ObjectModel;

public partial class InferenceSettingsViewModel : ViewModelBase, IDisposable
{
    private readonly IInferenceSettingsService _settingsService;
    private readonly IDispatcher _dispatcher;
    private bool _isUpdatingFromService;
    private System.Timers.Timer? _debounceTimer;

    // Parameter properties with defaults
    [ObservableProperty] private float _temperature = ParameterConstants.Temperature.Default;
    [ObservableProperty] private float _topP = ParameterConstants.TopP.Default;
    [ObservableProperty] private int _maxTokens = ParameterConstants.MaxTokens.Default;
    [ObservableProperty] private uint _contextSize = ParameterConstants.ContextSize.Default;
    [ObservableProperty] private float _repetitionPenalty = ParameterConstants.RepetitionPenalty.Default;
    [ObservableProperty] private int _topK = ParameterConstants.TopK.Default;

    // State properties
    [ObservableProperty] private ObservableCollection<InferencePresetViewModel> _presets = new();
    [ObservableProperty] private InferencePresetViewModel? _selectedPreset;
    [ObservableProperty] private bool _hasUnsavedChanges;
    [ObservableProperty] private bool _isExpanded = true;
    [ObservableProperty] private bool _showAdvanced;
    [ObservableProperty] private bool _isLoading;
    [ObservableProperty] private string? _errorMessage;

    // Computed descriptions
    public string TemperatureDescription => Temperature switch
    {
        < 0.3f => "Very focused and deterministic",
        < 0.6f => "Consistent with slight variation",
        < 0.8f => "Balanced creativity and consistency",
        < 1.0f => "More creative and varied",
        < 1.3f => "Creative and experimental",
        _ => "Highly random and experimental"
    };

    public string TopPDescription => $"Considers top {TopP * 100:F0}% probability mass";
    public string MaxTokensDescription => $"~{MaxTokens * 3 / 4} words maximum";
    public string ContextSizeDescription => $"~{ContextSize * 3 / 4} words of history";
    public string RepetitionPenaltyDescription => RepetitionPenalty switch
    {
        <= 1.0f => "No repetition penalty",
        < 1.1f => "Light repetition penalty",
        < 1.2f => "Moderate repetition penalty",
        _ => "Strong repetition penalty"
    };
    public string TopKDescription => TopK == 0 ? "Disabled" : $"Consider top {TopK} tokens";

    public InferenceSettingsViewModel(IInferenceSettingsService settingsService, IDispatcher dispatcher)
    {
        _settingsService = settingsService;
        _dispatcher = dispatcher;
        _settingsService.SettingsChanged += OnSettingsChanged;
        _settingsService.PresetChanged += OnPresetChanged;
        _debounceTimer = new System.Timers.Timer(200) { AutoReset = false };
        _debounceTimer.Elapsed += OnDebounceElapsed;
    }

    // Property change handlers (all similar pattern)
    partial void OnTemperatureChanged(float value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(TemperatureDescription));
        QueueServiceUpdate();
    }
    // ... similar for TopP, MaxTokens, ContextSize, RepetitionPenalty, TopK

    // Debounce logic
    private void QueueServiceUpdate()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
        HasUnsavedChanges = true;
    }

    private void OnDebounceElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        _settingsService.UpdateTemperature(Temperature);
        _settingsService.UpdateTopP(TopP);
        _settingsService.UpdateMaxTokens(MaxTokens);
        _settingsService.UpdateContextSize(ContextSize);
        _settingsService.UpdateRepetitionPenalty(RepetitionPenalty);
        _settingsService.UpdateTopK(TopK);
    }

    // Sync from service (prevents feedback loop)
    private void SyncFromService()
    {
        _isUpdatingFromService = true;
        try
        {
            var options = _settingsService.CurrentOptions;
            Temperature = options.Temperature;
            TopP = options.TopP;
            MaxTokens = options.MaxTokens;
            ContextSize = options.ContextSize;
            RepetitionPenalty = options.RepetitionPenalty;
            TopK = options.TopK;
            HasUnsavedChanges = _settingsService.HasUnsavedChanges;
            UpdatePresetSelection();
        }
        finally { _isUpdatingFromService = false; }
    }

    public void Dispose()
    {
        _settingsService.SettingsChanged -= OnSettingsChanged;
        _settingsService.PresetChanged -= OnPresetChanged;
        _debounceTimer?.Dispose();
    }
}
```

**Commands:**

| Command | Behavior |
|---------|----------|
| `LoadPresetsAsync` | Load all presets from service, populate collection |
| `ApplyPresetAsync` | Apply selected preset to service |
| `SaveAsPresetAsync` | Save current settings as new preset |
| `UpdateCurrentPresetAsync` | Update active custom preset with current values |
| `DeletePresetAsync` | Delete a custom preset |
| `ResetToDefaultsAsync` | Reset to default preset |
| `ToggleAdvanced` | Show/hide advanced parameters |
| `ToggleExpanded` | Expand/collapse settings panel |

---

### Task 3: Update DI Registration

```csharp
services.AddSingleton<InferenceSettingsViewModel>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| InferencePresetViewModel | 3 | Constructor mapping, ParameterSummary |
| InferenceSettingsViewModel | 12 | Debounce, sync, commands, descriptions |
| **Total** | **15** | |

### Key Test Scenarios

```csharp
[Fact]
public void TemperatureDescription_ReturnsCorrectText()
{
    var vm = CreateViewModel();
    vm.Temperature = 0.2f;
    Assert.Equal("Very focused and deterministic", vm.TemperatureDescription);
    
    vm.Temperature = 1.5f;
    Assert.Equal("Highly random and experimental", vm.TemperatureDescription);
}

[Fact]
public void OnTemperatureChanged_QueuesServiceUpdate()
{
    var vm = CreateViewModel();
    vm.Temperature = 1.0f;
    Assert.True(vm.HasUnsavedChanges);
}

[Fact]
public void SyncFromService_SetsUpdatingFlag_PreventsLoop()
{
    var mockService = new Mock<IInferenceSettingsService>();
    var vm = CreateViewModel(mockService.Object);
    
    // Trigger service event
    mockService.Raise(s => s.SettingsChanged += null, args);
    
    // Verify no service update was queued
    mockService.Verify(s => s.UpdateTemperature(It.IsAny<float>()), Times.Never);
}

[Fact]
public void InferencePresetViewModel_Constructor_MapsProperties()
{
    var preset = new InferencePreset
    {
        Name = "Test",
        Description = "Desc",
        IsBuiltIn = true,
        Options = new() { Temperature = 1.5f }
    };
    var vm = new InferencePresetViewModel(preset);
    
    Assert.Equal("Test", vm.Name);
    Assert.True(vm.IsBuiltIn);
    Assert.Contains("1.5", vm.ParameterSummary);
}
```

---

## Files Summary

### Files to Create (2)

| File | Lines (approx) |
|------|----------------|
| `ViewModels/InferenceSettingsViewModel.cs` | 280 |
| `ViewModels/InferencePresetViewModel.cs` | 45 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Extensions/ServiceCollectionExtensions.cs` | Add ViewModel registration |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | All 6 parameter properties bind correctly |
| AC-2 | Computed descriptions update on value change |
| AC-3 | Debounce timer fires after 200ms |
| AC-4 | SyncFromService prevents feedback loops |
| AC-5 | SelectedPreset change triggers ApplyPresetAsync |
| AC-6 | SaveAsPresetAsync creates new preset |
| AC-7 | DeletePresetAsync removes custom preset |
| AC-8 | Cannot delete built-in presets (error message) |
| AC-9 | HasUnsavedChanges reflects service state |
| AC-10 | Event handlers use IDispatcher for UI thread |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| 200ms debounce | Balance responsiveness vs. event spam |
| `_isUpdatingFromService` flag | Prevent infinite update loops |
| Batch update in debounce | Fewer service calls |
| Computed property descriptions | Clean XAML bindings |
| ParameterSummary pre-computed | Avoid recalculation in UI |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.3c | 0.5-1 day |
