# Design Specification: AIntern v0.2.3d "Parameter Slider Control"

## Executive Summary

This document provides a detailed implementation specification for v0.2.3d, which creates a reusable `ParameterSlider` custom control. This control provides a consistent, polished UX for all inference parameters with labels, formatted value display, description text, and keyboard navigation support.

### v0.2.3d Scope (from v0.2.3 Design Document)

- Create `ParameterSlider` templated control class
- Create XAML template with label, value badge, slider, and description
- Support configurable min/max/step ranges
- Support float and integer value formatting
- Implement keyboard navigation (arrow keys, Home/End, Shift modifier)
- Coerce values to valid ranges

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ParameterSlider.cs | Templated control with styled properties |
| ParameterSlider.axaml | XAML template and styles |
| Theme Integration | Dynamic resource bindings |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.3d Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ParameterSlider : TemplatedControl                               │
│  ├── Styled Properties                                            │
│  │   ├── Label (string) - "Temperature"                           │
│  │   ├── Value (double, TwoWay binding, coerced)                  │
│  │   ├── Minimum (double) - 0.0                                   │
│  │   ├── Maximum (double) - 2.0                                   │
│  │   ├── Step (double) - 0.1                                      │
│  │   ├── Description (string) - contextual help                   │
│  │   ├── ValueFormat (string) - "F1", "F2", "F0"                  │
│  │   ├── Unit (string?) - "tokens", "words"                       │
│  │   ├── ShowDescription (bool) - true                            │
│  │   └── IsInteger (bool) - affects formatting                    │
│  │                                                                │
│  ├── Computed Properties                                          │
│  │   └── FormattedValue - "0.7" or "2048 tokens"                  │
│  │                                                                │
│  ├── Template Parts                                               │
│  │   └── PART_Slider (Slider) - inner slider control              │
│  │                                                                │
│  ├── Value Coercion                                               │
│  │   └── CoerceValue() - clamps to Min/Max                        │
│  │                                                                │
│  └── Keyboard Navigation                                          │
│      ├── Left/Down → decrease by Step                             │
│      ├── Right/Up → increase by Step                              │
│      ├── Shift+Arrow → increase by Step × 10                      │
│      ├── Home → Minimum                                           │
│      └── End → Maximum                                            │
│                                                                   │
│  Visual Layout                                                    │
│  ┌────────────────────────────────────────────────────────┐       │
│  │ Temperature                              [   0.7   ]   │       │
│  │ ═══════════════════●══════════════════════════════════ │       │
│  │ Balanced creativity and consistency                    │       │
│  └────────────────────────────────────────────────────────┘       │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Control Visual Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                  ParameterSlider Visual Layout                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Grid (RowDefinitions="Auto,Auto,Auto")                          │
│                                                                  │
│  Row 0: Label + Value Badge                                      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Grid (ColumnDefinitions="*,Auto")                            │ │
│  │ ┌──────────────────────────────┐ ┌─────────────────────────┐ │ │
│  │ │ TextBlock                    │ │ Border (value badge)    │ │ │
│  │ │ Text="{TemplateBinding      │ │ ┌─────────────────────┐ │ │ │
│  │ │        Label}"               │ │ │ TextBlock           │ │ │ │
│  │ │ FontWeight="SemiBold"        │ │ │ Text=FormattedValue │ │ │ │
│  │ │ FontSize="13"                │ │ │ FontFamily="mono"   │ │ │ │
│  │ └──────────────────────────────┘ │ └─────────────────────┘ │ │ │
│  │                                  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Row 1: Slider                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Slider (PART_Slider)                                         │ │
│  │ Value="{TemplateBinding Value, Mode=TwoWay}"                 │ │
│  │ Minimum="{TemplateBinding Minimum}"                          │ │
│  │ Maximum="{TemplateBinding Maximum}"                          │ │
│  │ IsSnapToTickEnabled="True"                                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Row 2: Description                                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ TextBlock                                                    │ │
│  │ Text="{TemplateBinding Description}"                         │ │
│  │ IsVisible="{TemplateBinding ShowDescription}"                │ │
│  │ FontSize="11"                                                │ │
│  │ Foreground="{DynamicResource TextSecondaryColor}"            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Property Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Property & Binding Flow                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ViewModel                    ParameterSlider                    │
│  ┌──────────────────┐         ┌──────────────────────────────┐  │
│  │ Temperature=1.2  │ ──────► │ Value property (coerced)     │  │
│  └──────────────────┘   TwoWay│                              │  │
│         ▲                 ◄───│ User drags slider            │  │
│         │                     └──────────────────────────────┘  │
│         │                                    │                   │
│  Debounce (200ms)                            │                   │
│         │                                    ▼                   │
│         │                     ┌──────────────────────────────┐  │
│         └─────────────────────│ OnPropertyChanged            │  │
│                               │ → RaisePropertyChanged       │  │
│                               │   (FormattedValue)           │  │
│                               └──────────────────────────────┘  │
│                                              │                   │
│                                              ▼                   │
│                               ┌──────────────────────────────┐  │
│                               │ UI Updates                    │  │
│                               │ - Value badge shows "1.2"    │  │
│                               │ - Slider thumb position      │  │
│                               └──────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
├── Controls/
│   ├── ParameterSlider.cs                            (NEW)
│   └── ParameterSlider.axaml                         (NEW)
└── Themes/
    └── Dark.axaml                                    (UPDATE - include control theme)
```

---

## Implementation Details

### Task 1: Create ParameterSlider Control Class

**File:** `src/SeniorIntern.Desktop/Controls/ParameterSlider.cs`

```csharp
namespace SeniorIntern.Desktop.Controls;

using Avalonia;
using Avalonia.Controls;
using Avalonia.Controls.Primitives;
using Avalonia.Data;
using Avalonia.Input;

/// <summary>
/// Custom slider control for inference parameters with label, value display, and description.
/// </summary>
public class ParameterSlider : TemplatedControl
{
    #region Styled Properties

    public static readonly StyledProperty<string> LabelProperty =
        AvaloniaProperty.Register<ParameterSlider, string>(nameof(Label), "Parameter");

    public static readonly StyledProperty<double> ValueProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(
            nameof(Value),
            defaultBindingMode: BindingMode.TwoWay,
            coerce: CoerceValue);

    public static readonly StyledProperty<double> MinimumProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(nameof(Minimum), 0.0);

    public static readonly StyledProperty<double> MaximumProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(nameof(Maximum), 1.0);

    public static readonly StyledProperty<double> StepProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(nameof(Step), 0.1);

    public static readonly StyledProperty<string> DescriptionProperty =
        AvaloniaProperty.Register<ParameterSlider, string>(nameof(Description), string.Empty);

    public static readonly StyledProperty<string> ValueFormatProperty =
        AvaloniaProperty.Register<ParameterSlider, string>(nameof(ValueFormat), "F1");

    public static readonly StyledProperty<string?> UnitProperty =
        AvaloniaProperty.Register<ParameterSlider, string?>(nameof(Unit));

    public static readonly StyledProperty<bool> ShowDescriptionProperty =
        AvaloniaProperty.Register<ParameterSlider, bool>(nameof(ShowDescription), true);

    public static readonly StyledProperty<bool> IsIntegerProperty =
        AvaloniaProperty.Register<ParameterSlider, bool>(nameof(IsInteger), false);

    #endregion

    #region Properties

    public string Label { get => GetValue(LabelProperty); set => SetValue(LabelProperty, value); }
    public double Value { get => GetValue(ValueProperty); set => SetValue(ValueProperty, value); }
    public double Minimum { get => GetValue(MinimumProperty); set => SetValue(MinimumProperty, value); }
    public double Maximum { get => GetValue(MaximumProperty); set => SetValue(MaximumProperty, value); }
    public double Step { get => GetValue(StepProperty); set => SetValue(StepProperty, value); }
    public string Description { get => GetValue(DescriptionProperty); set => SetValue(DescriptionProperty, value); }
    public string ValueFormat { get => GetValue(ValueFormatProperty); set => SetValue(ValueFormatProperty, value); }
    public string? Unit { get => GetValue(UnitProperty); set => SetValue(UnitProperty, value); }
    public bool ShowDescription { get => GetValue(ShowDescriptionProperty); set => SetValue(ShowDescriptionProperty, value); }
    public bool IsInteger { get => GetValue(IsIntegerProperty); set => SetValue(IsIntegerProperty, value); }

    /// <summary>Formatted value for display (e.g., "0.7" or "2048 tokens").</summary>
    public string FormattedValue
    {
        get
        {
            var format = IsInteger ? "F0" : ValueFormat;
            var value = Value.ToString(format);
            return Unit != null ? $"{value} {Unit}" : value;
        }
    }

    #endregion

    #region Template Parts

    private Slider? _slider;

    protected override void OnApplyTemplate(TemplateAppliedEventArgs e)
    {
        base.OnApplyTemplate(e);
        _slider = e.NameScope.Find<Slider>("PART_Slider");
        if (_slider != null)
        {
            _slider.KeyDown += OnSliderKeyDown;
        }
    }

    #endregion

    #region Value Coercion

    private static double CoerceValue(AvaloniaObject sender, double value)
    {
        var slider = (ParameterSlider)sender;
        return Math.Clamp(value, slider.Minimum, slider.Maximum);
    }

    #endregion

    #region Property Changed

    protected override void OnPropertyChanged(AvaloniaPropertyChangedEventArgs change)
    {
        base.OnPropertyChanged(change);

        if (change.Property == ValueProperty ||
            change.Property == ValueFormatProperty ||
            change.Property == UnitProperty ||
            change.Property == IsIntegerProperty)
        {
            RaisePropertyChanged(nameof(FormattedValue));
        }
    }

    #endregion

    #region Keyboard Navigation

    private void OnSliderKeyDown(object? sender, KeyEventArgs e)
    {
        var increment = e.KeyModifiers.HasFlag(KeyModifiers.Shift) ? Step * 10 : Step;

        switch (e.Key)
        {
            case Key.Left:
            case Key.Down:
                Value = Math.Max(Minimum, Value - increment);
                e.Handled = true;
                break;

            case Key.Right:
            case Key.Up:
                Value = Math.Min(Maximum, Value + increment);
                e.Handled = true;
                break;

            case Key.Home:
                Value = Minimum;
                e.Handled = true;
                break;

            case Key.End:
                Value = Maximum;
                e.Handled = true;
                break;
        }
    }

    #endregion
}
```

---

### Task 2: Create ParameterSlider XAML Template

**File:** `src/SeniorIntern.Desktop/Controls/ParameterSlider.axaml`

```xml
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="using:SeniorIntern.Desktop.Controls">

    <ControlTheme x:Key="{x:Type controls:ParameterSlider}" TargetType="controls:ParameterSlider">
        <Setter Property="Template">
            <ControlTemplate>
                <Grid RowDefinitions="Auto,Auto,Auto">
                    <!-- Row 0: Label and Value Badge -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,4">
                        <TextBlock Text="{TemplateBinding Label}"
                                   FontWeight="SemiBold"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextPrimaryColor}" />

                        <Border Grid.Column="1"
                                Background="{DynamicResource ControlBackgroundColor}"
                                CornerRadius="4"
                                Padding="8,2"
                                MinWidth="60"
                                HorizontalAlignment="Right">
                            <TextBlock Text="{TemplateBinding FormattedValue}"
                                       FontFamily="Consolas, Menlo, monospace"
                                       FontSize="12"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource TextPrimaryColor}" />
                        </Border>
                    </Grid>

                    <!-- Row 1: Slider -->
                    <Slider Grid.Row="1"
                            Name="PART_Slider"
                            Value="{TemplateBinding Value, Mode=TwoWay}"
                            Minimum="{TemplateBinding Minimum}"
                            Maximum="{TemplateBinding Maximum}"
                            SmallChange="{TemplateBinding Step}"
                            LargeChange="{TemplateBinding Step}"
                            TickFrequency="{TemplateBinding Step}"
                            IsSnapToTickEnabled="True"
                            Margin="0,4" />

                    <!-- Row 2: Description -->
                    <TextBlock Grid.Row="2"
                               Text="{TemplateBinding Description}"
                               IsVisible="{TemplateBinding ShowDescription}"
                               FontSize="11"
                               Foreground="{DynamicResource TextSecondaryColor}"
                               TextWrapping="Wrap"
                               Margin="0,2,0,8" />
                </Grid>
            </ControlTemplate>
        </Setter>
    </ControlTheme>

    <!-- Hover effect for slider thumb -->
    <Style Selector="controls|ParameterSlider /template/ Slider:pointerover /template/ Thumb">
        <Setter Property="Background" Value="{DynamicResource AccentHoverColor}" />
    </Style>

</ResourceDictionary>
```

---

### Task 3: Include Theme in App Resources

**File:** `src/SeniorIntern.Desktop/App.axaml` (update)

```xml
<Application.Resources>
    <ResourceInclude Source="avares://SeniorIntern.Desktop/Controls/ParameterSlider.axaml" />
</Application.Resources>
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| Value Coercion | 3 | Clamp to min/max |
| FormattedValue | 4 | Format string, unit, integer |
| Keyboard Navigation | 4 | Arrow keys, Shift, Home/End |
| **Total** | **11** | |

### Key Test Scenarios

```csharp
[Fact]
public void Value_IsCoercedToMinimum()
{
    var slider = new ParameterSlider { Minimum = 0, Maximum = 10 };
    slider.Value = -5;
    Assert.Equal(0, slider.Value);
}

[Fact]
public void Value_IsCoercedToMaximum()
{
    var slider = new ParameterSlider { Minimum = 0, Maximum = 10 };
    slider.Value = 15;
    Assert.Equal(10, slider.Value);
}

[Fact]
public void FormattedValue_UsesValueFormat()
{
    var slider = new ParameterSlider { Value = 0.75, ValueFormat = "F2" };
    Assert.Equal("0.75", slider.FormattedValue);
}

[Fact]
public void FormattedValue_IncludesUnit()
{
    var slider = new ParameterSlider { Value = 2048, IsInteger = true, Unit = "tokens" };
    Assert.Equal("2048 tokens", slider.FormattedValue);
}

[Fact]
public void FormattedValue_UsesF0ForInteger()
{
    var slider = new ParameterSlider { Value = 100.9, IsInteger = true };
    Assert.Equal("101", slider.FormattedValue);
}

[AvaloniaFact]
public void KeyDown_Right_IncreasesValue()
{
    var slider = CreateSlider(value: 5, step: 1);
    RaiseKeyDown(slider, Key.Right);
    Assert.Equal(6, slider.Value);
}

[AvaloniaFact]
public void KeyDown_ShiftRight_IncreasesValueByTenSteps()
{
    var slider = CreateSlider(value: 5, step: 1);
    RaiseKeyDown(slider, Key.Right, KeyModifiers.Shift);
    Assert.Equal(15, slider.Value);
}
```

---

## Usage Examples

```xml
<!-- Temperature slider -->
<controls:ParameterSlider
    Label="Temperature"
    Value="{Binding Temperature}"
    Minimum="0"
    Maximum="2"
    Step="0.1"
    Description="{Binding TemperatureDescription}"
    ValueFormat="F1" />

<!-- Max Tokens slider (integer) -->
<controls:ParameterSlider
    Label="Max Response Tokens"
    Value="{Binding MaxTokens}"
    Minimum="64"
    Maximum="8192"
    Step="64"
    Description="{Binding MaxTokensDescription}"
    IsInteger="True"
    Unit="tokens" />

<!-- Context Size slider (integer, no unit) -->
<controls:ParameterSlider
    Label="Context Window Size"
    Value="{Binding ContextSize}"
    Minimum="512"
    Maximum="32768"
    Step="512"
    Description="{Binding ContextSizeDescription}"
    IsInteger="True" />
```

---

## Files Summary

### Files to Create (2)

| File | Lines (approx) |
|------|----------------|
| `Controls/ParameterSlider.cs` | 130 |
| `Controls/ParameterSlider.axaml` | 60 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `App.axaml` | Include ParameterSlider resource dictionary |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Label displays above slider |
| AC-2 | Value badge shows formatted value |
| AC-3 | Description text displays below slider |
| AC-4 | ShowDescription=false hides description |
| AC-5 | Values clamp to Min/Max range |
| AC-6 | IsSnapToTickEnabled works with Step |
| AC-7 | Arrow keys adjust value by Step |
| AC-8 | Shift+Arrow adjusts by Step×10 |
| AC-9 | Home/End jump to Min/Max |
| AC-10 | Unit suffix displays correctly |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| TemplatedControl base | Allows full template customization |
| Value coercion | Prevents invalid state |
| PART_Slider naming | Standard Avalonia convention for template parts |
| Monospace font for value | Prevents layout shift as value changes |
| IsSnapToTickEnabled | Ensures clean step values |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.3d | 0.5 day |
