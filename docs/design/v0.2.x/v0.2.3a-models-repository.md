# Design Specification: AIntern v0.2.3a "Models & Repository"

## Executive Summary

This document provides a detailed implementation specification for v0.2.3a, which defines the inference options model, preset model, parameter constants, and implements the inference preset repository with built-in preset seeding.

### v0.2.3a Scope (from v0.2.3 Design Document)

- Create `InferenceOptions` model with validation
- Create `InferencePreset` domain model
- Create `ParameterConstants` for slider ranges
- Update `InferencePresetEntity` with all fields
- Create `IInferencePresetRepository` interface
- Implement `InferencePresetRepository` with seeding
- Seed 5 built-in presets (Precise, Balanced, Creative, Long-form, Code Review)

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| InferenceOptions | Model with Temperature, TopP, MaxTokens, ContextSize, etc. |
| InferencePreset | Domain model for named presets |
| ParameterConstants | Min/Max/Default/Step for all parameters |
| IInferencePresetRepository | Repository interface with CRUD + seeding |
| InferencePresetRepository | Implementation with built-in preset data |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.3a Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Models & Repository                                              │
│  ├── InferenceOptions                                             │
│  │   ├── Temperature (0.0 - 2.0, default 0.7)                     │
│  │   ├── TopP (0.0 - 1.0, default 0.9)                            │
│  │   ├── MaxTokens (64 - 8192, default 2048)                      │
│  │   ├── ContextSize (512 - 32768, default 4096)                  │
│  │   ├── RepetitionPenalty (1.0 - 2.0, default 1.1)               │
│  │   ├── TopK (0 - 100, default 40)                               │
│  │   ├── Seed (-1 = random)                                       │
│  │   ├── Clone() method                                           │
│  │   └── Validate() method                                        │
│  │                                                                │
│  ├── InferencePreset                                              │
│  │   ├── Id, Name, Description, Category                          │
│  │   ├── IsBuiltIn, IsDefault flags                               │
│  │   ├── Options (InferenceOptions)                               │
│  │   └── FromOptions() factory method                             │
│  │                                                                │
│  ├── ParameterConstants                                           │
│  │   └── Static classes for each parameter's Min/Max/Default/Step │
│  │                                                                │
│  ├── InferencePresetEntity (update)                               │
│  │   └── Add RepetitionPenalty, TopK, Seed, UsageCount            │
│  │                                                                │
│  └── InferencePresetRepository                                    │
│      ├── GetAllAsync, GetByIdAsync, GetByNameAsync                │
│      ├── GetDefaultAsync, GetByCategoryAsync                      │
│      ├── CreateAsync, UpdateAsync, DeleteAsync                    │
│      ├── SetAsDefaultAsync, IncrementUsageAsync                   │
│      ├── NameExistsAsync                                          │
│      └── SeedBuiltInPresetsAsync (5 presets)                      │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Model Relationship

```
┌─────────────────────────────────────────────────────────────────┐
│                      Model Relationships                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────┐     ┌─────────────────────────┐    │
│  │    InferencePreset      │     │   InferenceOptions      │    │
│  │  (Domain Model)         │     │   (Value Object)        │    │
│  ├─────────────────────────┤     ├─────────────────────────┤    │
│  │ Id: Guid                │     │ Temperature: float      │    │
│  │ Name: string            │     │ TopP: float             │    │
│  │ Description: string?    │     │ MaxTokens: int          │    │
│  │ Category: string?       │     │ ContextSize: uint       │    │
│  │ IsBuiltIn: bool         │  ◄──┤ RepetitionPenalty: float│    │
│  │ IsDefault: bool         │     │ TopK: int               │    │
│  │ CreatedAt: DateTime     │     │ Seed: int               │    │
│  │ UpdatedAt: DateTime     │     ├─────────────────────────┤    │
│  │ Options ─────────────────┘     │ +Clone()                │    │
│  └─────────────────────────┘     │ +Validate()             │    │
│              │                   └─────────────────────────┘    │
│              │ maps to                                          │
│              ▼                                                   │
│  ┌─────────────────────────┐                                    │
│  │  InferencePresetEntity  │                                    │
│  │  (EF Core Entity)       │                                    │
│  ├─────────────────────────┤                                    │
│  │ All fields flattened    │                                    │
│  │ (no nested object)      │                                    │
│  │ + UsageCount: int       │                                    │
│  └─────────────────────────┘                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Built-in Presets

```
┌─────────────────────────────────────────────────────────────────┐
│                     Built-in Presets                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐    │
│  │  Precise   │ │  Balanced  │ │  Creative  │ │ Long-form  │    │
│  ├────────────┤ ├────────────┤ ├────────────┤ ├────────────┤    │
│  │ Temp: 0.2  │ │ Temp: 0.7  │ │ Temp: 1.2  │ │ Temp: 0.7  │    │
│  │ TopP: 0.8  │ │ TopP: 0.9  │ │ TopP: 0.95 │ │ TopP: 0.9  │    │
│  │ Max: 1024  │ │ Max: 2048  │ │ Max: 4096  │ │ Max: 8192  │    │
│  │ Ctx: 4096  │ │ Ctx: 4096  │ │ Ctx: 8192  │ │ Ctx: 16384 │    │
│  │ Rep: 1.1   │ │ Rep: 1.1   │ │ Rep: 1.05  │ │ Rep: 1.15  │    │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘    │
│                     ▲                                            │
│                     │ DEFAULT                                    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Code Review: Temp 0.3, TopP 0.85, Max 2048, Ctx 8192       │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Models/
│   ├── InferenceOptions.cs                           (NEW)
│   └── InferencePreset.cs                            (NEW)
├── Entities/
│   └── InferencePresetEntity.cs                      (UPDATE)
├── ParameterConstants.cs                             (NEW)
└── ValidationResult.cs                               (NEW)

src/SeniorIntern.Data/
├── Repositories/
│   ├── IInferencePresetRepository.cs                 (NEW)
│   └── InferencePresetRepository.cs                  (NEW)
└── Configurations/
    └── InferencePresetConfiguration.cs               (UPDATE)
```

---

## Implementation Details

### Task 1: Create InferenceOptions Model

**File:** `src/SeniorIntern.Core/Models/InferenceOptions.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Options for LLM inference.
/// </summary>
public sealed class InferenceOptions
{
    /// <summary>Controls randomness (0.0-2.0). Lower = deterministic.</summary>
    public float Temperature { get; set; } = 0.7f;

    /// <summary>Nucleus sampling threshold (0.0-1.0).</summary>
    public float TopP { get; set; } = 0.9f;

    /// <summary>Maximum tokens to generate (64-8192).</summary>
    public int MaxTokens { get; set; } = 2048;

    /// <summary>Context window size (512-32768).</summary>
    public uint ContextSize { get; set; } = 4096;

    /// <summary>Repetition penalty (1.0-2.0). 1.0 = none.</summary>
    public float RepetitionPenalty { get; set; } = 1.1f;

    /// <summary>Top-K sampling (0-100). 0 = disabled.</summary>
    public int TopK { get; set; } = 40;

    /// <summary>Random seed. -1 = random each time.</summary>
    public int Seed { get; set; } = -1;

    /// <summary>Creates a deep copy.</summary>
    public InferenceOptions Clone() => new()
    {
        Temperature = Temperature,
        TopP = TopP,
        MaxTokens = MaxTokens,
        ContextSize = ContextSize,
        RepetitionPenalty = RepetitionPenalty,
        TopK = TopK,
        Seed = Seed
    };

    /// <summary>Validates all values are within ranges.</summary>
    public ValidationResult Validate()
    {
        var errors = new List<string>();

        if (Temperature < 0f || Temperature > 2f)
            errors.Add("Temperature must be between 0.0 and 2.0");
        if (TopP < 0f || TopP > 1f)
            errors.Add("Top-P must be between 0.0 and 1.0");
        if (MaxTokens < 64 || MaxTokens > 8192)
            errors.Add("Max Tokens must be between 64 and 8192");
        if (ContextSize < 512 || ContextSize > 32768)
            errors.Add("Context Size must be between 512 and 32768");
        if (RepetitionPenalty < 1f || RepetitionPenalty > 2f)
            errors.Add("Repetition Penalty must be between 1.0 and 2.0");
        if (TopK < 0 || TopK > 100)
            errors.Add("Top-K must be between 0 and 100");

        return new ValidationResult(errors.Count == 0, errors);
    }
}

/// <summary>Result of validation.</summary>
public sealed record ValidationResult(bool IsValid, IReadOnlyList<string> Errors);
```

---

### Task 2: Create InferencePreset Model

**File:** `src/SeniorIntern.Core/Models/InferencePreset.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// A named preset of inference options.
/// </summary>
public sealed class InferencePreset
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Category { get; set; }
    public bool IsBuiltIn { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public InferenceOptions Options { get; set; } = new();

    /// <summary>Creates a preset from options.</summary>
    public static InferencePreset FromOptions(string name, InferenceOptions options) => new()
    {
        Name = name,
        Options = options.Clone()
    };
}
```

---

### Task 3: Create ParameterConstants

**File:** `src/SeniorIntern.Core/ParameterConstants.cs`

```csharp
namespace SeniorIntern.Core;

/// <summary>Constants for inference parameters.</summary>
public static class ParameterConstants
{
    public static class Temperature
    {
        public const float Min = 0.0f, Max = 2.0f, Default = 0.7f, Step = 0.1f;
    }

    public static class TopP
    {
        public const float Min = 0.0f, Max = 1.0f, Default = 0.9f, Step = 0.05f;
    }

    public static class MaxTokens
    {
        public const int Min = 64, Max = 8192, Default = 2048, Step = 64;
    }

    public static class ContextSize
    {
        public const uint Min = 512, Max = 32768, Default = 4096, Step = 512;
    }

    public static class RepetitionPenalty
    {
        public const float Min = 1.0f, Max = 2.0f, Default = 1.1f, Step = 0.05f;
    }

    public static class TopK
    {
        public const int Min = 0, Max = 100, Default = 40, Step = 5;
    }
}
```

---

### Task 4: Update InferencePresetEntity

**File:** `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>Entity for inference presets.</summary>
public sealed class InferencePresetEntity
{
    public Guid Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Category { get; set; }

    // Parameters (flattened)
    public float Temperature { get; set; } = 0.7f;
    public float TopP { get; set; } = 0.9f;
    public int MaxTokens { get; set; } = 2048;
    public uint ContextSize { get; set; } = 4096;
    public float RepetitionPenalty { get; set; } = 1.1f;
    public int TopK { get; set; } = 40;
    public int Seed { get; set; } = -1;

    // Metadata
    public bool IsBuiltIn { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public int UsageCount { get; set; }
}
```

---

### Task 5: Create IInferencePresetRepository

**File:** `src/SeniorIntern.Data/Repositories/IInferencePresetRepository.cs`

```csharp
namespace SeniorIntern.Data.Repositories;

using SeniorIntern.Core.Entities;

/// <summary>Repository for inference presets.</summary>
public interface IInferencePresetRepository
{
    Task<IReadOnlyList<InferencePresetEntity>> GetAllAsync(CancellationToken ct = default);
    Task<InferencePresetEntity?> GetByIdAsync(Guid id, CancellationToken ct = default);
    Task<InferencePresetEntity?> GetByNameAsync(string name, CancellationToken ct = default);
    Task<InferencePresetEntity?> GetDefaultAsync(CancellationToken ct = default);
    Task<IReadOnlyList<InferencePresetEntity>> GetByCategoryAsync(string category, CancellationToken ct = default);
    Task<InferencePresetEntity> CreateAsync(InferencePresetEntity preset, CancellationToken ct = default);
    Task UpdateAsync(InferencePresetEntity preset, CancellationToken ct = default);
    Task DeleteAsync(Guid id, CancellationToken ct = default);
    Task SetAsDefaultAsync(Guid id, CancellationToken ct = default);
    Task IncrementUsageAsync(Guid id, CancellationToken ct = default);
    Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default);
    Task SeedBuiltInPresetsAsync(CancellationToken ct = default);
}
```

---

### Task 6: Implement InferencePresetRepository

**File:** `src/SeniorIntern.Data/Repositories/InferencePresetRepository.cs`

Full implementation with all CRUD operations and built-in preset seeding. Key methods:

- `GetAllAsync`: Ordered by IsBuiltIn DESC, IsDefault DESC, Name ASC
- `CreateAsync/UpdateAsync/DeleteAsync`: Standard CRUD with built-in protection
- `SetAsDefaultAsync`: Clears previous default, sets new one
- `SeedBuiltInPresetsAsync`: Creates 5 built-in presets if none exist

Built-in presets use well-known GUIDs:
- Precise: `00000001-0000-0000-0000-000000000001`
- Balanced: `00000001-0000-0000-0000-000000000002` (DEFAULT)
- Creative: `00000001-0000-0000-0000-000000000003`
- Long-form: `00000001-0000-0000-0000-000000000004`
- Code Review: `00000001-0000-0000-0000-000000000005`

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| InferenceOptions | 8 | Validation, Clone, defaults |
| InferencePreset | 3 | FromOptions, properties |
| InferencePresetRepository | 12 | CRUD, seeding, constraints |
| **Total** | **23** | |

### Key Test Scenarios

```csharp
[Fact]
public void Validate_ReturnsErrors_ForOutOfRangeTemperature()
{
    var options = new InferenceOptions { Temperature = 3.0f };
    var result = options.Validate();
    Assert.False(result.IsValid);
    Assert.Contains(result.Errors, e => e.Contains("Temperature"));
}

[Fact]
public void Clone_CreatesIndependentCopy()
{
    var original = new InferenceOptions { Temperature = 1.5f };
    var clone = original.Clone();
    clone.Temperature = 0.5f;
    Assert.Equal(1.5f, original.Temperature);
}

[Fact]
public async Task DeleteAsync_ThrowsForBuiltInPreset()
{
    await _repository.SeedBuiltInPresetsAsync();
    var builtIn = await _repository.GetByNameAsync("Balanced");
    await Assert.ThrowsAsync<InvalidOperationException>(
        () => _repository.DeleteAsync(builtIn!.Id));
}

[Fact]
public async Task SeedBuiltInPresetsAsync_CreatesAllFivePresets()
{
    await _repository.SeedBuiltInPresetsAsync();
    var all = await _repository.GetAllAsync();
    Assert.Equal(5, all.Count(p => p.IsBuiltIn));
}
```

---

## Files Summary

### Files to Create (5)

| File | Lines (approx) |
|------|----------------|
| `Core/Models/InferenceOptions.cs` | 70 |
| `Core/Models/InferencePreset.cs` | 25 |
| `Core/ParameterConstants.cs` | 35 |
| `Data/Repositories/IInferencePresetRepository.cs` | 25 |
| `Data/Repositories/InferencePresetRepository.cs` | 180 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `Core/Entities/InferencePresetEntity.cs` | Add RepetitionPenalty, TopK, Seed, UsageCount |
| `Data/Configurations/InferencePresetConfiguration.cs` | Configure new columns |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | InferenceOptions has all 7 parameters with correct defaults |
| AC-2 | Validate() catches all out-of-range values |
| AC-3 | Clone() creates independent copy |
| AC-4 | InferencePreset.FromOptions() creates preset correctly |
| AC-5 | Repository CRUD operations work |
| AC-6 | Cannot delete built-in presets |
| AC-7 | Cannot modify built-in presets |
| AC-8 | SeedBuiltInPresetsAsync creates 5 presets |
| AC-9 | SetAsDefaultAsync clears previous default |
| AC-10 | "Balanced" is the default preset |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Flattened entity | Simpler EF mapping, no JSON columns |
| Well-known GUIDs for built-in | Stable references, easy testing |
| Immutable validation | Pure function, no side effects |
| UsageCount on entity | Analytics for popular presets |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.3a | 0.5 days |
