# Design Specification: The Senior Intern v0.2.2e "Polish & Edge Cases"

## Executive Summary

This document provides a detailed implementation specification for v0.2.2e, which handles edge cases, adds confirmation dialogs, implements keyboard shortcuts, and optimizes performance for large conversations. This version polishes the conversation persistence feature set, ensuring a robust, user-friendly experience.

v0.2.2e is the final polish layer that transforms the functional implementation (v0.2.2a-d) into a production-quality feature with proper safeguards and optimizations.

### v0.2.2e Scope (from v0.2.2 Design Document)

- Create `UnsavedChangesDialog` for save/discard/cancel confirmation
- Create `DeleteConfirmationDialog` for delete confirmation
- Implement comprehensive keyboard shortcuts
- Add message pagination for large conversations
- Optimize conversation loading with lazy loading support
- Integrate dialogs with ViewModels
- Add additional edge case handling

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| UnsavedChangesDialog | Three-button dialog (Save/Don't Save/Cancel) |
| DeleteConfirmationDialog | Two-button dialog (Delete/Cancel) with warning |
| Keyboard Shortcuts | Ctrl+N, Ctrl+S, Ctrl+K, Ctrl+B |
| Message Pagination | GetMessagesPagedAsync repository method |
| Lazy Loading | LoadConversationLazyAsync for large conversations |
| Dialog Integration | ViewModels updated to show dialogs |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.2e Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Polish & Edge Cases                                              │
│  ├── Confirmation Dialogs                                         │
│  │   ├── UnsavedChangesDialog                                     │
│  │   │   ├── Shows when switching with unsaved changes            │
│  │   │   ├── "Save" → Save then proceed                           │
│  │   │   ├── "Don't Save" → Discard and proceed                   │
│  │   │   └── "Cancel" → Stay on current conversation              │
│  │   │                                                            │
│  │   └── DeleteConfirmationDialog                                 │
│  │       ├── Shows before deleting conversation                   │
│  │       ├── Warning text about irreversibility                   │
│  │       ├── "Delete" (destructive styling)                       │
│  │       └── "Cancel"                                             │
│  │                                                                │
│  ├── Keyboard Shortcuts                                           │
│  │   ├── Ctrl+N → New conversation                                │
│  │   ├── Ctrl+S → Save current conversation                       │
│  │   ├── Ctrl+K → Focus search box                                │
│  │   ├── Ctrl+B → Toggle sidebar                                  │
│  │   ├── Escape → Cancel generation / Clear search                │
│  │   └── F2 → Rename selected conversation                        │
│  │                                                                │
│  ├── Performance Optimizations                                    │
│  │   ├── Message Pagination                                       │
│  │   │   ├── GetMessagesPagedAsync(conversationId, page, size)    │
│  │   │   └── Default page size: 50 messages                       │
│  │   │                                                            │
│  │   ├── Lazy Loading                                             │
│  │   │   ├── LoadConversationLazyAsync(id, initialCount)          │
│  │   │   ├── HasMoreMessages flag on Conversation                 │
│  │   │   └── LoadMoreMessagesAsync() for infinite scroll          │
│  │   │                                                            │
│  │   └── Virtualization (deferred to v0.3.0+)                     │
│  │                                                                │
│  ├── Edge Case Handling                                           │
│  │   ├── Empty conversation handling                              │
│  │   ├── Concurrent save prevention                               │
│  │   ├── Network/DB error recovery                                │
│  │   ├── Very long message handling                               │
│  │   └── Unicode/emoji in titles                                  │
│  │                                                                │
│  └── Dialog Integration                                           │
│      ├── ConversationListViewModel → Delete confirmation          │
│      ├── ChatViewModel → Unsaved changes on switch                │
│      └── MainWindow → Unsaved changes on close                    │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Dialog Flow: Unsaved Changes

```
┌─────────────────────────────────────────────────────────────────┐
│                  Unsaved Changes Dialog Flow                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User attempts action that would lose changes:                   │
│  - Switch conversation                                           │
│  - Create new conversation                                       │
│  - Close application                                             │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Check: HasUnsavedChanges == true?                         │    │
│  └──────────────┬─────────────────────────┬─────────────────┘    │
│                 │ Yes                     │ No                   │
│                 ▼                         ▼                      │
│  ┌──────────────────────────┐    ┌─────────────────────────┐     │
│  │ Show UnsavedChangesDialog│    │ Proceed with action      │     │
│  └──────────┬───────────────┘    └─────────────────────────┘     │
│             │                                                    │
│  ┌──────────┴──────────────────────────────────────────────┐     │
│  │                                                          │     │
│  │  ┌─────────────────────────────────────────────────────┐ │     │
│  │  │          "Unsaved Changes"                          │ │     │
│  │  │                                                     │ │     │
│  │  │  Save changes to "Conversation Title"?              │ │     │
│  │  │                                                     │ │     │
│  │  │              [Cancel] [Don't Save] [Save]           │ │     │
│  │  └─────────────────────────────────────────────────────┘ │     │
│  │                                                          │     │
│  └──────────┬───────────────┬───────────────┬──────────────┘     │
│             │               │               │                    │
│        "Cancel"       "Don't Save"       "Save"                  │
│             │               │               │                    │
│             ▼               ▼               ▼                    │
│  ┌────────────────┐ ┌───────────────┐ ┌──────────────────────┐   │
│  │ Abort action   │ │ Discard       │ │ SaveCurrentAsync()   │   │
│  │ Stay on        │ │ changes       │ │ then proceed         │   │
│  │ current conv   │ │ Proceed       │ │                      │   │
│  └────────────────┘ └───────────────┘ └──────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Dialog Flow: Delete Confirmation

```
┌─────────────────────────────────────────────────────────────────┐
│                  Delete Confirmation Dialog Flow                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User clicks "Delete" on conversation                            │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Show DeleteConfirmationDialog                             │    │
│  └──────────┬───────────────────────────────────────────────┘    │
│             │                                                    │
│  ┌──────────┴──────────────────────────────────────────────┐     │
│  │                                                          │     │
│  │  ┌─────────────────────────────────────────────────────┐ │     │
│  │  │          "Delete Conversation"                      │ │     │
│  │  │                                                     │ │     │
│  │  │  Are you sure you want to delete                    │ │     │
│  │  │  "Conversation Title"?                              │ │     │
│  │  │                                                     │ │     │
│  │  │  This action cannot be undone.                      │ │     │
│  │  │                                                     │ │     │
│  │  │                         [Cancel] [Delete]           │ │     │
│  │  │                                  ^^^^^^^^           │ │     │
│  │  │                               (destructive)         │ │     │
│  │  └─────────────────────────────────────────────────────┘ │     │
│  │                                                          │     │
│  └──────────┬───────────────────────────────┬──────────────┘     │
│             │                               │                    │
│         "Cancel"                        "Delete"                 │
│             │                               │                    │
│             ▼                               ▼                    │
│  ┌────────────────────────┐    ┌────────────────────────────┐    │
│  │ Abort deletion         │    │ DeleteConversationAsync()  │    │
│  │ Keep conversation      │    │ Remove from list           │    │
│  └────────────────────────┘    │ Select next/new            │    │
│                                └────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Message Pagination Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                  Message Pagination Architecture                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Conversation with 500 messages                                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                     Database                                 │ │
│  │  Messages Table (ordered by SequenceNumber)                  │ │
│  │  ┌───┬───┬───┬───┬───┬───┬─────────────────────┬───┬───┐    │ │
│  │  │ 1 │ 2 │ 3 │...│50 │51 │...                  │499│500│    │ │
│  │  └───┴───┴───┴───┴───┴───┴─────────────────────┴───┴───┘    │ │
│  │        ▲                                           ▲        │ │
│  │        │                                           │        │ │
│  │    Oldest                                      Newest       │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│       LoadConversationLazyAsync(initialCount: 50)                │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  In-Memory (Initial Load)                    │ │
│  │  50 most recent messages loaded                              │ │
│  │  ┌───────────────────────────────────────────┬───┬───┐      │ │
│  │  │ (451 messages not loaded)                 │499│500│      │ │
│  │  └───────────────────────────────────────────┴───┴───┘      │ │
│  │                                                              │ │
│  │  conversation.HasMoreMessages = true                         │ │
│  │  conversation.TotalMessageCount = 500                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│           User scrolls to top / clicks "Load More"               │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  LoadMoreMessagesAsync(page: 2)              │ │
│  │  Next 50 messages prepended                                  │ │
│  │  ┌───────────────────────────────────┬───┬───┬───┬───┐      │ │
│  │  │ (401 messages not loaded)         │451│...│499│500│      │ │
│  │  └───────────────────────────────────┴───┴───┴───┴───┘      │ │
│  │                                                              │ │
│  │  100 messages now in memory                                  │ │
│  │  conversation.HasMoreMessages = true (still 401 remaining)   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Prerequisites

Before implementing v0.2.2e, ensure:
- v0.2.2a through v0.2.2d are complete
- All conversation persistence features are working
- Solution builds successfully
- Basic conversation CRUD operations are functional

---

## Directory Structure

After v0.2.2e implementation:

```
src/SeniorIntern.Desktop/
├── SeniorIntern.Desktop.csproj
├── Dialogs/
│   ├── UnsavedChangesDialog.cs                       (NEW)
│   └── DeleteConfirmationDialog.cs                   (NEW)
├── ViewModels/
│   ├── MainWindowViewModel.cs                        (UPDATED)
│   ├── ChatViewModel.cs                              (UPDATED)
│   └── ConversationListViewModel.cs                  (UPDATED)
└── Views/
    ├── MainWindow.axaml                              (UPDATED)
    └── MainWindow.axaml.cs                           (UPDATED)

src/SeniorIntern.Core/
├── Models/
│   └── Conversation.cs                               (UPDATED - HasMoreMessages)
└── Interfaces/
    └── IConversationService.cs                       (UPDATED - LoadMoreMessagesAsync)

src/SeniorIntern.Data/
└── Repositories/
    ├── IConversationRepository.cs                    (UPDATED)
    └── ConversationRepository.cs                     (UPDATED)

src/SeniorIntern.Services/
└── DatabaseConversationService.cs                    (UPDATED)
```

---

## Implementation Details

### Task 1: Create UnsavedChangesDialog

**File:** `src/SeniorIntern.Desktop/Dialogs/UnsavedChangesDialog.cs`

Static dialog helper for unsaved changes confirmation.

```csharp
namespace SeniorIntern.Desktop.Dialogs;

using Avalonia;
using Avalonia.Controls;
using Avalonia.Layout;

/// <summary>
/// Dialog for confirming unsaved changes before navigation.
/// </summary>
public static class UnsavedChangesDialog
{
    /// <summary>
    /// Result of the unsaved changes dialog.
    /// </summary>
    public enum Result
    {
        /// <summary>Save changes and proceed.</summary>
        Save,
        /// <summary>Discard changes and proceed.</summary>
        DontSave,
        /// <summary>Cancel the action, stay on current.</summary>
        Cancel
    }

    /// <summary>
    /// Shows the unsaved changes dialog.
    /// </summary>
    /// <param name="owner">The owner window.</param>
    /// <param name="conversationTitle">The title of the conversation with unsaved changes.</param>
    /// <returns>The user's choice.</returns>
    public static async Task<Result> ShowAsync(Window owner, string conversationTitle)
    {
        var dialog = new Window
        {
            Title = "Unsaved Changes",
            Width = 420,
            Height = 160,
            WindowStartupLocation = WindowStartupLocation.CenterOwner,
            CanResize = false,
            ShowInTaskbar = false,
            SystemDecorations = SystemDecorations.BorderOnly
        };

        var result = Result.Cancel;

        var content = new StackPanel
        {
            Margin = new Thickness(24, 20),
            Spacing = 20
        };

        // Message
        var truncatedTitle = conversationTitle.Length > 40 
            ? conversationTitle[..37] + "..." 
            : conversationTitle;
        
        content.Children.Add(new TextBlock
        {
            Text = $"Save changes to \"{truncatedTitle}\"?",
            TextWrapping = Avalonia.Media.TextWrapping.Wrap,
            FontSize = 14
        });

        // Button panel
        var buttonPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            HorizontalAlignment = HorizontalAlignment.Right,
            Spacing = 8
        };

        var cancelButton = new Button 
        { 
            Content = "Cancel",
            MinWidth = 80
        };
        var dontSaveButton = new Button 
        { 
            Content = "Don't Save",
            MinWidth = 80
        };
        var saveButton = new Button 
        { 
            Content = "Save",
            MinWidth = 80,
            Classes = { "accent" }
        };

        cancelButton.Click += (s, e) => { result = Result.Cancel; dialog.Close(); };
        dontSaveButton.Click += (s, e) => { result = Result.DontSave; dialog.Close(); };
        saveButton.Click += (s, e) => { result = Result.Save; dialog.Close(); };

        buttonPanel.Children.Add(cancelButton);
        buttonPanel.Children.Add(dontSaveButton);
        buttonPanel.Children.Add(saveButton);

        content.Children.Add(buttonPanel);
        dialog.Content = content;

        // Set default focus to Save button
        dialog.Opened += (s, e) => saveButton.Focus();

        await dialog.ShowDialog(owner);
        return result;
    }
}
```

---

### Task 2: Create DeleteConfirmationDialog

**File:** `src/SeniorIntern.Desktop/Dialogs/DeleteConfirmationDialog.cs`

Static dialog helper for delete confirmation.

```csharp
namespace SeniorIntern.Desktop.Dialogs;

using Avalonia;
using Avalonia.Controls;
using Avalonia.Layout;
using Avalonia.Media;

/// <summary>
/// Dialog for confirming deletion of a conversation.
/// </summary>
public static class DeleteConfirmationDialog
{
    /// <summary>
    /// Shows the delete confirmation dialog.
    /// </summary>
    /// <param name="owner">The owner window.</param>
    /// <param name="conversationTitle">The title of the conversation to delete.</param>
    /// <returns>True if user confirmed deletion, false if cancelled.</returns>
    public static async Task<bool> ShowAsync(Window owner, string conversationTitle)
    {
        var dialog = new Window
        {
            Title = "Delete Conversation",
            Width = 420,
            Height = 180,
            WindowStartupLocation = WindowStartupLocation.CenterOwner,
            CanResize = false,
            ShowInTaskbar = false,
            SystemDecorations = SystemDecorations.BorderOnly
        };

        var confirmed = false;

        var content = new StackPanel
        {
            Margin = new Thickness(24, 20),
            Spacing = 16
        };

        // Title text
        var truncatedTitle = conversationTitle.Length > 40 
            ? conversationTitle[..37] + "..." 
            : conversationTitle;

        content.Children.Add(new TextBlock
        {
            Text = $"Are you sure you want to delete \"{truncatedTitle}\"?",
            TextWrapping = Avalonia.Media.TextWrapping.Wrap,
            FontSize = 14
        });

        // Warning text
        content.Children.Add(new TextBlock
        {
            Text = "This action cannot be undone.",
            FontSize = 12,
            Foreground = new SolidColorBrush(Color.Parse("#FF6B6B")) // Error color
        });

        // Button panel
        var buttonPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            HorizontalAlignment = HorizontalAlignment.Right,
            Spacing = 8
        };

        var cancelButton = new Button 
        { 
            Content = "Cancel",
            MinWidth = 80
        };
        var deleteButton = new Button 
        { 
            Content = "Delete",
            MinWidth = 80,
            Classes = { "destructive" }
        };

        cancelButton.Click += (s, e) => { confirmed = false; dialog.Close(); };
        deleteButton.Click += (s, e) => { confirmed = true; dialog.Close(); };

        buttonPanel.Children.Add(cancelButton);
        buttonPanel.Children.Add(deleteButton);

        content.Children.Add(buttonPanel);
        dialog.Content = content;

        // Set default focus to Cancel button (safer default)
        dialog.Opened += (s, e) => cancelButton.Focus();

        await dialog.ShowDialog(owner);
        return confirmed;
    }
}
```

---

### Task 3: Add Message Pagination to Repository

**File:** `src/SeniorIntern.Data/Repositories/IConversationRepository.cs` (add to existing)

```csharp
/// <summary>
/// Gets messages with pagination support.
/// </summary>
/// <param name="conversationId">The conversation ID.</param>
/// <param name="pageNumber">The page number (1-indexed).</param>
/// <param name="pageSize">Number of messages per page.</param>
/// <param name="ct">Cancellation token.</param>
/// <returns>Messages for the requested page, ordered by sequence number.</returns>
Task<IReadOnlyList<MessageEntity>> GetMessagesPagedAsync(
    Guid conversationId,
    int pageNumber,
    int pageSize = 50,
    CancellationToken ct = default);

/// <summary>
/// Gets the total message count for a conversation.
/// </summary>
Task<int> GetMessageCountAsync(Guid conversationId, CancellationToken ct = default);
```

**File:** `src/SeniorIntern.Data/Repositories/ConversationRepository.cs` (add implementation)

```csharp
/// <inheritdoc />
public async Task<IReadOnlyList<MessageEntity>> GetMessagesPagedAsync(
    Guid conversationId,
    int pageNumber,
    int pageSize = 50,
    CancellationToken ct = default)
{
    ArgumentOutOfRangeException.ThrowIfLessThan(pageNumber, 1);
    ArgumentOutOfRangeException.ThrowIfLessThan(pageSize, 1);
    ArgumentOutOfRangeException.ThrowIfGreaterThan(pageSize, 200);

    // Get messages from the end (most recent), then reverse for display
    return await _context.Messages
        .AsNoTracking()
        .Where(m => m.ConversationId == conversationId)
        .OrderByDescending(m => m.SequenceNumber) // Most recent first for pagination
        .Skip((pageNumber - 1) * pageSize)
        .Take(pageSize)
        .OrderBy(m => m.SequenceNumber) // Re-order for display
        .ToListAsync(ct);
}

/// <inheritdoc />
public async Task<int> GetMessageCountAsync(Guid conversationId, CancellationToken ct = default)
{
    return await _context.Messages
        .CountAsync(m => m.ConversationId == conversationId, ct);
}
```

---

### Task 4: Add Lazy Loading to Conversation Model

**File:** `src/SeniorIntern.Core/Models/Conversation.cs` (add properties)

```csharp
#region Lazy Loading Support

/// <summary>
/// Gets or sets whether there are more messages to load.
/// </summary>
/// <remarks>
/// True if the conversation has more messages than currently loaded.
/// Used for infinite scroll / "Load More" functionality.
/// </remarks>
public bool HasMoreMessages { get; set; }

/// <summary>
/// Gets or sets the total message count (including not-yet-loaded).
/// </summary>
public int TotalMessageCount { get; set; }

/// <summary>
/// Gets the number of currently loaded messages.
/// </summary>
public int LoadedMessageCount => Messages.Count;

#endregion
```

---

### Task 5: Add Lazy Loading to Service Interface

**File:** `src/SeniorIntern.Core/Interfaces/IConversationService.cs` (add methods)

```csharp
/// <summary>
/// Loads a conversation with only the most recent messages.
/// </summary>
/// <param name="conversationId">The conversation ID.</param>
/// <param name="initialMessageCount">Number of messages to load initially.</param>
/// <param name="ct">Cancellation token.</param>
Task<Conversation> LoadConversationLazyAsync(
    Guid conversationId,
    int initialMessageCount = 50,
    CancellationToken ct = default);

/// <summary>
/// Loads additional older messages for the current conversation.
/// </summary>
/// <param name="count">Number of additional messages to load.</param>
/// <param name="ct">Cancellation token.</param>
/// <returns>True if more messages were loaded, false if no more exist.</returns>
Task<bool> LoadMoreMessagesAsync(int count = 50, CancellationToken ct = default);
```

---

### Task 6: Implement Lazy Loading in Service

**File:** `src/SeniorIntern.Services/DatabaseConversationService.cs` (add implementation)

```csharp
private int _currentPage = 1;

/// <inheritdoc />
public async Task<Conversation> LoadConversationLazyAsync(
    Guid conversationId,
    int initialMessageCount = 50,
    CancellationToken ct = default)
{
    // Save current if dirty
    if (_currentConversation.HasUnsavedChanges && 
        _currentConversation.Messages.Count > 0)
    {
        await SaveCurrentConversationAsync(ct);
    }

    _logger.LogDebug("Lazy loading conversation {ConversationId}", conversationId);

    // Load conversation without messages
    var entity = await _repository.GetByIdAsync(conversationId, ct);
    if (entity == null)
    {
        throw new InvalidOperationException($"Conversation {conversationId} not found");
    }

    var conversation = MapToDomainWithoutMessages(entity);

    // Get total count
    conversation.TotalMessageCount = await _repository.GetMessageCountAsync(conversationId, ct);

    // Load only recent messages (page 1)
    _currentPage = 1;
    var recentMessages = await _repository.GetMessagesPagedAsync(
        conversationId, 1, initialMessageCount, ct);

    conversation.LoadMessages(recentMessages.Select(MapMessageToDomain));
    conversation.HasMoreMessages = conversation.TotalMessageCount > initialMessageCount;

    _currentConversation = conversation;
    OnConversationChanged(ConversationChangeType.Loaded);

    return conversation;
}

/// <inheritdoc />
public async Task<bool> LoadMoreMessagesAsync(int count = 50, CancellationToken ct = default)
{
    if (!_currentConversation.HasMoreMessages)
    {
        return false;
    }

    _logger.LogDebug("Loading more messages for {ConversationId}, page {Page}",
        _currentConversation.Id, _currentPage + 1);

    _currentPage++;
    var olderMessages = await _repository.GetMessagesPagedAsync(
        _currentConversation.Id, _currentPage, count, ct);

    if (!olderMessages.Any())
    {
        _currentConversation.HasMoreMessages = false;
        return false;
    }

    // Prepend older messages
    var allMessages = olderMessages.Select(MapMessageToDomain)
        .Concat(_currentConversation.Messages)
        .ToList();

    _currentConversation.LoadMessages(allMessages);
    _currentConversation.HasMoreMessages = 
        _currentConversation.LoadedMessageCount < _currentConversation.TotalMessageCount;

    OnConversationChanged(ConversationChangeType.MessagesLoaded);

    return true;
}

private Conversation MapToDomainWithoutMessages(ConversationEntity entity)
{
    return new Conversation
    {
        Id = entity.Id,
        Title = entity.Title,
        CreatedAt = entity.CreatedAt,
        UpdatedAt = entity.UpdatedAt,
        SystemPromptId = entity.SystemPromptId,
        SystemPromptName = entity.SystemPrompt?.Name,
        ModelPath = entity.ModelPath,
        ModelName = entity.ModelName,
        IsArchived = entity.IsArchived,
        IsPinned = entity.IsPinned,
        IsPersisted = true,
        HasUnsavedChanges = false
    };
}
```

---

### Task 7: Integrate Dialogs into ConversationListViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/ConversationListViewModel.cs` (update delete command)

```csharp
// Add field for window access
private Func<Window>? _getOwnerWindow;

/// <summary>
/// Sets the owner window provider for dialog display.
/// </summary>
public void SetOwnerWindowProvider(Func<Window> provider)
{
    _getOwnerWindow = provider;
}

/// <summary>Deletes a conversation with confirmation.</summary>
[RelayCommand]
private async Task DeleteConversationAsync(ConversationSummaryViewModel summary)
{
    // Show confirmation dialog
    var owner = _getOwnerWindow?.Invoke();
    if (owner != null)
    {
        var confirmed = await DeleteConfirmationDialog.ShowAsync(owner, summary.Title);
        if (!confirmed)
        {
            return;
        }
    }

    try
    {
        await _conversationService.DeleteConversationAsync(summary.Id);
    }
    catch (Exception ex)
    {
        ErrorMessage = $"Failed to delete conversation: {ex.Message}";
    }
}
```

---

### Task 8: Add Keyboard Shortcuts to MainWindow

**File:** `src/SeniorIntern.Desktop/Views/MainWindow.axaml.cs` (update OnKeyDown)

```csharp
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;
using Avalonia.Input;
using SeniorIntern.Desktop.Dialogs;
using SeniorIntern.Desktop.ViewModels;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }

    private MainWindowViewModel? ViewModel => DataContext as MainWindowViewModel;

    protected override async void OnOpened(EventArgs e)
    {
        base.OnOpened(e);
        
        // Set up owner window provider for dialogs
        if (ViewModel?.ConversationListViewModel != null)
        {
            ViewModel.ConversationListViewModel.SetOwnerWindowProvider(() => this);
        }

        await InitializeAsync();
    }

    private async Task InitializeAsync()
    {
        if (ViewModel != null)
        {
            await ViewModel.InitializeAsync();
        }
    }

    /// <summary>
    /// Handles global keyboard shortcuts.
    /// </summary>
    protected override void OnKeyDown(KeyEventArgs e)
    {
        base.OnKeyDown(e);

        if (e.KeyModifiers == KeyModifiers.Control)
        {
            switch (e.Key)
            {
                case Key.N:
                    // New conversation
                    ViewModel?.ConversationListViewModel.CreateNewConversationCommand.Execute(null);
                    e.Handled = true;
                    break;

                case Key.S:
                    // Save current conversation
                    _ = ViewModel?.ChatViewModel.SaveCommand?.ExecuteAsync(null);
                    e.Handled = true;
                    break;

                case Key.K:
                    // Focus search (requires element reference)
                    FocusSearchBox();
                    e.Handled = true;
                    break;

                case Key.B:
                    // Toggle sidebar
                    ViewModel?.ToggleSidebarCommand.Execute(null);
                    e.Handled = true;
                    break;
            }
        }
        else if (e.Key == Key.F2)
        {
            // Rename selected conversation
            var selected = ViewModel?.ConversationListViewModel.SelectedConversation;
            if (selected != null)
            {
                ViewModel?.ConversationListViewModel.RenameConversationCommand.Execute(selected);
                e.Handled = true;
            }
        }
    }

    /// <summary>
    /// Handles window closing with unsaved changes check.
    /// </summary>
    protected override async void OnClosing(WindowClosingEventArgs e)
    {
        if (ViewModel?.ChatViewModel.HasUnsavedChanges == true)
        {
            e.Cancel = true; // Prevent immediate close

            var result = await UnsavedChangesDialog.ShowAsync(
                this,
                ViewModel.ChatViewModel.ConversationTitle);

            switch (result)
            {
                case UnsavedChangesDialog.Result.Save:
                    await ViewModel.ChatViewModel.SaveCommand?.ExecuteAsync(null)!;
                    Close(); // Now close
                    break;

                case UnsavedChangesDialog.Result.DontSave:
                    // Force close without saving
                    ViewModel.ChatViewModel.HasUnsavedChanges = false;
                    Close();
                    break;

                case UnsavedChangesDialog.Result.Cancel:
                    // Stay open - cancel was already set
                    break;
            }
        }

        base.OnClosing(e);
    }

    private void FocusSearchBox()
    {
        // Find the search TextBox in ConversationListView
        // This requires the search box to have x:Name="SearchBox"
        var searchBox = this.FindControl<TextBox>("SearchBox");
        searchBox?.Focus();
    }
}
```

---

### Task 9: Add Save Command to ChatViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/ChatViewModel.cs` (add command)

```csharp
/// <summary>Saves the current conversation explicitly.</summary>
[RelayCommand]
private async Task SaveAsync()
{
    if (!HasUnsavedChanges)
    {
        return;
    }

    try
    {
        await _conversationService.SaveCurrentConversationAsync();
    }
    catch (Exception ex)
    {
        // Error will be surfaced via SaveStateChanged event
        _logger.LogError(ex, "Failed to save conversation");
    }
}
```

---

### Task 10: Add Destructive Button Style

**File:** `src/SeniorIntern.Desktop/Themes/Dark.axaml` (append)

```xml
<!-- Destructive Button (for delete actions) -->
<Style Selector="Button.destructive">
    <Setter Property="Background" Value="#DC3545" />
    <Setter Property="Foreground" Value="White" />
</Style>

<Style Selector="Button.destructive:pointerover">
    <Setter Property="Background" Value="#C82333" />
</Style>

<Style Selector="Button.destructive:pressed">
    <Setter Property="Background" Value="#BD2130" />
</Style>
```

---

## Logging Specifications

### Log Levels by Operation

| Level | Operations |
|-------|------------|
| Debug | Dialog shown, dialog result, lazy load requests |
| Information | User confirmed delete, keyboard shortcut used |
| Warning | Dialog cancelled |
| Error | Failed operations after confirmation |

### Logging Examples

```csharp
_logger.LogDebug("Showing delete confirmation for {Title}", title);
_logger.LogInformation("User confirmed deletion of {ConversationId}", id);
_logger.LogDebug("Lazy loading conversation {Id}, initial {Count} messages", id, count);
_logger.LogDebug("Loaded page {Page} of messages for {Id}", page, id);
```

---

## Unit Testing Requirements

### Test Summary

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| UnsavedChangesDialog | 3 | Result enum values, display |
| DeleteConfirmationDialog | 2 | Confirm/cancel results |
| Message Pagination | 6 | Paging, ordering, edge cases |
| Lazy Loading | 5 | Initial load, load more, boundaries |
| Keyboard Shortcuts | 4 | Ctrl+N/S/K/B, F2 |
| **Total** | **20** | |

### Key Test Scenarios

```csharp
// Pagination Tests
[Fact]
public async Task GetMessagesPagedAsync_ReturnsCorrectPage()
{
    // Arrange: Create conversation with 100 messages
    var conversationId = await CreateConversationWithMessages(100);
    var repo = CreateRepository();
    
    // Act: Get page 2 (messages 51-100 in reverse = messages 1-50)
    var page2 = await repo.GetMessagesPagedAsync(conversationId, 2, 50);
    
    // Assert
    Assert.Equal(50, page2.Count);
    Assert.Equal(1, page2.First().SequenceNumber); // Oldest messages
}

[Fact]
public async Task GetMessagesPagedAsync_ReturnsInDisplayOrder()
{
    var conversationId = await CreateConversationWithMessages(20);
    var repo = CreateRepository();
    
    var messages = await repo.GetMessagesPagedAsync(conversationId, 1, 10);
    
    // Should be ordered by sequence number (ascending) for display
    Assert.True(messages.Zip(messages.Skip(1))
        .All(pair => pair.First.SequenceNumber < pair.Second.SequenceNumber));
}

// Lazy Loading Tests
[Fact]
public async Task LoadConversationLazyAsync_SetsHasMoreMessages()
{
    // Arrange: Create conversation with 100 messages
    var conversationId = await CreateConversationWithMessages(100);
    var service = CreateService();
    
    // Act: Load with only 50 messages
    var conv = await service.LoadConversationLazyAsync(conversationId, 50);
    
    // Assert
    Assert.True(conv.HasMoreMessages);
    Assert.Equal(100, conv.TotalMessageCount);
    Assert.Equal(50, conv.LoadedMessageCount);
}

[Fact]
public async Task LoadMoreMessagesAsync_PrependsOlderMessages()
{
    var conversationId = await CreateConversationWithMessages(100);
    var service = CreateService();
    await service.LoadConversationLazyAsync(conversationId, 50);
    
    var firstMessageBefore = service.CurrentConversation.Messages.First();
    
    await service.LoadMoreMessagesAsync(50);
    
    var firstMessageAfter = service.CurrentConversation.Messages.First();
    
    // First message should now be older
    Assert.True(firstMessageAfter.SequenceNumber < firstMessageBefore.SequenceNumber);
}

[Fact]
public async Task LoadMoreMessagesAsync_ReturnsFalse_WhenNoMoreMessages()
{
    var conversationId = await CreateConversationWithMessages(30);
    var service = CreateService();
    await service.LoadConversationLazyAsync(conversationId, 50); // All loaded
    
    var result = await service.LoadMoreMessagesAsync(50);
    
    Assert.False(result);
    Assert.False(service.CurrentConversation.HasMoreMessages);
}

// Keyboard Shortcut Tests (integration)
[AvaloniaFact]
public void CtrlN_CreatesNewConversation()
{
    var vm = CreateMockMainWindowViewModel();
    var window = new MainWindow { DataContext = vm };
    
    // Simulate Ctrl+N
    window.RaiseEvent(new KeyEventArgs 
    { 
        Key = Key.N, 
        KeyModifiers = KeyModifiers.Control 
    });
    
    vm.ConversationListViewModel.CreateNewConversationCommand
        .Verify(c => c.Execute(null), Times.Once);
}
```

---

## Use Cases

### UC-001: Unsaved Changes on Close

| Attribute | Value |
|-----------|-------|
| **Actor** | User |
| **Trigger** | User closes application with unsaved changes |
| **Success Scenario** | Dialog shown, user can save/discard/cancel |
| **Postcondition** | Changes saved or discarded per user choice |

#### Flow
1. User clicks window close button
2. System detects HasUnsavedChanges == true
3. UnsavedChangesDialog appears
4. User clicks "Save" → changes saved, app closes
5. Or user clicks "Don't Save" → changes discarded, app closes
6. Or user clicks "Cancel" → app stays open

---

### UC-002: Delete Conversation with Confirmation

| Attribute | Value |
|-----------|-------|
| **Actor** | User |
| **Trigger** | User clicks "Delete" on conversation |
| **Success Scenario** | Confirmation shown, deletion requires explicit confirm |
| **Postcondition** | Conversation deleted only if confirmed |

---

### UC-003: Load More Messages (Lazy Loading)

| Attribute | Value |
|-----------|-------|
| **Actor** | User |
| **Trigger** | User scrolls to top of long conversation |
| **Success Scenario** | Additional older messages load |
| **Postcondition** | More messages visible, HasMoreMessages updated |

---

### UC-004: Keyboard Shortcut New Conversation

| Attribute | Value |
|-----------|-------|
| **Actor** | User |
| **Trigger** | User presses Ctrl+N |
| **Success Scenario** | New conversation created |
| **Postcondition** | Empty conversation ready for input |

---

## Deliverable Checklist

### New Files
- [ ] Dialogs/UnsavedChangesDialog.cs
- [ ] Dialogs/DeleteConfirmationDialog.cs

### Modified Files
- [ ] Core/Models/Conversation.cs (lazy loading properties)
- [ ] Core/Interfaces/IConversationService.cs (lazy loading methods)
- [ ] Data/Repositories/IConversationRepository.cs (pagination)
- [ ] Data/Repositories/ConversationRepository.cs (pagination impl)
- [ ] Services/DatabaseConversationService.cs (lazy loading impl)
- [ ] Desktop/ViewModels/ConversationListViewModel.cs (dialog integration)
- [ ] Desktop/ViewModels/ChatViewModel.cs (save command)
- [ ] Desktop/Views/MainWindow.axaml.cs (keyboard shortcuts, close handling)
- [ ] Desktop/Themes/Dark.axaml (destructive button style)

### Tests
- [ ] Pagination tests
- [ ] Lazy loading tests
- [ ] Dialog integration tests

---

## Files Summary

### Files to Create (2)

| File | Purpose | Lines (approx) |
|------|---------|----------------|
| `Dialogs/UnsavedChangesDialog.cs` | Unsaved changes confirmation | 85 |
| `Dialogs/DeleteConfirmationDialog.cs` | Delete confirmation | 80 |

### Files to Modify (9)

| File | Changes |
|------|---------|
| `Core/Models/Conversation.cs` | Add HasMoreMessages, TotalMessageCount |
| `Core/Interfaces/IConversationService.cs` | Add LoadConversationLazyAsync, LoadMoreMessagesAsync |
| `Data/Repositories/IConversationRepository.cs` | Add GetMessagesPagedAsync, GetMessageCountAsync |
| `Data/Repositories/ConversationRepository.cs` | Implement pagination methods |
| `Services/DatabaseConversationService.cs` | Implement lazy loading methods |
| `Desktop/ViewModels/ConversationListViewModel.cs` | Add dialog integration |
| `Desktop/ViewModels/ChatViewModel.cs` | Add SaveCommand |
| `Desktop/Views/MainWindow.axaml.cs` | Add keyboard shortcuts, close handling |
| `Desktop/Themes/Dark.axaml` | Add destructive button style |

---

## Verification Steps

### Step 1: Verify Compilation

```bash
dotnet build
```

### Step 2: Run Unit Tests

```bash
dotnet test
```

### Step 3: Manual Testing

1. **Unsaved Changes Dialog:**
   - Type a message but don't send
   - Try to switch conversation → dialog should appear
   - Close app with unsaved changes → dialog should appear

2. **Delete Confirmation:**
   - Right-click conversation → Delete
   - Confirm dialog appears with "cannot be undone" warning
   - Cancel and verify conversation remains
   - Delete and verify conversation removed

3. **Keyboard Shortcuts:**
   - Ctrl+N → new conversation
   - Ctrl+S → save (check for saved indicator)
   - Ctrl+B → toggle sidebar
   - Ctrl+K → focus search
   - F2 → rename selected

4. **Large Conversation (Lazy Loading):**
   - Create conversation with 100+ messages
   - Reload app
   - Verify only recent messages load initially
   - Scroll to top → verify "Load More" or auto-load works

---

## Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | Unsaved dialog has 3 buttons | Save, Don't Save, Cancel visible |
| AC-2 | Delete dialog warns about irreversibility | Warning text visible |
| AC-3 | Ctrl+N creates new conversation | Keyboard shortcut works |
| AC-4 | Ctrl+S saves current conversation | Keyboard shortcut works |
| AC-5 | Ctrl+B toggles sidebar | Keyboard shortcut works |
| AC-6 | Ctrl+K focuses search | Keyboard shortcut works |
| AC-7 | F2 renames selected conversation | Keyboard shortcut works |
| AC-8 | Pagination returns correct messages | Tests pass |
| AC-9 | Lazy loading sets HasMoreMessages | Flag correctly set |
| AC-10 | LoadMoreMessages prepends messages | Order is correct |
| AC-11 | Close app with unsaved shows dialog | Dialog appears |
| AC-12 | Delete requires confirmation | Dialog appears |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Dialog not displaying | Low | High | Test on all platforms |
| Focus issues in dialogs | Medium | Low | Set explicit focus in Opened event |
| Pagination off-by-one | Low | Medium | Unit tests with edge cases |
| Keyboard shortcut conflicts | Low | Low | Use standard shortcuts |

---

## Design Decisions

### Decision 1: Static Dialog Helpers

**Decision:** Implement dialogs as static helper classes, not Window subclasses.
**Rationale:** Simpler API, no need for DI, easy to use from any ViewModel.

### Decision 2: Page Size of 50

**Decision:** Default page size of 50 messages.
**Rationale:** Balance between memory usage and UX (not too many load requests).

### Decision 3: Lazy Loading Optional

**Decision:** Keep LoadConversationAsync for full load, add LoadConversationLazyAsync.
**Rationale:** Small conversations don't need lazy loading overhead.

### Decision 4: Prepend for Load More

**Decision:** Prepend older messages rather than append.
**Rationale:** Maintains scroll position, older messages at top.

### Decision 5: Cancel as Default Focus

**Decision:** Focus Cancel button on delete dialog, Save on unsaved dialog.
**Rationale:** Safer defaults - prevent accidental data loss.

---

## Future Considerations

| Item | Target Version | Rationale |
|------|----------------|-----------|
| Virtualization for chat messages | v0.3.0+ | Better performance for very long conversations |
| Infinite scroll trigger | v0.3.0+ | Auto-load instead of button |
| Export conversation | v0.3.0+ | User-requested export to markdown/JSON |
| Undo delete (soft delete) | v0.4.0+ | Allow recovery of deleted conversations |

---

## Timeline Estimate

| Version | Estimated Effort | Key Deliverables |
|---------|------------------|------------------|
| v0.2.2e | 1-2 days | Dialogs, keyboard shortcuts, pagination, lazy loading |

---

## References

- [Avalonia Dialog Windows](https://docs.avaloniaui.net/docs/controls/window)
- [Avalonia KeyBindings](https://docs.avaloniaui.net/docs/input/keybindings)
- [EF Core Skip/Take Pagination](https://learn.microsoft.com/en-us/ef/core/querying/pagination)
- [Infinite Scroll Pattern](https://www.nngroup.com/articles/infinite-scrolling/)
