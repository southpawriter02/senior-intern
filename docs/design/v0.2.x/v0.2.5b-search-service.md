# Design Specification: AIntern v0.2.5b "Search Service"

## Executive Summary

This document provides a detailed implementation specification for v0.2.5b, which implements the search service layer using FTS5 queries. The `SearchService` executes full-text searches with BM25 ranking, generates highlighted snippets, tracks recent searches for suggestions, and provides index maintenance capabilities.

### v0.2.5b Scope (from v0.2.5 Design Document)

- Create `ISearchService` interface
- Implement `SearchService` with FTS5 queries
- Implement BM25 ranking for relevance
- Generate snippets with `<mark>` highlighting
- Sanitize user queries for FTS5 safety
- Track recent searches for suggestions
- Provide index rebuild capability

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ISearchService | Service interface |
| SearchService | Full implementation |
| FTS5 Query Builder | Sanitization and term processing |
| Snippet Generation | Highlight matching terms |
| Suggestion Tracking | Recent search memory |
| Index Rebuild | Maintenance capability |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.5b Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ISearchService                                                   │
│  ├── SearchAsync(SearchQuery) → SearchResults                     │
│  │   ├── Searches ConversationsFts                                │
│  │   ├── Searches MessagesFts                                     │
│  │   ├── Returns grouped results                                  │
│  │   └── Measures search duration                                 │
│  │                                                                │
│  ├── RebuildIndexAsync() → void                                   │
│  │   └── Rebuilds FTS5 indexes for maintenance                    │
│  │                                                                │
│  └── GetSuggestionsAsync(prefix) → List<string>                   │
│      └── Returns recent searches matching prefix                  │
│                                                                   │
│  SearchService (Implementation)                                   │
│  ├── Dependencies                                                 │
│  │   ├── SeniorInternDbContext                                    │
│  │   └── ILogger<SearchService>                                   │
│  │                                                                │
│  ├── Core Methods                                                 │
│  │   ├── SearchConversationsAsync()                               │
│  │   │   ├── FTS5 MATCH query                                     │
│  │   │   ├── bm25() for ranking                                   │
│  │   │   └── snippet() for highlighting                           │
│  │   │                                                            │
│  │   └── SearchMessagesAsync()                                    │
│  │       ├── FTS5 MATCH query                                     │
│  │       ├── JOIN to Conversations for context                    │
│  │       └── snippet() for highlighting                           │
│  │                                                                │
│  ├── Utility Methods                                              │
│  │   ├── SanitizeFtsQuery(text) → safe FTS5 query                 │
│  │   ├── StripHtmlTags(html) → plain text                         │
│  │   ├── TruncateContent(text, max) → shortened text              │
│  │   └── TrackRecentSearch(query) → updates cache                 │
│  │                                                                │
│  └── State                                                        │
│      └── _recentSearches (List<string>, max 20)                   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Search Service Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   Search Service Data Flow                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SearchViewModel                                                 │
│        │                                                         │
│        ▼                                                         │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SearchQuery { Text="database error", MaxResults=50 }      │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SearchService.SearchAsync(query)                          │    │
│  │                                                           │    │
│  │  1. Validate query                                        │    │
│  │  2. SanitizeFtsQuery() → "\"database\"* \"error\"*"       │    │
│  │  3. TrackRecentSearch("database error")                   │    │
│  │  4. Execute parallel FTS5 queries                         │    │
│  │  5. Measure duration                                      │    │
│  │  6. Return grouped results                                │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│            ┌─────────────────┴─────────────────┐                 │
│            ▼                                   ▼                 │
│  ┌────────────────────────┐      ┌────────────────────────┐      │
│  │ SearchConversationsAsync│     │ SearchMessagesAsync    │      │
│  │                        │      │                        │      │
│  │ SELECT                 │      │ SELECT                 │      │
│  │   c.Id, c.Title,       │      │   m.Id, m.Content,     │      │
│  │   snippet(...),        │      │   snippet(...),        │      │
│  │   bm25(...)           │       │   bm25(...),           │      │
│  │ FROM ConversationsFts  │      │   c.Title              │      │
│  │ INNER JOIN Conversations│     │ FROM MessagesFts       │      │
│  │ WHERE MATCH query      │      │ INNER JOIN Messages    │      │
│  │ ORDER BY Rank          │      │ INNER JOIN Conversations│     │
│  │ LIMIT N               │       │ WHERE MATCH query      │      │
│  └────────────┬───────────┘      └────────────┬───────────┘      │
│               │                               │                  │
│               └───────────────┬───────────────┘                  │
│                               ▼                                  │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SearchResults                                             │    │
│  │   Conversations: [SearchResult, ...]                      │    │
│  │   Messages: [SearchResult, ...]                           │    │
│  │   TotalCount: 12                                          │    │
│  │   SearchDuration: 18ms                                    │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Query Sanitization Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   Query Sanitization Flow                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User Input: database "error" logs*                              │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 1: Escape special characters                         │    │
│  │   " → ""  (doubled)                                       │    │
│  │   * → ""  (removed)                                       │    │
│  │   ( → ""  (removed)                                       │    │
│  │   ) → ""  (removed)                                       │    │
│  │                                                           │    │
│  │   Result: database ""error"" logs                         │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 2: Split into terms                                  │    │
│  │   ["database", "\"\"error\"\"", "logs"]                   │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 3: Wrap each term in quotes + prefix wildcard        │    │
│  │   "\"database\"*" "\"error\"*" "\"logs\"*"                │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 4: Join with spaces (implicit AND)                   │    │
│  │   "\"database\"* \"error\"* \"logs\"*"                    │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Safety Benefits:                                                │
│  ✓ Prevents FTS5 syntax injection                                │
│  ✓ Enables prefix matching (type-as-you-search)                  │
│  ✓ Treats each word as required (AND logic)                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Interfaces/
    └── ISearchService.cs                             (NEW)

src/SeniorIntern.Services/
└── SearchService.cs                                  (NEW)

src/SeniorIntern.Desktop/
└── Extensions/
    └── ServiceCollectionExtensions.cs                (UPDATE)
```

---

## Implementation Details

### Task 1: Create ISearchService Interface

**File:** `src/SeniorIntern.Core/Interfaces/ISearchService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>Provides full-text search functionality.</summary>
public interface ISearchService
{
    /// <summary>Searches conversations and messages using FTS5.</summary>
    /// <param name="query">The search query with options.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>Grouped search results with ranking.</returns>
    Task<SearchResults> SearchAsync(
        SearchQuery query,
        CancellationToken cancellationToken = default);

    /// <summary>Rebuilds the FTS5 indexes (for maintenance).</summary>
    /// <remarks>Use sparingly - rebuilds entire index.</remarks>
    Task RebuildIndexAsync(CancellationToken cancellationToken = default);

    /// <summary>Gets search suggestions based on recent searches.</summary>
    /// <param name="prefix">The prefix to match.</param>
    /// <param name="maxSuggestions">Maximum number of suggestions.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>List of matching recent searches.</returns>
    Task<IReadOnlyList<string>> GetSuggestionsAsync(
        string prefix,
        int maxSuggestions = 5,
        CancellationToken cancellationToken = default);
}
```

---

### Task 2: Implement SearchService

**File:** `src/SeniorIntern.Services/SearchService.cs`

```csharp
namespace SeniorIntern.Services;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data;
using System.Data.Common;
using System.Diagnostics;
using System.Text.RegularExpressions;

public sealed partial class SearchService : ISearchService
{
    private readonly SeniorInternDbContext _dbContext;
    private readonly ILogger<SearchService> _logger;
    private readonly List<string> _recentSearches = new(capacity: 20);
    private readonly object _recentSearchesLock = new();

    public SearchService(
        SeniorInternDbContext dbContext,
        ILogger<SearchService> logger)
    {
        _dbContext = dbContext;
        _logger = logger;
    }

    public async Task<SearchResults> SearchAsync(
        SearchQuery query,
        CancellationToken cancellationToken = default)
    {
        ArgumentNullException.ThrowIfNull(query);

        if (string.IsNullOrWhiteSpace(query.Text))
            return SearchResults.Empty;

        var stopwatch = Stopwatch.StartNew();
        var sanitizedQuery = SanitizeFtsQuery(query.Text);

        _logger.LogDebug("Searching FTS5 for: {Query} → {Sanitized}", query.Text, sanitizedQuery);

        TrackRecentSearch(query.Text);

        var conversations = new List<SearchResult>();
        var messages = new List<SearchResult>();

        // Search conversations if not filtered to messages only
        if (query.FilterType is null or SearchResultType.Conversation)
        {
            conversations = await SearchConversationsAsync(
                sanitizedQuery, query.MaxResults / 2, query.SnippetLength, cancellationToken);
        }

        // Search messages if not filtered to conversations only
        if (query.FilterType is null or SearchResultType.Message)
        {
            messages = await SearchMessagesAsync(
                sanitizedQuery, query.MaxResults / 2, query.SnippetLength, cancellationToken);
        }

        stopwatch.Stop();

        _logger.LogInformation(
            "Search completed in {Duration}ms: {ConvCount} conversations, {MsgCount} messages",
            stopwatch.ElapsedMilliseconds, conversations.Count, messages.Count);

        return new SearchResults
        {
            Conversations = conversations,
            Messages = messages,
            TotalCount = conversations.Count + messages.Count,
            SearchDuration = stopwatch.Elapsed
        };
    }

    private async Task<List<SearchResult>> SearchConversationsAsync(
        string query, int maxResults, int snippetLength, CancellationToken ct)
    {
        // snippet() args: table, column-index, start-marker, end-marker, ellipsis, max-tokens
        const string sql = """
            SELECT
                c.Id,
                c.Title,
                snippet(ConversationsFts, 0, '<mark>', '</mark>', '...', @tokens) as Snippet,
                bm25(ConversationsFts) as Rank,
                c.UpdatedAt
            FROM ConversationsFts
            INNER JOIN Conversations c ON c.Id = ConversationsFts.rowid
            WHERE ConversationsFts MATCH @query
            ORDER BY Rank
            LIMIT @limit
        """;

        var results = new List<SearchResult>();
        await using var connection = _dbContext.GetConnection();
        await connection.OpenAsync(ct);

        try
        {
            await using var command = connection.CreateCommand();
            command.CommandText = sql;
            AddParameter(command, "@query", query);
            AddParameter(command, "@tokens", snippetLength / 10);
            AddParameter(command, "@limit", maxResults);

            await using var reader = await command.ExecuteReaderAsync(ct);
            while (await reader.ReadAsync(ct))
            {
                var snippet = reader.GetString(2);
                results.Add(new SearchResult
                {
                    Id = reader.GetGuid(0),
                    Type = SearchResultType.Conversation,
                    Title = reader.GetString(1),
                    Snippet = StripHtmlTags(snippet),
                    HighlightedSnippet = snippet,
                    Rank = Math.Abs(reader.GetDouble(3)), // BM25 returns negative
                    Timestamp = reader.GetDateTime(4)
                });
            }
        }
        finally
        {
            await connection.CloseAsync();
        }

        return results;
    }

    private async Task<List<SearchResult>> SearchMessagesAsync(
        string query, int maxResults, int snippetLength, CancellationToken ct)
    {
        const string sql = """
            SELECT
                m.Id,
                m.Content,
                snippet(MessagesFts, 0, '<mark>', '</mark>', '...', @tokens) as Snippet,
                bm25(MessagesFts) as Rank,
                m.Timestamp,
                m.ConversationId,
                c.Title as ConversationTitle
            FROM MessagesFts
            INNER JOIN Messages m ON m.Id = MessagesFts.rowid
            INNER JOIN Conversations c ON c.Id = m.ConversationId
            WHERE MessagesFts MATCH @query
            ORDER BY Rank
            LIMIT @limit
        """;

        var results = new List<SearchResult>();
        await using var connection = _dbContext.GetConnection();
        await connection.OpenAsync(ct);

        try
        {
            await using var command = connection.CreateCommand();
            command.CommandText = sql;
            AddParameter(command, "@query", query);
            AddParameter(command, "@tokens", snippetLength / 10);
            AddParameter(command, "@limit", maxResults);

            await using var reader = await command.ExecuteReaderAsync(ct);
            while (await reader.ReadAsync(ct))
            {
                var snippet = reader.GetString(2);
                results.Add(new SearchResult
                {
                    Id = reader.GetGuid(0),
                    Type = SearchResultType.Message,
                    Title = TruncateContent(reader.GetString(1), 50),
                    Snippet = StripHtmlTags(snippet),
                    HighlightedSnippet = snippet,
                    Rank = Math.Abs(reader.GetDouble(3)),
                    Timestamp = reader.GetDateTime(4),
                    ConversationId = reader.GetGuid(5),
                    ConversationTitle = reader.GetString(6)
                });
            }
        }
        finally
        {
            await connection.CloseAsync();
        }

        return results;
    }

    public async Task RebuildIndexAsync(CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Rebuilding FTS5 indexes...");

        await _dbContext.Database.ExecuteSqlRawAsync(
            "INSERT INTO ConversationsFts(ConversationsFts) VALUES('rebuild');",
            cancellationToken);

        await _dbContext.Database.ExecuteSqlRawAsync(
            "INSERT INTO MessagesFts(MessagesFts) VALUES('rebuild');",
            cancellationToken);

        _logger.LogInformation("FTS5 indexes rebuilt successfully");
    }

    public Task<IReadOnlyList<string>> GetSuggestionsAsync(
        string prefix, int maxSuggestions = 5, CancellationToken cancellationToken = default)
    {
        if (string.IsNullOrWhiteSpace(prefix))
            return Task.FromResult<IReadOnlyList<string>>([]);

        lock (_recentSearchesLock)
        {
            var suggestions = _recentSearches
                .Where(s => s.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
                .Distinct()
                .Take(maxSuggestions)
                .ToList();

            return Task.FromResult<IReadOnlyList<string>>(suggestions);
        }
    }

    // === Utility Methods ===

    private void TrackRecentSearch(string query)
    {
        lock (_recentSearchesLock)
        {
            _recentSearches.Remove(query);
            _recentSearches.Insert(0, query);

            while (_recentSearches.Count > 20)
                _recentSearches.RemoveAt(_recentSearches.Count - 1);
        }
    }

    private static string SanitizeFtsQuery(string query)
    {
        // Escape special FTS5 characters
        var sanitized = query
            .Replace("\"", "\"\"")
            .Replace("*", "")
            .Replace("(", "")
            .Replace(")", "");

        // Split into terms and add prefix matching
        var terms = sanitized.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return string.Join(" ", terms.Select(t => $"\"{t}\"*"));
    }

    private static string StripHtmlTags(string html)
        => StripHtmlRegex().Replace(html, string.Empty);

    private static string TruncateContent(string content, int maxLength)
        => content.Length <= maxLength ? content : content[..maxLength] + "...";

    private static void AddParameter(DbCommand command, string name, object value)
    {
        var param = command.CreateParameter();
        param.ParameterName = name;
        param.Value = value;
        command.Parameters.Add(param);
    }

    [GeneratedRegex("<[^>]+>")]
    private static partial Regex StripHtmlRegex();
}
```

---

### Task 3: Register SearchService in DI

**File:** `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` (addition)

```csharp
// Search Service (v0.2.5)
services.AddSingleton<ISearchService, SearchService>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| SearchAsync | 5 | Empty query, filter types, result grouping |
| SanitizeFtsQuery | 4 | Special characters, prefix matching |
| GetSuggestionsAsync | 3 | Prefix matching, max limit, empty |
| RebuildIndexAsync | 1 | Executes without error |
| StripHtmlTags | 2 | Tag removal, preserves text |
| **Total** | **15** | |

### Key Test Scenarios

```csharp
[Fact]
public async Task SearchAsync_EmptyQuery_ReturnsEmpty()
{
    var service = CreateService();
    var result = await service.SearchAsync(new SearchQuery { Text = "" });
    
    Assert.True(result.IsEmpty);
    Assert.Equal(TimeSpan.Zero, result.SearchDuration);
}

[Fact]
public async Task SearchAsync_FilterToConversations_SkipsMessages()
{
    var service = CreateService();
    var query = SearchQuery.Conversations("test");
    
    var result = await service.SearchAsync(query);
    
    Assert.Empty(result.Messages);
    // Only conversations searched
}

[Fact]
public void SanitizeFtsQuery_EscapesQuotes()
{
    var result = SearchService.SanitizeFtsQuery("test \"phrase\"");
    Assert.Contains("\"\"phrase\"\"", result);
}

[Fact]
public void SanitizeFtsQuery_AddsPrefixWildcard()
{
    var result = SearchService.SanitizeFtsQuery("hello");
    Assert.Equal("\"hello\"*", result);
}

[Fact]
public void SanitizeFtsQuery_MultipleTerms_JoinedWithSpace()
{
    var result = SearchService.SanitizeFtsQuery("hello world");
    Assert.Equal("\"hello\"* \"world\"*", result);
}

[Fact]
public async Task GetSuggestionsAsync_MatchesPrefix()
{
    var service = CreateService();
    // Simulate previous searches
    await service.SearchAsync(new SearchQuery { Text = "database error" });
    await service.SearchAsync(new SearchQuery { Text = "database migration" });
    await service.SearchAsync(new SearchQuery { Text = "user authentication" });
    
    var suggestions = await service.GetSuggestionsAsync("data");
    
    Assert.Equal(2, suggestions.Count);
    Assert.All(suggestions, s => Assert.StartsWith("data", s, StringComparison.OrdinalIgnoreCase));
}

[Fact]
public void StripHtmlTags_RemovesTags_PreservesContent()
{
    var html = "This is <mark>highlighted</mark> text";
    var result = SearchService.StripHtmlTags(html);
    Assert.Equal("This is highlighted text", result);
}
```

### Integration Tests

```csharp
[Fact]
public async Task SearchAsync_FindsConversationByTitle()
{
    await using var db = CreateTestDb();
    var service = new SearchService(db, _logger);
    
    // Create test conversation
    db.Conversations.Add(new ConversationEntity { Title = "Database Migration Discussion" });
    await db.SaveChangesAsync();
    
    var result = await service.SearchAsync(SearchQuery.All("migration"));
    
    Assert.Single(result.Conversations);
    Assert.Contains("Migration", result.Conversations[0].Title);
}

[Fact]
public async Task SearchAsync_FindsMessageContent()
{
    await using var db = CreateTestDb();
    var service = new SearchService(db, _logger);
    
    // Create test data
    var conv = new ConversationEntity { Title = "Chat" };
    db.Conversations.Add(conv);
    await db.SaveChangesAsync();
    
    db.Messages.Add(new MessageEntity 
    { 
        ConversationId = conv.Id, 
        Content = "This is about database normalization",
        Role = MessageRole.User
    });
    await db.SaveChangesAsync();
    
    var result = await service.SearchAsync(SearchQuery.Messages("normalization"));
    
    Assert.Single(result.Messages);
    Assert.NotNull(result.Messages[0].ConversationTitle);
}
```

---

## Files Summary

### Files to Create (2)

| File | Lines (approx) |
|------|----------------|
| `Core/Interfaces/ISearchService.cs` | 35 |
| `Services/SearchService.cs` | 200 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Add ISearchService registration |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | SearchAsync returns grouped results for both types |
| AC-2 | Empty query returns SearchResults.Empty immediately |
| AC-3 | FilterType restricts search to specified type |
| AC-4 | BM25 ranking orders results by relevance |
| AC-5 | Snippets contain `<mark>` highlighting |
| AC-6 | Query sanitization prevents FTS5 syntax errors |
| AC-7 | Prefix matching enabled (type-as-you-search) |
| AC-8 | Recent searches tracked for suggestions |
| AC-9 | RebuildIndexAsync completes without error |
| AC-10 | Search duration measured and returned |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Prefix wildcards | Enables type-as-you-search experience |
| Quote wrapping | Treats each word as literal term |
| In-memory suggestions | Fast, no DB overhead, session-scoped |
| Max 20 recent searches | Balance memory vs. usefulness |
| Split results by type | UI can display in separate sections |

---

## FTS5 Functions Reference

| Function | Description |
|----------|-------------|
| `bm25(table)` | Returns BM25 relevance score (negative, so use `Math.Abs`) |
| `snippet(table, col, start, end, ellipsis, tokens)` | Returns highlighted snippet |
| `highlight(table, col, start, end)` | Returns full content with highlights |
| `offsets(table)` | Returns byte offsets of matches |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.5b | 0.5-1 day |
