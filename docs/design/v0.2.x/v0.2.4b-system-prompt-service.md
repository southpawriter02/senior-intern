# Design Specification: AIntern v0.2.4b "System Prompt Service"

## Executive Summary

This document provides a detailed implementation specification for v0.2.4b, which implements the service layer for managing system prompts. The `SystemPromptService` provides CRUD operations, template management, conversation integration, and event notifications for UI synchronization.

### v0.2.4b Scope (from v0.2.4 Design Document)

- Create `ISystemPromptService` interface
- Create event args classes for prompt changes
- Implement `SystemPromptService` with full functionality
- Integrate with `ISettingsService` for persistence of current prompt
- Integrate with `IConversationRepository` for conversation-prompt binding
- Fire events on all prompt changes

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ISystemPromptService | Service interface with CRUD + events |
| PromptListChangedEventArgs | Events for list mutations |
| CurrentPromptChangedEventArgs | Events for current prompt changes |
| SystemPromptService | Full implementation |
| AppSettings Update | Add CurrentSystemPromptId |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.4b Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ISystemPromptService                                             │
│  ├── Properties                                                   │
│  │   └── CurrentPrompt (SystemPrompt?) - for new conversations    │
│  │                                                                │
│  ├── Query Methods                                                │
│  │   ├── GetUserPromptsAsync() → user prompts only                │
│  │   ├── GetTemplatesAsync() → built-in only                      │
│  │   ├── GetAllPromptsAsync() → all prompts                       │
│  │   ├── GetByIdAsync(id)                                         │
│  │   ├── GetDefaultPromptAsync()                                  │
│  │   ├── GetPromptForConversationAsync(conversationId)            │
│  │   └── SearchPromptsAsync(query)                                │
│  │                                                                │
│  ├── Mutation Methods                                             │
│  │   ├── CreatePromptAsync(name, content, description?)           │
│  │   ├── CreateFromTemplateAsync(templateId, newName?)            │
│  │   ├── UpdatePromptAsync(id, name?, content?, description?)     │
│  │   ├── DeletePromptAsync(id)                                    │
│  │   ├── DuplicatePromptAsync(id, newName?)                       │
│  │   ├── SetAsDefaultAsync(id)                                    │
│  │   └── SetCurrentPromptAsync(id?)                               │
│  │                                                                │
│  ├── Utilities                                                    │
│  │   └── FormatPromptForContext(prompt) → string                  │
│  │                                                                │
│  └── Events                                                       │
│      ├── PromptListChanged (Created, Updated, Deleted, etc.)      │
│      └── CurrentPromptChanged (NewPrompt, PreviousPrompt)         │
│                                                                   │
│  Event Args                                                       │
│  ├── PromptListChangedEventArgs                                   │
│  │   ├── ChangeType (enum)                                        │
│  │   ├── AffectedPromptId?                                        │
│  │   └── AffectedPromptName?                                      │
│  │                                                                │
│  └── CurrentPromptChangedEventArgs                                │
│      ├── NewPrompt?                                               │
│      └── PreviousPrompt?                                          │
│                                                                   │
│  PromptListChangeType (Enum)                                      │
│  ├── PromptCreated                                                │
│  ├── PromptUpdated                                                │
│  ├── PromptDeleted                                                │
│  ├── DefaultChanged                                               │
│  └── ListRefreshed                                                │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Service Layer Position

```
┌─────────────────────────────────────────────────────────────────┐
│                    Service Layer Position                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ViewModels                                                      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ SystemPromptEditorViewModel, SystemPromptSelectorViewModel  │ │
│  └─────────────────────────────┬───────────────────────────────┘ │
│                                │                                 │
│                                ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              ISystemPromptService                           │ │
│  │                                                             │ │
│  │  CurrentPrompt ─────────► For new conversations             │ │
│  │  GetAllPromptsAsync() ──► List for UI                       │ │
│  │  CreatePromptAsync() ───► CRUD operations                   │ │
│  │  SetCurrentPromptAsync()► Update selection                  │ │
│  │                                                             │ │
│  │  Events: PromptListChanged, CurrentPromptChanged            │ │
│  └───────────────────────────┬─────────────────────────────────┘ │
│                              │                                   │
│            ┌─────────────────┼─────────────────┐                 │
│            ▼                 ▼                 ▼                 │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────┐ │
│  │ISystemPrompt    │ │IConversation    │ │ISettingsService     │ │
│  │Repository       │ │Repository       │ │                     │ │
│  │(CRUD to DB)     │ │(get conv prompt)│ │(persist selection)  │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Prompt Selection Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   Prompt Selection Flow                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User selects "The Senior Intern" from dropdown                  │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SetCurrentPromptAsync(promptId)                           │    │
│  │  1. Get prompt by ID                                      │    │
│  │  2. Set _currentPrompt = prompt                           │    │
│  │  3. IncrementUsageAsync(promptId)                         │    │
│  │  4. Save to settings.json                                 │    │
│  │  5. Fire CurrentPromptChanged event                       │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ CurrentPromptChanged Event                                │    │
│  │  NewPrompt = "The Senior Intern"                          │    │
│  │  PreviousPrompt = "Default Assistant"                     │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                ┌─────────────┴─────────────┐                     │
│                ▼                           ▼                     │
│  ┌──────────────────────┐    ┌──────────────────────────────┐    │
│  │ Selector UI updates  │    │ ChatViewModel uses new       │    │
│  │ to show selection    │    │ prompt for next generation   │    │
│  └──────────────────────┘    └──────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### CRUD Event Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      CRUD Event Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  CreatePromptAsync("My Custom", content)                         │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ 1. Validate name and content                              │    │
│  │ 2. Check name uniqueness                                  │    │
│  │ 3. Create entity with Category="Custom"                   │    │
│  │ 4. Save to database                                       │    │
│  │ 5. Map to domain model                                    │    │
│  │ 6. Fire PromptListChanged(PromptCreated)                  │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ PromptListChanged Event                                   │    │
│  │  ChangeType = PromptCreated                               │    │
│  │  AffectedPromptId = newId                                 │    │
│  │  AffectedPromptName = "My Custom"                         │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ViewModels receive event, refresh prompt lists            │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Interfaces/
│   └── ISystemPromptService.cs                       (NEW)
├── Events/
│   ├── PromptListChangedEventArgs.cs                 (NEW)
│   └── CurrentPromptChangedEventArgs.cs              (NEW)
└── Models/
    └── AppSettings.cs                                (UPDATE)

src/SeniorIntern.Services/
└── SystemPromptService.cs                            (NEW)

src/SeniorIntern.Desktop/
└── Extensions/
    └── ServiceCollectionExtensions.cs                (UPDATE)
```

---

## Implementation Details

### Task 1: Create Event Args Classes

**File:** `src/SeniorIntern.Core/Events/PromptListChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

/// <summary>Event args for prompt list changes.</summary>
public sealed class PromptListChangedEventArgs : EventArgs
{
    public required PromptListChangeType ChangeType { get; init; }
    public Guid? AffectedPromptId { get; init; }
    public string? AffectedPromptName { get; init; }
}

public enum PromptListChangeType
{
    PromptCreated,
    PromptUpdated,
    PromptDeleted,
    DefaultChanged,
    ListRefreshed
}
```

**File:** `src/SeniorIntern.Core/Events/CurrentPromptChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

using SeniorIntern.Core.Models;

/// <summary>Event args for current prompt changes.</summary>
public sealed class CurrentPromptChangedEventArgs : EventArgs
{
    public SystemPrompt? NewPrompt { get; init; }
    public SystemPrompt? PreviousPrompt { get; init; }
}
```

---

### Task 2: Create ISystemPromptService Interface

**File:** `src/SeniorIntern.Core/Interfaces/ISystemPromptService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Events;
using SeniorIntern.Core.Models;

public interface ISystemPromptService
{
    /// <summary>Current prompt for new conversations.</summary>
    SystemPrompt? CurrentPrompt { get; }

    // Query methods
    Task<IReadOnlyList<SystemPrompt>> GetUserPromptsAsync(CancellationToken ct = default);
    Task<IReadOnlyList<SystemPrompt>> GetTemplatesAsync(CancellationToken ct = default);
    Task<IReadOnlyList<SystemPrompt>> GetAllPromptsAsync(CancellationToken ct = default);
    Task<SystemPrompt?> GetByIdAsync(Guid id, CancellationToken ct = default);
    Task<SystemPrompt?> GetDefaultPromptAsync(CancellationToken ct = default);
    Task<SystemPrompt?> GetPromptForConversationAsync(Guid conversationId, CancellationToken ct = default);
    Task<IReadOnlyList<SystemPrompt>> SearchPromptsAsync(string query, CancellationToken ct = default);

    // Mutation methods
    Task<SystemPrompt> CreatePromptAsync(string name, string content, string? description = null, CancellationToken ct = default);
    Task<SystemPrompt> CreateFromTemplateAsync(Guid templateId, string? newName = null, CancellationToken ct = default);
    Task UpdatePromptAsync(Guid id, string? name = null, string? content = null, string? description = null, CancellationToken ct = default);
    Task DeletePromptAsync(Guid id, CancellationToken ct = default);
    Task<SystemPrompt> DuplicatePromptAsync(Guid id, string? newName = null, CancellationToken ct = default);
    Task SetAsDefaultAsync(Guid id, CancellationToken ct = default);
    Task SetCurrentPromptAsync(Guid? id, CancellationToken ct = default);

    // Utilities
    string FormatPromptForContext(SystemPrompt prompt);

    // Events
    event EventHandler<PromptListChangedEventArgs>? PromptListChanged;
    event EventHandler<CurrentPromptChangedEventArgs>? CurrentPromptChanged;
}
```

---

### Task 3: Implement SystemPromptService

**File:** `src/SeniorIntern.Services/SystemPromptService.cs`

Key implementation patterns:

```csharp
namespace SeniorIntern.Services;

using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data.Repositories;
using System.Text.Json;

public sealed class SystemPromptService : ISystemPromptService
{
    private readonly ISystemPromptRepository _repository;
    private readonly IConversationRepository _conversationRepository;
    private readonly ISettingsService _settingsService;
    private readonly ILogger<SystemPromptService> _logger;
    private SystemPrompt? _currentPrompt;

    public SystemPrompt? CurrentPrompt => _currentPrompt;
    public event EventHandler<PromptListChangedEventArgs>? PromptListChanged;
    public event EventHandler<CurrentPromptChangedEventArgs>? CurrentPromptChanged;

    public SystemPromptService(
        ISystemPromptRepository repository,
        IConversationRepository conversationRepository,
        ISettingsService settingsService,
        ILogger<SystemPromptService> logger)
    {
        _repository = repository;
        _conversationRepository = conversationRepository;
        _settingsService = settingsService;
        _logger = logger;
    }

    public async Task InitializeAsync(CancellationToken ct = default)
    {
        await _repository.SeedBuiltInPromptsAsync(ct);

        var settings = _settingsService.GetSettings();
        if (settings.CurrentSystemPromptId.HasValue)
        {
            _currentPrompt = await GetByIdAsync(settings.CurrentSystemPromptId.Value, ct);
        }
        else
        {
            _currentPrompt = await GetDefaultPromptAsync(ct);
        }
    }

    // Query implementations delegate to repository + mapping

    public async Task<SystemPrompt> CreatePromptAsync(
        string name, string content, string? description = null, CancellationToken ct = default)
    {
        if (string.IsNullOrWhiteSpace(name)) throw new ArgumentException("Name is required");
        if (string.IsNullOrWhiteSpace(content)) throw new ArgumentException("Content is required");
        if (await _repository.NameExistsAsync(name, ct: ct))
            throw new InvalidOperationException($"A prompt named '{name}' already exists");

        var entity = new SystemPromptEntity
        {
            Id = Guid.NewGuid(),
            Name = name.Trim(),
            Content = content,
            Description = description?.Trim(),
            Category = "Custom",
            IsBuiltIn = false,
            IsDefault = false
        };
        await _repository.CreateAsync(entity, ct);
        var prompt = MapToDomain(entity);
        OnPromptListChanged(PromptListChangeType.PromptCreated, prompt.Id, prompt.Name);
        return prompt;
    }

    public async Task DeletePromptAsync(Guid id, CancellationToken ct = default)
    {
        var entity = await _repository.GetByIdAsync(id, ct);
        if (entity == null) return;
        if (entity.IsBuiltIn) throw new InvalidOperationException("Cannot delete built-in prompts");

        await _repository.DeleteAsync(id, ct);
        OnPromptListChanged(PromptListChangeType.PromptDeleted, id, entity.Name);

        // Reset to default if deleted was current
        if (_currentPrompt?.Id == id)
        {
            var previous = _currentPrompt;
            _currentPrompt = await GetDefaultPromptAsync(ct);
            OnCurrentPromptChanged(_currentPrompt, previous);
        }
    }

    public async Task SetCurrentPromptAsync(Guid? id, CancellationToken ct = default)
    {
        var previous = _currentPrompt;
        if (id.HasValue)
        {
            _currentPrompt = await GetByIdAsync(id.Value, ct);
            if (_currentPrompt != null) await _repository.IncrementUsageAsync(id.Value, ct);
        }
        else { _currentPrompt = null; }

        var settings = _settingsService.GetSettings();
        settings.CurrentSystemPromptId = id;
        await _settingsService.SaveSettingsAsync(settings, ct);

        OnCurrentPromptChanged(_currentPrompt, previous);
    }

    public string FormatPromptForContext(SystemPrompt prompt) => prompt.Content.Trim();

    // Mapping helper
    private static SystemPrompt MapToDomain(SystemPromptEntity entity) => new()
    {
        Id = entity.Id,
        Name = entity.Name,
        Content = entity.Content,
        Description = entity.Description,
        Category = entity.Category,
        Tags = ParseTags(entity.TagsJson),
        IsBuiltIn = entity.IsBuiltIn,
        IsDefault = entity.IsDefault,
        CreatedAt = entity.CreatedAt,
        UpdatedAt = entity.UpdatedAt,
        UsageCount = entity.UsageCount
    };

    private static IReadOnlyList<string> ParseTags(string? json)
    {
        if (string.IsNullOrEmpty(json)) return Array.Empty<string>();
        try { return JsonSerializer.Deserialize<List<string>>(json) ?? new(); }
        catch { return Array.Empty<string>(); }
    }

    // Event helpers
    private void OnPromptListChanged(PromptListChangeType type, Guid? id = null, string? name = null)
        => PromptListChanged?.Invoke(this, new PromptListChangedEventArgs
        { ChangeType = type, AffectedPromptId = id, AffectedPromptName = name });

    private void OnCurrentPromptChanged(SystemPrompt? newP, SystemPrompt? prevP)
        => CurrentPromptChanged?.Invoke(this, new CurrentPromptChangedEventArgs
        { NewPrompt = newP, PreviousPrompt = prevP });
}
```

---

### Task 4: Update AppSettings

**File:** `src/SeniorIntern.Core/Models/AppSettings.cs` (update)

```csharp
// Add to existing AppSettings class
/// <summary>ID of the currently selected system prompt for new conversations.</summary>
public Guid? CurrentSystemPromptId { get; set; }
```

---

### Task 5: Update DI Registration

```csharp
services.AddSingleton<ISystemPromptService, SystemPromptService>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| Query Methods | 6 | GetAll, GetById, Search |
| Create Operations | 5 | Validation, uniqueness, events |
| Update Operations | 4 | Built-in protection, events |
| Delete Operations | 4 | Protection, current prompt reset |
| SetCurrentPromptAsync | 3 | Persistence, events |
| **Total** | **22** | |

### Key Test Scenarios

```csharp
[Fact]
public async Task CreatePromptAsync_ThrowsForDuplicateName()
{
    var service = await CreateInitializedService();
    await service.CreatePromptAsync("Test", "Content");
    await Assert.ThrowsAsync<InvalidOperationException>(
        () => service.CreatePromptAsync("Test", "Other content"));
}

[Fact]
public async Task DeletePromptAsync_ResetsCurrentToDefault()
{
    var service = await CreateInitializedService();
    var custom = await service.CreatePromptAsync("Custom", "Content");
    await service.SetCurrentPromptAsync(custom.Id);

    await service.DeletePromptAsync(custom.Id);

    var defaultPrompt = await service.GetDefaultPromptAsync();
    Assert.Equal(defaultPrompt?.Id, service.CurrentPrompt?.Id);
}

[Fact]
public async Task SetCurrentPromptAsync_PersistsToSettings()
{
    var service = await CreateInitializedService();
    var promptId = Guid.Parse("00000002-0000-0000-0000-000000000002");

    await service.SetCurrentPromptAsync(promptId);

    var settings = _settingsService.GetSettings();
    Assert.Equal(promptId, settings.CurrentSystemPromptId);
}

[Fact]
public async Task CreateFromTemplateAsync_AutoIncrementsDuplicateNames()
{
    var service = await CreateInitializedService();
    var templateId = Guid.Parse("00000002-0000-0000-0000-000000000001");

    var p1 = await service.CreateFromTemplateAsync(templateId, "Custom");
    var p2 = await service.CreateFromTemplateAsync(templateId, "Custom");

    Assert.Equal("Custom", p1.Name);
    Assert.Equal("Custom (1)", p2.Name);
}
```

---

## Files Summary

### Files to Create (4)

| File | Lines (approx) |
|------|----------------|
| `Core/Interfaces/ISystemPromptService.cs` | 50 |
| `Core/Events/PromptListChangedEventArgs.cs` | 20 |
| `Core/Events/CurrentPromptChangedEventArgs.cs` | 15 |
| `Services/SystemPromptService.cs` | 220 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `Core/Models/AppSettings.cs` | Add CurrentSystemPromptId |
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Add service registration |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | CurrentPrompt persists across app restarts |
| AC-2 | GetUserPromptsAsync returns only custom prompts |
| AC-3 | GetTemplatesAsync returns only built-in prompts |
| AC-4 | CreatePromptAsync validates name uniqueness |
| AC-5 | Cannot modify or delete built-in prompts |
| AC-6 | CreateFromTemplateAsync auto-increments duplicate names |
| AC-7 | DeletePromptAsync resets CurrentPrompt if deleted |
| AC-8 | PromptListChanged event fires on all mutations |
| AC-9 | CurrentPromptChanged event fires on selection change |
| AC-10 | Usage count increments on SetCurrentPromptAsync |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Separate events for list vs current | Different subscribers need different info |
| Auto-increment duplicate names | Better UX than throwing errors |
| Persist CurrentPromptId in settings.json | Fast startup, survives reinstall |
| Fall back to default on deleted current | Never leave user without a prompt |
| FormatPromptForContext() hook | Future extensibility for model-specific formatting |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.4b | 0.5-1 day |
