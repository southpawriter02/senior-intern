# Design Specification: The Senior Intern v0.2.5c "Export Service"

## Executive Summary

This document provides a detailed implementation specification for v0.2.5c, which implements the conversation export service. The `ExportService` supports exporting conversations in multiple formats (Markdown, JSON, Plain Text, HTML) with customizable options for including timestamps, system prompts, metadata, and token counts.

### v0.2.5c Scope (from v0.2.5 Design Document)

- Create `ExportOptions` and `ExportResult` models
- Create `IExportService` interface
- Implement `ExportService` with 4 format exporters
- Generate styled HTML export with dark theme
- Provide preview generation for UI
- Sanitize filenames for safe saving

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ExportOptions | Configuration for export behavior |
| ExportResult | Result container with content/metadata |
| IExportService | Service interface |
| ExportService | Full implementation with 4 formats |
| Format Exporters | Markdown, JSON, PlainText, HTML |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.5c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Export Models                                                    │
│  ├── ExportOptions                                                │
│  │   ├── Format (Markdown | Json | PlainText | Html)              │
│  │   ├── IncludeTimestamps (default: true)                        │
│  │   ├── IncludeSystemPrompt (default: true)                      │
│  │   ├── IncludeTokenCounts (default: false)                      │
│  │   └── IncludeMetadata (default: true)                          │
│  │                                                                │
│  ├── ExportFormat (Enum)                                          │
│  │   ├── Markdown → .md, text/markdown                            │
│  │   ├── Json → .json, application/json                           │
│  │   ├── PlainText → .txt, text/plain                             │
│  │   └── Html → .html, text/html                                  │
│  │                                                                │
│  └── ExportResult                                                 │
│      ├── Success (bool)                                           │
│      ├── Content (string)                                         │
│      ├── SuggestedFileName (string)                               │
│      ├── MimeType (string)                                        │
│      └── ErrorMessage (string?)                                   │
│                                                                   │
│  IExportService                                                   │
│  ├── ExportAsync(conversationId, options) → ExportResult          │
│  ├── GeneratePreviewAsync(id, options, maxLen) → string           │
│  ├── GetFileExtension(format) → string                            │
│  └── GetMimeType(format) → string                                 │
│                                                                   │
│  Format Exporters                                                 │
│  ├── ExportToMarkdown()                                           │
│  │   ├── # Title                                                  │
│  │   ├── **User** / **Assistant** labels                          │
│  │   └── --- separators between messages                          │
│  │                                                                │
│  ├── ExportToJson()                                               │
│  │   └── Structured JSON with messages array                      │
│  │                                                                │
│  ├── ExportToPlainText()                                          │
│  │   ├── Title with === underline                                 │
│  │   └── [HH:mm] ROLE: format                                     │
│  │                                                                │
│  └── ExportToHtml()                                               │
│      ├── Dark theme styled HTML                                   │
│      ├── User messages: blue accent                               │
│      ├── Assistant messages: purple accent                        │
│      └── Responsive, standalone (embedded CSS)                    │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Export Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Export Flow                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User clicks "Export" in UI                                      │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ExportOptions                                             │    │
│  │   Format: Markdown                                        │    │
│  │   IncludeTimestamps: true                                 │    │
│  │   IncludeSystemPrompt: true                               │    │
│  │   IncludeMetadata: true                                   │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ IExportService.ExportAsync(conversationId, options)       │    │
│  │                                                           │    │
│  │  1. Load conversation with messages                       │    │
│  │  2. Validate conversation exists                          │    │
│  │  3. Route to format exporter                              │    │
│  │  4. Generate content                                      │    │
│  │  5. Sanitize filename                                     │    │
│  │  6. Return ExportResult                                   │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ExportResult                                              │    │
│  │   Success: true                                           │    │
│  │   Content: "# Database Discussion\n\n**User**:..."        │    │
│  │   SuggestedFileName: "database-discussion.md"             │    │
│  │   MimeType: "text/markdown"                               │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ UI shows Save File dialog with suggested name             │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Format Comparison

```
┌─────────────────────────────────────────────────────────────────┐
│                    Format Output Comparison                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Markdown (.md)                JSON (.json)                      │
│  ┌──────────────────────┐      ┌──────────────────────┐          │
│  │ # Database Help      │      │ {                    │          │
│  │                      │      │   "title": "...",    │          │
│  │ **Created:** 2024... │      │   "createdAt": ...,  │          │
│  │                      │      │   "messages": [      │          │
│  │ **User** (14:30):    │      │     {                │          │
│  │ How do I...          │      │       "role": "user",│          │
│  │                      │      │       "content": ... │          │
│  │ ---                  │      │     }                │          │
│  │                      │      │   ]                  │          │
│  │ **Assistant**:       │      │ }                    │          │
│  │ You can use...       │      │                      │          │
│  └──────────────────────┘      └──────────────────────┘          │
│                                                                  │
│  PlainText (.txt)              HTML (.html)                      │
│  ┌──────────────────────┐      ┌──────────────────────┐          │
│  │ Database Help        │      │ <!DOCTYPE html>      │          │
│  │ =============        │      │ <html lang="en">     │          │
│  │                      │      │ <head>               │          │
│  │ Created: 2024-01-10  │      │   <title>...</title> │          │
│  │                      │      │   <style>            │          │
│  │ [14:30] USER:        │      │     body { ... }     │          │
│  │ How do I...          │      │   </style>           │          │
│  │                      │      │ </head>              │          │
│  │ [14:31] ASSISTANT:   │      │ <body>               │          │
│  │ You can use...       │      │   <div class="msg">  │          │
│  └──────────────────────┘      └──────────────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Interfaces/
│   └── IExportService.cs                             (NEW)
└── Models/
    ├── ExportOptions.cs                              (NEW)
    └── ExportResult.cs                               (NEW)

src/SeniorIntern.Services/
└── ExportService.cs                                  (NEW)

src/SeniorIntern.Desktop/
└── Extensions/
    └── ServiceCollectionExtensions.cs                (UPDATE)
```

---

## Implementation Details

### Task 1: Create ExportOptions Model

**File:** `src/SeniorIntern.Core/Models/ExportOptions.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Options for exporting conversations.</summary>
public sealed class ExportOptions
{
    /// <summary>Export format (default: Markdown).</summary>
    public ExportFormat Format { get; set; } = ExportFormat.Markdown;

    /// <summary>Include message timestamps (default: true).</summary>
    public bool IncludeTimestamps { get; set; } = true;

    /// <summary>Include the system prompt (default: true).</summary>
    public bool IncludeSystemPrompt { get; set; } = true;

    /// <summary>Include token counts per message (default: false).</summary>
    public bool IncludeTokenCounts { get; set; } = false;

    /// <summary>Include metadata like created/updated dates (default: true).</summary>
    public bool IncludeMetadata { get; set; } = true;

    /// <summary>Default export options.</summary>
    public static ExportOptions Default => new();

    /// <summary>Minimal export (no metadata, no timestamps).</summary>
    public static ExportOptions Minimal => new()
    {
        IncludeTimestamps = false,
        IncludeMetadata = false,
        IncludeSystemPrompt = false,
        IncludeTokenCounts = false
    };
}

/// <summary>Export file format.</summary>
public enum ExportFormat
{
    /// <summary>Markdown format (.md).</summary>
    Markdown,

    /// <summary>JSON format (.json).</summary>
    Json,

    /// <summary>Plain text format (.txt).</summary>
    PlainText,

    /// <summary>HTML format with dark theme styling (.html).</summary>
    Html
}
```

---

### Task 2: Create ExportResult Model

**File:** `src/SeniorIntern.Core/Models/ExportResult.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Result of an export operation.</summary>
public sealed class ExportResult
{
    /// <summary>Whether the export succeeded.</summary>
    public required bool Success { get; init; }

    /// <summary>The exported content.</summary>
    public required string Content { get; init; }

    /// <summary>Suggested filename including extension.</summary>
    public required string SuggestedFileName { get; init; }

    /// <summary>MIME type for the content.</summary>
    public required string MimeType { get; init; }

    /// <summary>Error message if export failed.</summary>
    public string? ErrorMessage { get; init; }

    /// <summary>Creates a failed result with error message.</summary>
    public static ExportResult Failed(string error) => new()
    {
        Success = false,
        Content = string.Empty,
        SuggestedFileName = string.Empty,
        MimeType = string.Empty,
        ErrorMessage = error
    };
}
```

---

### Task 3: Create IExportService Interface

**File:** `src/SeniorIntern.Core/Interfaces/IExportService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>Provides conversation export functionality.</summary>
public interface IExportService
{
    /// <summary>Exports a conversation to the specified format.</summary>
    Task<ExportResult> ExportAsync(
        Guid conversationId,
        ExportOptions options,
        CancellationToken cancellationToken = default);

    /// <summary>Generates a preview of the export (truncated).</summary>
    Task<string> GeneratePreviewAsync(
        Guid conversationId,
        ExportOptions options,
        int maxLength = 500,
        CancellationToken cancellationToken = default);

    /// <summary>Gets the file extension for a format.</summary>
    string GetFileExtension(ExportFormat format);

    /// <summary>Gets the MIME type for a format.</summary>
    string GetMimeType(ExportFormat format);
}
```

---

### Task 4: Implement ExportService

**File:** `src/SeniorIntern.Services/ExportService.cs`

```csharp
namespace SeniorIntern.Services;

using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data.Repositories;
using System.Text;
using System.Text.Json;
using System.Text.RegularExpressions;
using System.Web;

public sealed partial class ExportService : IExportService
{
    private readonly IConversationRepository _conversationRepository;
    private readonly ILogger<ExportService> _logger;

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    public ExportService(
        IConversationRepository conversationRepository,
        ILogger<ExportService> logger)
    {
        _conversationRepository = conversationRepository;
        _logger = logger;
    }

    public async Task<ExportResult> ExportAsync(
        Guid conversationId,
        ExportOptions options,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var conversation = await _conversationRepository
                .GetByIdWithMessagesAsync(conversationId, cancellationToken);

            if (conversation is null)
                return ExportResult.Failed("Conversation not found");

            var content = options.Format switch
            {
                ExportFormat.Markdown => ExportToMarkdown(conversation, options),
                ExportFormat.Json => ExportToJson(conversation, options),
                ExportFormat.PlainText => ExportToPlainText(conversation, options),
                ExportFormat.Html => ExportToHtml(conversation, options),
                _ => throw new ArgumentOutOfRangeException(nameof(options.Format))
            };

            var safeTitle = SanitizeFileName(conversation.Title);
            var extension = GetFileExtension(options.Format);

            _logger.LogInformation("Exported conversation {Id} to {Format}", conversationId, options.Format);

            return new ExportResult
            {
                Success = true,
                Content = content,
                SuggestedFileName = $"{safeTitle}{extension}",
                MimeType = GetMimeType(options.Format)
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to export conversation {Id}", conversationId);
            return ExportResult.Failed(ex.Message);
        }
    }

    public async Task<string> GeneratePreviewAsync(
        Guid conversationId,
        ExportOptions options,
        int maxLength = 500,
        CancellationToken cancellationToken = default)
    {
        var result = await ExportAsync(conversationId, options, cancellationToken);

        if (!result.Success)
            return $"Error: {result.ErrorMessage}";

        if (result.Content.Length <= maxLength)
            return result.Content;

        return result.Content[..maxLength] + "\n\n... (truncated)";
    }

    public string GetFileExtension(ExportFormat format) => format switch
    {
        ExportFormat.Markdown => ".md",
        ExportFormat.Json => ".json",
        ExportFormat.PlainText => ".txt",
        ExportFormat.Html => ".html",
        _ => ".txt"
    };

    public string GetMimeType(ExportFormat format) => format switch
    {
        ExportFormat.Markdown => "text/markdown",
        ExportFormat.Json => "application/json",
        ExportFormat.PlainText => "text/plain",
        ExportFormat.Html => "text/html",
        _ => "text/plain"
    };

    // === Format Exporters ===

    private static string ExportToMarkdown(ConversationEntity conversation, ExportOptions options)
    {
        var sb = new StringBuilder();
        sb.AppendLine($"# {conversation.Title}");
        sb.AppendLine();

        if (options.IncludeMetadata)
        {
            sb.AppendLine($"**Created:** {conversation.CreatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine($"**Last Updated:** {conversation.UpdatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine();
        }

        if (options.IncludeSystemPrompt && !string.IsNullOrEmpty(conversation.SystemPrompt))
        {
            sb.AppendLine("## System Prompt");
            sb.AppendLine();
            sb.AppendLine(conversation.SystemPrompt);
            sb.AppendLine();
        }

        sb.AppendLine("## Conversation");
        sb.AppendLine();

        foreach (var message in conversation.Messages.OrderBy(m => m.Timestamp))
        {
            var roleLabel = message.Role switch
            {
                MessageRole.User => "**User**",
                MessageRole.Assistant => "**Assistant**",
                MessageRole.System => "**System**",
                _ => "**Unknown**"
            };

            sb.AppendLine(options.IncludeTimestamps
                ? $"{roleLabel} ({message.Timestamp:HH:mm}):"
                : $"{roleLabel}:");
            sb.AppendLine();
            sb.AppendLine(message.Content);

            if (options.IncludeTokenCounts && message.TokenCount.HasValue)
            {
                sb.AppendLine();
                sb.AppendLine($"*Tokens: {message.TokenCount}*");
            }

            sb.AppendLine();
            sb.AppendLine("---");
            sb.AppendLine();
        }

        sb.AppendLine("*Exported from The Senior Intern*");
        return sb.ToString();
    }

    private static string ExportToJson(ConversationEntity conversation, ExportOptions options)
    {
        var export = new
        {
            title = conversation.Title,
            createdAt = conversation.CreatedAt,
            updatedAt = conversation.UpdatedAt,
            systemPrompt = options.IncludeSystemPrompt ? conversation.SystemPrompt : null,
            messages = conversation.Messages
                .OrderBy(m => m.Timestamp)
                .Select(m => new
                {
                    role = m.Role.ToString().ToLowerInvariant(),
                    content = m.Content,
                    timestamp = options.IncludeTimestamps ? m.Timestamp : (DateTime?)null,
                    tokenCount = options.IncludeTokenCounts ? m.TokenCount : null
                })
                .ToList(),
            exportedAt = DateTime.UtcNow,
            exportedBy = "The Senior Intern"
        };

        return JsonSerializer.Serialize(export, JsonOptions);
    }

    private static string ExportToPlainText(ConversationEntity conversation, ExportOptions options)
    {
        var sb = new StringBuilder();
        sb.AppendLine(conversation.Title);
        sb.AppendLine(new string('=', conversation.Title.Length));
        sb.AppendLine();

        if (options.IncludeMetadata)
        {
            sb.AppendLine($"Created: {conversation.CreatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine($"Updated: {conversation.UpdatedAt:yyyy-MM-dd HH:mm}");
            sb.AppendLine();
        }

        if (options.IncludeSystemPrompt && !string.IsNullOrEmpty(conversation.SystemPrompt))
        {
            sb.AppendLine("System Prompt:");
            sb.AppendLine(conversation.SystemPrompt);
            sb.AppendLine();
        }

        foreach (var message in conversation.Messages.OrderBy(m => m.Timestamp))
        {
            var roleLabel = message.Role.ToString().ToUpperInvariant();
            sb.AppendLine(options.IncludeTimestamps
                ? $"[{message.Timestamp:HH:mm}] {roleLabel}:"
                : $"{roleLabel}:");
            sb.AppendLine(message.Content);

            if (options.IncludeTokenCounts && message.TokenCount.HasValue)
                sb.AppendLine($"(Tokens: {message.TokenCount})");

            sb.AppendLine();
        }

        return sb.ToString();
    }

    private static string ExportToHtml(ConversationEntity conversation, ExportOptions options)
    {
        var sb = new StringBuilder();
        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html lang=\"en\">");
        sb.AppendLine("<head>");
        sb.AppendLine("  <meta charset=\"UTF-8\">");
        sb.AppendLine($"  <title>{HttpUtility.HtmlEncode(conversation.Title)}</title>");
        sb.AppendLine("  <style>");
        sb.AppendLine("    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: #e0e0e0; }");
        sb.AppendLine("    h1 { color: #00d9ff; border-bottom: 2px solid #00d9ff; padding-bottom: 10px; }");
        sb.AppendLine("    .metadata { color: #888; font-size: 0.9em; margin-bottom: 20px; }");
        sb.AppendLine("    .system-prompt { background: #2d2d44; padding: 15px; border-radius: 8px; margin-bottom: 20px; }");
        sb.AppendLine("    .message { margin-bottom: 20px; padding: 15px; border-radius: 8px; }");
        sb.AppendLine("    .message.user { background: #16213e; border-left: 4px solid #00d9ff; }");
        sb.AppendLine("    .message.assistant { background: #1f1f3a; border-left: 4px solid #7b68ee; }");
        sb.AppendLine("    .message.system { background: #2d2d44; border-left: 4px solid #ffd700; }");
        sb.AppendLine("    .role { font-weight: bold; margin-bottom: 8px; }");
        sb.AppendLine("    .timestamp { color: #888; font-size: 0.85em; }");
        sb.AppendLine("    .content { white-space: pre-wrap; }");
        sb.AppendLine("    .footer { margin-top: 40px; text-align: center; color: #666; font-size: 0.85em; }");
        sb.AppendLine("  </style>");
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");
        sb.AppendLine($"  <h1>{HttpUtility.HtmlEncode(conversation.Title)}</h1>");

        // Metadata, system prompt, messages...
        // (Similar structure to other formatters)

        sb.AppendLine("  <div class=\"footer\">Exported from The Senior Intern</div>");
        sb.AppendLine("</body>");
        sb.AppendLine("</html>");
        return sb.ToString();
    }

    // === Utilities ===

    private static string SanitizeFileName(string title)
    {
        var sanitized = InvalidFileNameCharsRegex().Replace(title, "-");
        sanitized = sanitized.Trim('-').ToLowerInvariant();
        return string.IsNullOrEmpty(sanitized) ? "conversation" : sanitized;
    }

    [GeneratedRegex(@"[^a-zA-Z0-9\-_ ]")]
    private static partial Regex InvalidFileNameCharsRegex();
}
```

---

### Task 5: Register ExportService in DI

```csharp
services.AddSingleton<IExportService, ExportService>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| ExportAsync | 5 | Each format, not found, error handling |
| GeneratePreviewAsync | 2 | Truncation, error passthrough |
| GetFileExtension | 4 | Each format |
| GetMimeType | 4 | Each format |
| SanitizeFileName | 3 | Special chars, empty, normal |
| **Total** | **18** | |

### Key Test Scenarios

```csharp
[Fact]
public async Task ExportAsync_Markdown_IncludesTitle()
{
    var service = CreateService();
    var result = await service.ExportAsync(conversationId, new ExportOptions { Format = ExportFormat.Markdown });
    
    Assert.True(result.Success);
    Assert.StartsWith("# ", result.Content);
    Assert.EndsWith(".md", result.SuggestedFileName);
}

[Fact]
public async Task ExportAsync_Json_IsValidJson()
{
    var service = CreateService();
    var result = await service.ExportAsync(conversationId, new ExportOptions { Format = ExportFormat.Json });
    
    Assert.True(result.Success);
    var parsed = JsonDocument.Parse(result.Content);
    Assert.NotNull(parsed.RootElement.GetProperty("title"));
}

[Fact]
public async Task ExportAsync_NotFound_ReturnsError()
{
    var service = CreateService();
    var result = await service.ExportAsync(Guid.NewGuid(), ExportOptions.Default);
    
    Assert.False(result.Success);
    Assert.Contains("not found", result.ErrorMessage, StringComparison.OrdinalIgnoreCase);
}

[Theory]
[InlineData(ExportFormat.Markdown, ".md")]
[InlineData(ExportFormat.Json, ".json")]
[InlineData(ExportFormat.PlainText, ".txt")]
[InlineData(ExportFormat.Html, ".html")]
public void GetFileExtension_ReturnsCorrectExtension(ExportFormat format, string expected)
{
    var service = CreateService();
    Assert.Equal(expected, service.GetFileExtension(format));
}

[Fact]
public void SanitizeFileName_RemovesSpecialCharacters()
{
    var result = ExportService.SanitizeFileName("Hello: World! @#$%");
    Assert.Equal("hello-world", result);
}
```

---

## Files Summary

### Files to Create (4)

| File | Lines (approx) |
|------|----------------|
| `Core/Models/ExportOptions.cs` | 45 |
| `Core/Models/ExportResult.cs` | 35 |
| `Core/Interfaces/IExportService.cs` | 30 |
| `Services/ExportService.cs` | 280 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Add IExportService registration |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Markdown export includes title, messages, separators |
| AC-2 | JSON export is valid JSON |
| AC-3 | PlainText export is readable |
| AC-4 | HTML export has embedded dark-theme CSS |
| AC-5 | IncludeTimestamps option affects output |
| AC-6 | IncludeSystemPrompt option affects output |
| AC-7 | IncludeMetadata option affects output |
| AC-8 | SuggestedFileName is safe for file system |
| AC-9 | GeneratePreviewAsync truncates at maxLength |
| AC-10 | Missing conversation returns error result |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Embedded CSS in HTML | Standalone file, no external dependencies |
| Dark theme HTML | Matches app aesthetic |
| Lowercase sanitized filenames | Cross-platform safety |
| ExportResult.Failed() factory | Consistent error handling |
| Preview truncation | Fast UI feedback without full export |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.5c | 0.5-1 day |
