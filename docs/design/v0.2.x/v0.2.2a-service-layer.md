# Design Specification: The Senior Intern v0.2.2a "Service Layer"

## Executive Summary

This document provides a detailed implementation specification for v0.2.2a, which implements the `DatabaseConversationService` - the core service layer for conversation persistence. This service bridges the gap between the repository layer (v0.2.1d) and the presentation layer (v0.2.2b+), managing in-memory conversation state, auto-save functionality with debouncing, and entity-to-domain model mapping.

v0.2.2a transforms the application from an in-memory-only chat experience to one backed by persistent SQLite storage, enabling users to close and reopen the application without losing conversation history.

### v0.2.2a Scope (from v0.2.2 Design Document)

- Update `Conversation` domain model with persistence-related properties
- Create `ConversationSummary` model for efficient list display
- Define event args for service-to-ViewModel communication
- Implement `DatabaseConversationService` with auto-save debouncing
- Create mapping logic between entities and domain models
- Implement title auto-generation from first user message

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| Conversation Model Update | Add `IsPersisted`, `HasUnsavedChanges`, internal methods |
| ConversationSummary Model | Lightweight record for sidebar list display with date grouping |
| DateGroup Enum | Categorization for Today, Yesterday, Previous7Days, etc. |
| Event Args Classes | 3 classes for ConversationChanged, ListChanged, SaveStateChanged |
| IConversationService Update | Expanded interface with CRUD, list, and event definitions |
| DatabaseConversationService | Full implementation with auto-save, mapping, events |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.2a Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Service Layer                                                    │
│  ├── Domain Models                                                │
│  │   ├── Conversation (updated)                                   │
│  │   │   ├── IsPersisted flag                                     │
│  │   │   ├── HasUnsavedChanges flag                               │
│  │   │   ├── LoadMessages() internal method                       │
│  │   │   └── MarkAsSaved() internal method                        │
│  │   │                                                            │
│  │   ├── ConversationSummary (new)                                │
│  │   │   ├── Preview text truncation                              │
│  │   │   └── GetDateGroup() for grouping                          │
│  │   │                                                            │
│  │   └── DateGroup enum                                           │
│  │                                                                │
│  ├── Service Events                                               │
│  │   ├── ConversationChangedEventArgs                             │
│  │   │   └── ChangeType: Created, Loaded, MessageAdded, Saved...  │
│  │   ├── ConversationListChangedEventArgs                         │
│  │   │   └── ChangeType: Added, Removed, Updated, Refreshed       │
│  │   └── SaveStateChangedEventArgs                                │
│  │       └── IsSaving, HasUnsavedChanges, LastSavedAt             │
│  │                                                                │
│  ├── IConversationService Interface                               │
│  │   ├── State: CurrentConversation, HasUnsavedChanges            │
│  │   ├── Messages: Add, Update, Remove, Get                       │
│  │   ├── CRUD: Create, Load, Save, Delete, Rename                 │
│  │   ├── Flags: Archive, Unarchive, Pin, Unpin                    │
│  │   ├── List: GetRecent, Search                                  │
│  │   └── Events: 3 event definitions                              │
│  │                                                                │
│  └── DatabaseConversationService                                  │
│      ├── Auto-save with 500ms debounce timer                      │
│      ├── Title auto-generation from first message                 │
│      ├── Entity ↔ Domain mapping                                  │
│      ├── Message synchronization                                  │
│      └── Thread-safe save with SemaphoreSlim                      │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Service Layer Position

```
┌─────────────────────────────────────────────────────────────────┐
│                    SeniorIntern.Desktop                          │
│                    (Presentation Layer)                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ConversationListViewModel ◄──── Events ────┐              │  │
│  │ ChatViewModel ◄──────────────── Events ────┤              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────┬───────────────────────────────────┘
                              │ Uses IConversationService
┌─────────────────────────────▼───────────────────────────────────┐
│                    SeniorIntern.Services                         │
│                    (Application Layer)                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              DatabaseConversationService                   │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                 │  │
│  │  │ Auto-Save Timer │  │  In-Memory      │                 │  │
│  │  │   (500ms)       │  │  Conversation   │                 │  │
│  │  └─────────────────┘  └─────────────────┘                 │  │
│  │                                                            │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                 │  │
│  │  │ Entity ↔ Domain │  │  Event          │                 │  │
│  │  │ Mapping         │  │  Publishing     │                 │  │
│  │  └─────────────────┘  └─────────────────┘                 │  │
│  └──────────────────────────┬────────────────────────────────┘  │
└─────────────────────────────┼───────────────────────────────────┘
                              │ Uses Repositories
┌─────────────────────────────▼───────────────────────────────────┐
│                    SeniorIntern.Data                             │
│  IConversationRepository, ISystemPromptRepository                │
└─────────────────────────────────────────────────────────────────┘
```

### Auto-Save Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Auto-Save Flow Diagram                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User Action (Message/Edit)                                      │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────────┐                                            │
│  │ Update In-Memory │                                            │
│  │ Conversation     │                                            │
│  │ HasUnsavedChanges│──────┐                                     │
│  │     = true       │      │                                     │
│  └──────────────────┘      │                                     │
│         │                  │                                     │
│         ▼                  ▼                                     │
│  ┌──────────────────┐  ┌──────────────────┐                      │
│  │ Fire Event:      │  │ ScheduleAutoSave │                      │
│  │ MessageAdded     │  │ - Stop timer     │                      │
│  └──────────────────┘  │ - Start timer    │                      │
│                        │   (500ms)        │                      │
│                        └────────┬─────────┘                      │
│                                 │                                │
│                        Timer Expires                             │
│                                 │                                │
│                                 ▼                                │
│                        ┌──────────────────┐                      │
│                        │ Check conditions │                      │
│                        │ - HasUnsavedChg? │                      │
│                        │ - Messages > 0?  │                      │
│                        └────────┬─────────┘                      │
│                                 │ Yes                            │
│                                 ▼                                │
│                        ┌──────────────────┐                      │
│                        │ Acquire saveLock │                      │
│                        │ (SemaphoreSlim)  │                      │
│                        └────────┬─────────┘                      │
│                                 │                                │
│                                 ▼                                │
│                        ┌──────────────────┐                      │
│                        │ Fire Event:      │                      │
│                        │ SaveState(saving)│                      │
│                        └────────┬─────────┘                      │
│                                 │                                │
│                                 ▼                                │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │                    Save to Database                        │   │
│  │  ┌─────────────┐              ┌─────────────┐              │   │
│  │  │ IsPersisted?│──No──────────►CreateAsync  │              │   │
│  │  └──────┬──────┘              │ + Messages  │              │   │
│  │         │ Yes                 └─────────────┘              │   │
│  │         ▼                                                  │   │
│  │  ┌─────────────┐                                           │   │
│  │  │UpdateAsync +│                                           │   │
│  │  │SyncMessages │                                           │   │
│  │  └─────────────┘                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                 │                                │
│                                 ▼                                │
│                        ┌──────────────────┐                      │
│                        │ MarkAsSaved()    │                      │
│                        │ HasUnsavedChanges│                      │
│                        │     = false      │                      │
│                        └────────┬─────────┘                      │
│                                 │                                │
│                                 ▼                                │
│                        ┌──────────────────┐                      │
│                        │ Fire Events:     │                      │
│                        │ - SaveState(done)│                      │
│                        │ - ConvChanged    │                      │
│                        │ - ListChanged    │                      │
│                        └──────────────────┘                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Prerequisites

Before implementing v0.2.2a, ensure:
- v0.2.1a is complete (Data project exists)
- v0.2.1b is complete (Entity classes defined)
- v0.2.1c is complete (DbContext and configurations)
- v0.2.1d is complete (Repository interfaces and implementations)
- v0.2.1e is complete (DI registration, database initialization)
- Solution builds successfully

---

## Directory Structure

After v0.2.2a implementation:

```
src/
├── SeniorIntern.Core/
│   ├── Models/
│   │   ├── Conversation.cs                    (UPDATED)
│   │   ├── ConversationSummary.cs             (NEW)
│   │   ├── ChatMessage.cs                     (existing)
│   │   └── AppSettings.cs                     (existing)
│   ├── Enums/
│   │   ├── MessageRole.cs                     (existing)
│   │   └── DateGroup.cs                       (NEW)
│   ├── Events/
│   │   ├── ConversationChangedEventArgs.cs   (NEW)
│   │   ├── ConversationListChangedEventArgs.cs (NEW)
│   │   └── SaveStateChangedEventArgs.cs      (NEW)
│   └── Interfaces/
│       └── IConversationService.cs           (UPDATED)
│
├── SeniorIntern.Services/
│   └── DatabaseConversationService.cs        (NEW)
│
└── SeniorIntern.Desktop/
    └── Extensions/
        └── ServiceCollectionExtensions.cs    (UPDATED - register service)
```

---

## Implementation Details

### Task 1: Update Conversation Domain Model

**File:** `src/SeniorIntern.Core/Models/Conversation.cs`

Add persistence-related properties and internal methods for service use.

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Domain model for a conversation (in-memory representation).
/// Bridges between entities and ViewModels with persistence state tracking.
/// </summary>
public sealed class Conversation
{
    #region Identity

    /// <summary>Gets or sets the unique identifier.</summary>
    public Guid Id { get; set; } = Guid.NewGuid();

    /// <summary>Gets or sets the display title.</summary>
    public string Title { get; set; } = "New Conversation";

    #endregion

    #region Timestamps

    /// <summary>Gets or sets when the conversation was created.</summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>Gets or sets when the conversation was last modified.</summary>
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    #endregion

    #region Model Info

    /// <summary>Gets or sets the model file path.</summary>
    public string? ModelPath { get; set; }

    /// <summary>Gets or sets the human-readable model name.</summary>
    public string? ModelName { get; set; }

    #endregion

    #region System Prompt

    /// <summary>Gets or sets the system prompt ID.</summary>
    public Guid? SystemPromptId { get; set; }

    /// <summary>Gets or sets the system prompt name (for display).</summary>
    public string? SystemPromptName { get; set; }

    #endregion

    #region Flags

    /// <summary>Gets or sets whether the conversation is archived.</summary>
    public bool IsArchived { get; set; }

    /// <summary>Gets or sets whether the conversation is pinned.</summary>
    public bool IsPinned { get; set; }

    #endregion

    #region Persistence State

    /// <summary>
    /// Gets or sets whether the conversation has been saved to the database.
    /// </summary>
    /// <remarks>
    /// A new conversation starts with IsPersisted = false.
    /// After first save, this becomes true.
    /// </remarks>
    public bool IsPersisted { get; set; }

    /// <summary>
    /// Gets or sets whether there are unsaved changes.
    /// </summary>
    /// <remarks>
    /// Set to true when messages are added/removed/updated.
    /// Set to false after successful save.
    /// </remarks>
    public bool HasUnsavedChanges { get; set; }

    #endregion

    #region Messages

    private readonly List<ChatMessage> _messages = new();

    /// <summary>Gets the ordered list of messages.</summary>
    public IReadOnlyList<ChatMessage> Messages => _messages;

    /// <summary>
    /// Adds a message to the conversation.
    /// </summary>
    /// <param name="message">The message to add.</param>
    /// <remarks>
    /// Automatically assigns SequenceNumber and updates timestamps.
    /// </remarks>
    public void AddMessage(ChatMessage message)
    {
        message.SequenceNumber = _messages.Count + 1;
        _messages.Add(message);
        UpdatedAt = DateTime.UtcNow;
        HasUnsavedChanges = true;
    }

    /// <summary>
    /// Updates an existing message in the conversation.
    /// </summary>
    /// <param name="messageId">The message ID to update.</param>
    /// <param name="updateAction">Action to perform on the message.</param>
    public void UpdateMessage(Guid messageId, Action<ChatMessage> updateAction)
    {
        var message = _messages.FirstOrDefault(m => m.Id == messageId);
        if (message != null)
        {
            updateAction(message);
            UpdatedAt = DateTime.UtcNow;
            HasUnsavedChanges = true;
        }
    }

    /// <summary>
    /// Removes a message from the conversation.
    /// </summary>
    /// <param name="messageId">The message ID to remove.</param>
    /// <remarks>Re-sequences remaining messages.</remarks>
    public void RemoveMessage(Guid messageId)
    {
        var message = _messages.FirstOrDefault(m => m.Id == messageId);
        if (message != null)
        {
            _messages.Remove(message);
            // Re-sequence remaining messages
            for (int i = 0; i < _messages.Count; i++)
            {
                _messages[i].SequenceNumber = i + 1;
            }
            UpdatedAt = DateTime.UtcNow;
            HasUnsavedChanges = true;
        }
    }

    /// <summary>
    /// Clears all messages from the conversation.
    /// </summary>
    public void ClearMessages()
    {
        _messages.Clear();
        UpdatedAt = DateTime.UtcNow;
        HasUnsavedChanges = true;
    }

    #endregion

    #region Internal Methods (for service use)

    /// <summary>
    /// Loads messages from database (internal use only).
    /// </summary>
    /// <param name="messages">Messages to load.</param>
    internal void LoadMessages(IEnumerable<ChatMessage> messages)
    {
        _messages.Clear();
        _messages.AddRange(messages.OrderBy(m => m.SequenceNumber));
    }

    /// <summary>
    /// Marks the conversation as saved (internal use only).
    /// </summary>
    internal void MarkAsSaved()
    {
        HasUnsavedChanges = false;
        IsPersisted = true;
    }

    #endregion
}
```

---

### Task 2: Create ConversationSummary Model

**File:** `src/SeniorIntern.Core/Models/ConversationSummary.cs`

Lightweight model for sidebar list display.

```csharp
namespace SeniorIntern.Core.Models;

using SeniorIntern.Core.Enums;

/// <summary>
/// Lightweight summary of a conversation for list display.
/// Does not include full message content.
/// </summary>
public sealed record ConversationSummary
{
    /// <summary>Gets the unique identifier.</summary>
    public Guid Id { get; init; }

    /// <summary>Gets the display title.</summary>
    public string Title { get; init; } = string.Empty;

    /// <summary>Gets when the conversation was created.</summary>
    public DateTime CreatedAt { get; init; }

    /// <summary>Gets when the conversation was last modified.</summary>
    public DateTime UpdatedAt { get; init; }

    /// <summary>Gets the total number of messages.</summary>
    public int MessageCount { get; init; }

    /// <summary>Gets a preview of the first user message (truncated).</summary>
    public string? Preview { get; init; }

    /// <summary>Gets whether the conversation is archived.</summary>
    public bool IsArchived { get; init; }

    /// <summary>Gets whether the conversation is pinned.</summary>
    public bool IsPinned { get; init; }

    /// <summary>Gets the model name used.</summary>
    public string? ModelName { get; init; }

    /// <summary>
    /// Gets the date group for this conversation based on UpdatedAt.
    /// </summary>
    /// <returns>The appropriate DateGroup for UI grouping.</returns>
    public DateGroup GetDateGroup()
    {
        var now = DateTime.UtcNow.Date;
        var date = UpdatedAt.Date;

        if (date == now)
            return DateGroup.Today;
        if (date == now.AddDays(-1))
            return DateGroup.Yesterday;
        if (date >= now.AddDays(-7))
            return DateGroup.Previous7Days;
        if (date >= now.AddDays(-30))
            return DateGroup.Previous30Days;
        return DateGroup.Older;
    }
}
```

---

### Task 3: Create DateGroup Enum

**File:** `src/SeniorIntern.Core/Enums/DateGroup.cs`

```csharp
namespace SeniorIntern.Core.Enums;

/// <summary>
/// Date-based grouping categories for conversation lists.
/// </summary>
public enum DateGroup
{
    /// <summary>Conversations updated today.</summary>
    Today,

    /// <summary>Conversations updated yesterday.</summary>
    Yesterday,

    /// <summary>Conversations updated in the previous 7 days.</summary>
    Previous7Days,

    /// <summary>Conversations updated in the previous 30 days.</summary>
    Previous30Days,

    /// <summary>Conversations older than 30 days.</summary>
    Older
}
```

---

### Task 4: Create Event Args Classes

**File:** `src/SeniorIntern.Core/Events/ConversationChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

using SeniorIntern.Core.Models;

/// <summary>
/// Event args for conversation state changes.
/// </summary>
public sealed class ConversationChangedEventArgs : EventArgs
{
    /// <summary>Gets the affected conversation.</summary>
    public required Conversation Conversation { get; init; }

    /// <summary>Gets the type of change that occurred.</summary>
    public required ConversationChangeType ChangeType { get; init; }

    /// <summary>Gets the previous conversation ID (for load/create).</summary>
    public Guid? PreviousConversationId { get; init; }
}

/// <summary>
/// Types of conversation changes.
/// </summary>
public enum ConversationChangeType
{
    /// <summary>A new conversation was created.</summary>
    Created,

    /// <summary>An existing conversation was loaded from database.</summary>
    Loaded,

    /// <summary>A message was added to the conversation.</summary>
    MessageAdded,

    /// <summary>A message was updated (content or status change).</summary>
    MessageUpdated,

    /// <summary>A message was removed from the conversation.</summary>
    MessageRemoved,

    /// <summary>The conversation title was changed.</summary>
    TitleChanged,

    /// <summary>The conversation was saved to the database.</summary>
    Saved,

    /// <summary>All messages were cleared from the conversation.</summary>
    Cleared
}
```

**File:** `src/SeniorIntern.Core/Events/ConversationListChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

/// <summary>
/// Event args for conversation list changes (for sidebar refresh).
/// </summary>
public sealed class ConversationListChangedEventArgs : EventArgs
{
    /// <summary>Gets the type of list change.</summary>
    public required ConversationListChangeType ChangeType { get; init; }

    /// <summary>Gets the affected conversation ID (if applicable).</summary>
    public Guid? AffectedConversationId { get; init; }
}

/// <summary>
/// Types of conversation list changes.
/// </summary>
public enum ConversationListChangeType
{
    /// <summary>A new conversation was added to the list.</summary>
    ConversationAdded,

    /// <summary>A conversation was removed from the list.</summary>
    ConversationRemoved,

    /// <summary>A conversation in the list was updated.</summary>
    ConversationUpdated,

    /// <summary>The entire list should be refreshed.</summary>
    ListRefreshed
}
```

**File:** `src/SeniorIntern.Core/Events/SaveStateChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

/// <summary>
/// Event args for save state changes (for UI indicators).
/// </summary>
public sealed class SaveStateChangedEventArgs : EventArgs
{
    /// <summary>Gets whether a save operation is in progress.</summary>
    public required bool IsSaving { get; init; }

    /// <summary>Gets whether there are unsaved changes.</summary>
    public required bool HasUnsavedChanges { get; init; }

    /// <summary>Gets when the last successful save occurred.</summary>
    public DateTime? LastSavedAt { get; init; }

    /// <summary>Gets any error message from a failed save.</summary>
    public string? Error { get; init; }
}
```

---

### Task 5: Update IConversationService Interface

**File:** `src/SeniorIntern.Core/Interfaces/IConversationService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Events;
using SeniorIntern.Core.Models;

/// <summary>
/// Service for managing conversations with database persistence.
/// </summary>
public interface IConversationService
{
    #region State Properties

    /// <summary>Gets the currently active conversation.</summary>
    Conversation CurrentConversation { get; }

    /// <summary>Gets whether there are unsaved changes.</summary>
    bool HasUnsavedChanges { get; }

    /// <summary>Gets whether a conversation is currently loaded.</summary>
    bool HasActiveConversation { get; }

    #endregion

    #region Message Operations

    /// <summary>Adds a message to the current conversation.</summary>
    void AddMessage(ChatMessage message);

    /// <summary>Updates an existing message.</summary>
    void UpdateMessage(Guid messageId, Action<ChatMessage> updateAction);

    /// <summary>Removes a message from the current conversation.</summary>
    void RemoveMessage(Guid messageId);

    /// <summary>Gets all messages in the current conversation.</summary>
    IReadOnlyList<ChatMessage> GetMessages();

    #endregion

    #region Conversation CRUD

    /// <summary>Creates a new conversation and sets it as current.</summary>
    Task<Conversation> CreateNewConversationAsync(
        string? title = null,
        Guid? systemPromptId = null,
        CancellationToken ct = default);

    /// <summary>Loads an existing conversation by ID.</summary>
    Task<Conversation> LoadConversationAsync(Guid conversationId, CancellationToken ct = default);

    /// <summary>Saves the current conversation to the database.</summary>
    Task SaveCurrentConversationAsync(CancellationToken ct = default);

    /// <summary>Deletes a conversation.</summary>
    Task DeleteConversationAsync(Guid conversationId, CancellationToken ct = default);

    /// <summary>Renames a conversation.</summary>
    Task RenameConversationAsync(Guid conversationId, string newTitle, CancellationToken ct = default);

    #endregion

    #region Conversation Flags

    /// <summary>Archives a conversation (soft delete).</summary>
    Task ArchiveConversationAsync(Guid conversationId, CancellationToken ct = default);

    /// <summary>Unarchives a conversation.</summary>
    Task UnarchiveConversationAsync(Guid conversationId, CancellationToken ct = default);

    /// <summary>Pins a conversation to the top.</summary>
    Task PinConversationAsync(Guid conversationId, CancellationToken ct = default);

    /// <summary>Unpins a conversation.</summary>
    Task UnpinConversationAsync(Guid conversationId, CancellationToken ct = default);

    #endregion

    #region List Operations

    /// <summary>Gets recent conversations for the sidebar.</summary>
    Task<IReadOnlyList<ConversationSummary>> GetRecentConversationsAsync(
        int count = 50,
        bool includeArchived = false,
        CancellationToken ct = default);

    /// <summary>Searches conversations by title or content.</summary>
    Task<IReadOnlyList<ConversationSummary>> SearchConversationsAsync(
        string query,
        CancellationToken ct = default);

    #endregion

    #region Events

    /// <summary>Fired when the current conversation changes.</summary>
    event EventHandler<ConversationChangedEventArgs>? ConversationChanged;

    /// <summary>Fired when the conversation list should be refreshed.</summary>
    event EventHandler<ConversationListChangedEventArgs>? ConversationListChanged;

    /// <summary>Fired when save state changes.</summary>
    event EventHandler<SaveStateChangedEventArgs>? SaveStateChanged;

    #endregion
}
```

---

### Task 6: Implement DatabaseConversationService

**File:** `src/SeniorIntern.Services/DatabaseConversationService.cs`

Full implementation with auto-save, mapping, and events. See **Appendix A** for the complete ~400-line implementation.

Key implementation patterns:
- Constructor injection of `IConversationRepository`, `ISystemPromptRepository`, `ILogger`
- Auto-save timer (500ms debounce) using `System.Timers.Timer`
- Thread-safe save operations using `SemaphoreSlim`
- Automatic title generation from first user message
- Bidirectional mapping between entities and domain models

---

### Task 7: Register Service in DI

**File:** `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`

Add the following registration:

```csharp
// Services
services.AddSingleton<IConversationService, DatabaseConversationService>();
```

---

## Logging Specifications

### Log Levels by Operation

| Level | Operations |
|-------|------------|
| Debug | Create, Load, Save, Map operations |
| Information | Conversation created, loaded (user-initiated) |
| Warning | Auto-save retry after failure |
| Error | Save failure, mapping failure |

### Structured Logging Properties

| Property | Type | Description |
|----------|------|-------------|
| `ConversationId` | Guid | Conversation identifier |
| `Title` | string | Conversation title |
| `MessageCount` | int | Number of messages |
| `IsPersisted` | bool | Whether saved to DB |
| `ElapsedMs` | long | Operation duration |

### Logging Examples

```csharp
// Debug - Normal operations
_logger.LogDebug("Created new conversation {ConversationId}", id);
_logger.LogDebug("Loaded conversation {ConversationId}: {Title}", id, title);
_logger.LogDebug("Saved conversation {ConversationId} ({MessageCount} messages)", id, count);

// Warning - Recoverable issues
_logger.LogWarning("Auto-save retry for {ConversationId}: {Error}", id, error);

// Error - Failures
_logger.LogError(ex, "Failed to save conversation {ConversationId}", id);
```

---

## Unit Testing Requirements

### Test Summary

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| Conversation Model | 8 | AddMessage, RemoveMessage, state flags |
| ConversationSummary | 5 | GetDateGroup logic |
| DatabaseConversationService | 18 | CRUD, auto-save, mapping, events |
| **Total** | **31** | |

### Key Test Scenarios

```csharp
// Conversation Model Tests
[Fact]
public void AddMessage_IncrementsSequenceNumber()
{
    var conversation = new Conversation();
    var msg1 = new ChatMessage { Content = "First" };
    var msg2 = new ChatMessage { Content = "Second" };
    
    conversation.AddMessage(msg1);
    conversation.AddMessage(msg2);
    
    Assert.Equal(1, msg1.SequenceNumber);
    Assert.Equal(2, msg2.SequenceNumber);
}

[Fact]
public void AddMessage_SetsHasUnsavedChanges()
{
    var conversation = new Conversation();
    Assert.False(conversation.HasUnsavedChanges);
    
    conversation.AddMessage(new ChatMessage { Content = "Test" });
    
    Assert.True(conversation.HasUnsavedChanges);
}

[Fact]
public void RemoveMessage_ResequencesRemainingMessages()
{
    var conversation = new Conversation();
    var msg1 = new ChatMessage { Id = Guid.NewGuid(), Content = "1" };
    var msg2 = new ChatMessage { Id = Guid.NewGuid(), Content = "2" };
    var msg3 = new ChatMessage { Id = Guid.NewGuid(), Content = "3" };
    conversation.AddMessage(msg1);
    conversation.AddMessage(msg2);
    conversation.AddMessage(msg3);
    
    conversation.RemoveMessage(msg2.Id);
    
    Assert.Equal(1, msg1.SequenceNumber);
    Assert.Equal(2, msg3.SequenceNumber);
}

// ConversationSummary Tests
[Theory]
[InlineData(0, DateGroup.Today)]
[InlineData(-1, DateGroup.Yesterday)]
[InlineData(-3, DateGroup.Previous7Days)]
[InlineData(-15, DateGroup.Previous30Days)]
[InlineData(-60, DateGroup.Older)]
public void GetDateGroup_ReturnsCorrectGroup(int daysAgo, DateGroup expected)
{
    var summary = new ConversationSummary 
    { 
        UpdatedAt = DateTime.UtcNow.AddDays(daysAgo) 
    };
    
    Assert.Equal(expected, summary.GetDateGroup());
}

// Service Tests
[Fact]
public async Task CreateNewConversationAsync_SavesCurrentIfDirty()
{
    var mockRepo = new Mock<IConversationRepository>();
    var service = CreateService(mockRepo.Object);
    
    service.AddMessage(new ChatMessage { Content = "Test" });
    
    await service.CreateNewConversationAsync();
    
    mockRepo.Verify(r => r.CreateAsync(It.IsAny<ConversationEntity>(), 
        It.IsAny<CancellationToken>()), Times.Once);
}

[Fact]
public async Task AddMessage_TriggersAutoSave()
{
    var service = CreateService();
    var savedEventFired = false;
    service.SaveStateChanged += (s, e) => savedEventFired = !e.IsSaving && !e.HasUnsavedChanges;
    
    service.AddMessage(new ChatMessage { Content = "Test" });
    await Task.Delay(600); // Wait for debounce
    
    Assert.True(savedEventFired);
}

[Fact]
public void AddMessage_AutoGeneratesTitle_FromFirstUserMessage()
{
    var service = CreateService();
    
    service.AddMessage(new ChatMessage 
    { 
        Role = MessageRole.User, 
        Content = "How do I implement dependency injection in C#?" 
    });
    
    Assert.NotEqual("New Conversation", service.CurrentConversation.Title);
    Assert.Contains("dependency injection", service.CurrentConversation.Title, 
        StringComparison.OrdinalIgnoreCase);
}
```

---

## Use Cases

### UC-001: Add Message and Auto-Save

| Attribute | Value |
|-----------|-------|
| **Actor** | ChatViewModel |
| **Trigger** | User sends message or assistant generates response |
| **Success Scenario** | Message added, title generated (if first), auto-save triggered |
| **Postcondition** | Message in memory, save scheduled for 500ms later |

#### Flow
1. ChatViewModel calls `AddMessage(message)`
2. Service adds message to in-memory conversation
3. If first user message, title is auto-generated
4. `ConversationChanged` event fires (type: MessageAdded)
5. Auto-save timer resets to 500ms
6. After 500ms, conversation persists to database
7. `SaveStateChanged` event fires (saving complete)

---

### UC-002: Switch Between Conversations

| Attribute | Value |
|-----------|-------|
| **Actor** | ConversationListViewModel |
| **Trigger** | User clicks a different conversation in sidebar |
| **Success Scenario** | Current saved if dirty, new conversation loaded |
| **Postcondition** | New conversation is active with all messages |

#### Flow
1. ViewModel calls `LoadConversationAsync(targetId)`
2. Service checks if current has unsaved changes
3. If dirty, saves current conversation
4. Service loads target from repository (with messages)
5. Maps entity to domain model
6. `ConversationChanged` event fires (type: Loaded)
7. ViewModel updates UI

---

### UC-003: Create New Conversation

| Attribute | Value |
|-----------|-------|
| **Actor** | ConversationListViewModel |
| **Trigger** | User clicks "New Conversation" button |
| **Success Scenario** | Current saved if dirty, new empty conversation created |
| **Postcondition** | Empty conversation ready for first message |

---

## Deliverable Checklist

### Domain Layer (SeniorIntern.Core)
- [ ] Models/Conversation.cs (UPDATED)
- [ ] Models/ConversationSummary.cs (NEW)
- [ ] Enums/DateGroup.cs (NEW)
- [ ] Events/ConversationChangedEventArgs.cs (NEW)
- [ ] Events/ConversationListChangedEventArgs.cs (NEW)
- [ ] Events/SaveStateChangedEventArgs.cs (NEW)
- [ ] Interfaces/IConversationService.cs (UPDATED)

### Application Layer (SeniorIntern.Services)
- [ ] DatabaseConversationService.cs (NEW)

### Presentation Layer (SeniorIntern.Desktop)
- [ ] Extensions/ServiceCollectionExtensions.cs (UPDATED)

### Tests
- [ ] SeniorIntern.Core.Tests - Model and summary tests
- [ ] SeniorIntern.Services.Tests - Service tests

---

## Files Summary

### Files to Create (6)

| File | Purpose | Lines (approx) |
|------|---------|----------------|
| `Core/Models/ConversationSummary.cs` | Lightweight list display model | 50 |
| `Core/Enums/DateGroup.cs` | Date grouping enum | 20 |
| `Core/Events/ConversationChangedEventArgs.cs` | Conversation change events | 45 |
| `Core/Events/ConversationListChangedEventArgs.cs` | List change events | 30 |
| `Core/Events/SaveStateChangedEventArgs.cs` | Save state events | 25 |
| `Services/DatabaseConversationService.cs` | Full service implementation | 400 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `Core/Models/Conversation.cs` | Add IsPersisted, HasUnsavedChanges, internal methods |
| `Core/Interfaces/IConversationService.cs` | Expand with CRUD, list, flag, and event definitions |
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Register DatabaseConversationService |

---

## Verification Steps

### Step 1: Verify Compilation

```bash
dotnet build src/SeniorIntern.Core
dotnet build src/SeniorIntern.Services
dotnet build
```

### Step 2: Run Unit Tests

```bash
dotnet test tests/SeniorIntern.Core.Tests
dotnet test tests/SeniorIntern.Services.Tests
```

### Step 3: Integration Test (Manual)

1. Start application
2. Send a message → verify auto-generated title
3. Wait 600ms → check database for persisted conversation
4. Close and reopen app → verify conversation loads

---

## Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | Conversation model has persistence state | IsPersisted, HasUnsavedChanges properties work |
| AC-2 | ConversationSummary groups correctly | GetDateGroup returns correct values |
| AC-3 | Events fire on state changes | All 3 event types fire appropriately |
| AC-4 | Auto-save debounces at 500ms | Multiple rapid changes result in single save |
| AC-5 | Title auto-generates | First user message → title (max 50 chars) |
| AC-6 | Entity-domain mapping works | Round-trip preserves all data |
| AC-7 | Create saves dirty conversation | Switching saves unsaved changes |
| AC-8 | Load populates messages | LoadConversationAsync includes messages |
| AC-9 | Service is thread-safe | SemaphoreSlim prevents concurrent saves |
| AC-10 | Service is disposable | Timer and lock are properly disposed |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Auto-save timer race conditions | Low | Medium | SemaphoreSlim lock around save |
| Event handler memory leaks | Medium | Low | Implement IDisposable, document unsubscribe |
| Mapping misses properties | Low | High | Unit tests for round-trip mapping |
| Title generation edge cases | Low | Low | Handle null/empty, unicode, long text |

---

## Design Decisions

### Decision 1: 500ms Debounce Interval

**Decision:** Use 500ms delay for auto-save debouncing.
**Rationale:** Balances responsiveness (saves quickly after typing stops) with efficiency (doesn't save on every keystroke).

### Decision 2: SemaphoreSlim for Thread Safety

**Decision:** Use `SemaphoreSlim(1,1)` as async-compatible lock.
**Rationale:** Timer callbacks are asynchronous; `lock` statement doesn't work with async.

### Decision 3: Internal Methods for Service Use

**Decision:** Mark `LoadMessages()` and `MarkAsSaved()` as `internal`.
**Rationale:** These bypass normal mutation paths and should only be called by the service.

### Decision 4: Events for ViewModel Communication

**Decision:** Use events instead of direct ViewModel references.
**Rationale:** Loose coupling, testability, separation of concerns.

### Decision 5: Save Before Create/Load

**Decision:** Automatically save dirty conversation before switching.
**Rationale:** Prevents data loss without requiring explicit user action.

---

## Future Considerations

| Item | Target Version | Rationale |
|------|----------------|-----------|
| Full-text message search | v0.2.3+ | More complex search implementation |
| Conversation export/import | v0.3.0+ | JSON/Markdown export |
| Undo/redo for messages | v0.4.0+ | Complex state management |
| Conflict resolution | v0.5.0+ | Multi-device sync scenarios |

---

## Timeline Estimate

| Version | Estimated Effort | Key Deliverables |
|---------|------------------|------------------|
| v0.2.2a | 1-2 days | Service layer, models, events |

---

## References

- [Timer in .NET](https://learn.microsoft.com/en-us/dotnet/api/system.timers.timer)
- [SemaphoreSlim](https://learn.microsoft.com/en-us/dotnet/api/system.threading.semaphoreslim)
- [C# Events Best Practices](https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/events/)
- [Debouncing Explained](https://css-tricks.com/debouncing-throttling-explained-examples/)
