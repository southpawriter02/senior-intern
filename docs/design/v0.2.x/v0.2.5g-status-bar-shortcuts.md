# Design Specification: The Senior Intern v0.2.5g "Status Bar & Shortcuts"

## Executive Summary

This document provides a detailed implementation specification for v0.2.5g, which enhances the status bar with model info, token metrics, and save indicators, and implements global keyboard shortcuts for common operations. This is the final sub-part of v0.2.5, completing the "Polish & Integration" milestone.

### v0.2.5g Scope (from v0.2.5 Design Document)

- Create `StatusBarViewModel` with live metrics
- Display model name (clickable for model selection)
- Display token count and generation speed (tok/s)
- Display save status (Saved, Unsaved, Saving)
- Display current temperature (clickable for settings)
- Implement global keyboard shortcuts
- Create converters for status display

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| StatusBarViewModel | ViewModel with live metrics |
| TokenGeneratedEventArgs | Event for token counting |
| SaveStatus Enum | Saved, Unsaved, Saving states |
| Converters | Save status text/color, bool to color |
| Keyboard Shortcuts | 6 global shortcuts |
| Status Bar AXAML | Enhanced status bar UI |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.5g Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  StatusBarViewModel                                               │
│  ├── Properties                                                   │
│  │   ├── ModelName (string) - "llama-3.gguf"                     │
│  │   ├── IsModelLoaded (bool)                                     │
│  │   ├── TokenDisplay (string) - "234 (12.3 tok/s)"              │
│  │   ├── IsGenerating (bool)                                      │
│  │   ├── SaveStatus (SaveStatus) - Saved | Unsaved | Saving      │
│  │   └── Temperature (float) - 0.7                               │
│  │                                                                │
│  ├── Commands                                                     │
│  │   ├── OnModelClickCommand → opens model selector              │
│  │   └── OnTemperatureClickCommand → opens settings              │
│  │                                                                │
│  ├── Events                                                       │
│  │   ├── ModelClicked                                             │
│  │   └── TemperatureClicked                                       │
│  │                                                                │
│  ├── Methods                                                      │
│  │   ├── ResetTokenCount() - call on new generation              │
│  │   ├── GenerationComplete() - call when done                   │
│  │   ├── UpdateModelDisplay()                                     │
│  │   └── UpdateTokenDisplay()                                     │
│  │                                                                │
│  └── Event Subscriptions                                          │
│      ├── ILlmService.ModelStateChanged                            │
│      ├── ILlmService.TokenGenerated                               │
│      ├── IConversationService.SaveStatusChanged                   │
│      └── IInferenceSettingsService.SettingsChanged                │
│                                                                   │
│  SaveStatus (Enum)                                                │
│  ├── Saved (✓ Saved) - green                                     │
│  ├── Unsaved (● Unsaved) - yellow                                │
│  └── Saving (⟳ Saving...) - accent                               │
│                                                                   │
│  Keyboard Shortcuts                                               │
│  ├── Ctrl+K → Open Search                                        │
│  ├── Ctrl+N → New Conversation                                   │
│  ├── Ctrl+E → Export                                             │
│  ├── Ctrl+, → Open Settings                                      │
│  ├── Ctrl+P → System Prompt Editor                               │
│  └── Ctrl+Shift+S → Save Conversation                            │
│                                                                   │
│  Converters                                                       │
│  ├── SaveStatusConverter → status to text                        │
│  ├── SaveStatusColorConverter → status to color                  │
│  └── BoolToColorConverter → loaded state to color                │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Status Bar Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                    Status Bar Layout (28px height)               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Model: llama-3.gguf │ Tokens: 234 (12.3 tok/s) │ ✓ Saved │ T:0.7 │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Breakdown:                                                      │
│  ┌─────────────┬───┬──────────────────────┬───┬──────────┬───┬──────┐
│  │ [Model Name]│ │ │ Token Count + Speed  │   │ Save     │ │ │ Temp │
│  │ (clickable) │ │ │ (accent color)       │   │ Status   │ │ │ (clk)│
│  └─────────────┴───┴──────────────────────┴───┴──────────┴───┴──────┘
│        ▲                    ▲                     ▲            ▲
│        │                    │                     │            │
│  Opens model          Shows during           Color-coded   Opens
│  selection           generation              by status    settings
│                                                                  │
│  Colors:                                                         │
│  • Model loaded: Accent (#00d9ff)                                │
│  • Model not loaded: Muted gray                                  │
│  • Saved: Green (#4caf50)                                        │
│  • Unsaved: Yellow/Orange (#ffc107)                              │
│  • Saving: Accent (#00d9ff) with spinner                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Event Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Event Flow                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  LLM Service                                                     │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ GenerateStreamingAsync()                                  │    │
│  │   foreach token                                           │    │
│  │     → TokenGenerated event                                │    │
│  │   complete → GenerationComplete                           │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  StatusBarViewModel.OnTokenGenerated()                           │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ 1. _tokenCount++                                          │    │
│  │ 2. If first token: IsGenerating = true, start stopwatch   │    │
│  │ 3. UpdateTokenDisplay()                                   │    │
│  │    → "234 (12.3 tok/s)"                                   │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Conversation Service                                            │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ User types → SaveStatusChanged(Unsaved)                   │    │
│  │ AutoSave timer → SaveStatusChanged(Saving)                │    │
│  │ SaveAsync() complete → SaveStatusChanged(Saved)           │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  StatusBarViewModel.OnSaveStatusChanged()                        │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SaveStatus = e.Status                                     │    │
│  │ UI updates via binding + converter                        │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Events/
    └── LlmEvents.cs                                  (UPDATE - add TokenGenerated)

src/SeniorIntern.Desktop/
├── ViewModels/
│   ├── StatusBarViewModel.cs                         (NEW)
│   └── MainWindowViewModel.cs                        (UPDATE)
├── Views/
│   ├── MainWindow.axaml                              (UPDATE - status bar)
│   └── MainWindow.axaml.cs                           (UPDATE - shortcuts)
├── Converters/
│   ├── SaveStatusConverter.cs                        (NEW)
│   └── BoolToColorConverter.cs                       (NEW)
└── Themes/
    └── Dark.axaml                                    (UPDATE - status bar styles)
```

---

## Implementation Details

### Task 1: Add TokenGeneratedEventArgs

**File:** `src/SeniorIntern.Core/Events/LlmEvents.cs` (addition)

```csharp
namespace SeniorIntern.Core.Events;

/// <summary>Event args for token generation updates.</summary>
public sealed class TokenGeneratedEventArgs : EventArgs
{
    public required string Token { get; init; }
    public int TotalTokens { get; init; }
}
```

### Task 2: Create SaveStatus Enum and SaveStatusConverter

**File:** `src/SeniorIntern.Desktop/Converters/SaveStatusConverter.cs`

```csharp
namespace SeniorIntern.Desktop.Converters;

using Avalonia.Data.Converters;
using Avalonia.Media;
using System.Globalization;

public enum SaveStatus
{
    Saved,
    Unsaved,
    Saving
}

/// <summary>Converts SaveStatus to display text.</summary>
public sealed class SaveStatusConverter : IValueConverter
{
    public static readonly SaveStatusConverter Instance = new();

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        return value switch
        {
            SaveStatus.Saved => "✓ Saved",
            SaveStatus.Unsaved => "● Unsaved",
            SaveStatus.Saving => "⟳ Saving...",
            _ => ""
        };
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
        => throw new NotImplementedException();
}

/// <summary>Converts SaveStatus to color.</summary>
public sealed class SaveStatusColorConverter : IValueConverter
{
    public static readonly SaveStatusColorConverter Instance = new();

    private static readonly IBrush SavedBrush = new SolidColorBrush(Color.Parse("#4caf50"));
    private static readonly IBrush UnsavedBrush = new SolidColorBrush(Color.Parse("#ffc107"));
    private static readonly IBrush SavingBrush = new SolidColorBrush(Color.Parse("#00d9ff"));

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        return value switch
        {
            SaveStatus.Saved => SavedBrush,
            SaveStatus.Unsaved => UnsavedBrush,
            SaveStatus.Saving => SavingBrush,
            _ => Brushes.Gray
        };
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
        => throw new NotImplementedException();
}
```

---

### Task 3: Create BoolToColorConverter

**File:** `src/SeniorIntern.Desktop/Converters/BoolToColorConverter.cs`

```csharp
namespace SeniorIntern.Desktop.Converters;

using Avalonia.Data.Converters;
using Avalonia.Media;
using System.Globalization;

/// <summary>Converts bool to accent/muted color.</summary>
public sealed class BoolToColorConverter : IValueConverter
{
    public static readonly BoolToColorConverter Instance = new();

    private static readonly IBrush AccentBrush = new SolidColorBrush(Color.Parse("#00d9ff"));
    private static readonly IBrush MutedBrush = new SolidColorBrush(Color.Parse("#888888"));

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
        => value is true ? AccentBrush : MutedBrush;

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
        => throw new NotImplementedException();
}
```

---

### Task 4: Create StatusBarViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/StatusBarViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Desktop.Converters;
using System.Diagnostics;

public partial class StatusBarViewModel : ViewModelBase, IDisposable
{
    private readonly ILlmService _llmService;
    private readonly IConversationService _conversationService;
    private readonly IInferenceSettingsService _inferenceSettings;
    private readonly Stopwatch _generationStopwatch = new();
    private int _tokenCount;

    [ObservableProperty] private string _modelName = "No model loaded";
    [ObservableProperty] private bool _isModelLoaded;
    [ObservableProperty] private string _tokenDisplay = string.Empty;
    [ObservableProperty] private bool _isGenerating;
    [ObservableProperty] private SaveStatus _saveStatus = SaveStatus.Saved;
    [ObservableProperty] private float _temperature;

    public event EventHandler? ModelClicked;
    public event EventHandler? TemperatureClicked;

    public StatusBarViewModel(
        ILlmService llmService,
        IConversationService conversationService,
        IInferenceSettingsService inferenceSettings)
    {
        _llmService = llmService;
        _conversationService = conversationService;
        _inferenceSettings = inferenceSettings;

        // Subscribe to events
        _llmService.ModelStateChanged += OnModelStateChanged;
        _llmService.TokenGenerated += OnTokenGenerated;
        _conversationService.SaveStatusChanged += OnSaveStatusChanged;
        _inferenceSettings.SettingsChanged += OnInferenceSettingsChanged;

        // Initialize
        UpdateModelDisplay();
        Temperature = _inferenceSettings.CurrentOptions.Temperature;
    }

    private void OnModelStateChanged(object? sender, ModelStateChangedEventArgs e)
        => UpdateModelDisplay();

    private void OnTokenGenerated(object? sender, TokenGeneratedEventArgs e)
    {
        _tokenCount++;
        if (!IsGenerating)
        {
            IsGenerating = true;
            _generationStopwatch.Restart();
        }
        UpdateTokenDisplay();
    }

    private void OnSaveStatusChanged(object? sender, SaveStatusChangedEventArgs e)
        => SaveStatus = e.Status;

    private void OnInferenceSettingsChanged(object? sender, EventArgs e)
        => Temperature = _inferenceSettings.CurrentOptions.Temperature;

    private void UpdateModelDisplay()
    {
        IsModelLoaded = _llmService.IsModelLoaded;
        ModelName = IsModelLoaded && _llmService.CurrentModelPath is not null
            ? Path.GetFileName(_llmService.CurrentModelPath)
            : "No model loaded";
    }

    private void UpdateTokenDisplay()
    {
        var elapsed = _generationStopwatch.Elapsed.TotalSeconds;
        var tokensPerSecond = elapsed > 0 ? _tokenCount / elapsed : 0;
        TokenDisplay = $"{_tokenCount} ({tokensPerSecond:F1} tok/s)";
    }

    public void ResetTokenCount()
    {
        _tokenCount = 0;
        IsGenerating = false;
        _generationStopwatch.Reset();
        TokenDisplay = string.Empty;
    }

    public void GenerationComplete()
    {
        _generationStopwatch.Stop();
        IsGenerating = false;
        UpdateTokenDisplay();
    }

    [RelayCommand] private void OnModelClick() => ModelClicked?.Invoke(this, EventArgs.Empty);
    [RelayCommand] private void OnTemperatureClick() => TemperatureClicked?.Invoke(this, EventArgs.Empty);

    public void Dispose()
    {
        _llmService.ModelStateChanged -= OnModelStateChanged;
        _llmService.TokenGenerated -= OnTokenGenerated;
        _conversationService.SaveStatusChanged -= OnSaveStatusChanged;
        _inferenceSettings.SettingsChanged -= OnInferenceSettingsChanged;
    }
}
```

---

### Task 5: Update MainWindow Status Bar

**File:** `src/SeniorIntern.Desktop/Views/MainWindow.axaml` (status bar section)

```xml
<!-- Status Bar (Grid.Row="2") -->
<Border Grid.Row="2" Background="{DynamicResource SidebarBackgroundColor}"
        Height="28" Padding="12,0">
    <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto,Auto,Auto">
        <!-- Model Name (Clickable) -->
        <Button Grid.Column="0" Command="{Binding StatusBar.OnModelClickCommand}"
                Background="Transparent" Padding="8,4"
                ToolTip.Tip="Click to change model">
            <StackPanel Orientation="Horizontal" Spacing="6">
                <TextBlock Text="Model:" Opacity="0.6" />
                <TextBlock Text="{Binding StatusBar.ModelName}"
                           Foreground="{Binding StatusBar.IsModelLoaded, 
                                        Converter={StaticResource BoolToColorConverter}}" />
            </StackPanel>
        </Button>

        <Border Grid.Column="1" Width="1" Background="{DynamicResource BorderColor}" Margin="8,4" />

        <!-- Token Counter -->
        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6"
                    IsVisible="{Binding StatusBar.TokenDisplay, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <TextBlock Text="Tokens:" Opacity="0.6" />
            <TextBlock Text="{Binding StatusBar.TokenDisplay}" Foreground="{DynamicResource AccentColor}" />
        </StackPanel>

        <!-- Save Status -->
        <TextBlock Grid.Column="3" Margin="8,0"
                   Text="{Binding StatusBar.SaveStatus, Converter={StaticResource SaveStatusConverter}}"
                   Foreground="{Binding StatusBar.SaveStatus, Converter={StaticResource SaveStatusColorConverter}}" />

        <Border Grid.Column="4" Width="1" Background="{DynamicResource BorderColor}" Margin="8,4" />

        <!-- Temperature (Clickable) -->
        <Button Grid.Column="5" Command="{Binding StatusBar.OnTemperatureClickCommand}"
                Background="Transparent" Padding="8,4"
                ToolTip.Tip="Click to adjust inference settings">
            <StackPanel Orientation="Horizontal" Spacing="4">
                <TextBlock Text="T:" Opacity="0.6" />
                <TextBlock Text="{Binding StatusBar.Temperature, StringFormat='{}{0:F1}'}"
                           Foreground="{DynamicResource AccentColor}" />
            </StackPanel>
        </Button>
    </Grid>
</Border>
```

---

### Task 6: Configure Keyboard Shortcuts

**File:** `src/SeniorIntern.Desktop/Views/MainWindow.axaml.cs` (update)

```csharp
public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
        ConfigureKeyboardShortcuts();
    }

    private void ConfigureKeyboardShortcuts()
    {
        // Ctrl+K → Search
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.K, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.OpenSearchCommand.Execute(null))
        });

        // Ctrl+N → New Conversation
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.N, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.NewConversationCommand.Execute(null))
        });

        // Ctrl+E → Export
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.E, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.ExportCommand.Execute(null))
        });

        // Ctrl+, → Settings
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.OemComma, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.OpenSettingsCommand.Execute(null))
        });

        // Ctrl+P → System Prompt Editor
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.P, KeyModifiers.Control),
            Command = new RelayCommand(() => ViewModel?.OpenSystemPromptEditorCommand.Execute(null))
        });

        // Ctrl+Shift+S → Save Conversation
        KeyBindings.Add(new KeyBinding
        {
            Gesture = new KeyGesture(Key.S, KeyModifiers.Control | KeyModifiers.Shift),
            Command = new RelayCommand(() => ViewModel?.SaveConversationCommand.Execute(null))
        });
    }

    private MainWindowViewModel? ViewModel => DataContext as MainWindowViewModel;
}
```

---

## Keyboard Shortcuts Summary

| Shortcut | Action | Command |
|----------|--------|---------|
| `Ctrl+K` | Open Search | OpenSearchCommand |
| `Ctrl+N` | New Conversation | NewConversationCommand |
| `Ctrl+E` | Export Conversation | ExportCommand |
| `Ctrl+,` | Open Settings | OpenSettingsCommand |
| `Ctrl+P` | System Prompt Editor | OpenSystemPromptEditorCommand |
| `Ctrl+Shift+S` | Save Conversation | SaveConversationCommand |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| OnTokenGenerated | 3 | First token, subsequent, speed calc |
| UpdateModelDisplay | 2 | Loaded, not loaded |
| OnSaveStatusChanged | 3 | Each status value |
| SaveStatusConverter | 3 | Each status to text |
| SaveStatusColorConverter | 3 | Each status to color |
| BoolToColorConverter | 2 | True, false |
| **Total** | **16** | |

### Key Test Scenarios

```csharp
[Fact]
public void OnTokenGenerated_FirstToken_StartsStopwatch()
{
    var vm = CreateStatusBarViewModel();
    Assert.False(vm.IsGenerating);
    
    RaiseTokenGenerated(vm);
    
    Assert.True(vm.IsGenerating);
    Assert.Equal("1 (0.0 tok/s)", vm.TokenDisplay); // First token, no time yet
}

[Fact]
public void UpdateModelDisplay_WhenLoaded_ShowsFilename()
{
    var mockLlm = CreateMockLlmService(loaded: true, path: "/models/llama-3.gguf");
    var vm = new StatusBarViewModel(mockLlm, ...);
    
    Assert.Equal("llama-3.gguf", vm.ModelName);
    Assert.True(vm.IsModelLoaded);
}

[Fact]
public void SaveStatusConverter_Saved_ReturnsCheckmark()
{
    var converter = new SaveStatusConverter();
    var result = converter.Convert(SaveStatus.Saved, typeof(string), null, null);
    Assert.Equal("✓ Saved", result);
}

[Fact]
public void SaveStatusColorConverter_Unsaved_ReturnsYellow()
{
    var converter = new SaveStatusColorConverter();
    var result = converter.Convert(SaveStatus.Unsaved, typeof(IBrush), null, null) as SolidColorBrush;
    Assert.Equal(Color.Parse("#ffc107"), result?.Color);
}
```

---

## Files Summary

### Files to Create (3)

| File | Lines (approx) |
|------|----------------|
| `ViewModels/StatusBarViewModel.cs` | 120 |
| `Converters/SaveStatusConverter.cs` | 60 |
| `Converters/BoolToColorConverter.cs` | 25 |

### Files to Modify (4)

| File | Changes |
|------|---------|
| `Core/Events/LlmEvents.cs` | Add TokenGeneratedEventArgs |
| `Views/MainWindow.axaml` | Update status bar section |
| `Views/MainWindow.axaml.cs` | Add keyboard shortcut configuration |
| `ViewModels/MainWindowViewModel.cs` | Add StatusBar property |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Status bar shows model name |
| AC-2 | Clicking model name opens model selector |
| AC-3 | Token count updates during generation |
| AC-4 | Token speed (tok/s) calculated correctly |
| AC-5 | Save status shows correct icon and color |
| AC-6 | Temperature displays current value |
| AC-7 | Clicking temperature opens settings |
| AC-8 | All 6 keyboard shortcuts work |
| AC-9 | Converters produce correct output |
| AC-10 | Status bar updates in real-time |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Stopwatch for tok/s | Accurate timing without timer overhead |
| Event-driven updates | Reactive, no polling |
| Clickable status items | Direct access to related features |
| Status icons (✓ ● ⟳) | Visual differentiation at a glance |
| Code-behind shortcuts | Avalonia KeyBindings require code |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.5g | 1 day |

---

## v0.2.5 Complete Summary

With v0.2.5g complete, the entire v0.2.5 "Polish & Integration" milestone is done:

| Part | Name | Focus |
|------|------|-------|
| v0.2.5a | FTS5 Search Infrastructure | Virtual tables, triggers, models |
| v0.2.5b | Search Service | ISearchService with FTS5 queries |
| v0.2.5c | Export Service | IExportService with 4 formats |
| v0.2.5d | Migration Service | v0.1.0 → v0.2.0 migration |
| v0.2.5e | Search UI | SearchDialog with keyboard nav |
| v0.2.5f | Export UI | ExportDialog with live preview |
| **v0.2.5g** | **Status Bar & Shortcuts** | **Live metrics, 6 shortcuts** |

**Total Files Created:** 24  
**Total Files Modified:** 9  
**Estimated Total Effort:** 5-7 days
