# Design Specification: The Senior Intern v0.2.5d "Migration Service"

## Executive Summary

This document provides a detailed implementation specification for v0.2.5d, which implements settings migration from v0.1.0 (JSON file) to v0.2.0 (SQLite database). The `MigrationService` automatically detects legacy settings, backs them up, migrates configuration to the new schema, seeds default data, and stamps the database version.

### v0.2.5d Scope (from v0.2.5 Design Document)

- Create `MigrationResult` model for migration status
- Create `LegacySettings` model for v0.1.0 format parsing
- Create `AppVersionEntity` for version tracking
- Create `IMigrationService` interface
- Implement `MigrationService` with multi-step migration
- Run migration on application startup

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| MigrationResult | Result record with steps and status |
| LegacySettings | v0.1.0 settings format model |
| AppVersionEntity | Database version tracking |
| IMigrationService | Service interface |
| MigrationService | Full migration implementation |
| Startup Integration | Auto-run on app launch |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.5d Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Migration Models                                                 │
│  ├── MigrationResult (record)                                     │
│  │   ├── Success (bool)                                           │
│  │   ├── FromVersion (Version)                                    │
│  │   ├── ToVersion (Version)                                      │
│  │   ├── MigrationSteps (IReadOnlyList<string>)                   │
│  │   └── ErrorMessage (string?)                                   │
│  │                                                                │
│  ├── LegacySettings (v0.1.0 format)                               │
│  │   ├── LastModelPath (string?)                                  │
│  │   ├── DefaultContextSize (uint) = 4096                         │
│  │   ├── DefaultGpuLayers (int) = -1                              │
│  │   ├── Temperature (float) = 0.7                                │
│  │   └── Theme (string) = "Dark"                                  │
│  │                                                                │
│  └── AppVersionEntity                                             │
│      ├── Id (int, PK)                                             │
│      ├── Major, Minor, Patch (int)                                │
│      └── MigratedAt (DateTime)                                    │
│                                                                   │
│  IMigrationService                                                │
│  ├── MigrateIfNeededAsync() → MigrationResult                     │
│  ├── GetCurrentVersion() → Version                                │
│  └── IsMigrationRequired() → bool                                 │
│                                                                   │
│  MigrationService                                                 │
│  ├── Migration Steps                                              │
│  │   1. Check if migration needed                                 │
│  │   2. Backup settings.json → settings.v1.json.bak               │
│  │   3. Read legacy settings                                      │
│  │   4. Ensure database exists                                    │
│  │   5. Migrate settings to new schema                            │
│  │   6. Create default system prompts                             │
│  │   7. Create default inference presets                          │
│  │   8. Stamp version in database                                 │
│  │                                                                │
│  └── Detection Logic                                              │
│      ├── settings.json exists? (legacy indicator)                 │
│      ├── Database can connect?                                    │
│      └── Version < 0.2.0?                                         │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Migration Decision Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   Migration Decision Flow                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Application Startup                                             │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ IMigrationService.IsMigrationRequired()                   │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│         ┌────────────────────┼────────────────────┐              │
│         ▼                    ▼                    ▼              │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐       │
│  │ No settings │      │ DB exists   │      │ settings.json│      │
│  │ .json file  │      │ version OK  │      │ exists, DB   │      │
│  │             │      │             │      │ needs update │      │
│  └──────┬──────┘      └──────┬──────┘      └──────┬──────┘       │
│         │                    │                    │              │
│         ▼                    ▼                    ▼              │
│     NO MIGRATION        NO MIGRATION        RUN MIGRATION        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Migration Step Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Migration Step Flow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  MigrateIfNeededAsync()                                          │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 1: IsMigrationRequired()                             │    │
│  │   → Check for settings.json + database version            │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │ Required                          │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 2: BackupLegacySettingsAsync()                       │    │
│  │   → Copy settings.json → settings.v1.json.bak             │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 3: ReadLegacySettingsAsync()                         │    │
│  │   → Deserialize JSON to LegacySettings                    │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 4: Database.MigrateAsync()                           │    │
│  │   → Ensure database schema is up to date                  │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 5: MigrateSettingsAsync()                            │    │
│  │   → Create AppSettingsEntity from LegacySettings          │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 6: CreateDefaultSystemPromptsAsync()                 │    │
│  │   → Seed built-in system prompts                          │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 7: CreateDefaultPresetsAsync()                       │    │
│  │   → Seed inference presets (Precise, Balanced, Creative)  │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Step 8: MarkMigrationCompleteAsync()                      │    │
│  │   → Write AppVersionEntity { 0, 2, 0 }                    │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│                   MigrationResult { Success: true }              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Entities/
│   └── AppVersionEntity.cs                           (NEW)
├── Interfaces/
│   └── IMigrationService.cs                          (NEW)
└── Models/
    ├── MigrationResult.cs                            (NEW)
    └── LegacySettings.cs                             (NEW)

src/SeniorIntern.Data/
├── Configurations/
│   └── AppVersionConfiguration.cs                    (NEW)
└── SeniorInternDbContext.cs                          (UPDATE)

src/SeniorIntern.Services/
└── MigrationService.cs                               (NEW)

src/SeniorIntern.Desktop/
└── App.axaml.cs                                      (UPDATE)
```

---

## Implementation Details

### Task 1: Create MigrationResult Model

**File:** `src/SeniorIntern.Core/Models/MigrationResult.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Result of a migration operation.</summary>
public sealed record MigrationResult(
    bool Success,
    Version FromVersion,
    Version ToVersion,
    IReadOnlyList<string> MigrationSteps,
    string? ErrorMessage
)
{
    /// <summary>Creates a successful result with no migration needed.</summary>
    public static MigrationResult NoMigrationNeeded(Version current) => new(
        Success: true,
        FromVersion: current,
        ToVersion: current,
        MigrationSteps: ["No migration needed"],
        ErrorMessage: null
    );

    /// <summary>Creates a failed result with error.</summary>
    public static MigrationResult Failed(
        Version from,
        Version to,
        IReadOnlyList<string> steps,
        string error) => new(
        Success: false,
        FromVersion: from,
        ToVersion: to,
        MigrationSteps: steps,
        ErrorMessage: error
    );
}
```

---

### Task 2: Create LegacySettings Model

**File:** `src/SeniorIntern.Core/Models/LegacySettings.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>v0.1.0 settings format (for migration).</summary>
internal sealed class LegacySettings
{
    /// <summary>Last loaded model file path.</summary>
    public string? LastModelPath { get; set; }

    /// <summary>Default context size for inference.</summary>
    public uint DefaultContextSize { get; set; } = 4096;

    /// <summary>GPU layers to offload (-1 = all).</summary>
    public int DefaultGpuLayers { get; set; } = -1;

    /// <summary>Default temperature parameter.</summary>
    public float Temperature { get; set; } = 0.7f;

    /// <summary>UI theme name.</summary>
    public string Theme { get; set; } = "Dark";
}
```

---

### Task 3: Create AppVersionEntity

**File:** `src/SeniorIntern.Core/Entities/AppVersionEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>Tracks application version for migration purposes.</summary>
public sealed class AppVersionEntity
{
    public int Id { get; set; }
    public int Major { get; set; }
    public int Minor { get; set; }
    public int Patch { get; set; }
    public DateTime MigratedAt { get; set; }

    /// <summary>Gets the version as a Version object.</summary>
    public Version ToVersion() => new(Major, Minor, Patch);
}
```

---

### Task 4: Create IMigrationService Interface

**File:** `src/SeniorIntern.Core/Interfaces/IMigrationService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>Handles migration between application versions.</summary>
public interface IMigrationService
{
    /// <summary>Checks if migration is required and performs it if needed.</summary>
    Task<MigrationResult> MigrateIfNeededAsync(CancellationToken cancellationToken = default);

    /// <summary>Gets the current application version from the database.</summary>
    Version GetCurrentVersion();

    /// <summary>Checks if migration is required without performing it.</summary>
    bool IsMigrationRequired();
}
```

---

### Task 5: Implement MigrationService

**File:** `src/SeniorIntern.Services/MigrationService.cs`

```csharp
namespace SeniorIntern.Services;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Core.Templates;
using SeniorIntern.Data;
using SeniorIntern.Data.Repositories;
using System.Text.Json;

public sealed class MigrationService : IMigrationService
{
    private static readonly Version CurrentVersion = new(0, 2, 0);
    private static readonly Version LegacyVersion = new(0, 1, 0);

    private readonly SeniorInternDbContext _dbContext;
    private readonly ISystemPromptRepository _systemPromptRepository;
    private readonly IInferencePresetRepository _presetRepository;
    private readonly ILogger<MigrationService> _logger;
    private readonly string _settingsPath;
    private readonly string _backupPath;

    public MigrationService(
        SeniorInternDbContext dbContext,
        ISystemPromptRepository systemPromptRepository,
        IInferencePresetRepository presetRepository,
        ILogger<MigrationService> logger)
    {
        _dbContext = dbContext;
        _systemPromptRepository = systemPromptRepository;
        _presetRepository = presetRepository;
        _logger = logger;

        var appData = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var appFolder = Path.Combine(appData, "SeniorIntern");
        _settingsPath = Path.Combine(appFolder, "settings.json");
        _backupPath = Path.Combine(appFolder, "settings.v1.json.bak");
    }

    public async Task<MigrationResult> MigrateIfNeededAsync(CancellationToken cancellationToken = default)
    {
        var steps = new List<string>();

        try
        {
            if (!IsMigrationRequired())
            {
                _logger.LogInformation("No migration required");
                return MigrationResult.NoMigrationNeeded(CurrentVersion);
            }

            _logger.LogInformation("Starting migration from v0.1.0 to v0.2.0");

            steps.Add("Backing up v0.1.0 settings");
            await BackupLegacySettingsAsync(cancellationToken);

            steps.Add("Reading legacy settings");
            var legacySettings = await ReadLegacySettingsAsync(cancellationToken);

            steps.Add("Ensuring database exists");
            await _dbContext.Database.MigrateAsync(cancellationToken);

            steps.Add("Migrating settings to database");
            await MigrateSettingsAsync(legacySettings, cancellationToken);

            steps.Add("Creating default system prompts");
            await CreateDefaultSystemPromptsAsync(cancellationToken);

            steps.Add("Creating default inference presets");
            await CreateDefaultPresetsAsync(cancellationToken);

            steps.Add("Marking migration complete");
            await MarkMigrationCompleteAsync(cancellationToken);

            _logger.LogInformation("Migration completed successfully");

            return new MigrationResult(
                Success: true,
                FromVersion: LegacyVersion,
                ToVersion: CurrentVersion,
                MigrationSteps: steps,
                ErrorMessage: null);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Migration failed");
            steps.Add($"FAILED: {ex.Message}");
            return MigrationResult.Failed(LegacyVersion, CurrentVersion, steps, ex.Message);
        }
    }

    public Version GetCurrentVersion()
    {
        try
        {
            var versionRecord = _dbContext.Set<AppVersionEntity>().FirstOrDefault();
            return versionRecord?.ToVersion() ?? LegacyVersion;
        }
        catch
        {
            return LegacyVersion;
        }
    }

    public bool IsMigrationRequired()
    {
        if (!File.Exists(_settingsPath))
            return false;

        try
        {
            if (!_dbContext.Database.CanConnect())
                return true;

            return GetCurrentVersion() < CurrentVersion;
        }
        catch
        {
            return true;
        }
    }

    // Private helper methods: BackupLegacySettingsAsync, ReadLegacySettingsAsync,
    // MigrateSettingsAsync, CreateDefaultSystemPromptsAsync, 
    // CreateDefaultPresetsAsync, MarkMigrationCompleteAsync
}
```

---

### Task 6: Add Startup Integration

**File:** `src/SeniorIntern.Desktop/App.axaml.cs` (update)

```csharp
public override async void OnFrameworkInitializationCompleted()
{
    if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
    {
        // Run migration before showing main window
        var migrationService = _serviceProvider.GetRequiredService<IMigrationService>();
        var result = await migrationService.MigrateIfNeededAsync();
        
        if (!result.Success)
        {
            _logger.LogError("Migration failed: {Error}", result.ErrorMessage);
            // Could show error dialog here
        }

        desktop.MainWindow = new MainWindow
        {
            DataContext = _serviceProvider.GetRequiredService<MainWindowViewModel>()
        };
    }

    base.OnFrameworkInitializationCompleted();
}
```

---

## Default Data Created by Migration

### Default Inference Presets

| Name | Temperature | TopP | MaxTokens | Description |
|------|-------------|------|-----------|-------------|
| Precise | 0.3 | 0.85 | 2048 | Low creativity, focused |
| **Balanced** | 0.7 | 0.9 | 2048 | Default preset |
| Creative | 1.0 | 0.95 | 4096 | High creativity |
| Long-form | 0.7 | 0.9 | 8192 | Extended responses |

### System Prompts

All templates from `SystemPromptTemplates.GetAllTemplates()` including:
- Default Assistant
- The Senior Intern (default)
- Code Expert
- And others...

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| IsMigrationRequired | 4 | No file, has DB, needs update |
| GetCurrentVersion | 2 | Found, not found |
| MigrateIfNeededAsync | 6 | Full flow, error handling |
| Backup/Read | 2 | File operations |
| **Total** | **14** | |

### Key Test Scenarios

```csharp
[Fact]
public void IsMigrationRequired_NoSettingsFile_ReturnsFalse()
{
    var service = CreateService(settingsFileExists: false);
    Assert.False(service.IsMigrationRequired());
}

[Fact]
public void IsMigrationRequired_HasSettingsAndNoDb_ReturnsTrue()
{
    var service = CreateService(settingsFileExists: true, dbExists: false);
    Assert.True(service.IsMigrationRequired());
}

[Fact]
public void IsMigrationRequired_DbVersionCurrent_ReturnsFalse()
{
    var service = CreateService(settingsFileExists: true, dbVersion: new Version(0, 2, 0));
    Assert.False(service.IsMigrationRequired());
}

[Fact]
public async Task MigrateIfNeededAsync_NoMigrationNeeded_ReturnsSuccess()
{
    var service = CreateService(settingsFileExists: false);
    var result = await service.MigrateIfNeededAsync();
    
    Assert.True(result.Success);
    Assert.Contains("No migration needed", result.MigrationSteps);
}

[Fact]
public async Task MigrateIfNeededAsync_CreatesBackup()
{
    var service = CreateService(settingsFileExists: true);
    await service.MigrateIfNeededAsync();
    
    Assert.True(File.Exists(_backupPath));
}

[Fact]
public async Task MigrateIfNeededAsync_SeedsDefaultData()
{
    var service = CreateService(settingsFileExists: true, dbExists: false);
    await service.MigrateIfNeededAsync();
    
    Assert.True(await _dbContext.Set<InferencePresetEntity>().AnyAsync());
    Assert.True(await _dbContext.Set<SystemPromptEntity>().AnyAsync());
}
```

---

## Files Summary

### Files to Create (5)

| File | Lines (approx) |
|------|----------------|
| `Core/Models/MigrationResult.cs` | 35 |
| `Core/Models/LegacySettings.cs` | 25 |
| `Core/Entities/AppVersionEntity.cs` | 20 |
| `Core/Interfaces/IMigrationService.cs` | 20 |
| `Services/MigrationService.cs` | 180 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `Data/SeniorInternDbContext.cs` | Add DbSet<AppVersionEntity> |
| `Desktop/App.axaml.cs` | Run migration on startup |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Migration detects settings.json existence |
| AC-2 | Migration checks database version |
| AC-3 | Legacy settings are backed up before migration |
| AC-4 | Settings are migrated to new schema |
| AC-5 | Default system prompts are seeded |
| AC-6 | Default inference presets are seeded |
| AC-7 | Version is stamped in database |
| AC-8 | Migration runs automatically on startup |
| AC-9 | Failed migration returns error result |
| AC-10 | No migration runs if already current |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Backup before migration | Data safety, rollback possible |
| Version entity in DB | Persistent version tracking |
| Skip if already current | Idempotent, safe to re-run |
| Seed default data | First-run experience |
| Run on startup | Automatic, transparent to user |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.5d | 0.5-1 day |
