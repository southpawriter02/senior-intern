# Design Specification: The Senior Intern v0.2.1 "Database Foundation"

## Executive Summary

This document provides a comprehensive design specification for v0.2.1, which establishes the SQLite database layer using Entity Framework Core. This sub-version creates the foundation for all persistent storage features in v0.2.0, including conversation history, system prompts, and inference presets.

### v0.2.1 Scope (from v0.2.0 Design Document)
- SQLite setup with Entity Framework Core
- Entity classes for Conversations, Messages, SystemPrompts, and InferencePresets
- Database migrations infrastructure
- Repository pattern implementation

---

## Sub-Part Breakdown

| Part | Name | Focus |
|------|------|-------|
| v0.2.1a | Project Setup | Create Data project, configure EF Core, database path resolution |
| v0.2.1b | Entity Classes | Define all entity classes in Core project with proper relationships |
| v0.2.1c | DbContext & Configuration | Implement DbContext with Fluent API configurations |
| v0.2.1d | Repository Layer | Create repository interfaces and implementations |
| v0.2.1e | Initialization & Seeding | Database creation, migrations, seed data for defaults |

---

## v0.2.1a: Project Setup

### Objective
Create the new `SeniorIntern.Data` project, configure Entity Framework Core with SQLite, and implement cross-platform database path resolution.

### New Project Creation

```
src/SeniorIntern.Data/
├── SeniorIntern.Data.csproj
└── (empty, ready for classes)
```

### SeniorIntern.Data.csproj

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <LangVersion>12.0</LangVersion>
  </PropertyGroup>

  <ItemGroup>
    <!-- Entity Framework Core -->
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.0.11" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.11">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>

    <!-- Logging -->
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="8.0.2" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\SeniorIntern.Core\SeniorIntern.Core.csproj" />
  </ItemGroup>

</Project>
```

### Directory.Packages.props Update

Add new packages to central package management:

```xml
<!-- Entity Framework Core -->
<PackageVersion Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.0.11" />
<PackageVersion Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.11" />
<PackageVersion Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.11" />
```

### Database Path Resolution

```csharp
namespace SeniorIntern.Data;

/// <summary>
/// Resolves database file paths based on the current platform
/// </summary>
public static class DatabasePathResolver
{
    private const string AppName = "SeniorIntern";
    private const string DatabaseFileName = "seniorintern.db";

    /// <summary>
    /// Gets the full path to the database file for the current platform
    /// </summary>
    public static string GetDatabasePath()
    {
        var baseDir = GetApplicationDataDirectory();
        Directory.CreateDirectory(baseDir); // Ensure directory exists
        return Path.Combine(baseDir, DatabaseFileName);
    }

    /// <summary>
    /// Gets the application data directory for the current platform
    /// </summary>
    public static string GetApplicationDataDirectory()
    {
        if (OperatingSystem.IsWindows())
        {
            // Windows: %AppData%/SeniorIntern/
            var appData = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
            return Path.Combine(appData, AppName);
        }
        else if (OperatingSystem.IsMacOS())
        {
            // macOS: ~/Library/Application Support/SeniorIntern/
            var home = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
            return Path.Combine(home, "Library", "Application Support", AppName);
        }
        else
        {
            // Linux: ~/.config/SeniorIntern/
            var home = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
            return Path.Combine(home, ".config", AppName);
        }
    }

    /// <summary>
    /// Gets the SQLite connection string for the database
    /// </summary>
    public static string GetConnectionString()
    {
        var dbPath = GetDatabasePath();
        return $"Data Source={dbPath}";
    }

    /// <summary>
    /// Gets the backup path for the database (used during migrations)
    /// </summary>
    public static string GetBackupPath()
    {
        var dbPath = GetDatabasePath();
        var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
        return Path.Combine(
            Path.GetDirectoryName(dbPath)!,
            $"seniorintern_backup_{timestamp}.db");
    }
}
```

### Solution File Update

Add new project to `SeniorIntern.sln`:

```
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SeniorIntern.Data", "src\SeniorIntern.Data\SeniorIntern.Data.csproj", "{NEW-GUID-HERE}"
EndProject
```

### Project Reference Updates

Update `SeniorIntern.Services.csproj`:
```xml
<ItemGroup>
  <ProjectReference Include="..\SeniorIntern.Core\SeniorIntern.Core.csproj" />
  <ProjectReference Include="..\SeniorIntern.Data\SeniorIntern.Data.csproj" />
</ItemGroup>
```

Update `SeniorIntern.Desktop.csproj`:
```xml
<ItemGroup>
  <ProjectReference Include="..\SeniorIntern.Core\SeniorIntern.Core.csproj" />
  <ProjectReference Include="..\SeniorIntern.Services\SeniorIntern.Services.csproj" />
  <ProjectReference Include="..\SeniorIntern.Data\SeniorIntern.Data.csproj" />
</ItemGroup>
```

### v0.2.1a Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Data/SeniorIntern.Data.csproj` | New project file |
| `src/SeniorIntern.Data/DatabasePathResolver.cs` | Cross-platform path resolution |

### v0.2.1a Files to Modify

| File | Changes |
|------|---------|
| `SeniorIntern.sln` | Add Data project |
| `Directory.Packages.props` | Add EF Core packages |
| `src/SeniorIntern.Services/SeniorIntern.Services.csproj` | Add Data project reference |
| `src/SeniorIntern.Desktop/SeniorIntern.Desktop.csproj` | Add Data project reference |

### v0.2.1a Verification

```bash
# Verify project builds
dotnet build src/SeniorIntern.Data

# Verify solution builds
dotnet build SeniorIntern.sln

# Verify path resolution (add temporary test)
dotnet run --project src/SeniorIntern.Desktop -- --test-db-path
```

---

## v0.2.1b: Entity Classes

### Objective
Define all entity classes in the Core project with proper relationships, enums, and validation attributes.

### Entity Class Locations

```
src/SeniorIntern.Core/
├── Entities/
│   ├── ConversationEntity.cs
│   ├── MessageEntity.cs
│   ├── SystemPromptEntity.cs
│   └── InferencePresetEntity.cs
└── Enums/
    └── MessageRole.cs  (may already exist, verify/update)
```

### MessageRole Enum

```csharp
namespace SeniorIntern.Core.Enums;

/// <summary>
/// Defines the role of a message in a conversation
/// </summary>
public enum MessageRole
{
    /// <summary>
    /// System instructions that define the assistant's behavior
    /// </summary>
    System = 0,

    /// <summary>
    /// Messages from the human user
    /// </summary>
    User = 1,

    /// <summary>
    /// Messages from the AI assistant
    /// </summary>
    Assistant = 2
}
```

### ConversationEntity

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Represents a conversation (chat session) stored in the database
/// </summary>
public sealed class ConversationEntity
{
    /// <summary>
    /// Unique identifier for the conversation
    /// </summary>
    public Guid Id { get; set; }

    /// <summary>
    /// Display title for the conversation
    /// Auto-generated from first user message if not set
    /// </summary>
    public string Title { get; set; } = "New Conversation";

    /// <summary>
    /// When the conversation was created
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// When the conversation was last modified (message added/edited)
    /// </summary>
    public DateTime UpdatedAt { get; set; }

    /// <summary>
    /// Reference to the system prompt used for this conversation
    /// Null means using the default system prompt
    /// </summary>
    public Guid? SystemPromptId { get; set; }

    /// <summary>
    /// Path to the model file used for this conversation
    /// Stored for reference/display purposes
    /// </summary>
    public string? ModelPath { get; set; }

    /// <summary>
    /// Model name (extracted from path or user-defined)
    /// </summary>
    public string? ModelName { get; set; }

    /// <summary>
    /// Whether the conversation is archived (hidden from main list)
    /// </summary>
    public bool IsArchived { get; set; }

    /// <summary>
    /// Whether the conversation is pinned to the top
    /// </summary>
    public bool IsPinned { get; set; }

    /// <summary>
    /// Denormalized message count for efficient list display
    /// Updated via trigger or application logic
    /// </summary>
    public int MessageCount { get; set; }

    /// <summary>
    /// Total tokens used in this conversation (approximate)
    /// </summary>
    public int TotalTokenCount { get; set; }

    // Navigation properties

    /// <summary>
    /// The system prompt associated with this conversation
    /// </summary>
    public SystemPromptEntity? SystemPrompt { get; set; }

    /// <summary>
    /// All messages in this conversation, ordered by SequenceNumber
    /// </summary>
    public ICollection<MessageEntity> Messages { get; set; } = new List<MessageEntity>();
}
```

### MessageEntity

```csharp
namespace SeniorIntern.Core.Entities;

using SeniorIntern.Core.Enums;

/// <summary>
/// Represents a single message within a conversation
/// </summary>
public sealed class MessageEntity
{
    /// <summary>
    /// Unique identifier for the message
    /// </summary>
    public Guid Id { get; set; }

    /// <summary>
    /// The conversation this message belongs to
    /// </summary>
    public Guid ConversationId { get; set; }

    /// <summary>
    /// The role of the message sender (System, User, Assistant)
    /// </summary>
    public MessageRole Role { get; set; }

    /// <summary>
    /// The text content of the message
    /// </summary>
    public string Content { get; set; } = string.Empty;

    /// <summary>
    /// When the message was created
    /// </summary>
    public DateTime Timestamp { get; set; }

    /// <summary>
    /// Number of tokens in this message (if calculated)
    /// Null if not yet calculated
    /// </summary>
    public int? TokenCount { get; set; }

    /// <summary>
    /// Time taken to generate this message in milliseconds
    /// Only applicable for Assistant messages
    /// </summary>
    public int? GenerationTimeMs { get; set; }

    /// <summary>
    /// Tokens per second during generation
    /// Only applicable for Assistant messages
    /// </summary>
    public float? TokensPerSecond { get; set; }

    /// <summary>
    /// Order of this message within the conversation
    /// Used to maintain message ordering
    /// </summary>
    public int SequenceNumber { get; set; }

    /// <summary>
    /// Whether this message has been edited after creation
    /// </summary>
    public bool IsEdited { get; set; }

    /// <summary>
    /// When the message was last edited (if edited)
    /// </summary>
    public DateTime? EditedAt { get; set; }

    /// <summary>
    /// Whether the message generation was completed
    /// False if generation was cancelled mid-stream
    /// </summary>
    public bool IsComplete { get; set; } = true;

    // Navigation property

    /// <summary>
    /// The conversation this message belongs to
    /// </summary>
    public ConversationEntity Conversation { get; set; } = null!;
}
```

### SystemPromptEntity

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Represents a system prompt that defines the assistant's behavior
/// </summary>
public sealed class SystemPromptEntity
{
    /// <summary>
    /// Unique identifier for the system prompt
    /// </summary>
    public Guid Id { get; set; }

    /// <summary>
    /// Display name for the prompt (must be unique)
    /// </summary>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// The actual system prompt text
    /// </summary>
    public string Content { get; set; } = string.Empty;

    /// <summary>
    /// Optional description of what this prompt does
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// Category for organization (General, Code, Creative, Technical)
    /// </summary>
    public string Category { get; set; } = "General";

    /// <summary>
    /// When the prompt was created
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// When the prompt was last modified
    /// </summary>
    public DateTime UpdatedAt { get; set; }

    /// <summary>
    /// Whether this is the default prompt for new conversations
    /// Only one prompt should have this set to true
    /// </summary>
    public bool IsDefault { get; set; }

    /// <summary>
    /// Whether this is a built-in template (cannot be deleted)
    /// </summary>
    public bool IsBuiltIn { get; set; }

    /// <summary>
    /// Number of times this prompt has been used
    /// </summary>
    public int UsageCount { get; set; }

    /// <summary>
    /// Whether this prompt is currently active/visible
    /// </summary>
    public bool IsActive { get; set; } = true;

    // Navigation property

    /// <summary>
    /// Conversations using this system prompt
    /// </summary>
    public ICollection<ConversationEntity> Conversations { get; set; } = new List<ConversationEntity>();
}
```

### InferencePresetEntity

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Represents a saved configuration of inference parameters
/// </summary>
public sealed class InferencePresetEntity
{
    /// <summary>
    /// Unique identifier for the preset
    /// </summary>
    public Guid Id { get; set; }

    /// <summary>
    /// Display name for the preset (must be unique)
    /// </summary>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Optional description of the preset's use case
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// Temperature parameter (0.0 - 2.0)
    /// Controls randomness/creativity
    /// </summary>
    public float Temperature { get; set; } = 0.7f;

    /// <summary>
    /// Top-P (nucleus sampling) parameter (0.0 - 1.0)
    /// Controls diversity of token selection
    /// </summary>
    public float TopP { get; set; } = 0.9f;

    /// <summary>
    /// Top-K parameter (1 - 100)
    /// Limits token selection to top K options
    /// </summary>
    public int TopK { get; set; } = 40;

    /// <summary>
    /// Maximum tokens to generate in response
    /// </summary>
    public int MaxTokens { get; set; } = 2048;

    /// <summary>
    /// Context window size in tokens
    /// </summary>
    public int ContextSize { get; set; } = 4096;

    /// <summary>
    /// Repeat penalty (1.0 - 2.0)
    /// Penalizes repetition in output
    /// </summary>
    public float RepeatPenalty { get; set; } = 1.1f;

    /// <summary>
    /// Whether this is the default preset
    /// Only one preset should have this set to true
    /// </summary>
    public bool IsDefault { get; set; }

    /// <summary>
    /// Whether this is a built-in preset (cannot be deleted)
    /// </summary>
    public bool IsBuiltIn { get; set; }

    /// <summary>
    /// When the preset was created
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// When the preset was last modified
    /// </summary>
    public DateTime UpdatedAt { get; set; }
}
```

### v0.2.1b Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Entities/ConversationEntity.cs` | Conversation entity |
| `src/SeniorIntern.Core/Entities/MessageEntity.cs` | Message entity |
| `src/SeniorIntern.Core/Entities/SystemPromptEntity.cs` | System prompt entity |
| `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs` | Inference preset entity |
| `src/SeniorIntern.Core/Enums/MessageRole.cs` | Message role enum (if not exists) |

### v0.2.1b Verification

```bash
# Verify entities compile
dotnet build src/SeniorIntern.Core
```

---

## v0.2.1c: DbContext & Configuration

### Objective
Implement the EF Core DbContext with Fluent API configurations for all entities, defining relationships, indexes, and constraints.

### DbContext Implementation

```csharp
namespace SeniorIntern.Data;

using Microsoft.EntityFrameworkCore;
using SeniorIntern.Core.Entities;

/// <summary>
/// Entity Framework Core database context for Senior Intern
/// </summary>
public class SeniorInternDbContext : DbContext
{
    /// <summary>
    /// Conversations table
    /// </summary>
    public DbSet<ConversationEntity> Conversations => Set<ConversationEntity>();

    /// <summary>
    /// Messages table
    /// </summary>
    public DbSet<MessageEntity> Messages => Set<MessageEntity>();

    /// <summary>
    /// System prompts table
    /// </summary>
    public DbSet<SystemPromptEntity> SystemPrompts => Set<SystemPromptEntity>();

    /// <summary>
    /// Inference presets table
    /// </summary>
    public DbSet<InferencePresetEntity> InferencePresets => Set<InferencePresetEntity>();

    public SeniorInternDbContext(DbContextOptions<SeniorInternDbContext> options)
        : base(options)
    {
    }

    /// <summary>
    /// Parameterless constructor for design-time tools
    /// </summary>
    public SeniorInternDbContext()
    {
    }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        if (!optionsBuilder.IsConfigured)
        {
            // Design-time configuration
            optionsBuilder.UseSqlite(DatabasePathResolver.GetConnectionString());
        }
    }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // Apply all configurations from this assembly
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(SeniorInternDbContext).Assembly);
    }

    /// <summary>
    /// Override SaveChanges to automatically set timestamps
    /// </summary>
    public override int SaveChanges()
    {
        UpdateTimestamps();
        return base.SaveChanges();
    }

    /// <summary>
    /// Override SaveChangesAsync to automatically set timestamps
    /// </summary>
    public override Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
    {
        UpdateTimestamps();
        return base.SaveChangesAsync(cancellationToken);
    }

    private void UpdateTimestamps()
    {
        var entries = ChangeTracker.Entries()
            .Where(e => e.State == EntityState.Added || e.State == EntityState.Modified);

        var now = DateTime.UtcNow;

        foreach (var entry in entries)
        {
            // Handle CreatedAt
            if (entry.State == EntityState.Added)
            {
                if (entry.Entity is ConversationEntity conv)
                {
                    conv.CreatedAt = now;
                    conv.UpdatedAt = now;
                }
                else if (entry.Entity is MessageEntity msg)
                {
                    msg.Timestamp = now;
                }
                else if (entry.Entity is SystemPromptEntity prompt)
                {
                    prompt.CreatedAt = now;
                    prompt.UpdatedAt = now;
                }
                else if (entry.Entity is InferencePresetEntity preset)
                {
                    preset.CreatedAt = now;
                    preset.UpdatedAt = now;
                }
            }

            // Handle UpdatedAt
            if (entry.State == EntityState.Modified)
            {
                if (entry.Entity is ConversationEntity conv)
                {
                    conv.UpdatedAt = now;
                }
                else if (entry.Entity is SystemPromptEntity prompt)
                {
                    prompt.UpdatedAt = now;
                }
                else if (entry.Entity is InferencePresetEntity preset)
                {
                    preset.UpdatedAt = now;
                }
            }
        }
    }
}
```

### Entity Configurations

#### ConversationConfiguration.cs

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core configuration for ConversationEntity
/// </summary>
public sealed class ConversationConfiguration : IEntityTypeConfiguration<ConversationEntity>
{
    public void Configure(EntityTypeBuilder<ConversationEntity> builder)
    {
        // Table name
        builder.ToTable("Conversations");

        // Primary key
        builder.HasKey(c => c.Id);

        // Properties
        builder.Property(c => c.Id)
            .ValueGeneratedNever(); // GUIDs generated in code

        builder.Property(c => c.Title)
            .IsRequired()
            .HasMaxLength(200);

        builder.Property(c => c.CreatedAt)
            .IsRequired();

        builder.Property(c => c.UpdatedAt)
            .IsRequired();

        builder.Property(c => c.ModelPath)
            .HasMaxLength(500);

        builder.Property(c => c.ModelName)
            .HasMaxLength(100);

        builder.Property(c => c.IsArchived)
            .HasDefaultValue(false);

        builder.Property(c => c.IsPinned)
            .HasDefaultValue(false);

        builder.Property(c => c.MessageCount)
            .HasDefaultValue(0);

        builder.Property(c => c.TotalTokenCount)
            .HasDefaultValue(0);

        // Relationships
        builder.HasOne(c => c.SystemPrompt)
            .WithMany(sp => sp.Conversations)
            .HasForeignKey(c => c.SystemPromptId)
            .OnDelete(DeleteBehavior.SetNull); // Keep conversation if prompt deleted

        builder.HasMany(c => c.Messages)
            .WithOne(m => m.Conversation)
            .HasForeignKey(m => m.ConversationId)
            .OnDelete(DeleteBehavior.Cascade); // Delete messages when conversation deleted

        // Indexes
        builder.HasIndex(c => c.UpdatedAt)
            .IsDescending();

        builder.HasIndex(c => c.IsArchived);

        builder.HasIndex(c => c.IsPinned);

        builder.HasIndex(c => new { c.IsArchived, c.UpdatedAt })
            .IsDescending(false, true);
    }
}
```

#### MessageConfiguration.cs

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core configuration for MessageEntity
/// </summary>
public sealed class MessageConfiguration : IEntityTypeConfiguration<MessageEntity>
{
    public void Configure(EntityTypeBuilder<MessageEntity> builder)
    {
        // Table name
        builder.ToTable("Messages");

        // Primary key
        builder.HasKey(m => m.Id);

        // Properties
        builder.Property(m => m.Id)
            .ValueGeneratedNever();

        builder.Property(m => m.ConversationId)
            .IsRequired();

        builder.Property(m => m.Role)
            .IsRequired()
            .HasConversion<int>(); // Store enum as integer

        builder.Property(m => m.Content)
            .IsRequired();
        // No max length - messages can be long

        builder.Property(m => m.Timestamp)
            .IsRequired();

        builder.Property(m => m.SequenceNumber)
            .IsRequired();

        builder.Property(m => m.IsComplete)
            .HasDefaultValue(true);

        builder.Property(m => m.IsEdited)
            .HasDefaultValue(false);

        // Indexes
        builder.HasIndex(m => m.ConversationId);

        builder.HasIndex(m => new { m.ConversationId, m.SequenceNumber })
            .IsUnique(); // Ensure unique ordering within conversation

        builder.HasIndex(m => m.Timestamp);
    }
}
```

#### SystemPromptConfiguration.cs

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core configuration for SystemPromptEntity
/// </summary>
public sealed class SystemPromptConfiguration : IEntityTypeConfiguration<SystemPromptEntity>
{
    public void Configure(EntityTypeBuilder<SystemPromptEntity> builder)
    {
        // Table name
        builder.ToTable("SystemPrompts");

        // Primary key
        builder.HasKey(sp => sp.Id);

        // Properties
        builder.Property(sp => sp.Id)
            .ValueGeneratedNever();

        builder.Property(sp => sp.Name)
            .IsRequired()
            .HasMaxLength(100);

        builder.Property(sp => sp.Content)
            .IsRequired();
        // No max length - prompts can be long

        builder.Property(sp => sp.Description)
            .HasMaxLength(500);

        builder.Property(sp => sp.Category)
            .IsRequired()
            .HasMaxLength(50)
            .HasDefaultValue("General");

        builder.Property(sp => sp.CreatedAt)
            .IsRequired();

        builder.Property(sp => sp.UpdatedAt)
            .IsRequired();

        builder.Property(sp => sp.IsDefault)
            .HasDefaultValue(false);

        builder.Property(sp => sp.IsBuiltIn)
            .HasDefaultValue(false);

        builder.Property(sp => sp.UsageCount)
            .HasDefaultValue(0);

        builder.Property(sp => sp.IsActive)
            .HasDefaultValue(true);

        // Indexes
        builder.HasIndex(sp => sp.Name)
            .IsUnique();

        builder.HasIndex(sp => sp.IsDefault);

        builder.HasIndex(sp => sp.Category);

        builder.HasIndex(sp => sp.IsActive);
    }
}
```

#### InferencePresetConfiguration.cs

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core configuration for InferencePresetEntity
/// </summary>
public sealed class InferencePresetConfiguration : IEntityTypeConfiguration<InferencePresetEntity>
{
    public void Configure(EntityTypeBuilder<InferencePresetEntity> builder)
    {
        // Table name
        builder.ToTable("InferencePresets");

        // Primary key
        builder.HasKey(ip => ip.Id);

        // Properties
        builder.Property(ip => ip.Id)
            .ValueGeneratedNever();

        builder.Property(ip => ip.Name)
            .IsRequired()
            .HasMaxLength(100);

        builder.Property(ip => ip.Description)
            .HasMaxLength(500);

        builder.Property(ip => ip.Temperature)
            .IsRequired();

        builder.Property(ip => ip.TopP)
            .IsRequired();

        builder.Property(ip => ip.TopK)
            .IsRequired()
            .HasDefaultValue(40);

        builder.Property(ip => ip.MaxTokens)
            .IsRequired();

        builder.Property(ip => ip.ContextSize)
            .IsRequired();

        builder.Property(ip => ip.RepeatPenalty)
            .IsRequired()
            .HasDefaultValue(1.1f);

        builder.Property(ip => ip.IsDefault)
            .HasDefaultValue(false);

        builder.Property(ip => ip.IsBuiltIn)
            .HasDefaultValue(false);

        builder.Property(ip => ip.CreatedAt)
            .IsRequired();

        builder.Property(ip => ip.UpdatedAt)
            .IsRequired();

        // Indexes
        builder.HasIndex(ip => ip.Name)
            .IsUnique();

        builder.HasIndex(ip => ip.IsDefault);
    }
}
```

### v0.2.1c Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Data/SeniorInternDbContext.cs` | EF Core DbContext |
| `src/SeniorIntern.Data/Configurations/ConversationConfiguration.cs` | Conversation entity config |
| `src/SeniorIntern.Data/Configurations/MessageConfiguration.cs` | Message entity config |
| `src/SeniorIntern.Data/Configurations/SystemPromptConfiguration.cs` | System prompt config |
| `src/SeniorIntern.Data/Configurations/InferencePresetConfiguration.cs` | Inference preset config |

### v0.2.1c Verification

```bash
# Verify DbContext compiles
dotnet build src/SeniorIntern.Data

# Create initial migration
cd src/SeniorIntern.Data
dotnet ef migrations add InitialCreate

# Verify migration was created
ls Migrations/
```

---

## v0.2.1d: Repository Layer

### Objective
Create repository interfaces and implementations for data access, following the repository pattern to abstract EF Core operations.

### Repository Interfaces

#### IConversationRepository.cs

```csharp
namespace SeniorIntern.Data.Repositories;

using SeniorIntern.Core.Entities;

/// <summary>
/// Repository for conversation data access
/// </summary>
public interface IConversationRepository
{
    /// <summary>
    /// Get a conversation by ID without messages
    /// </summary>
    Task<ConversationEntity?> GetByIdAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Get a conversation by ID with all messages loaded
    /// </summary>
    Task<ConversationEntity?> GetByIdWithMessagesAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Get recent conversations (non-archived) for the sidebar
    /// </summary>
    Task<IReadOnlyList<ConversationEntity>> GetRecentAsync(
        int count = 50,
        bool includeArchived = false,
        CancellationToken ct = default);

    /// <summary>
    /// Search conversations by title
    /// </summary>
    Task<IReadOnlyList<ConversationEntity>> SearchAsync(
        string query,
        int maxResults = 20,
        CancellationToken ct = default);

    /// <summary>
    /// Create a new conversation
    /// </summary>
    Task<ConversationEntity> CreateAsync(
        ConversationEntity conversation,
        CancellationToken ct = default);

    /// <summary>
    /// Update an existing conversation
    /// </summary>
    Task UpdateAsync(ConversationEntity conversation, CancellationToken ct = default);

    /// <summary>
    /// Delete a conversation and all its messages
    /// </summary>
    Task DeleteAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Archive a conversation (soft delete)
    /// </summary>
    Task ArchiveAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Unarchive a conversation
    /// </summary>
    Task UnarchiveAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Pin a conversation to the top
    /// </summary>
    Task PinAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Unpin a conversation
    /// </summary>
    Task UnpinAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Add a message to a conversation
    /// </summary>
    Task AddMessageAsync(
        Guid conversationId,
        MessageEntity message,
        CancellationToken ct = default);

    /// <summary>
    /// Update a message (for edits or completing streaming)
    /// </summary>
    Task UpdateMessageAsync(MessageEntity message, CancellationToken ct = default);

    /// <summary>
    /// Get messages for a conversation with pagination
    /// </summary>
    Task<IReadOnlyList<MessageEntity>> GetMessagesAsync(
        Guid conversationId,
        int skip = 0,
        int take = 100,
        CancellationToken ct = default);

    /// <summary>
    /// Get the message count for a conversation
    /// </summary>
    Task<int> GetMessageCountAsync(Guid conversationId, CancellationToken ct = default);

    /// <summary>
    /// Check if a conversation exists
    /// </summary>
    Task<bool> ExistsAsync(Guid id, CancellationToken ct = default);
}
```

#### ISystemPromptRepository.cs

```csharp
namespace SeniorIntern.Data.Repositories;

using SeniorIntern.Core.Entities;

/// <summary>
/// Repository for system prompt data access
/// </summary>
public interface ISystemPromptRepository
{
    /// <summary>
    /// Get a system prompt by ID
    /// </summary>
    Task<SystemPromptEntity?> GetByIdAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Get the default system prompt
    /// </summary>
    Task<SystemPromptEntity?> GetDefaultAsync(CancellationToken ct = default);

    /// <summary>
    /// Get all active system prompts
    /// </summary>
    Task<IReadOnlyList<SystemPromptEntity>> GetAllActiveAsync(CancellationToken ct = default);

    /// <summary>
    /// Get system prompts by category
    /// </summary>
    Task<IReadOnlyList<SystemPromptEntity>> GetByCategoryAsync(
        string category,
        CancellationToken ct = default);

    /// <summary>
    /// Search system prompts by name or content
    /// </summary>
    Task<IReadOnlyList<SystemPromptEntity>> SearchAsync(
        string query,
        CancellationToken ct = default);

    /// <summary>
    /// Create a new system prompt
    /// </summary>
    Task<SystemPromptEntity> CreateAsync(
        SystemPromptEntity prompt,
        CancellationToken ct = default);

    /// <summary>
    /// Update an existing system prompt
    /// </summary>
    Task UpdateAsync(SystemPromptEntity prompt, CancellationToken ct = default);

    /// <summary>
    /// Delete a system prompt (soft delete by setting IsActive = false)
    /// </summary>
    Task DeleteAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Permanently delete a system prompt (only for non-built-in)
    /// </summary>
    Task HardDeleteAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Set a system prompt as the default
    /// </summary>
    Task SetAsDefaultAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Increment the usage count for a prompt
    /// </summary>
    Task IncrementUsageCountAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Check if a prompt name is already taken
    /// </summary>
    Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default);
}
```

#### IInferencePresetRepository.cs

```csharp
namespace SeniorIntern.Data.Repositories;

using SeniorIntern.Core.Entities;

/// <summary>
/// Repository for inference preset data access
/// </summary>
public interface IInferencePresetRepository
{
    /// <summary>
    /// Get a preset by ID
    /// </summary>
    Task<InferencePresetEntity?> GetByIdAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Get the default preset
    /// </summary>
    Task<InferencePresetEntity?> GetDefaultAsync(CancellationToken ct = default);

    /// <summary>
    /// Get all presets
    /// </summary>
    Task<IReadOnlyList<InferencePresetEntity>> GetAllAsync(CancellationToken ct = default);

    /// <summary>
    /// Create a new preset
    /// </summary>
    Task<InferencePresetEntity> CreateAsync(
        InferencePresetEntity preset,
        CancellationToken ct = default);

    /// <summary>
    /// Update an existing preset
    /// </summary>
    Task UpdateAsync(InferencePresetEntity preset, CancellationToken ct = default);

    /// <summary>
    /// Delete a preset (only for non-built-in)
    /// </summary>
    Task DeleteAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Set a preset as the default
    /// </summary>
    Task SetAsDefaultAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Check if a preset name is already taken
    /// </summary>
    Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default);
}
```

### Repository Implementations

#### ConversationRepository.cs

```csharp
namespace SeniorIntern.Data.Repositories;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core implementation of IConversationRepository
/// </summary>
public sealed class ConversationRepository : IConversationRepository
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<ConversationRepository> _logger;

    public ConversationRepository(
        SeniorInternDbContext context,
        ILogger<ConversationRepository> logger)
    {
        _context = context;
        _logger = logger;
    }

    public async Task<ConversationEntity?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        return await _context.Conversations
            .Include(c => c.SystemPrompt)
            .FirstOrDefaultAsync(c => c.Id == id, ct);
    }

    public async Task<ConversationEntity?> GetByIdWithMessagesAsync(Guid id, CancellationToken ct = default)
    {
        return await _context.Conversations
            .Include(c => c.SystemPrompt)
            .Include(c => c.Messages.OrderBy(m => m.SequenceNumber))
            .FirstOrDefaultAsync(c => c.Id == id, ct);
    }

    public async Task<IReadOnlyList<ConversationEntity>> GetRecentAsync(
        int count = 50,
        bool includeArchived = false,
        CancellationToken ct = default)
    {
        var query = _context.Conversations
            .Include(c => c.SystemPrompt)
            .AsQueryable();

        if (!includeArchived)
        {
            query = query.Where(c => !c.IsArchived);
        }

        return await query
            .OrderByDescending(c => c.IsPinned)
            .ThenByDescending(c => c.UpdatedAt)
            .Take(count)
            .ToListAsync(ct);
    }

    public async Task<IReadOnlyList<ConversationEntity>> SearchAsync(
        string query,
        int maxResults = 20,
        CancellationToken ct = default)
    {
        if (string.IsNullOrWhiteSpace(query))
            return Array.Empty<ConversationEntity>();

        var normalizedQuery = query.ToLowerInvariant();

        return await _context.Conversations
            .Where(c => c.Title.ToLower().Contains(normalizedQuery))
            .OrderByDescending(c => c.UpdatedAt)
            .Take(maxResults)
            .ToListAsync(ct);
    }

    public async Task<ConversationEntity> CreateAsync(
        ConversationEntity conversation,
        CancellationToken ct = default)
    {
        if (conversation.Id == Guid.Empty)
            conversation.Id = Guid.NewGuid();

        _context.Conversations.Add(conversation);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Created conversation {Id}: {Title}", conversation.Id, conversation.Title);
        return conversation;
    }

    public async Task UpdateAsync(ConversationEntity conversation, CancellationToken ct = default)
    {
        _context.Conversations.Update(conversation);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Updated conversation {Id}", conversation.Id);
    }

    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        var conversation = await _context.Conversations.FindAsync(new object[] { id }, ct);
        if (conversation != null)
        {
            _context.Conversations.Remove(conversation);
            await _context.SaveChangesAsync(ct);

            _logger.LogDebug("Deleted conversation {Id}", id);
        }
    }

    public async Task ArchiveAsync(Guid id, CancellationToken ct = default)
    {
        await _context.Conversations
            .Where(c => c.Id == id)
            .ExecuteUpdateAsync(s => s
                .SetProperty(c => c.IsArchived, true)
                .SetProperty(c => c.UpdatedAt, DateTime.UtcNow), ct);

        _logger.LogDebug("Archived conversation {Id}", id);
    }

    public async Task UnarchiveAsync(Guid id, CancellationToken ct = default)
    {
        await _context.Conversations
            .Where(c => c.Id == id)
            .ExecuteUpdateAsync(s => s
                .SetProperty(c => c.IsArchived, false)
                .SetProperty(c => c.UpdatedAt, DateTime.UtcNow), ct);

        _logger.LogDebug("Unarchived conversation {Id}", id);
    }

    public async Task PinAsync(Guid id, CancellationToken ct = default)
    {
        await _context.Conversations
            .Where(c => c.Id == id)
            .ExecuteUpdateAsync(s => s
                .SetProperty(c => c.IsPinned, true)
                .SetProperty(c => c.UpdatedAt, DateTime.UtcNow), ct);
    }

    public async Task UnpinAsync(Guid id, CancellationToken ct = default)
    {
        await _context.Conversations
            .Where(c => c.Id == id)
            .ExecuteUpdateAsync(s => s
                .SetProperty(c => c.IsPinned, false)
                .SetProperty(c => c.UpdatedAt, DateTime.UtcNow), ct);
    }

    public async Task AddMessageAsync(
        Guid conversationId,
        MessageEntity message,
        CancellationToken ct = default)
    {
        if (message.Id == Guid.Empty)
            message.Id = Guid.NewGuid();

        message.ConversationId = conversationId;

        // Get next sequence number
        var maxSequence = await _context.Messages
            .Where(m => m.ConversationId == conversationId)
            .MaxAsync(m => (int?)m.SequenceNumber, ct) ?? 0;

        message.SequenceNumber = maxSequence + 1;

        _context.Messages.Add(message);

        // Update conversation metadata
        await _context.Conversations
            .Where(c => c.Id == conversationId)
            .ExecuteUpdateAsync(s => s
                .SetProperty(c => c.MessageCount, c => c.MessageCount + 1)
                .SetProperty(c => c.TotalTokenCount, c => c.TotalTokenCount + (message.TokenCount ?? 0))
                .SetProperty(c => c.UpdatedAt, DateTime.UtcNow), ct);

        await _context.SaveChangesAsync(ct);

        _logger.LogDebug(
            "Added message {MessageId} to conversation {ConversationId}",
            message.Id, conversationId);
    }

    public async Task UpdateMessageAsync(MessageEntity message, CancellationToken ct = default)
    {
        _context.Messages.Update(message);
        await _context.SaveChangesAsync(ct);
    }

    public async Task<IReadOnlyList<MessageEntity>> GetMessagesAsync(
        Guid conversationId,
        int skip = 0,
        int take = 100,
        CancellationToken ct = default)
    {
        return await _context.Messages
            .Where(m => m.ConversationId == conversationId)
            .OrderBy(m => m.SequenceNumber)
            .Skip(skip)
            .Take(take)
            .ToListAsync(ct);
    }

    public async Task<int> GetMessageCountAsync(Guid conversationId, CancellationToken ct = default)
    {
        return await _context.Messages
            .CountAsync(m => m.ConversationId == conversationId, ct);
    }

    public async Task<bool> ExistsAsync(Guid id, CancellationToken ct = default)
    {
        return await _context.Conversations.AnyAsync(c => c.Id == id, ct);
    }
}
```

#### SystemPromptRepository.cs

```csharp
namespace SeniorIntern.Data.Repositories;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core implementation of ISystemPromptRepository
/// </summary>
public sealed class SystemPromptRepository : ISystemPromptRepository
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<SystemPromptRepository> _logger;

    public SystemPromptRepository(
        SeniorInternDbContext context,
        ILogger<SystemPromptRepository> logger)
    {
        _context = context;
        _logger = logger;
    }

    public async Task<SystemPromptEntity?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        return await _context.SystemPrompts.FindAsync(new object[] { id }, ct);
    }

    public async Task<SystemPromptEntity?> GetDefaultAsync(CancellationToken ct = default)
    {
        return await _context.SystemPrompts
            .Where(sp => sp.IsDefault && sp.IsActive)
            .FirstOrDefaultAsync(ct);
    }

    public async Task<IReadOnlyList<SystemPromptEntity>> GetAllActiveAsync(CancellationToken ct = default)
    {
        return await _context.SystemPrompts
            .Where(sp => sp.IsActive)
            .OrderByDescending(sp => sp.IsDefault)
            .ThenBy(sp => sp.Name)
            .ToListAsync(ct);
    }

    public async Task<IReadOnlyList<SystemPromptEntity>> GetByCategoryAsync(
        string category,
        CancellationToken ct = default)
    {
        return await _context.SystemPrompts
            .Where(sp => sp.IsActive && sp.Category == category)
            .OrderBy(sp => sp.Name)
            .ToListAsync(ct);
    }

    public async Task<IReadOnlyList<SystemPromptEntity>> SearchAsync(
        string query,
        CancellationToken ct = default)
    {
        if (string.IsNullOrWhiteSpace(query))
            return await GetAllActiveAsync(ct);

        var normalizedQuery = query.ToLowerInvariant();

        return await _context.SystemPrompts
            .Where(sp => sp.IsActive &&
                (sp.Name.ToLower().Contains(normalizedQuery) ||
                 sp.Content.ToLower().Contains(normalizedQuery)))
            .OrderBy(sp => sp.Name)
            .ToListAsync(ct);
    }

    public async Task<SystemPromptEntity> CreateAsync(
        SystemPromptEntity prompt,
        CancellationToken ct = default)
    {
        if (prompt.Id == Guid.Empty)
            prompt.Id = Guid.NewGuid();

        _context.SystemPrompts.Add(prompt);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Created system prompt {Id}: {Name}", prompt.Id, prompt.Name);
        return prompt;
    }

    public async Task UpdateAsync(SystemPromptEntity prompt, CancellationToken ct = default)
    {
        _context.SystemPrompts.Update(prompt);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Updated system prompt {Id}", prompt.Id);
    }

    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        var prompt = await _context.SystemPrompts.FindAsync(new object[] { id }, ct);
        if (prompt != null && !prompt.IsBuiltIn)
        {
            prompt.IsActive = false;
            await _context.SaveChangesAsync(ct);

            _logger.LogDebug("Soft-deleted system prompt {Id}", id);
        }
    }

    public async Task HardDeleteAsync(Guid id, CancellationToken ct = default)
    {
        var prompt = await _context.SystemPrompts.FindAsync(new object[] { id }, ct);
        if (prompt != null && !prompt.IsBuiltIn)
        {
            _context.SystemPrompts.Remove(prompt);
            await _context.SaveChangesAsync(ct);

            _logger.LogDebug("Hard-deleted system prompt {Id}", id);
        }
    }

    public async Task SetAsDefaultAsync(Guid id, CancellationToken ct = default)
    {
        // Clear existing default
        await _context.SystemPrompts
            .Where(sp => sp.IsDefault)
            .ExecuteUpdateAsync(s => s.SetProperty(sp => sp.IsDefault, false), ct);

        // Set new default
        await _context.SystemPrompts
            .Where(sp => sp.Id == id)
            .ExecuteUpdateAsync(s => s.SetProperty(sp => sp.IsDefault, true), ct);

        _logger.LogDebug("Set system prompt {Id} as default", id);
    }

    public async Task IncrementUsageCountAsync(Guid id, CancellationToken ct = default)
    {
        await _context.SystemPrompts
            .Where(sp => sp.Id == id)
            .ExecuteUpdateAsync(s => s
                .SetProperty(sp => sp.UsageCount, sp => sp.UsageCount + 1), ct);
    }

    public async Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default)
    {
        var query = _context.SystemPrompts
            .Where(sp => sp.Name == name);

        if (excludeId.HasValue)
            query = query.Where(sp => sp.Id != excludeId.Value);

        return await query.AnyAsync(ct);
    }
}
```

#### InferencePresetRepository.cs

```csharp
namespace SeniorIntern.Data.Repositories;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;

/// <summary>
/// EF Core implementation of IInferencePresetRepository
/// </summary>
public sealed class InferencePresetRepository : IInferencePresetRepository
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<InferencePresetRepository> _logger;

    public InferencePresetRepository(
        SeniorInternDbContext context,
        ILogger<InferencePresetRepository> logger)
    {
        _context = context;
        _logger = logger;
    }

    public async Task<InferencePresetEntity?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        return await _context.InferencePresets.FindAsync(new object[] { id }, ct);
    }

    public async Task<InferencePresetEntity?> GetDefaultAsync(CancellationToken ct = default)
    {
        return await _context.InferencePresets
            .Where(ip => ip.IsDefault)
            .FirstOrDefaultAsync(ct);
    }

    public async Task<IReadOnlyList<InferencePresetEntity>> GetAllAsync(CancellationToken ct = default)
    {
        return await _context.InferencePresets
            .OrderByDescending(ip => ip.IsDefault)
            .ThenBy(ip => ip.Name)
            .ToListAsync(ct);
    }

    public async Task<InferencePresetEntity> CreateAsync(
        InferencePresetEntity preset,
        CancellationToken ct = default)
    {
        if (preset.Id == Guid.Empty)
            preset.Id = Guid.NewGuid();

        _context.InferencePresets.Add(preset);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Created inference preset {Id}: {Name}", preset.Id, preset.Name);
        return preset;
    }

    public async Task UpdateAsync(InferencePresetEntity preset, CancellationToken ct = default)
    {
        _context.InferencePresets.Update(preset);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Updated inference preset {Id}", preset.Id);
    }

    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        var preset = await _context.InferencePresets.FindAsync(new object[] { id }, ct);
        if (preset != null && !preset.IsBuiltIn)
        {
            _context.InferencePresets.Remove(preset);
            await _context.SaveChangesAsync(ct);

            _logger.LogDebug("Deleted inference preset {Id}", id);
        }
    }

    public async Task SetAsDefaultAsync(Guid id, CancellationToken ct = default)
    {
        // Clear existing default
        await _context.InferencePresets
            .Where(ip => ip.IsDefault)
            .ExecuteUpdateAsync(s => s.SetProperty(ip => ip.IsDefault, false), ct);

        // Set new default
        await _context.InferencePresets
            .Where(ip => ip.Id == id)
            .ExecuteUpdateAsync(s => s.SetProperty(ip => ip.IsDefault, true), ct);

        _logger.LogDebug("Set inference preset {Id} as default", id);
    }

    public async Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default)
    {
        var query = _context.InferencePresets
            .Where(ip => ip.Name == name);

        if (excludeId.HasValue)
            query = query.Where(ip => ip.Id != excludeId.Value);

        return await query.AnyAsync(ct);
    }
}
```

### v0.2.1d Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Data/Repositories/IConversationRepository.cs` | Conversation repo interface |
| `src/SeniorIntern.Data/Repositories/ConversationRepository.cs` | Conversation repo implementation |
| `src/SeniorIntern.Data/Repositories/ISystemPromptRepository.cs` | System prompt repo interface |
| `src/SeniorIntern.Data/Repositories/SystemPromptRepository.cs` | System prompt repo implementation |
| `src/SeniorIntern.Data/Repositories/IInferencePresetRepository.cs` | Inference preset repo interface |
| `src/SeniorIntern.Data/Repositories/InferencePresetRepository.cs` | Inference preset repo implementation |

### v0.2.1d Verification

```bash
# Verify builds
dotnet build src/SeniorIntern.Data
```

---

## v0.2.1e: Initialization & Seeding

### Objective
Implement database initialization, migration execution, and seed data for built-in system prompts and inference presets.

### Database Initializer

```csharp
namespace SeniorIntern.Data;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;

/// <summary>
/// Handles database initialization, migrations, and seeding
/// </summary>
public sealed class DatabaseInitializer
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<DatabaseInitializer> _logger;

    public DatabaseInitializer(
        SeniorInternDbContext context,
        ILogger<DatabaseInitializer> logger)
    {
        _context = context;
        _logger = logger;
    }

    /// <summary>
    /// Initialize the database (create if needed, migrate, seed)
    /// </summary>
    public async Task InitializeAsync(CancellationToken ct = default)
    {
        try
        {
            _logger.LogInformation("Initializing database at: {Path}",
                DatabasePathResolver.GetDatabasePath());

            // Ensure database is created and migrated
            await _context.Database.MigrateAsync(ct);

            _logger.LogInformation("Database migrations applied successfully");

            // Seed default data
            await SeedDataAsync(ct);

            _logger.LogInformation("Database initialization complete");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Database initialization failed");
            throw;
        }
    }

    /// <summary>
    /// Seed default data if not present
    /// </summary>
    private async Task SeedDataAsync(CancellationToken ct)
    {
        var hasSystemPrompts = await _context.SystemPrompts.AnyAsync(ct);
        var hasPresets = await _context.InferencePresets.AnyAsync(ct);

        if (!hasSystemPrompts)
        {
            _logger.LogInformation("Seeding default system prompts");
            await SeedSystemPromptsAsync(ct);
        }

        if (!hasPresets)
        {
            _logger.LogInformation("Seeding default inference presets");
            await SeedInferencePresetsAsync(ct);
        }
    }

    private async Task SeedSystemPromptsAsync(CancellationToken ct)
    {
        var prompts = new List<SystemPromptEntity>
        {
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Default Assistant",
                Content = """
                    You are a helpful, harmless, and honest AI assistant. You provide clear,
                    accurate, and thoughtful responses to help users with their questions
                    and tasks. When you don't know something, you say so. When asked to do
                    something harmful or unethical, you politely decline.
                    """,
                Description = "A balanced, helpful assistant for general use",
                Category = "General",
                IsDefault = true,
                IsBuiltIn = true,
                IsActive = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "The Senior Intern",
                Content = """
                    You are "The Senior Intern" - an AI assistant with the knowledge of a senior
                    developer but the enthusiasm of a new hire. You're technically brilliant but
                    sometimes make sarcastic observations about code quality or architecture
                    decisions. You help users with coding tasks while occasionally dropping witty
                    remarks about the state of the codebase or industry trends.

                    Key traits:
                    - Technically accurate and thorough
                    - Occasionally sarcastic but never mean
                    - Enthusiastic about good practices
                    - Mildly judgmental about bad practices
                    - Uses programming humor when appropriate

                    Always prioritize being helpful over being funny. If the user seems frustrated
                    or the task is urgent, dial back the personality and focus on solutions.
                    """,
                Description = "The classic Senior Intern personality - helpful with a side of snark",
                Category = "Creative",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Code Expert",
                Content = """
                    You are an expert software engineer and coding assistant. Focus on:
                    - Writing clean, efficient, and well-documented code
                    - Following best practices and design patterns
                    - Explaining technical concepts clearly
                    - Identifying bugs and suggesting improvements
                    - Providing complete, working code examples

                    When reviewing code, be thorough but constructive. Explain the "why"
                    behind your suggestions, not just the "what".
                    """,
                Description = "Focused on programming tasks and code quality",
                Category = "Code",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Technical Writer",
                Content = """
                    You are a technical documentation specialist. Your goal is to create
                    clear, comprehensive, and well-organized documentation. Focus on:
                    - Clear explanations accessible to the target audience
                    - Proper structure with headers, lists, and code blocks
                    - Examples that illustrate key concepts
                    - Accurate technical details
                    - Consistent terminology and formatting

                    Adapt your writing style to the audience - more casual for tutorials,
                    more formal for API documentation.
                    """,
                Description = "Specialized in creating documentation and explanations",
                Category = "Technical",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Rubber Duck",
                Content = """
                    You are a rubber duck debugger. Your role is to help users debug their
                    code by asking clarifying questions that lead them to find the solution
                    themselves. Instead of giving direct answers:
                    - Ask about their assumptions
                    - Question what they expect vs what happens
                    - Encourage them to walk through the code step by step
                    - Point out areas that might be worth investigating

                    Only provide direct solutions if the user explicitly asks or seems stuck
                    after several rounds of questions.
                    """,
                Description = "Helps debug by asking questions - like a rubber duck!",
                Category = "Code",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Socratic Tutor",
                Content = """
                    You are a Socratic tutor who teaches through questions. Rather than
                    giving direct answers:
                    - Ask guiding questions that lead to understanding
                    - Build on what the student already knows
                    - Encourage critical thinking
                    - Celebrate correct reasoning
                    - Gently redirect incorrect thinking

                    Your goal is to help the learner develop understanding, not just
                    memorize answers. Be patient and encouraging.
                    """,
                Description = "Teaches through questions to build understanding",
                Category = "General",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true
            }
        };

        _context.SystemPrompts.AddRange(prompts);
        await _context.SaveChangesAsync(ct);
    }

    private async Task SeedInferencePresetsAsync(CancellationToken ct)
    {
        var presets = new List<InferencePresetEntity>
        {
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Balanced",
                Description = "Good for general conversation and most tasks",
                Temperature = 0.7f,
                TopP = 0.9f,
                TopK = 40,
                MaxTokens = 2048,
                ContextSize = 4096,
                RepeatPenalty = 1.1f,
                IsDefault = true,
                IsBuiltIn = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Precise",
                Description = "Low temperature for factual, consistent responses",
                Temperature = 0.2f,
                TopP = 0.8f,
                TopK = 20,
                MaxTokens = 1024,
                ContextSize = 4096,
                RepeatPenalty = 1.1f,
                IsDefault = false,
                IsBuiltIn = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Creative",
                Description = "High temperature for brainstorming and creative writing",
                Temperature = 1.2f,
                TopP = 0.95f,
                TopK = 60,
                MaxTokens = 4096,
                ContextSize = 8192,
                RepeatPenalty = 1.05f,
                IsDefault = false,
                IsBuiltIn = true
            },
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Long-form",
                Description = "Extended context and output for detailed explanations",
                Temperature = 0.7f,
                TopP = 0.9f,
                TopK = 40,
                MaxTokens = 8192,
                ContextSize = 16384,
                RepeatPenalty = 1.15f,
                IsDefault = false,
                IsBuiltIn = true
            }
        };

        _context.InferencePresets.AddRange(presets);
        await _context.SaveChangesAsync(ct);
    }
}
```

### Service Collection Extensions

```csharp
namespace SeniorIntern.Data;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using SeniorIntern.Data.Repositories;

/// <summary>
/// Extension methods for registering data services
/// </summary>
public static class DataServiceCollectionExtensions
{
    /// <summary>
    /// Add the data layer services to the DI container
    /// </summary>
    public static IServiceCollection AddDataServices(this IServiceCollection services)
    {
        // Register DbContext
        services.AddDbContext<SeniorInternDbContext>(options =>
        {
            options.UseSqlite(DatabasePathResolver.GetConnectionString());
#if DEBUG
            options.EnableSensitiveDataLogging();
            options.EnableDetailedErrors();
#endif
        });

        // Register repositories
        services.AddScoped<IConversationRepository, ConversationRepository>();
        services.AddScoped<ISystemPromptRepository, SystemPromptRepository>();
        services.AddScoped<IInferencePresetRepository, InferencePresetRepository>();

        // Register initializer
        services.AddScoped<DatabaseInitializer>();

        return services;
    }
}
```

### v0.2.1e Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Data/DatabaseInitializer.cs` | Database init and seeding |
| `src/SeniorIntern.Data/DataServiceCollectionExtensions.cs` | DI registration |

### v0.2.1e Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/App.axaml.cs` | Call database initialization on startup |

### App.axaml.cs Integration

```csharp
// In App.axaml.cs OnFrameworkInitializationCompleted
public override void OnFrameworkInitializationCompleted()
{
    // ... existing code ...

    // Initialize database
    var initializer = Services.GetRequiredService<DatabaseInitializer>();
    await initializer.InitializeAsync();

    // ... rest of startup ...
}
```

### v0.2.1e Verification

```bash
# Run the app and verify database creation
dotnet run --project src/SeniorIntern.Desktop

# Check database file exists at expected location
# Windows: %AppData%/SeniorIntern/seniorintern.db
# macOS: ~/Library/Application Support/SeniorIntern/seniorintern.db
# Linux: ~/.config/SeniorIntern/seniorintern.db

# Verify seed data using sqlite3
sqlite3 <path-to-db> "SELECT Name FROM SystemPrompts"
sqlite3 <path-to-db> "SELECT Name FROM InferencePresets"
```

---

## Files Summary

### Files to Create (Total: 17)

| Part | File | Purpose |
|------|------|---------|
| v0.2.1a | `src/SeniorIntern.Data/SeniorIntern.Data.csproj` | Project file |
| v0.2.1a | `src/SeniorIntern.Data/DatabasePathResolver.cs` | Path resolution |
| v0.2.1b | `src/SeniorIntern.Core/Entities/ConversationEntity.cs` | Conversation entity |
| v0.2.1b | `src/SeniorIntern.Core/Entities/MessageEntity.cs` | Message entity |
| v0.2.1b | `src/SeniorIntern.Core/Entities/SystemPromptEntity.cs` | System prompt entity |
| v0.2.1b | `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs` | Inference preset entity |
| v0.2.1b | `src/SeniorIntern.Core/Enums/MessageRole.cs` | Message role enum |
| v0.2.1c | `src/SeniorIntern.Data/SeniorInternDbContext.cs` | DbContext |
| v0.2.1c | `src/SeniorIntern.Data/Configurations/ConversationConfiguration.cs` | Config |
| v0.2.1c | `src/SeniorIntern.Data/Configurations/MessageConfiguration.cs` | Config |
| v0.2.1c | `src/SeniorIntern.Data/Configurations/SystemPromptConfiguration.cs` | Config |
| v0.2.1c | `src/SeniorIntern.Data/Configurations/InferencePresetConfiguration.cs` | Config |
| v0.2.1d | `src/SeniorIntern.Data/Repositories/IConversationRepository.cs` | Interface |
| v0.2.1d | `src/SeniorIntern.Data/Repositories/ConversationRepository.cs` | Implementation |
| v0.2.1d | `src/SeniorIntern.Data/Repositories/ISystemPromptRepository.cs` | Interface |
| v0.2.1d | `src/SeniorIntern.Data/Repositories/SystemPromptRepository.cs` | Implementation |
| v0.2.1d | `src/SeniorIntern.Data/Repositories/IInferencePresetRepository.cs` | Interface |
| v0.2.1d | `src/SeniorIntern.Data/Repositories/InferencePresetRepository.cs` | Implementation |
| v0.2.1e | `src/SeniorIntern.Data/DatabaseInitializer.cs` | Init and seeding |
| v0.2.1e | `src/SeniorIntern.Data/DataServiceCollectionExtensions.cs` | DI extensions |

### Files to Modify (Total: 5)

| Part | File | Changes |
|------|------|---------|
| v0.2.1a | `SeniorIntern.sln` | Add Data project |
| v0.2.1a | `Directory.Packages.props` | Add EF Core packages |
| v0.2.1a | `src/SeniorIntern.Services/SeniorIntern.Services.csproj` | Add Data reference |
| v0.2.1a | `src/SeniorIntern.Desktop/SeniorIntern.Desktop.csproj` | Add Data reference |
| v0.2.1e | `src/SeniorIntern.Desktop/App.axaml.cs` | Initialize database |

---

## Testing Strategy

### Unit Tests

```csharp
// Tests/SeniorIntern.Data.Tests/ConversationRepositoryTests.cs
public class ConversationRepositoryTests : IAsyncLifetime
{
    private SeniorInternDbContext _context = null!;
    private ConversationRepository _repository = null!;

    public async Task InitializeAsync()
    {
        var options = new DbContextOptionsBuilder<SeniorInternDbContext>()
            .UseSqlite("Data Source=:memory:")
            .Options;

        _context = new SeniorInternDbContext(options);
        await _context.Database.OpenConnectionAsync();
        await _context.Database.EnsureCreatedAsync();

        _repository = new ConversationRepository(
            _context,
            NullLogger<ConversationRepository>.Instance);
    }

    [Fact]
    public async Task CreateAsync_ShouldCreateConversation()
    {
        var conversation = new ConversationEntity { Title = "Test" };

        var result = await _repository.CreateAsync(conversation);

        Assert.NotEqual(Guid.Empty, result.Id);
        Assert.Equal("Test", result.Title);
    }

    [Fact]
    public async Task AddMessageAsync_ShouldIncrementMessageCount()
    {
        var conversation = await _repository.CreateAsync(new ConversationEntity());
        var message = new MessageEntity { Role = MessageRole.User, Content = "Hello" };

        await _repository.AddMessageAsync(conversation.Id, message);

        var loaded = await _repository.GetByIdAsync(conversation.Id);
        Assert.Equal(1, loaded!.MessageCount);
    }

    // ... more tests ...

    public async Task DisposeAsync()
    {
        await _context.Database.CloseConnectionAsync();
        await _context.DisposeAsync();
    }
}
```

---

## Acceptance Criteria

### v0.2.1a
- [ ] Data project builds successfully
- [ ] Project references are correct
- [ ] Database path resolves correctly on all platforms
- [ ] EF Core packages are installed

### v0.2.1b
- [ ] All entity classes compile
- [ ] Entities have proper relationships defined
- [ ] Enums are in correct namespace

### v0.2.1c
- [ ] DbContext compiles
- [ ] All configurations applied
- [ ] Initial migration generates without errors
- [ ] Migration creates correct schema

### v0.2.1d
- [ ] All repository interfaces defined
- [ ] All repository implementations compile
- [ ] Repositories handle null cases correctly
- [ ] CRUD operations work correctly

### v0.2.1e
- [ ] Database created on first run
- [ ] Migrations applied automatically
- [ ] Seed data inserted correctly
- [ ] 6 system prompts seeded
- [ ] 4 inference presets seeded
- [ ] "Default Assistant" is the default prompt
- [ ] "Balanced" is the default preset

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Path resolution fails on platform | Low | High | Test on all platforms early |
| Migration fails on existing DB | Low | Medium | Backup before migrate |
| Seed data conflicts | Low | Low | Check for existing before seed |
| Connection string issues | Low | Medium | Validate path format per OS |
