# Design Specification: The Senior Intern v0.2.1e "Initialization & Seeding"

## Executive Summary

This document provides a detailed implementation specification for v0.2.1e, which implements database initialization, migration execution, seed data creation, and dependency injection registration. This is the final sub-part of v0.2.1 "Database Foundation".

### v0.2.1e Scope
- Create `DatabaseInitializer` for migration and seeding
- Define seed data for built-in system prompts
- Define seed data for built-in inference presets
- Create `DataServiceCollectionExtensions` for DI registration
- Integrate database initialization with application startup

---

## Prerequisites

Before implementing v0.2.1e, ensure:
- v0.2.1a is complete (Data project with DatabasePathResolver)
- v0.2.1b is complete (Entity classes)
- v0.2.1c is complete (DbContext and configurations)
- v0.2.1d is complete (Repository interfaces and implementations)
- Initial EF Core migration has been created

---

## Directory Structure

After v0.2.1e implementation:

```
src/SeniorIntern.Data/
├── SeniorIntern.Data.csproj
├── DatabasePathResolver.cs
├── SeniorInternDbContext.cs
├── DatabaseInitializer.cs              (NEW)
├── DataServiceCollectionExtensions.cs  (NEW)
├── Configurations/
│   └── ... (from v0.2.1c)
├── Repositories/
│   └── ... (from v0.2.1d)
└── Migrations/
    └── ... (generated by EF Core)
```

---

## Implementation Tasks

### Task 1: Create DatabaseInitializer

The database initializer handles first-run setup and migrations.

**File:** `src/SeniorIntern.Data/DatabaseInitializer.cs`

```csharp
namespace SeniorIntern.Data;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Enums;

/// <summary>
/// Handles database initialization, migrations, and seed data.
/// </summary>
/// <remarks>
/// <para>This class is responsible for:</para>
/// <list type="bullet">
///   <item><description>Creating the database file if it doesn't exist</description></item>
///   <item><description>Applying pending EF Core migrations</description></item>
///   <item><description>Seeding default system prompts and inference presets</description></item>
///   <item><description>Creating backups before potentially destructive operations</description></item>
/// </list>
/// <para>Call <see cref="InitializeAsync"/> during application startup.</para>
/// </remarks>
public sealed class DatabaseInitializer
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<DatabaseInitializer> _logger;

    /// <summary>
    /// Creates a new instance of the database initializer.
    /// </summary>
    /// <param name="context">The database context.</param>
    /// <param name="logger">The logger instance.</param>
    public DatabaseInitializer(
        SeniorInternDbContext context,
        ILogger<DatabaseInitializer> logger)
    {
        _context = context ?? throw new ArgumentNullException(nameof(context));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Initializes the database, applying migrations and seeding data.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>A task representing the initialization operation.</returns>
    /// <remarks>
    /// <para>This method is idempotent - safe to call multiple times.</para>
    /// <para>Seed data is only inserted if the tables are empty.</para>
    /// </remarks>
    /// <exception cref="DatabaseInitializationException">
    /// Thrown when initialization fails due to migration or seeding errors.
    /// </exception>
    public async Task InitializeAsync(CancellationToken ct = default)
    {
        var databasePath = DatabasePathResolver.GetDatabasePath();

        _logger.LogInformation(
            "Initializing database at: {DatabasePath}",
            databasePath);

        try
        {
            // Check for pending migrations
            var pendingMigrations = await _context.Database
                .GetPendingMigrationsAsync(ct);

            var pendingList = pendingMigrations.ToList();

            if (pendingList.Count > 0)
            {
                _logger.LogInformation(
                    "Applying {Count} pending migration(s): {Migrations}",
                    pendingList.Count,
                    string.Join(", ", pendingList));

                // Create backup before migration if database exists
                if (DatabasePathResolver.DatabaseExists())
                {
                    await CreateBackupAsync(ct);
                }

                // Apply migrations
                await _context.Database.MigrateAsync(ct);

                _logger.LogInformation("Database migrations applied successfully");
            }
            else
            {
                _logger.LogDebug("No pending migrations");

                // Ensure database is created (handles fresh install)
                await _context.Database.EnsureCreatedAsync(ct);
            }

            // Seed default data
            await SeedDataAsync(ct);

            _logger.LogInformation("Database initialization complete");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Database initialization failed");
            throw new DatabaseInitializationException(
                "Failed to initialize database. See inner exception for details.",
                ex);
        }
    }

    /// <summary>
    /// Creates a backup of the current database.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>The path to the backup file.</returns>
    public async Task<string> CreateBackupAsync(CancellationToken ct = default)
    {
        var sourcePath = DatabasePathResolver.GetDatabasePath();
        var backupPath = DatabasePathResolver.GetBackupPath();

        if (!File.Exists(sourcePath))
        {
            _logger.LogDebug("No database file to backup");
            return string.Empty;
        }

        _logger.LogInformation(
            "Creating database backup: {BackupPath}",
            backupPath);

        // Ensure we're not in a transaction
        if (_context.Database.CurrentTransaction is not null)
        {
            await _context.Database.CurrentTransaction.CommitAsync(ct);
        }

        // Close any open connections to allow file copy
        await _context.Database.CloseConnectionAsync();

        try
        {
            // Copy the database file
            await Task.Run(() => File.Copy(sourcePath, backupPath, overwrite: false), ct);

            _logger.LogInformation("Database backup created successfully");

            return backupPath;
        }
        finally
        {
            // Reopen connection
            await _context.Database.OpenConnectionAsync(ct);
        }
    }

    /// <summary>
    /// Seeds default data if tables are empty.
    /// </summary>
    private async Task SeedDataAsync(CancellationToken ct)
    {
        var hasSystemPrompts = await _context.SystemPrompts.AnyAsync(ct);
        var hasInferencePresets = await _context.InferencePresets.AnyAsync(ct);

        if (!hasSystemPrompts)
        {
            _logger.LogInformation("Seeding default system prompts");
            await SeedSystemPromptsAsync(ct);
        }
        else
        {
            _logger.LogDebug("System prompts already exist, skipping seed");
        }

        if (!hasInferencePresets)
        {
            _logger.LogInformation("Seeding default inference presets");
            await SeedInferencePresetsAsync(ct);
        }
        else
        {
            _logger.LogDebug("Inference presets already exist, skipping seed");
        }
    }

    /// <summary>
    /// Seeds the default system prompts.
    /// </summary>
    private async Task SeedSystemPromptsAsync(CancellationToken ct)
    {
        var prompts = CreateDefaultSystemPrompts();

        _context.SystemPrompts.AddRange(prompts);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Seeded {Count} system prompts", prompts.Count);
    }

    /// <summary>
    /// Seeds the default inference presets.
    /// </summary>
    private async Task SeedInferencePresetsAsync(CancellationToken ct)
    {
        var presets = CreateDefaultInferencePresets();

        _context.InferencePresets.AddRange(presets);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Seeded {Count} inference presets", presets.Count);
    }

    /// <summary>
    /// Creates the list of default system prompts.
    /// </summary>
    /// <returns>List of system prompt entities to seed.</returns>
    private static List<SystemPromptEntity> CreateDefaultSystemPrompts()
    {
        return new List<SystemPromptEntity>
        {
            // Default Assistant - The default prompt for new conversations
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Default Assistant",
                Content = """
                    You are a helpful, harmless, and honest AI assistant. You provide clear,
                    accurate, and thoughtful responses to help users with their questions
                    and tasks. When you don't know something, you say so. When asked to do
                    something harmful or unethical, you politely decline.
                    """.TrimIndent(),
                Description = "A balanced, helpful assistant for general use",
                Category = "General",
                IsDefault = true,
                IsBuiltIn = true,
                IsActive = true,
                UsageCount = 0
            },

            // The Senior Intern - The signature personality
            new()
            {
                Id = Guid.NewGuid(),
                Name = "The Senior Intern",
                Content = """
                    You are "The Senior Intern" - an AI assistant with the knowledge of a senior
                    developer but the enthusiasm of a new hire. You're technically brilliant but
                    sometimes make sarcastic observations about code quality or architecture
                    decisions. You help users with coding tasks while occasionally dropping witty
                    remarks about the state of the codebase or industry trends.

                    Key traits:
                    - Technically accurate and thorough
                    - Occasionally sarcastic but never mean
                    - Enthusiastic about good practices
                    - Mildly judgmental about bad practices
                    - Uses programming humor when appropriate

                    Always prioritize being helpful over being funny. If the user seems frustrated
                    or the task is urgent, dial back the personality and focus on solutions.
                    """.TrimIndent(),
                Description = "The classic Senior Intern personality - helpful with a side of snark",
                Category = "Creative",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true,
                UsageCount = 0
            },

            // Code Expert - Focused programming assistant
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Code Expert",
                Content = """
                    You are an expert software engineer and coding assistant. Focus on:
                    - Writing clean, efficient, and well-documented code
                    - Following best practices and design patterns
                    - Explaining technical concepts clearly
                    - Identifying bugs and suggesting improvements
                    - Providing complete, working code examples

                    When reviewing code, be thorough but constructive. Explain the "why"
                    behind your suggestions, not just the "what". Consider performance,
                    readability, maintainability, and security in your recommendations.
                    """.TrimIndent(),
                Description = "Focused on programming tasks and code quality",
                Category = "Code",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true,
                UsageCount = 0
            },

            // Technical Writer - Documentation specialist
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Technical Writer",
                Content = """
                    You are a technical documentation specialist. Your goal is to create
                    clear, comprehensive, and well-organized documentation. Focus on:
                    - Clear explanations accessible to the target audience
                    - Proper structure with headers, lists, and code blocks
                    - Examples that illustrate key concepts
                    - Accurate technical details
                    - Consistent terminology and formatting

                    Adapt your writing style to the audience - more casual for tutorials,
                    more formal for API documentation. Always include practical examples.
                    """.TrimIndent(),
                Description = "Specialized in creating documentation and explanations",
                Category = "Technical",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true,
                UsageCount = 0
            },

            // Rubber Duck - Debugging companion
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Rubber Duck",
                Content = """
                    You are a rubber duck debugger. Your role is to help users debug their
                    code by asking clarifying questions that lead them to find the solution
                    themselves. Instead of giving direct answers:
                    - Ask about their assumptions
                    - Question what they expect vs what happens
                    - Encourage them to walk through the code step by step
                    - Point out areas that might be worth investigating

                    Only provide direct solutions if the user explicitly asks or seems stuck
                    after several rounds of questions. The goal is to help them develop their
                    debugging skills, not just solve the immediate problem.
                    """.TrimIndent(),
                Description = "Helps debug by asking questions - like a rubber duck!",
                Category = "Code",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true,
                UsageCount = 0
            },

            // Socratic Tutor - Educational assistant
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Socratic Tutor",
                Content = """
                    You are a Socratic tutor who teaches through questions. Rather than
                    giving direct answers:
                    - Ask guiding questions that lead to understanding
                    - Build on what the student already knows
                    - Encourage critical thinking
                    - Celebrate correct reasoning
                    - Gently redirect incorrect thinking

                    Your goal is to help the learner develop understanding, not just
                    memorize answers. Be patient and encouraging. Adjust your questions
                    based on the learner's responses and apparent skill level.
                    """.TrimIndent(),
                Description = "Teaches through questions to build understanding",
                Category = "General",
                IsDefault = false,
                IsBuiltIn = true,
                IsActive = true,
                UsageCount = 0
            }
        };
    }

    /// <summary>
    /// Creates the list of default inference presets.
    /// </summary>
    /// <returns>List of inference preset entities to seed.</returns>
    private static List<InferencePresetEntity> CreateDefaultInferencePresets()
    {
        return new List<InferencePresetEntity>
        {
            // Balanced - Default preset for general use
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Balanced",
                Description = "Good balance of creativity and consistency. Recommended for general conversation and most tasks.",
                Temperature = 0.7f,
                TopP = 0.9f,
                TopK = 40,
                MaxTokens = 2048,
                ContextSize = 4096,
                RepeatPenalty = 1.1f,
                IsDefault = true,
                IsBuiltIn = true
            },

            // Precise - Low temperature for factual responses
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Precise",
                Description = "Low temperature for factual, consistent, and deterministic responses. Best for code generation and technical questions.",
                Temperature = 0.2f,
                TopP = 0.8f,
                TopK = 20,
                MaxTokens = 1024,
                ContextSize = 4096,
                RepeatPenalty = 1.1f,
                IsDefault = false,
                IsBuiltIn = true
            },

            // Creative - High temperature for brainstorming
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Creative",
                Description = "High temperature for brainstorming, creative writing, and exploring diverse ideas. May produce more varied outputs.",
                Temperature = 1.2f,
                TopP = 0.95f,
                TopK = 60,
                MaxTokens = 4096,
                ContextSize = 8192,
                RepeatPenalty = 1.05f,
                IsDefault = false,
                IsBuiltIn = true
            },

            // Long-form - Extended context for detailed work
            new()
            {
                Id = Guid.NewGuid(),
                Name = "Long-form",
                Description = "Extended context window and output length for detailed explanations, long documents, and complex conversations.",
                Temperature = 0.7f,
                TopP = 0.9f,
                TopK = 40,
                MaxTokens = 8192,
                ContextSize = 16384,
                RepeatPenalty = 1.15f,
                IsDefault = false,
                IsBuiltIn = true
            }
        };
    }
}

/// <summary>
/// Exception thrown when database initialization fails.
/// </summary>
public class DatabaseInitializationException : Exception
{
    /// <summary>
    /// Creates a new database initialization exception.
    /// </summary>
    public DatabaseInitializationException()
    {
    }

    /// <summary>
    /// Creates a new database initialization exception with a message.
    /// </summary>
    public DatabaseInitializationException(string message)
        : base(message)
    {
    }

    /// <summary>
    /// Creates a new database initialization exception with a message and inner exception.
    /// </summary>
    public DatabaseInitializationException(string message, Exception innerException)
        : base(message, innerException)
    {
    }
}

/// <summary>
/// String extension methods for seed data formatting.
/// </summary>
internal static class StringExtensions
{
    /// <summary>
    /// Trims common leading whitespace from all lines in a multi-line string.
    /// </summary>
    /// <param name="text">The text to process.</param>
    /// <returns>The text with common indentation removed.</returns>
    public static string TrimIndent(this string text)
    {
        if (string.IsNullOrEmpty(text))
            return text;

        var lines = text.Split('\n');

        // Find minimum indentation (ignoring empty lines)
        var minIndent = lines
            .Where(line => line.Trim().Length > 0)
            .Select(line => line.TakeWhile(char.IsWhiteSpace).Count())
            .DefaultIfEmpty(0)
            .Min();

        // Remove the common indentation from each line
        var result = lines
            .Select(line => line.Length >= minIndent ? line[minIndent..] : line.TrimStart())
            .ToArray();

        return string.Join('\n', result).Trim();
    }
}
```

---

### Task 2: Create DataServiceCollectionExtensions

Extension methods for registering data services with dependency injection.

**File:** `src/SeniorIntern.Data/DataServiceCollectionExtensions.cs`

```csharp
namespace SeniorIntern.Data;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using SeniorIntern.Data.Repositories;

/// <summary>
/// Extension methods for registering data layer services with dependency injection.
/// </summary>
public static class DataServiceCollectionExtensions
{
    /// <summary>
    /// Adds the data layer services to the dependency injection container.
    /// </summary>
    /// <param name="services">The service collection.</param>
    /// <returns>The service collection for chaining.</returns>
    /// <remarks>
    /// <para>Registers the following services:</para>
    /// <list type="bullet">
    ///   <item><description><see cref="SeniorInternDbContext"/> - Scoped</description></item>
    ///   <item><description><see cref="IConversationRepository"/> - Scoped</description></item>
    ///   <item><description><see cref="ISystemPromptRepository"/> - Scoped</description></item>
    ///   <item><description><see cref="IInferencePresetRepository"/> - Scoped</description></item>
    ///   <item><description><see cref="DatabaseInitializer"/> - Scoped</description></item>
    /// </list>
    /// </remarks>
    /// <example>
    /// <code>
    /// services.AddDataServices();
    /// </code>
    /// </example>
    public static IServiceCollection AddDataServices(this IServiceCollection services)
    {
        // Register DbContext
        services.AddDbContext<SeniorInternDbContext>((serviceProvider, options) =>
        {
            var connectionString = DatabasePathResolver.GetConnectionString();

            options.UseSqlite(connectionString, sqliteOptions =>
            {
                // Configure SQLite-specific options
                sqliteOptions.CommandTimeout(30);
            });

#if DEBUG
            // Enable detailed logging in debug builds
            options.EnableSensitiveDataLogging();
            options.EnableDetailedErrors();

            // Log SQL queries
            var loggerFactory = serviceProvider.GetService<ILoggerFactory>();
            if (loggerFactory is not null)
            {
                options.UseLoggerFactory(loggerFactory);
            }
#endif
        });

        // Register repositories
        services.AddScoped<IConversationRepository, ConversationRepository>();
        services.AddScoped<ISystemPromptRepository, SystemPromptRepository>();
        services.AddScoped<IInferencePresetRepository, InferencePresetRepository>();

        // Register initializer
        services.AddScoped<DatabaseInitializer>();

        return services;
    }

    /// <summary>
    /// Adds the data layer services with custom configuration.
    /// </summary>
    /// <param name="services">The service collection.</param>
    /// <param name="configureOptions">Action to configure DbContext options.</param>
    /// <returns>The service collection for chaining.</returns>
    /// <remarks>
    /// Use this overload for testing with in-memory database or custom configuration.
    /// </remarks>
    /// <example>
    /// <code>
    /// // For testing with in-memory database
    /// services.AddDataServices(options =>
    ///     options.UseInMemoryDatabase("TestDb"));
    /// </code>
    /// </example>
    public static IServiceCollection AddDataServices(
        this IServiceCollection services,
        Action<DbContextOptionsBuilder> configureOptions)
    {
        ArgumentNullException.ThrowIfNull(configureOptions);

        // Register DbContext with custom options
        services.AddDbContext<SeniorInternDbContext>(configureOptions);

        // Register repositories
        services.AddScoped<IConversationRepository, ConversationRepository>();
        services.AddScoped<ISystemPromptRepository, SystemPromptRepository>();
        services.AddScoped<IInferencePresetRepository, InferencePresetRepository>();

        // Register initializer
        services.AddScoped<DatabaseInitializer>();

        return services;
    }
}
```

---

### Task 3: Update Application Startup

Integrate database initialization with the application startup.

**File to Modify:** `src/SeniorIntern.Desktop/App.axaml.cs`

**Changes Required:**

```csharp
// Add using statements
using Microsoft.Extensions.DependencyInjection;
using SeniorIntern.Data;

public partial class App : Application
{
    /// <summary>
    /// Gets the application's service provider.
    /// </summary>
    public IServiceProvider Services { get; private set; } = null!;

    public override void Initialize()
    {
        AvaloniaXamlLoader.Load(this);
    }

    public override async void OnFrameworkInitializationCompleted()
    {
        // Build service provider
        var services = new ServiceCollection();
        ConfigureServices(services);
        Services = services.BuildServiceProvider();

        // Initialize database
        await InitializeDatabaseAsync();

        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow
            {
                DataContext = Services.GetRequiredService<MainWindowViewModel>()
            };
        }

        base.OnFrameworkInitializationCompleted();
    }

    /// <summary>
    /// Configures application services.
    /// </summary>
    private static void ConfigureServices(IServiceCollection services)
    {
        // Add logging
        services.AddLogging(builder =>
        {
            builder.SetMinimumLevel(LogLevel.Debug);
            // Add console logging for development
#if DEBUG
            builder.AddDebug();
#endif
        });

        // Add data services
        services.AddDataServices();

        // Add other services...
        // services.AddSingleton<IModelService, ModelService>();
        // services.AddSingleton<IChatService, ChatService>();

        // Add ViewModels
        // services.AddTransient<MainWindowViewModel>();
    }

    /// <summary>
    /// Initializes the database on startup.
    /// </summary>
    private async Task InitializeDatabaseAsync()
    {
        try
        {
            using var scope = Services.CreateScope();
            var initializer = scope.ServiceProvider.GetRequiredService<DatabaseInitializer>();
            await initializer.InitializeAsync();
        }
        catch (DatabaseInitializationException ex)
        {
            // Log error and show user-friendly message
            var logger = Services.GetService<ILogger<App>>();
            logger?.LogError(ex, "Failed to initialize database");

            // TODO: Show error dialog to user
            // For now, rethrow to fail fast
            throw;
        }
    }
}
```

---

## Seed Data Details

### System Prompts (6 prompts)

| Name | Category | Default | Description |
|------|----------|---------|-------------|
| Default Assistant | General | Yes | Balanced, helpful assistant for general use |
| The Senior Intern | Creative | No | Signature personality with wit and snark |
| Code Expert | Code | No | Programming-focused assistant |
| Technical Writer | Technical | No | Documentation specialist |
| Rubber Duck | Code | No | Debugging through questioning |
| Socratic Tutor | General | No | Teaching through Socratic method |

### Inference Presets (4 presets)

| Name | Temp | TopP | TopK | MaxTokens | Context | Default | Use Case |
|------|------|------|------|-----------|---------|---------|----------|
| Balanced | 0.7 | 0.9 | 40 | 2048 | 4096 | Yes | General conversation |
| Precise | 0.2 | 0.8 | 20 | 1024 | 4096 | No | Code, technical facts |
| Creative | 1.2 | 0.95 | 60 | 4096 | 8192 | No | Brainstorming, writing |
| Long-form | 0.7 | 0.9 | 40 | 8192 | 16384 | No | Long documents |

---

## Initialization Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Application Startup                           │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    ConfigureServices()                               │
│  - AddLogging()                                                      │
│  - AddDataServices()  ◄── Registers DbContext, Repositories          │
│  - AddViewModels()                                                   │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  InitializeDatabaseAsync()                           │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│               DatabaseInitializer.InitializeAsync()                  │
├─────────────────────────────────────────────────────────────────────┤
│  1. Log database path                                                │
│  2. Check for pending migrations                                     │
│     ├─ If pending: Create backup, apply migrations                   │
│     └─ If none: EnsureCreated (fresh install)                       │
│  3. Seed data if tables empty                                        │
│     ├─ SystemPrompts: 6 built-in prompts                            │
│     └─ InferencePresets: 4 built-in presets                         │
│  4. Log completion                                                   │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Application Ready                               │
│  - MainWindow displayed                                              │
│  - Database ready for use                                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Files Summary

### Files to Create (2)

| File | Purpose | Lines (approx) |
|------|---------|----------------|
| `src/SeniorIntern.Data/DatabaseInitializer.cs` | Migration, backup, and seeding | 320 |
| `src/SeniorIntern.Data/DataServiceCollectionExtensions.cs` | DI registration extensions | 90 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/App.axaml.cs` | Add DI setup and database initialization |

---

## Verification Steps

### Step 1: Verify Compilation

```bash
# Build the Data project
dotnet build src/SeniorIntern.Data

# Build the entire solution
dotnet build SeniorIntern.sln
```

### Step 2: Verify Fresh Database Creation

```bash
# Delete any existing database (for testing)
rm -rf ~/Library/Application\ Support/SeniorIntern/seniorintern.db

# Run the application
dotnet run --project src/SeniorIntern.Desktop

# Verify database was created
ls -la ~/Library/Application\ Support/SeniorIntern/
```

### Step 3: Verify Seed Data

```bash
# Open the database with SQLite CLI
sqlite3 ~/Library/Application\ Support/SeniorIntern/seniorintern.db

# Check system prompts
SELECT Name, Category, IsDefault, IsBuiltIn FROM SystemPrompts;

# Expected output:
# Default Assistant|General|1|1
# The Senior Intern|Creative|0|1
# Code Expert|Code|0|1
# Technical Writer|Technical|0|1
# Rubber Duck|Code|0|1
# Socratic Tutor|General|0|1

# Check inference presets
SELECT Name, Temperature, IsDefault, IsBuiltIn FROM InferencePresets;

# Expected output:
# Balanced|0.7|1|1
# Precise|0.2|0|1
# Creative|1.2|0|1
# Long-form|0.7|0|1

# Exit SQLite
.quit
```

### Step 4: Verify Idempotent Seeding

```bash
# Run the application again
dotnet run --project src/SeniorIntern.Desktop

# Check that we still have only 6 prompts (not duplicated)
sqlite3 ~/Library/Application\ Support/SeniorIntern/seniorintern.db \
  "SELECT COUNT(*) FROM SystemPrompts;"
# Expected: 6

# Check that we still have only 4 presets
sqlite3 ~/Library/Application\ Support/SeniorIntern/seniorintern.db \
  "SELECT COUNT(*) FROM InferencePresets;"
# Expected: 4
```

### Step 5: Verify Backup Creation

```bash
# Force a migration scenario (development only)
# This would typically happen when updating to a new version

# Check for backup files
ls -la ~/Library/Application\ Support/SeniorIntern/seniorintern_backup_*.db
```

### Step 6: Unit Test for DatabaseInitializer

```csharp
public class DatabaseInitializerTests : IAsyncLifetime
{
    private SeniorInternDbContext _context = null!;
    private DatabaseInitializer _initializer = null!;

    public async Task InitializeAsync()
    {
        var options = new DbContextOptionsBuilder<SeniorInternDbContext>()
            .UseInMemoryDatabase(Guid.NewGuid().ToString())
            .Options;

        _context = new SeniorInternDbContext(options);
        _initializer = new DatabaseInitializer(
            _context,
            NullLogger<DatabaseInitializer>.Instance);

        await Task.CompletedTask;
    }

    public async Task DisposeAsync()
    {
        await _context.DisposeAsync();
    }

    [Fact]
    public async Task InitializeAsync_SeedsSystemPrompts()
    {
        await _initializer.InitializeAsync();

        var prompts = await _context.SystemPrompts.ToListAsync();

        Assert.Equal(6, prompts.Count);
        Assert.Single(prompts.Where(p => p.IsDefault));
        Assert.All(prompts, p => Assert.True(p.IsBuiltIn));
    }

    [Fact]
    public async Task InitializeAsync_SeedsInferencePresets()
    {
        await _initializer.InitializeAsync();

        var presets = await _context.InferencePresets.ToListAsync();

        Assert.Equal(4, presets.Count);
        Assert.Single(presets.Where(p => p.IsDefault));
        Assert.All(presets, p => Assert.True(p.IsBuiltIn));
    }

    [Fact]
    public async Task InitializeAsync_IsIdempotent()
    {
        // Initialize twice
        await _initializer.InitializeAsync();
        await _initializer.InitializeAsync();

        // Should still have same counts
        Assert.Equal(6, await _context.SystemPrompts.CountAsync());
        Assert.Equal(4, await _context.InferencePresets.CountAsync());
    }

    [Fact]
    public async Task InitializeAsync_DefaultPromptIsDefaultAssistant()
    {
        await _initializer.InitializeAsync();

        var defaultPrompt = await _context.SystemPrompts
            .FirstOrDefaultAsync(p => p.IsDefault);

        Assert.NotNull(defaultPrompt);
        Assert.Equal("Default Assistant", defaultPrompt.Name);
    }

    [Fact]
    public async Task InitializeAsync_DefaultPresetIsBalanced()
    {
        await _initializer.InitializeAsync();

        var defaultPreset = await _context.InferencePresets
            .FirstOrDefaultAsync(p => p.IsDefault);

        Assert.NotNull(defaultPreset);
        Assert.Equal("Balanced", defaultPreset.Name);
    }
}
```

---

## Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | DatabaseInitializer compiles | `dotnet build` succeeds |
| AC-2 | DataServiceCollectionExtensions compiles | `dotnet build` succeeds |
| AC-3 | Application starts without errors | App launches successfully |
| AC-4 | Database file created on first run | File exists at expected path |
| AC-5 | 6 system prompts seeded | Query returns 6 rows |
| AC-6 | 4 inference presets seeded | Query returns 4 rows |
| AC-7 | Default Assistant is default prompt | IsDefault = true for that row |
| AC-8 | Balanced is default preset | IsDefault = true for that row |
| AC-9 | All seeded data has IsBuiltIn = true | No IsBuiltIn = false in seed data |
| AC-10 | Seeding is idempotent | Running twice doesn't duplicate |
| AC-11 | Backup created before migration | Backup file exists after migration |
| AC-12 | DI registration works | Services resolve correctly |

---

## Error Handling

### DatabaseInitializationException

Thrown when initialization fails. Wraps the underlying exception.

```csharp
try
{
    await initializer.InitializeAsync();
}
catch (DatabaseInitializationException ex)
{
    // Log the error
    logger.LogError(ex, "Database initialization failed");

    // Show user-friendly error
    ShowErrorDialog("Unable to start application. Database initialization failed.");

    // Could offer options:
    // - Retry
    // - Reset database
    // - View logs
    // - Exit
}
```

### Recovery Options

| Scenario | Recovery |
|----------|----------|
| Migration failed | Restore from backup, retry, or reset |
| Seeding failed | Usually transient, retry |
| Disk full | Free space, retry |
| Permission denied | Check folder permissions |
| Corrupted database | Restore from backup or reset |

---

## Design Decisions

### Decision 1: Scoped DatabaseInitializer

**Decision:** Register DatabaseInitializer as Scoped, not Singleton.

**Rationale:**
- Matches DbContext lifetime (Scoped)
- Each initialization gets fresh context
- Prevents stale connection issues

### Decision 2: Separate Backup Method

**Decision:** Expose CreateBackupAsync as a public method.

**Rationale:**
- Allows manual backups from UI
- Can be used before risky operations
- Useful for export/migration features

### Decision 3: Raw String Literals for Prompts

**Decision:** Use C# 11 raw string literals (""") for prompt content.

**Rationale:**
- Clean multi-line strings
- Preserves formatting
- No escape character issues
- TrimIndent() cleans up leading whitespace

### Decision 4: Idempotent Seeding

**Decision:** Only seed if tables are empty.

**Rationale:**
- Safe to run multiple times
- Doesn't overwrite user changes
- Handles interrupted initialization gracefully

### Decision 5: Custom Exception Type

**Decision:** Create DatabaseInitializationException.

**Rationale:**
- Clear error categorization
- Wraps various EF Core exceptions
- Enables specific error handling in UI

---

## Platform-Specific Database Paths

| Platform | Path |
|----------|------|
| Windows | `%AppData%\SeniorIntern\seniorintern.db` |
| macOS | `~/Library/Application Support/SeniorIntern/seniorintern.db` |
| Linux | `~/.config/SeniorIntern/seniorintern.db` |

Backup files are created in the same directory with timestamp suffix:
- `seniorintern_backup_20240115_143022.db`

---

## Next Steps

With v0.2.1e complete, the entire v0.2.1 "Database Foundation" is finished:

| Part | Status | Description |
|------|--------|-------------|
| v0.2.1a | Complete | Project setup, EF Core packages |
| v0.2.1b | Complete | Entity classes |
| v0.2.1c | Complete | DbContext and configurations |
| v0.2.1d | Complete | Repository layer |
| v0.2.1e | Complete | Initialization and seeding |

**Proceed to v0.2.2: Conversation Persistence**
- Implement conversation save/load in UI
- Wire up repositories to ViewModels
- Add conversation list to sidebar
- Implement message persistence during chat

---

## Appendix: Complete System Prompt Content

### Default Assistant
```
You are a helpful, harmless, and honest AI assistant. You provide clear,
accurate, and thoughtful responses to help users with their questions
and tasks. When you don't know something, you say so. When asked to do
something harmful or unethical, you politely decline.
```

### The Senior Intern
```
You are "The Senior Intern" - an AI assistant with the knowledge of a senior
developer but the enthusiasm of a new hire. You're technically brilliant but
sometimes make sarcastic observations about code quality or architecture
decisions. You help users with coding tasks while occasionally dropping witty
remarks about the state of the codebase or industry trends.

Key traits:
- Technically accurate and thorough
- Occasionally sarcastic but never mean
- Enthusiastic about good practices
- Mildly judgmental about bad practices
- Uses programming humor when appropriate

Always prioritize being helpful over being funny. If the user seems frustrated
or the task is urgent, dial back the personality and focus on solutions.
```

### Code Expert
```
You are an expert software engineer and coding assistant. Focus on:
- Writing clean, efficient, and well-documented code
- Following best practices and design patterns
- Explaining technical concepts clearly
- Identifying bugs and suggesting improvements
- Providing complete, working code examples

When reviewing code, be thorough but constructive. Explain the "why"
behind your suggestions, not just the "what". Consider performance,
readability, maintainability, and security in your recommendations.
```

### Technical Writer
```
You are a technical documentation specialist. Your goal is to create
clear, comprehensive, and well-organized documentation. Focus on:
- Clear explanations accessible to the target audience
- Proper structure with headers, lists, and code blocks
- Examples that illustrate key concepts
- Accurate technical details
- Consistent terminology and formatting

Adapt your writing style to the audience - more casual for tutorials,
more formal for API documentation. Always include practical examples.
```

### Rubber Duck
```
You are a rubber duck debugger. Your role is to help users debug their
code by asking clarifying questions that lead them to find the solution
themselves. Instead of giving direct answers:
- Ask about their assumptions
- Question what they expect vs what happens
- Encourage them to walk through the code step by step
- Point out areas that might be worth investigating

Only provide direct solutions if the user explicitly asks or seems stuck
after several rounds of questions. The goal is to help them develop their
debugging skills, not just solve the immediate problem.
```

### Socratic Tutor
```
You are a Socratic tutor who teaches through questions. Rather than
giving direct answers:
- Ask guiding questions that lead to understanding
- Build on what the student already knows
- Encourage critical thinking
- Celebrate correct reasoning
- Gently redirect incorrect thinking

Your goal is to help the learner develop understanding, not just
memorize answers. Be patient and encouraging. Adjust your questions
based on the learner's responses and apparent skill level.
```
