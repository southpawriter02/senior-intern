# Design Specification: The Senior Intern v0.2.5a "FTS5 Search Infrastructure"

## Executive Summary

This document provides a detailed implementation specification for v0.2.5a, which sets up the SQLite FTS5 (Full-Text Search 5) infrastructure for searching conversations and messages. This includes creating FTS5 virtual tables, synchronization triggers, search models, and the migration to enable full-text search.

### v0.2.5a Scope (from v0.2.5 Design Document)

- Create FTS5 virtual tables for Conversations and Messages
- Create triggers to keep FTS tables synchronized
- Populate FTS tables with existing data
- Create search models (SearchResult, SearchQuery, SearchResults)
- Add raw SQL methods to DbContext for FTS queries

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ConversationsFts | FTS5 virtual table indexing conversation titles |
| MessagesFts | FTS5 virtual table indexing message content |
| Sync Triggers | 6 triggers for INSERT/UPDATE/DELETE sync |
| SearchResult | Model for individual search results |
| SearchQuery | Model for search parameters |
| SearchResults | Container for grouped results |
| EF Migration | Database migration adding FTS infrastructure |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.5a Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  FTS5 Virtual Tables                                              │
│  ├── ConversationsFts                                             │
│  │   ├── Indexes: Title column                                    │
│  │   ├── content='Conversations' (external content)               │
│  │   └── content_rowid='Id'                                       │
│  │                                                                │
│  └── MessagesFts                                                  │
│      ├── Indexes: Content column                                  │
│      ├── content='Messages' (external content)                    │
│      └── content_rowid='Id'                                       │
│                                                                   │
│  Synchronization Triggers                                         │
│  ├── Conversations_ai (AFTER INSERT)                              │
│  ├── Conversations_ad (AFTER DELETE)                              │
│  ├── Conversations_au (AFTER UPDATE)                              │
│  ├── Messages_ai (AFTER INSERT)                                   │
│  ├── Messages_ad (AFTER DELETE)                                   │
│  └── Messages_au (AFTER UPDATE)                                   │
│                                                                   │
│  Search Models                                                    │
│  ├── SearchResult                                                 │
│  │   ├── Id (Guid)                                                │
│  │   ├── Type (Conversation | Message)                            │
│  │   ├── Title, Snippet, HighlightedSnippet                       │
│  │   ├── Rank (BM25 score)                                        │
│  │   ├── Timestamp                                                │
│  │   └── ConversationId?, ConversationTitle? (for messages)       │
│  │                                                                │
│  ├── SearchQuery                                                  │
│  │   ├── Text (search terms)                                      │
│  │   ├── FilterType? (Conversation | Message | null=both)         │
│  │   ├── MaxResults (default: 50)                                 │
│  │   └── SnippetLength (default: 150)                             │
│  │                                                                │
│  └── SearchResults                                                │
│      ├── Conversations (IReadOnlyList)                            │
│      ├── Messages (IReadOnlyList)                                 │
│      ├── TotalCount                                               │
│      └── SearchDuration                                           │
│                                                                   │
│  SearchResultType (Enum)                                          │
│  ├── Conversation                                                 │
│  └── Message                                                      │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### FTS5 External Content Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                FTS5 External Content Architecture                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Source Tables                             │ │
│  │  ┌───────────────────────┐  ┌───────────────────────────┐   │ │
│  │  │     Conversations     │  │        Messages           │   │ │
│  │  │ Id (PK)  │ Title     │  │ Id (PK)  │ Content        │   │ │
│  │  │ Guid     │ TEXT      │  │ Guid     │ TEXT           │   │ │
│  │  └───────────────────────┘  └───────────────────────────┘   │ │
│  └─────────────────┬───────────────────────┬───────────────────┘ │
│                    │                       │                     │
│         ┌──────────┴────────┐   ┌──────────┴────────┐           │
│         │     Triggers      │   │     Triggers      │           │
│         │  _ai (INSERT)     │   │  _ai (INSERT)     │           │
│         │  _ad (DELETE)     │   │  _ad (DELETE)     │           │
│         │  _au (UPDATE)     │   │  _au (UPDATE)     │           │
│         └──────────┬────────┘   └──────────┬────────┘           │
│                    ▼                       ▼                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    FTS5 Virtual Tables                       │ │
│  │  ┌───────────────────────┐  ┌───────────────────────────┐   │ │
│  │  │   ConversationsFts    │  │      MessagesFts          │   │ │
│  │  │ rowid → Conversations │  │ rowid → Messages          │   │ │
│  │  │ Title (indexed)       │  │ Content (indexed)         │   │ │
│  │  └───────────────────────┘  └───────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  External Content = FTS5 stores only index, not content copy     │
│  Saves disk space, always queries current content                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### FTS5 Query Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                       FTS5 Query Flow                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User types "database migration"                                 │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SearchQuery                                               │    │
│  │   Text: "database migration"                              │    │
│  │   FilterType: null (search both)                          │    │
│  │   MaxResults: 50                                          │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ Sanitize → "\"database\"* \"migration\"*"                 │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│            ┌─────────────────┴─────────────────┐                 │
│            ▼                                   ▼                 │
│  ┌────────────────────────┐      ┌────────────────────────┐      │
│  │ SELECT ... FROM        │      │ SELECT ... FROM        │      │
│  │ ConversationsFts       │      │ MessagesFts            │      │
│  │ MATCH query            │      │ MATCH query            │      │
│  │ ORDER BY bm25()        │      │ ORDER BY bm25()        │      │
│  └────────────┬───────────┘      └────────────┬───────────┘      │
│               │                               │                  │
│               ▼                               ▼                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ SearchResults                                             │   │
│  │   Conversations: [result1, result2, ...]                  │   │
│  │   Messages: [result1, result2, ...]                       │   │
│  │   TotalCount: 15                                          │   │
│  │   SearchDuration: 23ms                                    │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Models/
    ├── SearchResult.cs                               (NEW)
    ├── SearchQuery.cs                                (NEW)
    └── SearchResults.cs                              (NEW)

src/SeniorIntern.Data/
├── Migrations/
│   └── YYYYMMDDHHMMSS_AddFts5SearchTables.cs         (NEW)
└── SeniorInternDbContext.cs                          (UPDATE)
```

---

## Implementation Details

### Task 1: Create SearchResult Model

**File:** `src/SeniorIntern.Core/Models/SearchResult.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Represents a single search result with relevance ranking.</summary>
public sealed class SearchResult
{
    /// <summary>Unique identifier of the matched item.</summary>
    public required Guid Id { get; init; }

    /// <summary>Type of result (Conversation or Message).</summary>
    public required SearchResultType Type { get; init; }

    /// <summary>Title or summary of the result.</summary>
    public required string Title { get; init; }

    /// <summary>Plain text snippet around the match.</summary>
    public required string Snippet { get; init; }

    /// <summary>HTML snippet with &lt;mark&gt; tags highlighting matches.</summary>
    public required string HighlightedSnippet { get; init; }

    /// <summary>BM25 relevance score (higher = more relevant).</summary>
    public required double Rank { get; init; }

    /// <summary>Timestamp of the matched item.</summary>
    public required DateTime Timestamp { get; init; }

    /// <summary>For message results, the parent conversation ID.</summary>
    public Guid? ConversationId { get; init; }

    /// <summary>For message results, the parent conversation title.</summary>
    public string? ConversationTitle { get; init; }
}

/// <summary>Type of search result.</summary>
public enum SearchResultType
{
    /// <summary>Result from conversation titles.</summary>
    Conversation,

    /// <summary>Result from message content.</summary>
    Message
}
```

---

### Task 2: Create SearchQuery Model

**File:** `src/SeniorIntern.Core/Models/SearchQuery.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Represents a search query with options.</summary>
public sealed class SearchQuery
{
    /// <summary>The search text (required).</summary>
    public required string Text { get; init; }

    /// <summary>Optional filter to search only conversations or messages.</summary>
    public SearchResultType? FilterType { get; init; }

    /// <summary>Maximum number of results to return (default: 50).</summary>
    public int MaxResults { get; init; } = 50;

    /// <summary>Approximate length of snippets in characters (default: 150).</summary>
    public int SnippetLength { get; init; } = 150;

    /// <summary>Creates a query for searching all types.</summary>
    public static SearchQuery All(string text) => new() { Text = text };

    /// <summary>Creates a query for searching conversations only.</summary>
    public static SearchQuery Conversations(string text) => new()
    {
        Text = text,
        FilterType = SearchResultType.Conversation
    };

    /// <summary>Creates a query for searching messages only.</summary>
    public static SearchQuery Messages(string text) => new()
    {
        Text = text,
        FilterType = SearchResultType.Message
    };
}
```

---

### Task 3: Create SearchResults Container

**File:** `src/SeniorIntern.Core/Models/SearchResults.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>Container for grouped search results.</summary>
public sealed class SearchResults
{
    /// <summary>Matching conversations.</summary>
    public required IReadOnlyList<SearchResult> Conversations { get; init; }

    /// <summary>Matching messages.</summary>
    public required IReadOnlyList<SearchResult> Messages { get; init; }

    /// <summary>Total count of all results.</summary>
    public required int TotalCount { get; init; }

    /// <summary>Time taken to execute the search.</summary>
    public required TimeSpan SearchDuration { get; init; }

    /// <summary>Returns true if no results were found.</summary>
    public bool IsEmpty => TotalCount == 0;

    /// <summary>Empty result set.</summary>
    public static SearchResults Empty => new()
    {
        Conversations = [],
        Messages = [],
        TotalCount = 0,
        SearchDuration = TimeSpan.Zero
    };
}
```

---

### Task 4: Create FTS5 Migration

**File:** `src/SeniorIntern.Data/Migrations/YYYYMMDDHHMMSS_AddFts5SearchTables.cs`

```csharp
using Microsoft.EntityFrameworkCore.Migrations;

namespace SeniorIntern.Data.Migrations;

public partial class AddFts5SearchTables : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // Create FTS5 virtual table for conversations (external content)
        migrationBuilder.Sql("""
            CREATE VIRTUAL TABLE IF NOT EXISTS ConversationsFts USING fts5(
                Title,
                content='Conversations',
                content_rowid='Id'
            );
        """);

        // Create FTS5 virtual table for messages (external content)
        migrationBuilder.Sql("""
            CREATE VIRTUAL TABLE IF NOT EXISTS MessagesFts USING fts5(
                Content,
                content='Messages',
                content_rowid='Id'
            );
        """);

        // Triggers: Conversations INSERT
        migrationBuilder.Sql("""
            CREATE TRIGGER Conversations_ai AFTER INSERT ON Conversations BEGIN
                INSERT INTO ConversationsFts(rowid, Title) VALUES (new.Id, new.Title);
            END;
        """);

        // Triggers: Conversations DELETE
        migrationBuilder.Sql("""
            CREATE TRIGGER Conversations_ad AFTER DELETE ON Conversations BEGIN
                INSERT INTO ConversationsFts(ConversationsFts, rowid, Title)
                VALUES('delete', old.Id, old.Title);
            END;
        """);

        // Triggers: Conversations UPDATE
        migrationBuilder.Sql("""
            CREATE TRIGGER Conversations_au AFTER UPDATE ON Conversations BEGIN
                INSERT INTO ConversationsFts(ConversationsFts, rowid, Title)
                VALUES('delete', old.Id, old.Title);
                INSERT INTO ConversationsFts(rowid, Title) VALUES (new.Id, new.Title);
            END;
        """);

        // Triggers: Messages INSERT
        migrationBuilder.Sql("""
            CREATE TRIGGER Messages_ai AFTER INSERT ON Messages BEGIN
                INSERT INTO MessagesFts(rowid, Content) VALUES (new.Id, new.Content);
            END;
        """);

        // Triggers: Messages DELETE
        migrationBuilder.Sql("""
            CREATE TRIGGER Messages_ad AFTER DELETE ON Messages BEGIN
                INSERT INTO MessagesFts(MessagesFts, rowid, Content)
                VALUES('delete', old.Id, old.Content);
            END;
        """);

        // Triggers: Messages UPDATE
        migrationBuilder.Sql("""
            CREATE TRIGGER Messages_au AFTER UPDATE ON Messages BEGIN
                INSERT INTO MessagesFts(MessagesFts, rowid, Content)
                VALUES('delete', old.Id, old.Content);
                INSERT INTO MessagesFts(rowid, Content) VALUES (new.Id, new.Content);
            END;
        """);

        // Populate FTS tables with existing data
        migrationBuilder.Sql("""
            INSERT INTO ConversationsFts(rowid, Title)
            SELECT Id, Title FROM Conversations;
        """);

        migrationBuilder.Sql("""
            INSERT INTO MessagesFts(rowid, Content)
            SELECT Id, Content FROM Messages;
        """);
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        // Drop triggers
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Messages_au;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Messages_ad;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Messages_ai;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Conversations_au;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Conversations_ad;");
        migrationBuilder.Sql("DROP TRIGGER IF EXISTS Conversations_ai;");

        // Drop FTS tables
        migrationBuilder.Sql("DROP TABLE IF EXISTS MessagesFts;");
        migrationBuilder.Sql("DROP TABLE IF EXISTS ConversationsFts;");
    }
}
```

---

### Task 5: Update DbContext for FTS Support

**File:** `src/SeniorIntern.Data/SeniorInternDbContext.cs` (additions)

```csharp
// Add methods to support raw FTS5 queries
public partial class SeniorInternDbContext
{
    /// <summary>Gets the database connection for raw SQL queries.</summary>
    public DbConnection GetConnection() => Database.GetDbConnection();

    /// <summary>Opens the database connection if not already open.</summary>
    public async Task OpenConnectionAsync(CancellationToken ct = default)
        => await Database.OpenConnectionAsync(ct);

    /// <summary>Closes the database connection.</summary>
    public async Task CloseConnectionAsync()
        => await Database.CloseConnectionAsync();
}
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| SearchResult | 2 | Construction, MessageResult with conversation |
| SearchQuery | 3 | Factory methods, defaults |
| SearchResults | 2 | Empty, IsEmpty property |
| Migration | 3 | Up executes, Down executes, Triggers work |
| **Total** | **10** | |

### Key Test Scenarios

```csharp
[Fact]
public void SearchQuery_All_CreatesWithNullFilter()
{
    var query = SearchQuery.All("test");
    Assert.Equal("test", query.Text);
    Assert.Null(query.FilterType);
    Assert.Equal(50, query.MaxResults);
}

[Fact]
public void SearchQuery_Conversations_FiltersToConversations()
{
    var query = SearchQuery.Conversations("test");
    Assert.Equal(SearchResultType.Conversation, query.FilterType);
}

[Fact]
public void SearchResults_Empty_HasZeroCounts()
{
    var results = SearchResults.Empty;
    Assert.True(results.IsEmpty);
    Assert.Equal(0, results.TotalCount);
    Assert.Empty(results.Conversations);
    Assert.Empty(results.Messages);
}

[Fact]
public void SearchResult_MessageType_IncludesConversationInfo()
{
    var result = new SearchResult
    {
        Id = Guid.NewGuid(),
        Type = SearchResultType.Message,
        Title = "Message preview",
        Snippet = "...the database migration...",
        HighlightedSnippet = "...the <mark>database</mark> <mark>migration</mark>...",
        Rank = 15.7,
        Timestamp = DateTime.UtcNow,
        ConversationId = Guid.NewGuid(),
        ConversationTitle = "Database Discussion"
    };

    Assert.NotNull(result.ConversationId);
    Assert.NotNull(result.ConversationTitle);
}
```

### Integration Test: FTS5 Triggers

```csharp
[Fact]
public async Task FtsIndex_SyncsOnInsert()
{
    await using var db = CreateTestDb();

    var conversation = new ConversationEntity { Title = "Test FTS Indexing" };
    db.Conversations.Add(conversation);
    await db.SaveChangesAsync();

    // Query FTS directly
    var count = await db.Database.ExecuteSqlRawAsync(
        "SELECT COUNT(*) FROM ConversationsFts WHERE ConversationsFts MATCH 'FTS'");
    Assert.Equal(1, count);
}

[Fact]
public async Task FtsIndex_SyncsOnDelete()
{
    await using var db = CreateTestDb();

    var conversation = new ConversationEntity { Title = "Delete Me" };
    db.Conversations.Add(conversation);
    await db.SaveChangesAsync();

    db.Conversations.Remove(conversation);
    await db.SaveChangesAsync();

    var count = await db.Database.ExecuteSqlRawAsync(
        "SELECT COUNT(*) FROM ConversationsFts WHERE ConversationsFts MATCH 'Delete'");
    Assert.Equal(0, count);
}
```

---

## Files Summary

### Files to Create (4)

| File | Lines (approx) |
|------|----------------|
| `Core/Models/SearchResult.cs` | 45 |
| `Core/Models/SearchQuery.cs` | 40 |
| `Core/Models/SearchResults.cs` | 35 |
| `Data/Migrations/AddFts5SearchTables.cs` | 100 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Data/SeniorInternDbContext.cs` | Add connection helper methods |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | ConversationsFts virtual table created successfully |
| AC-2 | MessagesFts virtual table created successfully |
| AC-3 | INSERT trigger populates FTS on new conversation |
| AC-4 | DELETE trigger removes from FTS on conversation delete |
| AC-5 | UPDATE trigger updates FTS on conversation title change |
| AC-6 | Messages triggers work correctly for all operations |
| AC-7 | Existing data populated into FTS on migration |
| AC-8 | SearchResult model includes all required properties |
| AC-9 | SearchQuery factory methods create correct filters |
| AC-10 | Migration Down() cleanly removes all FTS objects |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| External content FTS5 | Saves disk space, always queries current data |
| Triggers for sync | Automatic, no code needed for sync |
| BM25 ranking | Industry-standard relevance scoring |
| Snippet with `<mark>` | Easy highlighting in UI |
| Separate Conversations/Messages FTS | Different content types need different handling |

---

## FTS5 Query Syntax Reference

| Syntax | Description |
|--------|-------------|
| `word` | Match exact word |
| `word*` | Prefix matching |
| `"phrase"` | Exact phrase match |
| `word1 word2` | Both words (AND) |
| `word1 OR word2` | Either word |
| `NEAR(word1 word2, N)` | Words within N tokens |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.5a | 0.5 day |
