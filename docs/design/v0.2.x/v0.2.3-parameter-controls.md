# Design Specification: The Senior Intern v0.2.3 "Parameter Controls"

## Executive Summary

This document provides a comprehensive design specification for v0.2.3, which adds user interface controls for inference parameters (Temperature, Top-P, Max Tokens, Context Size) with real-time feedback, preset management, and persistent settings. This sub-version gives users fine-grained control over the LLM's behavior.

### v0.2.3 Scope (from v0.2.0 Design Document)
- Inference sliders for Temperature, Top-P, Max Tokens, and Context Size
- Real-time preview and description of parameter effects
- Preset management (save, load, delete custom presets)
- Built-in presets for common use cases (Precise, Balanced, Creative, Long-form)
- Settings persistence across application restarts

### Dependencies
- **v0.2.1** must be complete (database foundation with InferencePresetEntity)
- **v0.2.2** must be complete (conversation persistence, service patterns)

---

## Sub-Part Breakdown

| Part | Name | Focus |
|------|------|-------|
| v0.2.3a | Models & Repository | InferenceOptions, preset repository, built-in presets |
| v0.2.3b | Settings Service | IInferenceSettingsService, persistence, change events |
| v0.2.3c | ViewModels | InferenceSettingsViewModel, InferencePresetViewModel |
| v0.2.3d | Parameter Slider Control | Custom ParameterSlider control with labels and descriptions |
| v0.2.3e | Settings Panel UI | InferenceSettingsPanel, preset dropdown, integration |

---

## Architecture Overview

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              User Interface                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    InferenceSettingsPanel                            │    │
│  │  ┌─────────────────┐  ┌────────────────────────────────────────┐   │    │
│  │  │ Preset Dropdown │  │        Parameter Sliders               │   │    │
│  │  │ - Precise       │  │  ┌──────────────────────────────────┐  │   │    │
│  │  │ - Balanced      │  │  │ Temperature    [=====●=====] 0.7 │  │   │    │
│  │  │ - Creative      │  │  │ Balanced creativity               │  │   │    │
│  │  │ - Long-form     │  │  ├──────────────────────────────────┤  │   │    │
│  │  │ - Custom...     │  │  │ Top-P         [=======●===] 0.90 │  │   │    │
│  │  └─────────────────┘  │  │ 90% probability mass              │  │   │    │
│  │                       │  ├──────────────────────────────────┤  │   │    │
│  │  [Save Preset]        │  │ Max Tokens    [===●=========] 2048│  │   │    │
│  │  [Reset to Default]   │  │ ~1500 words maximum               │  │   │    │
│  │                       │  ├──────────────────────────────────┤  │   │    │
│  │                       │  │ Context Size  [===●=========] 4096│  │   │    │
│  │                       │  │ ~3000 words of history            │  │   │    │
│  │                       │  └──────────────────────────────────┘  │   │    │
│  │                       └────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      InferenceSettingsViewModel                              │
│  - Temperature, TopP, MaxTokens, ContextSize properties                      │
│  - SelectedPreset                                                            │
│  - SavePresetCommand, ApplyPresetCommand, ResetCommand                      │
│  - Auto-save on change (debounced)                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      IInferenceSettingsService                               │
│  - CurrentOptions (live inference settings)                                  │
│  - GetPresetsAsync, SavePresetAsync, DeletePresetAsync                      │
│  - ApplyPreset, ResetToDefaults                                             │
│  - SettingsChanged event                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
        ┌───────────────────┐ ┌─────────────┐ ┌─────────────────┐
        │IInferencePreset   │ │ISettings    │ │    ILlmService  │
        │Repository         │ │Service      │ │  (uses options) │
        └───────────────────┘ └─────────────┘ └─────────────────┘
                    │                 │
                    ▼                 ▼
        ┌───────────────────┐ ┌─────────────────┐
        │   SQLite DB       │ │  settings.json  │
        │ InferencePresets  │ │ (quick access)  │
        └───────────────────┘ └─────────────────┘
```

### Data Flow

```
User adjusts slider
        │
        ▼
┌─────────────────────┐
│ ViewModel property  │
│     changes         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Debounce timer      │
│    (200ms)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ IInferenceSettings  │
│ Service.Update()    │
└──────────┬──────────┘
           │
     ┌─────┴─────┐
     ▼           ▼
┌─────────┐ ┌──────────┐
│ Persist │ │  Update  │
│ to JSON │ │CurrentOpts│
└─────────┘ └────┬─────┘
                 │
                 ▼
          ┌────────────┐
          │Fire event  │
          │to LlmService│
          └────────────┘
```

---

## v0.2.3a: Models & Repository

### Objective
Define the inference options model, enhance the preset entity, implement the repository, and seed built-in presets.

### InferenceOptions Model

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Options for LLM inference
/// </summary>
public sealed class InferenceOptions
{
    /// <summary>
    /// Controls randomness in output generation.
    /// Range: 0.0 - 2.0
    /// Lower = more deterministic, Higher = more creative
    /// </summary>
    public float Temperature { get; set; } = 0.7f;

    /// <summary>
    /// Nucleus sampling threshold.
    /// Range: 0.0 - 1.0
    /// Only considers tokens within the top cumulative probability
    /// </summary>
    public float TopP { get; set; } = 0.9f;

    /// <summary>
    /// Maximum number of tokens to generate.
    /// Range: 64 - 8192
    /// </summary>
    public int MaxTokens { get; set; } = 2048;

    /// <summary>
    /// Context window size for conversation history.
    /// Range: 512 - 32768
    /// Must be supported by the loaded model
    /// </summary>
    public uint ContextSize { get; set; } = 4096;

    /// <summary>
    /// Repetition penalty to discourage repetitive text.
    /// Range: 1.0 - 2.0
    /// 1.0 = no penalty
    /// </summary>
    public float RepetitionPenalty { get; set; } = 1.1f;

    /// <summary>
    /// Top-K sampling. 0 = disabled.
    /// Range: 0 - 100
    /// </summary>
    public int TopK { get; set; } = 40;

    /// <summary>
    /// Random seed for reproducibility.
    /// -1 = random seed each time
    /// </summary>
    public int Seed { get; set; } = -1;

    /// <summary>
    /// Creates a copy of the options
    /// </summary>
    public InferenceOptions Clone() => new()
    {
        Temperature = Temperature,
        TopP = TopP,
        MaxTokens = MaxTokens,
        ContextSize = ContextSize,
        RepetitionPenalty = RepetitionPenalty,
        TopK = TopK,
        Seed = Seed
    };

    /// <summary>
    /// Validates that all values are within acceptable ranges
    /// </summary>
    public ValidationResult Validate()
    {
        var errors = new List<string>();

        if (Temperature < 0f || Temperature > 2f)
            errors.Add("Temperature must be between 0.0 and 2.0");

        if (TopP < 0f || TopP > 1f)
            errors.Add("Top-P must be between 0.0 and 1.0");

        if (MaxTokens < 64 || MaxTokens > 8192)
            errors.Add("Max Tokens must be between 64 and 8192");

        if (ContextSize < 512 || ContextSize > 32768)
            errors.Add("Context Size must be between 512 and 32768");

        if (RepetitionPenalty < 1f || RepetitionPenalty > 2f)
            errors.Add("Repetition Penalty must be between 1.0 and 2.0");

        if (TopK < 0 || TopK > 100)
            errors.Add("Top-K must be between 0 and 100");

        return new ValidationResult(errors.Count == 0, errors);
    }
}

/// <summary>
/// Result of validation
/// </summary>
public sealed record ValidationResult(bool IsValid, IReadOnlyList<string> Errors);
```

### InferencePreset Model

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// A named preset of inference options
/// </summary>
public sealed class InferencePreset
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Category { get; set; }
    public bool IsBuiltIn { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    public InferenceOptions Options { get; set; } = new();

    /// <summary>
    /// Creates a new preset from current options
    /// </summary>
    public static InferencePreset FromOptions(string name, InferenceOptions options) => new()
    {
        Name = name,
        Options = options.Clone()
    };
}
```

### InferencePresetEntity (Update)

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Entity for storing inference presets in the database
/// </summary>
public sealed class InferencePresetEntity
{
    public Guid Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Category { get; set; }

    // Parameters
    public float Temperature { get; set; } = 0.7f;
    public float TopP { get; set; } = 0.9f;
    public int MaxTokens { get; set; } = 2048;
    public uint ContextSize { get; set; } = 4096;
    public float RepetitionPenalty { get; set; } = 1.1f;
    public int TopK { get; set; } = 40;
    public int Seed { get; set; } = -1;

    // Metadata
    public bool IsBuiltIn { get; set; }
    public bool IsDefault { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public int UsageCount { get; set; }
}
```

### IInferencePresetRepository Interface

```csharp
namespace SeniorIntern.Data.Repositories;

using SeniorIntern.Core.Entities;

/// <summary>
/// Repository for inference presets
/// </summary>
public interface IInferencePresetRepository
{
    /// <summary>
    /// Get all presets, ordered by built-in first, then by name
    /// </summary>
    Task<IReadOnlyList<InferencePresetEntity>> GetAllAsync(CancellationToken ct = default);

    /// <summary>
    /// Get a preset by ID
    /// </summary>
    Task<InferencePresetEntity?> GetByIdAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Get a preset by name
    /// </summary>
    Task<InferencePresetEntity?> GetByNameAsync(string name, CancellationToken ct = default);

    /// <summary>
    /// Get the default preset
    /// </summary>
    Task<InferencePresetEntity?> GetDefaultAsync(CancellationToken ct = default);

    /// <summary>
    /// Get presets by category
    /// </summary>
    Task<IReadOnlyList<InferencePresetEntity>> GetByCategoryAsync(
        string category,
        CancellationToken ct = default);

    /// <summary>
    /// Create a new preset
    /// </summary>
    Task<InferencePresetEntity> CreateAsync(
        InferencePresetEntity preset,
        CancellationToken ct = default);

    /// <summary>
    /// Update an existing preset
    /// </summary>
    Task UpdateAsync(InferencePresetEntity preset, CancellationToken ct = default);

    /// <summary>
    /// Delete a preset (cannot delete built-in presets)
    /// </summary>
    Task DeleteAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Set a preset as default (clears previous default)
    /// </summary>
    Task SetAsDefaultAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Increment usage count for a preset
    /// </summary>
    Task IncrementUsageAsync(Guid id, CancellationToken ct = default);

    /// <summary>
    /// Check if a preset name exists
    /// </summary>
    Task<bool> NameExistsAsync(string name, Guid? excludeId = null, CancellationToken ct = default);

    /// <summary>
    /// Seed built-in presets if they don't exist
    /// </summary>
    Task SeedBuiltInPresetsAsync(CancellationToken ct = default);
}
```

### InferencePresetRepository Implementation

```csharp
namespace SeniorIntern.Data.Repositories;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Entities;

/// <summary>
/// Repository implementation for inference presets
/// </summary>
public sealed class InferencePresetRepository : IInferencePresetRepository
{
    private readonly SeniorInternDbContext _context;
    private readonly ILogger<InferencePresetRepository> _logger;

    public InferencePresetRepository(
        SeniorInternDbContext context,
        ILogger<InferencePresetRepository> logger)
    {
        _context = context;
        _logger = logger;
    }

    public async Task<IReadOnlyList<InferencePresetEntity>> GetAllAsync(CancellationToken ct = default)
    {
        return await _context.InferencePresets
            .OrderByDescending(p => p.IsBuiltIn)
            .ThenByDescending(p => p.IsDefault)
            .ThenBy(p => p.Name)
            .ToListAsync(ct);
    }

    public async Task<InferencePresetEntity?> GetByIdAsync(Guid id, CancellationToken ct = default)
    {
        return await _context.InferencePresets.FindAsync(new object[] { id }, ct);
    }

    public async Task<InferencePresetEntity?> GetByNameAsync(string name, CancellationToken ct = default)
    {
        return await _context.InferencePresets
            .FirstOrDefaultAsync(p => p.Name == name, ct);
    }

    public async Task<InferencePresetEntity?> GetDefaultAsync(CancellationToken ct = default)
    {
        return await _context.InferencePresets
            .FirstOrDefaultAsync(p => p.IsDefault, ct);
    }

    public async Task<IReadOnlyList<InferencePresetEntity>> GetByCategoryAsync(
        string category,
        CancellationToken ct = default)
    {
        return await _context.InferencePresets
            .Where(p => p.Category == category)
            .OrderBy(p => p.Name)
            .ToListAsync(ct);
    }

    public async Task<InferencePresetEntity> CreateAsync(
        InferencePresetEntity preset,
        CancellationToken ct = default)
    {
        preset.CreatedAt = DateTime.UtcNow;
        preset.UpdatedAt = DateTime.UtcNow;

        _context.InferencePresets.Add(preset);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Created inference preset: {Name}", preset.Name);
        return preset;
    }

    public async Task UpdateAsync(InferencePresetEntity preset, CancellationToken ct = default)
    {
        var existing = await _context.InferencePresets.FindAsync(new object[] { preset.Id }, ct);
        if (existing == null)
        {
            throw new InvalidOperationException($"Preset {preset.Id} not found");
        }

        if (existing.IsBuiltIn)
        {
            throw new InvalidOperationException("Cannot modify built-in presets");
        }

        existing.Name = preset.Name;
        existing.Description = preset.Description;
        existing.Category = preset.Category;
        existing.Temperature = preset.Temperature;
        existing.TopP = preset.TopP;
        existing.MaxTokens = preset.MaxTokens;
        existing.ContextSize = preset.ContextSize;
        existing.RepetitionPenalty = preset.RepetitionPenalty;
        existing.TopK = preset.TopK;
        existing.Seed = preset.Seed;
        existing.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync(ct);
        _logger.LogDebug("Updated inference preset: {Name}", preset.Name);
    }

    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        var preset = await _context.InferencePresets.FindAsync(new object[] { id }, ct);
        if (preset == null)
            return;

        if (preset.IsBuiltIn)
        {
            throw new InvalidOperationException("Cannot delete built-in presets");
        }

        _context.InferencePresets.Remove(preset);
        await _context.SaveChangesAsync(ct);

        _logger.LogDebug("Deleted inference preset: {Name}", preset.Name);
    }

    public async Task SetAsDefaultAsync(Guid id, CancellationToken ct = default)
    {
        // Clear existing default
        var currentDefault = await _context.InferencePresets
            .FirstOrDefaultAsync(p => p.IsDefault, ct);

        if (currentDefault != null)
        {
            currentDefault.IsDefault = false;
        }

        // Set new default
        var newDefault = await _context.InferencePresets.FindAsync(new object[] { id }, ct);
        if (newDefault != null)
        {
            newDefault.IsDefault = true;
            await _context.SaveChangesAsync(ct);
            _logger.LogDebug("Set default preset: {Name}", newDefault.Name);
        }
    }

    public async Task IncrementUsageAsync(Guid id, CancellationToken ct = default)
    {
        var preset = await _context.InferencePresets.FindAsync(new object[] { id }, ct);
        if (preset != null)
        {
            preset.UsageCount++;
            await _context.SaveChangesAsync(ct);
        }
    }

    public async Task<bool> NameExistsAsync(
        string name,
        Guid? excludeId = null,
        CancellationToken ct = default)
    {
        var query = _context.InferencePresets.Where(p => p.Name == name);

        if (excludeId.HasValue)
        {
            query = query.Where(p => p.Id != excludeId.Value);
        }

        return await query.AnyAsync(ct);
    }

    public async Task SeedBuiltInPresetsAsync(CancellationToken ct = default)
    {
        var existingBuiltIn = await _context.InferencePresets
            .AnyAsync(p => p.IsBuiltIn, ct);

        if (existingBuiltIn)
        {
            _logger.LogDebug("Built-in presets already seeded");
            return;
        }

        var builtInPresets = GetBuiltInPresets();

        _context.InferencePresets.AddRange(builtInPresets);
        await _context.SaveChangesAsync(ct);

        _logger.LogInformation("Seeded {Count} built-in inference presets", builtInPresets.Count);
    }

    private static List<InferencePresetEntity> GetBuiltInPresets() => new()
    {
        new InferencePresetEntity
        {
            Id = Guid.Parse("00000001-0000-0000-0000-000000000001"),
            Name = "Precise",
            Description = "Focused and deterministic responses. Best for code generation, factual queries, and tasks requiring accuracy.",
            Category = "Built-in",
            Temperature = 0.2f,
            TopP = 0.8f,
            MaxTokens = 1024,
            ContextSize = 4096,
            RepetitionPenalty = 1.1f,
            TopK = 40,
            IsBuiltIn = true,
            IsDefault = false,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        },
        new InferencePresetEntity
        {
            Id = Guid.Parse("00000001-0000-0000-0000-000000000002"),
            Name = "Balanced",
            Description = "A good balance between creativity and consistency. Suitable for most general conversations.",
            Category = "Built-in",
            Temperature = 0.7f,
            TopP = 0.9f,
            MaxTokens = 2048,
            ContextSize = 4096,
            RepetitionPenalty = 1.1f,
            TopK = 40,
            IsBuiltIn = true,
            IsDefault = true,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        },
        new InferencePresetEntity
        {
            Id = Guid.Parse("00000001-0000-0000-0000-000000000003"),
            Name = "Creative",
            Description = "More varied and creative responses. Great for brainstorming, creative writing, and exploring ideas.",
            Category = "Built-in",
            Temperature = 1.2f,
            TopP = 0.95f,
            MaxTokens = 4096,
            ContextSize = 8192,
            RepetitionPenalty = 1.05f,
            TopK = 50,
            IsBuiltIn = true,
            IsDefault = false,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        },
        new InferencePresetEntity
        {
            Id = Guid.Parse("00000001-0000-0000-0000-000000000004"),
            Name = "Long-form",
            Description = "Optimized for detailed, lengthy responses. Ideal for documentation, explanations, and comprehensive answers.",
            Category = "Built-in",
            Temperature = 0.7f,
            TopP = 0.9f,
            MaxTokens = 8192,
            ContextSize = 16384,
            RepetitionPenalty = 1.15f,
            TopK = 40,
            IsBuiltIn = true,
            IsDefault = false,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        },
        new InferencePresetEntity
        {
            Id = Guid.Parse("00000001-0000-0000-0000-000000000005"),
            Name = "Code Review",
            Description = "Tuned for analyzing and reviewing code. Consistent and thorough.",
            Category = "Built-in",
            Temperature = 0.3f,
            TopP = 0.85f,
            MaxTokens = 2048,
            ContextSize = 8192,
            RepetitionPenalty = 1.0f,
            TopK = 30,
            IsBuiltIn = true,
            IsDefault = false,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        }
    };
}
```

### Parameter Constants

```csharp
namespace SeniorIntern.Core;

/// <summary>
/// Constants for inference parameters
/// </summary>
public static class ParameterConstants
{
    public static class Temperature
    {
        public const float Min = 0.0f;
        public const float Max = 2.0f;
        public const float Default = 0.7f;
        public const float Step = 0.1f;
    }

    public static class TopP
    {
        public const float Min = 0.0f;
        public const float Max = 1.0f;
        public const float Default = 0.9f;
        public const float Step = 0.05f;
    }

    public static class MaxTokens
    {
        public const int Min = 64;
        public const int Max = 8192;
        public const int Default = 2048;
        public const int Step = 64;
    }

    public static class ContextSize
    {
        public const uint Min = 512;
        public const uint Max = 32768;
        public const uint Default = 4096;
        public const uint Step = 512;
    }

    public static class RepetitionPenalty
    {
        public const float Min = 1.0f;
        public const float Max = 2.0f;
        public const float Default = 1.1f;
        public const float Step = 0.05f;
    }

    public static class TopK
    {
        public const int Min = 0;
        public const int Max = 100;
        public const int Default = 40;
        public const int Step = 5;
    }
}
```

### v0.2.3a Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Models/InferenceOptions.cs` | Inference options model |
| `src/SeniorIntern.Core/Models/InferencePreset.cs` | Preset domain model |
| `src/SeniorIntern.Core/ParameterConstants.cs` | Parameter range constants |
| `src/SeniorIntern.Data/Repositories/IInferencePresetRepository.cs` | Repository interface |
| `src/SeniorIntern.Data/Repositories/InferencePresetRepository.cs` | Repository implementation |

### v0.2.3a Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs` | Add additional fields |
| `src/SeniorIntern.Data/Configurations/InferencePresetConfiguration.cs` | Update EF config |

---

## v0.2.3b: Settings Service

### Objective
Implement the inference settings service that manages current inference options, handles persistence, and notifies consumers of changes.

### IInferenceSettingsService Interface

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>
/// Service for managing inference settings
/// </summary>
public interface IInferenceSettingsService
{
    /// <summary>
    /// Current inference options (live, used by LlmService)
    /// </summary>
    InferenceOptions CurrentOptions { get; }

    /// <summary>
    /// Currently active preset (null if custom settings)
    /// </summary>
    InferencePreset? ActivePreset { get; }

    /// <summary>
    /// Whether current settings differ from active preset
    /// </summary>
    bool HasUnsavedChanges { get; }

    /// <summary>
    /// Update a single parameter
    /// </summary>
    void UpdateTemperature(float value);
    void UpdateTopP(float value);
    void UpdateMaxTokens(int value);
    void UpdateContextSize(uint value);
    void UpdateRepetitionPenalty(float value);
    void UpdateTopK(int value);

    /// <summary>
    /// Apply all settings at once
    /// </summary>
    void UpdateAll(InferenceOptions options);

    /// <summary>
    /// Get all available presets
    /// </summary>
    Task<IReadOnlyList<InferencePreset>> GetPresetsAsync(CancellationToken ct = default);

    /// <summary>
    /// Apply a preset (loads its settings)
    /// </summary>
    Task ApplyPresetAsync(Guid presetId, CancellationToken ct = default);

    /// <summary>
    /// Save current settings as a new preset
    /// </summary>
    Task<InferencePreset> SaveAsPresetAsync(
        string name,
        string? description = null,
        CancellationToken ct = default);

    /// <summary>
    /// Update an existing preset with current settings
    /// </summary>
    Task UpdatePresetAsync(Guid presetId, CancellationToken ct = default);

    /// <summary>
    /// Delete a preset
    /// </summary>
    Task DeletePresetAsync(Guid presetId, CancellationToken ct = default);

    /// <summary>
    /// Reset to default preset
    /// </summary>
    Task ResetToDefaultsAsync(CancellationToken ct = default);

    /// <summary>
    /// Set a preset as the default
    /// </summary>
    Task SetDefaultPresetAsync(Guid presetId, CancellationToken ct = default);

    /// <summary>
    /// Fired when settings change
    /// </summary>
    event EventHandler<InferenceSettingsChangedEventArgs>? SettingsChanged;

    /// <summary>
    /// Fired when the active preset changes
    /// </summary>
    event EventHandler<PresetChangedEventArgs>? PresetChanged;
}
```

### Event Args

```csharp
namespace SeniorIntern.Core.Events;

using SeniorIntern.Core.Models;

/// <summary>
/// Event args for inference settings changes
/// </summary>
public sealed class InferenceSettingsChangedEventArgs : EventArgs
{
    public required InferenceOptions NewOptions { get; init; }
    public required InferenceSettingsChangeType ChangeType { get; init; }
    public string? ChangedParameter { get; init; }
}

public enum InferenceSettingsChangeType
{
    ParameterChanged,
    PresetApplied,
    ResetToDefaults,
    AllChanged
}

/// <summary>
/// Event args for preset changes
/// </summary>
public sealed class PresetChangedEventArgs : EventArgs
{
    public InferencePreset? NewPreset { get; init; }
    public InferencePreset? PreviousPreset { get; init; }
    public required PresetChangeType ChangeType { get; init; }
}

public enum PresetChangeType
{
    Applied,
    Created,
    Updated,
    Deleted,
    DefaultChanged
}
```

### InferenceSettingsService Implementation

```csharp
namespace SeniorIntern.Services;

using Microsoft.Extensions.Logging;
using SeniorIntern.Core;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data.Repositories;

/// <summary>
/// Service for managing inference settings
/// </summary>
public sealed class InferenceSettingsService : IInferenceSettingsService, IAsyncDisposable
{
    private readonly IInferencePresetRepository _presetRepository;
    private readonly ISettingsService _settingsService;
    private readonly ILogger<InferenceSettingsService> _logger;

    private InferenceOptions _currentOptions = new();
    private InferencePreset? _activePreset;
    private InferenceOptions? _presetSnapshot;
    private readonly SemaphoreSlim _lock = new(1, 1);

    public InferenceOptions CurrentOptions => _currentOptions;
    public InferencePreset? ActivePreset => _activePreset;

    public bool HasUnsavedChanges
    {
        get
        {
            if (_activePreset == null || _presetSnapshot == null)
                return false;

            return !OptionsEqual(_currentOptions, _presetSnapshot);
        }
    }

    public event EventHandler<InferenceSettingsChangedEventArgs>? SettingsChanged;
    public event EventHandler<PresetChangedEventArgs>? PresetChanged;

    public InferenceSettingsService(
        IInferencePresetRepository presetRepository,
        ISettingsService settingsService,
        ILogger<InferenceSettingsService> logger)
    {
        _presetRepository = presetRepository;
        _settingsService = settingsService;
        _logger = logger;
    }

    /// <summary>
    /// Initialize the service (load default preset)
    /// </summary>
    public async Task InitializeAsync(CancellationToken ct = default)
    {
        await _presetRepository.SeedBuiltInPresetsAsync(ct);

        // Try to load last used preset from settings
        var settings = _settingsService.GetSettings();
        if (settings.ActiveInferencePresetId.HasValue)
        {
            try
            {
                await ApplyPresetAsync(settings.ActiveInferencePresetId.Value, ct);
                return;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, "Failed to load last preset, falling back to default");
            }
        }

        // Fall back to default preset
        await ResetToDefaultsAsync(ct);
    }

    // === Parameter Updates ===

    public void UpdateTemperature(float value)
    {
        value = Math.Clamp(value, ParameterConstants.Temperature.Min, ParameterConstants.Temperature.Max);
        if (Math.Abs(_currentOptions.Temperature - value) < 0.001f)
            return;

        _currentOptions.Temperature = value;
        OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged, nameof(InferenceOptions.Temperature));
    }

    public void UpdateTopP(float value)
    {
        value = Math.Clamp(value, ParameterConstants.TopP.Min, ParameterConstants.TopP.Max);
        if (Math.Abs(_currentOptions.TopP - value) < 0.001f)
            return;

        _currentOptions.TopP = value;
        OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged, nameof(InferenceOptions.TopP));
    }

    public void UpdateMaxTokens(int value)
    {
        value = Math.Clamp(value, ParameterConstants.MaxTokens.Min, ParameterConstants.MaxTokens.Max);
        if (_currentOptions.MaxTokens == value)
            return;

        _currentOptions.MaxTokens = value;
        OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged, nameof(InferenceOptions.MaxTokens));
    }

    public void UpdateContextSize(uint value)
    {
        value = Math.Clamp(value, ParameterConstants.ContextSize.Min, ParameterConstants.ContextSize.Max);
        if (_currentOptions.ContextSize == value)
            return;

        _currentOptions.ContextSize = value;
        OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged, nameof(InferenceOptions.ContextSize));
    }

    public void UpdateRepetitionPenalty(float value)
    {
        value = Math.Clamp(value, ParameterConstants.RepetitionPenalty.Min, ParameterConstants.RepetitionPenalty.Max);
        if (Math.Abs(_currentOptions.RepetitionPenalty - value) < 0.001f)
            return;

        _currentOptions.RepetitionPenalty = value;
        OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged, nameof(InferenceOptions.RepetitionPenalty));
    }

    public void UpdateTopK(int value)
    {
        value = Math.Clamp(value, ParameterConstants.TopK.Min, ParameterConstants.TopK.Max);
        if (_currentOptions.TopK == value)
            return;

        _currentOptions.TopK = value;
        OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged, nameof(InferenceOptions.TopK));
    }

    public void UpdateAll(InferenceOptions options)
    {
        var validation = options.Validate();
        if (!validation.IsValid)
        {
            throw new ArgumentException($"Invalid options: {string.Join(", ", validation.Errors)}");
        }

        _currentOptions = options.Clone();
        OnSettingsChanged(InferenceSettingsChangeType.AllChanged);
    }

    // === Preset Operations ===

    public async Task<IReadOnlyList<InferencePreset>> GetPresetsAsync(CancellationToken ct = default)
    {
        var entities = await _presetRepository.GetAllAsync(ct);
        return entities.Select(MapToPreset).ToList();
    }

    public async Task ApplyPresetAsync(Guid presetId, CancellationToken ct = default)
    {
        var entity = await _presetRepository.GetByIdAsync(presetId, ct);
        if (entity == null)
        {
            throw new InvalidOperationException($"Preset {presetId} not found");
        }

        var previousPreset = _activePreset;
        _activePreset = MapToPreset(entity);
        _currentOptions = _activePreset.Options.Clone();
        _presetSnapshot = _activePreset.Options.Clone();

        // Track usage
        await _presetRepository.IncrementUsageAsync(presetId, ct);

        // Persist selection
        await SaveActivePresetToSettingsAsync(presetId, ct);

        _logger.LogDebug("Applied preset: {Name}", _activePreset.Name);

        OnSettingsChanged(InferenceSettingsChangeType.PresetApplied);
        OnPresetChanged(_activePreset, previousPreset, PresetChangeType.Applied);
    }

    public async Task<InferencePreset> SaveAsPresetAsync(
        string name,
        string? description = null,
        CancellationToken ct = default)
    {
        await _lock.WaitAsync(ct);
        try
        {
            // Validate name
            if (string.IsNullOrWhiteSpace(name))
            {
                throw new ArgumentException("Preset name is required");
            }

            if (await _presetRepository.NameExistsAsync(name, ct: ct))
            {
                throw new InvalidOperationException($"A preset named '{name}' already exists");
            }

            var entity = new InferencePresetEntity
            {
                Id = Guid.NewGuid(),
                Name = name.Trim(),
                Description = description?.Trim(),
                Category = "Custom",
                Temperature = _currentOptions.Temperature,
                TopP = _currentOptions.TopP,
                MaxTokens = _currentOptions.MaxTokens,
                ContextSize = _currentOptions.ContextSize,
                RepetitionPenalty = _currentOptions.RepetitionPenalty,
                TopK = _currentOptions.TopK,
                Seed = _currentOptions.Seed,
                IsBuiltIn = false,
                IsDefault = false
            };

            await _presetRepository.CreateAsync(entity, ct);

            var preset = MapToPreset(entity);
            _activePreset = preset;
            _presetSnapshot = _currentOptions.Clone();

            // Persist selection
            await SaveActivePresetToSettingsAsync(entity.Id, ct);

            _logger.LogInformation("Created preset: {Name}", name);

            OnPresetChanged(preset, null, PresetChangeType.Created);

            return preset;
        }
        finally
        {
            _lock.Release();
        }
    }

    public async Task UpdatePresetAsync(Guid presetId, CancellationToken ct = default)
    {
        await _lock.WaitAsync(ct);
        try
        {
            var entity = await _presetRepository.GetByIdAsync(presetId, ct);
            if (entity == null)
            {
                throw new InvalidOperationException($"Preset {presetId} not found");
            }

            if (entity.IsBuiltIn)
            {
                throw new InvalidOperationException("Cannot modify built-in presets");
            }

            // Update with current options
            entity.Temperature = _currentOptions.Temperature;
            entity.TopP = _currentOptions.TopP;
            entity.MaxTokens = _currentOptions.MaxTokens;
            entity.ContextSize = _currentOptions.ContextSize;
            entity.RepetitionPenalty = _currentOptions.RepetitionPenalty;
            entity.TopK = _currentOptions.TopK;
            entity.Seed = _currentOptions.Seed;

            await _presetRepository.UpdateAsync(entity, ct);

            _presetSnapshot = _currentOptions.Clone();

            _logger.LogDebug("Updated preset: {Name}", entity.Name);

            OnPresetChanged(_activePreset, null, PresetChangeType.Updated);
        }
        finally
        {
            _lock.Release();
        }
    }

    public async Task DeletePresetAsync(Guid presetId, CancellationToken ct = default)
    {
        var entity = await _presetRepository.GetByIdAsync(presetId, ct);
        if (entity == null)
            return;

        if (entity.IsBuiltIn)
        {
            throw new InvalidOperationException("Cannot delete built-in presets");
        }

        await _presetRepository.DeleteAsync(presetId, ct);

        _logger.LogDebug("Deleted preset: {Name}", entity.Name);

        // If deleted the active preset, reset to default
        if (_activePreset?.Id == presetId)
        {
            await ResetToDefaultsAsync(ct);
        }

        OnPresetChanged(null, _activePreset, PresetChangeType.Deleted);
    }

    public async Task ResetToDefaultsAsync(CancellationToken ct = default)
    {
        var defaultPreset = await _presetRepository.GetDefaultAsync(ct);
        if (defaultPreset != null)
        {
            await ApplyPresetAsync(defaultPreset.Id, ct);
        }
        else
        {
            // Fallback to Balanced if no default set
            var balanced = await _presetRepository.GetByNameAsync("Balanced", ct);
            if (balanced != null)
            {
                await ApplyPresetAsync(balanced.Id, ct);
            }
            else
            {
                // Last resort - use hard-coded defaults
                _currentOptions = new InferenceOptions();
                _activePreset = null;
                _presetSnapshot = null;
                OnSettingsChanged(InferenceSettingsChangeType.ResetToDefaults);
            }
        }
    }

    public async Task SetDefaultPresetAsync(Guid presetId, CancellationToken ct = default)
    {
        await _presetRepository.SetAsDefaultAsync(presetId, ct);
        OnPresetChanged(_activePreset, null, PresetChangeType.DefaultChanged);
    }

    // === Helpers ===

    private async Task SaveActivePresetToSettingsAsync(Guid presetId, CancellationToken ct)
    {
        var settings = _settingsService.GetSettings();
        settings.ActiveInferencePresetId = presetId;
        await _settingsService.SaveSettingsAsync(settings, ct);
    }

    private static InferencePreset MapToPreset(InferencePresetEntity entity) => new()
    {
        Id = entity.Id,
        Name = entity.Name,
        Description = entity.Description,
        Category = entity.Category,
        IsBuiltIn = entity.IsBuiltIn,
        IsDefault = entity.IsDefault,
        CreatedAt = entity.CreatedAt,
        UpdatedAt = entity.UpdatedAt,
        Options = new InferenceOptions
        {
            Temperature = entity.Temperature,
            TopP = entity.TopP,
            MaxTokens = entity.MaxTokens,
            ContextSize = entity.ContextSize,
            RepetitionPenalty = entity.RepetitionPenalty,
            TopK = entity.TopK,
            Seed = entity.Seed
        }
    };

    private static bool OptionsEqual(InferenceOptions a, InferenceOptions b)
    {
        return Math.Abs(a.Temperature - b.Temperature) < 0.001f &&
               Math.Abs(a.TopP - b.TopP) < 0.001f &&
               a.MaxTokens == b.MaxTokens &&
               a.ContextSize == b.ContextSize &&
               Math.Abs(a.RepetitionPenalty - b.RepetitionPenalty) < 0.001f &&
               a.TopK == b.TopK &&
               a.Seed == b.Seed;
    }

    private void OnSettingsChanged(InferenceSettingsChangeType changeType, string? parameter = null)
    {
        SettingsChanged?.Invoke(this, new InferenceSettingsChangedEventArgs
        {
            NewOptions = _currentOptions.Clone(),
            ChangeType = changeType,
            ChangedParameter = parameter
        });
    }

    private void OnPresetChanged(InferencePreset? newPreset, InferencePreset? previousPreset, PresetChangeType changeType)
    {
        PresetChanged?.Invoke(this, new PresetChangedEventArgs
        {
            NewPreset = newPreset,
            PreviousPreset = previousPreset,
            ChangeType = changeType
        });
    }

    public async ValueTask DisposeAsync()
    {
        _lock.Dispose();
    }
}
```

### AppSettings Updates

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Application settings (additions for v0.2.3)
/// </summary>
public sealed class AppSettings
{
    // ... existing properties ...

    /// <summary>
    /// ID of the currently active inference preset
    /// </summary>
    public Guid? ActiveInferencePresetId { get; set; }

    /// <summary>
    /// Override temperature (when not using a preset)
    /// </summary>
    [Obsolete("Use ActiveInferencePresetId instead")]
    public float? TemperatureOverride { get; set; }

    /// <summary>
    /// Whether to show advanced parameters in the settings panel
    /// </summary>
    public bool ShowAdvancedParameters { get; set; } = false;

    /// <summary>
    /// Whether the inference settings panel is expanded
    /// </summary>
    public bool InferenceSettingsPanelExpanded { get; set; } = true;
}
```

### v0.2.3b Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Interfaces/IInferenceSettingsService.cs` | Service interface |
| `src/SeniorIntern.Core/Events/InferenceSettingsChangedEventArgs.cs` | Settings change events |
| `src/SeniorIntern.Core/Events/PresetChangedEventArgs.cs` | Preset change events |
| `src/SeniorIntern.Services/InferenceSettingsService.cs` | Service implementation |

### v0.2.3b Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Core/Models/AppSettings.cs` | Add preset ID property |

---

## v0.2.3c: ViewModels

### Objective
Create the ViewModels for the inference settings panel, including parameter binding, preset selection, and command handling.

### InferenceSettingsViewModel

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using System.Collections.ObjectModel;

/// <summary>
/// ViewModel for the inference settings panel
/// </summary>
public partial class InferenceSettingsViewModel : ViewModelBase, IDisposable
{
    private readonly IInferenceSettingsService _settingsService;
    private readonly IDispatcher _dispatcher;
    private bool _isUpdatingFromService;
    private System.Timers.Timer? _debounceTimer;

    // === Observable Properties ===

    [ObservableProperty]
    private float _temperature = ParameterConstants.Temperature.Default;

    [ObservableProperty]
    private float _topP = ParameterConstants.TopP.Default;

    [ObservableProperty]
    private int _maxTokens = ParameterConstants.MaxTokens.Default;

    [ObservableProperty]
    private uint _contextSize = ParameterConstants.ContextSize.Default;

    [ObservableProperty]
    private float _repetitionPenalty = ParameterConstants.RepetitionPenalty.Default;

    [ObservableProperty]
    private int _topK = ParameterConstants.TopK.Default;

    [ObservableProperty]
    private ObservableCollection<InferencePresetViewModel> _presets = new();

    [ObservableProperty]
    private InferencePresetViewModel? _selectedPreset;

    [ObservableProperty]
    private bool _hasUnsavedChanges;

    [ObservableProperty]
    private bool _isExpanded = true;

    [ObservableProperty]
    private bool _showAdvanced;

    [ObservableProperty]
    private bool _isLoading;

    [ObservableProperty]
    private string? _errorMessage;

    // === Computed Descriptions ===

    public string TemperatureDescription => Temperature switch
    {
        < 0.3f => "Very focused and deterministic",
        < 0.6f => "Consistent with slight variation",
        < 0.8f => "Balanced creativity and consistency",
        < 1.0f => "More creative and varied",
        < 1.3f => "Creative and experimental",
        _ => "Highly random and experimental"
    };

    public string TopPDescription => $"Considers top {TopP * 100:F0}% probability mass";

    public string MaxTokensDescription => MaxTokens switch
    {
        < 512 => $"~{MaxTokens * 3 / 4} words (short responses)",
        < 1024 => $"~{MaxTokens * 3 / 4} words (medium length)",
        < 2048 => $"~{MaxTokens * 3 / 4} words (standard)",
        < 4096 => $"~{MaxTokens * 3 / 4} words (detailed)",
        _ => $"~{MaxTokens * 3 / 4} words (very long)"
    };

    public string ContextSizeDescription => $"~{ContextSize * 3 / 4} words of conversation history";

    public string RepetitionPenaltyDescription => RepetitionPenalty switch
    {
        <= 1.0f => "No repetition penalty",
        < 1.1f => "Light repetition penalty",
        < 1.2f => "Moderate repetition penalty",
        _ => "Strong repetition penalty"
    };

    public string TopKDescription => TopK == 0
        ? "Disabled (using Top-P only)"
        : $"Consider top {TopK} tokens";

    // === Constructor ===

    public InferenceSettingsViewModel(
        IInferenceSettingsService settingsService,
        IDispatcher dispatcher)
    {
        _settingsService = settingsService;
        _dispatcher = dispatcher;

        // Subscribe to service events
        _settingsService.SettingsChanged += OnSettingsChanged;
        _settingsService.PresetChanged += OnPresetChanged;

        // Setup debounce timer
        _debounceTimer = new System.Timers.Timer(200) { AutoReset = false };
        _debounceTimer.Elapsed += OnDebounceElapsed;
    }

    /// <summary>
    /// Initialize the ViewModel
    /// </summary>
    public async Task InitializeAsync()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = null;

            // Load presets
            await LoadPresetsAsync();

            // Sync with current settings
            SyncFromService();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load settings: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    // === Property Change Handlers ===

    partial void OnTemperatureChanged(float value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(TemperatureDescription));
        QueueServiceUpdate();
    }

    partial void OnTopPChanged(float value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(TopPDescription));
        QueueServiceUpdate();
    }

    partial void OnMaxTokensChanged(int value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(MaxTokensDescription));
        QueueServiceUpdate();
    }

    partial void OnContextSizeChanged(uint value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(ContextSizeDescription));
        QueueServiceUpdate();
    }

    partial void OnRepetitionPenaltyChanged(float value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(RepetitionPenaltyDescription));
        QueueServiceUpdate();
    }

    partial void OnTopKChanged(int value)
    {
        if (_isUpdatingFromService) return;
        OnPropertyChanged(nameof(TopKDescription));
        QueueServiceUpdate();
    }

    partial void OnSelectedPresetChanged(InferencePresetViewModel? value)
    {
        if (_isUpdatingFromService || value == null) return;

        // Apply the preset
        _ = ApplyPresetAsync(value);
    }

    // === Commands ===

    [RelayCommand]
    private async Task LoadPresetsAsync()
    {
        var presets = await _settingsService.GetPresetsAsync();

        await _dispatcher.InvokeAsync(() =>
        {
            Presets.Clear();
            foreach (var preset in presets)
            {
                Presets.Add(new InferencePresetViewModel(preset));
            }

            // Update selection
            UpdatePresetSelection();
        });
    }

    [RelayCommand]
    private async Task ApplyPresetAsync(InferencePresetViewModel preset)
    {
        try
        {
            IsLoading = true;
            await _settingsService.ApplyPresetAsync(preset.Id);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to apply preset: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    [RelayCommand]
    private async Task SaveAsPresetAsync()
    {
        // This should open a dialog to get the preset name
        // For now, just show the dialog via a service or event
        // Implementation depends on your dialog service pattern

        // Placeholder - actual implementation would use a dialog
        var name = $"Custom {DateTime.Now:HH:mm:ss}";
        try
        {
            await _settingsService.SaveAsPresetAsync(name);
            await LoadPresetsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to save preset: {ex.Message}";
        }
    }

    [RelayCommand]
    private async Task UpdateCurrentPresetAsync()
    {
        if (_settingsService.ActivePreset == null || _settingsService.ActivePreset.IsBuiltIn)
        {
            // Can't update built-in, save as new instead
            await SaveAsPresetAsync();
            return;
        }

        try
        {
            await _settingsService.UpdatePresetAsync(_settingsService.ActivePreset.Id);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to update preset: {ex.Message}";
        }
    }

    [RelayCommand]
    private async Task DeletePresetAsync(InferencePresetViewModel preset)
    {
        if (preset.IsBuiltIn)
        {
            ErrorMessage = "Cannot delete built-in presets";
            return;
        }

        try
        {
            await _settingsService.DeletePresetAsync(preset.Id);
            await LoadPresetsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to delete preset: {ex.Message}";
        }
    }

    [RelayCommand]
    private async Task ResetToDefaultsAsync()
    {
        try
        {
            await _settingsService.ResetToDefaultsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to reset: {ex.Message}";
        }
    }

    [RelayCommand]
    private void ToggleAdvanced()
    {
        ShowAdvanced = !ShowAdvanced;
    }

    [RelayCommand]
    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }

    // === Service Event Handlers ===

    private void OnSettingsChanged(object? sender, InferenceSettingsChangedEventArgs e)
    {
        _dispatcher.InvokeAsync(() =>
        {
            SyncFromService();
        });
    }

    private async void OnPresetChanged(object? sender, PresetChangedEventArgs e)
    {
        await _dispatcher.InvokeAsync(async () =>
        {
            await LoadPresetsAsync();
        });
    }

    // === Helpers ===

    private void SyncFromService()
    {
        _isUpdatingFromService = true;
        try
        {
            var options = _settingsService.CurrentOptions;
            Temperature = options.Temperature;
            TopP = options.TopP;
            MaxTokens = options.MaxTokens;
            ContextSize = options.ContextSize;
            RepetitionPenalty = options.RepetitionPenalty;
            TopK = options.TopK;

            HasUnsavedChanges = _settingsService.HasUnsavedChanges;

            UpdatePresetSelection();
        }
        finally
        {
            _isUpdatingFromService = false;
        }
    }

    private void UpdatePresetSelection()
    {
        var activePreset = _settingsService.ActivePreset;
        if (activePreset == null)
        {
            SelectedPreset = null;
            return;
        }

        _isUpdatingFromService = true;
        try
        {
            SelectedPreset = Presets.FirstOrDefault(p => p.Id == activePreset.Id);
        }
        finally
        {
            _isUpdatingFromService = false;
        }
    }

    private void QueueServiceUpdate()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
        HasUnsavedChanges = true;
    }

    private void OnDebounceElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        // Update the service with current values
        _settingsService.UpdateTemperature(Temperature);
        _settingsService.UpdateTopP(TopP);
        _settingsService.UpdateMaxTokens(MaxTokens);
        _settingsService.UpdateContextSize(ContextSize);
        _settingsService.UpdateRepetitionPenalty(RepetitionPenalty);
        _settingsService.UpdateTopK(TopK);
    }

    public void Dispose()
    {
        _settingsService.SettingsChanged -= OnSettingsChanged;
        _settingsService.PresetChanged -= OnPresetChanged;
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
    }
}
```

### InferencePresetViewModel

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using SeniorIntern.Core.Models;

/// <summary>
/// ViewModel for an inference preset in the dropdown
/// </summary>
public partial class InferencePresetViewModel : ViewModelBase
{
    public Guid Id { get; init; }

    [ObservableProperty]
    private string _name = string.Empty;

    [ObservableProperty]
    private string? _description;

    [ObservableProperty]
    private string? _category;

    [ObservableProperty]
    private bool _isBuiltIn;

    [ObservableProperty]
    private bool _isDefault;

    [ObservableProperty]
    private bool _isSelected;

    /// <summary>
    /// Summary of key parameters for display
    /// </summary>
    public string ParameterSummary { get; init; } = string.Empty;

    /// <summary>
    /// Icon or indicator for the preset type
    /// </summary>
    public string TypeIndicator => IsBuiltIn ? "Built-in" : "Custom";

    public InferencePresetViewModel() { }

    public InferencePresetViewModel(InferencePreset preset)
    {
        Id = preset.Id;
        Name = preset.Name;
        Description = preset.Description;
        Category = preset.Category;
        IsBuiltIn = preset.IsBuiltIn;
        IsDefault = preset.IsDefault;
        ParameterSummary = FormatParameterSummary(preset.Options);
    }

    private static string FormatParameterSummary(InferenceOptions options)
    {
        return $"T:{options.Temperature:F1} P:{options.TopP:F2} Max:{options.MaxTokens} Ctx:{options.ContextSize}";
    }
}
```

### SavePresetDialogViewModel

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;

/// <summary>
/// ViewModel for the save preset dialog
/// </summary>
public partial class SavePresetDialogViewModel : ViewModelBase
{
    [ObservableProperty]
    private string _name = string.Empty;

    [ObservableProperty]
    private string? _description;

    [ObservableProperty]
    private string? _errorMessage;

    [ObservableProperty]
    private bool _canSave;

    public bool DialogResult { get; private set; }

    partial void OnNameChanged(string value)
    {
        CanSave = !string.IsNullOrWhiteSpace(value);
        ErrorMessage = null;
    }

    [RelayCommand(CanExecute = nameof(CanSave))]
    private void Save()
    {
        if (string.IsNullOrWhiteSpace(Name))
        {
            ErrorMessage = "Name is required";
            return;
        }

        DialogResult = true;
        // Close dialog via event or callback
    }

    [RelayCommand]
    private void Cancel()
    {
        DialogResult = false;
        // Close dialog
    }
}
```

### v0.2.3c Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/InferenceSettingsViewModel.cs` | Main settings ViewModel |
| `src/SeniorIntern.Desktop/ViewModels/InferencePresetViewModel.cs` | Preset item ViewModel |
| `src/SeniorIntern.Desktop/ViewModels/SavePresetDialogViewModel.cs` | Save dialog ViewModel |

---

## v0.2.3d: Parameter Slider Control

### Objective
Create a reusable custom slider control with labels, value display, and description text that provides consistent UX for all inference parameters.

### ParameterSlider Control

```csharp
namespace SeniorIntern.Desktop.Controls;

using Avalonia;
using Avalonia.Controls;
using Avalonia.Controls.Primitives;
using Avalonia.Data;

/// <summary>
/// Custom slider control for inference parameters
/// </summary>
public class ParameterSlider : TemplatedControl
{
    public static readonly StyledProperty<string> LabelProperty =
        AvaloniaProperty.Register<ParameterSlider, string>(nameof(Label), "Parameter");

    public static readonly StyledProperty<double> ValueProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(
            nameof(Value),
            defaultBindingMode: BindingMode.TwoWay,
            coerce: CoerceValue);

    public static readonly StyledProperty<double> MinimumProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(nameof(Minimum), 0.0);

    public static readonly StyledProperty<double> MaximumProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(nameof(Maximum), 1.0);

    public static readonly StyledProperty<double> StepProperty =
        AvaloniaProperty.Register<ParameterSlider, double>(nameof(Step), 0.1);

    public static readonly StyledProperty<string> DescriptionProperty =
        AvaloniaProperty.Register<ParameterSlider, string>(nameof(Description), string.Empty);

    public static readonly StyledProperty<string> ValueFormatProperty =
        AvaloniaProperty.Register<ParameterSlider, string>(nameof(ValueFormat), "F1");

    public static readonly StyledProperty<string?> UnitProperty =
        AvaloniaProperty.Register<ParameterSlider, string?>(nameof(Unit));

    public static readonly StyledProperty<bool> ShowDescriptionProperty =
        AvaloniaProperty.Register<ParameterSlider, bool>(nameof(ShowDescription), true);

    public static readonly StyledProperty<bool> IsIntegerProperty =
        AvaloniaProperty.Register<ParameterSlider, bool>(nameof(IsInteger), false);

    /// <summary>
    /// The label displayed above the slider
    /// </summary>
    public string Label
    {
        get => GetValue(LabelProperty);
        set => SetValue(LabelProperty, value);
    }

    /// <summary>
    /// The current value
    /// </summary>
    public double Value
    {
        get => GetValue(ValueProperty);
        set => SetValue(ValueProperty, value);
    }

    /// <summary>
    /// Minimum value
    /// </summary>
    public double Minimum
    {
        get => GetValue(MinimumProperty);
        set => SetValue(MinimumProperty, value);
    }

    /// <summary>
    /// Maximum value
    /// </summary>
    public double Maximum
    {
        get => GetValue(MaximumProperty);
        set => SetValue(MaximumProperty, value);
    }

    /// <summary>
    /// Step increment
    /// </summary>
    public double Step
    {
        get => GetValue(StepProperty);
        set => SetValue(StepProperty, value);
    }

    /// <summary>
    /// Description text displayed below the slider
    /// </summary>
    public string Description
    {
        get => GetValue(DescriptionProperty);
        set => SetValue(DescriptionProperty, value);
    }

    /// <summary>
    /// Format string for displaying the value
    /// </summary>
    public string ValueFormat
    {
        get => GetValue(ValueFormatProperty);
        set => SetValue(ValueFormatProperty, value);
    }

    /// <summary>
    /// Optional unit suffix (e.g., "tokens", "words")
    /// </summary>
    public string? Unit
    {
        get => GetValue(UnitProperty);
        set => SetValue(UnitProperty, value);
    }

    /// <summary>
    /// Whether to show the description
    /// </summary>
    public bool ShowDescription
    {
        get => GetValue(ShowDescriptionProperty);
        set => SetValue(ShowDescriptionProperty, value);
    }

    /// <summary>
    /// Whether the value is an integer (affects display)
    /// </summary>
    public bool IsInteger
    {
        get => GetValue(IsIntegerProperty);
        set => SetValue(IsIntegerProperty, value);
    }

    /// <summary>
    /// Formatted value for display
    /// </summary>
    public string FormattedValue
    {
        get
        {
            var format = IsInteger ? "F0" : ValueFormat;
            var value = Value.ToString(format);
            return Unit != null ? $"{value} {Unit}" : value;
        }
    }

    private static double CoerceValue(AvaloniaObject sender, double value)
    {
        var slider = (ParameterSlider)sender;
        return Math.Clamp(value, slider.Minimum, slider.Maximum);
    }

    protected override void OnPropertyChanged(AvaloniaPropertyChangedEventArgs change)
    {
        base.OnPropertyChanged(change);

        if (change.Property == ValueProperty ||
            change.Property == ValueFormatProperty ||
            change.Property == UnitProperty ||
            change.Property == IsIntegerProperty)
        {
            RaisePropertyChanged(nameof(FormattedValue));
        }
    }
}
```

### ParameterSlider Template (ParameterSlider.axaml)

```xml
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="using:SeniorIntern.Desktop.Controls">

    <ControlTheme x:Key="{x:Type controls:ParameterSlider}" TargetType="controls:ParameterSlider">
        <Setter Property="Template">
            <ControlTemplate>
                <Grid RowDefinitions="Auto,Auto,Auto">
                    <!-- Label and Value Row -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,4">
                        <TextBlock Text="{TemplateBinding Label}"
                                   FontWeight="SemiBold"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextPrimaryColor}" />

                        <Border Grid.Column="1"
                                Background="{DynamicResource ControlBackgroundColor}"
                                CornerRadius="4"
                                Padding="8,2"
                                MinWidth="60"
                                HorizontalAlignment="Right">
                            <TextBlock Text="{TemplateBinding FormattedValue}"
                                       FontFamily="Consolas, Menlo, monospace"
                                       FontSize="12"
                                       HorizontalAlignment="Center"
                                       Foreground="{DynamicResource TextPrimaryColor}" />
                        </Border>
                    </Grid>

                    <!-- Slider Row -->
                    <Slider Grid.Row="1"
                            Name="PART_Slider"
                            Value="{TemplateBinding Value, Mode=TwoWay}"
                            Minimum="{TemplateBinding Minimum}"
                            Maximum="{TemplateBinding Maximum}"
                            SmallChange="{TemplateBinding Step}"
                            LargeChange="{TemplateBinding Step}"
                            TickFrequency="{TemplateBinding Step}"
                            IsSnapToTickEnabled="True"
                            Margin="0,4" />

                    <!-- Description Row -->
                    <TextBlock Grid.Row="2"
                               Text="{TemplateBinding Description}"
                               IsVisible="{TemplateBinding ShowDescription}"
                               FontSize="11"
                               Foreground="{DynamicResource TextSecondaryColor}"
                               TextWrapping="Wrap"
                               Margin="0,2,0,8" />
                </Grid>
            </ControlTemplate>
        </Setter>
    </ControlTheme>

    <!-- Slider Style Overrides -->
    <Style Selector="controls|ParameterSlider /template/ Slider">
        <Setter Property="Focusable" Value="True" />
    </Style>

    <Style Selector="controls|ParameterSlider /template/ Slider:pointerover /template/ Thumb">
        <Setter Property="Background" Value="{DynamicResource AccentHoverColor}" />
    </Style>

</ResourceDictionary>
```

### ParameterSlider Code-Behind (ParameterSlider.axaml.cs)

```csharp
namespace SeniorIntern.Desktop.Controls;

using Avalonia.Controls;
using Avalonia.Controls.Primitives;
using Avalonia.Input;

public partial class ParameterSlider
{
    private Slider? _slider;

    protected override void OnApplyTemplate(TemplateAppliedEventArgs e)
    {
        base.OnApplyTemplate(e);

        _slider = e.NameScope.Find<Slider>("PART_Slider");

        if (_slider != null)
        {
            // Handle keyboard input for fine control
            _slider.KeyDown += OnSliderKeyDown;
        }
    }

    private void OnSliderKeyDown(object? sender, KeyEventArgs e)
    {
        var increment = e.KeyModifiers.HasFlag(KeyModifiers.Shift) ? Step * 10 : Step;

        switch (e.Key)
        {
            case Key.Left:
            case Key.Down:
                Value = Math.Max(Minimum, Value - increment);
                e.Handled = true;
                break;

            case Key.Right:
            case Key.Up:
                Value = Math.Min(Maximum, Value + increment);
                e.Handled = true;
                break;

            case Key.Home:
                Value = Minimum;
                e.Handled = true;
                break;

            case Key.End:
                Value = Maximum;
                e.Handled = true;
                break;
        }
    }
}
```

### v0.2.3d Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/Controls/ParameterSlider.cs` | Slider control class |
| `src/SeniorIntern.Desktop/Controls/ParameterSlider.axaml` | Slider template |

---

## v0.2.3e: Settings Panel UI

### Objective
Create the complete InferenceSettingsPanel UI with preset dropdown, parameter sliders, and integrate into the main window.

### InferenceSettingsPanel.axaml

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             xmlns:controls="using:SeniorIntern.Desktop.Controls"
             x:Class="SeniorIntern.Desktop.Views.InferenceSettingsPanel"
             x:DataType="vm:InferenceSettingsViewModel">

    <UserControl.Resources>
        <!-- Preset Item Template -->
        <DataTemplate x:Key="PresetItemTemplate" x:DataType="vm:InferencePresetViewModel">
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="4,2">
                <!-- Built-in indicator -->
                <Border Grid.Column="0"
                        IsVisible="{Binding IsBuiltIn}"
                        Background="{DynamicResource AccentBackgroundColor}"
                        CornerRadius="2"
                        Padding="4,1"
                        Margin="0,0,8,0"
                        VerticalAlignment="Center">
                    <TextBlock Text="Built-in"
                               FontSize="9"
                               Foreground="{DynamicResource AccentForegroundColor}" />
                </Border>

                <!-- Name -->
                <StackPanel Grid.Column="1" Spacing="2">
                    <TextBlock Text="{Binding Name}"
                               FontWeight="{Binding IsDefault, Converter={StaticResource BoolToFontWeightConverter}}" />
                    <TextBlock Text="{Binding ParameterSummary}"
                               FontSize="10"
                               Foreground="{DynamicResource TextSecondaryColor}"
                               IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                </StackPanel>

                <!-- Default indicator -->
                <TextBlock Grid.Column="2"
                           Text="★"
                           IsVisible="{Binding IsDefault}"
                           Foreground="{DynamicResource AccentColor}"
                           FontSize="14"
                           VerticalAlignment="Center"
                           ToolTip.Tip="Default preset" />
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <Border Background="{DynamicResource PanelBackgroundColor}"
            CornerRadius="8"
            Padding="12"
            Margin="12,8">

        <Grid RowDefinitions="Auto,Auto,*,Auto">
            <!-- Header -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,12">
                <Button Classes="icon-button"
                        Command="{Binding ToggleExpandedCommand}"
                        ToolTip.Tip="Collapse/Expand">
                    <PathIcon Data="{Binding IsExpanded, Converter={StaticResource ExpandIconConverter}}"
                              Width="12" Height="12" />
                </Button>

                <TextBlock Grid.Column="1"
                           Text="Inference Settings"
                           FontWeight="Bold"
                           FontSize="14"
                           VerticalAlignment="Center"
                           Margin="8,0,0,0" />

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                    <Button Classes="icon-button small"
                            Command="{Binding ResetToDefaultsCommand}"
                            ToolTip.Tip="Reset to Defaults">
                        <PathIcon Data="{StaticResource ResetIcon}"
                                  Width="14" Height="14" />
                    </Button>

                    <Button Classes="icon-button small"
                            Command="{Binding SaveAsPresetCommand}"
                            ToolTip.Tip="Save as Preset"
                            IsVisible="{Binding HasUnsavedChanges}">
                        <PathIcon Data="{StaticResource SaveIcon}"
                                  Width="14" Height="14" />
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Preset Selector -->
            <Grid Grid.Row="1"
                  ColumnDefinitions="*,Auto"
                  Margin="0,0,0,12"
                  IsVisible="{Binding IsExpanded}">

                <ComboBox ItemsSource="{Binding Presets}"
                          SelectedItem="{Binding SelectedPreset}"
                          ItemTemplate="{StaticResource PresetItemTemplate}"
                          HorizontalAlignment="Stretch"
                          MaxDropDownHeight="300">
                    <ComboBox.ItemContainerTheme>
                        <ControlTheme TargetType="ComboBoxItem" BasedOn="{StaticResource {x:Type ComboBoxItem}}">
                            <Setter Property="Padding" Value="8,4" />
                        </ControlTheme>
                    </ComboBox.ItemContainerTheme>
                </ComboBox>

                <!-- Unsaved indicator -->
                <Border Grid.Column="1"
                        IsVisible="{Binding HasUnsavedChanges}"
                        Background="{DynamicResource WarningBackgroundColor}"
                        CornerRadius="4"
                        Padding="6,2"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center">
                    <TextBlock Text="Modified"
                               FontSize="10"
                               Foreground="{DynamicResource WarningForegroundColor}" />
                </Border>
            </Grid>

            <!-- Parameter Sliders -->
            <StackPanel Grid.Row="2"
                        Spacing="4"
                        IsVisible="{Binding IsExpanded}">

                <!-- Temperature -->
                <controls:ParameterSlider Label="Temperature"
                                          Value="{Binding Temperature}"
                                          Minimum="0"
                                          Maximum="2"
                                          Step="0.1"
                                          Description="{Binding TemperatureDescription}"
                                          ValueFormat="F1" />

                <!-- Top-P -->
                <controls:ParameterSlider Label="Top-P (Nucleus Sampling)"
                                          Value="{Binding TopP}"
                                          Minimum="0"
                                          Maximum="1"
                                          Step="0.05"
                                          Description="{Binding TopPDescription}"
                                          ValueFormat="F2" />

                <!-- Max Tokens -->
                <controls:ParameterSlider Label="Max Response Tokens"
                                          Value="{Binding MaxTokens}"
                                          Minimum="64"
                                          Maximum="8192"
                                          Step="64"
                                          Description="{Binding MaxTokensDescription}"
                                          IsInteger="True" />

                <!-- Context Size -->
                <controls:ParameterSlider Label="Context Window Size"
                                          Value="{Binding ContextSize}"
                                          Minimum="512"
                                          Maximum="32768"
                                          Step="512"
                                          Description="{Binding ContextSizeDescription}"
                                          IsInteger="True" />

                <!-- Advanced Section -->
                <Expander Header="Advanced"
                          IsExpanded="{Binding ShowAdvanced}"
                          Margin="0,8,0,0">
                    <StackPanel Spacing="4" Margin="0,8,0,0">

                        <!-- Repetition Penalty -->
                        <controls:ParameterSlider Label="Repetition Penalty"
                                                  Value="{Binding RepetitionPenalty}"
                                                  Minimum="1"
                                                  Maximum="2"
                                                  Step="0.05"
                                                  Description="{Binding RepetitionPenaltyDescription}"
                                                  ValueFormat="F2" />

                        <!-- Top-K -->
                        <controls:ParameterSlider Label="Top-K"
                                                  Value="{Binding TopK}"
                                                  Minimum="0"
                                                  Maximum="100"
                                                  Step="5"
                                                  Description="{Binding TopKDescription}"
                                                  IsInteger="True" />
                    </StackPanel>
                </Expander>
            </StackPanel>

            <!-- Error Message -->
            <Border Grid.Row="3"
                    IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                    Background="{DynamicResource ErrorBackgroundColor}"
                    Padding="8,4"
                    CornerRadius="4"
                    Margin="0,8,0,0">
                <TextBlock Text="{Binding ErrorMessage}"
                           Foreground="{DynamicResource ErrorForegroundColor}"
                           FontSize="11"
                           TextWrapping="Wrap" />
            </Border>
        </Grid>
    </Border>
</UserControl>
```

### InferenceSettingsPanel.axaml.cs

```csharp
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;

public partial class InferenceSettingsPanel : UserControl
{
    public InferenceSettingsPanel()
    {
        InitializeComponent();
    }
}
```

### SavePresetDialog.axaml

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
        x:Class="SeniorIntern.Desktop.Dialogs.SavePresetDialog"
        x:DataType="vm:SavePresetDialogViewModel"
        Title="Save Preset"
        Width="400"
        SizeToContent="Height"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        ShowInTaskbar="False">

    <Grid Margin="20" RowDefinitions="Auto,Auto,Auto,Auto,Auto">
        <!-- Name -->
        <StackPanel Grid.Row="0" Spacing="4">
            <TextBlock Text="Preset Name" FontWeight="SemiBold" />
            <TextBox Text="{Binding Name}"
                     Watermark="Enter a name for this preset"
                     Classes="has-clear-button" />
        </StackPanel>

        <!-- Description -->
        <StackPanel Grid.Row="1" Spacing="4" Margin="0,12,0,0">
            <TextBlock Text="Description (Optional)" />
            <TextBox Text="{Binding Description}"
                     Watermark="Brief description of when to use this preset"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     Height="60" />
        </StackPanel>

        <!-- Error Message -->
        <Border Grid.Row="2"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource ErrorBackgroundColor}"
                Padding="8,4"
                CornerRadius="4"
                Margin="0,12,0,0">
            <TextBlock Text="{Binding ErrorMessage}"
                       Foreground="{DynamicResource ErrorForegroundColor}"
                       FontSize="12" />
        </Border>

        <!-- Buttons -->
        <StackPanel Grid.Row="3"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Spacing="8"
                    Margin="0,20,0,0">
            <Button Content="Cancel"
                    Command="{Binding CancelCommand}"
                    MinWidth="80" />
            <Button Content="Save"
                    Command="{Binding SaveCommand}"
                    Classes="accent"
                    MinWidth="80" />
        </StackPanel>
    </Grid>
</Window>
```

### MainWindow Integration

Update the MainWindow.axaml to include the settings panel:

```xml
<!-- In the sidebar, after Model Selector -->
<views:InferenceSettingsPanel Grid.Row="1"
                              DataContext="{Binding InferenceSettingsViewModel}"
                              Margin="0,0,0,8" />

<!-- Update the status bar to show current preset -->
<Border Grid.Row="2"
        Background="{DynamicResource StatusBarBackgroundColor}"
        Padding="12,4">
    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto">
        <TextBlock Text="{Binding ModelSelectorViewModel.CurrentModelName, StringFormat='Model: {0}'}"
                   FontSize="11"
                   Foreground="{DynamicResource TextSecondaryColor}" />

        <TextBlock Grid.Column="1"
                   Text="{Binding InferenceSettingsViewModel.SelectedPreset.Name, StringFormat='Preset: {0}'}"
                   FontSize="11"
                   Foreground="{DynamicResource TextSecondaryColor}"
                   Margin="16,0,0,0" />

        <TextBlock Grid.Column="2"
                   Text="{Binding InferenceSettingsViewModel.Temperature, StringFormat='T:{0:F1}'}"
                   FontSize="11"
                   Foreground="{DynamicResource TextTertiaryColor}"
                   ToolTip.Tip="Temperature"
                   Margin="16,0,0,0" />

        <TextBlock Grid.Column="3"
                   Text="{Binding ChatViewModel.SaveStatus}"
                   FontSize="11"
                   Foreground="{DynamicResource TextSecondaryColor}"
                   Margin="16,0,0,0" />
    </Grid>
</Border>
```

### MainWindowViewModel Updates

```csharp
namespace SeniorIntern.Desktop.ViewModels;

public partial class MainWindowViewModel : ViewModelBase
{
    // ... existing properties ...

    [ObservableProperty]
    private InferenceSettingsViewModel _inferenceSettingsViewModel;

    public MainWindowViewModel(
        ChatViewModel chatViewModel,
        ConversationListViewModel conversationListViewModel,
        ModelSelectorViewModel modelSelectorViewModel,
        InferenceSettingsViewModel inferenceSettingsViewModel)
    {
        _chatViewModel = chatViewModel;
        _conversationListViewModel = conversationListViewModel;
        _modelSelectorViewModel = modelSelectorViewModel;
        _inferenceSettingsViewModel = inferenceSettingsViewModel;
    }

    public async Task InitializeAsync()
    {
        await _conversationListViewModel.InitializeAsync();
        await _inferenceSettingsViewModel.InitializeAsync();
    }
}
```

### Service Registration Updates

```csharp
// In ServiceCollectionExtensions.cs
public static IServiceCollection AddSeniorInternServices(this IServiceCollection services)
{
    // ... existing registrations ...

    // Inference settings
    services.AddSingleton<IInferencePresetRepository, InferencePresetRepository>();
    services.AddSingleton<IInferenceSettingsService, InferenceSettingsService>();
    services.AddTransient<InferenceSettingsViewModel>();
    services.AddTransient<SavePresetDialogViewModel>();

    return services;
}
```

### LlmService Integration

```csharp
// Update LlmService to use current inference options
public sealed class LlmService : ILlmService
{
    private readonly IInferenceSettingsService _inferenceSettings;

    public LlmService(
        IInferenceSettingsService inferenceSettings,
        // ... other dependencies
    )
    {
        _inferenceSettings = inferenceSettings;
    }

    public async IAsyncEnumerable<string> GenerateStreamingAsync(
        IEnumerable<ChatMessage> conversation,
        InferenceOptions? optionsOverride,
        [EnumeratorCancellation] CancellationToken cancellationToken = default)
    {
        // Use provided options or fall back to current service options
        var options = optionsOverride ?? _inferenceSettings.CurrentOptions;

        // Apply options to inference
        var inferParams = new InferenceParams
        {
            Temperature = options.Temperature,
            TopP = options.TopP,
            MaxTokens = options.MaxTokens,
            RepeatPenalty = options.RepetitionPenalty,
            TopK = options.TopK
            // ...
        };

        // ... rest of inference logic
    }
}
```

### v0.2.3e Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/Views/InferenceSettingsPanel.axaml` | Settings panel UI |
| `src/SeniorIntern.Desktop/Views/InferenceSettingsPanel.axaml.cs` | Code-behind |
| `src/SeniorIntern.Desktop/Dialogs/SavePresetDialog.axaml` | Save preset dialog |
| `src/SeniorIntern.Desktop/Dialogs/SavePresetDialog.axaml.cs` | Dialog code-behind |
| `src/SeniorIntern.Desktop/Converters/BoolToFontWeightConverter.cs` | Converter for default indicator |
| `src/SeniorIntern.Desktop/Converters/ExpandIconConverter.cs` | Converter for expand/collapse icon |

### v0.2.3e Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add settings panel to sidebar |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add InferenceSettingsViewModel |
| `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Register new services |
| `src/SeniorIntern.Services/LlmService.cs` | Integrate with inference settings |

---

## Files Summary

### Files to Create (Total: 18)

| Part | File |
|------|------|
| v0.2.3a | `src/SeniorIntern.Core/Models/InferenceOptions.cs` |
| v0.2.3a | `src/SeniorIntern.Core/Models/InferencePreset.cs` |
| v0.2.3a | `src/SeniorIntern.Core/ParameterConstants.cs` |
| v0.2.3a | `src/SeniorIntern.Data/Repositories/IInferencePresetRepository.cs` |
| v0.2.3a | `src/SeniorIntern.Data/Repositories/InferencePresetRepository.cs` |
| v0.2.3b | `src/SeniorIntern.Core/Interfaces/IInferenceSettingsService.cs` |
| v0.2.3b | `src/SeniorIntern.Core/Events/InferenceSettingsChangedEventArgs.cs` |
| v0.2.3b | `src/SeniorIntern.Core/Events/PresetChangedEventArgs.cs` |
| v0.2.3b | `src/SeniorIntern.Services/InferenceSettingsService.cs` |
| v0.2.3c | `src/SeniorIntern.Desktop/ViewModels/InferenceSettingsViewModel.cs` |
| v0.2.3c | `src/SeniorIntern.Desktop/ViewModels/InferencePresetViewModel.cs` |
| v0.2.3c | `src/SeniorIntern.Desktop/ViewModels/SavePresetDialogViewModel.cs` |
| v0.2.3d | `src/SeniorIntern.Desktop/Controls/ParameterSlider.cs` |
| v0.2.3d | `src/SeniorIntern.Desktop/Controls/ParameterSlider.axaml` |
| v0.2.3e | `src/SeniorIntern.Desktop/Views/InferenceSettingsPanel.axaml` |
| v0.2.3e | `src/SeniorIntern.Desktop/Views/InferenceSettingsPanel.axaml.cs` |
| v0.2.3e | `src/SeniorIntern.Desktop/Dialogs/SavePresetDialog.axaml` |
| v0.2.3e | `src/SeniorIntern.Desktop/Dialogs/SavePresetDialog.axaml.cs` |

### Files to Modify (Total: 7)

| Part | File | Changes |
|------|------|---------|
| v0.2.3a | `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs` | Add additional fields |
| v0.2.3a | `src/SeniorIntern.Data/Configurations/InferencePresetConfiguration.cs` | Update EF config |
| v0.2.3b | `src/SeniorIntern.Core/Models/AppSettings.cs` | Add preset ID property |
| v0.2.3e | `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add settings panel |
| v0.2.3e | `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add settings ViewModel |
| v0.2.3e | `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Register services |
| v0.2.3e | `src/SeniorIntern.Services/LlmService.cs` | Use inference settings |

---

## Testing Strategy

### Unit Tests

```csharp
namespace SeniorIntern.Services.Tests;

public class InferenceSettingsServiceTests
{
    [Fact]
    public void UpdateTemperature_ShouldClampValue()
    {
        var service = CreateService();

        service.UpdateTemperature(5.0f); // Above max

        Assert.Equal(2.0f, service.CurrentOptions.Temperature);
    }

    [Fact]
    public void UpdateTemperature_ShouldFireEvent()
    {
        var service = CreateService();
        var eventFired = false;
        service.SettingsChanged += (s, e) => eventFired = true;

        service.UpdateTemperature(0.5f);

        Assert.True(eventFired);
    }

    [Fact]
    public async Task ApplyPreset_ShouldLoadAllValues()
    {
        var service = CreateService();
        var preset = CreateTestPreset(temperature: 0.3f, topP: 0.8f);

        await service.ApplyPresetAsync(preset.Id);

        Assert.Equal(0.3f, service.CurrentOptions.Temperature);
        Assert.Equal(0.8f, service.CurrentOptions.TopP);
    }

    [Fact]
    public async Task SaveAsPreset_ShouldPersistCurrentOptions()
    {
        var service = CreateService();
        service.UpdateTemperature(1.5f);
        service.UpdateTopP(0.75f);

        var preset = await service.SaveAsPresetAsync("Test Preset");

        Assert.Equal(1.5f, preset.Options.Temperature);
        Assert.Equal(0.75f, preset.Options.TopP);
    }

    [Fact]
    public async Task DeletePreset_ShouldNotDeleteBuiltIn()
    {
        var service = CreateService();
        var builtInPreset = await service.GetPresetsAsync();
        var precise = builtInPreset.First(p => p.Name == "Precise");

        await Assert.ThrowsAsync<InvalidOperationException>(
            () => service.DeletePresetAsync(precise.Id));
    }
}

public class InferenceOptionsTests
{
    [Theory]
    [InlineData(-0.5f, false)] // Below min
    [InlineData(0.0f, true)]   // At min
    [InlineData(1.0f, true)]   // In range
    [InlineData(2.0f, true)]   // At max
    [InlineData(2.5f, false)]  // Above max
    public void Validate_Temperature(float temperature, bool shouldBeValid)
    {
        var options = new InferenceOptions { Temperature = temperature };

        var result = options.Validate();

        Assert.Equal(shouldBeValid, result.IsValid || !result.Errors.Any(e => e.Contains("Temperature")));
    }

    [Fact]
    public void Clone_ShouldCreateIndependentCopy()
    {
        var original = new InferenceOptions { Temperature = 1.0f };

        var clone = original.Clone();
        clone.Temperature = 0.5f;

        Assert.Equal(1.0f, original.Temperature);
        Assert.Equal(0.5f, clone.Temperature);
    }
}
```

### Integration Tests

```csharp
public class InferencePresetRepositoryTests
{
    [Fact]
    public async Task SeedBuiltInPresets_ShouldCreateFivePresets()
    {
        using var context = CreateInMemoryContext();
        var repository = new InferencePresetRepository(context, CreateLogger());

        await repository.SeedBuiltInPresetsAsync();

        var presets = await repository.GetAllAsync();
        Assert.Equal(5, presets.Count(p => p.IsBuiltIn));
    }

    [Fact]
    public async Task SetAsDefault_ShouldClearPreviousDefault()
    {
        using var context = CreateInMemoryContext();
        var repository = new InferencePresetRepository(context, CreateLogger());
        await repository.SeedBuiltInPresetsAsync();

        var presets = await repository.GetAllAsync();
        var precise = presets.First(p => p.Name == "Precise");

        await repository.SetAsDefaultAsync(precise.Id);

        var updated = await repository.GetAllAsync();
        Assert.Single(updated.Where(p => p.IsDefault));
        Assert.True(updated.First(p => p.Id == precise.Id).IsDefault);
    }
}
```

### ViewModel Tests

```csharp
public class InferenceSettingsViewModelTests
{
    [Fact]
    public void TemperatureDescription_ShouldUpdateWithValue()
    {
        var vm = CreateViewModel();

        vm.Temperature = 0.2f;
        Assert.Contains("focused", vm.TemperatureDescription.ToLower());

        vm.Temperature = 1.5f;
        Assert.Contains("creative", vm.TemperatureDescription.ToLower());
    }

    [Fact]
    public async Task SelectPreset_ShouldUpdateAllValues()
    {
        var vm = CreateViewModel();
        var preset = new InferencePresetViewModel(CreateTestPreset());
        vm.Presets.Add(preset);

        vm.SelectedPreset = preset;
        await Task.Delay(100); // Wait for async apply

        // Values should match preset
    }
}
```

---

## Acceptance Criteria

### v0.2.3a - Models & Repository
- [ ] InferenceOptions model validates all parameter ranges
- [ ] InferencePreset model stores all required data
- [ ] Repository CRUD operations work correctly
- [ ] Built-in presets are seeded on first run
- [ ] Cannot delete or modify built-in presets

### v0.2.3b - Settings Service
- [ ] Current options update correctly for each parameter
- [ ] Changes fire appropriate events
- [ ] Presets load and apply correctly
- [ ] Save as preset creates new preset with current values
- [ ] Active preset persists across app restarts

### v0.2.3c - ViewModels
- [ ] All parameters bind correctly to UI
- [ ] Descriptions update dynamically
- [ ] Preset dropdown shows all presets
- [ ] HasUnsavedChanges reflects actual state
- [ ] Debounce prevents excessive updates

### v0.2.3d - Parameter Slider
- [ ] Slider values bind correctly
- [ ] Step increments work
- [ ] Keyboard navigation works (arrows, Home, End)
- [ ] Value display formats correctly
- [ ] Description shows below slider

### v0.2.3e - Settings Panel UI
- [ ] Panel displays in sidebar
- [ ] Preset dropdown works
- [ ] All sliders adjust correctly
- [ ] Advanced section expands/collapses
- [ ] Save preset dialog works
- [ ] Status bar shows current preset/temperature
- [ ] Inference uses correct parameter values

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Slider drag causes excessive updates | High | Low | 200ms debounce timer |
| Invalid parameter values | Medium | High | Validation in model and clamp in service |
| Context size exceeds model capability | Medium | Medium | Warn user, use model-reported max |
| Preset migration on schema changes | Low | Medium | Version presets, migration logic |
| UI thread blocking | Low | High | Async operations, background updates |

---

## Future Considerations

### v0.2.4+ Enhancements
- Per-conversation inference settings override
- System prompt can specify recommended parameters
- Parameter presets tied to system prompts
- Import/export presets as JSON
- Preset sharing between installations

### Performance Optimization
- Cache preset list in memory
- Batch parameter updates within debounce window
- Lazy-load advanced parameters section

---

## References

- [LLamaSharp Inference Parameters](https://github.com/SciSharp/LLamaSharp/wiki/Parameters)
- [Understanding Temperature and Top-P](https://platform.openai.com/docs/api-reference/chat/create#chat-create-temperature)
- [Avalonia Slider Control](https://docs.avaloniaui.net/docs/controls/slider)
- [CommunityToolkit.Mvvm Source Generators](https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/generators/overview)
