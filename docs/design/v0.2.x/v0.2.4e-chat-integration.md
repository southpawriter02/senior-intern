# Design Specification: AIntern v0.2.4e "Chat Integration"

## Executive Summary

This document provides a detailed implementation specification for v0.2.4e, which integrates system prompts with the chat interface. This includes the quick prompt selector dropdown in the chat header, displaying the active system prompt, building LLM context with the system message, and providing access to the prompt editor.

### v0.2.4e Scope (from v0.2.4 Design Document)

- Create `SystemPromptSelector.axaml` control for chat header
- Update ChatView to include selector and prompt display
- Update ChatViewModel to build context with system prompt
- Update LlmService to handle system messages in chat history
- Add OpenSystemPromptEditorAsync command to MainWindowViewModel
- Complete DI registration for all v0.2.4 services

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| SystemPromptSelector | Dropdown control for chat header |
| ChatView Updates | Selector header + prompt expander |
| ChatViewModel Integration | Build context with system message |
| LlmService Updates | Convert system messages to LLamaSharp |
| DI Registration | Complete service wiring |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.4e Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  SystemPromptSelector (UserControl)                               │
│  ├── "Using:" label                                               │
│  ├── ComboBox with all prompts                                    │
│  │   ├── "(No system prompt)" option                              │
│  │   ├── User prompts with ★ default indicator                    │
│  │   └── Built-in templates with category                         │
│  └── Edit button → OpenEditorCommand                              │
│                                                                   │
│  ChatView Updates                                                 │
│  ├── Header: SystemPromptSelector                                 │
│  └── Message List Top: System Prompt Expander                     │
│      ├── Collapsed: "Using: [PromptName]"                         │
│      └── Expanded: Full prompt content (read-only)                │
│                                                                   │
│  ChatViewModel Updates                                            │
│  ├── SystemPromptSelectorViewModel (child)                        │
│  ├── ShowSystemPromptMessage (bool)                               │
│  ├── SystemPromptContent, SystemPromptName                        │
│  ├── OnCurrentPromptChanged event handler                         │
│  └── BuildContextWithSystemPrompt()                               │
│      └── Prepend MessageRole.System to conversation               │
│                                                                   │
│  LlmService Updates                                               │
│  └── GenerateStreamingAsync()                                     │
│      └── Map MessageRole.System → AuthorRole.System               │
│                                                                   │
│  MainWindowViewModel Updates                                      │
│  └── OpenSystemPromptEditorCommand                                │
│      └── Show SystemPromptEditorWindow as dialog                  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### System Prompt in LLM Context

```
┌─────────────────────────────────────────────────────────────────┐
│                System Prompt in LLM Context                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User sends message                                              │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ChatViewModel.GenerateResponseAsync()                     │    │
│  │   systemPrompt = _systemPromptService.CurrentPrompt       │    │
│  │   context = BuildContextWithSystemPrompt(systemPrompt)    │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ BuildContextWithSystemPrompt()                            │    │
│  │                                                           │    │
│  │   if (systemPrompt != null)                               │    │
│  │     yield ChatMessage(Role=System, Content=prompt)        │    │
│  │                                                           │    │
│  │   foreach (message in conversation)                       │    │
│  │     yield message                                         │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ LlmService.GenerateStreamingAsync(context)                │    │
│  │                                                           │    │
│  │   ChatHistory:                                            │    │
│  │   ┌─────────────────────────────────────────────────────┐ │    │
│  │   │ [System] You are "The Senior Intern"...             │ │    │
│  │   │ [User] Help me write a function to...               │ │    │
│  │   │ [Assistant] Sure! Here's how...                     │ │    │
│  │   │ [User] Can you optimize it?                         │ │    │
│  │   └─────────────────────────────────────────────────────┘ │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### ChatView Layout with Selector

```
┌─────────────────────────────────────────────────────────────────┐
│                    ChatView Layout Update                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    Header Bar (NEW)                         │  │
│  │  Using: [★ The Senior Intern ▾]              [✏️ Edit]     │  │
│  └────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                 System Prompt Expander (NEW)                │  │
│  │  ▶ Using: The Senior Intern                                 │  │
│  │  └── (expands to show full prompt content)                  │  │
│  └────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    Message List (existing)                  │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ [User] Help me write a function...                    │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ [Assistant] *Sighs* Another function? Sure...         │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    Input Area (existing)                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
├── Views/
│   ├── SystemPromptSelector.axaml                    (NEW)
│   ├── SystemPromptSelector.axaml.cs                 (NEW)
│   └── ChatView.axaml                                (UPDATE)
├── ViewModels/
│   ├── ChatViewModel.cs                              (UPDATE)
│   └── MainWindowViewModel.cs                        (UPDATE)
└── Extensions/
    └── ServiceCollectionExtensions.cs                (UPDATE)

src/SeniorIntern.Services/
└── LlmService.cs                                     (UPDATE)
```

---

## Implementation Details

### Task 1: Create SystemPromptSelector Control

**File:** `src/SeniorIntern.Desktop/Views/SystemPromptSelector.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             x:Class="SeniorIntern.Desktop.Views.SystemPromptSelector"
             x:DataType="vm:SystemPromptSelectorViewModel">

    <Border Background="{DynamicResource ControlBackgroundColor}"
            CornerRadius="4" Padding="8,4">
        <Grid ColumnDefinitions="Auto,*,Auto">
            <!-- Label -->
            <TextBlock Grid.Column="0" Text="Using:" FontSize="12"
                       Foreground="{DynamicResource TextSecondaryColor}"
                       VerticalAlignment="Center" Margin="0,0,8,0" />

            <!-- Prompt Dropdown -->
            <ComboBox Grid.Column="1"
                      ItemsSource="{Binding AvailablePrompts}"
                      SelectedItem="{Binding SelectedPrompt}"
                      MinWidth="150" MaxWidth="300">
                <ComboBox.ItemTemplate>
                    <DataTemplate x:DataType="vm:SystemPromptViewModel">
                        <Grid ColumnDefinitions="Auto,*">
                            <TextBlock Text="★" IsVisible="{Binding IsDefault}"
                                       Foreground="{DynamicResource AccentColor}"
                                       Margin="0,0,6,0" VerticalAlignment="Center" />
                            <StackPanel Grid.Column="1" Spacing="2">
                                <TextBlock Text="{Binding Name}"
                                           FontWeight="{Binding IsDefault, Converter={StaticResource BoolToFontWeightConverter}}" />
                                <TextBlock Text="{Binding Category}" FontSize="10"
                                           Foreground="{DynamicResource TextTertiaryColor}"
                                           IsVisible="{Binding Category, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>

            <!-- Edit Button -->
            <Button Grid.Column="2" Command="{Binding OpenEditorCommand}"
                    ToolTip.Tip="Edit Prompts" Classes="icon-button small" Margin="8,0,0,0">
                <PathIcon Data="{StaticResource EditIcon}" Width="14" Height="14" />
            </Button>
        </Grid>
    </Border>
</UserControl>
```

**File:** `src/SeniorIntern.Desktop/Views/SystemPromptSelector.axaml.cs`

```csharp
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;

public partial class SystemPromptSelector : UserControl
{
    public SystemPromptSelector()
    {
        InitializeComponent();
    }
}
```

---

### Task 2: Update ChatView

**File:** `src/SeniorIntern.Desktop/Views/ChatView.axaml` (updates)

```xml
<Grid RowDefinitions="Auto,Auto,*,Auto">
    <!-- System Prompt Selector Header (NEW) -->
    <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundColor}"
            Padding="12,8" BorderBrush="{DynamicResource BorderColor}" BorderThickness="0,0,0,1">
        <views:SystemPromptSelector DataContext="{Binding SystemPromptSelectorViewModel}" />
    </Border>

    <!-- System Prompt Display Expander (NEW) -->
    <Border Grid.Row="1" IsVisible="{Binding ShowSystemPromptMessage}"
            Background="{DynamicResource SystemPromptBackgroundColor}"
            Padding="12" Margin="12,12,12,0" CornerRadius="8">
        <Expander IsExpanded="False">
            <Expander.Header>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="{StaticResource PromptIcon}" Width="16" Height="16"
                              Foreground="{DynamicResource TextSecondaryColor}" />
                    <TextBlock Text="{Binding SystemPromptName, StringFormat='Using: {0}'}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextSecondaryColor}" />
                </StackPanel>
            </Expander.Header>
            <TextBlock Text="{Binding SystemPromptContent}"
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource TextSecondaryColor}"
                       FontSize="12" Margin="24,8,0,0" />
        </Expander>
    </Border>

    <!-- Message List (existing, moved to Row 2) -->
    <ScrollViewer Grid.Row="2" ... />

    <!-- Input Area (existing, moved to Row 3) -->
    <Border Grid.Row="3" ... />
</Grid>
```

---

### Task 3: Update ChatViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/ChatViewModel.cs` (updates)

```csharp
public partial class ChatViewModel : ViewModelBase
{
    private readonly ISystemPromptService _systemPromptService;

    [ObservableProperty]
    private SystemPromptSelectorViewModel _systemPromptSelectorViewModel;

    [ObservableProperty]
    private bool _showSystemPromptMessage;

    [ObservableProperty]
    private string? _systemPromptContent;

    [ObservableProperty]
    private string? _systemPromptName;

    public ChatViewModel(
        IConversationService conversationService,
        ILlmService llmService,
        ISystemPromptService systemPromptService,
        IDispatcher dispatcher)
    {
        _conversationService = conversationService;
        _llmService = llmService;
        _systemPromptService = systemPromptService;

        _systemPromptSelectorViewModel = new SystemPromptSelectorViewModel(
            systemPromptService, conversationService, dispatcher);

        _systemPromptService.CurrentPromptChanged += OnCurrentPromptChanged;
    }

    private void OnCurrentPromptChanged(object? sender, CurrentPromptChangedEventArgs e)
    {
        _dispatcher.InvokeAsync(() =>
        {
            if (e.NewPrompt != null)
            {
                ShowSystemPromptMessage = true;
                SystemPromptContent = e.NewPrompt.Content;
                SystemPromptName = e.NewPrompt.Name;
            }
            else
            {
                ShowSystemPromptMessage = false;
                SystemPromptContent = null;
                SystemPromptName = null;
            }
        });
    }

    private async Task GenerateResponseAsync(string userInput)
    {
        var systemPrompt = _systemPromptService.CurrentPrompt;
        var context = BuildContextWithSystemPrompt(systemPrompt);
        
        await foreach (var token in _llmService.GenerateStreamingAsync(context))
        {
            // ... streaming logic
        }
    }

    private IEnumerable<ChatMessage> BuildContextWithSystemPrompt(SystemPrompt? systemPrompt)
    {
        if (systemPrompt != null)
        {
            yield return new ChatMessage
            {
                Role = MessageRole.System,
                Content = _systemPromptService.FormatPromptForContext(systemPrompt),
                Timestamp = DateTime.UtcNow
            };
        }

        foreach (var message in _conversationService.GetMessages())
        {
            yield return message;
        }
    }
}
```

---

### Task 4: Update LlmService

**File:** `src/SeniorIntern.Services/LlmService.cs` (updates)

```csharp
public async IAsyncEnumerable<string> GenerateStreamingAsync(
    IEnumerable<ChatMessage> conversation,
    InferenceOptions? options = null,
    [EnumeratorCancellation] CancellationToken cancellationToken = default)
{
    var messages = conversation.ToList();
    var chatHistory = new ChatHistory();

    foreach (var message in messages)
    {
        var role = message.Role switch
        {
            MessageRole.System => AuthorRole.System,
            MessageRole.User => AuthorRole.User,
            MessageRole.Assistant => AuthorRole.Assistant,
            _ => AuthorRole.User
        };

        chatHistory.AddMessage(role, message.Content);
    }

    // Generate with full context including system prompt
    // ... inference logic
}
```

---

### Task 5: Update MainWindowViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` (additions)

```csharp
private readonly ISystemPromptService _systemPromptService;

[RelayCommand]
private async Task OpenSystemPromptEditorAsync()
{
    var window = new SystemPromptEditorWindow
    {
        DataContext = new SystemPromptEditorViewModel(_systemPromptService, _dispatcher)
    };
    await window.ShowDialog(GetMainWindow());
}
```

---

### Task 6: Complete DI Registration

**File:** `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` (additions)

```csharp
// System Prompt Services (v0.2.4)
services.AddSingleton<ISystemPromptRepository, SystemPromptRepository>();
services.AddSingleton<ISystemPromptService, SystemPromptService>();
services.AddTransient<SystemPromptEditorViewModel>();
services.AddSingleton<SystemPromptSelectorViewModel>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| SystemPromptSelector | 3 | Selection binding, display |
| ChatViewModel Integration | 5 | Context building, event handling |
| LlmService | 3 | Role mapping, system message |
| **Total** | **11** | |

### Key Test Scenarios

```csharp
[Fact]
public void BuildContextWithSystemPrompt_PrependsSystemMessage()
{
    var vm = CreateChatViewModel();
    var systemPrompt = new SystemPrompt { Content = "You are helpful" };
    
    var context = vm.BuildContextWithSystemPrompt(systemPrompt).ToList();
    
    Assert.Equal(MessageRole.System, context[0].Role);
    Assert.Equal("You are helpful", context[0].Content);
}

[Fact]
public void BuildContextWithSystemPrompt_NullPrompt_NoSystemMessage()
{
    var vm = CreateChatViewModel();
    _conversationService.AddMessage(new ChatMessage { Role = MessageRole.User, Content = "Hi" });
    
    var context = vm.BuildContextWithSystemPrompt(null).ToList();
    
    Assert.All(context, m => Assert.NotEqual(MessageRole.System, m.Role));
}

[Fact]
public void LlmService_MapsSystemRoleToAuthorRoleSystem()
{
    var messages = new[]
    {
        new ChatMessage { Role = MessageRole.System, Content = "System prompt" },
        new ChatMessage { Role = MessageRole.User, Content = "Hello" }
    };
    
    var history = _llmService.BuildChatHistory(messages);
    
    Assert.Equal(AuthorRole.System, history.Messages[0].AuthorRole);
}

[Fact]
public void OnCurrentPromptChanged_UpdatesUIProperties()
{
    var vm = CreateChatViewModel();
    var prompt = new SystemPrompt { Name = "Test", Content = "Content" };
    
    vm.OnCurrentPromptChanged(null, new CurrentPromptChangedEventArgs { NewPrompt = prompt });
    
    Assert.True(vm.ShowSystemPromptMessage);
    Assert.Equal("Test", vm.SystemPromptName);
    Assert.Equal("Content", vm.SystemPromptContent);
}
```

---

## Files Summary

### Files to Create (2)

| File | Lines (approx) |
|------|----------------|
| `Views/SystemPromptSelector.axaml` | 50 |
| `Views/SystemPromptSelector.axaml.cs` | 10 |

### Files to Modify (5)

| File | Changes |
|------|---------|
| `Views/ChatView.axaml` | Add selector header, prompt expander |
| `ViewModels/ChatViewModel.cs` | Add integration properties/methods |
| `ViewModels/MainWindowViewModel.cs` | Add OpenSystemPromptEditorCommand |
| `Services/LlmService.cs` | Handle system messages |
| `Extensions/ServiceCollectionExtensions.cs` | Complete DI registration |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Selector dropdown shows all prompts + "None" option |
| AC-2 | Default prompt shows ★ indicator |
| AC-3 | Category shows in dropdown items |
| AC-4 | Edit button opens SystemPromptEditorWindow |
| AC-5 | System prompt expander shows prompt name |
| AC-6 | Expander reveals full prompt content |
| AC-7 | LLM context includes system message first |
| AC-8 | No system message when CurrentPrompt is null |
| AC-9 | UI updates on CurrentPromptChanged event |
| AC-10 | All v0.2.4 services registered in DI |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Selector in chat header | Always visible, easy access |
| Collapsible prompt display | Show context without overwhelming |
| System message first in context | Standard LLM convention |
| Yield iterator for context | Efficient, lazy evaluation |
| Event-driven UI update | Reactive, decoupled architecture |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.4e | 1 day |
