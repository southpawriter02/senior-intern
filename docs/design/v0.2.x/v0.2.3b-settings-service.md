# Design Specification: The Senior Intern v0.2.3b "Settings Service"

## Executive Summary

This document provides a detailed implementation specification for v0.2.3b, which implements the `IInferenceSettingsService` that manages current inference options, handles persistence, provides preset operations, and notifies consumers of changes via events.

### v0.2.3b Scope (from v0.2.3 Design Document)

- Create `IInferenceSettingsService` interface
- Create event args classes for settings and preset changes
- Implement `InferenceSettingsService` with full functionality
- Integrate with `ISettingsService` for persistence
- Fire events on all settings changes
- DI registration

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| IInferenceSettingsService | Interface for settings management |
| InferenceSettingsChangedEventArgs | Event args for settings changes |
| PresetChangedEventArgs | Event args for preset changes |
| InferenceSettingsService | Full implementation with persistence |
| DI Registration | Service wiring |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.3b Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  IInferenceSettingsService                                        │
│  ├── Properties                                                   │
│  │   ├── CurrentOptions (live InferenceOptions)                   │
│  │   ├── ActivePreset (null if custom)                            │
│  │   └── HasUnsavedChanges (differs from preset)                  │
│  │                                                                │
│  ├── Parameter Updates (with clamping + change detection)         │
│  │   ├── UpdateTemperature(float)                                 │
│  │   ├── UpdateTopP(float)                                        │
│  │   ├── UpdateMaxTokens(int)                                     │
│  │   ├── UpdateContextSize(uint)                                  │
│  │   ├── UpdateRepetitionPenalty(float)                           │
│  │   ├── UpdateTopK(int)                                          │
│  │   └── UpdateAll(InferenceOptions)                              │
│  │                                                                │
│  ├── Preset Operations                                            │
│  │   ├── GetPresetsAsync() → all presets                          │
│  │   ├── ApplyPresetAsync(id) → load preset settings              │
│  │   ├── SaveAsPresetAsync(name) → create new                     │
│  │   ├── UpdatePresetAsync(id) → update existing                  │
│  │   ├── DeletePresetAsync(id) → remove                           │
│  │   ├── ResetToDefaultsAsync() → apply default                   │
│  │   └── SetDefaultPresetAsync(id) → change default               │
│  │                                                                │
│  └── Events                                                       │
│      ├── SettingsChanged (ParameterChanged, PresetApplied, etc.)  │
│      └── PresetChanged (Applied, Created, Updated, Deleted)       │
│                                                                   │
│  Supporting Types                                                 │
│  ├── InferenceSettingsChangedEventArgs                            │
│  │   ├── NewOptions                                               │
│  │   ├── ChangeType (enum)                                        │
│  │   └── ChangedParameter (string?)                               │
│  │                                                                │
│  └── PresetChangedEventArgs                                       │
│      ├── NewPreset, PreviousPreset                                │
│      └── ChangeType (enum)                                        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Service Integration

```
┌─────────────────────────────────────────────────────────────────┐
│                    Service Layer Integration                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                InferenceSettingsService                    │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────┐   │  │
│  │  │   _currentOptions    │  │     _activePreset         │   │  │
│  │  │   (InferenceOptions) │  │   (InferencePreset?)      │   │  │
│  │  └──────────────────────┘  └──────────────────────────┘   │  │
│  │                                                            │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────┐   │  │
│  │  │   _presetSnapshot    │  │       _lock               │   │  │
│  │  │   (for diff check)   │  │   (SemaphoreSlim)         │   │  │
│  │  └──────────────────────┘  └──────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────┘  │
│                          │                                       │
│           ┌──────────────┼──────────────┐                        │
│           ▼              ▼              ▼                        │
│  ┌──────────────┐ ┌─────────────┐ ┌─────────────────┐            │
│  │IInferencePre-│ │ISettings    │ │ Consumers       │            │
│  │setRepository │ │Service      │ │ (LlmService,    │            │
│  │              │ │(JSON file)  │ │  ViewModels)    │            │
│  └──────────────┘ └─────────────┘ └─────────────────┘            │
│         │                │                  ▲                    │
│         ▼                ▼                  │                    │
│  ┌──────────────┐ ┌─────────────┐  SettingsChanged event         │
│  │  SQLite DB   │ │settings.json│                                │
│  │  (Presets)   │ │(active ID)  │                                │
│  └──────────────┘ └─────────────┘                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Event Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Event Flow                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User adjusts Temperature slider                                 │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ UpdateTemperature(1.2f)                                   │    │
│  │  1. Clamp to valid range                                  │    │
│  │  2. Check if different (skip if same)                     │    │
│  │  3. Update _currentOptions.Temperature                    │    │
│  │  4. Call OnSettingsChanged(ParameterChanged, "Temp")      │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ OnSettingsChanged()                                       │    │
│  │  1. Fire SettingsChanged event                            │    │
│  │  2. Subscribers (LlmService, ViewModel) receive           │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                ┌─────────────┴─────────────┐                     │
│                ▼                           ▼                     │
│  ┌──────────────────────┐    ┌──────────────────────────────┐    │
│  │ LlmService           │    │ InferenceSettingsViewModel   │    │
│  │ Updates its local    │    │ Updates UI display           │    │
│  │ options reference    │    │ HasUnsavedChanges = true     │    │
│  └──────────────────────┘    └──────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Interfaces/
│   └── IInferenceSettingsService.cs                  (NEW)
└── Events/
    ├── InferenceSettingsChangedEventArgs.cs          (NEW)
    └── PresetChangedEventArgs.cs                     (NEW)

src/SeniorIntern.Services/
└── InferenceSettingsService.cs                       (NEW)

src/SeniorIntern.Desktop/
└── Extensions/
    └── ServiceCollectionExtensions.cs                (UPDATE)
```

---

## Implementation Details

### Task 1: Create Event Args Classes

**File:** `src/SeniorIntern.Core/Events/InferenceSettingsChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

using SeniorIntern.Core.Models;

/// <summary>Event args for inference settings changes.</summary>
public sealed class InferenceSettingsChangedEventArgs : EventArgs
{
    public required InferenceOptions NewOptions { get; init; }
    public required InferenceSettingsChangeType ChangeType { get; init; }
    public string? ChangedParameter { get; init; }
}

public enum InferenceSettingsChangeType
{
    ParameterChanged,
    PresetApplied,
    ResetToDefaults,
    AllChanged
}
```

**File:** `src/SeniorIntern.Core/Events/PresetChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Events;

using SeniorIntern.Core.Models;

/// <summary>Event args for preset changes.</summary>
public sealed class PresetChangedEventArgs : EventArgs
{
    public InferencePreset? NewPreset { get; init; }
    public InferencePreset? PreviousPreset { get; init; }
    public required PresetChangeType ChangeType { get; init; }
}

public enum PresetChangeType
{
    Applied,
    Created,
    Updated,
    Deleted,
    DefaultChanged
}
```

---

### Task 2: Create IInferenceSettingsService Interface

**File:** `src/SeniorIntern.Core/Interfaces/IInferenceSettingsService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Events;
using SeniorIntern.Core.Models;

/// <summary>Service for managing inference settings.</summary>
public interface IInferenceSettingsService
{
    /// <summary>Current live inference options.</summary>
    InferenceOptions CurrentOptions { get; }

    /// <summary>Currently active preset (null if custom).</summary>
    InferencePreset? ActivePreset { get; }

    /// <summary>Whether settings differ from active preset.</summary>
    bool HasUnsavedChanges { get; }

    // Parameter updates
    void UpdateTemperature(float value);
    void UpdateTopP(float value);
    void UpdateMaxTokens(int value);
    void UpdateContextSize(uint value);
    void UpdateRepetitionPenalty(float value);
    void UpdateTopK(int value);
    void UpdateAll(InferenceOptions options);

    // Preset operations
    Task<IReadOnlyList<InferencePreset>> GetPresetsAsync(CancellationToken ct = default);
    Task ApplyPresetAsync(Guid presetId, CancellationToken ct = default);
    Task<InferencePreset> SaveAsPresetAsync(string name, string? description = null, CancellationToken ct = default);
    Task UpdatePresetAsync(Guid presetId, CancellationToken ct = default);
    Task DeletePresetAsync(Guid presetId, CancellationToken ct = default);
    Task ResetToDefaultsAsync(CancellationToken ct = default);
    Task SetDefaultPresetAsync(Guid presetId, CancellationToken ct = default);

    // Events
    event EventHandler<InferenceSettingsChangedEventArgs>? SettingsChanged;
    event EventHandler<PresetChangedEventArgs>? PresetChanged;
}
```

---

### Task 3: Implement InferenceSettingsService

**File:** `src/SeniorIntern.Services/InferenceSettingsService.cs`

Key implementation aspects:

```csharp
namespace SeniorIntern.Services;

using Microsoft.Extensions.Logging;
using SeniorIntern.Core;
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data.Repositories;

public sealed class InferenceSettingsService : IInferenceSettingsService, IAsyncDisposable
{
    private readonly IInferencePresetRepository _presetRepository;
    private readonly ISettingsService _settingsService;
    private readonly ILogger<InferenceSettingsService> _logger;

    private InferenceOptions _currentOptions = new();
    private InferencePreset? _activePreset;
    private InferenceOptions? _presetSnapshot;
    private readonly SemaphoreSlim _lock = new(1, 1);

    public InferenceOptions CurrentOptions => _currentOptions;
    public InferencePreset? ActivePreset => _activePreset;

    public bool HasUnsavedChanges
    {
        get
        {
            if (_activePreset == null || _presetSnapshot == null) return false;
            return !OptionsEqual(_currentOptions, _presetSnapshot);
        }
    }

    public event EventHandler<InferenceSettingsChangedEventArgs>? SettingsChanged;
    public event EventHandler<PresetChangedEventArgs>? PresetChanged;

    // Constructor, InitializeAsync, parameter update methods...
    
    // Mapping helper
    private static InferencePreset MapToPreset(InferencePresetEntity entity) => new()
    {
        Id = entity.Id,
        Name = entity.Name,
        Description = entity.Description,
        Category = entity.Category,
        IsBuiltIn = entity.IsBuiltIn,
        IsDefault = entity.IsDefault,
        CreatedAt = entity.CreatedAt,
        UpdatedAt = entity.UpdatedAt,
        Options = new InferenceOptions
        {
            Temperature = entity.Temperature,
            TopP = entity.TopP,
            MaxTokens = entity.MaxTokens,
            ContextSize = entity.ContextSize,
            RepetitionPenalty = entity.RepetitionPenalty,
            TopK = entity.TopK,
            Seed = entity.Seed
        }
    };

    private static bool OptionsEqual(InferenceOptions a, InferenceOptions b) =>
        Math.Abs(a.Temperature - b.Temperature) < 0.001f &&
        Math.Abs(a.TopP - b.TopP) < 0.001f &&
        a.MaxTokens == b.MaxTokens &&
        a.ContextSize == b.ContextSize &&
        Math.Abs(a.RepetitionPenalty - b.RepetitionPenalty) < 0.001f &&
        a.TopK == b.TopK;

    private void OnSettingsChanged(InferenceSettingsChangeType type, string? param = null)
    {
        SettingsChanged?.Invoke(this, new InferenceSettingsChangedEventArgs
        {
            NewOptions = _currentOptions.Clone(),
            ChangeType = type,
            ChangedParameter = param
        });
    }

    private void OnPresetChanged(InferencePreset? newPreset, InferencePreset? prev, PresetChangeType type)
    {
        PresetChanged?.Invoke(this, new PresetChangedEventArgs
        {
            NewPreset = newPreset,
            PreviousPreset = prev,
            ChangeType = type
        });
    }

    public async ValueTask DisposeAsync()
    {
        _lock.Dispose();
    }
}
```

**Key Methods:**

| Method | Behavior |
|--------|----------|
| `UpdateTemperature` | Clamp, skip if same, update, fire event |
| `ApplyPresetAsync` | Load preset, clone options, save to settings, fire events |
| `SaveAsPresetAsync` | Validate name, create entity, persist, fire event |
| `DeletePresetAsync` | Validate not built-in, delete, fire event |
| `ResetToDefaultsAsync` | Get default preset, apply it |

---

### Task 4: Update DI Registration

**File:** `src/SeniorIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`

```csharp
// Add to existing registration
services.AddSingleton<IInferenceSettingsService, InferenceSettingsService>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| Parameter Updates | 7 | Clamping, change detection, events |
| Preset Operations | 8 | CRUD, validation, events |
| HasUnsavedChanges | 3 | Comparison logic |
| Event Firing | 4 | Correct event args |
| **Total** | **22** | |

### Key Test Scenarios

```csharp
[Fact]
public void UpdateTemperature_ClampsToValidRange()
{
    var service = CreateService();
    service.UpdateTemperature(5.0f); // Over max
    Assert.Equal(2.0f, service.CurrentOptions.Temperature);
}

[Fact]
public void UpdateTemperature_DoesNotFireEvent_WhenValueUnchanged()
{
    var service = CreateService();
    var eventFired = false;
    service.SettingsChanged += (s, e) => eventFired = true;
    
    service.UpdateTemperature(0.7f); // Same as default
    Assert.False(eventFired);
}

[Fact]
public async Task ApplyPresetAsync_UpdatesCurrentOptions()
{
    var service = await CreateInitializedService();
    var presets = await service.GetPresetsAsync();
    var precise = presets.First(p => p.Name == "Precise");
    
    await service.ApplyPresetAsync(precise.Id);
    
    Assert.Equal(0.2f, service.CurrentOptions.Temperature);
}

[Fact]
public void HasUnsavedChanges_ReturnsTrue_WhenOptionsModified()
{
    var service = await CreateInitializedService();
    await service.ApplyPresetAsync(balancedId);
    
    Assert.False(service.HasUnsavedChanges);
    
    service.UpdateTemperature(1.5f);
    Assert.True(service.HasUnsavedChanges);
}

[Fact]
public async Task SaveAsPresetAsync_ThrowsForDuplicateName()
{
    var service = await CreateInitializedService();
    await Assert.ThrowsAsync<InvalidOperationException>(
        () => service.SaveAsPresetAsync("Balanced"));
}
```

---

## Files Summary

### Files to Create (4)

| File | Lines (approx) |
|------|----------------|
| `Core/Interfaces/IInferenceSettingsService.cs` | 45 |
| `Core/Events/InferenceSettingsChangedEventArgs.cs` | 20 |
| `Core/Events/PresetChangedEventArgs.cs` | 20 |
| `Services/InferenceSettingsService.cs` | 250 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Add service registration |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | CurrentOptions reflects live settings |
| AC-2 | Parameter updates clamp to valid ranges |
| AC-3 | No event fires when value unchanged |
| AC-4 | ApplyPresetAsync loads preset options |
| AC-5 | HasUnsavedChanges detects differences |
| AC-6 | SaveAsPresetAsync validates name uniqueness |
| AC-7 | Cannot delete built-in presets |
| AC-8 | SettingsChanged event fires on changes |
| AC-9 | PresetChanged event fires on preset ops |
| AC-10 | Active preset persists to settings.json |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Clone options in events | Prevent external modification |
| SemaphoreSlim for preset ops | Thread-safe async operations |
| Float comparison with epsilon | Avoid floating-point equality issues |
| Skip event for unchanged values | Prevent UI update loops |
| Persist to settings.json | Fast startup, last-used preset |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.3b | 0.5-1 day |
