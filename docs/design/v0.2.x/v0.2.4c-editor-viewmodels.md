# Design Specification: The Senior Intern v0.2.4c "Editor ViewModels"

## Executive Summary

This document provides a detailed implementation specification for v0.2.4c, which creates the ViewModels for the system prompt editor window. This includes `SystemPromptEditorViewModel` for full CRUD editing, `SystemPromptViewModel` for list items, and `SystemPromptSelectorViewModel` for the quick selector in the chat header.

### v0.2.4c Scope (from v0.2.4 Design Document)

- Create `SystemPromptEditorViewModel` with full editor state management
- Create `SystemPromptViewModel` for prompt list items
- Create `SystemPromptSelectorViewModel` for chat header dropdown
- Implement dirty tracking and validation
- Handle character/token counting
- Subscribe to service events for UI synchronization

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| SystemPromptEditorViewModel | Full editor with CRUD commands |
| SystemPromptViewModel | List item ViewModel |
| SystemPromptSelectorViewModel | Quick selector in chat header |
| DI Registration | ViewModel wiring |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.4c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  SystemPromptEditorViewModel                                      │
│  ├── Prompt Lists                                                 │
│  │   ├── UserPrompts (ObservableCollection) - custom prompts      │
│  │   ├── Templates (ObservableCollection) - built-in prompts      │
│  │   └── SelectedPrompt                                           │
│  │                                                                │
│  ├── Editor State                                                 │
│  │   ├── PromptName, PromptDescription, EditorContent             │
│  │   ├── IsDirty, IsEditing, IsNewPrompt                          │
│  │   ├── CanEdit, CanDelete, CanSetDefault                        │
│  │   └── _originalPrompt (for dirty tracking)                     │
│  │                                                                │
│  ├── Computed Properties                                          │
│  │   ├── CharacterCount, EstimatedTokenCount                      │
│  │   ├── CharacterCountText, TokenCountText                       │
│  │   ├── HasContent, HasValidName, CanSave                        │
│  │   └── ValidationError                                          │
│  │                                                                │
│  ├── Commands                                                     │
│  │   ├── CreateNewPromptAsync                                     │
│  │   ├── SavePromptAsync (CanExecute=CanSave)                     │
│  │   ├── DeletePromptAsync (CanExecute=CanDelete)                 │
│  │   ├── DuplicatePromptAsync                                     │
│  │   ├── SetAsDefaultAsync (CanExecute=CanSetDefault)             │
│  │   ├── CreateFromTemplateAsync(template)                        │
│  │   ├── LoadTemplate(template)                                   │
│  │   ├── DiscardChanges                                           │
│  │   └── StartEditing                                             │
│  │                                                                │
│  └── Event Handlers                                               │
│      └── OnPromptListChanged → LoadPromptsAsync()                 │
│                                                                   │
│  SystemPromptViewModel (List item)                                │
│  ├── Properties: Id, Name, Content, Description, Category         │
│  ├── Flags: IsBuiltIn, IsDefault, IsSelected                      │
│  ├── Computed: CharacterCount, EstimatedTokenCount                │
│  ├── ContentPreview (first 100 chars)                             │
│  ├── TypeLabel ("Template" / "Custom")                            │
│  └── CategoryIcon (icon key based on category)                    │
│                                                                   │
│  SystemPromptSelectorViewModel (Chat header dropdown)             │
│  ├── AvailablePrompts (all + "None" option)                       │
│  ├── SelectedPrompt                                               │
│  ├── DisplayText                                                  │
│  ├── ApplyToConversationAsync command                             │
│  └── Event sync with service and conversation                     │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Editor ViewModel State Flow

```
┌─────────────────────────────────────────────────────────────────┐
│               SystemPromptEditorViewModel State Flow             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User selects "My Custom Prompt" from list                       │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ OnSelectedPromptChanged(value)                            │    │
│  │  → LoadPromptIntoEditor(value)                            │    │
│  │    1. Store _originalPrompt for dirty tracking            │    │
│  │    2. Set PromptName, PromptDescription, EditorContent    │    │
│  │    3. Set CanEdit=true, CanDelete=true (not built-in)     │    │
│  │    4. Set IsDirty=false, IsEditing=false                  │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  User modifies content                                           │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ OnEditorContentChanged(value)                             │    │
│  │  1. UpdateDirtyState() → compare with _originalPrompt     │    │
│  │  2. Update computed properties (CharacterCount, etc.)     │    │
│  │  3. Update CanSave = HasValidName && HasContent && IsDirty│    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  User clicks Save                                                │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SavePromptAsync()                                         │    │
│  │  if (IsNewPrompt) CreatePromptAsync(...)                  │    │
│  │  else UpdatePromptAsync(_originalPrompt.Id, ...)          │    │
│  │  → IsDirty = false                                        │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### New Prompt Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      New Prompt Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User clicks "New Prompt" button                                 │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ CreateNewPromptAsync()                                    │    │
│  │  1. Check IsDirty → ConfirmDiscardChangesAsync()          │    │
│  │  2. SelectedPrompt = null (deselect)                      │    │
│  │  3. IsNewPrompt = true                                    │    │
│  │  4. IsEditing = true, CanEdit = true                      │    │
│  │  5. CanDelete = false, CanSetDefault = false              │    │
│  │  6. PromptName = "New Prompt"                             │    │
│  │  7. EditorContent = "" (empty)                            │    │
│  │  8. _originalPrompt = null                                │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│  User fills in content and saves                                 │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ SavePromptAsync() [IsNewPrompt=true]                      │    │
│  │  1. CreatePromptAsync(Name, Content, Description)         │    │
│  │  2. Reload prompts list                                   │    │
│  │  3. SelectPromptById(newId)                               │    │
│  │  4. IsNewPrompt = false                                   │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
├── ViewModels/
│   ├── SystemPromptEditorViewModel.cs            (NEW)
│   ├── SystemPromptViewModel.cs                  (NEW)
│   └── SystemPromptSelectorViewModel.cs          (NEW)
└── Extensions/
    └── ServiceCollectionExtensions.cs            (UPDATE)
```

---

## Implementation Details

### Task 1: Create SystemPromptViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/SystemPromptViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using SeniorIntern.Core.Models;

/// <summary>ViewModel for a system prompt in lists.</summary>
public partial class SystemPromptViewModel : ViewModelBase
{
    public Guid Id { get; init; }

    [ObservableProperty] private string _name = string.Empty;
    [ObservableProperty] private string _content = string.Empty;
    [ObservableProperty] private string? _description;
    [ObservableProperty] private string _category = "Custom";
    [ObservableProperty] private bool _isBuiltIn;
    [ObservableProperty] private bool _isDefault;
    [ObservableProperty] private bool _isSelected;
    [ObservableProperty] private int _usageCount;

    public int CharacterCount => Content?.Length ?? 0;
    public int EstimatedTokenCount => CharacterCount / 4;

    public string ContentPreview
    {
        get
        {
            if (string.IsNullOrWhiteSpace(Content)) return string.Empty;
            var clean = Content.Replace("\n", " ").Replace("\r", " ").Trim();
            return clean.Length > 100 ? clean[..100] + "..." : clean;
        }
    }

    public string TypeLabel => IsBuiltIn ? "Template" : "Custom";

    public string CategoryIcon => Category switch
    {
        "Code" => "CodeIcon",
        "Creative" => "PaletteIcon",
        "Technical" => "DocumentIcon",
        "General" => "ChatIcon",
        _ => "PromptIcon"
    };

    public SystemPromptViewModel() { }

    public SystemPromptViewModel(SystemPrompt prompt)
    {
        Id = prompt.Id;
        Name = prompt.Name;
        Content = prompt.Content;
        Description = prompt.Description;
        Category = prompt.Category;
        IsBuiltIn = prompt.IsBuiltIn;
        IsDefault = prompt.IsDefault;
        UsageCount = prompt.UsageCount;
    }
}
```

---

### Task 2: Create SystemPromptEditorViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/SystemPromptEditorViewModel.cs`

Key sections:

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using System.Collections.ObjectModel;

public partial class SystemPromptEditorViewModel : ViewModelBase, IDisposable
{
    private readonly ISystemPromptService _promptService;
    private readonly IDispatcher _dispatcher;
    private SystemPrompt? _originalPrompt;

    // Prompt Lists
    [ObservableProperty] private ObservableCollection<SystemPromptViewModel> _userPrompts = new();
    [ObservableProperty] private ObservableCollection<SystemPromptViewModel> _templates = new();
    [ObservableProperty] private SystemPromptViewModel? _selectedPrompt;

    // Editor State
    [ObservableProperty] private string _promptName = string.Empty;
    [ObservableProperty] private string _promptDescription = string.Empty;
    [ObservableProperty] private string _editorContent = string.Empty;
    [ObservableProperty] private bool _isDirty;
    [ObservableProperty] private bool _isEditing;
    [ObservableProperty] private bool _isNewPrompt;
    [ObservableProperty] private bool _canEdit;
    [ObservableProperty] private bool _canDelete;
    [ObservableProperty] private bool _canSetDefault;

    // UI State
    [ObservableProperty] private bool _isLoading;
    [ObservableProperty] private string? _errorMessage;
    [ObservableProperty] private string? _validationError;

    // Computed Properties
    public int CharacterCount => EditorContent?.Length ?? 0;
    public int EstimatedTokenCount => CharacterCount / 4;
    public string CharacterCountText => $"{CharacterCount:N0} characters";
    public string TokenCountText => $"~{EstimatedTokenCount:N0} tokens";
    public bool HasContent => !string.IsNullOrWhiteSpace(EditorContent);
    public bool HasValidName => !string.IsNullOrWhiteSpace(PromptName);
    public bool CanSave => HasValidName && HasContent && IsDirty && string.IsNullOrEmpty(ValidationError);

    public SystemPromptEditorViewModel(ISystemPromptService promptService, IDispatcher dispatcher)
    {
        _promptService = promptService;
        _dispatcher = dispatcher;
        _promptService.PromptListChanged += OnPromptListChanged;
    }

    // Property change handlers update computed properties and dirty state

    [RelayCommand]
    private async Task CreateNewPromptAsync()
    {
        if (IsDirty && !await ConfirmDiscardChangesAsync()) return;
        SelectedPrompt = null;
        IsNewPrompt = true; IsEditing = true; CanEdit = true;
        CanDelete = false; CanSetDefault = false;
        PromptName = "New Prompt"; EditorContent = string.Empty;
        _originalPrompt = null; IsDirty = false;
    }

    [RelayCommand(CanExecute = nameof(CanSave))]
    private async Task SavePromptAsync()
    {
        try
        {
            if (IsNewPrompt)
            {
                var prompt = await _promptService.CreatePromptAsync(PromptName.Trim(), EditorContent, 
                    string.IsNullOrWhiteSpace(PromptDescription) ? null : PromptDescription.Trim());
                await LoadPromptsAsync();
                SelectPromptById(prompt.Id);
                IsNewPrompt = false;
            }
            else if (_originalPrompt != null)
            {
                await _promptService.UpdatePromptAsync(_originalPrompt.Id, PromptName.Trim(), EditorContent,
                    string.IsNullOrWhiteSpace(PromptDescription) ? null : PromptDescription.Trim());
                _originalPrompt = await _promptService.GetByIdAsync(_originalPrompt.Id);
            }
            IsDirty = false;
        }
        catch (Exception ex) { ErrorMessage = ex.Message; }
    }

    [RelayCommand(CanExecute = nameof(CanDelete))]
    private async Task DeletePromptAsync()
    {
        if (_originalPrompt == null || _originalPrompt.IsBuiltIn) return;
        if (!await ConfirmDeleteAsync(_originalPrompt.Name)) return;
        try
        {
            await _promptService.DeletePromptAsync(_originalPrompt.Id);
            await LoadPromptsAsync();
            SelectedPrompt = UserPrompts.FirstOrDefault();
        }
        catch (Exception ex) { ErrorMessage = ex.Message; }
    }

    // Additional commands: DuplicatePromptAsync, SetAsDefaultAsync, CreateFromTemplateAsync, etc.

    private void UpdateDirtyState()
    {
        if (_originalPrompt == null && !IsNewPrompt) { IsDirty = false; return; }
        if (IsNewPrompt) { IsDirty = !string.IsNullOrWhiteSpace(PromptName) || !string.IsNullOrWhiteSpace(EditorContent); return; }
        IsDirty = PromptName != _originalPrompt!.Name || EditorContent != _originalPrompt.Content ||
                  (PromptDescription ?? "") != (_originalPrompt.Description ?? "");
    }

    public void Dispose() => _promptService.PromptListChanged -= OnPromptListChanged;
}
```

---

### Task 3: Create SystemPromptSelectorViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/SystemPromptSelectorViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using System.Collections.ObjectModel;

/// <summary>ViewModel for the quick prompt selector in chat header.</summary>
public partial class SystemPromptSelectorViewModel : ViewModelBase, IDisposable
{
    private readonly ISystemPromptService _promptService;
    private readonly IConversationService _conversationService;
    private readonly IDispatcher _dispatcher;

    [ObservableProperty] private ObservableCollection<SystemPromptViewModel> _availablePrompts = new();
    [ObservableProperty] private SystemPromptViewModel? _selectedPrompt;
    [ObservableProperty] private bool _isLoading;
    [ObservableProperty] private bool _hasPromptSelected;

    public string DisplayText => SelectedPrompt?.Name ?? "No prompt selected";

    public SystemPromptSelectorViewModel(
        ISystemPromptService promptService,
        IConversationService conversationService,
        IDispatcher dispatcher)
    {
        _promptService = promptService;
        _conversationService = conversationService;
        _dispatcher = dispatcher;

        _promptService.PromptListChanged += OnPromptListChanged;
        _promptService.CurrentPromptChanged += OnCurrentPromptChanged;
        _conversationService.ConversationChanged += OnConversationChanged;
    }

    public async Task InitializeAsync()
    {
        await LoadPromptsAsync();
        await SyncWithCurrentConversationAsync();
    }

    partial void OnSelectedPromptChanged(SystemPromptViewModel? value)
    {
        HasPromptSelected = value != null;
        OnPropertyChanged(nameof(DisplayText));
    }

    [RelayCommand]
    private async Task ApplyToConversationAsync()
    {
        if (SelectedPrompt == null) return;
        var promptId = SelectedPrompt.Id == Guid.Empty ? null : (Guid?)SelectedPrompt.Id;
        await _promptService.SetCurrentPromptAsync(promptId);
    }

    private async Task LoadPromptsAsync()
    {
        var prompts = await _promptService.GetAllPromptsAsync();
        await _dispatcher.InvokeAsync(() =>
        {
            AvailablePrompts.Clear();
            // Add "None" option
            AvailablePrompts.Add(new SystemPromptViewModel { Id = Guid.Empty, Name = "(No system prompt)", Category = "None" });
            foreach (var p in prompts) AvailablePrompts.Add(new SystemPromptViewModel(p));
        });
    }

    public void Dispose()
    {
        _promptService.PromptListChanged -= OnPromptListChanged;
        _promptService.CurrentPromptChanged -= OnCurrentPromptChanged;
        _conversationService.ConversationChanged -= OnConversationChanged;
    }
}
```

---

### Task 4: Update DI Registration

```csharp
services.AddTransient<SystemPromptEditorViewModel>();
services.AddSingleton<SystemPromptSelectorViewModel>();
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| SystemPromptViewModel | 4 | Constructor mapping, ContentPreview |
| SystemPromptEditorViewModel | 12 | Dirty tracking, CanSave, commands |
| SystemPromptSelectorViewModel | 4 | Selection sync, DisplayText |
| **Total** | **20** | |

### Key Test Scenarios

```csharp
[Fact]
public void ContentPreview_TruncatesLongContent()
{
    var vm = new SystemPromptViewModel { Content = new string('a', 200) };
    Assert.Equal(103, vm.ContentPreview.Length); // 100 + "..."
    Assert.EndsWith("...", vm.ContentPreview);
}

[Fact]
public void CanSave_RequiresNameAndContentAndDirty()
{
    var vm = CreateEditorViewModel();
    vm.PromptName = "Test";
    vm.EditorContent = "Content";
    vm.IsDirty = false;
    Assert.False(vm.CanSave);

    vm.IsDirty = true;
    Assert.True(vm.CanSave);
}

[Fact]
public void UpdateDirtyState_DetectsChanges()
{
    var vm = CreateEditorViewModel();
    vm.SelectPrompt(existingPrompt);
    Assert.False(vm.IsDirty);

    vm.EditorContent = "Modified content";
    Assert.True(vm.IsDirty);
}

[Fact]
public void CreateNewPromptAsync_ClearsEditor()
{
    var vm = CreateEditorViewModel();
    await vm.CreateNewPromptCommand.ExecuteAsync(null);

    Assert.True(vm.IsNewPrompt);
    Assert.True(vm.IsEditing);
    Assert.Equal("New Prompt", vm.PromptName);
    Assert.Empty(vm.EditorContent);
}
```

---

## Files Summary

### Files to Create (3)

| File | Lines (approx) |
|------|----------------|
| `ViewModels/SystemPromptViewModel.cs` | 60 |
| `ViewModels/SystemPromptEditorViewModel.cs` | 320 |
| `ViewModels/SystemPromptSelectorViewModel.cs` | 100 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Extensions/ServiceCollectionExtensions.cs` | Add ViewModel registrations |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | UserPrompts shows only custom prompts |
| AC-2 | Templates shows only built-in prompts |
| AC-3 | CanEdit=false for built-in prompts |
| AC-4 | IsDirty tracks changes correctly |
| AC-5 | CanSave=true only when valid and dirty |
| AC-6 | CharacterCount/TokenCount update on content change |
| AC-7 | CreateNewPromptAsync initializes empty editor |
| AC-8 | SavePromptAsync creates or updates correctly |
| AC-9 | Selector includes "No prompt" option |
| AC-10 | Event handlers refresh on service changes |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Separate UserPrompts/Templates lists | Cleaner UI grouping |
| _originalPrompt for dirty tracking | Simple comparison without service calls |
| CanExecute on commands | Disable buttons when invalid |
| ContentPreview 100 chars | Balance info vs. space |
| Selector includes "None" option | Allow disabling system prompt |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.4c | 1 day |
