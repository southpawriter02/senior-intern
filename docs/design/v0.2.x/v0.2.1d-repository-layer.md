# Design Specification: The Senior Intern v0.2.1d "Repository Layer"

## Executive Summary

This document provides a detailed implementation specification for v0.2.1d, which creates the repository pattern implementation for data access. Repositories abstract EF Core operations and provide a clean API for the service layer.

### v0.2.1d Scope

- Create repository interfaces defining data access contracts
- Implement repository classes with EF Core operations
- Add specialized query methods (search, filter, pagination)
- Provide logging for data operations
- Prepare for dependency injection registration (v0.2.1e)

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| IConversationRepository | Interface with 17 methods for conversations and messages |
| ConversationRepository | EF Core implementation with logging |
| ISystemPromptRepository | Interface with 13 methods for system prompts |
| SystemPromptRepository | EF Core implementation with soft/hard delete |
| IInferencePresetRepository | Interface with 11 methods for presets |
| InferencePresetRepository | EF Core implementation with duplication |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.1d Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Repository Layer                                                 │
│  ├── IConversationRepository + Implementation                     │
│  │   ├── Read: GetById, GetByIdWithMessages, GetRecent, Search    │
│  │   ├── Write: Create, Update, Delete                            │
│  │   ├── Flags: Archive, Unarchive, Pin, Unpin                    │
│  │   └── Messages: Add, Update, Get, GetCount, Delete             │
│  │                                                                │
│  ├── ISystemPromptRepository + Implementation                     │
│  │   ├── Read: GetById, GetDefault, GetAllActive, GetByCategory   │
│  │   ├── Read: GetCategories, Search, NameExists                  │
│  │   ├── Write: Create, Update, Delete (soft), HardDelete         │
│  │   └── Actions: SetAsDefault, IncrementUsageCount, Restore      │
│  │                                                                │
│  └── IInferencePresetRepository + Implementation                  │
│      ├── Read: GetById, GetDefault, GetAll, GetBuiltIn            │
│      ├── Read: GetUserCreated, NameExists                         │
│      └── Write: Create, Update, Delete, SetAsDefault, Duplicate   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Repository Pattern

```
┌─────────────────────────────────────────────────────────────────┐
│                    SeniorIntern.Services                         │
│                    (Application Layer)                           │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │
│  │ConversationSvc│  │SystemPromptSvc│  │ InferenceSvc  │        │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘        │
│          │                  │                  │                 │
└──────────┼──────────────────┼──────────────────┼─────────────────┘
           │ Uses             │ Uses             │ Uses
           ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    SeniorIntern.Data                             │
│                    (Data Access Layer)                           │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │
│  │IConversation  │  │ISystemPrompt  │  │IInferencePreset│       │
│  │  Repository   │  │  Repository   │  │  Repository   │        │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘        │
│          │                  │                  │                 │
│  ┌───────▼───────┐  ┌───────▼───────┐  ┌───────▼───────┐        │
│  │Conversation   │  │SystemPrompt   │  │InferencePreset│        │
│  │  Repository   │  │  Repository   │  │  Repository   │        │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘        │
│          │                  │                  │                 │
│          └──────────────────┼──────────────────┘                 │
│                             │                                    │
│                    ┌────────▼────────┐                           │
│                    │SeniorInternDb   │                           │
│                    │    Context      │                           │
│                    └─────────────────┘                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## Prerequisites

Before implementing v0.2.1d, ensure:
- v0.2.1a is complete (Data project exists)
- v0.2.1b is complete (Entity classes defined)
- v0.2.1c is complete (DbContext and configurations)
- Solution builds successfully

---

## Directory Structure

After v0.2.1d implementation:

```
src/SeniorIntern.Data/
├── SeniorIntern.Data.csproj
├── DatabasePathResolver.cs
├── SeniorInternDbContext.cs
├── Configurations/
│   ├── ConversationConfiguration.cs
│   ├── MessageConfiguration.cs
│   ├── SystemPromptConfiguration.cs
│   └── InferencePresetConfiguration.cs
└── Repositories/
    ├── IConversationRepository.cs      (NEW)
    ├── ConversationRepository.cs       (NEW)
    ├── ISystemPromptRepository.cs      (NEW)
    ├── SystemPromptRepository.cs       (NEW)
    ├── IInferencePresetRepository.cs   (NEW)
    └── InferencePresetRepository.cs    (NEW)
```

---

## Design Principles

### Repository Pattern Benefits

| Benefit | Description |
|---------|-------------|
| Abstraction | Hides EF Core implementation details from services |
| Testability | Interfaces enable mocking in unit tests |
| Single Responsibility | Each repository handles one entity type |
| Consistency | Standardized API across all data access |
| Logging | Centralized logging for all database operations |

### Naming Conventions

| Pattern | Example | Purpose |
|---------|---------|---------| 
| `GetByIdAsync` | `GetByIdAsync(Guid id)` | Single entity by primary key |
| `GetAllAsync` | `GetAllAsync()` | All entities (with optional filters) |
| `GetXxxAsync` | `GetRecentAsync()` | Specialized query methods |
| `CreateAsync` | `CreateAsync(entity)` | Insert new entity |
| `UpdateAsync` | `UpdateAsync(entity)` | Update existing entity |
| `DeleteAsync` | `DeleteAsync(id)` | Remove entity |
| `XxxExistsAsync` | `NameExistsAsync(name)` | Existence checks |

---

## Implementation Details

### Task 1: IConversationRepository Interface

**File:** `src/SeniorIntern.Data/Repositories/IConversationRepository.cs`

Defines conversation and message data access operations with 17 methods:
- **Read:** GetByIdAsync, GetByIdWithMessagesAsync, GetRecentAsync, SearchAsync, ExistsAsync
- **Write:** CreateAsync, UpdateAsync, DeleteAsync
- **Flags:** ArchiveAsync, UnarchiveAsync, PinAsync, UnpinAsync
- **Messages:** AddMessageAsync, UpdateMessageAsync, GetMessagesAsync, GetMessageCountAsync, DeleteMessageAsync

See **Appendix A** for full interface definition.

---

### Task 2: ConversationRepository Implementation

**File:** `src/SeniorIntern.Data/Repositories/ConversationRepository.cs`

Key implementation patterns:
- Constructor injection of DbContext and ILogger
- Debug logging for all operations
- ExecuteUpdateAsync for efficient flag updates
- Automatic sequence number assignment for messages
- Atomic MessageCount/TotalTokenCount updates

See **Appendix B** for full implementation.

---

### Task 3: ISystemPromptRepository Interface

**File:** `src/SeniorIntern.Data/Repositories/ISystemPromptRepository.cs`

Defines system prompt operations with 13 methods:
- **Read:** GetByIdAsync, GetDefaultAsync, GetAllActiveAsync, GetByCategoryAsync, GetCategoriesAsync, SearchAsync, NameExistsAsync
- **Write:** CreateAsync, UpdateAsync, DeleteAsync (soft), HardDeleteAsync
- **Actions:** SetAsDefaultAsync, IncrementUsageCountAsync, RestoreAsync

See **Appendix C** for full interface definition.

---

### Task 4: SystemPromptRepository Implementation

**File:** `src/SeniorIntern.Data/Repositories/SystemPromptRepository.cs`

Key implementation patterns:
- Soft delete via IsActive flag
- Hard delete protection for built-in prompts
- Atomic default switching (clear old, set new)
- Category filtering and distinct queries

See **Appendix D** for full implementation.

---

### Task 5: IInferencePresetRepository Interface

**File:** `src/SeniorIntern.Data/Repositories/IInferencePresetRepository.cs`

Defines inference preset operations with 11 methods:
- **Read:** GetByIdAsync, GetDefaultAsync, GetAllAsync, GetBuiltInAsync, GetUserCreatedAsync, NameExistsAsync
- **Write:** CreateAsync, UpdateAsync, DeleteAsync, SetAsDefaultAsync, DuplicateAsync

See **Appendix E** for full interface definition.

---

### Task 6: InferencePresetRepository Implementation

**File:** `src/SeniorIntern.Data/Repositories/InferencePresetRepository.cs`

Key implementation patterns:
- Protect built-in presets from deletion
- Automatic default reassignment on delete
- Preset duplication with property copying
- Built-in vs user-created filtering

See **Appendix F** for full implementation.

---

## Repository Method Summary

### IConversationRepository (17 methods)

| Method | Returns | Description |
|--------|---------|-------------|
| `GetByIdAsync` | `ConversationEntity?` | Get by ID (no messages) |
| `GetByIdWithMessagesAsync` | `ConversationEntity?` | Get by ID with all messages |
| `GetRecentAsync` | `IReadOnlyList<ConversationEntity>` | Recent conversations for sidebar |
| `SearchAsync` | `IReadOnlyList<ConversationEntity>` | Search by title |
| `ExistsAsync` | `bool` | Check if exists |
| `CreateAsync` | `ConversationEntity` | Create new conversation |
| `UpdateAsync` | `void` | Update conversation |
| `DeleteAsync` | `void` | Hard delete with messages |
| `ArchiveAsync` | `void` | Set IsArchived = true |
| `UnarchiveAsync` | `void` | Set IsArchived = false |
| `PinAsync` | `void` | Set IsPinned = true |
| `UnpinAsync` | `void` | Set IsPinned = false |
| `AddMessageAsync` | `void` | Add message to conversation |
| `UpdateMessageAsync` | `void` | Update existing message |
| `GetMessagesAsync` | `IReadOnlyList<MessageEntity>` | Paginated messages |
| `GetMessageCountAsync` | `int` | Count messages |
| `DeleteMessageAsync` | `void` | Delete single message |

### ISystemPromptRepository (13 methods)

| Method | Returns | Description |
|--------|---------|-------------|
| `GetByIdAsync` | `SystemPromptEntity?` | Get by ID |
| `GetDefaultAsync` | `SystemPromptEntity?` | Get default prompt |
| `GetAllActiveAsync` | `IReadOnlyList<SystemPromptEntity>` | All active prompts |
| `GetByCategoryAsync` | `IReadOnlyList<SystemPromptEntity>` | Filter by category |
| `GetCategoriesAsync` | `IReadOnlyList<string>` | Distinct categories |
| `SearchAsync` | `IReadOnlyList<SystemPromptEntity>` | Search name/content |
| `NameExistsAsync` | `bool` | Check name uniqueness |
| `CreateAsync` | `SystemPromptEntity` | Create new prompt |
| `UpdateAsync` | `void` | Update prompt |
| `DeleteAsync` | `void` | Soft delete (IsActive = false) |
| `HardDeleteAsync` | `void` | Permanent delete (non-built-in) |
| `SetAsDefaultAsync` | `void` | Set as default prompt |
| `IncrementUsageCountAsync` | `void` | Increment usage counter |
| `RestoreAsync` | `void` | Restore soft-deleted |

### IInferencePresetRepository (11 methods)

| Method | Returns | Description |
|--------|---------|-------------|
| `GetByIdAsync` | `InferencePresetEntity?` | Get by ID |
| `GetDefaultAsync` | `InferencePresetEntity?` | Get default preset |
| `GetAllAsync` | `IReadOnlyList<InferencePresetEntity>` | All presets |
| `GetBuiltInAsync` | `IReadOnlyList<InferencePresetEntity>` | Built-in only |
| `GetUserCreatedAsync` | `IReadOnlyList<InferencePresetEntity>` | User-created only |
| `NameExistsAsync` | `bool` | Check name uniqueness |
| `CreateAsync` | `InferencePresetEntity` | Create new preset |
| `UpdateAsync` | `void` | Update preset |
| `DeleteAsync` | `void` | Delete (non-built-in only) |
| `SetAsDefaultAsync` | `void` | Set as default preset |
| `DuplicateAsync` | `InferencePresetEntity?` | Copy existing preset |

---

## Logging Specifications

### Log Levels by Operation

| Level | Operations |
|-------|------------|
| Debug | Get, Create, Update, Delete, Archive, Pin, AddMessage |
| Warning | Hard-delete built-in entities (protection triggered) |
| Error | Not used (exceptions propagate to caller) |

### Structured Logging Properties

| Property | Type | Description |
|----------|------|-------------|
| `ConversationId` | Guid | Conversation identifier |
| `MessageId` | Guid | Message identifier |
| `PromptId` | Guid | System prompt identifier |
| `PresetId` | Guid | Inference preset identifier |
| `Title` | string | Entity display name |
| `Name` | string | Entity name |
| `Query` | string | Search query text |
| `Count` | int | Requested count |
| `Skip` / `Take` | int | Pagination parameters |

### Logging Examples

```csharp
// Debug - Normal operations
_logger.LogDebug("Getting conversation {ConversationId}", id);
_logger.LogDebug("Created conversation {ConversationId}: {Title}", id, title);
_logger.LogDebug("Archived conversation {ConversationId}", id);

// Warning - Protected operations
_logger.LogWarning("Cannot hard-delete built-in system prompt {PromptId}: {Name}", id, name);
```

---

## Unit Testing Requirements

### Test Summary

| Repository | Test Count | Focus Areas |
|------------|------------|-------------|
| ConversationRepository | 12 | CRUD, archive/pin, messages, search |
| SystemPromptRepository | 8 | CRUD, soft/hard delete, categories |
| InferencePresetRepository | 6 | CRUD, duplication, default handling |
| **Total** | **26** | |

### Key Test Scenarios

```csharp
[Fact]
public async Task CreateAsync_GeneratesId_WhenIdIsEmpty()
{
    var conversation = new ConversationEntity { Title = "Test" };
    var result = await _repository.CreateAsync(conversation);
    Assert.NotEqual(Guid.Empty, result.Id);
}

[Fact]
public async Task GetRecentAsync_ReturnsNonArchivedByDefault()
{
    await _repository.CreateAsync(new ConversationEntity { Title = "Active" });
    var archived = await _repository.CreateAsync(new ConversationEntity { Title = "Archived" });
    await _repository.ArchiveAsync(archived.Id);
    
    var result = await _repository.GetRecentAsync();
    
    Assert.Single(result);
    Assert.Equal("Active", result[0].Title);
}

[Fact]
public async Task AddMessageAsync_IncrementsMessageCount()
{
    var conversation = await _repository.CreateAsync(new ConversationEntity());
    var message = new MessageEntity { Role = MessageRole.User, Content = "Hello" };
    
    await _repository.AddMessageAsync(conversation.Id, message);
    
    var loaded = await _repository.GetByIdAsync(conversation.Id);
    Assert.Equal(1, loaded!.MessageCount);
}

[Fact]
public async Task HardDeleteAsync_FailsForBuiltInPrompts()
{
    var prompt = await _promptRepository.CreateAsync(new SystemPromptEntity 
    { 
        Name = "Built-In", 
        IsBuiltIn = true 
    });
    
    await _promptRepository.HardDeleteAsync(prompt.Id);
    
    var stillExists = await _promptRepository.GetByIdAsync(prompt.Id);
    Assert.NotNull(stillExists);
}

[Fact]
public async Task DuplicateAsync_CreatesUserOwnedCopy()
{
    var original = await _presetRepository.CreateAsync(new InferencePresetEntity 
    { 
        Name = "Original", 
        IsBuiltIn = true 
    });
    
    var copy = await _presetRepository.DuplicateAsync(original.Id, "Copy");
    
    Assert.NotNull(copy);
    Assert.False(copy.IsBuiltIn);
    Assert.Equal(original.Temperature, copy.Temperature);
}
```

---

## Use Cases

### UC-001: Load Recent Conversations for Sidebar

| Attribute | Value |
|-----------|-------|
| **Actor** | ConversationService |
| **Trigger** | Application startup or sidebar refresh |
| **Success Scenario** | Returns up to 50 non-archived conversations, pinned first |
| **Postcondition** | Conversation list displayed in sidebar |

### UC-002: Add Message to Conversation

| Attribute | Value |
|-----------|-------|
| **Actor** | ConversationService |
| **Trigger** | User sends message or assistant generates response |
| **Success Scenario** | Message added with auto sequence number, counts updated |
| **Postcondition** | Message persisted, conversation.MessageCount incremented |

### UC-003: Duplicate Inference Preset

| Attribute | Value |
|-----------|-------|
| **Actor** | SettingsService |
| **Trigger** | User clicks "Duplicate" on a preset |
| **Success Scenario** | Creates copy with IsBuiltIn=false |
| **Postcondition** | New preset available in list |

---

## Deliverable Checklist

### Data Layer (SeniorIntern.Data)
- [x] Repositories/IConversationRepository.cs
- [x] Repositories/ConversationRepository.cs
- [x] Repositories/ISystemPromptRepository.cs
- [x] Repositories/SystemPromptRepository.cs
- [x] Repositories/IInferencePresetRepository.cs
- [x] Repositories/InferencePresetRepository.cs

### Tests
- [ ] SeniorIntern.Data.Tests - Repository unit tests

---

## Files Summary

### Files to Create (6)

| File | Purpose | Lines (approx) |
|------|---------|----------------|
| `Repositories/IConversationRepository.cs` | Conversation interface | 120 |
| `Repositories/ConversationRepository.cs` | Conversation implementation | 280 |
| `Repositories/ISystemPromptRepository.cs` | System prompt interface | 90 |
| `Repositories/SystemPromptRepository.cs` | System prompt implementation | 200 |
| `Repositories/IInferencePresetRepository.cs` | Inference preset interface | 80 |
| `Repositories/InferencePresetRepository.cs` | Inference preset implementation | 180 |

### Directories to Create

| Directory | Purpose |
|-----------|---------|
| `src/SeniorIntern.Data/Repositories/` | Repository classes |

---

## Verification Steps

### Step 1: Verify Compilation

```bash
dotnet build src/SeniorIntern.Data
```

### Step 2: Verify Interface/Implementation Alignment

```bash
dotnet build src/SeniorIntern.Data --warnaserror
```

### Step 3: Run Unit Tests

```bash
dotnet test tests/SeniorIntern.Data.Tests
```

---

## Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | All interfaces compile | `dotnet build` succeeds |
| AC-2 | All implementations compile | No compilation errors |
| AC-3 | Interfaces match implementations | All methods implemented |
| AC-4 | Null checks present | ArgumentNullException on null entities |
| AC-5 | Logging implemented | Debug logs for all operations |
| AC-6 | Async throughout | All methods return Task |
| AC-7 | CancellationToken support | All methods accept ct parameter |
| AC-8 | GUID generation works | Empty GUIDs get generated values |
| AC-9 | Bulk updates work | ExecuteUpdateAsync used correctly |
| AC-10 | Cascade logic correct | MessageCount updates on add/delete |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Interface/impl mismatch | Low | Medium | Compile after each interface change |
| ExecuteUpdateAsync bypasses SaveChanges | Low | Medium | Document behavior, test separately |
| Concurrent sequence number conflicts | Low | Low | Unique constraint catches at DB level |
| MessageCount drift from actual count | Low | Medium | Atomic updates; periodic reconciliation if needed |

---

## Design Decisions

### Decision 1: No Generic Repository

**Decision:** Create specific repositories per entity rather than a generic `IRepository<T>`.
**Rationale:** Entity-specific methods (Archive, Pin, AddMessage) don't fit generic pattern. Clearer API for consumers.

### Decision 2: IReadOnlyList Return Types

**Decision:** Return `IReadOnlyList<T>` instead of `IEnumerable<T>` or `List<T>`.
**Rationale:** Signals materialized collection, prevents modification, allows indexing.

### Decision 3: ExecuteUpdateAsync for Bulk Operations

**Decision:** Use `ExecuteUpdateAsync` for flag updates (archive, pin, default).
**Rationale:** Single database roundtrip, no need to load entity first.

### Decision 4: Message Operations in ConversationRepository

**Decision:** Include message operations in `IConversationRepository` rather than separate `IMessageRepository`.
**Rationale:** Messages always accessed in context of conversation. Allows atomic metadata updates.

### Decision 5: Soft Delete for System Prompts

**Decision:** Use soft delete (IsActive = false) with optional hard delete.
**Rationale:** Preserves referential integrity, allows recovery, protects built-in prompts.

---

## Error Handling

### Expected Exceptions

| Exception | When | Handling |
|-----------|------|----------|
| `ArgumentNullException` | Null entity passed to Create/Update | Thrown immediately |
| `DbUpdateException` | Constraint violation | Let propagate (caller handles) |
| `OperationCanceledException` | Cancellation requested | Let propagate |

### Silent Failures (by design)

| Operation | Behavior | Rationale |
|-----------|----------|-----------|
| Delete non-existent entity | No-op, logged at Debug | Idempotent operation |
| Hard delete built-in | No-op, logged at Warning | Protect system data |
| Archive/Pin non-existent | No-op (0 rows affected) | Idempotent operation |

---

## Future Considerations

| Item | Target Version | Rationale |
|------|----------------|-----------|
| Unit of Work pattern | v0.3.0+ | Complex transactions spanning repositories |
| Query specifications | v0.3.0+ | Reusable query building |
| Caching layer | v0.4.0+ | Performance optimization |

---

## Timeline Estimate

| Version | Estimated Effort | Key Deliverables |
|---------|------------------|------------------|
| v0.2.1d | 1-2 days | 6 repository files, full CRUD for 3 entities |

---

## Next Steps

After completing v0.2.1d, proceed to:

**v0.2.1e: Initialization & Seeding**
- Create `DatabaseInitializer` for migration and seeding
- Create `DataServiceCollectionExtensions` for DI registration
- Seed default system prompts and inference presets
- Integrate with application startup

---

## References

- [Repository Pattern in .NET](https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design)
- [EF Core ExecuteUpdate](https://learn.microsoft.com/en-us/ef/core/saving/execute-insert-update-delete)
- [IReadOnlyList vs IEnumerable](https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.ireadonlylist-1)

