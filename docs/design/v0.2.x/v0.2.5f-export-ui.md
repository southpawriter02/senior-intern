# Design Specification: The Senior Intern v0.2.5f "Export UI"

## Executive Summary

This document provides a detailed implementation specification for v0.2.5f, which creates the export dialog UI with format selection, configurable options, and live preview. The `ExportDialog` allows users to choose export format, toggle options, preview the output, and save to their file system.

### v0.2.5f Scope (from v0.2.5 Design Document)

- Create `ExportViewModel` with format and option bindings
- Create `ExportDialog.axaml` with radio buttons and checkboxes
- Live preview that updates when options change
- File save dialog integration with IStorageProvider
- Add EnumBoolConverter for radio button bindings
- Integration with MainWindow (Ctrl+E)

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ExportViewModel | ViewModel with options and preview |
| ExportDialog | Export dialog window |
| EnumBoolConverter | Converter for format radio buttons |
| File Save Integration | IStorageProvider file picker |
| MainWindow Command | Ctrl+E shortcut |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.5f Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ExportViewModel                                                  │
│  ├── Properties                                                   │
│  │   ├── SelectedFormat (ExportFormat) = Markdown                │
│  │   ├── IncludeTimestamps (bool) = true                          │
│  │   ├── IncludeSystemPrompt (bool) = true                        │
│  │   ├── IncludeTokenCounts (bool) = false                        │
│  │   ├── Preview (string) - live preview, max 500 chars          │
│  │   ├── IsExporting (bool) - disable during export              │
│  │   └── ErrorMessage (string?) - shown in red                   │
│  │                                                                │
│  ├── Commands                                                     │
│  │   ├── ExportCommand → save file dialog → write file           │
│  │   └── CancelCommand → fires CloseRequested                    │
│  │                                                                │
│  ├── Events                                                       │
│  │   └── CloseRequested()                                         │
│  │                                                                │
│  └── Methods                                                      │
│      ├── InitializeAsync() - load initial preview                │
│      ├── UpdatePreviewAsync() - called on option change          │
│      ├── CreateOptions() → ExportOptions                          │
│      └── GetFormatName(format) → "Markdown", "JSON", etc.        │
│                                                                   │
│  ExportDialog (550x500)                                           │
│  ├── Format Section                                               │
│  │   ├── ○ Markdown (.md)                                        │
│  │   ├── ○ JSON (.json)                                          │
│  │   ├── ○ Plain Text (.txt)                                     │
│  │   └── ○ HTML (.html)                                          │
│  │                                                                │
│  ├── Options Section                                              │
│  │   ├── ☑ Include timestamps                                    │
│  │   ├── ☑ Include system prompt                                 │
│  │   └── ☐ Include token counts                                  │
│  │                                                                │
│  ├── Preview Section                                              │
│  │   └── [Monospace preview of output, scrollable]               │
│  │                                                                │
│  └── Action Buttons                                               │
│      ├── [Cancel]                                                 │
│      └── [Export] (accent button)                                │
│                                                                   │
│  EnumBoolConverter                                                │
│  └── Converts enum value ↔ bool for RadioButton IsChecked         │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Export Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Export Flow                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User opens ExportDialog (Ctrl+E)                                │
│              │                                                   │
│              ▼                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ExportViewModel.InitializeAsync()                         │    │
│  │   → UpdatePreviewAsync() with default options             │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴──────────────────────────────┐    │
│  │                     User Interaction                      │    │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐     │    │
│  │  │ Change      │   │ Toggle      │   │ Toggle      │     │    │
│  │  │ Format      │   │ Timestamps  │   │ System      │     │    │
│  │  └──────┬──────┘   └──────┬──────┘   │ Prompt      │     │    │
│  │         │                 │          └──────┬──────┘     │    │
│  │         └────────────────┬┴─────────────────┘            │    │
│  │                          │                               │    │
│  │                          ▼                               │    │
│  │  OnPropertyChanged → UpdatePreviewAsync()               │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│  User clicks [Export]        │                                   │
│              │               │                                   │
│              ▼               │                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │ ExportViewModel.ExportAsync()                             │    │
│  │   1. IsExporting = true                                   │    │
│  │   2. Call IExportService.ExportAsync()                    │    │
│  │   3. Show SaveFilePickerAsync()                           │    │
│  │   4. Write content to file                                │    │
│  │   5. Fire CloseRequested                                  │    │
│  └───────────────────────────┬──────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│                   [Dialog closes, file saved]                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Dialog Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                   ExportDialog Layout (550x500)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Export Conversation                                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Format                                                          │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ◉ Markdown (.md)                                           │  │
│  │  ○ JSON (.json)                                             │  │
│  │  ○ Plain Text (.txt)                                        │  │
│  │  ○ HTML (.html)                                             │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Options                                                         │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ☑ Include timestamps                                       │  │
│  │  ☑ Include system prompt                                    │  │
│  │  ☐ Include token counts                                     │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Preview                                                         │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ # Database Discussion                                       │  │
│  │                                                             │  │
│  │ **Created:** 2026-01-10 14:30                               │  │
│  │                                                             │  │
│  │ **User** (14:30):                                           │  │
│  │ How do I set up a database?                                 │  │
│  │                                                             │  │
│  │ ... (truncated)                                             │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│                                       [Cancel]    [Export]       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
├── ViewModels/
│   └── ExportViewModel.cs                            (NEW)
├── Views/
│   ├── ExportDialog.axaml                            (NEW)
│   └── ExportDialog.axaml.cs                         (NEW)
├── Converters/
│   └── EnumBoolConverter.cs                          (NEW)
└── ViewModels/
    └── MainWindowViewModel.cs                        (UPDATE - Ctrl+E)
```

---

## Implementation Details

### Task 1: Create EnumBoolConverter

**File:** `src/SeniorIntern.Desktop/Converters/EnumBoolConverter.cs`

```csharp
namespace SeniorIntern.Desktop.Converters;

using Avalonia.Data.Converters;
using System.Globalization;

/// <summary>
/// Converts between enum values and bool for RadioButton bindings.
/// Usage: IsChecked="{Binding EnumProp, Converter={StaticResource EnumBoolConverter}, ConverterParameter=EnumValue}"
/// </summary>
public sealed class EnumBoolConverter : IValueConverter
{
    public static readonly EnumBoolConverter Instance = new();

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is null || parameter is null)
            return false;

        var enumValue = value.ToString();
        var targetValue = parameter.ToString();

        return string.Equals(enumValue, targetValue, StringComparison.OrdinalIgnoreCase);
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is not bool isChecked || !isChecked || parameter is null)
            return Avalonia.Data.BindingOperations.DoNothing;

        return Enum.Parse(targetType, parameter.ToString()!);
    }
}
```

---

### Task 2: Create ExportViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/ExportViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using Avalonia.Platform.Storage;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;

public partial class ExportViewModel : ViewModelBase
{
    private readonly IExportService _exportService;
    private readonly IStorageProvider _storageProvider;
    private readonly Guid _conversationId;

    [ObservableProperty] private ExportFormat _selectedFormat = ExportFormat.Markdown;
    [ObservableProperty] private bool _includeTimestamps = true;
    [ObservableProperty] private bool _includeSystemPrompt = true;
    [ObservableProperty] private bool _includeTokenCounts;
    [ObservableProperty] private bool _includeMetadata = true;
    [ObservableProperty] private string _preview = string.Empty;
    [ObservableProperty] private bool _isExporting;
    [ObservableProperty] private string? _errorMessage;

    public event EventHandler? CloseRequested;

    public ExportViewModel(
        IExportService exportService,
        IStorageProvider storageProvider,
        Guid conversationId)
    {
        _exportService = exportService;
        _storageProvider = storageProvider;
        _conversationId = conversationId;
    }

    public async Task InitializeAsync() => await UpdatePreviewAsync();

    // Property change handlers trigger preview update
    partial void OnSelectedFormatChanged(ExportFormat value) => _ = UpdatePreviewAsync();
    partial void OnIncludeTimestampsChanged(bool value) => _ = UpdatePreviewAsync();
    partial void OnIncludeSystemPromptChanged(bool value) => _ = UpdatePreviewAsync();
    partial void OnIncludeTokenCountsChanged(bool value) => _ = UpdatePreviewAsync();
    partial void OnIncludeMetadataChanged(bool value) => _ = UpdatePreviewAsync();

    private async Task UpdatePreviewAsync()
    {
        try
        {
            Preview = await _exportService.GeneratePreviewAsync(
                _conversationId, CreateOptions(), maxLength: 500);
        }
        catch (Exception ex)
        {
            Preview = $"Error generating preview: {ex.Message}";
        }
    }

    [RelayCommand]
    private async Task ExportAsync()
    {
        try
        {
            IsExporting = true;
            ErrorMessage = null;

            var result = await _exportService.ExportAsync(_conversationId, CreateOptions());

            if (!result.Success)
            {
                ErrorMessage = result.ErrorMessage;
                return;
            }

            var file = await _storageProvider.SaveFilePickerAsync(new FilePickerSaveOptions
            {
                Title = "Export Conversation",
                SuggestedFileName = result.SuggestedFileName,
                FileTypeChoices = new[]
                {
                    new FilePickerFileType(GetFormatName(SelectedFormat))
                    {
                        Patterns = [$"*{_exportService.GetFileExtension(SelectedFormat)}"],
                        MimeTypes = [result.MimeType]
                    }
                }
            });

            if (file is null) return;

            await using var stream = await file.OpenWriteAsync();
            await using var writer = new StreamWriter(stream);
            await writer.WriteAsync(result.Content);

            CloseRequested?.Invoke(this, EventArgs.Empty);
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsExporting = false;
        }
    }

    [RelayCommand]
    private void Cancel() => CloseRequested?.Invoke(this, EventArgs.Empty);

    private ExportOptions CreateOptions() => new()
    {
        Format = SelectedFormat,
        IncludeTimestamps = IncludeTimestamps,
        IncludeSystemPrompt = IncludeSystemPrompt,
        IncludeTokenCounts = IncludeTokenCounts,
        IncludeMetadata = IncludeMetadata
    };

    private static string GetFormatName(ExportFormat format) => format switch
    {
        ExportFormat.Markdown => "Markdown",
        ExportFormat.Json => "JSON",
        ExportFormat.PlainText => "Plain Text",
        ExportFormat.Html => "HTML",
        _ => "File"
    };
}
```

---

### Task 3: Create ExportDialog.axaml

**File:** `src/SeniorIntern.Desktop/Views/ExportDialog.axaml`

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
        xmlns:conv="using:SeniorIntern.Desktop.Converters"
        x:Class="SeniorIntern.Desktop.Views.ExportDialog"
        x:DataType="vm:ExportViewModel"
        Title="Export Conversation"
        Width="550" Height="500"
        WindowStartupLocation="CenterOwner"
        CanResize="False">

    <Window.Resources>
        <conv:EnumBoolConverter x:Key="EnumBoolConverter" />
    </Window.Resources>

    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding CancelCommand}" />
    </Window.KeyBindings>

    <Grid RowDefinitions="*,Auto" Margin="20">
        <ScrollViewer Grid.Row="0">
            <StackPanel Spacing="20">
                <!-- Format Selection -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Format" FontWeight="SemiBold" />
                    <StackPanel Spacing="4">
                        <RadioButton Content="Markdown (.md)" GroupName="Format"
                            IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Markdown}" />
                        <RadioButton Content="JSON (.json)" GroupName="Format"
                            IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Json}" />
                        <RadioButton Content="Plain Text (.txt)" GroupName="Format"
                            IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=PlainText}" />
                        <RadioButton Content="HTML (.html)" GroupName="Format"
                            IsChecked="{Binding SelectedFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Html}" />
                    </StackPanel>
                </StackPanel>

                <!-- Options -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Options" FontWeight="SemiBold" />
                    <CheckBox Content="Include timestamps" IsChecked="{Binding IncludeTimestamps}" />
                    <CheckBox Content="Include system prompt" IsChecked="{Binding IncludeSystemPrompt}" />
                    <CheckBox Content="Include metadata" IsChecked="{Binding IncludeMetadata}" />
                    <CheckBox Content="Include token counts" IsChecked="{Binding IncludeTokenCounts}" />
                </StackPanel>

                <!-- Preview -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Preview" FontWeight="SemiBold" />
                    <Border Background="{DynamicResource SidebarBackgroundColor}"
                            BorderBrush="{DynamicResource BorderColor}"
                            BorderThickness="1" CornerRadius="4"
                            Padding="12" MinHeight="150" MaxHeight="200">
                        <ScrollViewer>
                            <TextBlock Text="{Binding Preview}"
                                       FontFamily="Consolas, Menlo, monospace"
                                       FontSize="12" TextWrapping="Wrap" />
                        </ScrollViewer>
                    </Border>
                </StackPanel>

                <!-- Error Message -->
                <TextBlock Text="{Binding ErrorMessage}"
                           Foreground="{DynamicResource ErrorColor}"
                           IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                           TextWrapping="Wrap" />
            </StackPanel>
        </ScrollViewer>

        <!-- Buttons -->
        <StackPanel Grid.Row="1" Orientation="Horizontal"
                    HorizontalAlignment="Right" Spacing="12" Margin="0,20,0,0">
            <Button Content="Cancel" Command="{Binding CancelCommand}" MinWidth="80" />
            <Button Content="Export" Command="{Binding ExportCommand}"
                    IsEnabled="{Binding !IsExporting}" Classes="accent" MinWidth="80" />
        </StackPanel>
    </Grid>
</Window>
```

---

### Task 4: Create ExportDialog.axaml.cs

**File:** `src/SeniorIntern.Desktop/Views/ExportDialog.axaml.cs`

```csharp
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;
using SeniorIntern.Desktop.ViewModels;

public partial class ExportDialog : Window
{
    public ExportDialog()
    {
        InitializeComponent();
    }

    public ExportDialog(ExportViewModel viewModel) : this()
    {
        DataContext = viewModel;
        viewModel.CloseRequested += (s, e) => Close();
    }

    protected override async void OnOpened(EventArgs e)
    {
        base.OnOpened(e);
        if (DataContext is ExportViewModel vm)
            await vm.InitializeAsync();
    }
}
```

---

### Task 5: Add MainWindow Integration

**In MainWindowViewModel.cs:**

```csharp
[RelayCommand(CanExecute = nameof(HasActiveConversation))]
private async Task ExportAsync()
{
    if (_currentConversationId is not { } conversationId) return;

    var viewModel = new ExportViewModel(_exportService, _storageProvider, conversationId);
    var dialog = new ExportDialog(viewModel);
    await dialog.ShowDialog(GetMainWindow());
}

private bool HasActiveConversation => _currentConversationId.HasValue;
```

**In MainWindow.axaml:**

```xml
<Window.KeyBindings>
    <KeyBinding Gesture="Ctrl+E" Command="{Binding ExportCommand}" />
</Window.KeyBindings>
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| InitializeAsync | 1 | Preview loads on init |
| UpdatePreviewAsync | 4 | Each option change triggers |
| ExportAsync | 3 | Success, error, cancel |
| CreateOptions | 1 | Maps properties correctly |
| EnumBoolConverter | 4 | Convert, ConvertBack |
| **Total** | **13** | |

### Key Test Scenarios

```csharp
[Fact]
public async Task InitializeAsync_LoadsPreview()
{
    var vm = CreateViewModel();
    
    await vm.InitializeAsync();
    
    Assert.NotEmpty(vm.Preview);
}

[Fact]
public async Task OnSelectedFormatChanged_UpdatesPreview()
{
    var vm = CreateViewModel();
    await vm.InitializeAsync();
    var initialPreview = vm.Preview;
    
    vm.SelectedFormat = ExportFormat.Json;
    await Task.Delay(50); // Allow async update
    
    Assert.NotEqual(initialPreview, vm.Preview);
}

[Fact]
public async Task ExportAsync_CallsExportService()
{
    var mockExportService = CreateMockExportService();
    var vm = CreateViewModel(mockExportService);
    
    await vm.ExportCommand.ExecuteAsync(null);
    
    mockExportService.Received(1).ExportAsync(Arg.Any<Guid>(), Arg.Any<ExportOptions>());
}

[Fact]
public void EnumBoolConverter_Convert_ReturnsTrueForMatch()
{
    var converter = new EnumBoolConverter();
    
    var result = converter.Convert(ExportFormat.Markdown, typeof(bool), "Markdown", null);
    
    Assert.True((bool)result!);
}

[Fact]
public void EnumBoolConverter_ConvertBack_ReturnsEnumValue()
{
    var converter = new EnumBoolConverter();
    
    var result = converter.ConvertBack(true, typeof(ExportFormat), "Json", null);
    
    Assert.Equal(ExportFormat.Json, result);
}
```

---

## Files Summary

### Files to Create (4)

| File | Lines (approx) |
|------|----------------|
| `Converters/EnumBoolConverter.cs` | 35 |
| `ViewModels/ExportViewModel.cs` | 120 |
| `Views/ExportDialog.axaml` | 80 |
| `Views/ExportDialog.axaml.cs` | 30 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `ViewModels/MainWindowViewModel.cs` | Add ExportCommand |
| `Views/MainWindow.axaml` | Add Ctrl+E binding |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Ctrl+E opens ExportDialog when conversation active |
| AC-2 | Format radio buttons switch export format |
| AC-3 | Option checkboxes affect export output |
| AC-4 | Preview updates when format changes |
| AC-5 | Preview updates when options change |
| AC-6 | Preview shows monospace font |
| AC-7 | Export button opens save file dialog |
| AC-8 | File saved with correct extension |
| AC-9 | Cancel button closes dialog |
| AC-10 | Error message displays on failure |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Live preview | Immediate feedback on options |
| RadioButtons for format | Only one format at a time |
| Checkboxes for options | Multiple options selectable |
| EnumBoolConverter | Clean AXAML bindings |
| IStorageProvider | Cross-platform file picker |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.2.5f | 0.5-1 day |
