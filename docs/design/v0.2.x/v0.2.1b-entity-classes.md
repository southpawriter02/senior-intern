# Design Specification: AIntern v0.2.1b "Entity Classes"

## Executive Summary

This document provides a detailed implementation specification for v0.2.1b, which defines all entity classes in the `SeniorIntern.Core` project. These entities represent the database schema for conversations, messages, system prompts, and inference presets.

This sub-version establishes the domain model that will be configured for database persistence in v0.2.1c. By placing entities in the Core project (rather than Data), the domain layer remains independent of Entity Framework Core, allowing services to work with entities without introducing a data access dependency.

### v0.2.1b Scope

- Create `MessageRole` enum for message sender identification
- Create `ConversationEntity` for chat sessions
- Create `MessageEntity` for individual messages
- Create `SystemPromptEntity` for reusable system prompts
- Create `InferencePresetEntity` for saved inference configurations

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| MessageRole Enum | Three-value enum distinguishing System, User, and Assistant messages |
| ConversationEntity | Chat session with metadata, pinning, archiving, and denormalized counts |
| MessageEntity | Individual message with role, content, ordering, and generation statistics |
| SystemPromptEntity | Reusable system prompt with categories and usage tracking |
| InferencePresetEntity | Saved inference parameter configurations (temperature, top-p, etc.) |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.2.1b Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Entity Classes                                                   │
│  ├── MessageRole Enum                                             │
│  │   ├── System (0) - Hidden instructions                         │
│  │   ├── User (1) - Human input                                   │
│  │   └── Assistant (2) - AI responses                             │
│  │                                                                │
│  ├── ConversationEntity                                           │
│  │   ├── Identity (Id, Title)                                     │
│  │   ├── Timestamps (CreatedAt, UpdatedAt)                        │
│  │   ├── Model info (ModelPath, ModelName)                        │
│  │   ├── Organization (IsArchived, IsPinned)                      │
│  │   └── Statistics (MessageCount, TotalTokenCount)               │
│  │                                                                │
│  ├── MessageEntity                                                │
│  │   ├── Identity & FK (Id, ConversationId)                       │
│  │   ├── Content (Role, Content, SequenceNumber)                  │
│  │   ├── Statistics (TokenCount, GenerationTimeMs)                │
│  │   └── Status (IsEdited, IsComplete)                            │
│  │                                                                │
│  ├── SystemPromptEntity                                           │
│  │   ├── Identity (Id, Name, Description)                         │
│  │   ├── Content (Content, Category)                              │
│  │   ├── Flags (IsDefault, IsBuiltIn, IsActive)                   │
│  │   └── Statistics (UsageCount)                                  │
│  │                                                                │
│  └── InferencePresetEntity                                        │
│      ├── Identity (Id, Name, Description)                         │
│      ├── Sampling (Temperature, TopP, TopK, RepeatPenalty)        │
│      ├── Length (MaxTokens, ContextSize)                          │
│      └── Flags (IsDefault, IsBuiltIn)                             │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Entity Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        SystemPromptEntity                        │
├─────────────────────────────────────────────────────────────────┤
│ PK: Id (Guid)                                                    │
│     Name (string, unique)                                        │
│     Description (string?)                                        │
│     Content (string)                                             │
│     Category (string)                                            │
│     CreatedAt, UpdatedAt (DateTime)                             │
│     IsDefault, IsBuiltIn, IsActive (bool)                       │
│     UsageCount (int)                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N (optional)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       ConversationEntity                         │
├─────────────────────────────────────────────────────────────────┤
│ PK: Id (Guid)                                                    │
│ FK: SystemPromptId (Guid?, SetNull on delete)                   │
│     Title (string)                                               │
│     ModelPath, ModelName (string?)                              │
│     CreatedAt, UpdatedAt (DateTime)                             │
│     IsArchived, IsPinned (bool)                                 │
│     MessageCount, TotalTokenCount (int)                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N (cascade delete)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         MessageEntity                            │
├─────────────────────────────────────────────────────────────────┤
│ PK: Id (Guid)                                                    │
│ FK: ConversationId (Guid, required)                             │
│     Role (MessageRole enum)                                      │
│     Content (string)                                             │
│     SequenceNumber (int, unique per conversation)               │
│     Timestamp (DateTime)                                         │
│     EditedAt (DateTime?)                                        │
│     TokenCount, GenerationTimeMs (int?)                         │
│     TokensPerSecond (float?)                                    │
│     IsEdited, IsComplete (bool)                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     InferencePresetEntity                        │
├─────────────────────────────────────────────────────────────────┤
│ PK: Id (Guid)                                                    │
│     Name (string, unique)                                        │
│     Description (string?)                                        │
│     Temperature, TopP, RepeatPenalty (float)                    │
│     TopK, MaxTokens, ContextSize (int)                          │
│     IsDefault, IsBuiltIn (bool)                                 │
│     CreatedAt, UpdatedAt (DateTime)                             │
└─────────────────────────────────────────────────────────────────┘
          (standalone - no relationships to other entities)
```

### Layer Interaction (Entity Placement)

```
┌─────────────────────────────────────────────────────────────────┐
│                    SeniorIntern.Desktop                          │
│                    (Presentation Layer)                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │ Uses
┌─────────────────────────────▼───────────────────────────────────┐
│                    SeniorIntern.Services                         │
│                    (Application Layer)                           │
└─────────────────────────────┬───────────────────────────────────┘
                              │ Uses
┌─────────────────────────────▼───────────────────────────────────┐
│                    SeniorIntern.Data                             │
│                    (Data Access Layer)                           │
│  ┌───────────────┐  ┌───────────────┐                           │
│  │DatabasePath   │  │ (DbContext    │                           │
│  │Resolver       │  │  in v0.2.1c)  │                           │
│  └───────────────┘  └───────────────┘                           │
└─────────────────────────────┬───────────────────────────────────┘
                              │ Uses
┌─────────────────────────────▼───────────────────────────────────┐
│                    SeniorIntern.Core                             │
│                    (Domain Layer)                                │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │
│  │   Entities    │  │    Enums      │  │   Interfaces  │        │
│  │ [NEW in 1b]   │  │ [NEW in 1b]   │  │               │        │
│  └───────────────┘  └───────────────┘  └───────────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

---

## Prerequisites

Before implementing v0.2.1b, ensure:

- v0.2.1a is complete (Data project exists)
- `SeniorIntern.Core` project exists and builds
- Solution builds successfully

---

## Directory Structure

After v0.2.1b implementation:

```
src/SeniorIntern.Core/
├── Entities/
│   ├── ConversationEntity.cs
│   ├── MessageEntity.cs
│   ├── SystemPromptEntity.cs
│   └── InferencePresetEntity.cs
├── Enums/
│   └── MessageRole.cs
└── ... (existing files)
```

---

## Implementation Details

### Task 1: Create MessageRole Enum

Define the enum for message sender roles in the chat.

**File:** `src/SeniorIntern.Core/Enums/MessageRole.cs`

```csharp
namespace SeniorIntern.Core.Enums;

/// <summary>
/// Defines the role of a message sender in a conversation.
/// Used to distinguish between system instructions, user input, and AI responses.
/// </summary>
public enum MessageRole
{
    /// <summary>
    /// System instructions that define the assistant's behavior and context.
    /// These messages are typically hidden from the user but sent to the model.
    /// </summary>
    /// <example>
    /// "You are a helpful assistant that specializes in C# development."
    /// </example>
    System = 0,

    /// <summary>
    /// Messages from the human user.
    /// These are the prompts and questions entered by the user.
    /// </summary>
    User = 1,

    /// <summary>
    /// Messages from the AI assistant.
    /// These are the generated responses from the language model.
    /// </summary>
    Assistant = 2
}
```

**Design Decisions:**

| Decision | Rationale |
|----------|-----------|
| Explicit integer values | Ensures stable database storage even if enum order changes |
| Start at 0 | Standard convention, matches default enum behavior |
| XML documentation | Clear usage guidance for each role type |

---

### Task 2: Create ConversationEntity

The conversation entity represents a chat session containing multiple messages.

**File:** `src/SeniorIntern.Core/Entities/ConversationEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Represents a conversation (chat session) stored in the database.
/// A conversation contains an ordered collection of messages and metadata
/// about the chat session.
/// </summary>
/// <remarks>
/// <para>Conversations are the primary organizational unit for chat history.</para>
/// <para>Key features:</para>
/// <list type="bullet">
///   <item><description>Auto-generated titles from first user message</description></item>
///   <item><description>Support for pinning and archiving</description></item>
///   <item><description>Optional system prompt association</description></item>
///   <item><description>Denormalized counts for efficient list display</description></item>
/// </list>
/// </remarks>
public sealed class ConversationEntity
{
    #region Primary Key

    /// <summary>
    /// Unique identifier for the conversation.
    /// </summary>
    /// <remarks>
    /// Generated as a new GUID when the conversation is created.
    /// Used as the primary key in the database.
    /// </remarks>
    public Guid Id { get; set; }

    #endregion

    #region Display Properties

    /// <summary>
    /// Display title for the conversation.
    /// </summary>
    /// <remarks>
    /// <para>Default value: "New Conversation"</para>
    /// <para>Can be auto-generated from the first user message content,
    /// typically truncated to 50-100 characters.</para>
    /// <para>Users can manually edit the title.</para>
    /// </remarks>
    /// <example>"How to implement dependency injection in C#"</example>
    public string Title { get; set; } = "New Conversation";

    #endregion

    #region Timestamps

    /// <summary>
    /// When the conversation was created.
    /// </summary>
    /// <remarks>
    /// Set automatically by the DbContext when the entity is added.
    /// Stored as UTC time.
    /// </remarks>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// When the conversation was last modified.
    /// </summary>
    /// <remarks>
    /// Updated automatically when:
    /// <list type="bullet">
    ///   <item><description>A message is added</description></item>
    ///   <item><description>A message is edited</description></item>
    ///   <item><description>The title is changed</description></item>
    ///   <item><description>Settings are modified</description></item>
    /// </list>
    /// Used for sorting conversations by recency.
    /// </remarks>
    public DateTime UpdatedAt { get; set; }

    #endregion

    #region Model Information

    /// <summary>
    /// Path to the model file used for this conversation.
    /// </summary>
    /// <remarks>
    /// <para>Stored for reference and display purposes.</para>
    /// <para>May be null if no model has been loaded yet.</para>
    /// <para>Example: "/Users/john/models/llama-2-7b-chat.Q4_K_M.gguf"</para>
    /// </remarks>
    public string? ModelPath { get; set; }

    /// <summary>
    /// Human-readable model name.
    /// </summary>
    /// <remarks>
    /// <para>Can be extracted from the model path filename or user-defined.</para>
    /// <para>Example: "Llama 2 7B Chat"</para>
    /// </remarks>
    public string? ModelName { get; set; }

    #endregion

    #region System Prompt Reference

    /// <summary>
    /// Foreign key reference to the system prompt used for this conversation.
    /// </summary>
    /// <remarks>
    /// <para>Null indicates using the default system prompt or no system prompt.</para>
    /// <para>When the referenced SystemPrompt is deleted, this is set to null
    /// (SetNull delete behavior).</para>
    /// </remarks>
    public Guid? SystemPromptId { get; set; }

    #endregion

    #region Organization Flags

    /// <summary>
    /// Whether the conversation is archived.
    /// </summary>
    /// <remarks>
    /// <para>Archived conversations are hidden from the main conversation list
    /// but can be viewed in an "Archived" section.</para>
    /// <para>Default: false</para>
    /// </remarks>
    public bool IsArchived { get; set; }

    /// <summary>
    /// Whether the conversation is pinned to the top.
    /// </summary>
    /// <remarks>
    /// <para>Pinned conversations appear at the top of the conversation list,
    /// sorted by UpdatedAt among pinned items.</para>
    /// <para>Default: false</para>
    /// </remarks>
    public bool IsPinned { get; set; }

    #endregion

    #region Denormalized Statistics

    /// <summary>
    /// Total number of messages in this conversation.
    /// </summary>
    /// <remarks>
    /// <para>Denormalized for efficient display in conversation lists
    /// without needing to count related messages.</para>
    /// <para>Updated when messages are added or deleted.</para>
    /// <para>Default: 0</para>
    /// </remarks>
    public int MessageCount { get; set; }

    /// <summary>
    /// Approximate total tokens used in this conversation.
    /// </summary>
    /// <remarks>
    /// <para>Sum of TokenCount from all messages.</para>
    /// <para>Used for context window management and statistics display.</para>
    /// <para>Default: 0</para>
    /// </remarks>
    public int TotalTokenCount { get; set; }

    #endregion

    #region Navigation Properties

    /// <summary>
    /// The system prompt associated with this conversation.
    /// </summary>
    /// <remarks>
    /// Navigation property for EF Core.
    /// May be null if no specific system prompt is assigned.
    /// </remarks>
    public SystemPromptEntity? SystemPrompt { get; set; }

    /// <summary>
    /// All messages in this conversation.
    /// </summary>
    /// <remarks>
    /// <para>Navigation property for EF Core.</para>
    /// <para>Messages should be ordered by SequenceNumber when queried.</para>
    /// <para>Cascade delete: When conversation is deleted, all messages are deleted.</para>
    /// </remarks>
    public ICollection<MessageEntity> Messages { get; set; } = new List<MessageEntity>();

    #endregion
}
```

**Property Summary:**

| Property | Type | Required | Default | Purpose |
|----------|------|----------|---------|---------|
| `Id` | `Guid` | Yes | Generated | Primary key |
| `Title` | `string` | Yes | "New Conversation" | Display name |
| `CreatedAt` | `DateTime` | Yes | Auto-set | Creation timestamp |
| `UpdatedAt` | `DateTime` | Yes | Auto-set | Last modification |
| `ModelPath` | `string?` | No | null | Model file location |
| `ModelName` | `string?` | No | null | Display model name |
| `SystemPromptId` | `Guid?` | No | null | FK to SystemPrompt |
| `IsArchived` | `bool` | Yes | false | Archive flag |
| `IsPinned` | `bool` | Yes | false | Pin flag |
| `MessageCount` | `int` | Yes | 0 | Denormalized count |
| `TotalTokenCount` | `int` | Yes | 0 | Token statistics |

---

### Task 3: Create MessageEntity

The message entity represents a single message within a conversation.

**File:** `src/SeniorIntern.Core/Entities/MessageEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

using SeniorIntern.Core.Enums;

/// <summary>
/// Represents a single message within a conversation.
/// Messages are ordered by SequenceNumber within their parent conversation.
/// </summary>
/// <remarks>
/// <para>Messages can be from three roles: System, User, or Assistant.</para>
/// <para>Key features:</para>
/// <list type="bullet">
///   <item><description>Sequence-based ordering within conversation</description></item>
///   <item><description>Token counting for context management</description></item>
///   <item><description>Generation statistics for assistant messages</description></item>
///   <item><description>Edit tracking with timestamps</description></item>
///   <item><description>Incomplete message handling for cancelled generations</description></item>
/// </list>
/// </remarks>
public sealed class MessageEntity
{
    #region Primary Key

    /// <summary>
    /// Unique identifier for the message.
    /// </summary>
    public Guid Id { get; set; }

    #endregion

    #region Foreign Key

    /// <summary>
    /// The conversation this message belongs to.
    /// </summary>
    /// <remarks>
    /// Required foreign key. Messages cannot exist without a parent conversation.
    /// </remarks>
    public Guid ConversationId { get; set; }

    #endregion

    #region Message Content

    /// <summary>
    /// The role of the message sender.
    /// </summary>
    /// <remarks>
    /// Determines how the message is displayed and processed:
    /// <list type="bullet">
    ///   <item><description>System: Hidden from UI, prepended to context</description></item>
    ///   <item><description>User: Displayed on right side, user input</description></item>
    ///   <item><description>Assistant: Displayed on left side, AI response</description></item>
    /// </list>
    /// Stored as integer in database.
    /// </remarks>
    public MessageRole Role { get; set; }

    /// <summary>
    /// The text content of the message.
    /// </summary>
    /// <remarks>
    /// <para>Can be any length (no database limit).</para>
    /// <para>May contain markdown formatting.</para>
    /// <para>For assistant messages, may be partial if generation was cancelled.</para>
    /// </remarks>
    public string Content { get; set; } = string.Empty;

    #endregion

    #region Ordering

    /// <summary>
    /// Order of this message within the conversation.
    /// </summary>
    /// <remarks>
    /// <para>Starts at 1 for the first message.</para>
    /// <para>Unique within each conversation (enforced by database index).</para>
    /// <para>Used to maintain chronological message order.</para>
    /// </remarks>
    public int SequenceNumber { get; set; }

    #endregion

    #region Timestamps

    /// <summary>
    /// When the message was created.
    /// </summary>
    /// <remarks>
    /// Set automatically when the message is first saved.
    /// For assistant messages, this is when generation started.
    /// </remarks>
    public DateTime Timestamp { get; set; }

    /// <summary>
    /// When the message was last edited.
    /// </summary>
    /// <remarks>
    /// Null if the message has never been edited.
    /// Set when IsEdited becomes true.
    /// </remarks>
    public DateTime? EditedAt { get; set; }

    #endregion

    #region Token Statistics

    /// <summary>
    /// Number of tokens in this message.
    /// </summary>
    /// <remarks>
    /// <para>Null if not yet calculated.</para>
    /// <para>Calculated using the model's tokenizer.</para>
    /// <para>Used for context window management.</para>
    /// </remarks>
    public int? TokenCount { get; set; }

    #endregion

    #region Generation Statistics (Assistant Messages Only)

    /// <summary>
    /// Time taken to generate this message in milliseconds.
    /// </summary>
    /// <remarks>
    /// <para>Only applicable for Assistant messages.</para>
    /// <para>Null for User and System messages.</para>
    /// <para>Measures time from generation start to completion.</para>
    /// </remarks>
    public int? GenerationTimeMs { get; set; }

    /// <summary>
    /// Tokens generated per second during message generation.
    /// </summary>
    /// <remarks>
    /// <para>Only applicable for Assistant messages.</para>
    /// <para>Calculated as TokenCount / (GenerationTimeMs / 1000).</para>
    /// <para>Used for performance monitoring and display.</para>
    /// </remarks>
    public float? TokensPerSecond { get; set; }

    #endregion

    #region Status Flags

    /// <summary>
    /// Whether this message has been edited after creation.
    /// </summary>
    /// <remarks>
    /// <para>Default: false</para>
    /// <para>Set to true when user edits their message or regenerates an assistant response.</para>
    /// </remarks>
    public bool IsEdited { get; set; }

    /// <summary>
    /// Whether the message generation was completed.
    /// </summary>
    /// <remarks>
    /// <para>Default: true</para>
    /// <para>Set to false for assistant messages where generation was cancelled mid-stream.</para>
    /// <para>Incomplete messages may be displayed with a visual indicator.</para>
    /// </remarks>
    public bool IsComplete { get; set; } = true;

    #endregion

    #region Navigation Properties

    /// <summary>
    /// The conversation this message belongs to.
    /// </summary>
    /// <remarks>
    /// Navigation property for EF Core.
    /// Required relationship - message cannot exist without conversation.
    /// </remarks>
    public ConversationEntity Conversation { get; set; } = null!;

    #endregion
}
```

**Property Summary:**

| Property | Type | Required | Default | Purpose |
|----------|------|----------|---------|---------|
| `Id` | `Guid` | Yes | Generated | Primary key |
| `ConversationId` | `Guid` | Yes | - | FK to Conversation |
| `Role` | `MessageRole` | Yes | - | Sender type |
| `Content` | `string` | Yes | "" | Message text |
| `SequenceNumber` | `int` | Yes | - | Order in conversation |
| `Timestamp` | `DateTime` | Yes | Auto-set | Creation time |
| `EditedAt` | `DateTime?` | No | null | Last edit time |
| `TokenCount` | `int?` | No | null | Token count |
| `GenerationTimeMs` | `int?` | No | null | Generation duration |
| `TokensPerSecond` | `float?` | No | null | Generation speed |
| `IsEdited` | `bool` | Yes | false | Edit flag |
| `IsComplete` | `bool` | Yes | true | Completion flag |

**Message Role Display Guidelines:**

| Role | UI Position | Background | Icon |
|------|-------------|------------|------|
| System | Hidden or collapsible | Gray | Gear |
| User | Right-aligned | Blue | User |
| Assistant | Left-aligned | White/Dark | Bot |

---

### Task 4: Create SystemPromptEntity

The system prompt entity stores reusable system instructions.

**File:** `src/SeniorIntern.Core/Entities/SystemPromptEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Represents a system prompt that defines the assistant's behavior and personality.
/// System prompts are reusable templates that can be applied to conversations.
/// </summary>
/// <remarks>
/// <para>System prompts are sent as the first message in the conversation context
/// to establish the AI's behavior, tone, and capabilities.</para>
/// <para>Key features:</para>
/// <list type="bullet">
///   <item><description>Built-in prompts that cannot be deleted</description></item>
///   <item><description>Category-based organization</description></item>
///   <item><description>Usage tracking for analytics</description></item>
///   <item><description>Soft-delete via IsActive flag</description></item>
/// </list>
/// </remarks>
public sealed class SystemPromptEntity
{
    #region Primary Key

    /// <summary>
    /// Unique identifier for the system prompt.
    /// </summary>
    public Guid Id { get; set; }

    #endregion

    #region Identity

    /// <summary>
    /// Display name for the prompt.
    /// </summary>
    /// <remarks>
    /// <para>Must be unique across all prompts.</para>
    /// <para>Maximum length: 100 characters.</para>
    /// <para>Examples: "Default Assistant", "Code Expert", "The Senior Intern"</para>
    /// </remarks>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Optional description of what this prompt does.
    /// </summary>
    /// <remarks>
    /// <para>Maximum length: 500 characters.</para>
    /// <para>Displayed in the prompt selection UI to help users choose.</para>
    /// </remarks>
    public string? Description { get; set; }

    #endregion

    #region Content

    /// <summary>
    /// The actual system prompt text.
    /// </summary>
    /// <remarks>
    /// <para>No maximum length - prompts can be extensive.</para>
    /// <para>This text is prepended to every conversation using this prompt.</para>
    /// <para>May contain multi-line instructions, examples, and formatting.</para>
    /// </remarks>
    public string Content { get; set; } = string.Empty;

    #endregion

    #region Organization

    /// <summary>
    /// Category for organizing prompts.
    /// </summary>
    /// <remarks>
    /// <para>Predefined categories for filtering in the UI.</para>
    /// <para>Maximum length: 50 characters.</para>
    /// <para>Default: "General"</para>
    /// </remarks>
    /// <example>
    /// Common categories:
    /// - "General" - General-purpose assistants
    /// - "Code" - Programming and development
    /// - "Creative" - Creative writing and brainstorming
    /// - "Technical" - Technical documentation and explanations
    /// </example>
    public string Category { get; set; } = "General";

    #endregion

    #region Timestamps

    /// <summary>
    /// When the prompt was created.
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// When the prompt was last modified.
    /// </summary>
    public DateTime UpdatedAt { get; set; }

    #endregion

    #region Flags

    /// <summary>
    /// Whether this is the default prompt for new conversations.
    /// </summary>
    /// <remarks>
    /// <para>Only one prompt should have this set to true.</para>
    /// <para>When setting a new default, clear the flag on the previous default.</para>
    /// <para>Default: false</para>
    /// </remarks>
    public bool IsDefault { get; set; }

    /// <summary>
    /// Whether this is a built-in template.
    /// </summary>
    /// <remarks>
    /// <para>Built-in prompts are created during database seeding.</para>
    /// <para>They cannot be deleted (only hidden via IsActive).</para>
    /// <para>They can be modified by the user.</para>
    /// <para>Default: false</para>
    /// </remarks>
    public bool IsBuiltIn { get; set; }

    /// <summary>
    /// Whether this prompt is currently active/visible.
    /// </summary>
    /// <remarks>
    /// <para>Used for soft-delete functionality.</para>
    /// <para>Inactive prompts are hidden from selection UI.</para>
    /// <para>Default: true</para>
    /// </remarks>
    public bool IsActive { get; set; } = true;

    #endregion

    #region Statistics

    /// <summary>
    /// Number of times this prompt has been used.
    /// </summary>
    /// <remarks>
    /// <para>Incremented when a new conversation is started with this prompt.</para>
    /// <para>Used for analytics and sorting by popularity.</para>
    /// <para>Default: 0</para>
    /// </remarks>
    public int UsageCount { get; set; }

    #endregion

    #region Navigation Properties

    /// <summary>
    /// Conversations using this system prompt.
    /// </summary>
    /// <remarks>
    /// <para>Navigation property for EF Core.</para>
    /// <para>One-to-many relationship: one prompt can be used by many conversations.</para>
    /// </remarks>
    public ICollection<ConversationEntity> Conversations { get; set; } = new List<ConversationEntity>();

    #endregion
}
```

**Property Summary:**

| Property | Type | Required | Default | Purpose |
|----------|------|----------|---------|---------|
| `Id` | `Guid` | Yes | Generated | Primary key |
| `Name` | `string` | Yes | "" | Unique display name |
| `Description` | `string?` | No | null | Usage description |
| `Content` | `string` | Yes | "" | Prompt text |
| `Category` | `string` | Yes | "General" | Organization category |
| `CreatedAt` | `DateTime` | Yes | Auto-set | Creation timestamp |
| `UpdatedAt` | `DateTime` | Yes | Auto-set | Last modification |
| `IsDefault` | `bool` | Yes | false | Default prompt flag |
| `IsBuiltIn` | `bool` | Yes | false | Built-in template flag |
| `IsActive` | `bool` | Yes | true | Visibility flag |
| `UsageCount` | `int` | Yes | 0 | Usage statistics |

**Built-in Categories:**

| Category | Description | Example Prompts |
|----------|-------------|-----------------|
| General | General-purpose assistants | Default Assistant, Socratic Tutor |
| Code | Programming assistance | Code Expert, Rubber Duck |
| Creative | Creative writing | The Senior Intern |
| Technical | Technical documentation | Technical Writer |

---

### Task 5: Create InferencePresetEntity

The inference preset entity stores saved inference parameter configurations.

**File:** `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

/// <summary>
/// Represents a saved configuration of inference parameters.
/// Presets allow users to quickly switch between different generation settings.
/// </summary>
/// <remarks>
/// <para>Inference parameters control how the language model generates text,
/// affecting creativity, consistency, and output length.</para>
/// <para>Key features:</para>
/// <list type="bullet">
///   <item><description>Built-in presets for common use cases</description></item>
///   <item><description>User-created custom presets</description></item>
///   <item><description>Quick switching during conversations</description></item>
/// </list>
/// </remarks>
public sealed class InferencePresetEntity
{
    #region Primary Key

    /// <summary>
    /// Unique identifier for the preset.
    /// </summary>
    public Guid Id { get; set; }

    #endregion

    #region Identity

    /// <summary>
    /// Display name for the preset.
    /// </summary>
    /// <remarks>
    /// <para>Must be unique across all presets.</para>
    /// <para>Maximum length: 100 characters.</para>
    /// <para>Examples: "Balanced", "Creative", "Precise"</para>
    /// </remarks>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Optional description of the preset's use case.
    /// </summary>
    /// <remarks>
    /// <para>Maximum length: 500 characters.</para>
    /// <para>Helps users understand when to use this preset.</para>
    /// </remarks>
    public string? Description { get; set; }

    #endregion

    #region Sampling Parameters

    /// <summary>
    /// Temperature parameter controlling randomness.
    /// </summary>
    /// <remarks>
    /// <para>Range: 0.0 to 2.0</para>
    /// <para>Lower values (0.1-0.3): More focused, deterministic outputs</para>
    /// <para>Medium values (0.7-0.9): Balanced creativity and coherence</para>
    /// <para>Higher values (1.0-2.0): More creative, potentially chaotic</para>
    /// <para>Default: 0.7</para>
    /// </remarks>
    public float Temperature { get; set; } = 0.7f;

    /// <summary>
    /// Top-P (nucleus sampling) parameter.
    /// </summary>
    /// <remarks>
    /// <para>Range: 0.0 to 1.0</para>
    /// <para>Controls diversity by sampling from the smallest set of tokens
    /// whose cumulative probability exceeds P.</para>
    /// <para>0.9: Considers tokens in the top 90% probability mass</para>
    /// <para>1.0: Considers all tokens (disabled)</para>
    /// <para>Default: 0.9</para>
    /// </remarks>
    public float TopP { get; set; } = 0.9f;

    /// <summary>
    /// Top-K parameter limiting token selection.
    /// </summary>
    /// <remarks>
    /// <para>Range: 1 to 100 (typically)</para>
    /// <para>Limits selection to the K most likely next tokens.</para>
    /// <para>Lower values: More focused outputs</para>
    /// <para>Higher values: More diversity</para>
    /// <para>Default: 40</para>
    /// </remarks>
    public int TopK { get; set; } = 40;

    /// <summary>
    /// Repeat penalty to reduce repetition.
    /// </summary>
    /// <remarks>
    /// <para>Range: 1.0 to 2.0</para>
    /// <para>1.0: No penalty (disabled)</para>
    /// <para>1.1: Light penalty (recommended)</para>
    /// <para>1.5+: Strong penalty (may affect coherence)</para>
    /// <para>Default: 1.1</para>
    /// </remarks>
    public float RepeatPenalty { get; set; } = 1.1f;

    #endregion

    #region Length Parameters

    /// <summary>
    /// Maximum tokens to generate in response.
    /// </summary>
    /// <remarks>
    /// <para>Limits the length of generated responses.</para>
    /// <para>Common values: 512, 1024, 2048, 4096, 8192</para>
    /// <para>Higher values allow longer responses but use more memory.</para>
    /// <para>Default: 2048</para>
    /// </remarks>
    public int MaxTokens { get; set; } = 2048;

    /// <summary>
    /// Context window size in tokens.
    /// </summary>
    /// <remarks>
    /// <para>Total tokens available for prompt + response.</para>
    /// <para>Must not exceed model's maximum context length.</para>
    /// <para>Common values: 2048, 4096, 8192, 16384, 32768</para>
    /// <para>Higher values allow longer conversations but use more memory.</para>
    /// <para>Default: 4096</para>
    /// </remarks>
    public int ContextSize { get; set; } = 4096;

    #endregion

    #region Flags

    /// <summary>
    /// Whether this is the default preset.
    /// </summary>
    /// <remarks>
    /// <para>Only one preset should have this set to true.</para>
    /// <para>The default preset is used for new conversations.</para>
    /// <para>Default: false</para>
    /// </remarks>
    public bool IsDefault { get; set; }

    /// <summary>
    /// Whether this is a built-in preset.
    /// </summary>
    /// <remarks>
    /// <para>Built-in presets are created during database seeding.</para>
    /// <para>They cannot be deleted but can be modified.</para>
    /// <para>Default: false</para>
    /// </remarks>
    public bool IsBuiltIn { get; set; }

    #endregion

    #region Timestamps

    /// <summary>
    /// When the preset was created.
    /// </summary>
    public DateTime CreatedAt { get; set; }

    /// <summary>
    /// When the preset was last modified.
    /// </summary>
    public DateTime UpdatedAt { get; set; }

    #endregion
}
```

**Property Summary:**

| Property | Type | Required | Default | Range | Purpose |
|----------|------|----------|---------|-------|---------|
| `Id` | `Guid` | Yes | Generated | - | Primary key |
| `Name` | `string` | Yes | "" | 1-100 chars | Unique display name |
| `Description` | `string?` | No | null | 0-500 chars | Usage description |
| `Temperature` | `float` | Yes | 0.7 | 0.0-2.0 | Randomness control |
| `TopP` | `float` | Yes | 0.9 | 0.0-1.0 | Nucleus sampling |
| `TopK` | `int` | Yes | 40 | 1-100 | Token selection limit |
| `RepeatPenalty` | `float` | Yes | 1.1 | 1.0-2.0 | Repetition penalty |
| `MaxTokens` | `int` | Yes | 2048 | 1-32768 | Max response length |
| `ContextSize` | `int` | Yes | 4096 | 512-131072 | Context window |
| `IsDefault` | `bool` | Yes | false | - | Default preset flag |
| `IsBuiltIn` | `bool` | Yes | false | - | Built-in flag |
| `CreatedAt` | `DateTime` | Yes | Auto-set | - | Creation timestamp |
| `UpdatedAt` | `DateTime` | Yes | Auto-set | - | Last modification |

**Built-in Presets (defined in v0.2.1e):**

| Preset | Temperature | TopP | TopK | MaxTokens | Context | Use Case |
|--------|-------------|------|------|-----------|---------|----------|
| Balanced | 0.7 | 0.9 | 40 | 2048 | 4096 | General conversation |
| Precise | 0.2 | 0.8 | 20 | 1024 | 4096 | Factual responses |
| Creative | 1.2 | 0.95 | 60 | 4096 | 8192 | Brainstorming |
| Long-form | 0.7 | 0.9 | 40 | 8192 | 16384 | Detailed explanations |

---

## Logging Specifications

### Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| Entity Construction | Debug | Entity instantiated with default values |
| Entity Validation | Warning | Invalid property value set (e.g., negative counts) |
| Navigation Loading | Debug | Navigation property lazy-loaded |

**Note:** Entities themselves do not perform logging. Logging occurs in services and repositories that use these entities. The above represents events that may occur during entity usage.

---

## Unit Testing Requirements

### Test Summary

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| MessageRole Enum | 3 | Value validation, integer mapping |
| ConversationEntity | 6 | Defaults, navigation properties, constraints |
| MessageEntity | 6 | Defaults, role handling, statistics properties |
| SystemPromptEntity | 5 | Defaults, category validation, flags |
| InferencePresetEntity | 6 | Parameter ranges, defaults, constraints |
| **Total** | **26** | |

### Key Test Scenarios

#### MessageRole Tests

```csharp
[Fact]
public void MessageRole_System_ShouldEqual0()
{
    // Assert
    Assert.Equal(0, (int)MessageRole.System);
}

[Fact]
public void MessageRole_User_ShouldEqual1()
{
    // Assert
    Assert.Equal(1, (int)MessageRole.User);
}

[Fact]
public void MessageRole_Assistant_ShouldEqual2()
{
    // Assert
    Assert.Equal(2, (int)MessageRole.Assistant);
}
```

#### ConversationEntity Tests

```csharp
[Fact]
public void ConversationEntity_NewInstance_ShouldHaveDefaultTitle()
{
    // Arrange & Act
    var conversation = new ConversationEntity();

    // Assert
    Assert.Equal("New Conversation", conversation.Title);
}

[Fact]
public void ConversationEntity_NewInstance_ShouldHaveEmptyMessagesCollection()
{
    // Arrange & Act
    var conversation = new ConversationEntity();

    // Assert
    Assert.NotNull(conversation.Messages);
    Assert.Empty(conversation.Messages);
}

[Fact]
public void ConversationEntity_NewInstance_ShouldHaveZeroMessageCount()
{
    // Arrange & Act
    var conversation = new ConversationEntity();

    // Assert
    Assert.Equal(0, conversation.MessageCount);
    Assert.Equal(0, conversation.TotalTokenCount);
}

[Fact]
public void ConversationEntity_NewInstance_ShouldNotBeArchivedOrPinned()
{
    // Arrange & Act
    var conversation = new ConversationEntity();

    // Assert
    Assert.False(conversation.IsArchived);
    Assert.False(conversation.IsPinned);
}
```

#### MessageEntity Tests

```csharp
[Fact]
public void MessageEntity_NewInstance_ShouldHaveEmptyContent()
{
    // Arrange & Act
    var message = new MessageEntity();

    // Assert
    Assert.Equal(string.Empty, message.Content);
}

[Fact]
public void MessageEntity_NewInstance_ShouldBeComplete()
{
    // Arrange & Act
    var message = new MessageEntity();

    // Assert
    Assert.True(message.IsComplete);
    Assert.False(message.IsEdited);
}

[Fact]
public void MessageEntity_NewInstance_ShouldHaveNullStatistics()
{
    // Arrange & Act
    var message = new MessageEntity();

    // Assert
    Assert.Null(message.TokenCount);
    Assert.Null(message.GenerationTimeMs);
    Assert.Null(message.TokensPerSecond);
}
```

#### InferencePresetEntity Tests

```csharp
[Fact]
public void InferencePresetEntity_NewInstance_ShouldHaveBalancedDefaults()
{
    // Arrange & Act
    var preset = new InferencePresetEntity();

    // Assert
    Assert.Equal(0.7f, preset.Temperature);
    Assert.Equal(0.9f, preset.TopP);
    Assert.Equal(40, preset.TopK);
    Assert.Equal(1.1f, preset.RepeatPenalty);
    Assert.Equal(2048, preset.MaxTokens);
    Assert.Equal(4096, preset.ContextSize);
}

[Fact]
public void InferencePresetEntity_NewInstance_ShouldNotBeDefaultOrBuiltIn()
{
    // Arrange & Act
    var preset = new InferencePresetEntity();

    // Assert
    Assert.False(preset.IsDefault);
    Assert.False(preset.IsBuiltIn);
}
```

---

## Use Cases

### UC-001: Create New Conversation Entity

| Attribute | Value |
|-----------|-------|
| **Actor** | ConversationService |
| **Precondition** | User initiates new conversation |
| **Trigger** | Service creates ConversationEntity |
| **Success Scenario** | Entity created with defaults, persisted to database |
| **Failure Scenarios** | Database write failure → Exception propagated |
| **Postcondition** | Conversation exists with unique Id and default title |

#### Flow
1. Service instantiates `new ConversationEntity()`
2. Entity receives default values (Title, empty Messages, counts = 0)
3. Service sets `Id = Guid.NewGuid()`, `CreatedAt = DateTime.UtcNow`
4. Service persists entity via repository
5. Entity is returned with populated Id

### UC-002: Add Message to Conversation

| Attribute | Value |
|-----------|-------|
| **Actor** | ConversationService |
| **Precondition** | Conversation exists |
| **Trigger** | User sends message or assistant generates response |
| **Success Scenario** | Message added with correct sequence number |
| **Failure Scenarios** | Sequence number collision → Retry with next number |
| **Postcondition** | Message persisted, conversation.MessageCount incremented |

#### Flow
1. Service creates `new MessageEntity()` with content and role
2. Service calculates next `SequenceNumber`
3. Service sets `ConversationId` to parent conversation
4. Service persists message
5. Service updates `conversation.MessageCount++` and `UpdatedAt`

---

## Deliverable Checklist

### Domain Layer (SeniorIntern.Core)
- [x] Enums: `MessageRole.cs`
- [x] Entities: `ConversationEntity.cs`
- [x] Entities: `MessageEntity.cs`
- [x] Entities: `SystemPromptEntity.cs`
- [x] Entities: `InferencePresetEntity.cs`

### Data Layer (SeniorIntern.Data)
- [ ] No changes in v0.2.1b (DbContext in v0.2.1c)

### Application Layer (SeniorIntern.Services)
- [ ] No changes in v0.2.1b

### Presentation Layer (SeniorIntern.Desktop)
- [ ] No changes in v0.2.1b

### Tests
- [ ] SeniorIntern.Core.Tests - Entity and enum tests

### Documentation
- [x] This design specification (v0.2.1b-entity-classes.md)

---

## Files Summary

### Files to Create (5)

| File | Purpose | Lines (approx) |
|------|---------|----------------|
| `src/SeniorIntern.Core/Enums/MessageRole.cs` | Message role enum | 25 |
| `src/SeniorIntern.Core/Entities/ConversationEntity.cs` | Conversation entity | 120 |
| `src/SeniorIntern.Core/Entities/MessageEntity.cs` | Message entity | 130 |
| `src/SeniorIntern.Core/Entities/SystemPromptEntity.cs` | System prompt entity | 110 |
| `src/SeniorIntern.Core/Entities/InferencePresetEntity.cs` | Inference preset entity | 120 |

### Files to Modify (0)

No existing files need modification in v0.2.1b.

### Directories to Create

| Directory | Purpose |
|-----------|---------|
| `src/SeniorIntern.Core/Entities/` | Entity class container |
| `src/SeniorIntern.Core/Enums/` | Enum definitions (if not exists) |

---

## Verification Steps

### Step 1: Verify Directory Structure

```bash
# Create directories if needed
mkdir -p src/SeniorIntern.Core/Entities
mkdir -p src/SeniorIntern.Core/Enums

# Verify structure
ls -la src/SeniorIntern.Core/
```

### Step 2: Verify Compilation

```bash
# Build Core project
dotnet build src/SeniorIntern.Core

# Expected output: Build succeeded with no errors
```

### Step 3: Verify Entity Relationships

Create a simple test to verify navigation properties compile:

```csharp
// Temporary verification code
var conversation = new ConversationEntity
{
    Id = Guid.NewGuid(),
    Title = "Test",
    Messages = new List<MessageEntity>
    {
        new() { Role = MessageRole.User, Content = "Hello" }
    }
};

var message = conversation.Messages.First();
message.Conversation = conversation; // Verify bidirectional navigation
```

### Step 4: Verify Enum Usage

```csharp
// Verify enum values
Assert.Equal(0, (int)MessageRole.System);
Assert.Equal(1, (int)MessageRole.User);
Assert.Equal(2, (int)MessageRole.Assistant);
```

---

## Acceptance Criteria

### Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | MessageRole enum exists with 3 values | Enum compiles with System=0, User=1, Assistant=2 |
| AC-2 | ConversationEntity compiles | `dotnet build` succeeds |
| AC-3 | MessageEntity compiles | `dotnet build` succeeds |
| AC-4 | SystemPromptEntity compiles | `dotnet build` succeeds |
| AC-5 | InferencePresetEntity compiles | `dotnet build` succeeds |
| AC-6 | Navigation properties are correct | Conversation.Messages and Message.Conversation compile |
| AC-7 | Default values are set | New entities have expected defaults |
| AC-8 | Nullable properties are marked | `?` suffix on optional properties |

### Quality Criteria

- [x] All code includes XML documentation comments
- [x] No compiler warnings
- [x] Code follows established patterns (sealed classes, regions)
- [x] Properties organized by logical grouping

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Entity design mismatch with EF Core | Low | Medium | Follow EF Core conventions; validate in v0.2.1c |
| Navigation property issues | Low | Medium | Use explicit `= null!` for required navigations |
| Missing XML documentation | Low | Low | Review all public members before completion |
| Enum value changes break data | Low | High | Explicit integer values prevent reordering issues |

---

## Design Decisions

### Decision 1: Entities in Core Project

**Decision:** Place entities in `SeniorIntern.Core` rather than `SeniorIntern.Data`.

**Rationale:**
- Entities are domain models, not data access concerns
- Core project has no EF Core dependency
- Services can reference entities without Data dependency
- Clean separation of concerns

### Decision 2: Sealed Entity Classes

**Decision:** Mark all entity classes as `sealed`.

**Rationale:**
- Entities are not designed for inheritance
- Prevents accidental proxy issues with EF Core
- Clear intent that these are final implementations

### Decision 3: GUID Primary Keys

**Decision:** Use `Guid` instead of `int` for primary keys.

**Rationale:**
- No coordination needed for ID generation
- Works well with disconnected scenarios
- Supports potential future sync features
- More difficult to guess (security)

### Decision 4: Denormalized Counts

**Decision:** Store `MessageCount` and `TotalTokenCount` on ConversationEntity.

**Rationale:**
- Avoids COUNT queries when displaying conversation list
- Updated atomically when messages change
- Acceptable trade-off for read performance

### Decision 5: Soft Delete for System Prompts

**Decision:** Use `IsActive` flag instead of hard delete for SystemPromptEntity.

**Rationale:**
- Preserves history for conversations using deleted prompts
- Allows recovery of accidentally deleted prompts
- Built-in prompts should never be fully deleted

---

## Future Considerations

| Item | Target Version | Rationale for Deferral |
|------|----------------|------------------------|
| File attachment entities | v0.3.0+ | Not in v0.2.x scope |
| Conversation tags/labels | v0.2.5+ | Nice-to-have organization feature |
| Message reaction entities | v0.4.0+ | Advanced feature not in current roadmap |
| Audit logging entities | v0.5.0+ | Enterprise feature for future consideration |

---

## Timeline Estimate

| Version | Estimated Effort | Key Deliverables |
|---------|------------------|------------------|
| v0.2.1b | 0.5 days | 5 entity/enum files with full XML documentation |

---

## Architecture Summary

### Project Structure After v0.2.1b

```
SeniorIntern/
├── src/
│   ├── SeniorIntern.Core/
│   │   ├── Entities/                              [NEW DIRECTORY]
│   │   │   ├── ConversationEntity.cs              [NEW]
│   │   │   ├── MessageEntity.cs                   [NEW]
│   │   │   ├── SystemPromptEntity.cs              [NEW]
│   │   │   └── InferencePresetEntity.cs           [NEW]
│   │   ├── Enums/                                 [NEW DIRECTORY]
│   │   │   └── MessageRole.cs                     [NEW]
│   │   ├── Models/
│   │   │   ├── ChatMessage.cs
│   │   │   ├── Conversation.cs
│   │   │   ├── AppSettings.cs
│   │   │   └── ModelLoadOptions.cs
│   │   └── Interfaces/
│   │       ├── IConversationService.cs
│   │       ├── ILlmService.cs
│   │       └── ISettingsService.cs
│   │
│   ├── SeniorIntern.Data/
│   │   ├── SeniorIntern.Data.csproj
│   │   └── DatabasePathResolver.cs
│   │
│   ├── SeniorIntern.Services/
│   └── SeniorIntern.Desktop/
│
└── tests/
    └── SeniorIntern.Core.Tests/                   [Entity tests]
```

### Dependency Flow

```
SeniorIntern.Core (no dependencies)
       ↑
SeniorIntern.Data (→ Core, EF Core)
       ↑
SeniorIntern.Services (→ Core, Data, LLamaSharp)
       ↑
SeniorIntern.Desktop (→ Core, Services, Data, Avalonia)
```

---

## Next Steps

After completing v0.2.1b, proceed to:

**v0.2.1c: DbContext & Configuration**
- Create `SeniorInternDbContext` in Data project
- Implement Fluent API configurations for each entity
- Define indexes, constraints, and relationships
- Generate initial EF Core migration

The entities created in v0.2.1b will be configured for database mapping in v0.2.1c.

---

## Appendix: Complete Namespace Structure

After v0.2.1b, the Core project namespaces will be:

```
SeniorIntern.Core
├── Entities
│   ├── ConversationEntity
│   ├── MessageEntity
│   ├── SystemPromptEntity
│   └── InferencePresetEntity
├── Enums
│   └── MessageRole
└── ... (existing namespaces)
```

**Using Statements for Entities:**

```csharp
using SeniorIntern.Core.Entities;
using SeniorIntern.Core.Enums;
```

---

## References

- [Entity Framework Core Entity Types](https://learn.microsoft.com/en-us/ef/core/modeling/entity-types)
- [EF Core Navigation Properties](https://learn.microsoft.com/en-us/ef/core/modeling/relationships)
- [C# Sealed Classes](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/sealed)
- [GUID vs Int Primary Keys](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/)
