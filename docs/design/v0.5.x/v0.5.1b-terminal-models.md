# Design Specification: AIntern v0.5.1b "Terminal Models"

**Status**: _PLANNED_

## Executive Summary

This document provides a detailed implementation specification for v0.5.1b, which defines all terminal-related model classes required for the terminal subsystem. These models provide the foundational data structures for screen buffer management, text styling, cell representation, session lifecycle, and text selection. This sub-part depends on v0.5.1a (Project Setup) and is a prerequisite for v0.5.1c (ANSI Parser).

### v0.5.1b Scope (from v0.5.1-terminal-foundation.md)

- Define `TerminalSize` readonly record struct for terminal dimensions
- Define `TerminalColor` readonly struct for color representation (default, palette, RGB)
- Define `TerminalAttributes` readonly struct for text styling (bold, italic, underline, etc.)
- Define `TerminalCell` struct for individual buffer cells with Unicode support
- Define `TerminalLine` sealed class for managing rows of cells
- Define `TerminalSelection` sealed record for text selection
- Define `TerminalSessionState` enum for session lifecycle states
- Define `TerminalSession` sealed class for session management with `IAsyncDisposable`
- Define `TerminalBuffer` sealed class for screen buffer with scrollback

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| TerminalSize.cs | Readonly record struct for terminal dimensions (columns x rows) |
| TerminalColor.cs | Readonly struct for terminal colors (default, 256-palette, 24-bit RGB) |
| TerminalAttributes.cs | Readonly struct for text styling attributes (SGR support) |
| TerminalCell.cs | Struct representing a single cell with character and attributes |
| TerminalLine.cs | Sealed class representing a line of cells with dirty tracking |
| TerminalSelection.cs | Sealed record for text selection (line and block modes) |
| TerminalSessionState.cs | Enum for session lifecycle states |
| TerminalSession.cs | Sealed class for terminal session with IAsyncDisposable |
| TerminalBuffer.cs | Sealed class for screen buffer with scrollback support |

### Related Documents

- @v0.5.0-integrated-terminal.md - Parent design specification
- @v0.5.1-terminal-foundation.md - Sub-version specification with all parts (a-f)
- @v0.5.1a-project-setup.md - Project setup specification (prerequisite)

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.5.1b Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Terminal Models (src/AIntern.Core/Models/Terminal/)              │
│  │                                                                │
│  ├── Value Types (Structs)                                        │
│  │   ├── TerminalSize.cs                                          │
│  │   │   └── Readonly record struct for dimensions                │
│  │   ├── TerminalColor.cs                                         │
│  │   │   └── Readonly struct with IEquatable<T>                   │
│  │   ├── TerminalAttributes.cs                                    │
│  │   │   └── Readonly struct for text styling                     │
│  │   └── TerminalCell.cs                                          │
│  │       └── Mutable struct for buffer cells                      │
│  │                                                                │
│  ├── Reference Types (Classes)                                    │
│  │   ├── TerminalLine.cs                                          │
│  │   │   └── Sealed class for cell rows                           │
│  │   ├── TerminalSession.cs                                       │
│  │   │   └── Sealed class with IAsyncDisposable                   │
│  │   └── TerminalBuffer.cs                                        │
│  │       └── Sealed class for screen + scrollback                 │
│  │                                                                │
│  ├── Records                                                      │
│  │   └── TerminalSelection.cs                                     │
│  │       └── Sealed record for text selection                     │
│  │                                                                │
│  └── Enums                                                        │
│      └── TerminalSessionState.cs                                  │
│          └── Session lifecycle states                             │
│                                                                   │
│  Namespace: AIntern.Core.Models.Terminal                          │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Model Type Hierarchy

```
┌─────────────────────────────────────────────────────────────────┐
│                  Terminal Model Type Hierarchy                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Value Types                            │   │
│  │                                                           │   │
│  │  ┌─────────────────────┐  ┌────────────────────────────┐ │   │
│  │  │    TerminalSize     │  │      TerminalColor         │ │   │
│  │  │   (record struct)   │  │   (struct + IEquatable)    │ │   │
│  │  │                     │  │                            │ │   │
│  │  │  • Columns: int     │  │  • R, G, B: byte           │ │   │
│  │  │  • Rows: int        │  │  • IsDefault: bool         │ │   │
│  │  │  • TotalCells       │  │  • PaletteIndex: byte?     │ │   │
│  │  │  • IsValid          │  │  • FromRgb(), FromPalette()│ │   │
│  │  └─────────────────────┘  └────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────────┐  ┌────────────────────────────┐ │   │
│  │  │ TerminalAttributes  │  │      TerminalCell          │ │   │
│  │  │ (struct+IEquatable) │  │  (struct + IEquatable)     │ │   │
│  │  │                     │  │                            │ │   │
│  │  │  • Foreground       │──▶  • Character: Rune         │ │   │
│  │  │  • Background       │  │  • Attributes              │ │   │
│  │  │  • Bold, Italic...  │  │  • Width: int              │ │   │
│  │  │  • With() method    │  │  • IsContinuation: bool    │ │   │
│  │  └─────────────────────┘  └────────────────────────────┘ │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  Reference Types                          │   │
│  │                                                           │   │
│  │  ┌─────────────────────┐  ┌────────────────────────────┐ │   │
│  │  │   TerminalLine      │  │    TerminalSelection       │ │   │
│  │  │   (sealed class)    │  │     (sealed record)        │ │   │
│  │  │                     │  │                            │ │   │
│  │  │  • _cells: Cell[]   │  │  • StartLine, StartColumn  │ │   │
│  │  │  • IsDirty: bool    │  │  • EndLine, EndColumn      │ │   │
│  │  │  • IsWrapped: bool  │  │  • IsBlock: bool           │ │   │
│  │  │  • GetText()        │  │  • Contains()              │ │   │
│  │  └─────────────────────┘  └────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────────┐  ┌────────────────────────────┐ │   │
│  │  │  TerminalSession    │  │     TerminalBuffer         │ │   │
│  │  │  (sealed class)     │  │     (sealed class)         │ │   │
│  │  │  IAsyncDisposable   │  │                            │ │   │
│  │  │                     │  │  • _lines: List<Line>      │ │   │
│  │  │  • Id: Guid         │  │  • Columns, Rows: int      │ │   │
│  │  │  • Name: string     │  │  • CursorX, CursorY: int   │ │   │
│  │  │  • State: enum      │──▶  • CurrentAttributes       │ │   │
│  │  │  • Size: Size       │  │  • WriteChar(), LineFeed() │ │   │
│  │  │  • WorkingDirectory │  │  • Scroll methods          │ │   │
│  │  └─────────────────────┘  └────────────────────────────┘ │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                      Enums                                │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │              TerminalSessionState                   │ │   │
│  │  │                                                     │ │   │
│  │  │  Starting → Running → Exited                        │ │   │
│  │  │               ↓                                     │ │   │
│  │  │            Error → Closing                          │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Model Dependencies

```
┌─────────────────────────────────────────────────────────────────┐
│                    Model Dependency Graph                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                        ┌─────────────────┐                       │
│                        │  TerminalBuffer │                       │
│                        └────────┬────────┘                       │
│                   ┌─────────────┼─────────────┐                  │
│                   │             │             │                  │
│                   ▼             ▼             ▼                  │
│          ┌────────────┐ ┌─────────────┐ ┌──────────────┐        │
│          │TerminalLine│ │TerminalSize │ │TerminalCell │        │
│          └──────┬─────┘ └─────────────┘ └───────┬──────┘        │
│                 │                               │                │
│                 ▼                               ▼                │
│          ┌────────────┐                 ┌──────────────────┐    │
│          │TerminalCell│                 │TerminalAttributes│    │
│          └──────┬─────┘                 └────────┬─────────┘    │
│                 │                                │               │
│                 ▼                                ▼               │
│          ┌──────────────────┐           ┌─────────────────┐     │
│          │TerminalAttributes│           │  TerminalColor  │     │
│          └────────┬─────────┘           └─────────────────┘     │
│                   │                                              │
│                   ▼                                              │
│           ┌─────────────────┐                                    │
│           │  TerminalColor  │                                    │
│           └─────────────────┘                                    │
│                                                                  │
│  ┌─────────────────┐         ┌──────────────────────┐           │
│  │ TerminalSession │────────▶│ TerminalSessionState │           │
│  └────────┬────────┘         └──────────────────────┘           │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                             │
│  │  TerminalSize   │                                             │
│  └─────────────────┘                                             │
│                                                                  │
│  ┌───────────────────┐                                           │
│  │ TerminalSelection │  (standalone, used by buffer/renderer)    │
│  └───────────────────┘                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Color System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                 Terminal Color System                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   TerminalColor Modes                    │    │
│  │                                                          │    │
│  │  1. Default Color (IsDefault = true)                     │    │
│  │     └── Uses terminal's configured default               │    │
│  │                                                          │    │
│  │  2. Palette Color (PaletteIndex = 0-255)                 │    │
│  │     ├── 0-7:   Standard ANSI colors                      │    │
│  │     ├── 8-15:  Bright ANSI colors                        │    │
│  │     ├── 16-231: 6×6×6 color cube                         │    │
│  │     └── 232-255: 24 grayscale shades                     │    │
│  │                                                          │    │
│  │  3. True Color (R, G, B = 0-255)                         │    │
│  │     └── Full 24-bit color support                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              Standard ANSI Color Palette                 │    │
│  │                                                          │    │
│  │   Index  │  Name         │  Bright Name                  │    │
│  │  ────────┼───────────────┼──────────────                 │    │
│  │    0     │  Black        │  BrightBlack (8)              │    │
│  │    1     │  Red          │  BrightRed (9)                │    │
│  │    2     │  Green        │  BrightGreen (10)             │    │
│  │    3     │  Yellow       │  BrightYellow (11)            │    │
│  │    4     │  Blue         │  BrightBlue (12)              │    │
│  │    5     │  Magenta      │  BrightMagenta (13)           │    │
│  │    6     │  Cyan         │  BrightCyan (14)              │    │
│  │    7     │  White        │  BrightWhite (15)             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Text Attributes (SGR Support)

```
┌─────────────────────────────────────────────────────────────────┐
│               Terminal Attributes (SGR Codes)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   TerminalAttributes                     │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  Colors (TerminalColor)                          │    │    │
│  │  │  ├── Foreground  (SGR 30-37, 38, 90-97)          │    │    │
│  │  │  └── Background  (SGR 40-47, 48, 100-107)        │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  Style Flags (bool)                              │    │    │
│  │  │  ├── Bold         (SGR 1)   - Bright/bold text   │    │    │
│  │  │  ├── Dim          (SGR 2)   - Faint text         │    │    │
│  │  │  ├── Italic       (SGR 3)   - Italic text        │    │    │
│  │  │  ├── Underline    (SGR 4)   - Underlined text    │    │    │
│  │  │  ├── Blink        (SGR 5)   - Blinking text      │    │    │
│  │  │  ├── Inverse      (SGR 7)   - Swap fg/bg         │    │    │
│  │  │  ├── Hidden       (SGR 8)   - Invisible text     │    │    │
│  │  │  └── Strikethrough(SGR 9)   - Crossed-out text   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  Factory Methods:                                        │    │
│  │  • Default     - Reset to terminal defaults              │    │
│  │  • With(...)   - Create modified copy                    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### 1. TerminalSize.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSize.cs`
**Type**: `readonly record struct`
**Purpose**: Represents terminal dimensions in columns and rows

```
┌─────────────────────────────────────────────────────────────────┐
│                      TerminalSize Design                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Properties:                                                     │
│  ├── Columns: int        - Number of character columns          │
│  └── Rows: int           - Number of character rows             │
│                                                                  │
│  Computed Properties:                                            │
│  ├── IsValid: bool       - Both dimensions > 0                  │
│  └── TotalCells: int     - Columns × Rows                       │
│                                                                  │
│  Static Factory Properties:                                      │
│  ├── Default             - 80×24 (standard VT100)               │
│  ├── Wide                - 120×30 (widescreen)                  │
│  └── Compact             - 80×12 (half-height)                  │
│                                                                  │
│  Methods:                                                        │
│  └── ToString()          - "80x24" format                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Uses `readonly record struct` for value semantics with automatic equality
- Factory properties provide common terminal sizes
- `IsValid` prevents invalid dimensions from causing issues downstream
- `TotalCells` is useful for memory allocation calculations

---

### 2. TerminalColor.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalColor.cs`
**Type**: `readonly struct` with `IEquatable<TerminalColor>`
**Purpose**: Represents terminal colors with support for default, palette, and true color modes

```
┌─────────────────────────────────────────────────────────────────┐
│                     TerminalColor Design                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Properties:                                                     │
│  ├── R: byte             - Red component (0-255)                │
│  ├── G: byte             - Green component (0-255)              │
│  ├── B: byte             - Blue component (0-255)               │
│  ├── IsDefault: bool     - Uses terminal default                │
│  └── PaletteIndex: byte? - 256-color palette index              │
│                                                                  │
│  Static Factory Methods:                                         │
│  ├── FromRgb(r, g, b)    - Create 24-bit color                  │
│  └── FromPalette(index)  - Create from 256 palette              │
│                                                                  │
│  Static Factory Properties:                                      │
│  ├── Default             - Terminal default color               │
│  ├── Black, Red, Green, Yellow, Blue, Magenta, Cyan, White      │
│  └── BrightBlack, BrightRed, ... (indices 8-15)                 │
│                                                                  │
│  IEquatable<TerminalColor>:                                      │
│  ├── Equals(TerminalColor other)                                │
│  ├── Equals(object? obj)                                        │
│  ├── GetHashCode()                                              │
│  ├── operator ==                                                │
│  └── operator !=                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Uses `readonly struct` instead of `record struct` to allow explicit `IEquatable<T>` implementation
- `init` accessors on properties for flexible construction
- Three color modes: Default, Palette (256), and TrueColor (RGB)
- Standard ANSI colors provided as static properties
- `HashCode.Combine()` for efficient hash code generation

---

### 3. TerminalAttributes.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalAttributes.cs`
**Type**: `readonly struct` with `IEquatable<TerminalAttributes>`
**Purpose**: Represents text styling attributes for terminal cells

```
┌─────────────────────────────────────────────────────────────────┐
│                   TerminalAttributes Design                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Color Properties:                                               │
│  ├── Foreground: TerminalColor  - Text color                    │
│  └── Background: TerminalColor  - Background color              │
│                                                                  │
│  Style Properties (bool):                                        │
│  ├── Bold          - Bold/intense text (SGR 1)                  │
│  ├── Dim           - Dim/faint text (SGR 2)                     │
│  ├── Italic        - Italic text (SGR 3)                        │
│  ├── Underline     - Underlined text (SGR 4)                    │
│  ├── Blink         - Blinking text (SGR 5)                      │
│  ├── Inverse       - Swap foreground/background (SGR 7)         │
│  ├── Hidden        - Hidden/invisible text (SGR 8)              │
│  └── Strikethrough - Strikethrough text (SGR 9)                 │
│                                                                  │
│  Static Properties:                                              │
│  └── Default       - Default colors, no styles                  │
│                                                                  │
│  Methods:                                                        │
│  └── With(...)     - Create copy with modifications             │
│                                                                  │
│  IEquatable<TerminalAttributes>:                                 │
│  ├── Equals(TerminalAttributes other)                           │
│  ├── Equals(object? obj)                                        │
│  ├── GetHashCode()                                              │
│  ├── operator ==                                                │
│  └── operator !=                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Immutable struct pattern with `With()` method for modifications
- All style flags are optional nullable parameters in `With()`
- `HashCode` struct used for combining multiple hash codes
- Maps directly to SGR (Select Graphic Rendition) escape codes

---

### 4. TerminalCell.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalCell.cs`
**Type**: `struct` with `IEquatable<TerminalCell>`
**Purpose**: Represents a single cell in the terminal buffer

```
┌─────────────────────────────────────────────────────────────────┐
│                      TerminalCell Design                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Properties:                                                     │
│  ├── Character: Rune              - Unicode character            │
│  ├── Attributes: TerminalAttributes - Cell styling              │
│  ├── Width: int                   - Cell width (1 or 2)         │
│  └── IsContinuation: bool         - Part of wide character      │
│                                                                  │
│  Computed Properties:                                            │
│  └── IsBlank: bool                - Space, null, or continuation│
│                                                                  │
│  Static Factory Properties:                                      │
│  └── Empty                        - Space with default attrs    │
│                                                                  │
│  Static Factory Methods:                                         │
│  ├── FromChar(char c)             - Create with default attrs   │
│  └── FromChar(char c, attrs)      - Create with specific attrs  │
│                                                                  │
│  IEquatable<TerminalCell>:                                       │
│  ├── Equals(TerminalCell other)                                 │
│  ├── Equals(object? obj)                                        │
│  ├── GetHashCode()                                              │
│  ├── operator ==                                                │
│  └── operator !=                                                │
│                                                                  │
│  Notes:                                                          │
│  • Mutable struct (not readonly) for performance                │
│  • Uses System.Text.Rune for Unicode support                    │
│  • Width > 1 for CJK/emoji characters                           │
│  • IsContinuation marks second cell of wide characters          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Mutable struct (no `readonly`) to allow efficient buffer updates
- Uses `System.Text.Rune` for full Unicode scalar value support
- Width field supports wide characters (CJK, emoji)
- `IsContinuation` prevents rendering the same character twice
- `IsBlank` helps with optimization in rendering

---

### 5. TerminalLine.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalLine.cs`
**Type**: `sealed class`
**Purpose**: Represents a single line of cells in the terminal buffer

```
┌─────────────────────────────────────────────────────────────────┐
│                      TerminalLine Design                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Private Fields:                                                 │
│  └── _cells: TerminalCell[]       - Cell array (fixed size)     │
│                                                                  │
│  Properties:                                                     │
│  ├── Length: int                  - Number of columns            │
│  ├── IsWrapped: bool              - Wrapped from previous line  │
│  ├── IsDirty: bool                - Modified since last render  │
│  └── LastModified: DateTime       - UTC timestamp of last change│
│                                                                  │
│  Indexer:                                                        │
│  └── this[int column]: ref Cell   - Get cell by reference       │
│                                                                  │
│  Span Accessors:                                                 │
│  ├── Cells: Span<TerminalCell>    - Mutable cell span           │
│  └── ReadOnlyCells: ROSpan<Cell>  - Immutable cell span         │
│                                                                  │
│  Methods:                                                        │
│  ├── Clear()                      - Clear entire line           │
│  ├── Clear(start, end)            - Clear range                 │
│  ├── SetCell(column, cell)        - Set specific cell           │
│  ├── CopyFrom(TerminalLine)       - Copy from another line      │
│  ├── Resize(newColumns)           - Resize line width           │
│  ├── GetText()                    - Get trimmed text content    │
│  ├── MarkDirty()                  - Mark as needing re-render   │
│  └── MarkClean()                  - Mark as rendered            │
│                                                                  │
│  Constructor:                                                    │
│  └── TerminalLine(int columns)    - Create with column count    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- `sealed class` for performance (no virtual dispatch)
- Returns `ref TerminalCell` from indexer for efficient in-place updates
- `Span<T>` accessors for zero-copy iteration
- `IsDirty` flag enables efficient incremental rendering
- `IsWrapped` indicates soft line breaks (vs hard newlines)
- `LastModified` enables time-based operations (e.g., fade effects)

---

### 6. TerminalSelection.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSelection.cs`
**Type**: `sealed record`
**Purpose**: Represents a text selection in the terminal

```
┌─────────────────────────────────────────────────────────────────┐
│                    TerminalSelection Design                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Properties:                                                     │
│  ├── StartLine: int               - Starting line (0-indexed)   │
│  ├── StartColumn: int             - Starting column             │
│  ├── EndLine: int                 - Ending line                 │
│  ├── EndColumn: int               - Ending column               │
│  └── IsBlock: bool                - Block vs line selection     │
│                                                                  │
│  Computed Properties:                                            │
│  ├── Normalized: TerminalSelection - Start always before end    │
│  └── IsEmpty: bool                - Start equals end            │
│                                                                  │
│  Methods:                                                        │
│  └── Contains(line, column): bool - Check if cell is selected  │
│                                                                  │
│  Selection Modes:                                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Line Selection (IsBlock = false)                        │    │
│  │  ┌────────────────────────────────────┐                  │    │
│  │  │  Some text on the [first line with │                  │    │
│  │  │  selection continuing to the] next │                  │    │
│  │  │  line of content...                │                  │    │
│  │  └────────────────────────────────────┘                  │    │
│  │                                                          │    │
│  │  Block Selection (IsBlock = true)                        │    │
│  │  ┌────────────────────────────────────┐                  │    │
│  │  │  Some [text on] the first line     │                  │    │
│  │  │  with [selecti]on continuing       │                  │    │
│  │  │  to t[he next ] line...            │                  │    │
│  │  └────────────────────────────────────┘                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- `sealed record` for immutability and value equality
- `Normalized` property ensures consistent start/end ordering
- `Contains()` method used by renderer to highlight selected cells
- Block selection useful for columnar data

---

### 7. TerminalSessionState.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSessionState.cs`
**Type**: `enum`
**Purpose**: Represents the lifecycle state of a terminal session

```
┌─────────────────────────────────────────────────────────────────┐
│                  TerminalSessionState Design                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Values:                                                         │
│  ├── Starting     - Session being created/initialized           │
│  ├── Running      - Session active, accepting input             │
│  ├── Exited       - Process terminated normally or abnormally   │
│  ├── Error        - Session encountered an error                │
│  └── Closing      - Session being closed/disposed               │
│                                                                  │
│  State Transitions:                                              │
│                                                                  │
│         ┌──────────┐                                             │
│         │ Starting │                                             │
│         └────┬─────┘                                             │
│              │ PTY spawned                                       │
│              ▼                                                   │
│         ┌──────────┐     process exits    ┌──────────┐          │
│         │ Running  │─────────────────────▶│  Exited  │          │
│         └────┬─────┘                      └────┬─────┘          │
│              │ error                           │                 │
│              ▼                                 │                 │
│         ┌──────────┐                           │                 │
│         │  Error   │                           │                 │
│         └────┬─────┘                           │                 │
│              │                                 │                 │
│              └─────────────┬───────────────────┘                 │
│                            │ dispose                             │
│                            ▼                                     │
│                       ┌──────────┐                               │
│                       │ Closing  │                               │
│                       └──────────┘                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Simple enum for state tracking
- State transitions enforced by TerminalService (v0.5.1d)
- `Error` state allows recovery/retry attempts
- `Closing` state prevents race conditions during disposal

---

### 8. TerminalSession.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSession.cs`
**Type**: `sealed class` with `IAsyncDisposable`
**Purpose**: Represents an active terminal session with a PTY process

```
┌─────────────────────────────────────────────────────────────────┐
│                     TerminalSession Design                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Identity Properties:                                            │
│  ├── Id: Guid                     - Unique session identifier   │
│  └── Name: string                 - Display name (tab title)    │
│                                                                  │
│  Process Properties:                                             │
│  ├── ShellPath: string            - Path to shell executable    │
│  ├── WorkingDirectory: string     - Current directory           │
│  └── Environment: Dictionary<str> - Environment variables       │
│                                                                  │
│  State Properties:                                               │
│  ├── State: TerminalSessionState  - Current lifecycle state     │
│  ├── CreatedAt: DateTime          - UTC creation time           │
│  ├── ClosedAt: DateTime?          - UTC close time (null=open)  │
│  └── ExitCode: int?               - Process exit code           │
│                                                                  │
│  Terminal Properties:                                            │
│  ├── Size: TerminalSize           - Current dimensions          │
│  ├── Title: string?               - Title from escape sequence  │
│  └── IsInteractive: bool          - Has PTY (vs non-interactive)│
│                                                                  │
│  Workspace Integration:                                          │
│  └── WorkspaceId: Guid?           - Associated workspace        │
│                                                                  │
│  Internal:                                                       │
│  └── OnDisposeAsync: Func<VTask>? - Disposal callback           │
│                                                                  │
│  IAsyncDisposable:                                               │
│  └── DisposeAsync(): ValueTask    - Async cleanup               │
│                                                                  │
│  Methods:                                                        │
│  └── ToString()                   - "Session(Id, Name, State)"  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- `sealed class` for finality and performance
- `IAsyncDisposable` for async resource cleanup (PTY process)
- `OnDisposeAsync` callback set by TerminalService (dependency inversion)
- `WorkspaceId` enables directory synchronization with file explorer
- `Title` updated via OSC (Operating System Command) escape sequences
- All properties use `init` accessors where immutability is desired

---

### 9. TerminalBuffer.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalBuffer.cs`
**Type**: `sealed class`
**Purpose**: Manages the terminal screen buffer with scrollback support

```
┌─────────────────────────────────────────────────────────────────┐
│                     TerminalBuffer Design                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Models.Terminal                         │
│                                                                  │
│  Private Fields:                                                 │
│  ├── _lines: List<TerminalLine>   - All lines (screen+scrollback)│
│  ├── _maxScrollback: int          - Maximum scrollback lines    │
│  └── _lock: object                - Thread synchronization      │
│                                                                  │
│  Dimension Properties:                                           │
│  ├── Columns: int                 - Terminal width              │
│  └── Rows: int                    - Visible terminal height     │
│                                                                  │
│  Cursor Properties:                                              │
│  ├── CursorX: int                 - Column position (0-indexed) │
│  ├── CursorY: int                 - Row position (0-indexed)    │
│  └── CursorVisible: bool          - Cursor visibility           │
│                                                                  │
│  Scroll Properties:                                              │
│  ├── ScrollOffset: int            - View offset from bottom     │
│  ├── TotalLines: int              - Total line count            │
│  └── ScrollbackLines: int         - Lines above visible area    │
│                                                                  │
│  Attribute Properties:                                           │
│  ├── CurrentAttributes: Attrs     - Active text attributes      │
│  ├── SavedCursor: (int, int)      - DECSC saved position        │
│  └── SavedAttributes: Attrs       - DECSC saved attributes      │
│                                                                  │
│  Mode Properties:                                                │
│  ├── ScrollRegionTop: int         - Scroll region top margin    │
│  ├── ScrollRegionBottom: int      - Scroll region bottom margin │
│  ├── OriginMode: bool             - Cursor relative to region   │
│  └── AutoWrapMode: bool           - Auto-wrap at line end       │
│                                                                  │
│  Events:                                                         │
│  └── ContentChanged: EventHandler - Buffer content changed      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### TerminalBuffer Methods (Part 1: Core Operations)

```
┌─────────────────────────────────────────────────────────────────┐
│                  TerminalBuffer Methods (1/3)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Constructor:                                                    │
│  └── TerminalBuffer(cols, rows, maxScrollback=10000)            │
│                                                                  │
│  Character Writing:                                              │
│  ├── WriteChar(char c)            - Write single character      │
│  ├── WriteChar(Rune rune)         - Write Unicode rune          │
│  └── WriteString(string text)     - Write string                │
│                                                                  │
│  Cursor Movement:                                                │
│  ├── LineFeed()                   - Move down, scroll if needed │
│  ├── CarriageReturn()             - Move to column 0            │
│  ├── Tab()                        - Move to next tab stop       │
│  ├── Backspace()                  - Move left one column        │
│  ├── CursorUp(n=1)                - Move up n rows              │
│  ├── CursorDown(n=1)              - Move down n rows            │
│  ├── CursorForward(n=1)           - Move right n columns        │
│  ├── CursorBack(n=1)              - Move left n columns         │
│  └── SetCursorPosition(row, col)  - Move to position (1-indexed)│
│                                                                  │
│  Cursor Save/Restore:                                            │
│  ├── SaveCursor()                 - DECSC: save position+attrs  │
│  └── RestoreCursor()              - DECRC: restore position+attr│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### TerminalBuffer Methods (Part 2: Screen Operations)

```
┌─────────────────────────────────────────────────────────────────┐
│                  TerminalBuffer Methods (2/3)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Scrolling:                                                      │
│  ├── ScrollUp(lines=1)            - Scroll content up           │
│  ├── ScrollDown(lines=1)          - Scroll content down         │
│  └── SetScrollRegion(top, bottom) - Set scrolling margins       │
│                                                                  │
│  Screen Clearing:                                                │
│  ├── Clear()                      - Clear entire screen (ED 2)  │
│  ├── ClearToEnd()                 - Clear to end of screen (ED 0)│
│  ├── ClearToBeginning()           - Clear to start (ED 1)       │
│  ├── ClearLine()                  - Clear current line (EL 2)   │
│  ├── ClearLineToEnd()             - Clear to end of line (EL 0) │
│  └── ClearLineToBeginning()       - Clear to start of line (EL 1)│
│                                                                  │
│  Line Operations:                                                │
│  ├── InsertLines(n=1)             - Insert blank lines at cursor│
│  └── DeleteLines(n=1)             - Delete lines at cursor      │
│                                                                  │
│  Character Operations:                                           │
│  ├── InsertChars(n=1)             - Insert blanks at cursor     │
│  └── DeleteChars(n=1)             - Delete chars at cursor      │
│                                                                  │
│  Resize:                                                         │
│  └── Resize(columns, rows)        - Resize buffer               │
│                                                                  │
│  Reset:                                                          │
│  └── Reset()                      - Reset to initial state      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### TerminalBuffer Methods (Part 3: Data Access)

```
┌─────────────────────────────────────────────────────────────────┐
│                  TerminalBuffer Methods (3/3)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Line Access:                                                    │
│  ├── GetLine(screenRow): Line?    - Get line by screen row      │
│  └── GetVisibleLines(): IROList   - Get all visible lines       │
│                                                                  │
│  Text Extraction:                                                │
│  ├── GetSelectedText(selection)   - Get text in selection       │
│  └── GetAllText()                 - Get entire buffer text      │
│                                                                  │
│  Private Methods:                                                │
│  ├── InitializeLines()            - Create initial line array   │
│  ├── GetAbsoluteLineIndex(row)    - Convert screen to absolute  │
│  ├── TrimScrollback()             - Remove excess scrollback    │
│  └── OnContentChanged()           - Raise ContentChanged event  │
│                                                                  │
│  Thread Safety:                                                  │
│  • All public methods use lock(_lock) for thread safety         │
│  • ContentChanged event raised within lock                      │
│  • GetVisibleLines returns copy to prevent race conditions      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Thread-safe via `lock(_lock)` on all public methods
- `_maxScrollback` limits memory usage (default 10,000 lines)
- Screen rows at end of `_lines` list, scrollback at beginning
- `ContentChanged` event enables UI refresh
- All cursor positions are 0-indexed internally; VT100 uses 1-indexed
- `SetCursorPosition` converts from 1-indexed VT100 coordinates

---

## Implementation Checklist

### Files to Create

| File | Type | Purpose |
|------|------|---------|
| `src/AIntern.Core/Models/Terminal/TerminalSize.cs` | readonly record struct | Terminal dimensions |
| `src/AIntern.Core/Models/Terminal/TerminalColor.cs` | readonly struct + IEquatable | Color representation |
| `src/AIntern.Core/Models/Terminal/TerminalAttributes.cs` | readonly struct + IEquatable | Text styling |
| `src/AIntern.Core/Models/Terminal/TerminalCell.cs` | struct + IEquatable | Buffer cell |
| `src/AIntern.Core/Models/Terminal/TerminalLine.cs` | sealed class | Line of cells |
| `src/AIntern.Core/Models/Terminal/TerminalSelection.cs` | sealed record | Text selection |
| `src/AIntern.Core/Models/Terminal/TerminalSessionState.cs` | enum | Session lifecycle |
| `src/AIntern.Core/Models/Terminal/TerminalSession.cs` | sealed class + IAsyncDisposable | Session model |
| `src/AIntern.Core/Models/Terminal/TerminalBuffer.cs` | sealed class | Screen buffer |

### Files to Remove

| File | Reason |
|------|--------|
| `src/AIntern.Core/Models/Terminal/.gitkeep` | Replace with actual model files |

### Prerequisites

- v0.5.1a must be completed (folder structure exists)
- `src/AIntern.Core/Models/Terminal/` directory must exist

---

## Code Style Requirements

### File Header Pattern

Each file should follow the project's established header pattern:

```csharp
namespace AIntern.Core.Models.Terminal;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ TYPE NAME (v0.5.1b)                                                     │
// │ Brief description of the type's purpose.                                │
// └─────────────────────────────────────────────────────────────────────────┘
```

### XML Documentation Pattern

```csharp
/// <summary>
/// Description of the type or member.
/// </summary>
/// <remarks>
/// <para>Added in v0.5.1b.</para>
/// </remarks>
```

### IEquatable Implementation Pattern

For structs implementing `IEquatable<T>`:

```csharp
public bool Equals(T other) => /* comparison */;

public override bool Equals(object? obj) =>
    obj is T other && Equals(other);

public override int GetHashCode() =>
    HashCode.Combine(/* properties */);

public static bool operator ==(T left, T right) => left.Equals(right);
public static bool operator !=(T left, T right) => !left.Equals(right);
```

---

## Verification Commands

### Step 1: Build Core Project

```bash
# Verify models compile correctly
dotnet build src/AIntern.Core/AIntern.Core.csproj
```

**Expected Output**:
- Build succeeded
- 0 errors
- No warnings related to new terminal types

### Step 2: Verify Type Visibility

```bash
# Run a quick test to verify types are accessible
dotnet build AIntern.sln
```

### Step 3: Verify Namespace

After implementation, ensure all types are in the correct namespace by checking that this code compiles:

```csharp
using AIntern.Core.Models.Terminal;

var size = TerminalSize.Default;
var color = TerminalColor.Red;
var attrs = TerminalAttributes.Default;
var cell = TerminalCell.Empty;
var line = new TerminalLine(80);
var selection = new TerminalSelection { StartLine = 0, StartColumn = 0, EndLine = 0, EndColumn = 10 };
var state = TerminalSessionState.Running;
var session = new TerminalSession { Name = "Test" };
var buffer = new TerminalBuffer(80, 24);
```

---

## Post-Implementation Notes

### Next Steps (v0.5.1c)

After v0.5.1b is complete, v0.5.1c will implement the ANSI parser in `src/AIntern.Core/Terminal/`:

- AnsiParserState.cs - Parser state machine
- AnsiParser.cs - VT100/ANSI escape sequence parser

The parser will consume data from the PTY stream and update the `TerminalBuffer` using the models defined in v0.5.1b.

### Rollback Procedure

If v0.5.1b needs to be rolled back:

1. Delete all `.cs` files in `src/AIntern.Core/Models/Terminal/`
2. Restore the `.gitkeep` file
3. Run `dotnet build` to verify no broken references

---

## Appendix A: System.Text.Rune Overview

The `TerminalCell` type uses `System.Text.Rune` for character storage:

```csharp
// Rune represents a Unicode scalar value (U+0000 to U+10FFFF, excluding surrogates)
// This is superior to char for terminal emulation because:
// 1. Supports full Unicode including emoji and CJK
// 2. Single value represents one grapheme (vs char which may be half a surrogate pair)
// 3. Provides proper character width calculation

// Example usage:
Rune rune = new Rune('A');           // ASCII character
Rune emoji = new Rune(0x1F600);      // 😀 emoji (U+1F600)
string text = rune.ToString();        // Convert to string
int utf8Bytes = rune.Utf8SequenceLength;  // 1 for ASCII, up to 4 for emoji
```

---

## Appendix B: Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-17 | Initial specification |
