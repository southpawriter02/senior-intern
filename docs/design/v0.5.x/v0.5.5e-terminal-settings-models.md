# Design Specification: AIntern v0.5.5e "Terminal Settings Models"

## Overview

**Version**: v0.5.5e
**Parent**: v0.5.5 Polish & Integration
**Focus**: Settings models for terminal customization with persistence

### Purpose

This sub-version defines the terminal settings models:
1. Create `TerminalSettings` model with appearance and behavior settings
2. Define `TerminalCursorStyle` and `TerminalBellStyle` enums
3. Create `TerminalTheme` model with ANSI color definitions
4. Define `IFontService` interface for font detection
5. Implement `FontService` with monospace font discovery
6. Extend `AppSettings` with terminal configuration
7. Provide built-in color themes

### Dependencies

**From v0.5.3c (Shell Profile Models)**:
- `ShellProfile` - Profile definitions for CustomProfiles

**From v0.5.5a (Terminal Search Models)**:
- `SearchHighlightStyle` - Theme integration

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.5.5e Terminal Settings Models Architecture                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Model Layer                                        │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalSettings                                                        │ │
│  │  ├── Appearance:                                                        │ │
│  │  │   ├── FontFamily: string                                             │ │
│  │  │   ├── FontSize: double (default: 14)                                 │ │
│  │  │   ├── LineHeight: double (default: 1.2)                              │ │
│  │  │   ├── LetterSpacing: double (default: 0)                             │ │
│  │  │   ├── ThemeName: string                                              │ │
│  │  │   ├── CursorStyle: TerminalCursorStyle                               │ │
│  │  │   ├── CursorBlink: bool                                              │ │
│  │  │   ├── CursorBlinkRate: int (ms)                                      │ │
│  │  │   ├── BoldIsBright: bool                                             │ │
│  │  │   └── MinimumContrastRatio: double                                   │ │
│  │  │                                                                       │ │
│  │  ├── Behavior:                                                          │ │
│  │  │   ├── ScrollbackLines: int (default: 10000)                          │ │
│  │  │   ├── BellEnabled: bool                                              │ │
│  │  │   ├── BellStyle: TerminalBellStyle                                   │ │
│  │  │   ├── CopyOnSelect: bool                                             │ │
│  │  │   ├── ScrollOnInput: bool                                            │ │
│  │  │   ├── ScrollOnOutput: bool                                           │ │
│  │  │   ├── WordSeparators: string                                         │ │
│  │  │   ├── EnableLigatures: bool                                          │ │
│  │  │   ├── SyncWithWorkspace: bool                                        │ │
│  │  │   └── ConfirmOnClose: bool                                           │ │
│  │  │                                                                       │ │
│  │  └── Shell:                                                             │ │
│  │      ├── DefaultProfileId: string?                                      │ │
│  │      └── CustomProfiles: List<ShellProfile>                             │ │
│  │                                                                          │ │
│  │  TerminalCursorStyle (enum): Block, Underline, Bar                       │ │
│  │  TerminalBellStyle (enum): None, Audio, Visual, Both                     │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         Theme Layer                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalTheme                                                           │ │
│  │  ├── Metadata:                                                          │ │
│  │  │   ├── Name: string                                                   │ │
│  │  │   └── IsBuiltIn: bool                                                │ │
│  │  │                                                                       │ │
│  │  ├── ANSI Colors (0-7):                                                 │ │
│  │  │   └── Black, Red, Green, Yellow, Blue, Magenta, Cyan, White          │ │
│  │  │                                                                       │ │
│  │  ├── Bright ANSI Colors (8-15):                                         │ │
│  │  │   └── BrightBlack, BrightRed, ... BrightWhite                        │ │
│  │  │                                                                       │ │
│  │  ├── UI Colors:                                                         │ │
│  │  │   ├── Background, Foreground                                         │ │
│  │  │   ├── Cursor, CursorText                                             │ │
│  │  │   └── Selection, SelectionText                                       │ │
│  │  │                                                                       │ │
│  │  └── Static: BuiltInThemes (DefaultDark, DefaultLight, ...)             │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Service Layer                                     │ │
│  │  src/AIntern.Services/                                                  │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  IFontService                                                            │ │
│  │  ├── GetMonospaceFonts() → IReadOnlyList<string>                        │ │
│  │  ├── IsFontAvailable(fontFamily) → bool                                 │ │
│  │  └── GetBestAvailableFont(fontList) → string                            │ │
│  │                                                                          │ │
│  │  FontService                                                             │ │
│  │  ├── Lazy<List<string>> _monospaceFonts                                 │ │
│  │  └── DetectMonospaceFonts() → List<string>                              │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Settings Organization

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      Terminal Settings Overview                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  APPEARANCE                                                           │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Property              │ Type          │ Default        │ Range       │  │
│  │  ─────────────────────────────────────────────────────────────────── │  │
│  │  FontFamily            │ string        │ (platform)     │ -           │  │
│  │  FontSize              │ double        │ 14             │ 8-72        │  │
│  │  LineHeight            │ double        │ 1.2            │ 1.0-3.0     │  │
│  │  LetterSpacing         │ double        │ 0              │ -2.0-5.0    │  │
│  │  ThemeName             │ string        │ "Default Dark" │ -           │  │
│  │  CursorStyle           │ enum          │ Block          │ 3 options   │  │
│  │  CursorBlink           │ bool          │ true           │ -           │  │
│  │  CursorBlinkRate       │ int           │ 530            │ 250-1500    │  │
│  │  BoldIsBright          │ bool          │ true           │ -           │  │
│  │  MinimumContrastRatio  │ double        │ 4.5            │ 1.0-21.0    │  │
│  │  EnableLigatures       │ bool          │ true           │ -           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  BEHAVIOR                                                             │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Property              │ Type          │ Default        │ Notes       │  │
│  │  ─────────────────────────────────────────────────────────────────── │  │
│  │  ScrollbackLines       │ int           │ 10000          │ 0-1000000   │  │
│  │  BellEnabled           │ bool          │ false          │ -           │  │
│  │  BellStyle             │ enum          │ Visual         │ 4 options   │  │
│  │  CopyOnSelect          │ bool          │ false          │ Linux-style │  │
│  │  ScrollOnInput         │ bool          │ true           │ -           │  │
│  │  ScrollOnOutput        │ bool          │ false          │ -           │  │
│  │  WordSeparators        │ string        │ " ()[]{}..."   │ -           │  │
│  │  SyncWithWorkspace     │ bool          │ true           │ -           │  │
│  │  ConfirmOnClose        │ bool          │ true           │ -           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  SHELL                                                                │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Property              │ Type                 │ Default               │  │
│  │  ─────────────────────────────────────────────────────────────────── │  │
│  │  DefaultProfileId      │ string?              │ null (auto-detect)    │  │
│  │  CustomProfiles        │ List<ShellProfile>   │ [] (empty)            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## ANSI Color Palette

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Terminal Theme Color Palette                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Standard ANSI Colors (0-7)                                                  │
│  ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐ │
│  │  0     │  1     │  2     │  3     │  4     │  5     │  6     │  7     │ │
│  │ Black  │  Red   │ Green  │ Yellow │  Blue  │Magenta │  Cyan  │ White  │ │
│  │#000000 │#CC0000 │#00CC00 │#CCCC00 │#0000CC │#CC00CC │#00CCCC │#CCCCCC │ │
│  └────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┘ │
│                                                                              │
│  Bright ANSI Colors (8-15)                                                   │
│  ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐ │
│  │  8     │  9     │  10    │  11    │  12    │  13    │  14    │  15    │ │
│  │Br.Black│Br.Red  │Br.Green│Br.Yellw│Br.Blue │Br.Magnt│Br.Cyan │Br.White│ │
│  │#666666 │#FF0000 │#00FF00 │#FFFF00 │#0000FF │#FF00FF │#00FFFF │#FFFFFF │ │
│  └────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┘ │
│                                                                              │
│  UI Colors                                                                   │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Background  │ Foreground  │ Cursor │ CursorText│ Selection │ SelectTxt│ │
│  │  #1E1E1E    │  #D4D4D4    │#FFFFFF │  #000000  │  #264F78  │  #FFFFFF │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. TerminalSettings.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSettings.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Terminal-specific settings for appearance, behavior, and shell configuration.
/// </summary>
public sealed class TerminalSettings
{
    // ========== Appearance ==========

    /// <summary>
    /// Font family for terminal text. Supports comma-separated fallbacks.
    /// </summary>
    public string FontFamily { get; set; } = GetDefaultMonospaceFont();

    /// <summary>
    /// Font size in points.
    /// Valid range: 8-72.
    /// </summary>
    public double FontSize { get; set; } = 14;

    /// <summary>
    /// Line height multiplier. 1.0 = single spacing.
    /// Valid range: 1.0-3.0.
    /// </summary>
    public double LineHeight { get; set; } = 1.2;

    /// <summary>
    /// Letter spacing in pixels.
    /// Valid range: -2.0-5.0.
    /// </summary>
    public double LetterSpacing { get; set; } = 0;

    /// <summary>
    /// Terminal color theme name.
    /// </summary>
    public string ThemeName { get; set; } = "Default Dark";

    /// <summary>
    /// Cursor style (Block, Underline, Bar).
    /// </summary>
    public TerminalCursorStyle CursorStyle { get; set; } = TerminalCursorStyle.Block;

    /// <summary>
    /// Whether the cursor should blink.
    /// </summary>
    public bool CursorBlink { get; set; } = true;

    /// <summary>
    /// Cursor blink rate in milliseconds.
    /// Valid range: 250-1500.
    /// </summary>
    public int CursorBlinkRate { get; set; } = 530;

    /// <summary>
    /// Whether to render bold text as bright colors.
    /// </summary>
    public bool BoldIsBright { get; set; } = true;

    /// <summary>
    /// Minimum contrast ratio for text accessibility (1.0-21.0).
    /// WCAG AA recommends 4.5:1 for normal text.
    /// </summary>
    public double MinimumContrastRatio { get; set; } = 4.5;

    /// <summary>
    /// Whether to enable font ligatures (e.g., -> becomes →).
    /// </summary>
    public bool EnableLigatures { get; set; } = true;

    // ========== Behavior ==========

    /// <summary>
    /// Number of lines to keep in scrollback buffer.
    /// Valid range: 0-1000000. 0 = unlimited.
    /// </summary>
    public int ScrollbackLines { get; set; } = 10000;

    /// <summary>
    /// Whether to enable terminal bell.
    /// </summary>
    public bool BellEnabled { get; set; } = false;

    /// <summary>
    /// Bell style (None, Audio, Visual, Both).
    /// </summary>
    public TerminalBellStyle BellStyle { get; set; } = TerminalBellStyle.Visual;

    /// <summary>
    /// Whether to automatically copy text when selected.
    /// Common on Linux terminals.
    /// </summary>
    public bool CopyOnSelect { get; set; } = false;

    /// <summary>
    /// Whether to scroll to bottom when typing.
    /// </summary>
    public bool ScrollOnInput { get; set; } = true;

    /// <summary>
    /// Whether to scroll to bottom when new output appears.
    /// </summary>
    public bool ScrollOnOutput { get; set; } = false;

    /// <summary>
    /// Characters that separate words for double-click selection.
    /// </summary>
    public string WordSeparators { get; set; } = " ()[]{}',\"`";

    /// <summary>
    /// Whether to sync terminal working directory with workspace.
    /// </summary>
    public bool SyncWithWorkspace { get; set; } = true;

    /// <summary>
    /// Whether to confirm before closing terminal with running process.
    /// </summary>
    public bool ConfirmOnClose { get; set; } = true;

    // ========== Shell Configuration ==========

    /// <summary>
    /// ID of the default shell profile (null = auto-detect).
    /// </summary>
    public string? DefaultProfileId { get; set; }

    /// <summary>
    /// User-defined shell profiles.
    /// </summary>
    public List<ShellProfile> CustomProfiles { get; set; } = new();

    // ========== Helpers ==========

    /// <summary>
    /// Gets the platform-appropriate default monospace font.
    /// </summary>
    private static string GetDefaultMonospaceFont()
    {
        if (OperatingSystem.IsWindows())
            return "Cascadia Code, Cascadia Mono, Consolas, Courier New";
        
        if (OperatingSystem.IsMacOS())
            return "SF Mono, Menlo, Monaco, Courier New";
        
        // Linux
        return "Ubuntu Mono, DejaVu Sans Mono, Liberation Mono, monospace";
    }

    /// <summary>
    /// Creates a deep copy of these settings.
    /// </summary>
    public TerminalSettings Clone()
    {
        return new TerminalSettings
        {
            FontFamily = FontFamily,
            FontSize = FontSize,
            LineHeight = LineHeight,
            LetterSpacing = LetterSpacing,
            ThemeName = ThemeName,
            CursorStyle = CursorStyle,
            CursorBlink = CursorBlink,
            CursorBlinkRate = CursorBlinkRate,
            BoldIsBright = BoldIsBright,
            MinimumContrastRatio = MinimumContrastRatio,
            EnableLigatures = EnableLigatures,
            ScrollbackLines = ScrollbackLines,
            BellEnabled = BellEnabled,
            BellStyle = BellStyle,
            CopyOnSelect = CopyOnSelect,
            ScrollOnInput = ScrollOnInput,
            ScrollOnOutput = ScrollOnOutput,
            WordSeparators = WordSeparators,
            SyncWithWorkspace = SyncWithWorkspace,
            ConfirmOnClose = ConfirmOnClose,
            DefaultProfileId = DefaultProfileId,
            CustomProfiles = CustomProfiles.Select(p => p.Clone()).ToList()
        };
    }

    /// <summary>
    /// Validates settings and returns any validation errors.
    /// </summary>
    public IReadOnlyList<string> Validate()
    {
        var errors = new List<string>();

        if (FontSize < 8 || FontSize > 72)
            errors.Add($"FontSize must be between 8 and 72, got {FontSize}");

        if (LineHeight < 1.0 || LineHeight > 3.0)
            errors.Add($"LineHeight must be between 1.0 and 3.0, got {LineHeight}");

        if (LetterSpacing < -2.0 || LetterSpacing > 5.0)
            errors.Add($"LetterSpacing must be between -2.0 and 5.0, got {LetterSpacing}");

        if (CursorBlinkRate < 250 || CursorBlinkRate > 1500)
            errors.Add($"CursorBlinkRate must be between 250 and 1500, got {CursorBlinkRate}");

        if (MinimumContrastRatio < 1.0 || MinimumContrastRatio > 21.0)
            errors.Add($"MinimumContrastRatio must be between 1.0 and 21.0, got {MinimumContrastRatio}");

        if (ScrollbackLines < 0 || ScrollbackLines > 1_000_000)
            errors.Add($"ScrollbackLines must be between 0 and 1000000, got {ScrollbackLines}");

        return errors;
    }
}
```

### 2. TerminalCursorStyle.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalCursorStyle.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Terminal cursor display styles.
/// </summary>
public enum TerminalCursorStyle
{
    /// <summary>Full block cursor (█).</summary>
    Block = 0,

    /// <summary>Underline cursor (_).</summary>
    Underline = 1,

    /// <summary>Vertical bar cursor (|).</summary>
    Bar = 2
}
```

### 3. TerminalBellStyle.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalBellStyle.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Terminal bell notification styles.
/// </summary>
public enum TerminalBellStyle
{
    /// <summary>No bell notification.</summary>
    None = 0,

    /// <summary>Audio bell (system beep).</summary>
    Audio = 1,

    /// <summary>Visual bell (screen flash).</summary>
    Visual = 2,

    /// <summary>Both audio and visual bell.</summary>
    Both = 3
}
```

### 4. TerminalTheme.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalTheme.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Terminal color theme definition with 16 ANSI colors and UI colors.
/// </summary>
public sealed class TerminalTheme
{
    /// <summary>Theme name for display.</summary>
    public string Name { get; set; } = "Custom";

    /// <summary>Whether this is a built-in theme (cannot be deleted).</summary>
    public bool IsBuiltIn { get; set; }

    // ========== Standard ANSI Colors (0-7) ==========

    /// <summary>ANSI color 0: Black.</summary>
    public string Black { get; set; } = "#000000";

    /// <summary>ANSI color 1: Red.</summary>
    public string Red { get; set; } = "#CC0000";

    /// <summary>ANSI color 2: Green.</summary>
    public string Green { get; set; } = "#00CC00";

    /// <summary>ANSI color 3: Yellow.</summary>
    public string Yellow { get; set; } = "#CCCC00";

    /// <summary>ANSI color 4: Blue.</summary>
    public string Blue { get; set; } = "#0000CC";

    /// <summary>ANSI color 5: Magenta.</summary>
    public string Magenta { get; set; } = "#CC00CC";

    /// <summary>ANSI color 6: Cyan.</summary>
    public string Cyan { get; set; } = "#00CCCC";

    /// <summary>ANSI color 7: White.</summary>
    public string White { get; set; } = "#CCCCCC";

    // ========== Bright ANSI Colors (8-15) ==========

    /// <summary>ANSI color 8: Bright Black (Gray).</summary>
    public string BrightBlack { get; set; } = "#666666";

    /// <summary>ANSI color 9: Bright Red.</summary>
    public string BrightRed { get; set; } = "#FF0000";

    /// <summary>ANSI color 10: Bright Green.</summary>
    public string BrightGreen { get; set; } = "#00FF00";

    /// <summary>ANSI color 11: Bright Yellow.</summary>
    public string BrightYellow { get; set; } = "#FFFF00";

    /// <summary>ANSI color 12: Bright Blue.</summary>
    public string BrightBlue { get; set; } = "#0000FF";

    /// <summary>ANSI color 13: Bright Magenta.</summary>
    public string BrightMagenta { get; set; } = "#FF00FF";

    /// <summary>ANSI color 14: Bright Cyan.</summary>
    public string BrightCyan { get; set; } = "#00FFFF";

    /// <summary>ANSI color 15: Bright White.</summary>
    public string BrightWhite { get; set; } = "#FFFFFF";

    // ========== UI Colors ==========

    /// <summary>Terminal background color.</summary>
    public string Background { get; set; } = "#1E1E1E";

    /// <summary>Terminal foreground (default text) color.</summary>
    public string Foreground { get; set; } = "#D4D4D4";

    /// <summary>Cursor color.</summary>
    public string Cursor { get; set; } = "#FFFFFF";

    /// <summary>Text color when under cursor.</summary>
    public string CursorText { get; set; } = "#000000";

    /// <summary>Selection background color.</summary>
    public string Selection { get; set; } = "#264F78";

    /// <summary>Selection text color.</summary>
    public string SelectionText { get; set; } = "#FFFFFF";

    /// <summary>Search highlight style.</summary>
    public SearchHighlightStyle SearchHighlight { get; set; } = new();

    // ========== Methods ==========

    /// <summary>
    /// Gets an ANSI color by index (0-15).
    /// </summary>
    public string GetAnsiColor(int index) => index switch
    {
        0 => Black,
        1 => Red,
        2 => Green,
        3 => Yellow,
        4 => Blue,
        5 => Magenta,
        6 => Cyan,
        7 => White,
        8 => BrightBlack,
        9 => BrightRed,
        10 => BrightGreen,
        11 => BrightYellow,
        12 => BrightBlue,
        13 => BrightMagenta,
        14 => BrightCyan,
        15 => BrightWhite,
        _ => Foreground
    };

    /// <summary>
    /// Sets an ANSI color by index (0-15).
    /// </summary>
    public void SetAnsiColor(int index, string color)
    {
        switch (index)
        {
            case 0: Black = color; break;
            case 1: Red = color; break;
            case 2: Green = color; break;
            case 3: Yellow = color; break;
            case 4: Blue = color; break;
            case 5: Magenta = color; break;
            case 6: Cyan = color; break;
            case 7: White = color; break;
            case 8: BrightBlack = color; break;
            case 9: BrightRed = color; break;
            case 10: BrightGreen = color; break;
            case 11: BrightYellow = color; break;
            case 12: BrightBlue = color; break;
            case 13: BrightMagenta = color; break;
            case 14: BrightCyan = color; break;
            case 15: BrightWhite = color; break;
        }
    }

    /// <summary>
    /// Creates a copy of this theme.
    /// </summary>
    public TerminalTheme Clone()
    {
        return new TerminalTheme
        {
            Name = Name,
            IsBuiltIn = false, // Cloned themes are not built-in
            Black = Black,
            Red = Red,
            Green = Green,
            Yellow = Yellow,
            Blue = Blue,
            Magenta = Magenta,
            Cyan = Cyan,
            White = White,
            BrightBlack = BrightBlack,
            BrightRed = BrightRed,
            BrightGreen = BrightGreen,
            BrightYellow = BrightYellow,
            BrightBlue = BrightBlue,
            BrightMagenta = BrightMagenta,
            BrightCyan = BrightCyan,
            BrightWhite = BrightWhite,
            Background = Background,
            Foreground = Foreground,
            Cursor = Cursor,
            CursorText = CursorText,
            Selection = Selection,
            SelectionText = SelectionText,
            SearchHighlight = SearchHighlight.Clone()
        };
    }

    // ========== Built-in Themes ==========

    /// <summary>Default dark theme.</summary>
    public static TerminalTheme DefaultDark => new()
    {
        Name = "Default Dark",
        IsBuiltIn = true,
        Background = "#1E1E1E",
        Foreground = "#D4D4D4",
        Black = "#000000",
        Red = "#CD3131",
        Green = "#0DBC79",
        Yellow = "#E5E510",
        Blue = "#2472C8",
        Magenta = "#BC3FBC",
        Cyan = "#11A8CD",
        White = "#E5E5E5",
        BrightBlack = "#666666",
        BrightRed = "#F14C4C",
        BrightGreen = "#23D18B",
        BrightYellow = "#F5F543",
        BrightBlue = "#3B8EEA",
        BrightMagenta = "#D670D6",
        BrightCyan = "#29B8DB",
        BrightWhite = "#FFFFFF",
        Cursor = "#FFFFFF",
        CursorText = "#000000",
        Selection = "#264F78",
        SelectionText = "#FFFFFF",
        SearchHighlight = SearchHighlightStyle.Dark
    };

    /// <summary>Default light theme.</summary>
    public static TerminalTheme DefaultLight => new()
    {
        Name = "Default Light",
        IsBuiltIn = true,
        Background = "#FFFFFF",
        Foreground = "#1E1E1E",
        Black = "#000000",
        Red = "#CD3131",
        Green = "#00BC00",
        Yellow = "#949800",
        Blue = "#0451A5",
        Magenta = "#BC05BC",
        Cyan = "#0598BC",
        White = "#555555",
        BrightBlack = "#666666",
        BrightRed = "#CD3131",
        BrightGreen = "#14CE14",
        BrightYellow = "#B5BA00",
        BrightBlue = "#0451A5",
        BrightMagenta = "#BC05BC",
        BrightCyan = "#0598BC",
        BrightWhite = "#A5A5A5",
        Cursor = "#000000",
        CursorText = "#FFFFFF",
        Selection = "#ADD6FF",
        SelectionText = "#000000",
        SearchHighlight = SearchHighlightStyle.Light
    };

    /// <summary>Dracula theme.</summary>
    public static TerminalTheme Dracula => new()
    {
        Name = "Dracula",
        IsBuiltIn = true,
        Background = "#282A36",
        Foreground = "#F8F8F2",
        Black = "#21222C",
        Red = "#FF5555",
        Green = "#50FA7B",
        Yellow = "#F1FA8C",
        Blue = "#BD93F9",
        Magenta = "#FF79C6",
        Cyan = "#8BE9FD",
        White = "#F8F8F2",
        BrightBlack = "#6272A4",
        BrightRed = "#FF6E6E",
        BrightGreen = "#69FF94",
        BrightYellow = "#FFFFA5",
        BrightBlue = "#D6ACFF",
        BrightMagenta = "#FF92DF",
        BrightCyan = "#A4FFFF",
        BrightWhite = "#FFFFFF",
        Cursor = "#F8F8F2",
        CursorText = "#282A36",
        Selection = "#44475A",
        SelectionText = "#F8F8F2"
    };

    /// <summary>Monokai theme.</summary>
    public static TerminalTheme Monokai => new()
    {
        Name = "Monokai",
        IsBuiltIn = true,
        Background = "#272822",
        Foreground = "#F8F8F2",
        Black = "#272822",
        Red = "#F92672",
        Green = "#A6E22E",
        Yellow = "#F4BF75",
        Blue = "#66D9EF",
        Magenta = "#AE81FF",
        Cyan = "#A1EFE4",
        White = "#F8F8F2",
        BrightBlack = "#75715E",
        BrightRed = "#F92672",
        BrightGreen = "#A6E22E",
        BrightYellow = "#F4BF75",
        BrightBlue = "#66D9EF",
        BrightMagenta = "#AE81FF",
        BrightCyan = "#A1EFE4",
        BrightWhite = "#F9F8F5",
        Cursor = "#F8F8F2",
        CursorText = "#272822",
        Selection = "#49483E",
        SelectionText = "#F8F8F2"
    };

    /// <summary>All built-in themes.</summary>
    public static IReadOnlyList<TerminalTheme> BuiltInThemes => new[]
    {
        DefaultDark,
        DefaultLight,
        Dracula,
        Monokai
    };

    /// <summary>
    /// Gets a built-in theme by name.
    /// </summary>
    public static TerminalTheme? GetBuiltInTheme(string name) =>
        BuiltInThemes.FirstOrDefault(t => 
            string.Equals(t.Name, name, StringComparison.OrdinalIgnoreCase));
}
```

### 5. IFontService.cs

**Location**: `src/AIntern.Core/Interfaces/IFontService.cs`

```csharp
namespace AIntern.Core.Interfaces;

/// <summary>
/// Service for detecting and managing available fonts.
/// </summary>
public interface IFontService
{
    /// <summary>
    /// Gets a list of available monospace fonts on the system.
    /// </summary>
    IReadOnlyList<string> GetMonospaceFonts();

    /// <summary>
    /// Checks if a specific font family is available.
    /// </summary>
    bool IsFontAvailable(string fontFamily);

    /// <summary>
    /// Gets the best available font from a comma-separated fallback list.
    /// </summary>
    /// <param name="fontList">Comma-separated font names (e.g., "SF Mono, Menlo, monospace").</param>
    /// <returns>The first available font, or "monospace" if none found.</returns>
    string GetBestAvailableFont(string fontList);

    /// <summary>
    /// Gets recommended fonts for the current platform.
    /// </summary>
    IReadOnlyList<string> GetRecommendedFonts();
}
```

### 6. FontService.cs

**Location**: `src/AIntern.Services/FontService.cs`

```csharp
namespace AIntern.Services;

using Avalonia.Media;
using Microsoft.Extensions.Logging;
using AIntern.Core.Interfaces;

/// <summary>
/// Service for detecting and managing available fonts.
/// </summary>
public sealed class FontService : IFontService
{
    private readonly ILogger<FontService> _logger;
    private readonly Lazy<List<string>> _monospaceFonts;
    private readonly Lazy<List<string>> _recommendedFonts;

    // Known monospace fonts for detection
    private static readonly string[] KnownMonospaceFonts = new[]
    {
        // Windows
        "Cascadia Code", "Cascadia Mono", "Consolas", "Courier New",
        "Lucida Console", "Source Code Pro",
        
        // macOS
        "SF Mono", "Menlo", "Monaco",
        
        // Linux
        "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono", "Noto Mono",
        
        // Cross-platform (commonly installed)
        "Fira Code", "JetBrains Mono", "Hack", "Inconsolata",
        "Roboto Mono", "IBM Plex Mono", "Anonymous Pro", "Droid Sans Mono",
        "Fantasque Sans Mono", "Input Mono", "Iosevka", "Victor Mono"
    };

    public FontService(ILogger<FontService> logger)
    {
        _logger = logger;
        _monospaceFonts = new Lazy<List<string>>(DetectMonospaceFonts);
        _recommendedFonts = new Lazy<List<string>>(GetPlatformRecommendedFonts);
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetMonospaceFonts() => _monospaceFonts.Value;

    /// <inheritdoc />
    public bool IsFontAvailable(string fontFamily)
    {
        if (string.IsNullOrWhiteSpace(fontFamily))
            return false;

        try
        {
            var typeface = new Typeface(fontFamily);
            // If we can create the typeface and get glyph info, it's available
            return typeface.GlyphTypeface != null;
        }
        catch (Exception ex)
        {
            _logger.LogDebug(ex, "Font not available: {FontFamily}", fontFamily);
            return false;
        }
    }

    /// <inheritdoc />
    public string GetBestAvailableFont(string fontList)
    {
        if (string.IsNullOrWhiteSpace(fontList))
            return "monospace";

        var fonts = fontList
            .Split(',')
            .Select(f => f.Trim())
            .Where(f => !string.IsNullOrEmpty(f));

        foreach (var font in fonts)
        {
            if (IsFontAvailable(font))
            {
                _logger.LogDebug("Selected font: {Font} from list: {FontList}", font, fontList);
                return font;
            }
        }

        _logger.LogWarning("No fonts available from list: {FontList}, falling back to monospace", fontList);
        return "monospace";
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetRecommendedFonts() => _recommendedFonts.Value;

    private List<string> DetectMonospaceFonts()
    {
        var available = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

        foreach (var font in KnownMonospaceFonts)
        {
            if (IsFontAvailable(font))
            {
                available.Add(font);
            }
        }

        var result = available.OrderBy(f => f).ToList();
        _logger.LogInformation("Detected {Count} monospace fonts", result.Count);
        
        return result;
    }

    private List<string> GetPlatformRecommendedFonts()
    {
        var recommended = new List<string>();

        if (OperatingSystem.IsWindows())
        {
            recommended.AddRange(new[] { "Cascadia Code", "Cascadia Mono", "Consolas" });
        }
        else if (OperatingSystem.IsMacOS())
        {
            recommended.AddRange(new[] { "SF Mono", "Menlo", "Monaco" });
        }
        else
        {
            recommended.AddRange(new[] { "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono" });
        }

        // Add cross-platform favorites
        recommended.AddRange(new[] { "Fira Code", "JetBrains Mono", "Hack" });

        // Filter to only available fonts
        return recommended.Where(IsFontAvailable).ToList();
    }
}
```

### 7. AppSettings Extensions

**Location**: `src/AIntern.Core/Models/AppSettings.cs` (additions)

```csharp
// Add to existing AppSettings class:

/// <summary>
/// Terminal-specific settings.
/// </summary>
public TerminalSettings Terminal { get; set; } = new();

/// <summary>
/// Custom keyboard binding overrides.
/// Key: Action name, Value: Serialized key combo (e.g., "Ctrl+Shift+C").
/// </summary>
public Dictionary<string, string>? CustomKeyBindings { get; set; }

/// <summary>
/// Custom terminal themes defined by the user.
/// </summary>
public List<TerminalTheme>? CustomThemes { get; set; }
```

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `TerminalSettings.cs` | `Core/Models/Terminal/` | Settings model |
| `TerminalCursorStyle.cs` | `Core/Models/Terminal/` | Cursor enum |
| `TerminalBellStyle.cs` | `Core/Models/Terminal/` | Bell enum |
| `TerminalTheme.cs` | `Core/Models/Terminal/` | Theme model |
| `IFontService.cs` | `Core/Interfaces/` | Font service interface |
| `FontService.cs` | `Services/` | Font detection |

### Files to Modify

| File | Changes |
|------|---------|
| `AppSettings.cs` | Add `Terminal`, `CustomKeyBindings`, `CustomThemes` |
| `DependencyInjection.cs` | Register `IFontService` |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `TerminalSettings_DefaultValues_AreValid` | Defaults pass validation |
| `TerminalSettings_Clone_CreatesDeepCopy` | Clone independence |
| `TerminalSettings_Validate_DetectsBadFontSize` | Range validation |
| `TerminalSettings_Validate_DetectsBadScrollback` | Range validation |
| `TerminalSettings_GetDefaultFont_PlatformSpecific` | Platform fonts |
| `TerminalTheme_GetAnsiColor_ReturnsCorrect` | Color indexing |
| `TerminalTheme_SetAnsiColor_UpdatesCorrect` | Color setting |
| `TerminalTheme_Clone_CreatesIndependentCopy` | Clone behavior |
| `TerminalTheme_BuiltInThemes_AreValid` | Built-in themes |
| `TerminalTheme_GetBuiltInTheme_FindsByName` | Name lookup |
| `FontService_GetMonospaceFonts_ReturnsSorted` | Font list |
| `FontService_IsFontAvailable_DetectsAvailable` | Font detection |
| `FontService_IsFontAvailable_ReturnsFalseForMissing` | Missing font |
| `FontService_GetBestAvailableFont_ReturnsFirst` | Fallback order |
| `FontService_GetBestAvailableFont_FallsBackToMonospace` | No match |
| `FontService_GetRecommendedFonts_PlatformSpecific` | Platform recs |

**Total Tests**: 16

---

## Verification

```bash
# Build projects
dotnet build src/AIntern.Core
dotnet build src/AIntern.Services

# Run unit tests
dotnet test --filter "TerminalSettings or TerminalTheme or FontService"

# Verify DI registration
grep -n "IFontService" src/AIntern.Services/DependencyInjection.cs
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | TerminalSettings has all appearance properties |
| AC-2 | TerminalSettings has all behavior properties |
| AC-3 | Default values are sensible for each platform |
| AC-4 | Settings validation catches out-of-range values |
| AC-5 | Clone creates independent deep copy |
| AC-6 | TerminalTheme has 16 ANSI colors |
| AC-7 | TerminalTheme has UI colors |
| AC-8 | Built-in themes are complete and valid |
| AC-9 | FontService detects available monospace fonts |
| AC-10 | FontService handles fallback font lists |
| AC-11 | AppSettings includes Terminal property |

---

## Changelog Entry

```markdown
## v0.5.5e - Terminal Settings Models

### Added
- `TerminalSettings` model with:
  - Appearance: FontFamily, FontSize, LineHeight, LetterSpacing
  - Theme: ThemeName, CursorStyle, CursorBlink, CursorBlinkRate
  - Text: BoldIsBright, MinimumContrastRatio, EnableLigatures
  - Behavior: ScrollbackLines, BellEnabled, BellStyle
  - Interaction: CopyOnSelect, ScrollOnInput, ScrollOnOutput
  - Integration: SyncWithWorkspace, ConfirmOnClose
  - Shell: DefaultProfileId, CustomProfiles
  - Validation and cloning support

- `TerminalCursorStyle` enum: Block, Underline, Bar

- `TerminalBellStyle` enum: None, Audio, Visual, Both

- `TerminalTheme` model with:
  - 16 ANSI colors (0-15)
  - UI colors: Background, Foreground, Cursor, Selection
  - GetAnsiColor/SetAnsiColor methods
  - Built-in themes: DefaultDark, DefaultLight, Dracula, Monokai

- `IFontService` interface and `FontService` implementation:
  - GetMonospaceFonts with lazy detection
  - IsFontAvailable using Avalonia Typeface
  - GetBestAvailableFont with fallback support
  - GetRecommendedFonts per platform

### Extended
- `AppSettings` with Terminal, CustomKeyBindings, CustomThemes
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.5e | 0.75 day |
