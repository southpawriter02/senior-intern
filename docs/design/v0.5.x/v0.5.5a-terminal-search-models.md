# Design Specification: AIntern v0.5.5a "Terminal Search Models"

## Overview

**Version**: v0.5.5a
**Parent**: v0.5.5 Polish & Integration
**Focus**: Data models for terminal search functionality

### Purpose

This sub-version defines the data models for terminal search:
1. `TerminalSearchResult` - Represents a single match within the buffer
2. `TerminalSearchState` - Maintains search state including query and results
3. `TerminalSearchOptions` - Configurable search behavior settings
4. `SearchHighlightStyle` - Visual styling for match highlighting
5. Extension methods for common search operations

### Dependencies

**From v0.5.1 (Terminal Foundation)**:
- `TerminalBuffer` - Buffer to search within

**From v0.5.2 (Terminal UI)**:
- Theme colors for highlighting integration

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                   v0.5.5a Terminal Search Models Architecture                 │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     Model Layer                                          │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalSearchResult                                                    │ │
│  │  ├── LineIndex: int (buffer line, 0-based)                              │ │
│  │  ├── StartColumn: int (match start column)                              │ │
│  │  ├── Length: int (match character length)                               │ │
│  │  ├── MatchedText: string (actual matched text)                          │ │
│  │  ├── LineContent: string (full line for context)                        │ │
│  │  ├── IsCurrent: bool (is this the focused result?)                      │ │
│  │  └── EndColumn: int (computed: StartColumn + Length)                    │ │
│  │                                                                          │ │
│  │  TerminalSearchState                                                     │ │
│  │  ├── Query: string (current search query)                               │ │
│  │  ├── CaseSensitive: bool                                                │ │
│  │  ├── UseRegex: bool                                                     │ │
│  │  ├── WrapAround: bool                                                   │ │
│  │  ├── IncludeScrollback: bool                                            │ │
│  │  ├── Results: IReadOnlyList<TerminalSearchResult>                       │ │
│  │  ├── CurrentResultIndex: int                                            │ │
│  │  ├── IsSearching: bool                                                  │ │
│  │  ├── ErrorMessage: string?                                              │ │
│  │  ├── CurrentResult: TerminalSearchResult? (computed)                    │ │
│  │  ├── HasResults: bool (computed)                                        │ │
│  │  └── ResultsSummary: string (computed: "3 of 15")                       │ │
│  │                                                                          │ │
│  │  TerminalSearchOptions                                                   │ │
│  │  ├── MaxResults: int (limit, 0 = unlimited)                             │ │
│  │  ├── DebounceDelayMs: int (incremental search delay)                    │ │
│  │  ├── MinQueryLength: int (min chars before search)                      │ │
│  │  ├── DefaultCaseSensitive: bool                                         │ │
│  │  └── DefaultUseRegex: bool                                              │ │
│  │                                                                          │ │
│  │  SearchHighlightStyle                                                    │ │
│  │  ├── MatchBackground: string (hex color)                                │ │
│  │  ├── MatchForeground: string (hex color)                                │ │
│  │  ├── CurrentMatchBackground: string (hex color)                         │ │
│  │  ├── CurrentMatchForeground: string (hex color)                         │ │
│  │  ├── CurrentMatchBorder: string (hex color)                             │ │
│  │  └── MatchOpacity: double (0.0-1.0)                                     │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Search Result Positioning

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    Search Result Coordinate System                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Terminal Buffer (with scrollback)                                           │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Line 0: (scrollback)  "$ npm install"                                  │ │
│  │ Line 1: (scrollback)  "added 523 packages"                             │ │
│  │ Line 2: (scrollback)  "$ npm test"                                     │ │
│  │ ...                                                                     │ │
│  │ Line 847:             "ERROR: Module not found: 'react'"               │ │
│  │                        ↑                     ↑                         │ │
│  │                        │StartColumn=0        │StartColumn=24          │ │
│  │                        └─ Length=5 ("ERROR") └─ Length=5 ("react")    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Search Results for "react":                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Result[0]: LineIndex=156, StartColumn=12, Length=5, "react"            │ │
│  │ Result[1]: LineIndex=289, StartColumn=45, Length=5, "react"            │ │
│  │ Result[2]: LineIndex=847, StartColumn=24, Length=5, "react" ← Current  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  CurrentResultIndex = 2                                                      │
│  ResultsSummary = "3 of 3"                                                   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## State Transitions

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Search State Transitions                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Initial State (empty)                                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Query: ""                                                               │ │
│  │ Results: []                                                             │ │
│  │ CurrentResultIndex: -1                                                  │ │
│  │ IsSearching: false                                                      │ │
│  │ HasResults: false                                                       │ │
│  │ ResultsSummary: ""                                                      │ │
│  └─────────────────────────────────────────┬──────────────────────────────┘ │
│                                            │ User types query               │
│                                            ▼                                 │
│  Searching State                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Query: "react"                                                          │ │
│  │ Results: [] (not yet populated)                                        │ │
│  │ IsSearching: true                                                       │ │
│  │ HasResults: false                                                       │ │
│  └─────────────────────────────────────────┬──────────────────────────────┘ │
│                                            │ Search completes               │
│           ┌────────────────────────────────┴────────────────────────┐       │
│           │                                                          │       │
│           ▼ Results found                                ▼ No results │       │
│  ┌────────────────────────────────┐   ┌────────────────────────────────────┐ │
│  │ Query: "react"                 │   │ Query: "nonexistent"               │ │
│  │ Results: [3 items]             │   │ Results: []                        │ │
│  │ CurrentResultIndex: 0          │   │ CurrentResultIndex: -1             │ │
│  │ IsSearching: false             │   │ IsSearching: false                 │ │
│  │ HasResults: true               │   │ HasResults: false                  │ │
│  │ ResultsSummary: "1 of 3"       │   │ ResultsSummary: "No results"       │ │
│  └────────────────────────────────┘   └────────────────────────────────────┘ │
│           │                                         │                        │
│           ▼ Next/Previous                          │ Clear search           │
│  ┌────────────────────────────────┐               │                         │
│  │ Navigation updates:            │               │                         │
│  │ CurrentResultIndex: 0 → 1      │               │                         │
│  │ ResultsSummary: "2 of 3"       │               │                         │
│  └────────────────────────────────┘               │                         │
│           │                                        │                         │
│           └────────────────────────────────────────┴─────────────────────────┤
│                                            │                                 │
│                                            ▼ Reset                           │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Back to Initial State                                                   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. TerminalSearchResult.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSearchResult.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Represents a single search result match within the terminal buffer.
/// Provides position information for highlighting and navigation.
/// </summary>
public sealed class TerminalSearchResult
{
    /// <summary>
    /// Gets the line index in the terminal buffer (0-based, including scrollback).
    /// </summary>
    public int LineIndex { get; init; }

    /// <summary>
    /// Gets the starting column of the match (0-based).
    /// </summary>
    public int StartColumn { get; init; }

    /// <summary>
    /// Gets the length of the matched text in characters.
    /// </summary>
    public int Length { get; init; }

    /// <summary>
    /// Gets the actual matched text content.
    /// </summary>
    public string MatchedText { get; init; } = string.Empty;

    /// <summary>
    /// Gets the full line content for context display.
    /// </summary>
    public string LineContent { get; init; } = string.Empty;

    /// <summary>
    /// Gets or sets whether this result is the currently selected/focused result.
    /// This property is mutable to allow navigation state updates.
    /// </summary>
    public bool IsCurrent { get; set; }

    /// <summary>
    /// Gets the ending column (exclusive) calculated from StartColumn + Length.
    /// Useful for rendering the highlight range.
    /// </summary>
    public int EndColumn => StartColumn + Length;

    /// <summary>
    /// Gets whether the match has valid content.
    /// </summary>
    public bool IsValid => Length > 0 && !string.IsNullOrEmpty(MatchedText);

    /// <summary>
    /// Gets context text before the match (for preview display).
    /// </summary>
    /// <param name="maxLength">Maximum characters to include.</param>
    /// <returns>Text before the match.</returns>
    public string GetContextBefore(int maxLength = 20)
    {
        if (StartColumn <= 0 || string.IsNullOrEmpty(LineContent))
            return string.Empty;

        var start = Math.Max(0, StartColumn - maxLength);
        var length = StartColumn - start;
        var context = LineContent.Substring(start, length);

        return start > 0 ? "..." + context : context;
    }

    /// <summary>
    /// Gets context text after the match (for preview display).
    /// </summary>
    /// <param name="maxLength">Maximum characters to include.</param>
    /// <returns>Text after the match.</returns>
    public string GetContextAfter(int maxLength = 20)
    {
        if (EndColumn >= LineContent.Length || string.IsNullOrEmpty(LineContent))
            return string.Empty;

        var available = LineContent.Length - EndColumn;
        var length = Math.Min(available, maxLength);
        var context = LineContent.Substring(EndColumn, length);

        return EndColumn + length < LineContent.Length ? context + "..." : context;
    }

    /// <summary>
    /// Creates a formatted preview string showing the match in context.
    /// </summary>
    /// <param name="beforeLength">Characters to show before match.</param>
    /// <param name="afterLength">Characters to show after match.</param>
    /// <returns>Formatted preview string.</returns>
    public string ToPreviewString(int beforeLength = 20, int afterLength = 20)
    {
        var before = GetContextBefore(beforeLength);
        var after = GetContextAfter(afterLength);
        return $"{before}[{MatchedText}]{after}";
    }

    public override string ToString()
    {
        return $"Line {LineIndex}, Col {StartColumn}-{EndColumn}: \"{MatchedText}\"";
    }
}
```

### 2. TerminalSearchState.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSearchState.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Maintains the current state of terminal search including query,
/// options, results, and navigation position.
/// </summary>
public sealed record TerminalSearchState
{
    /// <summary>
    /// Gets or sets the current search query.
    /// </summary>
    public string Query { get; init; } = string.Empty;

    /// <summary>
    /// Gets or sets whether the search should be case-sensitive.
    /// </summary>
    public bool CaseSensitive { get; init; }

    /// <summary>
    /// Gets or sets whether to interpret the query as a regular expression.
    /// </summary>
    public bool UseRegex { get; init; }

    /// <summary>
    /// Gets or sets whether to wrap around when navigating past the last/first result.
    /// </summary>
    public bool WrapAround { get; init; } = true;

    /// <summary>
    /// Gets or sets whether to search in scrollback buffer or only visible content.
    /// </summary>
    public bool IncludeScrollback { get; init; } = true;

    /// <summary>
    /// Gets the search direction for navigation.
    /// </summary>
    public SearchDirection Direction { get; init; } = SearchDirection.Forward;

    /// <summary>
    /// Gets all found search results.
    /// </summary>
    public IReadOnlyList<TerminalSearchResult> Results { get; init; } = 
        Array.Empty<TerminalSearchResult>();

    /// <summary>
    /// Gets the index of the currently selected result (-1 if none).
    /// </summary>
    public int CurrentResultIndex { get; init; } = -1;

    /// <summary>
    /// Gets whether a search is currently in progress.
    /// </summary>
    public bool IsSearching { get; init; }

    /// <summary>
    /// Gets the error message if search failed (e.g., invalid regex).
    /// </summary>
    public string? ErrorMessage { get; init; }

    // === Computed Properties ===

    /// <summary>
    /// Gets the currently selected result, or null if none selected.
    /// </summary>
    public TerminalSearchResult? CurrentResult =>
        CurrentResultIndex >= 0 && CurrentResultIndex < Results.Count
            ? Results[CurrentResultIndex]
            : null;

    /// <summary>
    /// Gets whether there are any results.
    /// </summary>
    public bool HasResults => Results.Count > 0;

    /// <summary>
    /// Gets whether the search query is valid and non-empty.
    /// </summary>
    public bool HasQuery => !string.IsNullOrEmpty(Query);

    /// <summary>
    /// Gets whether there is an error.
    /// </summary>
    public bool HasError => !string.IsNullOrEmpty(ErrorMessage);

    /// <summary>
    /// Gets the total number of results found.
    /// </summary>
    public int ResultCount => Results.Count;

    /// <summary>
    /// Gets a human-readable results summary (e.g., "3 of 15").
    /// </summary>
    public string ResultsSummary => HasResults
        ? $"{CurrentResultIndex + 1} of {Results.Count}"
        : HasQuery && !IsSearching
            ? "No results"
            : string.Empty;

    /// <summary>
    /// Gets whether navigation to the next result is possible.
    /// </summary>
    public bool CanNavigateNext => HasResults && 
        (WrapAround || CurrentResultIndex < Results.Count - 1);

    /// <summary>
    /// Gets whether navigation to the previous result is possible.
    /// </summary>
    public bool CanNavigatePrevious => HasResults && 
        (WrapAround || CurrentResultIndex > 0);

    // === Factory Methods ===

    /// <summary>
    /// Creates an empty search state.
    /// </summary>
    public static TerminalSearchState Empty => new();

    /// <summary>
    /// Creates a new state with updated results.
    /// </summary>
    public TerminalSearchState WithResults(IReadOnlyList<TerminalSearchResult> results)
    {
        return this with
        {
            Results = results,
            CurrentResultIndex = results.Count > 0 ? 0 : -1,
            IsSearching = false
        };
    }

    /// <summary>
    /// Creates a new state with an error.
    /// </summary>
    public TerminalSearchState WithError(string error)
    {
        return this with
        {
            ErrorMessage = error,
            IsSearching = false
        };
    }

    /// <summary>
    /// Creates a new state navigated to the next result.
    /// </summary>
    public TerminalSearchState NavigateNext()
    {
        if (!HasResults) return this;

        var newIndex = CurrentResultIndex + 1;
        if (newIndex >= Results.Count)
        {
            newIndex = WrapAround ? 0 : Results.Count - 1;
        }

        return this with { CurrentResultIndex = newIndex };
    }

    /// <summary>
    /// Creates a new state navigated to the previous result.
    /// </summary>
    public TerminalSearchState NavigatePrevious()
    {
        if (!HasResults) return this;

        var newIndex = CurrentResultIndex - 1;
        if (newIndex < 0)
        {
            newIndex = WrapAround ? Results.Count - 1 : 0;
        }

        return this with { CurrentResultIndex = newIndex };
    }

    /// <summary>
    /// Creates a new state navigated to a specific index.
    /// </summary>
    public TerminalSearchState NavigateToIndex(int index)
    {
        if (!HasResults) return this;

        var clampedIndex = Math.Clamp(index, 0, Results.Count - 1);
        return this with { CurrentResultIndex = clampedIndex };
    }
}

/// <summary>
/// Search direction for incremental find.
/// </summary>
public enum SearchDirection
{
    /// <summary>Search forward from current position.</summary>
    Forward,
    
    /// <summary>Search backward from current position.</summary>
    Backward
}
```

### 3. TerminalSearchOptions.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSearchOptions.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Options for configuring terminal search behavior.
/// </summary>
public sealed class TerminalSearchOptions
{
    /// <summary>
    /// Maximum number of results to return. Set to 0 for unlimited.
    /// Default: 10000
    /// </summary>
    public int MaxResults { get; set; } = 10000;

    /// <summary>
    /// Debounce delay for incremental search in milliseconds.
    /// Default: 150ms
    /// </summary>
    public int DebounceDelayMs { get; set; } = 150;

    /// <summary>
    /// Minimum query length before search starts.
    /// Default: 1
    /// </summary>
    public int MinQueryLength { get; set; } = 1;

    /// <summary>
    /// Default case sensitivity setting.
    /// Default: false (case-insensitive)
    /// </summary>
    public bool DefaultCaseSensitive { get; set; } = false;

    /// <summary>
    /// Default regex mode setting.
    /// Default: false (plain text)
    /// </summary>
    public bool DefaultUseRegex { get; set; } = false;

    /// <summary>
    /// Timeout for regex matching in milliseconds (to prevent catastrophic backtracking).
    /// Default: 5000ms
    /// </summary>
    public int RegexTimeoutMs { get; set; } = 5000;

    /// <summary>
    /// Whether to search in scrollback buffer by default.
    /// Default: true
    /// </summary>
    public bool DefaultIncludeScrollback { get; set; } = true;

    /// <summary>
    /// Whether to wrap around when reaching end of results.
    /// Default: true
    /// </summary>
    public bool DefaultWrapAround { get; set; } = true;

    /// <summary>
    /// Whether to highlight all matches or only the current one.
    /// Default: true (highlight all)
    /// </summary>
    public bool HighlightAllMatches { get; set; } = true;

    /// <summary>
    /// Whether to auto-scroll to current match.
    /// Default: true
    /// </summary>
    public bool AutoScrollToMatch { get; set; } = true;

    // === Presets ===

    /// <summary>
    /// Default options for most use cases.
    /// </summary>
    public static TerminalSearchOptions Default => new();

    /// <summary>
    /// Options optimized for large terminals/buffers.
    /// </summary>
    public static TerminalSearchOptions LargeBuffer => new()
    {
        MaxResults = 50000,
        DebounceDelayMs = 300,
        MinQueryLength = 2
    };

    /// <summary>
    /// Options for quick find (smaller debounce).
    /// </summary>
    public static TerminalSearchOptions QuickFind => new()
    {
        MaxResults = 1000,
        DebounceDelayMs = 50,
        MinQueryLength = 1
    };

    /// <summary>
    /// Creates a copy of these options.
    /// </summary>
    public TerminalSearchOptions Clone()
    {
        return new TerminalSearchOptions
        {
            MaxResults = MaxResults,
            DebounceDelayMs = DebounceDelayMs,
            MinQueryLength = MinQueryLength,
            DefaultCaseSensitive = DefaultCaseSensitive,
            DefaultUseRegex = DefaultUseRegex,
            RegexTimeoutMs = RegexTimeoutMs,
            DefaultIncludeScrollback = DefaultIncludeScrollback,
            DefaultWrapAround = DefaultWrapAround,
            HighlightAllMatches = HighlightAllMatches,
            AutoScrollToMatch = AutoScrollToMatch
        };
    }
}
```

### 4. SearchHighlightStyle.cs

**Location**: `src/AIntern.Core/Models/Terminal/SearchHighlightStyle.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Visual styling configuration for search result highlights.
/// Colors are specified as hex strings for cross-platform compatibility.
/// </summary>
public sealed class SearchHighlightStyle
{
    /// <summary>
    /// Background color for matched text (hex, e.g., "#FFFF00").
    /// Default: Yellow
    /// </summary>
    public string MatchBackground { get; set; } = "#FFFF00";

    /// <summary>
    /// Foreground color for matched text (hex).
    /// Default: Black
    /// </summary>
    public string MatchForeground { get; set; } = "#000000";

    /// <summary>
    /// Background color for the currently focused match (hex).
    /// Default: Orange
    /// </summary>
    public string CurrentMatchBackground { get; set; } = "#FF8C00";

    /// <summary>
    /// Foreground color for the currently focused match (hex).
    /// Default: Black
    /// </summary>
    public string CurrentMatchForeground { get; set; } = "#000000";

    /// <summary>
    /// Border color for the currently focused match (hex).
    /// Default: OrangeRed
    /// </summary>
    public string CurrentMatchBorder { get; set; } = "#FF4500";

    /// <summary>
    /// Border thickness for the current match in pixels.
    /// Default: 1
    /// </summary>
    public int CurrentMatchBorderThickness { get; set; } = 1;

    /// <summary>
    /// Opacity for non-current matches (0.0-1.0).
    /// Default: 0.7
    /// </summary>
    public double MatchOpacity { get; set; } = 0.7;

    /// <summary>
    /// Whether to use a box/outline style instead of solid background.
    /// Default: false
    /// </summary>
    public bool UseOutlineStyle { get; set; } = false;

    // === Theme Presets ===

    /// <summary>
    /// Default yellow highlighting style.
    /// </summary>
    public static SearchHighlightStyle Default => new();

    /// <summary>
    /// Dark theme compatible highlighting.
    /// </summary>
    public static SearchHighlightStyle Dark => new()
    {
        MatchBackground = "#3A3D41",
        MatchForeground = "#FFD700",
        CurrentMatchBackground = "#515C6B",
        CurrentMatchForeground = "#FFFFFF",
        CurrentMatchBorder = "#007ACC",
        MatchOpacity = 0.9
    };

    /// <summary>
    /// Light theme compatible highlighting.
    /// </summary>
    public static SearchHighlightStyle Light => new()
    {
        MatchBackground = "#FFFACD",
        MatchForeground = "#000000",
        CurrentMatchBackground = "#FFD700",
        CurrentMatchForeground = "#000000",
        CurrentMatchBorder = "#FF8C00",
        MatchOpacity = 0.8
    };

    /// <summary>
    /// High contrast/accessibility highlighting.
    /// </summary>
    public static SearchHighlightStyle HighContrast => new()
    {
        MatchBackground = "#00FF00",
        MatchForeground = "#000000",
        CurrentMatchBackground = "#FF00FF",
        CurrentMatchForeground = "#FFFFFF",
        CurrentMatchBorder = "#FFFFFF",
        CurrentMatchBorderThickness = 2,
        MatchOpacity = 1.0
    };

    /// <summary>
    /// Creates a style appropriate for the given theme.
    /// </summary>
    public static SearchHighlightStyle ForTheme(bool isDarkTheme)
    {
        return isDarkTheme ? Dark : Light;
    }

    /// <summary>
    /// Creates a copy of this style.
    /// </summary>
    public SearchHighlightStyle Clone()
    {
        return new SearchHighlightStyle
        {
            MatchBackground = MatchBackground,
            MatchForeground = MatchForeground,
            CurrentMatchBackground = CurrentMatchBackground,
            CurrentMatchForeground = CurrentMatchForeground,
            CurrentMatchBorder = CurrentMatchBorder,
            CurrentMatchBorderThickness = CurrentMatchBorderThickness,
            MatchOpacity = MatchOpacity,
            UseOutlineStyle = UseOutlineStyle
        };
    }
}
```

### 5. TerminalSearchExtensions.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSearchExtensions.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Extension methods for terminal search functionality.
/// </summary>
public static class TerminalSearchExtensions
{
    /// <summary>
    /// Checks if a result is within the visible viewport.
    /// </summary>
    /// <param name="result">The search result.</param>
    /// <param name="firstVisibleLine">First visible line index.</param>
    /// <param name="visibleLineCount">Number of visible lines.</param>
    /// <returns>True if the result is visible.</returns>
    public static bool IsVisible(
        this TerminalSearchResult result,
        int firstVisibleLine,
        int visibleLineCount)
    {
        return result.LineIndex >= firstVisibleLine &&
               result.LineIndex < firstVisibleLine + visibleLineCount;
    }

    /// <summary>
    /// Filters results to only those in the visible viewport.
    /// </summary>
    public static IEnumerable<TerminalSearchResult> GetVisibleResults(
        this TerminalSearchState state,
        int firstVisibleLine,
        int visibleLineCount)
    {
        return state.Results.Where(r => r.IsVisible(firstVisibleLine, visibleLineCount));
    }

    /// <summary>
    /// Gets the line indices that contain matches (for scroll bar markers).
    /// </summary>
    public static IReadOnlySet<int> GetMatchingLineIndices(this TerminalSearchState state)
    {
        return state.Results.Select(r => r.LineIndex).ToHashSet();
    }

    /// <summary>
    /// Finds the nearest result to a given line.
    /// </summary>
    public static int FindNearestResultIndex(
        this TerminalSearchState state,
        int lineIndex,
        SearchDirection direction = SearchDirection.Forward)
    {
        if (!state.HasResults) return -1;

        var results = state.Results;

        if (direction == SearchDirection.Forward)
        {
            for (int i = 0; i < results.Count; i++)
            {
                if (results[i].LineIndex >= lineIndex)
                    return i;
            }
            return state.WrapAround ? 0 : results.Count - 1;
        }
        else
        {
            for (int i = results.Count - 1; i >= 0; i--)
            {
                if (results[i].LineIndex <= lineIndex)
                    return i;
            }
            return state.WrapAround ? results.Count - 1 : 0;
        }
    }

    /// <summary>
    /// Creates a description of the search for logging/display.
    /// </summary>
    public static string ToDescription(this TerminalSearchState state)
    {
        var parts = new List<string>();
        
        parts.Add($"Query: \"{state.Query}\"");
        
        if (state.CaseSensitive)
            parts.Add("Case-sensitive");
        
        if (state.UseRegex)
            parts.Add("Regex");
        
        parts.Add($"Results: {state.ResultCount}");
        
        if (state.HasResults)
            parts.Add($"Current: {state.CurrentResultIndex + 1}");
        
        return string.Join(", ", parts);
    }
}
```

---

## File Summary

| File | Location | Purpose |
|------|----------|---------|
| `TerminalSearchResult.cs` | `src/AIntern.Core/Models/Terminal/` | Single match result |
| `TerminalSearchState.cs` | `src/AIntern.Core/Models/Terminal/` | Search state container |
| `TerminalSearchOptions.cs` | `src/AIntern.Core/Models/Terminal/` | Search configuration |
| `SearchHighlightStyle.cs` | `src/AIntern.Core/Models/Terminal/` | Visual highlight styling |
| `TerminalSearchExtensions.cs` | `src/AIntern.Core/Models/Terminal/` | Extension methods |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `TerminalSearchResult_EndColumn_CalculatesCorrectly` | StartColumn + Length |
| `TerminalSearchResult_GetContextBefore_TruncatesWithEllipsis` | Context extraction |
| `TerminalSearchResult_GetContextAfter_TruncatesWithEllipsis` | Context extraction |
| `TerminalSearchResult_ToPreviewString_FormatsCorrectly` | Preview format |
| `TerminalSearchState_CurrentResult_ReturnsNullWhenEmpty` | No results |
| `TerminalSearchState_CurrentResult_ReturnsCorrectResult` | Valid index |
| `TerminalSearchState_HasResults_ReturnsTrueWhenPopulated` | Results present |
| `TerminalSearchState_ResultsSummary_FormatsCorrectly` | "3 of 15" format |
| `TerminalSearchState_ResultsSummary_ShowsNoResults` | Empty query state |
| `TerminalSearchState_NavigateNext_WrapsAround` | Wrap to start |
| `TerminalSearchState_NavigateNext_StopsAtEnd` | No wrap |
| `TerminalSearchState_NavigatePrevious_WrapsAround` | Wrap to end |
| `TerminalSearchState_NavigatePrevious_StopsAtStart` | No wrap |
| `TerminalSearchState_NavigateToIndex_ClampsToRange` | Index clamping |
| `TerminalSearchState_WithResults_SetsIndexToZero` | First result |
| `TerminalSearchState_WithError_SetsErrorMessage` | Error state |
| `TerminalSearchOptions_Presets_HaveCorrectValues` | Default, LargeBuffer, QuickFind |
| `TerminalSearchOptions_Clone_CreatesIndependentCopy` | Clone behavior |
| `SearchHighlightStyle_ForTheme_ReturnsDarkStyle` | Dark theme |
| `SearchHighlightStyle_ForTheme_ReturnsLightStyle` | Light theme |
| `Extensions_IsVisible_ReturnsTrueWhenInViewport` | Visibility check |
| `Extensions_GetMatchingLineIndices_ReturnsUniqueLines` | Line set |
| `Extensions_FindNearestResultIndex_Forward` | Forward search |
| `Extensions_FindNearestResultIndex_Backward` | Backward search |

**Total Tests**: 24

---

## Verification

```bash
# Build the core project
dotnet build src/AIntern.Core

# Run unit tests
dotnet test --filter "TerminalSearch"

# Verify files exist
ls -la src/AIntern.Core/Models/Terminal/Terminal*.cs
ls -la src/AIntern.Core/Models/Terminal/Search*.cs
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | TerminalSearchResult captures line, column, and match text |
| AC-2 | EndColumn computed property is correct |
| AC-3 | Context before/after methods work with truncation |
| AC-4 | TerminalSearchState is immutable (record type) |
| AC-5 | ResultsSummary formats as "X of Y" |
| AC-6 | Navigation methods update CurrentResultIndex correctly |
| AC-7 | Wrap-around works in both directions |
| AC-8 | TerminalSearchOptions has sensible defaults |
| AC-9 | Option presets (Default, LargeBuffer, QuickFind) are available |
| AC-10 | SearchHighlightStyle has theme-appropriate presets |
| AC-11 | Extension methods for viewport filtering work |
| AC-12 | All models have XML documentation |

---

## Changelog Entry

```markdown
## v0.5.5a - Terminal Search Models

### Added
- `TerminalSearchResult` model:
  - Line index, column, and length positioning
  - Context extraction methods (GetContextBefore, GetContextAfter)
  - Preview string formatting
  - IsCurrent flag for navigation

- `TerminalSearchState` record:
  - Query, CaseSensitive, UseRegex options
  - WrapAround, IncludeScrollback flags
  - Results collection and CurrentResultIndex
  - IsSearching, ErrorMessage state
  - Computed: CurrentResult, HasResults, ResultsSummary
  - Navigation methods: NavigateNext, NavigatePrevious, NavigateToIndex
  - Factory methods: Empty, WithResults, WithError

- `TerminalSearchOptions` class:
  - MaxResults, DebounceDelayMs, MinQueryLength
  - Default value presets (Default, LargeBuffer, QuickFind)
  - RegexTimeoutMs for safety

- `SearchHighlightStyle` class:
  - Match and CurrentMatch color properties
  - Opacity and border settings
  - Theme presets (Dark, Light, HighContrast)

- `TerminalSearchExtensions` static class:
  - IsVisible, GetVisibleResults viewport filtering
  - GetMatchingLineIndices for scroll markers
  - FindNearestResultIndex for navigation
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.5a | 0.5 day |
