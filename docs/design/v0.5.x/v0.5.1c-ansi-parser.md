# Design Specification: AIntern v0.5.1c "ANSI Parser"

**Status**: _PLANNED_

## Executive Summary

This document provides a detailed implementation specification for v0.5.1c, which implements a robust VT100/ANSI escape sequence parser. The parser processes terminal output streams, interprets escape sequences, and updates the terminal buffer accordingly. This sub-part depends on v0.5.1b (Terminal Models) and is a prerequisite for v0.5.1d (Terminal Service).

### v0.5.1c Scope (from v0.5.1-terminal-foundation.md)

- Define `AnsiParserState` enum for state machine states
- Implement `AnsiParser` sealed class for VT100/ANSI escape sequence parsing
- Support C0 control characters (NUL, BEL, BS, HT, LF, VT, FF, CR, SO, SI, ESC, CAN, SUB)
- Support CSI (Control Sequence Introducer) commands for cursor and screen manipulation
- Support SGR (Select Graphic Rendition) for text colors and styling
- Support extended color modes (256-color palette and 24-bit true color)
- Support DEC private modes (cursor visibility, origin mode, auto-wrap, alternate screen)
- Support OSC (Operating System Command) for title, working directory, and hyperlinks
- Support DCS and SOS/PM/APC string handling

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| AnsiParserState.cs | Enum defining parser state machine states |
| AnsiParser.cs | Sealed class implementing VT100/ANSI escape sequence parsing |

### Related Documents

- @v0.5.0-integrated-terminal.md - Parent design specification
- @v0.5.1-terminal-foundation.md - Sub-version specification with all parts (a-f)
- @v0.5.1b-terminal-models.md - Terminal models specification (prerequisite)

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.5.1c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ANSI Parser (src/AIntern.Core/Terminal/)                         │
│  │                                                                │
│  ├── AnsiParserState.cs                                           │
│  │   └── Enum: Parser state machine states                        │
│  │       ├── Ground           - Normal character processing       │
│  │       ├── Escape           - Received ESC (0x1B)               │
│  │       ├── EscapeIntermediate - ESC + intermediate byte         │
│  │       ├── CsiEntry         - Control Sequence Introducer       │
│  │       ├── CsiParam         - Collecting CSI parameters         │
│  │       ├── CsiIntermediate  - CSI intermediate bytes            │
│  │       ├── OscString        - Operating System Command          │
│  │       ├── DcsEntry         - Device Control String             │
│  │       ├── DcsParam         - DCS parameters                    │
│  │       ├── DcsIntermediate  - DCS intermediate bytes            │
│  │       ├── DcsPassthrough   - DCS passthrough mode              │
│  │       └── SosPmApcString   - SOS/PM/APC string                 │
│  │                                                                │
│  └── AnsiParser.cs                                                │
│      └── Sealed Class: VT100/ANSI escape sequence parser          │
│          ├── C0 Control Character Handling                        │
│          ├── CSI Sequence Processing                              │
│          ├── SGR (Color/Style) Execution                          │
│          ├── DEC Private Mode Handling                            │
│          ├── OSC Command Processing                               │
│          └── Events (Bell, TitleChanged, WorkingDirectory, etc.)  │
│                                                                   │
│  Namespace: AIntern.Core.Terminal                                 │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Parser State Machine

```
┌─────────────────────────────────────────────────────────────────┐
│                   ANSI Parser State Machine                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                         ┌───────────┐                            │
│               ┌────────▶│  Ground   │◀────────┐                  │
│               │         └─────┬─────┘         │                  │
│               │               │ ESC (0x1B)    │                  │
│               │               ▼               │                  │
│               │         ┌───────────┐         │                  │
│               │         │  Escape   │─────────┼──────────┐       │
│               │         └─────┬─────┘         │          │       │
│               │               │               │          │       │
│      ┌────────┴───────┬───────┴───────┬───────┘          │       │
│      │                │               │                  │       │
│      ▼                ▼               ▼                  ▼       │
│ ┌─────────┐    ┌───────────┐   ┌───────────┐     ┌───────────┐  │
│ │CsiEntry │    │ OscString │   │ DcsEntry  │     │SosPmApc   │  │
│ └────┬────┘    └─────┬─────┘   └─────┬─────┘     │  String   │  │
│      │               │               │           └─────┬─────┘  │
│      ▼               │               │                 │        │
│ ┌─────────┐          │               ▼                 │        │
│ │CsiParam │          │         ┌───────────┐           │        │
│ └────┬────┘          │         │ DcsParam  │           │        │
│      │               │         └─────┬─────┘           │        │
│      ▼               │               │                 │        │
│ ┌────────────┐       │               ▼                 │        │
│ │CsiInter-   │       │         ┌───────────┐           │        │
│ │  mediate   │       │         │DcsInter-  │           │        │
│ └────┬───────┘       │         │  mediate  │           │        │
│      │               │         └─────┬─────┘           │        │
│      │               │               │                 │        │
│      │               │               ▼                 │        │
│      │               │         ┌───────────┐           │        │
│      │               │         │Dcs        │           │        │
│      │               │         │Passthrough│           │        │
│      │               │         └─────┬─────┘           │        │
│      │               │               │                 │        │
│      └───────────────┴───────────────┴─────────────────┘        │
│                               │                                  │
│                    Final byte / ST (String Terminator)           │
│                               │                                  │
│                               ▼                                  │
│                         Back to Ground                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Parser Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Parser Data Flow                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   PTY Output Stream                                              │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐                                                │
│  │  AnsiParser  │                                                │
│  │              │                                                │
│  │  Parse(data) │───────────────────────────────────────────┐    │
│  └──────┬───────┘                                           │    │
│         │                                                   │    │
│         ▼                                                   │    │
│  ┌─────────────────────────────────────────────────────┐   │    │
│  │                 ProcessByte(b)                       │   │    │
│  │                                                      │   │    │
│  │  ┌───────────────────────────────────────────────┐  │   │    │
│  │  │  C0 Control (0x00-0x1F)                        │  │   │    │
│  │  │  ├── NUL (0x00) → Ignore                       │  │   │    │
│  │  │  ├── BEL (0x07) → Bell event / OSC terminator  │  │   │    │
│  │  │  ├── BS  (0x08) → buffer.Backspace()           │  │   │    │
│  │  │  ├── HT  (0x09) → buffer.Tab()                 │  │   │    │
│  │  │  ├── LF/VT/FF   → buffer.LineFeed()            │  │   │    │
│  │  │  ├── CR  (0x0D) → buffer.CarriageReturn()      │  │   │    │
│  │  │  ├── ESC (0x1B) → State = Escape               │  │   │    │
│  │  │  └── CAN/SUB    → Cancel, State = Ground       │  │   │    │
│  │  └───────────────────────────────────────────────┘  │   │    │
│  │                                                      │   │    │
│  │  ┌───────────────────────────────────────────────┐  │   │    │
│  │  │  Printable (0x20-0x7E, 0x80+)                  │  │   │    │
│  │  │  └── buffer.WriteChar()                        │  │   │    │
│  │  └───────────────────────────────────────────────┘  │   │    │
│  │                                                      │   │    │
│  └──────────────────────────────────────────────────────┘   │    │
│         │                                                   │    │
│         ▼                                                   │    │
│  ┌────────────────────────────────────────────────────────┐│    │
│  │  Terminal Buffer Methods Called                         ││    │
│  │  ├── WriteChar(c)         - Write character             ││    │
│  │  ├── CursorUp/Down/etc.   - Cursor movement             ││    │
│  │  ├── Clear/ClearLine/etc. - Screen clearing             ││    │
│  │  ├── ScrollUp/ScrollDown  - Scrolling                   ││    │
│  │  ├── InsertLines/DeleteLines                            ││    │
│  │  ├── InsertChars/DeleteChars                            ││    │
│  │  ├── SaveCursor/RestoreCursor                           ││    │
│  │  └── SetScrollRegion      - Margins                     ││    │
│  └────────────────────────────────────────────────────────┘│    │
│         │                                                   │    │
│         │        Events Raised                              │    │
│         │        ├── Bell()                                 │    │
│         │        ├── TitleChanged(title)                    │    │
│         │        ├── WorkingDirectoryChanged(path)          │    │
│         │        └── HyperlinkDetected(params, uri)         │    │
│         │                                                   │    │
│         ▼                                                   ▼    │
│  ┌──────────────┐                                ┌──────────────┐│
│  │TerminalBuffer│                                │ Event        ││
│  │  (Updated)   │                                │ Subscribers  ││
│  └──────────────┘                                └──────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### CSI Sequence Processing

```
┌─────────────────────────────────────────────────────────────────┐
│               CSI (Control Sequence Introducer)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Format: ESC [ <params> <intermediate> <final>                   │
│          0x1B 0x5B                                               │
│                                                                  │
│  Example: ESC [ 1 ; 2 H                                          │
│           │   │ │ │ │ └── Final: 'H' (CUP - Cursor Position)    │
│           │   │ │ │ └──── Separator                              │
│           │   │ │ └────── Param 2: column                        │
│           │   │ └──────── Separator                              │
│           │   └────────── Param 1: row                           │
│           └────────────── CSI introducer                         │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Supported CSI Commands                                  │    │
│  │                                                          │    │
│  │  Cursor Movement:                                        │    │
│  │  ├── A  CUU   Cursor Up                                  │    │
│  │  ├── B  CUD   Cursor Down                                │    │
│  │  ├── C  CUF   Cursor Forward                             │    │
│  │  ├── D  CUB   Cursor Back                                │    │
│  │  ├── E  CNL   Cursor Next Line                           │    │
│  │  ├── F  CPL   Cursor Previous Line                       │    │
│  │  ├── G  CHA   Cursor Horizontal Absolute                 │    │
│  │  ├── H  CUP   Cursor Position                            │    │
│  │  ├── d  VPA   Vertical Position Absolute                 │    │
│  │  ├── f  HVP   Horizontal Vertical Position               │    │
│  │  ├── s       Save Cursor (SCO)                           │    │
│  │  └── u       Restore Cursor (SCO)                        │    │
│  │                                                          │    │
│  │  Screen Clearing:                                        │    │
│  │  ├── J  ED    Erase in Display                           │    │
│  │  │      0 = to end, 1 = to start, 2 = all, 3 = scrollback│    │
│  │  └── K  EL    Erase in Line                              │    │
│  │         0 = to end, 1 = to start, 2 = entire line        │    │
│  │                                                          │    │
│  │  Line Operations:                                        │    │
│  │  ├── L  IL    Insert Lines                               │    │
│  │  └── M  DL    Delete Lines                               │    │
│  │                                                          │    │
│  │  Character Operations:                                   │    │
│  │  ├── @  ICH   Insert Characters                          │    │
│  │  ├── P  DCH   Delete Characters                          │    │
│  │  └── X  ECH   Erase Characters                           │    │
│  │                                                          │    │
│  │  Scrolling:                                              │    │
│  │  ├── S  SU    Scroll Up                                  │    │
│  │  ├── T  SD    Scroll Down                                │    │
│  │  └── r DECSTBM Set Top/Bottom Margins                    │    │
│  │                                                          │    │
│  │  Styling:                                                │    │
│  │  └── m  SGR   Select Graphic Rendition                   │    │
│  │                                                          │    │
│  │  Modes:                                                  │    │
│  │  ├── h  SM    Set Mode / DECSET (with ?)                 │    │
│  │  └── l  RM    Reset Mode / DECRST (with ?)               │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### SGR (Select Graphic Rendition) Processing

```
┌─────────────────────────────────────────────────────────────────┐
│              SGR (Select Graphic Rendition)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Format: ESC [ <params> m                                        │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Basic Attributes                                        │    │
│  │                                                          │    │
│  │  Code │ Effect              │ Reset Code                 │    │
│  │  ─────┼─────────────────────┼────────────                │    │
│  │   0   │ Reset all           │ -                          │    │
│  │   1   │ Bold                │ 22                         │    │
│  │   2   │ Dim                 │ 22                         │    │
│  │   3   │ Italic              │ 23                         │    │
│  │   4   │ Underline           │ 24                         │    │
│  │   5   │ Blink (slow)        │ 25                         │    │
│  │   6   │ Blink (rapid)       │ 25                         │    │
│  │   7   │ Inverse             │ 27                         │    │
│  │   8   │ Hidden              │ 28                         │    │
│  │   9   │ Strikethrough       │ 29                         │    │
│  │  21   │ Double underline    │ 24                         │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Color Codes                                             │    │
│  │                                                          │    │
│  │  Standard Colors (8 colors):                             │    │
│  │  ├── 30-37: Foreground (Black..White)                    │    │
│  │  └── 40-47: Background (Black..White)                    │    │
│  │                                                          │    │
│  │  Bright Colors (8 colors):                               │    │
│  │  ├── 90-97: Bright foreground                            │    │
│  │  └── 100-107: Bright background                          │    │
│  │                                                          │    │
│  │  Default Colors:                                         │    │
│  │  ├── 39: Default foreground                              │    │
│  │  └── 49: Default background                              │    │
│  │                                                          │    │
│  │  Extended Colors:                                        │    │
│  │  ├── 38;5;n: 256-color foreground                        │    │
│  │  ├── 48;5;n: 256-color background                        │    │
│  │  ├── 38;2;r;g;b: True color foreground                   │    │
│  │  └── 48;2;r;g;b: True color background                   │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Example: ESC[1;31;44m = Bold + Red FG + Blue BG                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### DEC Private Modes

```
┌─────────────────────────────────────────────────────────────────┐
│                     DEC Private Modes                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Format: ESC [ ? <mode> h    (DECSET - enable)                   │
│          ESC [ ? <mode> l    (DECRST - disable)                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Supported DEC Modes                                     │    │
│  │                                                          │    │
│  │  Mode  │ Name    │ Description                           │    │
│  │  ──────┼─────────┼────────────────────────────────────── │    │
│  │    1   │ DECCKM  │ Cursor keys mode (App vs Normal)      │    │
│  │    6   │ DECOM   │ Origin mode (relative to margins)     │    │
│  │    7   │ DECAWM  │ Auto-wrap mode                        │    │
│  │   25   │ DECTCEM │ Text cursor enable (visibility)       │    │
│  │   47   │ -       │ Alternate screen buffer (old)         │    │
│  │ 1047   │ -       │ Alternate screen buffer               │    │
│  │ 1049   │ -       │ Alternate buffer + save cursor        │    │
│  │ 2004   │ -       │ Bracketed paste mode                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Example: ESC[?25l = Hide cursor                                 │
│           ESC[?25h = Show cursor                                 │
│           ESC[?1049h = Switch to alternate screen                │
│           ESC[?1049l = Switch back to main screen                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### OSC (Operating System Command) Processing

```
┌─────────────────────────────────────────────────────────────────┐
│              OSC (Operating System Command)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Format: ESC ] <command> ; <argument> <terminator>               │
│          0x1B 0x5D                      BEL (0x07) or ST         │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Supported OSC Commands                                  │    │
│  │                                                          │    │
│  │  Cmd │ Description              │ Example                │    │
│  │  ────┼──────────────────────────┼──────────────────────  │    │
│  │  0   │ Set icon name and title  │ ESC]0;My Title BEL     │    │
│  │  1   │ Set icon name            │ ESC]1;Icon BEL         │    │
│  │  2   │ Set window title         │ ESC]2;Window BEL       │    │
│  │  7   │ Set working directory    │ ESC]7;file:///path BEL │    │
│  │  8   │ Hyperlink                │ ESC]8;params;uri BEL   │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  OSC 7 (Working Directory):                                      │
│  ├── Format: file://hostname/path                                │
│  ├── Extracts path starting after hostname                       │
│  └── Raises WorkingDirectoryChanged event                        │
│                                                                  │
│  OSC 8 (Hyperlink):                                              │
│  ├── Start: ESC]8;params;https://example.com BEL                 │
│  ├── End:   ESC]8;; BEL (empty URI to end hyperlink)             │
│  └── Raises HyperlinkDetected event                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### 1. AnsiParserState.cs

**Location**: `src/AIntern.Core/Terminal/AnsiParserState.cs`
**Type**: `enum`
**Purpose**: Defines the state machine states for ANSI escape sequence parsing

```
┌─────────────────────────────────────────────────────────────────┐
│                    AnsiParserState Design                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Terminal                                │
│                                                                  │
│  Values:                                                         │
│  ├── Ground           - Normal character processing              │
│  ├── Escape           - Received ESC (0x1B)                      │
│  ├── EscapeIntermediate - ESC + intermediate byte (0x20-0x2F)    │
│  ├── CsiEntry         - CSI entry (ESC [)                        │
│  ├── CsiParam         - Collecting CSI parameters                │
│  ├── CsiIntermediate  - CSI intermediate bytes                   │
│  ├── OscString        - OSC string collection (ESC ])            │
│  ├── DcsEntry         - DCS entry (ESC P)                        │
│  ├── DcsParam         - DCS parameter collection                 │
│  ├── DcsIntermediate  - DCS intermediate bytes                   │
│  ├── DcsPassthrough   - DCS passthrough mode                     │
│  └── SosPmApcString   - SOS/PM/APC string collection             │
│                                                                  │
│  State Transition Triggers:                                      │
│  ├── ESC (0x1B)       → Escape                                   │
│  ├── ESC [            → CsiEntry                                 │
│  ├── ESC ]            → OscString                                │
│  ├── ESC P            → DcsEntry                                 │
│  ├── ESC X/^/_        → SosPmApcString                           │
│  ├── Final byte       → Ground (execute command)                 │
│  ├── BEL/ST           → Ground (terminate string)                │
│  └── CAN/SUB          → Ground (cancel sequence)                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Implementation Notes**:
- Each state represents a distinct phase in escape sequence parsing
- Ground is the default state for normal character processing
- CsiEntry/CsiParam/CsiIntermediate form the CSI processing pipeline
- OscString collects OSC command content until terminator
- DCS states handle Device Control String sequences
- SosPmApcString handles SOS, PM, and APC sequences (mostly ignored)

---

### 2. AnsiParser.cs

**Location**: `src/AIntern.Core/Terminal/AnsiParser.cs`
**Type**: `sealed class`
**Purpose**: Parses VT100/ANSI escape sequences and updates the terminal buffer

```
┌─────────────────────────────────────────────────────────────────┐
│                      AnsiParser Design                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Namespace: AIntern.Core.Terminal                                │
│  Dependencies: AIntern.Core.Models.Terminal                      │
│                                                                  │
│  Private Fields:                                                 │
│  ├── _buffer: TerminalBuffer         - Target buffer             │
│  ├── _state: AnsiParserState         - Current parser state      │
│  ├── _params: List<int>              - CSI parameter list        │
│  ├── _intermediates: StringBuilder   - Intermediate bytes        │
│  ├── _oscString: StringBuilder       - OSC string content        │
│  ├── _currentParam: int              - Current parameter value   │
│  └── _paramStarted: bool             - Parameter parsing flag    │
│                                                                  │
│  Events:                                                         │
│  ├── Bell: Action?                   - BEL character received    │
│  ├── TitleChanged: Action<string>?   - OSC 0/1/2 title change    │
│  ├── WorkingDirectoryChanged: Action<string>? - OSC 7            │
│  └── HyperlinkDetected: Action<string?, string>? - OSC 8         │
│                                                                  │
│  Constructor:                                                    │
│  └── AnsiParser(TerminalBuffer buffer)                           │
│                                                                  │
│  Public Methods:                                                 │
│  ├── Parse(ReadOnlySpan<byte> data)  - Parse byte sequence       │
│  └── Parse(string text)              - Parse string (UTF-8)      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### AnsiParser Private Methods (Part 1: Main Processing)

```
┌─────────────────────────────────────────────────────────────────┐
│                  AnsiParser Methods (1/4)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ProcessByte(byte b):                                            │
│  ├── If b < 0x20: ProcessC0Control(b) → if true, return         │
│  └── Switch on _state:                                           │
│      ├── Ground            → ProcessGround(b)                    │
│      ├── Escape            → ProcessEscape(b)                    │
│      ├── EscapeIntermediate→ ProcessEscapeIntermediate(b)        │
│      ├── CsiEntry/CsiParam → ProcessCsi(b)                       │
│      ├── CsiIntermediate   → ProcessCsiIntermediate(b)           │
│      ├── OscString         → ProcessOsc(b)                       │
│      ├── DcsEntry-DcsPass. → ProcessDcs(b)                       │
│      └── SosPmApcString    → ProcessSosPmApc(b)                  │
│                                                                  │
│  ProcessC0Control(byte b) → bool:                                │
│  ├── 0x00 NUL  → Ignore, return true                             │
│  ├── 0x07 BEL  → If OscString: ExecuteOsc(); else: Bell event    │
│  ├── 0x08 BS   → buffer.Backspace()                              │
│  ├── 0x09 HT   → buffer.Tab()                                    │
│  ├── 0x0A LF   → buffer.LineFeed()                               │
│  ├── 0x0B VT   → buffer.LineFeed()                               │
│  ├── 0x0C FF   → buffer.LineFeed()                               │
│  ├── 0x0D CR   → buffer.CarriageReturn()                         │
│  ├── 0x0E SO   → Ignore (Shift Out)                              │
│  ├── 0x0F SI   → Ignore (Shift In)                               │
│  ├── 0x1B ESC  → state = Escape, clear intermediates             │
│  ├── 0x18 CAN  → state = Ground (cancel)                         │
│  └── 0x1A SUB  → state = Ground (cancel)                         │
│                                                                  │
│  ProcessGround(byte b):                                          │
│  ├── 0x20-0x7E → buffer.WriteChar((char)b) - Printable ASCII    │
│  └── 0x80+     → buffer.WriteChar((char)b) - UTF-8 continuation │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### AnsiParser Private Methods (Part 2: Escape Handling)

```
┌─────────────────────────────────────────────────────────────────┐
│                  AnsiParser Methods (2/4)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ProcessEscape(byte b):                                          │
│  ├── '[' (0x5B) → state = CsiEntry, ResetCsiParser()             │
│  ├── ']' (0x5D) → state = OscString, clear oscString             │
│  ├── 'P' (0x50) → state = DcsEntry, ResetCsiParser()             │
│  ├── 'X'/'ˆ'/'_'→ state = SosPmApcString                         │
│  ├── '\' (0x5C) → state = Ground (String Terminator)             │
│  ├── '7'        → buffer.SaveCursor(), state = Ground            │
│  ├── '8'        → buffer.RestoreCursor(), state = Ground         │
│  ├── 'D'        → buffer.LineFeed(), state = Ground              │
│  ├── 'E'        → buffer.CR(); buffer.LF(), state = Ground       │
│  ├── 'H'        → Ignore (HTS), state = Ground                   │
│  ├── 'M'        → buffer.ScrollDown(1), state = Ground           │
│  ├── 'c'        → buffer.Reset(), state = Ground                 │
│  ├── 0x20-0x2F  → Append to intermediates, state = EscIntermed.  │
│  └── default    → state = Ground (unknown escape)                │
│                                                                  │
│  ProcessEscapeIntermediate(byte b):                              │
│  ├── 0x20-0x2F → Append to intermediates                         │
│  ├── 0x30-0x7E → ExecuteEscapeSequence(), state = Ground         │
│  └── default   → state = Ground                                  │
│                                                                  │
│  ExecuteEscapeSequence(char final):                              │
│  └── Handle ESC ( B, ESC ) 0, etc. (charset selection, ignored)  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### AnsiParser Private Methods (Part 3: CSI Processing)

```
┌─────────────────────────────────────────────────────────────────┐
│                  AnsiParser Methods (3/4)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ProcessCsi(byte b):                                             │
│  ├── 0x30-0x39 (digit) → Accumulate parameter digit              │
│  ├── 0x3B (semicolon)  → Add param to list, reset currentParam   │
│  ├── 0x3C-0x3F (<=>?)  → Append to intermediates (private prefix)│
│  ├── 0x20-0x2F         → Add final param, state = CsiIntermediate│
│  ├── 0x40-0x7E         → Add final param, ExecuteCsi(), Ground   │
│  └── default           → state = Ground (invalid)                │
│                                                                  │
│  ProcessCsiIntermediate(byte b):                                 │
│  ├── 0x20-0x2F → Append to intermediates                         │
│  ├── 0x40-0x7E → ExecuteCsi(), state = Ground                    │
│  └── default   → state = Ground                                  │
│                                                                  │
│  ResetCsiParser():                                               │
│  └── Clear params, intermediates, currentParam, paramStarted     │
│                                                                  │
│  GetParam(int index, int defaultValue = 0) → int:                │
│  └── Return params[index] or defaultValue if not present/zero    │
│                                                                  │
│  ExecuteCsi(char final):                                         │
│  ├── Get privatePrefix from intermediates[0]                     │
│  └── Switch on final:                                            │
│      ├── 'A' CUU → buffer.CursorUp(GetParam(0, 1))               │
│      ├── 'B' CUD → buffer.CursorDown(GetParam(0, 1))             │
│      ├── 'C' CUF → buffer.CursorForward(GetParam(0, 1))          │
│      ├── 'D' CUB → buffer.CursorBack(GetParam(0, 1))             │
│      ├── 'E' CNL → CursorDown + CarriageReturn                   │
│      ├── 'F' CPL → CursorUp + CarriageReturn                     │
│      ├── 'G' CHA → Set CursorX to param-1                        │
│      ├── 'H'/'f' → buffer.SetCursorPosition(row, col)            │
│      ├── 'J' ED  → Clear display (0=end, 1=start, 2=all, 3=all+sb)│
│      ├── 'K' EL  → Clear line (0=end, 1=start, 2=all)            │
│      ├── 'L' IL  → buffer.InsertLines(n)                         │
│      ├── 'M' DL  → buffer.DeleteLines(n)                         │
│      ├── 'P' DCH → buffer.DeleteChars(n)                         │
│      ├── 'S' SU  → buffer.ScrollUp(n)                            │
│      ├── 'T' SD  → buffer.ScrollDown(n)                          │
│      ├── 'X' ECH → Erase n characters at cursor                  │
│      ├── '@' ICH → buffer.InsertChars(n)                         │
│      ├── 'd' VPA → Set CursorY to param-1                        │
│      ├── 'm' SGR → ExecuteSgr()                                  │
│      ├── 'n' DSR → Ignore (Device Status Report)                 │
│      ├── 'r' DECSTBM → buffer.SetScrollRegion(top, bottom)       │
│      ├── 's'     → buffer.SaveCursor()                           │
│      ├── 'u'     → buffer.RestoreCursor()                        │
│      ├── 'h' SM  → If privatePrefix='?': ExecuteDecSet(true)     │
│      ├── 'l' RM  → If privatePrefix='?': ExecuteDecSet(false)    │
│      ├── 'c' DA  → Ignore (Device Attributes)                    │
│      └── 't'     → Ignore (Window manipulation)                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### AnsiParser Private Methods (Part 4: SGR, DEC Modes, OSC)

```
┌─────────────────────────────────────────────────────────────────┐
│                  AnsiParser Methods (4/4)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ExecuteSgr():                                                   │
│  ├── If no params → Reset to default attributes                  │
│  └── For each param:                                             │
│      ├── 0        → Reset all attributes                         │
│      ├── 1        → Bold = true                                  │
│      ├── 2        → Dim = true                                   │
│      ├── 3        → Italic = true                                │
│      ├── 4        → Underline = true                             │
│      ├── 5/6      → Blink = true                                 │
│      ├── 7        → Inverse = true                               │
│      ├── 8        → Hidden = true                                │
│      ├── 9        → Strikethrough = true                         │
│      ├── 21       → Underline = true (double underline)          │
│      ├── 22       → Bold = false, Dim = false                    │
│      ├── 23       → Italic = false                               │
│      ├── 24       → Underline = false                            │
│      ├── 25       → Blink = false                                │
│      ├── 27       → Inverse = false                              │
│      ├── 28       → Hidden = false                               │
│      ├── 29       → Strikethrough = false                        │
│      ├── 30-37    → Foreground = palette[p - 30]                 │
│      ├── 38       → ProcessExtendedColor(foreground)             │
│      ├── 39       → Foreground = default                         │
│      ├── 40-47    → Background = palette[p - 40]                 │
│      ├── 48       → ProcessExtendedColor(background)             │
│      ├── 49       → Background = default                         │
│      ├── 90-97    → Foreground = palette[p - 90 + 8] (bright)    │
│      └── 100-107  → Background = palette[p - 100 + 8] (bright)   │
│                                                                  │
│  ProcessExtendedColor(int index, bool isForeground) → int:       │
│  ├── Mode 5 (256-color): params[i+1]=5, params[i+2]=colorIndex   │
│  │   └── Color = TerminalColor.FromPalette(colorIndex)           │
│  └── Mode 2 (True color): params[i+1]=2, r=i+2, g=i+3, b=i+4     │
│      └── Color = TerminalColor.FromRgb(r, g, b)                  │
│                                                                  │
│  ExecuteDecSet(bool enable):                                     │
│  └── For each param:                                             │
│      ├── 1    DECCKM  → (cursor keys mode, ignored)              │
│      ├── 6    DECOM   → buffer.OriginMode = enable               │
│      ├── 7    DECAWM  → buffer.AutoWrapMode = enable             │
│      ├── 25   DECTCEM → buffer.CursorVisible = enable            │
│      ├── 47/1047/1049 → Alternate screen buffer                  │
│      └── 2004         → (bracketed paste, ignored)               │
│                                                                  │
│  ProcessOsc(byte b):                                             │
│  ├── 0x07 BEL → ExecuteOsc(), state = Ground                     │
│  ├── 0x1B ESC → ExecuteOsc(), state = Escape                     │
│  └── 0x20+    → Append to oscString                              │
│                                                                  │
│  ExecuteOsc():                                                   │
│  ├── Parse command;argument from oscString                       │
│  └── Switch on command:                                          │
│      ├── "0"/"1"/"2" → TitleChanged?.Invoke(argument)            │
│      ├── "7"         → Parse file:// URL, invoke WorkingDir.     │
│      └── "8"         → Parse params;uri, invoke HyperlinkDetected│
│                                                                  │
│  ProcessDcs(byte b): (Simplified)                                │
│  └── Wait for ST (0x9C or ESC \), then state = Ground            │
│                                                                  │
│  ProcessSosPmApc(byte b):                                        │
│  └── Wait for ST (0x9C or ESC), then state = Ground              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Implementation Checklist

### Files to Create

| File | Type | Purpose |
|------|------|---------|
| `src/AIntern.Core/Terminal/AnsiParserState.cs` | enum | Parser state machine states |
| `src/AIntern.Core/Terminal/AnsiParser.cs` | sealed class | VT100/ANSI escape sequence parser |

### Files to Remove

| File | Reason |
|------|--------|
| `src/AIntern.Core/Terminal/.gitkeep` | Replace with actual source files |

### Prerequisites

- v0.5.1a must be completed (folder structure exists)
- v0.5.1b must be completed (terminal models exist)
- `src/AIntern.Core/Terminal/` directory must exist
- `TerminalBuffer` class must be available in `AIntern.Core.Models.Terminal`

---

## Code Style Requirements

### File Header Pattern

Each file should follow the project's established header pattern:

```csharp
namespace AIntern.Core.Terminal;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ TYPE NAME (v0.5.1c)                                                     │
// │ Brief description of the type's purpose.                                │
// └─────────────────────────────────────────────────────────────────────────┘
```

### XML Documentation Pattern

```csharp
/// <summary>
/// Description of the type or member.
/// </summary>
/// <remarks>
/// <para>Added in v0.5.1c.</para>
/// </remarks>
```

### Event Declaration Pattern

Events use `Action` delegates for simplicity:

```csharp
/// <summary>
/// Event raised when [condition].
/// </summary>
public event Action? EventName;

/// <summary>
/// Event raised when [condition] with parameter.
/// </summary>
public event Action<string>? EventWithParameter;
```

### Using Statements

The implementation requires these using statements:

```csharp
using System.Text;
using AIntern.Core.Models.Terminal;
```

---

## Verification Commands

### Step 1: Build Core Project

```bash
# Verify parser compiles correctly
dotnet build src/AIntern.Core/AIntern.Core.csproj
```

**Expected Output**:
- Build succeeded
- 0 errors
- No warnings related to new terminal types

### Step 2: Verify Type Visibility

```bash
# Run a quick test to verify types are accessible
dotnet build AIntern.sln
```

### Step 3: Verify Namespace and Usage

After implementation, ensure all types work correctly by checking that this code compiles:

```csharp
using AIntern.Core.Terminal;
using AIntern.Core.Models.Terminal;

var buffer = new TerminalBuffer(80, 24);
var parser = new AnsiParser(buffer);

// Subscribe to events
parser.Bell += () => Console.WriteLine("Bell!");
parser.TitleChanged += title => Console.WriteLine($"Title: {title}");
parser.WorkingDirectoryChanged += dir => Console.WriteLine($"Dir: {dir}");
parser.HyperlinkDetected += (p, uri) => Console.WriteLine($"Link: {uri}");

// Parse some input
parser.Parse("Hello, World!\n");
parser.Parse("\x1b[1;31mRed and Bold\x1b[0m");
parser.Parse("\x1b]0;My Terminal Title\x07");

// Check state
var state = AnsiParserState.Ground;
```

---

## Implementation Reference Code

The complete implementation code is provided in the parent specification `v0.5.1-terminal-foundation.md` in the "v0.5.1c: ANSI Parser" section. Key aspects:

### AnsiParserState.cs

```csharp
namespace AIntern.Core.Terminal;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ ANSI PARSER STATE (v0.5.1c)                                             │
// │ State machine states for ANSI escape sequence parsing.                  │
// └─────────────────────────────────────────────────────────────────────────┘

/// <summary>
/// State machine states for ANSI escape sequence parsing.
/// </summary>
/// <remarks>
/// <para>Added in v0.5.1c.</para>
/// </remarks>
public enum AnsiParserState
{
    /// <summary>
    /// Normal character processing.
    /// </summary>
    Ground,

    /// <summary>
    /// Received ESC (0x1B), waiting for next byte.
    /// </summary>
    Escape,

    /// <summary>
    /// Received ESC followed by intermediate byte.
    /// </summary>
    EscapeIntermediate,

    /// <summary>
    /// Control Sequence Introducer (ESC [).
    /// </summary>
    CsiEntry,

    /// <summary>
    /// Collecting CSI parameters.
    /// </summary>
    CsiParam,

    /// <summary>
    /// CSI intermediate bytes.
    /// </summary>
    CsiIntermediate,

    /// <summary>
    /// Operating System Command (ESC ]).
    /// </summary>
    OscString,

    /// <summary>
    /// Device Control String (ESC P).
    /// </summary>
    DcsEntry,

    /// <summary>
    /// DCS collecting parameters.
    /// </summary>
    DcsParam,

    /// <summary>
    /// DCS intermediate bytes.
    /// </summary>
    DcsIntermediate,

    /// <summary>
    /// DCS passthrough.
    /// </summary>
    DcsPassthrough,

    /// <summary>
    /// SOS/PM/APC string.
    /// </summary>
    SosPmApcString
}
```

### AnsiParser.cs (Signature)

```csharp
namespace AIntern.Core.Terminal;

using System.Text;
using AIntern.Core.Models.Terminal;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ ANSI PARSER (v0.5.1c)                                                   │
// │ Parses VT100/ANSI escape sequences and updates a terminal buffer.       │
// └─────────────────────────────────────────────────────────────────────────┘

/// <summary>
/// Parses VT100/ANSI escape sequences and updates a terminal buffer.
/// </summary>
/// <remarks>
/// <para>
/// Supports C0 control characters, CSI sequences (cursor movement, screen
/// clearing, SGR styling), OSC commands (title, working directory, hyperlinks),
/// and DEC private modes.
/// </para>
/// <para>Added in v0.5.1c.</para>
/// </remarks>
public sealed class AnsiParser
{
    private readonly TerminalBuffer _buffer;
    private AnsiParserState _state = AnsiParserState.Ground;
    private readonly List<int> _params = new();
    private readonly StringBuilder _intermediates = new();
    private readonly StringBuilder _oscString = new();
    private int _currentParam;
    private bool _paramStarted;

    /// <summary>
    /// Event raised when a bell character is received.
    /// </summary>
    public event Action? Bell;

    /// <summary>
    /// Event raised when the terminal title changes (via OSC 0/1/2).
    /// </summary>
    public event Action<string>? TitleChanged;

    /// <summary>
    /// Event raised when the working directory changes (via OSC 7).
    /// </summary>
    public event Action<string>? WorkingDirectoryChanged;

    /// <summary>
    /// Event raised when a hyperlink is detected (via OSC 8).
    /// </summary>
    public event Action<string?, string>? HyperlinkDetected;

    /// <summary>
    /// Creates a new ANSI parser targeting the specified buffer.
    /// </summary>
    /// <param name="buffer">The terminal buffer to update.</param>
    /// <exception cref="ArgumentNullException">Thrown when buffer is null.</exception>
    public AnsiParser(TerminalBuffer buffer)
    {
        _buffer = buffer ?? throw new ArgumentNullException(nameof(buffer));
    }

    /// <summary>
    /// Parse a sequence of bytes from the terminal output stream.
    /// </summary>
    /// <param name="data">The byte data to parse.</param>
    public void Parse(ReadOnlySpan<byte> data)
    {
        foreach (var b in data)
        {
            ProcessByte(b);
        }
    }

    /// <summary>
    /// Parse a string (converted to UTF-8 bytes).
    /// </summary>
    /// <param name="text">The text to parse.</param>
    public void Parse(string text)
    {
        Parse(Encoding.UTF8.GetBytes(text));
    }

    // Private methods follow the detailed design above...
}
```

---

## Post-Implementation Notes

### Next Steps (v0.5.1d)

After v0.5.1c is complete, v0.5.1d will implement the terminal service in `src/AIntern.Services/Terminal/`:

- ITerminalService.cs - Terminal service interface
- TerminalService.cs - PTY-based terminal service implementation

The service will create terminal sessions, spawn PTY processes, read output, and feed data to the `AnsiParser` created in v0.5.1c.

### Testing Considerations

The ANSI parser should be tested with:
1. Basic text output (printable ASCII)
2. C0 control characters (LF, CR, TAB, etc.)
3. CSI cursor movement sequences
4. CSI screen clearing sequences
5. SGR color and style sequences
6. Extended color modes (256 and true color)
7. OSC title changes
8. Invalid/malformed escape sequences (should not crash)

### Rollback Procedure

If v0.5.1c needs to be rolled back:

1. Delete `src/AIntern.Core/Terminal/AnsiParserState.cs`
2. Delete `src/AIntern.Core/Terminal/AnsiParser.cs`
3. Restore the `.gitkeep` file in `src/AIntern.Core/Terminal/`
4. Run `dotnet build` to verify no broken references

---

## Appendix A: VT100 Control Codes Reference

| Code | Hex | Name | Description |
|------|-----|------|-------------|
| NUL | 0x00 | Null | Ignored |
| BEL | 0x07 | Bell | Audio/visual alert |
| BS | 0x08 | Backspace | Move cursor left |
| HT | 0x09 | Tab | Move to next tab stop |
| LF | 0x0A | Line Feed | Move cursor down |
| VT | 0x0B | Vertical Tab | Same as LF |
| FF | 0x0C | Form Feed | Same as LF |
| CR | 0x0D | Carriage Return | Move cursor to column 0 |
| SO | 0x0E | Shift Out | Select G1 charset (ignored) |
| SI | 0x0F | Shift In | Select G0 charset (ignored) |
| CAN | 0x18 | Cancel | Cancel escape sequence |
| SUB | 0x1A | Substitute | Cancel escape sequence |
| ESC | 0x1B | Escape | Start escape sequence |

---

## Appendix B: ANSI Color Palette

### Standard Colors (0-15)

| Index | Name | RGB (Typical) |
|-------|------|---------------|
| 0 | Black | #000000 |
| 1 | Red | #AA0000 |
| 2 | Green | #00AA00 |
| 3 | Yellow | #AA5500 |
| 4 | Blue | #0000AA |
| 5 | Magenta | #AA00AA |
| 6 | Cyan | #00AAAA |
| 7 | White | #AAAAAA |
| 8 | Bright Black | #555555 |
| 9 | Bright Red | #FF5555 |
| 10 | Bright Green | #55FF55 |
| 11 | Bright Yellow | #FFFF55 |
| 12 | Bright Blue | #5555FF |
| 13 | Bright Magenta | #FF55FF |
| 14 | Bright Cyan | #55FFFF |
| 15 | Bright White | #FFFFFF |

### Extended Palette (16-255)

- **16-231**: 6×6×6 color cube
  - Formula: 16 + 36×r + 6×g + b (where r,g,b ∈ {0..5})
- **232-255**: 24 grayscale shades
  - Formula: RGB = 8 + 10×(index - 232)

---

## Appendix C: Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-17 | Initial specification |
