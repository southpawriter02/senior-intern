# Design Specification: AIntern v0.5.4g "Terminal Context Attachment"

## Overview

**Version**: v0.5.4g
**Parent**: v0.5.4 Command Integration
**Focus**: Capturing and attaching terminal output to AI chat context

### Purpose

This sub-version enables users to attach terminal output to chat context:
1. Create TerminalContextViewModel for representing attached terminal output
2. Add capture commands to ChatViewModel (full buffer, last N lines, selection)
3. Include terminal context in AI prompt construction
4. Display token count and truncation indicators
5. Track active terminal session state
6. Support clearing attached context

### Dependencies

**From v0.5.4a (Command Block Models)**:
- `TerminalOutputCapture` - Captured output container
- `OutputCaptureMode` - Capture mode enumeration

**From v0.5.4d (Output Capture)**:
- `IOutputCaptureService` - Capture operations

**From v0.5.1 (Terminal Foundation)**:
- `ITerminalService` - Session management

**From CommunityToolkit.Mvvm**:
- `ObservableProperty`, `RelayCommand` - MVVM infrastructure

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│              v0.5.4g Terminal Context Attachment Architecture                 │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     ViewModel Layer                                      │ │
│  │  src/AIntern.Desktop/ViewModels/                                        │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalContextViewModel : ViewModelBase                                │ │
│  │  ├── Dependencies:                                                      │ │
│  │  │   ├── IOutputCaptureService                                          │ │
│  │  │   └── ITerminalService                                               │ │
│  │  │                                                                       │ │
│  │  ├── Observable Properties:                                             │ │
│  │  │   ├── Capture: TerminalOutputCapture?                                │ │
│  │  │   └── IsExpanded: bool                                               │ │
│  │  │                                                                       │ │
│  │  ├── Computed Properties:                                               │ │
│  │  │   ├── DisplayName: string (session name)                             │ │
│  │  │   ├── Preview: string (100 char preview)                             │ │
│  │  │   ├── EstimatedTokens: int                                           │ │
│  │  │   ├── IsTruncated: bool                                              │ │
│  │  │   ├── WorkingDirectory: string?                                      │ │
│  │  │   ├── Command: string?                                               │ │
│  │  │   ├── ContextString: string (for AI prompt)                          │ │
│  │  │   └── CaptureTime: DateTime                                          │ │
│  │  │                                                                       │ │
│  │  └── Commands:                                                          │ │
│  │      ├── ToggleExpandCommand                                            │ │
│  │      └── RefreshCommand                                                 │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                ChatViewModel Extensions                                  │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ChatViewModel (modifications)                                           │ │
│  │  ├── New Dependencies:                                                  │ │
│  │  │   ├── IOutputCaptureService                                          │ │
│  │  │   └── ITerminalService                                               │ │
│  │  │                                                                       │ │
│  │  ├── New Properties:                                                    │ │
│  │  │   ├── AttachedTerminalContext: TerminalContextViewModel?             │ │
│  │  │   ├── HasActiveTerminal: bool                                        │ │
│  │  │   └── HasTerminalContext: bool (computed)                            │ │
│  │  │                                                                       │ │
│  │  ├── New Commands:                                                      │ │
│  │  │   ├── AttachTerminalOutputCommand (full buffer)                      │ │
│  │  │   ├── AttachLastCommandOutputCommand (last N lines)                  │ │
│  │  │   ├── AttachSelectionCommand (selected text)                         │ │
│  │  │   └── ClearTerminalContextCommand                                    │ │
│  │  │                                                                       │ │
│  │  └── Modified Methods:                                                  │ │
│  │      ├── BuildContextPrompt() - includes terminal context               │ │
│  │      └── UpdateHasActiveTerminal() - terminal state tracking            │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Context Attachment Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     Terminal Context Attachment Flow                          │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User clicks "Attach Terminal Output" button                                 │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Check: HasActiveTerminal                                               │ │
│  │  └── If false: Button disabled, nothing happens                        │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │                                                │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Select capture mode:                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │  "Attach Full Output"    → OutputCaptureMode.FullBuffer        │   │ │
│  │  │  "Attach Last Command"   → OutputCaptureMode.LastNLines (50)   │   │ │
│  │  │  "Attach Selection"      → OutputCaptureMode.Selection         │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │                                                │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Call IOutputCaptureService:                                            │ │
│  │  capture = await CaptureBufferAsync(sessionId, mode, lineCount?)        │ │
│  │                                                                          │ │
│  │  For selection:                                                          │ │
│  │  capture = await CaptureSelectionAsync(sessionId)                       │ │
│  │  └── Returns null if nothing selected                                  │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │                                                │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Create TerminalContextViewModel:                                       │ │
│  │  AttachedTerminalContext = new TerminalContextViewModel(...)            │ │
│  │  {                                                                       │ │
│  │      Capture = capture                                                   │ │
│  │  }                                                                       │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │                                                │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  UI Updates:                                                            │ │
│  │  • HasTerminalContext → true                                            │ │
│  │  • Context pill appears in context bar                                  │ │
│  │  • Shows: icon, session name, token count, close button                │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## AI Prompt Integration

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    AI Prompt Construction with Terminal Context               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  BuildContextPrompt() called when sending message to AI                      │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Prompt Structure:                                                      │ │
│  │                                                                          │ │
│  │  --- File: /path/to/Component.tsx ---                                   │ │
│  │  import React from 'react';                                             │ │
│  │  ...file content...                                                     │ │
│  │                                                                          │ │
│  │  --- File: /path/to/styles.css ---                                      │ │
│  │  .container { ... }                                                     │ │
│  │  ...file content...                                                     │ │
│  │                                                                          │ │
│  │  --- Terminal Output ---                                                │ │
│  │  Session: bash - /project                                               │ │
│  │  Command: npm run build                                                 │ │
│  │  Working Directory: /home/user/project                                  │ │
│  │  Duration: 5.2s                                                         │ │
│  │                                                                          │ │
│  │  > project@1.0.0 build                                                  │ │
│  │  > webpack --mode production                                            │ │
│  │                                                                          │ │
│  │  ERROR in ./src/App.tsx 15:23                                           │ │
│  │  Module not found: Error: Can't resolve './components/Header'           │ │
│  │                                                                          │ │
│  │  (output may be truncated)                                              │ │
│  │                                                                          │ │
│  │  [User message here]                                                    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  The AI can now see:                                                         │
│  • Actual error messages from build output                                  │
│  • Working directory context                                                 │
│  • Command that was run                                                      │
│  • Session information                                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. TerminalContextViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/TerminalContextViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// ViewModel for terminal output attached to chat context.
/// Displays capture information and provides context for AI prompts.
/// </summary>
public partial class TerminalContextViewModel : ViewModelBase
{
    private readonly IOutputCaptureService _captureService;
    private readonly ITerminalService _terminalService;

    // === Observable Properties ===

    [ObservableProperty]
    private TerminalOutputCapture? _capture;

    [ObservableProperty]
    private bool _isExpanded;

    // === Computed Properties ===

    /// <summary>Display name for the context pill.</summary>
    public string DisplayName => Capture?.SessionName ?? "Terminal Output";

    /// <summary>Short preview of the captured output (100 chars max).</summary>
    public string Preview
    {
        get
        {
            if (Capture == null)
                return string.Empty;

            var preview = Capture.Output;
            if (preview.Length > 100)
            {
                preview = preview[..97] + "...";
            }
            return preview.Replace('\n', ' ').Replace('\r', ' ');
        }
    }

    /// <summary>Full output for expanded view.</summary>
    public string FullOutput => Capture?.Output ?? string.Empty;

    /// <summary>Estimated token count for LLM context.</summary>
    public int EstimatedTokens => Capture?.EstimatedTokens ?? 0;

    /// <summary>Whether the captured output was truncated.</summary>
    public bool IsTruncated => Capture?.IsTruncated ?? false;

    /// <summary>Working directory at capture time.</summary>
    public string? WorkingDirectory => Capture?.WorkingDirectory;

    /// <summary>Command that was run (if captured during execution).</summary>
    public string? Command => Capture?.Command;

    /// <summary>Whether a command was captured.</summary>
    public bool HasCommand => !string.IsNullOrEmpty(Command);

    /// <summary>Capture mode used.</summary>
    public OutputCaptureMode CaptureMode => Capture?.CaptureMode ?? OutputCaptureMode.FullBuffer;

    /// <summary>Human-readable capture mode.</summary>
    public string CaptureModeText => CaptureMode switch
    {
        OutputCaptureMode.FullBuffer => "Full Buffer",
        OutputCaptureMode.LastCommand => "Last Command",
        OutputCaptureMode.LastNLines => "Last Lines",
        OutputCaptureMode.Selection => "Selection",
        OutputCaptureMode.Manual => "Manual",
        _ => "Unknown"
    };

    /// <summary>When the capture was taken.</summary>
    public DateTime CaptureTime => Capture?.CompletedAt ?? DateTime.MinValue;

    /// <summary>Human-readable capture time.</summary>
    public string CaptureTimeText => CaptureTime == DateTime.MinValue 
        ? "" 
        : CaptureTime.ToLocalTime().ToString("HH:mm:ss");

    /// <summary>Formatted context string for AI prompt.</summary>
    public string ContextString => Capture?.ToContextString() ?? string.Empty;

    /// <summary>Output line count.</summary>
    public int LineCount => Capture?.LineCount ?? 0;

    /// <summary>Original length before truncation.</summary>
    public int OriginalLength => Capture?.OriginalLength ?? 0;

    /// <summary>Whether content is different from original due to truncation.</summary>
    public bool WasTruncated => IsTruncated || 
        (Capture != null && Capture.Output.Length < Capture.OriginalLength);

    /// <summary>Truncation summary text.</summary>
    public string TruncationText => WasTruncated 
        ? $"Truncated from {OriginalLength:N0} chars" 
        : "";

    // === Constructor ===

    public TerminalContextViewModel(
        IOutputCaptureService captureService,
        ITerminalService terminalService)
    {
        _captureService = captureService;
        _terminalService = terminalService;
    }

    // === Commands ===

    [RelayCommand]
    private void ToggleExpand()
    {
        IsExpanded = !IsExpanded;
    }

    [RelayCommand]
    private async Task RefreshAsync()
    {
        if (Capture == null)
            return;

        // Re-capture from the same session with same mode
        var newCapture = await _captureService.CaptureBufferAsync(
            Capture.SessionId,
            Capture.CaptureMode);

        Capture = newCapture;
    }

    // === Property Change Handlers ===

    partial void OnCaptureChanged(TerminalOutputCapture? value)
    {
        // Notify all computed properties
        OnPropertyChanged(nameof(DisplayName));
        OnPropertyChanged(nameof(Preview));
        OnPropertyChanged(nameof(FullOutput));
        OnPropertyChanged(nameof(EstimatedTokens));
        OnPropertyChanged(nameof(IsTruncated));
        OnPropertyChanged(nameof(WorkingDirectory));
        OnPropertyChanged(nameof(Command));
        OnPropertyChanged(nameof(HasCommand));
        OnPropertyChanged(nameof(CaptureMode));
        OnPropertyChanged(nameof(CaptureModeText));
        OnPropertyChanged(nameof(CaptureTime));
        OnPropertyChanged(nameof(CaptureTimeText));
        OnPropertyChanged(nameof(ContextString));
        OnPropertyChanged(nameof(LineCount));
        OnPropertyChanged(nameof(OriginalLength));
        OnPropertyChanged(nameof(WasTruncated));
        OnPropertyChanged(nameof(TruncationText));
    }
}
```

### 2. ChatViewModel Terminal Extensions

**Location**: `src/AIntern.Desktop/ViewModels/ChatViewModel.cs` (additions)

```csharp
// === New Dependencies (add to constructor) ===
private readonly IOutputCaptureService _outputCaptureService;
private readonly ITerminalService _terminalService;

// === New Observable Properties ===

[ObservableProperty]
private TerminalContextViewModel? _attachedTerminalContext;

[ObservableProperty]
private bool _hasActiveTerminal;

// === New Computed Properties ===

/// <summary>Whether terminal output is attached to context.</summary>
public bool HasTerminalContext => AttachedTerminalContext?.Capture != null;

// === New Commands ===

/// <summary>
/// Attach the full terminal buffer to chat context.
/// </summary>
[RelayCommand(CanExecute = nameof(HasActiveTerminal))]
private async Task AttachTerminalOutputAsync()
{
    var activeSession = _terminalService.ActiveSession;
    if (activeSession == null)
        return;

    var capture = await _outputCaptureService.CaptureBufferAsync(
        activeSession.Id,
        OutputCaptureMode.FullBuffer);

    AttachedTerminalContext = new TerminalContextViewModel(
        _outputCaptureService, 
        _terminalService)
    {
        Capture = capture
    };

    OnPropertyChanged(nameof(HasTerminalContext));
}

/// <summary>
/// Attach the last N lines of terminal output (recent command output).
/// </summary>
[RelayCommand(CanExecute = nameof(HasActiveTerminal))]
private async Task AttachLastCommandOutputAsync()
{
    var activeSession = _terminalService.ActiveSession;
    if (activeSession == null)
        return;

    var capture = await _outputCaptureService.CaptureBufferAsync(
        activeSession.Id,
        OutputCaptureMode.LastNLines,
        lineCount: 50);

    AttachedTerminalContext = new TerminalContextViewModel(
        _outputCaptureService, 
        _terminalService)
    {
        Capture = capture
    };

    OnPropertyChanged(nameof(HasTerminalContext));
}

/// <summary>
/// Attach user-selected text from terminal.
/// </summary>
[RelayCommand(CanExecute = nameof(HasActiveTerminal))]
private async Task AttachSelectionAsync()
{
    var activeSession = _terminalService.ActiveSession;
    if (activeSession == null)
        return;

    var capture = await _outputCaptureService.CaptureSelectionAsync(activeSession.Id);
    if (capture == null)
    {
        // Could show a message: "No text selected in terminal"
        return;
    }

    AttachedTerminalContext = new TerminalContextViewModel(
        _outputCaptureService, 
        _terminalService)
    {
        Capture = capture
    };

    OnPropertyChanged(nameof(HasTerminalContext));
}

/// <summary>
/// Remove attached terminal context.
/// </summary>
[RelayCommand]
private void ClearTerminalContext()
{
    AttachedTerminalContext = null;
    OnPropertyChanged(nameof(HasTerminalContext));
}

// === Modified Methods ===

/// <summary>
/// Build context string for AI prompt, including terminal output.
/// </summary>
private string BuildContextPrompt()
{
    var sb = new StringBuilder();

    // Existing file contexts
    foreach (var ctx in AttachedContexts)
    {
        sb.AppendLine($"--- File: {ctx.FileName} ---");
        sb.AppendLine(ctx.Content);
        sb.AppendLine();
    }

    // Terminal context
    if (AttachedTerminalContext?.Capture != null)
    {
        sb.AppendLine("--- Terminal Output ---");
        sb.AppendLine(AttachedTerminalContext.ContextString);
        sb.AppendLine();
    }

    return sb.ToString();
}

/// <summary>
/// Update HasActiveTerminal property based on terminal service state.
/// </summary>
private void UpdateHasActiveTerminal()
{
    var hadTerminal = HasActiveTerminal;
    HasActiveTerminal = _terminalService.ActiveSession != null;
    
    if (hadTerminal != HasActiveTerminal)
    {
        // Notify commands that can-execute may have changed
        AttachTerminalOutputCommand.NotifyCanExecuteChanged();
        AttachLastCommandOutputCommand.NotifyCanExecuteChanged();
        AttachSelectionCommand.NotifyCanExecuteChanged();
    }
}

// === Initialization (add to constructor or Initialize method) ===

private void InitializeTerminalIntegration()
{
    // Subscribe to session state changes
    _terminalService.SessionStateChanged += (_, _) => UpdateHasActiveTerminal();
    
    // Initial state check
    UpdateHasActiveTerminal();
}
```

### 3. TerminalContextViewModelFactory.cs

**Location**: `src/AIntern.Desktop/ViewModels/TerminalContextViewModelFactory.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// Factory for creating TerminalContextViewModel instances with proper DI.
/// </summary>
public sealed class TerminalContextViewModelFactory
{
    private readonly IOutputCaptureService _captureService;
    private readonly ITerminalService _terminalService;

    public TerminalContextViewModelFactory(
        IOutputCaptureService captureService,
        ITerminalService terminalService)
    {
        _captureService = captureService;
        _terminalService = terminalService;
    }

    /// <summary>
    /// Create a ViewModel from an existing capture.
    /// </summary>
    public TerminalContextViewModel Create(TerminalOutputCapture capture)
    {
        ArgumentNullException.ThrowIfNull(capture);
        
        return new TerminalContextViewModel(_captureService, _terminalService)
        {
            Capture = capture
        };
    }

    /// <summary>
    /// Create a ViewModel and capture the full buffer.
    /// </summary>
    public async Task<TerminalContextViewModel?> CreateFromFullBufferAsync(
        Guid sessionId, 
        CancellationToken ct = default)
    {
        var capture = await _captureService.CaptureBufferAsync(
            sessionId, 
            OutputCaptureMode.FullBuffer, 
            ct: ct);
        
        return Create(capture);
    }

    /// <summary>
    /// Create a ViewModel and capture last N lines.
    /// </summary>
    public async Task<TerminalContextViewModel?> CreateFromLastLinesAsync(
        Guid sessionId,
        int lineCount = 50,
        CancellationToken ct = default)
    {
        var capture = await _captureService.CaptureBufferAsync(
            sessionId, 
            OutputCaptureMode.LastNLines,
            lineCount,
            ct);
        
        return Create(capture);
    }

    /// <summary>
    /// Create a ViewModel from user selection.
    /// </summary>
    public async Task<TerminalContextViewModel?> CreateFromSelectionAsync(
        Guid sessionId,
        CancellationToken ct = default)
    {
        var capture = await _captureService.CaptureSelectionAsync(sessionId, ct);
        
        if (capture == null)
            return null;
        
        return Create(capture);
    }
}
```

---

## File Summary

| File | Location | Purpose |
|------|----------|---------|
| `TerminalContextViewModel.cs` | `src/AIntern.Desktop/ViewModels/` | Terminal context display ViewModel |
| `TerminalContextViewModelFactory.cs` | `src/AIntern.Desktop/ViewModels/` | Factory for ViewModel creation |

### Files to Modify

| File | Changes |
|------|---------|
| `src/AIntern.Desktop/ViewModels/ChatViewModel.cs` | Add terminal context properties and commands |
| `src/AIntern.Desktop/DependencyInjection.cs` | Register TerminalContextViewModelFactory |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `DisplayName_ReturnsSessionName` | Session name or default |
| `Preview_TruncatesLongOutput` | Max 100 chars |
| `Preview_ReplacesNewlines` | Newlines become spaces |
| `EstimatedTokens_DelegatesToCapture` | Returns capture value |
| `IsTruncated_DelegatesToCapture` | Returns capture value |
| `ContextString_DelegatesToCapture` | Returns formatted context |
| `CaptureModeText_MapsCorrectly` | Enum to readable text |
| `CaptureTimeText_FormatsLocalTime` | Formats as HH:mm:ss |
| `TruncationText_ShowsWhenTruncated` | Shows original length |
| `ToggleExpand_TogglesState` | IsExpanded flips |
| `RefreshAsync_ReCaptures` | Calls capture service |
| `OnCaptureChanged_NotifiesAll` | All computed properties notified |
| `AttachTerminalOutput_CreatesContext` | Full buffer captured |
| `AttachTerminalOutput_RequiresActiveSession` | Returns early if none |
| `AttachLastCommand_CapturesLastLines` | Last 50 lines |
| `AttachSelection_CapturesSelected` | Selection captured |
| `AttachSelection_ReturnsIfNoSelection` | Null capture handled |
| `ClearTerminalContext_Clears` | Sets to null |
| `HasTerminalContext_TracksState` | True when attached |
| `HasActiveTerminal_TracksSession` | Updates on session change |
| `BuildContextPrompt_IncludesTerminal` | Terminal in prompt |
| `BuildContextPrompt_IncludesFiles` | Files in prompt |
| `Factory_Create_SetsCapture` | Factory creates correctly |
| `Factory_CreateFromFullBuffer_Captures` | Async capture works |

**Total Tests**: 24

---

## Verification

```bash
# Verify compilation
dotnet build src/AIntern.Desktop

# Run unit tests
dotnet test --filter "TerminalContext"

# Verify registration
grep -n "TerminalContextViewModelFactory" src/AIntern.Desktop/DependencyInjection.cs
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Full terminal buffer can be captured and attached |
| AC-2 | Last N lines (50) can be captured and attached |
| AC-3 | User selection can be captured and attached |
| AC-4 | Attach commands are disabled without active terminal |
| AC-5 | Context pill shows session name |
| AC-6 | Token count is displayed on context pill |
| AC-7 | Truncation indicator shows when output was truncated |
| AC-8 | Terminal context is included in AI prompts |
| AC-9 | Context can be cleared |
| AC-10 | Refresh re-captures from same session |
| AC-11 | Preview shows first 100 chars with newlines replaced |

---

## Changelog Entry

```markdown
## v0.5.4g - Terminal Context Attachment

### Added
- `TerminalContextViewModel` with:
  - Observable: Capture, IsExpanded
  - Computed: DisplayName, Preview, EstimatedTokens, IsTruncated,
    WorkingDirectory, Command, ContextString, CaptureTime,
    CaptureModeText, LineCount, TruncationText
  - Commands: ToggleExpand, RefreshAsync

- `TerminalContextViewModelFactory` with:
  - Create(TerminalOutputCapture)
  - CreateFromFullBufferAsync(sessionId)
  - CreateFromLastLinesAsync(sessionId, lineCount)
  - CreateFromSelectionAsync(sessionId)

### Changed
- Extended `ChatViewModel` with:
  - AttachedTerminalContext property
  - HasActiveTerminal tracking
  - HasTerminalContext computed property
  - AttachTerminalOutputCommand (full buffer)
  - AttachLastCommandOutputCommand (last 50 lines)
  - AttachSelectionCommand (user selection)
  - ClearTerminalContextCommand
  - BuildContextPrompt() now includes terminal output
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.4g | 0.5 day |
