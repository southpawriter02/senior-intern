# Design Specification: AIntern v0.5.3b "Shell Configuration System"

## Overview

**Version**: v0.5.3b
**Parent**: v0.5.3 Shell Integration
**Focus**: Shell-specific commands, environment variables, escape sequences, and capabilities

### Purpose

This sub-version creates a comprehensive shell configuration system that provides:
1. Shell-specific command syntax (clear, cd, pwd, history, ls)
2. Environment variable handling per shell
3. OSC escape sequence support detection (OSC 7, OSC 9, OSC 133)
4. Profile file paths and login/interactive arguments
5. Shell integration scripts for directory synchronization

### Dependencies

**From v0.5.3a (Shell Detection)**:
- `IShellDetectionService.DetectShellType()` - Maps shell path to ShellType
- `ShellType` enumeration - Identifies shell variants

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                   v0.5.3b Shell Configuration Architecture                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Interface Layer                                   │ │
│  │  src/AIntern.Core/Interfaces/                                           │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  IShellConfigurationService                                              │ │
│  │  ├── GetConfiguration(ShellType) → ShellConfiguration                   │ │
│  │  ├── GetConfiguration(shellPath) → ShellConfiguration                   │ │
│  │  ├── FormatChangeDirectoryCommand(type, path) → string                  │ │
│  │  ├── GetCwdReportingEscapeSequence(type, dir) → string?                │ │
│  │  ├── GetDefaultEnvironment(type) → Dictionary<string, string>          │ │
│  │  └── GenerateShellIntegrationScript(type) → string?                    │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Model Layer                                       │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  ShellConfiguration                                                      │ │
│  │  ├── Type: ShellType                                                    │ │
│  │  ├── Commands:                                                          │ │
│  │  │   ├── ClearCommand                                                   │ │
│  │  │   ├── ChangeDirectoryCommand                                         │ │
│  │  │   ├── PrintWorkingDirectoryCommand                                   │ │
│  │  │   ├── HistoryCommand                                                 │ │
│  │  │   └── ListDirectoryCommand                                           │ │
│  │  ├── OSC Support:                                                       │ │
│  │  │   ├── SupportsOsc7 (CWD reporting)                                   │ │
│  │  │   ├── SupportsOsc9 (notifications)                                   │ │
│  │  │   └── SupportsOsc133 (shell marks)                                   │ │
│  │  ├── Syntax:                                                            │ │
│  │  │   ├── CommandSeparator                                               │ │
│  │  │   ├── LineContinuation                                               │ │
│  │  │   ├── CommentPrefix                                                  │ │
│  │  │   ├── EnvironmentVariablePrefix                                      │ │
│  │  │   └── SetEnvironmentVariableTemplate                                 │ │
│  │  ├── Paths:                                                             │ │
│  │  │   └── ProfileFiles[]                                                 │ │
│  │  ├── Arguments:                                                         │ │
│  │  │   ├── LoginArguments                                                 │ │
│  │  │   └── InteractiveArguments                                           │ │
│  │  └── DefaultEnvironment: Dictionary<string, string>                     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Shell Configuration Matrix

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Shell Configuration Comparison                              │
├──────────────┬────────────────┬───────────┬──────────────┬───────────┬──────────┤
│ Property     │ Bash/Zsh       │ Fish      │ PowerShell   │ Cmd       │ Nushell  │
├──────────────┼────────────────┼───────────┼──────────────┼───────────┼──────────┤
│ Clear        │ clear          │ clear     │ Clear-Host   │ cls       │ clear    │
│ CD           │ cd             │ cd        │ Set-Location │ cd /d     │ cd       │
│ PWD          │ pwd            │ pwd       │ (Get-Loc).P  │ cd        │ pwd      │
│ History      │ history        │ history   │ Get-History  │ doskey /h │ history  │
│ List         │ ls -la         │ ls -la    │ Get-ChildItem│ dir       │ ls       │
├──────────────┼────────────────┼───────────┼──────────────┼───────────┼──────────┤
│ OSC 7        │ ✓              │ ✓         │ ✗            │ ✗         │ ✓        │
│ OSC 133      │ ✓              │ ✓         │ ✗            │ ✗         │ ✗        │
├──────────────┼────────────────┼───────────┼──────────────┼───────────┼──────────┤
│ Cmd Sep      │ ;              │ ; and     │ ;            │ &         │ ;        │
│ Line Cont    │ \              │ \         │ `            │ ^         │ \        │
│ Comment      │ #              │ #         │ #            │ REM       │ #        │
│ Env Prefix   │ $              │ $         │ $env:        │ %         │ $env.    │
├──────────────┼────────────────┼───────────┼──────────────┼───────────┼──────────┤
│ Set Env      │ export X=Y     │ set -x X Y│ $env:X = "Y" │ set X=Y   │$env.X="Y"│
│ Login Args   │ --login        │ --login   │ -NoLogo      │ /k        │ --login  │
│ Interactive  │ -i             │ -i        │ -NoExit      │ -         │ -        │
└──────────────┴────────────────┴───────────┴──────────────┴───────────┴──────────┘
```

---

## OSC Escape Sequences

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         OSC Escape Sequence Support                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  OSC 7 - Current Working Directory Reporting                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Format: \x1b]7;file://hostname/path\x07                              │  │
│  │                                                                        │  │
│  │  Purpose: Reports CWD to terminal emulator for:                       │  │
│  │  - Opening new tabs in same directory                                 │  │
│  │  - File explorer synchronization                                       │  │
│  │  - "Open in Terminal" features                                         │  │
│  │                                                                        │  │
│  │  Supported: Bash, Zsh, Fish, Nushell, WSL                             │  │
│  │  Not Supported: PowerShell (uses OSC 9;9), Cmd, Sh                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  OSC 9;9 - Windows Terminal Directory (ConEmu/WT Style)                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Format: \x1b]9;9;"path"\x07                                          │  │
│  │  Used by: PowerShell on Windows Terminal                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  OSC 133 - Shell Integration Marks                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  A = Prompt start, B = Command start, C = Output start, D = Finished │  │
│  │  Enables: Command detection, output extraction, navigation           │  │
│  │  Supported: Bash, Zsh, Fish                                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Shell Integration Scripts

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Shell Integration Script Generation                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Purpose: Auto-inject scripts to enable CWD reporting                       │
│                                                                              │
│  Bash:                                                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  __si_prompt_command() {                                              │  │
│  │      printf '\e]7;file://%s%s\a' "$HOSTNAME" "$(pwd)"                │  │
│  │  }                                                                     │  │
│  │  PROMPT_COMMAND="__si_prompt_command${PROMPT_COMMAND:+;$...}"        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Zsh:                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  __si_chpwd() { printf '\e]7;file://%s%s\a' "$HOST" "$PWD" }         │  │
│  │  autoload -Uz add-zsh-hook                                            │  │
│  │  add-zsh-hook chpwd __si_chpwd                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Fish:                                                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  function __si_pwd_hook --on-variable PWD                             │  │
│  │      printf '\e]7;file://%s%s\a' (hostname) $PWD                     │  │
│  │  end                                                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  PowerShell:                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  function global:prompt {                                              │  │
│  │      $loc = (Get-Location).Path                                       │  │
│  │      Write-Host "`e]9;9;`"$loc`"`a" -NoNewline                       │  │
│  │      return "PS $loc> "                                                │  │
│  │  }                                                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Profile File Paths

| Shell | Profile Files |
|-------|---------------|
| Bash | `~/.bashrc`, `~/.bash_profile`, `~/.profile` |
| Zsh | `~/.zshrc`, `~/.zprofile`, `~/.zshenv` |
| Fish | `~/.config/fish/config.fish` |
| PowerShell | `~/Documents/PowerShell/Microsoft.PowerShell_profile.ps1`, `~/.config/powershell/...` |
| Nushell | `~/.config/nushell/config.nu` |
| Sh | `~/.profile` |

---

## File Specifications

### 1. ShellConfiguration.cs

**Location**: `src/AIntern.Core/Models/Terminal/ShellConfiguration.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

public sealed class ShellConfiguration
{
    public ShellType Type { get; init; }
    
    // Commands
    public string ClearCommand { get; init; } = "clear";
    public string ChangeDirectoryCommand { get; init; } = "cd";
    public string PrintWorkingDirectoryCommand { get; init; } = "pwd";
    public string HistoryCommand { get; init; } = "history";
    public string ListDirectoryCommand { get; init; } = "ls";
    
    // OSC Support
    public bool SupportsOsc7 { get; init; }
    public bool SupportsOsc9 { get; init; }
    public bool SupportsOsc133 { get; init; }
    
    // Configuration
    public string? PromptConfigTemplate { get; init; }
    public string[] ProfileFiles { get; init; } = Array.Empty<string>();
    public string LoginArguments { get; init; } = string.Empty;
    public string InteractiveArguments { get; init; } = string.Empty;
    
    // Syntax
    public string CommandSeparator { get; init; } = ";";
    public string LineContinuation { get; init; } = "\\";
    public bool EscapeQuotesWithBackslash { get; init; } = true;
    public string CommentPrefix { get; init; } = "#";
    public string EnvironmentVariablePrefix { get; init; } = "$";
    public string SetEnvironmentVariableTemplate { get; init; } = "export {0}={1}";
    
    // Environment
    public Dictionary<string, string> DefaultEnvironment { get; init; } = new();
}
```

### 2. IShellConfigurationService.cs

**Location**: `src/AIntern.Core/Interfaces/IShellConfigurationService.cs`

```csharp
namespace AIntern.Core.Interfaces;

using AIntern.Core.Models.Terminal;

public interface IShellConfigurationService
{
    ShellConfiguration GetConfiguration(ShellType shellType);
    ShellConfiguration GetConfiguration(string shellPath);
    string FormatChangeDirectoryCommand(ShellType shellType, string path);
    string? GetCwdReportingEscapeSequence(ShellType shellType, string directory);
    Dictionary<string, string> GetDefaultEnvironment(ShellType shellType);
    string? GenerateShellIntegrationScript(ShellType shellType);
}
```

### 3. ShellConfigurationService.cs

**Location**: `src/AIntern.Services/Terminal/ShellConfigurationService.cs`

Full implementation with:
- `InitializeConfigurations()` - Build dictionary of all shell configs
- `GetConfiguration()` - Retrieve config by type or path
- `FormatChangeDirectoryCommand()` - Build CD command with proper escaping
- `EscapePath()` - Shell-specific path escaping ($, quotes, spaces)
- `GetCwdReportingEscapeSequence()` - Generate OSC 7 sequence
- `GetDefaultEnvironment()` - Clone default env vars
- `GenerateShellIntegrationScript()` - Generate shell-specific integration

---

## File Summary

| File | Location | Purpose |
|------|----------|---------|
| `ShellConfiguration.cs` | `src/AIntern.Core/Models/Terminal/` | Configuration model |
| `IShellConfigurationService.cs` | `src/AIntern.Core/Interfaces/` | Service interface |
| `ShellConfigurationService.cs` | `src/AIntern.Services/Terminal/` | Service implementation |

### Files to Modify

| File | Changes |
|------|---------|
| `DependencyInjection.cs` | Register `IShellConfigurationService` |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `GetConfiguration_Bash_ReturnsBashConfig` | Verify Bash configuration |
| `GetConfiguration_PowerShell_HasCorrectSyntax` | PowerShell-specific syntax |
| `FormatChangeDirectoryCommand_WithSpaces_Escapes` | Path escaping |
| `GetCwdReportingEscapeSequence_Bash_ReturnsOsc7` | OSC 7 format |
| `GetCwdReportingEscapeSequence_Cmd_ReturnsNull` | Unsupported shells |
| `GenerateShellIntegrationScript_Zsh_HasHook` | Integration script |

---

## Verification

```bash
dotnet build src/AIntern.Services
dotnet test --filter "ShellConfiguration"
```

---

## Changelog Entry

```markdown
## v0.5.3b - Shell Configuration System

### Added
- `ShellConfiguration` model with:
  - Shell-specific commands (clear, cd, pwd, history, ls)
  - OSC escape sequence support flags (OSC 7, 9, 133)
  - Syntax elements (separators, continuations, comments, env vars)
  - Profile file paths and login/interactive arguments
  - Default environment variables (TERM, COLORTERM)

- `IShellConfigurationService` interface for configuration retrieval
- `ShellConfigurationService` implementation with:
  - Pre-built configurations for Bash, Zsh, Fish, PowerShell, Cmd, Sh, Nushell, WSL
  - Path escaping per shell type
  - OSC 7 CWD reporting sequence generation
  - Shell integration script generation for directory sync
```
