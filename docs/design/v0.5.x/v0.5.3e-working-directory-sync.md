# Design Specification: AIntern v0.5.3e "Working Directory Synchronization"

## Overview

**Version**: v0.5.3e
**Parent**: v0.5.3 Shell Integration
**Focus**: Bi-directional directory sync, OSC 7 parsing, terminal/explorer integration

### Purpose

This sub-version implements working directory synchronization that enables:
1. Tracking terminal working directory via OSC 7 escape sequences
2. Bi-directional sync between terminal and file explorer
3. Automatic directory updates based on user settings
4. Workspace linking for terminal sessions
5. WSL path translation on Windows
6. Manual sync commands for explicit directory changes

### Dependencies

**From v0.5.1 (Terminal Foundation)**:
- `ITerminalService` - Session management and input/output
- `AnsiParser` - Extended with OSC 7 handling

**From v0.5.3b (Shell Configuration)**:
- `IShellConfigurationService` - FormatChangeDirectoryCommand()

**From v0.5.3c (Shell Profile Models)**:
- `DirectorySyncMode` - ActiveTerminalOnly, AllLinkedTerminals, Manual
- `AppSettings.SyncTerminalWithWorkspace`, `AppSettings.TerminalSyncMode`

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│              v0.5.3e Working Directory Synchronization Architecture           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Interface Layer                                   │ │
│  │  src/AIntern.Core/Interfaces/                                           │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  IWorkingDirectorySyncService                                            │ │
│  │  ├── Events:                                                            │ │
│  │  │   ├── TerminalDirectoryChanged: EventHandler<DirectoryChangedArgs>   │ │
│  │  │   └── ExplorerDirectoryChanged: EventHandler<DirectoryChangedArgs>   │ │
│  │  ├── Query:                                                             │ │
│  │  │   ├── GetTerminalDirectoryAsync(sessionId) → string?                 │ │
│  │  │   └── IsAutoSyncEnabled(sessionId) → bool                            │ │
│  │  ├── Commands:                                                          │ │
│  │  │   ├── ChangeTerminalDirectoryAsync(sessionId, path) → void           │ │
│  │  │   ├── SyncTerminalToExplorerAsync(sessionId) → void                  │ │
│  │  │   └── SyncExplorerToTerminalAsync(sessionId) → void                  │ │
│  │  ├── Configuration:                                                     │ │
│  │  │   └── SetAutoSync(sessionId, enabled) → void                         │ │
│  │  ├── Workspace Linking:                                                 │ │
│  │  │   ├── LinkToWorkspace(sessionId, workspaceId) → void                 │ │
│  │  │   └── UnlinkFromWorkspace(sessionId) → void                          │ │
│  │  └── OSC Integration:                                                   │ │
│  │      └── ProcessOsc7(sessionId, uri) → void                             │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Event Models                                      │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  DirectoryChangedEventArgs              DirectoryChangeSource (enum)    │ │
│  │  ├── SessionId: Guid                    ├── Shell                       │ │
│  │  ├── OldDirectory: string               ├── Osc7                        │ │
│  │  ├── NewDirectory: string               ├── Api                         │ │
│  │  └── Source: DirectoryChangeSource      ├── ExplorerSync                │ │
│  │                                          └── WorkspaceSync              │ │
│  │                                                                          │ │
│  │  Osc7EventArgs                                                          │ │
│  │  └── Uri: string                                                        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     Implementation Layer                                 │ │
│  │  src/AIntern.Services/Terminal/                                         │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  WorkingDirectorySyncService : IWorkingDirectorySyncService, IDisposable│ │
│  │  ├── Dependencies:                                                      │ │
│  │  │   ├── ITerminalService                                               │ │
│  │  │   ├── IShellConfigurationService                                     │ │
│  │  │   ├── ISettingsService                                               │ │
│  │  │   └── ILogger<WorkingDirectorySyncService>                           │ │
│  │  ├── State:                                                             │ │
│  │  │   └── _sessionStates: ConcurrentDictionary<Guid, SessionSyncState>   │ │
│  │  └── Internal:                                                          │ │
│  │      └── SessionSyncState:                                              │ │
│  │          ├── SessionId: Guid                                            │ │
│  │          ├── CurrentDirectory: string?                                  │ │
│  │          ├── AutoSyncEnabled: bool                                      │ │
│  │          └── LinkedWorkspaceId: Guid?                                   │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Synchronization Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Directory Sync Data Flow                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Terminal → File Explorer (OSC 7 triggered)                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                                                                        │  │
│  │  Shell Executes `cd /path`                                            │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  Shell emits: \x1b]7;file://host/path\x07                             │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  AnsiParser.ParseByte() detects OSC 7                                 │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  AnsiParser.Osc7Received event fires                                  │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  TerminalService calls ProcessOsc7(sessionId, uri)                    │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  WorkingDirectorySyncService updates SessionSyncState                 │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  TerminalDirectoryChanged event fires                                 │  │
│  │           │                                                            │  │
│  │           ▼ (if AutoSync enabled + SyncTerminalWithWorkspace)         │  │
│  │  ExplorerDirectoryChanged event fires                                 │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  FileExplorerViewModel navigates to path                              │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  File Explorer → Terminal (Manual sync)                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                                                                        │  │
│  │  User changes directory in file explorer                              │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  FileExplorerViewModel.CurrentDirectory changed                       │  │
│  │           │                                                            │  │
│  │           ▼ (if SyncMode == ActiveTerminalOnly or AllLinkedTerminals) │  │
│  │  SyncTerminalToExplorerAsync(sessionId) called                        │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  ChangeTerminalDirectoryAsync(sessionId, path)                        │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  IShellConfigurationService.FormatChangeDirectoryCommand()            │  │
│  │           │                                                            │  │
│  │           ▼                                                            │  │
│  │  ITerminalService.WriteInputAsync("cd /path\n")                       │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## OSC 7 Escape Sequence

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       OSC 7 Format and Parsing                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Format: ESC ] 7 ; file://hostname/path BEL                                  │
│          \x1b ] 7 ;                      \x07                                │
│                                                                              │
│  Examples:                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  macOS:    \x1b]7;file://MacBook-Pro.local/Users/ryan/projects\x07   │  │
│  │  Linux:    \x1b]7;file://hostname/home/user/code\x07                  │  │
│  │  WSL:      \x1b]7;file://DESKTOP-ABC/mnt/c/Users/ryan\x07             │  │
│  │  Windows:  Uses OSC 9;9 instead (handled separately)                  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Parsing Steps:                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  1. Detect sequence start: ESC ] (0x1B 0x5D)                          │  │
│  │  2. Accumulate until BEL (0x07) or ESC \ (ST)                         │  │
│  │  3. Parse command number before first semicolon                       │  │
│  │  4. If command == 7, extract URI parameter                            │  │
│  │  5. Parse URI: new Uri(parameter)                                     │  │
│  │  6. URL-decode the LocalPath                                          │  │
│  │  7. Apply WSL path translation if needed                              │  │
│  │  8. Validate directory exists                                         │  │
│  │  9. Fire Osc7Received event                                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## WSL Path Translation

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       WSL Path Translation (Windows Only)                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  When running on Windows and receiving paths from WSL:                       │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  WSL Path               →    Windows Path                             │  │
│  │  ─────────────────────       ──────────────────                       │  │
│  │  /mnt/c/Users/ryan     →    C:\Users\ryan                             │  │
│  │  /mnt/d/Projects       →    D:\Projects                               │  │
│  │  /home/user            →    \\wsl$\Ubuntu\home\user (or kept as-is)   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Translation Logic:                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  if (path.StartsWith("/mnt/") && OperatingSystem.IsWindows())         │  │
│  │  {                                                                     │  │
│  │      var parts = path.Split('/');  // ["", "mnt", "c", "Users", ...]  │  │
│  │      if (parts.Length >= 3 && parts[1] == "mnt" && parts[2].Length==1)│  │
│  │      {                                                                 │  │
│  │          var drive = parts[2].ToUpper();    // "C"                    │  │
│  │          var rest = string.Join("\\", parts.Skip(3));                 │  │
│  │          path = $"{drive}:\\{rest}";        // "C:\Users\..."         │  │
│  │      }                                                                 │  │
│  │  }                                                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Sync Modes

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Directory Sync Mode Behavior                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  AppSettings.TerminalSyncMode determines sync behavior:                      │
│                                                                              │
│  ┌────────────────────┬──────────────────────────────────────────────────┐  │
│  │ Mode               │ Behavior                                         │  │
│  ├────────────────────┼──────────────────────────────────────────────────┤  │
│  │ ActiveTerminalOnly │ Only sync the currently focused terminal tab.   │  │
│  │                    │ Other tabs maintain independent directories.    │  │
│  │                    │ Most common/default mode.                        │  │
│  ├────────────────────┼──────────────────────────────────────────────────┤  │
│  │ AllLinkedTerminals │ Sync all terminals linked to the same workspace.│  │
│  │                    │ When one changes, all linked terminals change.  │  │
│  │                    │ Useful for multi-terminal workflows.            │  │
│  ├────────────────────┼──────────────────────────────────────────────────┤  │
│  │ Manual             │ Never auto-sync. User must explicitly sync      │  │
│  │                    │ via commands or context menu.                    │  │
│  └────────────────────┴──────────────────────────────────────────────────┘  │
│                                                                              │
│  AppSettings.SyncTerminalWithWorkspace enables/disables all syncing.        │
│  If false, no automatic sync occurs regardless of TerminalSyncMode.         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. DirectoryChangeSource.cs

**Location**: `src/AIntern.Core/Models/Terminal/DirectoryChangeSource.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Source of a working directory change.
/// </summary>
public enum DirectoryChangeSource
{
    /// <summary>Directory changed via shell command (cd).</summary>
    Shell,

    /// <summary>Directory changed via OSC 7 escape sequence.</summary>
    Osc7,

    /// <summary>Directory changed via explicit API call.</summary>
    Api,

    /// <summary>Directory changed via file explorer sync.</summary>
    ExplorerSync,

    /// <summary>Directory changed via workspace navigation.</summary>
    WorkspaceSync
}
```

### 2. DirectoryChangedEventArgs.cs

**Location**: `src/AIntern.Core/Models/Terminal/DirectoryChangedEventArgs.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Event arguments for directory change events.
/// </summary>
public sealed class DirectoryChangedEventArgs : EventArgs
{
    /// <summary>ID of the terminal session that changed.</summary>
    public Guid SessionId { get; init; }

    /// <summary>Previous working directory (empty if unknown).</summary>
    public string OldDirectory { get; init; } = string.Empty;

    /// <summary>New working directory.</summary>
    public string NewDirectory { get; init; } = string.Empty;

    /// <summary>Source of the directory change.</summary>
    public DirectoryChangeSource Source { get; init; }
}
```

### 3. Osc7EventArgs.cs

**Location**: `src/AIntern.Core/Models/Terminal/Osc7EventArgs.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Event arguments for OSC 7 escape sequence events.
/// </summary>
public sealed class Osc7EventArgs : EventArgs
{
    /// <summary>The file:// URI containing the current directory.</summary>
    public string Uri { get; init; } = string.Empty;
}
```

### 4. IWorkingDirectorySyncService.cs

**Location**: `src/AIntern.Core/Interfaces/IWorkingDirectorySyncService.cs`

```csharp
namespace AIntern.Core.Interfaces;

using AIntern.Core.Models.Terminal;

/// <summary>
/// Service for synchronizing working directories between terminal and file explorer.
/// </summary>
public interface IWorkingDirectorySyncService
{
    // === Events ===

    /// <summary>Raised when a terminal's working directory changes.</summary>
    event EventHandler<DirectoryChangedEventArgs>? TerminalDirectoryChanged;

    /// <summary>Raised when the file explorer should navigate to a directory.</summary>
    event EventHandler<DirectoryChangedEventArgs>? ExplorerDirectoryChanged;

    // === Query ===

    /// <summary>Get the current working directory for a terminal session.</summary>
    Task<string?> GetTerminalDirectoryAsync(Guid sessionId, CancellationToken ct = default);

    /// <summary>Check if auto-sync is enabled for a session.</summary>
    bool IsAutoSyncEnabled(Guid sessionId);

    // === Commands ===

    /// <summary>Change the terminal's working directory.</summary>
    Task ChangeTerminalDirectoryAsync(Guid sessionId, string path, CancellationToken ct = default);

    /// <summary>Sync terminal directory to match file explorer.</summary>
    Task SyncTerminalToExplorerAsync(Guid sessionId, string explorerPath, CancellationToken ct = default);

    /// <summary>Sync file explorer to match terminal directory.</summary>
    Task SyncExplorerToTerminalAsync(Guid sessionId, CancellationToken ct = default);

    // === Configuration ===

    /// <summary>Enable or disable automatic sync for a session.</summary>
    void SetAutoSync(Guid sessionId, bool enabled);

    // === Workspace Linking ===

    /// <summary>Link a terminal session to a workspace.</summary>
    void LinkToWorkspace(Guid sessionId, Guid workspaceId);

    /// <summary>Unlink a terminal session from its workspace.</summary>
    void UnlinkFromWorkspace(Guid sessionId);

    // === OSC Integration ===

    /// <summary>Process an OSC 7 directory report from the terminal.</summary>
    void ProcessOsc7(Guid sessionId, string uri);
}
```

### 5. WorkingDirectorySyncService.cs

**Location**: `src/AIntern.Services/Terminal/WorkingDirectorySyncService.cs`

```csharp
namespace AIntern.Services.Terminal;

using System.Collections.Concurrent;
using System.Web;
using Microsoft.Extensions.Logging;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// Manages working directory synchronization between terminal and file explorer.
/// </summary>
public sealed class WorkingDirectorySyncService : IWorkingDirectorySyncService, IDisposable
{
    private readonly ITerminalService _terminalService;
    private readonly IShellConfigurationService _shellConfig;
    private readonly ISettingsService _settingsService;
    private readonly ILogger<WorkingDirectorySyncService> _logger;

    private readonly ConcurrentDictionary<Guid, SessionSyncState> _sessionStates = new();

    public event EventHandler<DirectoryChangedEventArgs>? TerminalDirectoryChanged;
    public event EventHandler<DirectoryChangedEventArgs>? ExplorerDirectoryChanged;

    public WorkingDirectorySyncService(
        ITerminalService terminalService,
        IShellConfigurationService shellConfig,
        ISettingsService settingsService,
        ILogger<WorkingDirectorySyncService> logger)
    {
        _terminalService = terminalService;
        _shellConfig = shellConfig;
        _settingsService = settingsService;
        _logger = logger;

        _terminalService.SessionCreated += OnSessionCreated;
        _terminalService.SessionClosed += OnSessionClosed;
    }

    // === Event Handlers ===

    private void OnSessionCreated(object? sender, TerminalSessionEventArgs e)
    {
        var state = new SessionSyncState
        {
            SessionId = e.Session.Id,
            CurrentDirectory = e.Session.WorkingDirectory,
            AutoSyncEnabled = true
        };

        _sessionStates[e.Session.Id] = state;
        _logger.LogDebug("Tracking directory sync for session: {Id}", e.Session.Id);
    }

    private void OnSessionClosed(object? sender, TerminalSessionEventArgs e)
    {
        _sessionStates.TryRemove(e.Session.Id, out _);
        _logger.LogDebug("Stopped tracking session: {Id}", e.Session.Id);
    }

    // === Query ===

    public async Task<string?> GetTerminalDirectoryAsync(Guid sessionId, CancellationToken ct = default)
    {
        if (!_sessionStates.TryGetValue(sessionId, out var state))
            return null;

        if (!string.IsNullOrEmpty(state.CurrentDirectory))
            return state.CurrentDirectory;

        return await QueryShellDirectoryAsync(sessionId, ct);
    }

    public bool IsAutoSyncEnabled(Guid sessionId)
    {
        return _sessionStates.TryGetValue(sessionId, out var state) && state.AutoSyncEnabled;
    }

    // === Commands ===

    public async Task ChangeTerminalDirectoryAsync(Guid sessionId, string path, CancellationToken ct = default)
    {
        var session = _terminalService.GetSession(sessionId);
        if (session == null)
        {
            _logger.LogWarning("Cannot change directory - session not found: {Id}", sessionId);
            return;
        }

        if (!Directory.Exists(path))
        {
            _logger.LogWarning("Cannot change to non-existent directory: {Path}", path);
            return;
        }

        var command = _shellConfig.FormatChangeDirectoryCommand(session.ShellType, path);
        _logger.LogDebug("Changing directory for session {Id}: {Command}", sessionId, command);

        await _terminalService.WriteInputAsync(sessionId, command + "\n", ct);

        if (_sessionStates.TryGetValue(sessionId, out var state))
        {
            var oldDir = state.CurrentDirectory;
            state.CurrentDirectory = path;

            TerminalDirectoryChanged?.Invoke(this, new DirectoryChangedEventArgs
            {
                SessionId = sessionId,
                OldDirectory = oldDir ?? string.Empty,
                NewDirectory = path,
                Source = DirectoryChangeSource.Api
            });
        }
    }

    public async Task SyncTerminalToExplorerAsync(Guid sessionId, string explorerPath, CancellationToken ct = default)
    {
        if (string.IsNullOrEmpty(explorerPath) || !Directory.Exists(explorerPath))
        {
            _logger.LogWarning("Cannot sync terminal - invalid explorer path: {Path}", explorerPath);
            return;
        }

        await ChangeTerminalDirectoryAsync(sessionId, explorerPath, ct);

        if (_sessionStates.TryGetValue(sessionId, out var state))
        {
            TerminalDirectoryChanged?.Invoke(this, new DirectoryChangedEventArgs
            {
                SessionId = sessionId,
                NewDirectory = explorerPath,
                Source = DirectoryChangeSource.ExplorerSync
            });
        }
    }

    public async Task SyncExplorerToTerminalAsync(Guid sessionId, CancellationToken ct = default)
    {
        var directory = await GetTerminalDirectoryAsync(sessionId, ct);
        if (string.IsNullOrEmpty(directory))
        {
            _logger.LogWarning("Cannot sync explorer - no terminal directory for session: {Id}", sessionId);
            return;
        }

        ExplorerDirectoryChanged?.Invoke(this, new DirectoryChangedEventArgs
        {
            SessionId = sessionId,
            NewDirectory = directory,
            Source = DirectoryChangeSource.Shell
        });
    }

    // === Configuration ===

    public void SetAutoSync(Guid sessionId, bool enabled)
    {
        if (_sessionStates.TryGetValue(sessionId, out var state))
        {
            state.AutoSyncEnabled = enabled;
            _logger.LogDebug("Auto-sync {Status} for session: {Id}",
                enabled ? "enabled" : "disabled", sessionId);
        }
    }

    // === Workspace Linking ===

    public void LinkToWorkspace(Guid sessionId, Guid workspaceId)
    {
        if (_sessionStates.TryGetValue(sessionId, out var state))
        {
            state.LinkedWorkspaceId = workspaceId;
            _logger.LogDebug("Linked session {SessionId} to workspace {WorkspaceId}",
                sessionId, workspaceId);
        }
    }

    public void UnlinkFromWorkspace(Guid sessionId)
    {
        if (_sessionStates.TryGetValue(sessionId, out var state))
        {
            state.LinkedWorkspaceId = null;
            _logger.LogDebug("Unlinked session {Id} from workspace", sessionId);
        }
    }

    // === OSC Integration ===

    public void ProcessOsc7(Guid sessionId, string uri)
    {
        if (!_sessionStates.TryGetValue(sessionId, out var state))
            return;

        try
        {
            var parsedUri = new Uri(uri);
            var path = HttpUtility.UrlDecode(parsedUri.LocalPath);

            // Handle WSL paths on Windows
            path = TranslateWslPath(path);

            if (string.IsNullOrEmpty(path) || !Directory.Exists(path))
            {
                _logger.LogDebug("OSC 7 path does not exist: {Path}", path);
                return;
            }

            var oldDir = state.CurrentDirectory;
            state.CurrentDirectory = path;

            _logger.LogDebug("OSC 7 directory update for session {Id}: {Path}", sessionId, path);

            TerminalDirectoryChanged?.Invoke(this, new DirectoryChangedEventArgs
            {
                SessionId = sessionId,
                OldDirectory = oldDir ?? string.Empty,
                NewDirectory = path,
                Source = DirectoryChangeSource.Osc7
            });

            // Auto-sync to explorer if enabled
            var settings = _settingsService.GetSettingsAsync().GetAwaiter().GetResult();
            if (state.AutoSyncEnabled && settings.SyncTerminalWithWorkspace)
            {
                HandleAutoSync(sessionId, path, settings.TerminalSyncMode);
            }
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Failed to parse OSC 7 URI: {Uri}", uri);
        }
    }

    // === Private Methods ===

    private void HandleAutoSync(Guid sessionId, string path, DirectorySyncMode mode)
    {
        switch (mode)
        {
            case DirectorySyncMode.ActiveTerminalOnly:
                // Only sync if this is the active terminal (caller responsibility)
                ExplorerDirectoryChanged?.Invoke(this, new DirectoryChangedEventArgs
                {
                    SessionId = sessionId,
                    NewDirectory = path,
                    Source = DirectoryChangeSource.Osc7
                });
                break;

            case DirectorySyncMode.AllLinkedTerminals:
                // Sync all terminals linked to the same workspace
                if (_sessionStates.TryGetValue(sessionId, out var state) &&
                    state.LinkedWorkspaceId.HasValue)
                {
                    ExplorerDirectoryChanged?.Invoke(this, new DirectoryChangedEventArgs
                    {
                        SessionId = sessionId,
                        NewDirectory = path,
                        Source = DirectoryChangeSource.Osc7
                    });
                }
                break;

            case DirectorySyncMode.Manual:
                // No auto-sync
                break;
        }
    }

    private static string TranslateWslPath(string path)
    {
        if (!OperatingSystem.IsWindows())
            return path;

        if (!path.StartsWith("/mnt/"))
            return path;

        var parts = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2 && parts[0] == "mnt" && parts[1].Length == 1)
        {
            var drive = parts[1].ToUpper();
            var windowsPath = string.Join("\\", parts.Skip(2));
            return $"{drive}:\\{windowsPath}";
        }

        return path;
    }

    private async Task<string?> QueryShellDirectoryAsync(Guid sessionId, CancellationToken ct)
    {
        try
        {
            var session = _terminalService.GetSession(sessionId);
            if (session == null)
                return null;

            var config = _shellConfig.GetConfiguration(session.ShellPath);
            await _terminalService.WriteInputAsync(
                sessionId,
                config.PrintWorkingDirectoryCommand + "\n",
                ct);

            // Rely on OSC 7 or stored state
            return null;
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Failed to query shell directory for session: {Id}", sessionId);
            return null;
        }
    }

    public void Dispose()
    {
        _terminalService.SessionCreated -= OnSessionCreated;
        _terminalService.SessionClosed -= OnSessionClosed;
    }

    // === Internal State ===

    private sealed class SessionSyncState
    {
        public Guid SessionId { get; init; }
        public string? CurrentDirectory { get; set; }
        public bool AutoSyncEnabled { get; set; }
        public Guid? LinkedWorkspaceId { get; set; }
    }
}
```

### 6. AnsiParser Extension (OSC 7 Handling)

**File to Modify**: `src/AIntern.Core/Terminal/AnsiParser.cs`

Add the following to the existing AnsiParser class:

```csharp
/// <summary>
/// Event raised when OSC 7 (current working directory) is received.
/// </summary>
public event EventHandler<Osc7EventArgs>? Osc7Received;

/// <summary>
/// Event raised when OSC 9;9 (Windows Terminal CWD) is received.
/// </summary>
public event EventHandler<Osc7EventArgs>? Osc9CwdReceived;

private void ExecuteOscCommand()
{
    var sequence = _escapeSequence.ToString();
    var semicolonIndex = sequence.IndexOf(';');

    if (semicolonIndex <= 0)
        return;

    if (!int.TryParse(sequence.AsSpan(0, semicolonIndex), out var command))
        return;

    var parameter = sequence.Substring(semicolonIndex + 1);

    switch (command)
    {
        case 0: // Set icon name and window title
        case 2: // Set window title
            OnTitleChanged(parameter);
            break;

        case 7: // Current working directory (OSC 7)
            Osc7Received?.Invoke(this, new Osc7EventArgs { Uri = parameter });
            break;

        case 9: // ConEmu/Windows Terminal notifications
            ProcessOsc9(parameter);
            break;

        case 133: // Shell integration (prompt marks)
            ProcessOsc133(parameter);
            break;
    }
}

private void ProcessOsc9(string parameter)
{
    // OSC 9;9;"path" - Windows Terminal CWD
    var parts = parameter.Split(';', 2);
    if (parts.Length == 2 && parts[0] == "9")
    {
        var path = parts[1].Trim('"');
        Osc9CwdReceived?.Invoke(this, new Osc7EventArgs { Uri = $"file://localhost/{path}" });
    }
}

private void ProcessOsc133(string parameter)
{
    // OSC 133;A - Prompt start
    // OSC 133;B - Command start
    // OSC 133;C - Output start
    // OSC 133;D - Command finished
    // Future: Shell integration marks for command detection
}
```

---

## File Summary

| File | Location | Purpose |
|------|----------|---------|
| `DirectoryChangeSource.cs` | `src/AIntern.Core/Models/Terminal/` | Change source enumeration |
| `DirectoryChangedEventArgs.cs` | `src/AIntern.Core/Models/Terminal/` | Directory change event args |
| `Osc7EventArgs.cs` | `src/AIntern.Core/Models/Terminal/` | OSC 7 event args |
| `IWorkingDirectorySyncService.cs` | `src/AIntern.Core/Interfaces/` | Sync service interface |
| `WorkingDirectorySyncService.cs` | `src/AIntern.Services/Terminal/` | Sync service implementation |

### Files to Modify

| File | Changes |
|------|---------|
| `src/AIntern.Core/Terminal/AnsiParser.cs` | Add OSC 7/9 handling, Osc7Received event |
| `src/AIntern.Services/Terminal/TerminalService.cs` | Wire up Osc7Received to ProcessOsc7() |
| `src/AIntern.Services/DependencyInjection.cs` | Register IWorkingDirectorySyncService |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `ProcessOsc7_ValidUri_UpdatesDirectory` | Parses file:// URI correctly |
| `ProcessOsc7_InvalidUri_LogsWarning` | Handles malformed URIs |
| `ProcessOsc7_NonExistentPath_NoUpdate` | Ignores invalid paths |
| `TranslateWslPath_MntPath_ReturnsWindowsPath` | /mnt/c → C:\ |
| `TranslateWslPath_LinuxPath_ReturnsUnchanged` | /home/user unchanged |
| `ChangeTerminalDirectoryAsync_ValidPath_SendsCommand` | Sends cd command |
| `ChangeTerminalDirectoryAsync_InvalidPath_LogsWarning` | Rejects non-existent |
| `SetAutoSync_EnablesDisables_UpdatesState` | Toggles auto-sync |
| `LinkToWorkspace_SetsWorkspaceId` | Links session to workspace |
| `UnlinkFromWorkspace_ClearsWorkspaceId` | Unlinks session |
| `GetTerminalDirectoryAsync_ReturnsStoredDirectory` | Returns cached directory |
| `SyncExplorerToTerminalAsync_FiresEvent` | Raises ExplorerDirectoryChanged |
| `OnSessionCreated_TracksSession` | Adds to _sessionStates |
| `OnSessionClosed_RemovesSession` | Removes from _sessionStates |
| `AnsiParser_Osc7_RaisesEvent` | Parses OSC 7 sequence |
| `AnsiParser_Osc9_TranslatesToOsc7` | OSC 9;9 → file:// URI |

**Total Tests**: 16

---

## Verification

```bash
# Verify compilation
dotnet build src/AIntern.Services

# Run unit tests
dotnet test --filter "WorkingDirectorySync"
dotnet test --filter "Osc7"

# Manual test: In terminal, run:
printf '\e]7;file://localhost/tmp\a'
# Verify directory update event fires
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | OSC 7 sequences are correctly parsed from terminal output |
| AC-2 | Directory changes trigger TerminalDirectoryChanged event |
| AC-3 | Auto-sync respects AppSettings.SyncTerminalWithWorkspace |
| AC-4 | Auto-sync respects AppSettings.TerminalSyncMode |
| AC-5 | Bi-directional sync works (terminal ↔ explorer) |
| AC-6 | WSL /mnt/x paths translated to X:\ on Windows |
| AC-7 | Invalid/non-existent paths are handled gracefully |
| AC-8 | Sessions can be linked/unlinked from workspaces |
| AC-9 | OSC 9;9 (Windows Terminal) sequences handled |

---

## Changelog Entry

```markdown
## v0.5.3e - Working Directory Synchronization

### Added
- `DirectoryChangeSource` enumeration (Shell, Osc7, Api, ExplorerSync, WorkspaceSync)
- `DirectoryChangedEventArgs` for directory change events
- `Osc7EventArgs` for OSC 7 escape sequence events
- `IWorkingDirectorySyncService` interface with:
  - Events: TerminalDirectoryChanged, ExplorerDirectoryChanged
  - Query: GetTerminalDirectoryAsync, IsAutoSyncEnabled
  - Commands: ChangeTerminalDirectoryAsync, SyncTerminalToExplorerAsync, SyncExplorerToTerminalAsync
  - Configuration: SetAutoSync
  - Workspace: LinkToWorkspace, UnlinkFromWorkspace
  - OSC: ProcessOsc7

- `WorkingDirectorySyncService` implementation with:
  - OSC 7 URI parsing and directory extraction
  - WSL path translation on Windows (/mnt/c → C:\)
  - Session lifecycle tracking via ITerminalService events
  - Sync mode support (ActiveTerminalOnly, AllLinkedTerminals, Manual)
  - Workspace linking for multi-terminal sync

### Changed
- Extended `AnsiParser` with:
  - Osc7Received event for directory reporting
  - Osc9CwdReceived event for Windows Terminal compatibility
  - OSC 133 shell integration mark parsing (foundation)
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.3e | 0.75 day |
