# Design Specification: AIntern v0.5.5d "Keyboard Shortcuts System"

## Overview

**Version**: v0.5.5d
**Parent**: v0.5.5 Polish & Integration
**Focus**: Comprehensive keyboard shortcut system with registry, mapping, and customization

### Purpose

This sub-version implements the keyboard shortcuts system:
1. Define `TerminalShortcutAction` enum with all terminal actions
2. Create `KeyBinding` model for shortcut definitions
3. Define `IKeyboardShortcutService` interface for shortcut management
4. Implement `KeyboardShortcutService` with default bindings and persistence
5. Support platform-specific key formatting (Ctrl vs ⌘)
6. Handle PTY pass-through shortcuts (Ctrl+C, Ctrl+Z)
7. Integrate with `TerminalControl` for key handling
8. Support custom bindings with conflict detection

### Dependencies

**From v0.5.1 (Terminal Foundation)**:
- `ITerminalService` - Terminal operations

**From v0.5.5c (Terminal Search UI)**:
- Search bar commands for OpenSearch/CloseSearch

**From AppSettings**:
- `CustomKeyBindings` dictionary for persistence

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.5.5d Keyboard Shortcuts System Architecture               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Model Layer                                        │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalShortcutAction (enum)                                           │ │
│  │  ├── Terminal Panel: ToggleTerminal, NewTerminal, CloseTerminal...      │ │
│  │  ├── Terminal Input: SendInterrupt, SendSuspend, SendEof...             │ │
│  │  ├── Terminal Search: OpenSearch, CloseSearch, NextSearchResult...      │ │
│  │  ├── Terminal Selection: Copy, Paste, SelectAll                         │ │
│  │  ├── Terminal Scroll: ScrollPageUp, ScrollPageDown...                   │ │
│  │  └── Command Blocks: ExecuteCommand, SendToTerminal                     │ │
│  │                                                                          │ │
│  │  KeyBinding (class)                                                      │ │
│  │  ├── Action: TerminalShortcutAction                                     │ │
│  │  ├── Key: Avalonia.Input.Key                                            │ │
│  │  ├── Modifiers: KeyModifiers                                            │ │
│  │  ├── Description: string                                                │ │
│  │  ├── Category: string                                                   │ │
│  │  ├── IsCustomizable: bool                                               │ │
│  │  ├── PassToPty: bool                                                    │ │
│  │  └── DisplayString: string (computed, platform-aware)                   │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                      Service Layer                                       │ │
│  │  src/AIntern.Services/                                                  │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  IKeyboardShortcutService                                                │ │
│  │  ├── GetAllBindings() → IReadOnlyList<KeyBinding>                       │ │
│  │  ├── GetBindingsByCategory(category) → IReadOnlyList<KeyBinding>        │ │
│  │  ├── TryGetAction(key, modifiers) → (bool, TerminalShortcutAction)      │ │
│  │  ├── GetBinding(action) → KeyBinding?                                   │ │
│  │  ├── UpdateBinding(action, key, modifiers) → bool                       │ │
│  │  ├── ResetBinding(action)                                               │ │
│  │  ├── ResetAllBindings()                                                 │ │
│  │  ├── HasConflict(key, modifiers, exclude?) → bool                       │ │
│  │  └── GetConflictingBinding(key, modifiers, exclude?) → KeyBinding?      │ │
│  │                                                                          │ │
│  │  KeyboardShortcutService                                                 │ │
│  │  ├── _bindings: Dictionary<(Key, KeyModifiers), KeyBinding>             │ │
│  │  ├── _defaultBindings: Dictionary<TerminalShortcutAction, KeyBinding>   │ │
│  │  ├── _actionBindings: Dictionary<TerminalShortcutAction, KeyBinding>    │ │
│  │  ├── InitializeDefaultBindings()                                        │ │
│  │  ├── LoadCustomBindings()                                               │ │
│  │  └── SaveCustomBindings()                                               │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     Integration Layer                                    │ │
│  │  src/AIntern.Desktop/                                                   │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalControl.axaml.cs                                                │ │
│  │  ├── OnKeyDown override                                                 │ │
│  │  ├── TryGetAction call                                                  │ │
│  │  ├── PassToPty check                                                    │ │
│  │  └── HandleShortcutAction switch                                        │ │
│  │                                                                          │ │
│  │  MainWindow.axaml.cs                                                     │ │
│  │  ├── Global shortcuts (ToggleTerminal)                                  │ │
│  │  └── Command block shortcuts (ExecuteCommand)                           │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Shortcut Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Keyboard Event Flow                                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User presses Ctrl+Shift+C                                                   │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  TerminalControl.OnKeyDown(KeyEventArgs)                                │ │
│  │  ├── key = Key.C                                                        │ │
│  │  └── modifiers = Control | Shift                                        │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │                                                │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  _shortcutService.TryGetAction(key, modifiers, out action)              │ │
│  │  ├── Lookup in _bindings dictionary                                     │ │
│  │  ├── Key: (Key.C, Control | Shift)                                      │ │
│  │  └── Found: action = Copy                                               │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │                                                │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Check binding.PassToPty                                                │ │
│  │  ├── Copy: PassToPty = false → Handle action                           │ │
│  │  └── If true: Let event pass to PTY                                     │ │
│  └──────────────────────────┬─────────────────────────────────────────────┘ │
│                             │ PassToPty = false                              │
│                             ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  HandleShortcutAction(TerminalShortcutAction.Copy)                      │ │
│  │  ├── switch (action)                                                    │ │
│  │  ├── case Copy: CopySelectionCommand.Execute(null)                     │ │
│  │  └── e.Handled = true                                                   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  User presses Ctrl+C (in terminal)                                           │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  TryGetAction(Key.C, Control) → action = SendInterrupt                  │ │
│  │  binding.PassToPty = true                                               │ │
│  │     │                                                                    │ │
│  │     └── Do NOT handle, let event bubble → PTY receives SIGINT           │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Default Bindings Reference

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      Default Keyboard Bindings                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  TERMINAL PANEL                                                       │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Ctrl+`          │ Toggle terminal panel                              │  │
│  │  Ctrl+Shift+`    │ New terminal tab                                   │  │
│  │  Ctrl+Shift+W    │ Close terminal tab                                 │  │
│  │  Ctrl+PageUp     │ Previous terminal tab                              │  │
│  │  Ctrl+PageDown   │ Next terminal tab                                  │  │
│  │  Ctrl+Shift+1-9  │ Switch to terminal 1-9                             │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  TERMINAL INPUT (PassToPty = true)                                    │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Ctrl+C          │ Send SIGINT (interrupt)                            │  │
│  │  Ctrl+Z          │ Send SIGTSTP (suspend)                             │  │
│  │  Ctrl+D          │ Send EOF                                           │  │
│  │  Ctrl+L          │ Clear terminal                                     │  │
│  │  Ctrl+U          │ Clear line before cursor                           │  │
│  │  Ctrl+K          │ Clear line after cursor                            │  │
│  │  Ctrl+W          │ Delete word before cursor                          │  │
│  │  Ctrl+A          │ Move to line start                                 │  │
│  │  Ctrl+E          │ Move to line end                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  TERMINAL SEARCH                                                      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Ctrl+F          │ Open search                                        │  │
│  │  Escape          │ Close search                                       │  │
│  │  Enter           │ Next search result                                 │  │
│  │  Shift+Enter     │ Previous search result                             │  │
│  │  F3              │ Next search result (alt)                           │  │
│  │  Shift+F3        │ Previous search result (alt)                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  TERMINAL SELECTION                                                   │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Ctrl+Shift+C    │ Copy selection                                     │  │
│  │  Ctrl+Shift+V    │ Paste from clipboard                               │  │
│  │  Ctrl+Shift+A    │ Select all                                         │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  TERMINAL SCROLL                                                      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Shift+PageUp    │ Scroll page up                                     │  │
│  │  Shift+PageDown  │ Scroll page down                                   │  │
│  │  Shift+Home      │ Scroll to top                                      │  │
│  │  Shift+End       │ Scroll to bottom                                   │  │
│  │  Ctrl+Shift+↑    │ Scroll line up                                     │  │
│  │  Ctrl+Shift+↓    │ Scroll line down                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  COMMAND BLOCKS                                                       │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  Ctrl+Enter      │ Execute focused command                            │  │
│  │  Ctrl+Shift+Enter│ Send to terminal (no execute)                      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. TerminalShortcutAction.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalShortcutAction.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Enum defining all available terminal keyboard shortcut actions.
/// Organized by category for display in settings UI.
/// </summary>
public enum TerminalShortcutAction
{
    // ========== Terminal Panel (0-20) ==========
    
    /// <summary>Show/hide the terminal panel.</summary>
    ToggleTerminal = 0,
    
    /// <summary>Create a new terminal tab.</summary>
    NewTerminal = 1,
    
    /// <summary>Close the active terminal tab.</summary>
    CloseTerminal = 2,
    
    /// <summary>Switch to the previous terminal tab.</summary>
    PreviousTerminalTab = 3,
    
    /// <summary>Switch to the next terminal tab.</summary>
    NextTerminalTab = 4,
    
    /// <summary>Switch to terminal tab 1.</summary>
    SwitchToTerminal1 = 5,
    
    /// <summary>Switch to terminal tab 2.</summary>
    SwitchToTerminal2 = 6,
    
    /// <summary>Switch to terminal tab 3.</summary>
    SwitchToTerminal3 = 7,
    
    /// <summary>Switch to terminal tab 4.</summary>
    SwitchToTerminal4 = 8,
    
    /// <summary>Switch to terminal tab 5.</summary>
    SwitchToTerminal5 = 9,
    
    /// <summary>Switch to terminal tab 6.</summary>
    SwitchToTerminal6 = 10,
    
    /// <summary>Switch to terminal tab 7.</summary>
    SwitchToTerminal7 = 11,
    
    /// <summary>Switch to terminal tab 8.</summary>
    SwitchToTerminal8 = 12,
    
    /// <summary>Switch to terminal tab 9.</summary>
    SwitchToTerminal9 = 13,

    // ========== Terminal Input (100-120) - Passed to PTY ==========
    
    /// <summary>Send SIGINT (interrupt current process).</summary>
    SendInterrupt = 100,
    
    /// <summary>Send SIGTSTP (suspend current process).</summary>
    SendSuspend = 101,
    
    /// <summary>Send EOF (end of file).</summary>
    SendEof = 102,
    
    /// <summary>Clear terminal screen.</summary>
    ClearTerminal = 103,
    
    /// <summary>Clear line before cursor.</summary>
    ClearLineBefore = 104,
    
    /// <summary>Clear line after cursor.</summary>
    ClearLineAfter = 105,
    
    /// <summary>Delete word before cursor.</summary>
    DeleteWordBefore = 106,
    
    /// <summary>Move cursor to line start.</summary>
    MoveToLineStart = 107,
    
    /// <summary>Move cursor to line end.</summary>
    MoveToLineEnd = 108,

    // ========== Terminal Search (200-220) ==========
    
    /// <summary>Open the terminal search bar.</summary>
    OpenSearch = 200,
    
    /// <summary>Close the terminal search bar.</summary>
    CloseSearch = 201,
    
    /// <summary>Navigate to the next search result.</summary>
    NextSearchResult = 202,
    
    /// <summary>Navigate to the previous search result.</summary>
    PreviousSearchResult = 203,

    // ========== Terminal Selection (300-320) ==========
    
    /// <summary>Copy selected text to clipboard.</summary>
    Copy = 300,
    
    /// <summary>Paste from clipboard.</summary>
    Paste = 301,
    
    /// <summary>Select all terminal content.</summary>
    SelectAll = 302,

    // ========== Terminal Scroll (400-420) ==========
    
    /// <summary>Scroll up one page.</summary>
    ScrollPageUp = 400,
    
    /// <summary>Scroll down one page.</summary>
    ScrollPageDown = 401,
    
    /// <summary>Scroll to the top of the buffer.</summary>
    ScrollToTop = 402,
    
    /// <summary>Scroll to the bottom of the buffer.</summary>
    ScrollToBottom = 403,
    
    /// <summary>Scroll up one line.</summary>
    ScrollLineUp = 404,
    
    /// <summary>Scroll down one line.</summary>
    ScrollLineDown = 405,

    // ========== Command Blocks (500-520) ==========
    
    /// <summary>Execute the focused command block.</summary>
    ExecuteCommand = 500,
    
    /// <summary>Send command to terminal without executing.</summary>
    SendToTerminal = 501
}
```

### 2. KeyBinding.cs

**Location**: `src/AIntern.Core/Models/Terminal/KeyBinding.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

using Avalonia.Input;

/// <summary>
/// Represents a keyboard shortcut binding with key, modifiers, and metadata.
/// </summary>
public sealed class KeyBinding
{
    /// <summary>
    /// The action this binding triggers.
    /// </summary>
    public TerminalShortcutAction Action { get; init; }

    /// <summary>
    /// The primary key for this binding.
    /// </summary>
    public Key Key { get; init; }

    /// <summary>
    /// Required modifier keys (Ctrl, Shift, Alt).
    /// </summary>
    public KeyModifiers Modifiers { get; init; }

    /// <summary>
    /// Human-readable description of the shortcut action.
    /// </summary>
    public string Description { get; init; } = string.Empty;

    /// <summary>
    /// Category for grouping in settings UI.
    /// </summary>
    public string Category { get; init; } = string.Empty;

    /// <summary>
    /// Whether this binding can be customized by the user.
    /// Some system shortcuts are not customizable.
    /// </summary>
    public bool IsCustomizable { get; init; } = true;

    /// <summary>
    /// Whether this shortcut should be passed through to the PTY
    /// instead of being handled by the application.
    /// Used for shell shortcuts like Ctrl+C, Ctrl+Z.
    /// </summary>
    public bool PassToPty { get; init; }

    /// <summary>
    /// Gets the formatted shortcut string for display.
    /// Platform-aware: uses ⌘ on macOS, Ctrl on Windows/Linux.
    /// </summary>
    public string DisplayString => FormatKeyBinding();

    /// <summary>
    /// Gets the shortcut in a parseable format (e.g., "Ctrl+Shift+C").
    /// </summary>
    public string SerializedString => FormatKeyBinding(usePlatformSymbols: false);

    /// <summary>
    /// Creates a copy of this binding with a new key/modifier combination.
    /// </summary>
    public KeyBinding WithKey(Key key, KeyModifiers modifiers)
    {
        return new KeyBinding
        {
            Action = Action,
            Key = key,
            Modifiers = modifiers,
            Description = Description,
            Category = Category,
            IsCustomizable = IsCustomizable,
            PassToPty = PassToPty
        };
    }

    private string FormatKeyBinding(bool usePlatformSymbols = true)
    {
        var parts = new List<string>();

        var isMac = OperatingSystem.IsMacOS() && usePlatformSymbols;

        if (Modifiers.HasFlag(KeyModifiers.Control))
            parts.Add(isMac ? "⌘" : "Ctrl");
        
        if (Modifiers.HasFlag(KeyModifiers.Alt))
            parts.Add(isMac ? "⌥" : "Alt");
        
        if (Modifiers.HasFlag(KeyModifiers.Shift))
            parts.Add(isMac ? "⇧" : "Shift");
        
        if (Modifiers.HasFlag(KeyModifiers.Meta))
            parts.Add(isMac ? "⌃" : "Meta");

        parts.Add(FormatKey(Key));

        return string.Join("+", parts);
    }

    private static string FormatKey(Key key) => key switch
    {
        Key.OemTilde => "`",
        Key.OemMinus => "-",
        Key.OemPlus => "=",
        Key.OemOpenBrackets => "[",
        Key.OemCloseBrackets => "]",
        Key.OemPipe => "\\",
        Key.OemSemicolon => ";",
        Key.OemQuotes => "'",
        Key.OemComma => ",",
        Key.OemPeriod => ".",
        Key.OemQuestion => "/",
        Key.PageUp => "PgUp",
        Key.PageDown => "PgDn",
        Key.Escape => "Esc",
        Key.Delete => "Del",
        Key.Insert => "Ins",
        Key.Back => "Backspace",
        Key.Return => "Enter",
        Key.Up => "↑",
        Key.Down => "↓",
        Key.Left => "←",
        Key.Right => "→",
        Key.D0 => "0",
        Key.D1 => "1",
        Key.D2 => "2",
        Key.D3 => "3",
        Key.D4 => "4",
        Key.D5 => "5",
        Key.D6 => "6",
        Key.D7 => "7",
        Key.D8 => "8",
        Key.D9 => "9",
        _ => key.ToString()
    };

    /// <summary>
    /// Parses a serialized string like "Ctrl+Shift+C" into key/modifiers.
    /// </summary>
    public static (Key key, KeyModifiers modifiers) Parse(string serialized)
    {
        var parts = serialized.Split('+');
        var modifiers = KeyModifiers.None;
        var key = Key.None;

        foreach (var part in parts)
        {
            var trimmed = part.Trim();
            switch (trimmed.ToLowerInvariant())
            {
                case "ctrl":
                case "control":
                case "⌘":
                    modifiers |= KeyModifiers.Control;
                    break;
                case "alt":
                case "⌥":
                    modifiers |= KeyModifiers.Alt;
                    break;
                case "shift":
                case "⇧":
                    modifiers |= KeyModifiers.Shift;
                    break;
                case "meta":
                case "⌃":
                    modifiers |= KeyModifiers.Meta;
                    break;
                default:
                    key = ParseKey(trimmed);
                    break;
            }
        }

        return (key, modifiers);
    }

    private static Key ParseKey(string keyString) => keyString.ToLowerInvariant() switch
    {
        "`" => Key.OemTilde,
        "-" => Key.OemMinus,
        "=" => Key.OemPlus,
        "[" => Key.OemOpenBrackets,
        "]" => Key.OemCloseBrackets,
        "\\" => Key.OemPipe,
        ";" => Key.OemSemicolon,
        "'" => Key.OemQuotes,
        "," => Key.OemComma,
        "." => Key.OemPeriod,
        "/" => Key.OemQuestion,
        "pgup" or "pageup" => Key.PageUp,
        "pgdn" or "pagedown" => Key.PageDown,
        "esc" or "escape" => Key.Escape,
        "del" or "delete" => Key.Delete,
        "ins" or "insert" => Key.Insert,
        "backspace" or "back" => Key.Back,
        "enter" or "return" => Key.Return,
        "↑" or "up" => Key.Up,
        "↓" or "down" => Key.Down,
        "←" or "left" => Key.Left,
        "→" or "right" => Key.Right,
        "0" => Key.D0,
        "1" => Key.D1,
        "2" => Key.D2,
        "3" => Key.D3,
        "4" => Key.D4,
        "5" => Key.D5,
        "6" => Key.D6,
        "7" => Key.D7,
        "8" => Key.D8,
        "9" => Key.D9,
        _ => Enum.TryParse<Key>(keyString, ignoreCase: true, out var k) ? k : Key.None
    };

    public override string ToString() => $"{DisplayString} → {Description}";
}
```

### 3. IKeyboardShortcutService.cs

**Location**: `src/AIntern.Core/Interfaces/IKeyboardShortcutService.cs`

```csharp
namespace AIntern.Core.Interfaces;

using Avalonia.Input;
using AIntern.Core.Models.Terminal;

/// <summary>
/// Service for managing and handling keyboard shortcuts.
/// </summary>
public interface IKeyboardShortcutService
{
    /// <summary>
    /// Gets all registered keyboard bindings.
    /// </summary>
    IReadOnlyList<KeyBinding> GetAllBindings();

    /// <summary>
    /// Gets bindings filtered by category.
    /// </summary>
    IReadOnlyList<KeyBinding> GetBindingsByCategory(string category);

    /// <summary>
    /// Gets all unique categories.
    /// </summary>
    IReadOnlyList<string> GetCategories();

    /// <summary>
    /// Gets the binding for a specific action.
    /// </summary>
    KeyBinding? GetBinding(TerminalShortcutAction action);

    /// <summary>
    /// Tries to match a key event to an action.
    /// </summary>
    /// <param name="key">The pressed key.</param>
    /// <param name="modifiers">Active modifier keys.</param>
    /// <param name="action">The matched action, if any.</param>
    /// <returns>True if a binding was matched.</returns>
    bool TryGetAction(Key key, KeyModifiers modifiers, out TerminalShortcutAction action);

    /// <summary>
    /// Gets the binding that matches a key combination.
    /// </summary>
    KeyBinding? GetBindingByKey(Key key, KeyModifiers modifiers);

    /// <summary>
    /// Updates a custom key binding.
    /// </summary>
    /// <param name="action">The action to rebind.</param>
    /// <param name="key">New key.</param>
    /// <param name="modifiers">New modifiers.</param>
    /// <returns>True if binding was updated successfully.</returns>
    bool UpdateBinding(TerminalShortcutAction action, Key key, KeyModifiers modifiers);

    /// <summary>
    /// Resets a binding to its default.
    /// </summary>
    void ResetBinding(TerminalShortcutAction action);

    /// <summary>
    /// Resets all bindings to defaults.
    /// </summary>
    void ResetAllBindings();

    /// <summary>
    /// Checks if a key combination conflicts with existing bindings.
    /// </summary>
    /// <param name="key">Key to check.</param>
    /// <param name="modifiers">Modifiers to check.</param>
    /// <param name="exclude">Optional action to exclude from conflict check.</param>
    /// <returns>True if there's a conflict.</returns>
    bool HasConflict(Key key, KeyModifiers modifiers, TerminalShortcutAction? exclude = null);

    /// <summary>
    /// Gets the binding that would conflict with a key combination.
    /// </summary>
    KeyBinding? GetConflictingBinding(Key key, KeyModifiers modifiers, TerminalShortcutAction? exclude = null);

    /// <summary>
    /// Event raised when bindings are changed.
    /// </summary>
    event EventHandler? BindingsChanged;
}
```

### 4. KeyboardShortcutService.cs

**Location**: `src/AIntern.Services/KeyboardShortcutService.cs`

```csharp
namespace AIntern.Services;

using Avalonia.Input;
using Microsoft.Extensions.Logging;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// Service for managing and handling keyboard shortcuts.
/// </summary>
public sealed class KeyboardShortcutService : IKeyboardShortcutService
{
    private readonly ILogger<KeyboardShortcutService> _logger;
    private readonly ISettingsService _settingsService;
    
    // Key combination → Binding lookup
    private readonly Dictionary<(Key, KeyModifiers), KeyBinding> _bindings = new();
    
    // Action → Default binding lookup
    private readonly Dictionary<TerminalShortcutAction, KeyBinding> _defaultBindings = new();
    
    // Action → Current binding lookup
    private readonly Dictionary<TerminalShortcutAction, KeyBinding> _actionBindings = new();

    public event EventHandler? BindingsChanged;

    public KeyboardShortcutService(
        ILogger<KeyboardShortcutService> logger,
        ISettingsService settingsService)
    {
        _logger = logger;
        _settingsService = settingsService;
        
        InitializeDefaultBindings();
        LoadCustomBindings();
    }

    private void InitializeDefaultBindings()
    {
        // === Terminal Panel ===
        Register(TerminalShortcutAction.ToggleTerminal,
            Key.OemTilde, KeyModifiers.Control, 
            "Toggle Terminal", "Terminal Panel");
        
        Register(TerminalShortcutAction.NewTerminal,
            Key.OemTilde, KeyModifiers.Control | KeyModifiers.Shift, 
            "New Terminal", "Terminal Panel");
        
        Register(TerminalShortcutAction.CloseTerminal,
            Key.W, KeyModifiers.Control | KeyModifiers.Shift, 
            "Close Terminal", "Terminal Panel");
        
        Register(TerminalShortcutAction.PreviousTerminalTab,
            Key.PageUp, KeyModifiers.Control, 
            "Previous Tab", "Terminal Panel");
        
        Register(TerminalShortcutAction.NextTerminalTab,
            Key.PageDown, KeyModifiers.Control, 
            "Next Tab", "Terminal Panel");

        // Terminal tabs 1-9
        RegisterTerminalTabBindings();

        // === Terminal Input (PassToPty) ===
        Register(TerminalShortcutAction.SendInterrupt,
            Key.C, KeyModifiers.Control, 
            "Interrupt (SIGINT)", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.SendSuspend,
            Key.Z, KeyModifiers.Control, 
            "Suspend (SIGTSTP)", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.SendEof,
            Key.D, KeyModifiers.Control, 
            "Send EOF", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.ClearTerminal,
            Key.L, KeyModifiers.Control, 
            "Clear Terminal", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.ClearLineBefore,
            Key.U, KeyModifiers.Control, 
            "Clear Line Before Cursor", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.ClearLineAfter,
            Key.K, KeyModifiers.Control, 
            "Clear Line After Cursor", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.DeleteWordBefore,
            Key.W, KeyModifiers.Control, 
            "Delete Word Before", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.MoveToLineStart,
            Key.A, KeyModifiers.Control, 
            "Move to Line Start", "Terminal Input", passToPty: true);
        
        Register(TerminalShortcutAction.MoveToLineEnd,
            Key.E, KeyModifiers.Control, 
            "Move to Line End", "Terminal Input", passToPty: true);

        // === Terminal Search ===
        Register(TerminalShortcutAction.OpenSearch,
            Key.F, KeyModifiers.Control, 
            "Open Search", "Terminal Search");
        
        Register(TerminalShortcutAction.CloseSearch,
            Key.Escape, KeyModifiers.None, 
            "Close Search", "Terminal Search");
        
        Register(TerminalShortcutAction.NextSearchResult,
            Key.F3, KeyModifiers.None, 
            "Next Result", "Terminal Search");
        
        Register(TerminalShortcutAction.PreviousSearchResult,
            Key.F3, KeyModifiers.Shift, 
            "Previous Result", "Terminal Search");

        // === Terminal Selection ===
        Register(TerminalShortcutAction.Copy,
            Key.C, KeyModifiers.Control | KeyModifiers.Shift, 
            "Copy", "Terminal Selection");
        
        Register(TerminalShortcutAction.Paste,
            Key.V, KeyModifiers.Control | KeyModifiers.Shift, 
            "Paste", "Terminal Selection");
        
        Register(TerminalShortcutAction.SelectAll,
            Key.A, KeyModifiers.Control | KeyModifiers.Shift, 
            "Select All", "Terminal Selection");

        // === Terminal Scroll ===
        Register(TerminalShortcutAction.ScrollPageUp,
            Key.PageUp, KeyModifiers.Shift, 
            "Scroll Page Up", "Terminal Scroll");
        
        Register(TerminalShortcutAction.ScrollPageDown,
            Key.PageDown, KeyModifiers.Shift, 
            "Scroll Page Down", "Terminal Scroll");
        
        Register(TerminalShortcutAction.ScrollToTop,
            Key.Home, KeyModifiers.Shift, 
            "Scroll to Top", "Terminal Scroll");
        
        Register(TerminalShortcutAction.ScrollToBottom,
            Key.End, KeyModifiers.Shift, 
            "Scroll to Bottom", "Terminal Scroll");
        
        Register(TerminalShortcutAction.ScrollLineUp,
            Key.Up, KeyModifiers.Control | KeyModifiers.Shift, 
            "Scroll Line Up", "Terminal Scroll");
        
        Register(TerminalShortcutAction.ScrollLineDown,
            Key.Down, KeyModifiers.Control | KeyModifiers.Shift, 
            "Scroll Line Down", "Terminal Scroll");

        // === Command Blocks ===
        Register(TerminalShortcutAction.ExecuteCommand,
            Key.Return, KeyModifiers.Control, 
            "Execute Command", "Command Blocks");
        
        Register(TerminalShortcutAction.SendToTerminal,
            Key.Return, KeyModifiers.Control | KeyModifiers.Shift, 
            "Send to Terminal", "Command Blocks");

        _logger.LogDebug("Initialized {Count} default bindings", _defaultBindings.Count);
    }

    private void RegisterTerminalTabBindings()
    {
        var tabActions = new[]
        {
            TerminalShortcutAction.SwitchToTerminal1,
            TerminalShortcutAction.SwitchToTerminal2,
            TerminalShortcutAction.SwitchToTerminal3,
            TerminalShortcutAction.SwitchToTerminal4,
            TerminalShortcutAction.SwitchToTerminal5,
            TerminalShortcutAction.SwitchToTerminal6,
            TerminalShortcutAction.SwitchToTerminal7,
            TerminalShortcutAction.SwitchToTerminal8,
            TerminalShortcutAction.SwitchToTerminal9
        };

        for (int i = 0; i < tabActions.Length; i++)
        {
            var key = Key.D1 + i; // Key.D1 = 1, Key.D2 = 2, etc.
            Register(tabActions[i],
                key, KeyModifiers.Control | KeyModifiers.Shift,
                $"Switch to Terminal {i + 1}", "Terminal Panel");
        }
    }

    private void Register(
        TerminalShortcutAction action,
        Key key,
        KeyModifiers modifiers,
        string description,
        string category,
        bool passToPty = false,
        bool isCustomizable = true)
    {
        var binding = new KeyBinding
        {
            Action = action,
            Key = key,
            Modifiers = modifiers,
            Description = description,
            Category = category,
            PassToPty = passToPty,
            IsCustomizable = isCustomizable
        };

        _defaultBindings[action] = binding;
        _bindings[(key, modifiers)] = binding;
        _actionBindings[action] = binding;
    }

    private void LoadCustomBindings()
    {
        var customBindings = _settingsService.CurrentSettings?.CustomKeyBindings;
        if (customBindings == null || customBindings.Count == 0)
            return;

        _logger.LogDebug("Loading {Count} custom bindings", customBindings.Count);

        foreach (var (actionName, keyCombo) in customBindings)
        {
            if (!Enum.TryParse<TerminalShortcutAction>(actionName, out var action))
            {
                _logger.LogWarning("Unknown action in custom bindings: {Action}", actionName);
                continue;
            }

            try
            {
                var (key, modifiers) = KeyBinding.Parse(keyCombo);
                
                // Remove old binding
                var oldBinding = _actionBindings.GetValueOrDefault(action);
                if (oldBinding != null)
                {
                    _bindings.Remove((oldBinding.Key, oldBinding.Modifiers));
                }

                // Add new binding
                var defaultBinding = _defaultBindings[action];
                var newBinding = defaultBinding.WithKey(key, modifiers);
                
                _bindings[(key, modifiers)] = newBinding;
                _actionBindings[action] = newBinding;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, "Failed to parse custom binding: {Action}={KeyCombo}", 
                    actionName, keyCombo);
            }
        }
    }

    /// <inheritdoc />
    public IReadOnlyList<KeyBinding> GetAllBindings() =>
        _actionBindings.Values.ToList();

    /// <inheritdoc />
    public IReadOnlyList<KeyBinding> GetBindingsByCategory(string category) =>
        _actionBindings.Values
            .Where(b => b.Category == category)
            .OrderBy(b => b.Description)
            .ToList();

    /// <inheritdoc />
    public IReadOnlyList<string> GetCategories() =>
        _actionBindings.Values
            .Select(b => b.Category)
            .Distinct()
            .OrderBy(c => c)
            .ToList();

    /// <inheritdoc />
    public KeyBinding? GetBinding(TerminalShortcutAction action) =>
        _actionBindings.GetValueOrDefault(action);

    /// <inheritdoc />
    public bool TryGetAction(Key key, KeyModifiers modifiers, out TerminalShortcutAction action)
    {
        if (_bindings.TryGetValue((key, modifiers), out var binding))
        {
            action = binding.Action;
            return true;
        }

        action = default;
        return false;
    }

    /// <inheritdoc />
    public KeyBinding? GetBindingByKey(Key key, KeyModifiers modifiers) =>
        _bindings.GetValueOrDefault((key, modifiers));

    /// <inheritdoc />
    public bool UpdateBinding(TerminalShortcutAction action, Key key, KeyModifiers modifiers)
    {
        if (!_defaultBindings.TryGetValue(action, out var defaultBinding))
        {
            _logger.LogWarning("Attempted to update unknown action: {Action}", action);
            return false;
        }

        if (!defaultBinding.IsCustomizable)
        {
            _logger.LogWarning("Attempted to update non-customizable binding: {Action}", action);
            return false;
        }

        if (HasConflict(key, modifiers, action))
        {
            var conflict = GetConflictingBinding(key, modifiers, action);
            _logger.LogWarning("Binding conflict: {Action} conflicts with {Conflict}", 
                action, conflict?.Action);
            return false;
        }

        // Remove old binding
        var oldBinding = _actionBindings.GetValueOrDefault(action);
        if (oldBinding != null)
        {
            _bindings.Remove((oldBinding.Key, oldBinding.Modifiers));
        }

        // Add new binding
        var newBinding = defaultBinding.WithKey(key, modifiers);
        _bindings[(key, modifiers)] = newBinding;
        _actionBindings[action] = newBinding;

        SaveCustomBindings();
        BindingsChanged?.Invoke(this, EventArgs.Empty);

        _logger.LogInformation("Updated binding: {Action} = {Key}", action, newBinding.DisplayString);
        return true;
    }

    /// <inheritdoc />
    public void ResetBinding(TerminalShortcutAction action)
    {
        if (!_defaultBindings.TryGetValue(action, out var defaultBinding))
            return;

        // Remove current binding
        var currentBinding = _actionBindings.GetValueOrDefault(action);
        if (currentBinding != null)
        {
            _bindings.Remove((currentBinding.Key, currentBinding.Modifiers));
        }

        // Restore default
        _bindings[(defaultBinding.Key, defaultBinding.Modifiers)] = defaultBinding;
        _actionBindings[action] = defaultBinding;

        SaveCustomBindings();
        BindingsChanged?.Invoke(this, EventArgs.Empty);

        _logger.LogInformation("Reset binding: {Action} = {Key}", action, defaultBinding.DisplayString);
    }

    /// <inheritdoc />
    public void ResetAllBindings()
    {
        _bindings.Clear();
        _actionBindings.Clear();

        foreach (var (action, binding) in _defaultBindings)
        {
            _bindings[(binding.Key, binding.Modifiers)] = binding;
            _actionBindings[action] = binding;
        }

        SaveCustomBindings();
        BindingsChanged?.Invoke(this, EventArgs.Empty);

        _logger.LogInformation("Reset all bindings to defaults");
    }

    /// <inheritdoc />
    public bool HasConflict(Key key, KeyModifiers modifiers, TerminalShortcutAction? exclude = null) =>
        GetConflictingBinding(key, modifiers, exclude) != null;

    /// <inheritdoc />
    public KeyBinding? GetConflictingBinding(Key key, KeyModifiers modifiers, TerminalShortcutAction? exclude = null)
    {
        if (_bindings.TryGetValue((key, modifiers), out var binding))
        {
            if (exclude == null || binding.Action != exclude)
            {
                return binding;
            }
        }
        return null;
    }

    private void SaveCustomBindings()
    {
        var customBindings = new Dictionary<string, string>();

        foreach (var (action, binding) in _actionBindings)
        {
            var defaultBinding = _defaultBindings[action];
            
            // Only save if different from default
            if (binding.Key != defaultBinding.Key || binding.Modifiers != defaultBinding.Modifiers)
            {
                customBindings[action.ToString()] = binding.SerializedString;
            }
        }

        _settingsService.CurrentSettings.CustomKeyBindings = 
            customBindings.Count > 0 ? customBindings : null;
        _settingsService.SaveSettings();
    }
}
```

### 5. AppSettings Extensions

**Location**: `src/AIntern.Core/Models/AppSettings.cs` (additions)

```csharp
// Add to existing AppSettings class:

/// <summary>
/// Custom keyboard binding overrides.
/// Key: Action name, Value: Serialized key combo (e.g., "Ctrl+Shift+C")
/// </summary>
public Dictionary<string, string>? CustomKeyBindings { get; set; }
```

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `TerminalShortcutAction.cs` | `Core/Models/Terminal/` | Action enum |
| `KeyBinding.cs` | `Core/Models/Terminal/` | Binding model |
| `IKeyboardShortcutService.cs` | `Core/Interfaces/` | Service interface |
| `KeyboardShortcutService.cs` | `Services/` | Implementation |

### Files to Modify

| File | Changes |
|------|---------|
| `AppSettings.cs` | Add `CustomKeyBindings` property |
| `DependencyInjection.cs` | Register `IKeyboardShortcutService` |
| `TerminalControl.axaml.cs` | Integrate shortcut handling |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `GetAllBindings_ReturnsAllRegistered` | Default count |
| `GetBindingsByCategory_FiltersCorrectly` | Category filter |
| `TryGetAction_FindsExistingBinding` | Key lookup |
| `TryGetAction_ReturnsFalseForUnknown` | Unknown key |
| `GetBinding_ReturnsCorrectAction` | Action lookup |
| `UpdateBinding_ChangesKey` | Key update |
| `UpdateBinding_RejectsConflict` | Conflict check |
| `UpdateBinding_RejectsNonCustomizable` | Customizable check |
| `ResetBinding_RestoresDefault` | Single reset |
| `ResetAllBindings_RestoresAllDefaults` | Full reset |
| `HasConflict_DetectsConflict` | Conflict detection |
| `HasConflict_ExcludesSpecifiedAction` | Exclude parameter |
| `SaveCustomBindings_OnlyNonDefaults` | Persistence |
| `LoadCustomBindings_AppliesFromSettings` | Loading |
| `KeyBinding_DisplayString_FormatsPlatform` | Platform format |
| `KeyBinding_Parse_HandlesAllFormats` | Parsing |
| `KeyBinding_WithKey_CreatesNewInstance` | Immutability |
| `Categories_ReturnsUniqueList` | Category list |
| `PassToPty_CorrectForInputShortcuts` | PTY flag |
| `BindingsChanged_RaisedOnUpdate` | Event raised |

**Total Tests**: 20

---

## Verification

```bash
# Build projects
dotnet build src/AIntern.Core
dotnet build src/AIntern.Services

# Run unit tests
dotnet test --filter "KeyboardShortcut"

# Verify DI registration
grep -n "IKeyboardShortcutService" src/AIntern.Services/DependencyInjection.cs
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | All terminal shortcuts defined in enum |
| AC-2 | KeyBinding displays platform-aware format |
| AC-3 | TryGetAction matches key combinations correctly |
| AC-4 | PTY shortcuts pass through to terminal |
| AC-5 | Non-PTY shortcuts handled by application |
| AC-6 | Custom bindings persist to settings |
| AC-7 | Custom bindings load on startup |
| AC-8 | Conflict detection prevents duplicates |
| AC-9 | Reset restores default bindings |
| AC-10 | Categories group shortcuts correctly |
| AC-11 | BindingsChanged event notifies listeners |
| AC-12 | Non-customizable shortcuts cannot be changed |

---

## Changelog Entry

```markdown
## v0.5.5d - Keyboard Shortcuts System

### Added
- `TerminalShortcutAction` enum with 35+ actions across 6 categories:
  - Terminal Panel: Toggle, New, Close, Tab navigation
  - Terminal Input: SIGINT, SIGTSTP, EOF, line editing
  - Terminal Search: Open, Close, Navigate
  - Terminal Selection: Copy, Paste, SelectAll
  - Terminal Scroll: Page, Line, Top, Bottom
  - Command Blocks: Execute, Send

- `KeyBinding` model:
  - Key + Modifiers combination
  - Platform-aware display formatting (⌘ vs Ctrl)
  - Serialization/deserialization support
  - PassToPty flag for shell shortcuts
  - IsCustomizable flag

- `IKeyboardShortcutService` interface:
  - Binding lookup by key or action
  - Category filtering
  - Custom binding management
  - Conflict detection
  - Reset to defaults

- `KeyboardShortcutService` implementation:
  - 35+ default bindings
  - Settings persistence
  - BindingsChanged event

### Extended
- `AppSettings` with CustomKeyBindings dictionary
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.5d | 1 day |
