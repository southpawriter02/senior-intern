# Design Specification: AIntern v0.5.5i "History Management"

## Overview

**Version**: v0.5.5i
**Parent**: v0.5.5 Polish & Integration
**Focus**: Terminal command history with persistence, search, and navigation

### Purpose

This sub-version implements terminal command history management:
1. Create `TerminalHistoryEntry` model with command metadata
2. Create `TerminalSessionHistory` for session-level grouping
3. Define `ITerminalHistoryService` interface
4. Implement `TerminalHistoryService` with SQLite persistence
5. Support history search with pattern matching
6. Provide export functionality (JSON, CSV, Text)
7. Implement automatic cleanup of old history

### Dependencies

**From v0.5.1 (Terminal Foundation)**:
- `TerminalSession` for session tracking

**From v0.5.3c (Shell Profile Models)**:
- `ShellProfile` for profile ID

**Platform**:
- SQLite via Entity Framework Core

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    v0.5.5i History Management Architecture                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Model Layer                                       │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalHistoryEntry                                                    │ │
│  │  ├── Id: string (GUID)                                                  │ │
│  │  ├── Command: string                                                    │ │
│  │  ├── ExecutedAt: DateTime (UTC)                                         │ │
│  │  ├── WorkingDirectory: string?                                          │ │
│  │  ├── ExitCode: int?                                                     │ │
│  │  ├── Duration: TimeSpan?                                                │ │
│  │  └── ProfileId: string?                                                 │ │
│  │                                                                          │ │
│  │  TerminalSessionHistory                                                  │ │
│  │  ├── SessionId: string                                                  │ │
│  │  ├── StartedAt: DateTime                                                │ │
│  │  ├── EndedAt: DateTime?                                                 │ │
│  │  └── Commands: List<TerminalHistoryEntry>                               │ │
│  │                                                                          │ │
│  │  HistoryExportFormat (enum)                                              │ │
│  │  ├── Json                                                               │ │
│  │  ├── Csv                                                                │ │
│  │  └── Text                                                               │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Interface Layer                                    │ │
│  │  src/AIntern.Core/Interfaces/                                           │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ITerminalHistoryService                                                 │ │
│  │  ├── AddCommandAsync(sessionId, entry)                                  │ │
│  │  ├── GetRecentCommandsAsync(count)                                      │ │
│  │  ├── GetSessionHistoryAsync(sessionId)                                  │ │
│  │  ├── SearchHistoryAsync(query, maxResults)                              │ │
│  │  ├── ClearAllHistoryAsync()                                             │ │
│  │  ├── ClearHistoryOlderThanAsync(cutoffDate)                             │ │
│  │  ├── GetSessionRecordsAsync(count)                                      │ │
│  │  ├── ExportHistoryAsync(filePath, format)                               │ │
│  │  ├── GetTotalCommandCountAsync()                                        │ │
│  │  └── Event: HistoryChanged                                              │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Service Layer                                      │ │
│  │  src/AIntern.Services/Terminal/                                         │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalHistoryService : ITerminalHistoryService                        │ │
│  │  ├── Dependencies:                                                      │ │
│  │  │   ├── IAppDbContext                                                  │ │
│  │  │   └── ILogger                                                        │ │
│  │  │                                                                       │ │
│  │  ├── Internal:                                                          │ │
│  │  │   ├── _writeLock: SemaphoreSlim (thread safety)                      │ │
│  │  │   └── ToEntry() (entity → model mapping)                             │ │
│  │  │                                                                       │ │
│  │  └── Storage: SQLite (TerminalHistory table)                            │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         Data Layer                                       │ │
│  │  src/AIntern.Data/                                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  TerminalHistoryEntity                                                   │ │
│  │  ├── Id: string (PK)                                                    │ │
│  │  ├── SessionId: string (indexed)                                        │ │
│  │  ├── Command: string                                                    │ │
│  │  ├── ExecutedAt: DateTime (indexed)                                     │ │
│  │  ├── WorkingDirectory: string?                                          │ │
│  │  ├── ExitCode: int?                                                     │ │
│  │  ├── DurationMs: double?                                                │ │
│  │  └── ProfileId: string?                                                 │ │
│  │                                                                          │ │
│  │  AppDbContext                                                            │ │
│  │  └── DbSet<TerminalHistoryEntity> TerminalHistory                       │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         History Flow Diagram                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Command Execution:                                                          │
│  ┌───────────┐    ┌─────────────┐    ┌────────────────┐    ┌─────────────┐  │
│  │ Terminal  │───▶│ PTY Process │───▶│ History Service│───▶│  SQLite DB  │  │
│  │  Session  │    │ Completion  │    │ AddCommandAsync│    │   INSERT    │  │
│  └───────────┘    └─────────────┘    └────────────────┘    └─────────────┘  │
│                                                                              │
│  History Search:                                                             │
│  ┌───────────┐    ┌─────────────┐    ┌────────────────┐    ┌─────────────┐  │
│  │   User    │───▶│ Search UI   │───▶│ History Service│───▶│  SQLite DB  │  │
│  │   Query   │    │   Input     │    │SearchHistoryAsync   │ LIKE Query  │  │
│  └───────────┘    └─────────────┘    └────────────────┘    └─────────────┘  │
│        ▲                                     │                               │
│        │ Results                             │                               │
│        └─────────────────────────────────────┘                               │
│                                                                              │
│  History Export:                                                             │
│  ┌───────────┐    ┌─────────────┐    ┌────────────────┐    ┌─────────────┐  │
│  │   User    │───▶│Export Dialog│───▶│ History Service│───▶│  File Write │  │
│  │  Request  │    │Format Select│    │ExportHistoryAsync   │ JSON/CSV/TXT│  │
│  └───────────┘    └─────────────┘    └────────────────┘    └─────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. TerminalHistoryEntry.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalHistoryEntry.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// A single entry in the terminal command history.
/// Captures metadata about command execution for future reference.
/// </summary>
public sealed class TerminalHistoryEntry
{
    /// <summary>
    /// Unique identifier for this history entry.
    /// </summary>
    public string Id { get; init; } = Guid.NewGuid().ToString();

    /// <summary>
    /// The command that was executed.
    /// </summary>
    public string Command { get; init; } = string.Empty;

    /// <summary>
    /// When the command was executed (UTC).
    /// </summary>
    public DateTime ExecutedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Working directory when the command was executed.
    /// </summary>
    public string? WorkingDirectory { get; init; }

    /// <summary>
    /// Exit code of the command, if captured.
    /// </summary>
    public int? ExitCode { get; init; }

    /// <summary>
    /// Duration of command execution, if captured.
    /// </summary>
    public TimeSpan? Duration { get; init; }

    /// <summary>
    /// ID of the shell profile used.
    /// </summary>
    public string? ProfileId { get; init; }

    /// <summary>
    /// Whether the command executed successfully (exit code 0).
    /// </summary>
    public bool IsSuccess => ExitCode == 0;

    /// <summary>
    /// Returns a display-friendly relative time string.
    /// </summary>
    public string RelativeTime => FormatRelativeTime(ExecutedAt);

    private static string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;

        if (diff.TotalSeconds < 60)
            return "just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)}w ago";

        return dateTime.ToString("MMM d, yyyy");
    }

    /// <summary>
    /// Returns a display-friendly duration string.
    /// </summary>
    public string? DurationDisplay => Duration.HasValue
        ? Duration.Value.TotalSeconds < 1
            ? $"{Duration.Value.TotalMilliseconds:F0}ms"
            : Duration.Value.TotalMinutes < 1
                ? $"{Duration.Value.TotalSeconds:F1}s"
                : $"{Duration.Value.TotalMinutes:F1}m"
        : null;

    public override string ToString() => Command;
}
```

### 2. TerminalSessionHistory.cs

**Location**: `src/AIntern.Core/Models/Terminal/TerminalSessionHistory.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Session-level history grouping for terminal commands.
/// Groups commands by terminal session for organized browsing.
/// </summary>
public sealed class TerminalSessionHistory
{
    /// <summary>
    /// The session ID this history belongs to.
    /// </summary>
    public string SessionId { get; init; } = string.Empty;

    /// <summary>
    /// When the session was started (UTC).
    /// </summary>
    public DateTime StartedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// When the session was ended (UTC), or null if still active.
    /// </summary>
    public DateTime? EndedAt { get; set; }

    /// <summary>
    /// Profile ID used for this session.
    /// </summary>
    public string? ProfileId { get; init; }

    /// <summary>
    /// Profile name for display.
    /// </summary>
    public string? ProfileName { get; init; }

    /// <summary>
    /// Commands executed in this session, in chronological order.
    /// </summary>
    public List<TerminalHistoryEntry> Commands { get; init; } = new();

    /// <summary>
    /// Number of commands in this session.
    /// </summary>
    public int CommandCount => Commands.Count;

    /// <summary>
    /// Total duration of the session.
    /// </summary>
    public TimeSpan Duration => (EndedAt ?? DateTime.UtcNow) - StartedAt;

    /// <summary>
    /// Whether the session is still active.
    /// </summary>
    public bool IsActive => EndedAt == null;

    /// <summary>
    /// Display-friendly session duration.
    /// </summary>
    public string DurationDisplay
    {
        get
        {
            var d = Duration;
            if (d.TotalMinutes < 1)
                return $"{d.TotalSeconds:F0}s";
            if (d.TotalHours < 1)
                return $"{d.TotalMinutes:F0}m";
            return $"{d.TotalHours:F1}h";
        }
    }
}
```

### 3. HistoryExportFormat.cs

**Location**: `src/AIntern.Core/Models/Terminal/HistoryExportFormat.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Export format options for terminal command history.
/// </summary>
public enum HistoryExportFormat
{
    /// <summary>
    /// JSON format with full metadata.
    /// </summary>
    Json,

    /// <summary>
    /// CSV format for spreadsheet import.
    /// </summary>
    Csv,

    /// <summary>
    /// Plain text with one command per line.
    /// </summary>
    Text
}
```

### 4. ITerminalHistoryService.cs

**Location**: `src/AIntern.Core/Interfaces/ITerminalHistoryService.cs`

```csharp
namespace AIntern.Core.Interfaces;

using AIntern.Core.Models.Terminal;

/// <summary>
/// Service for managing terminal command history with persistence.
/// </summary>
public interface ITerminalHistoryService
{
    /// <summary>
    /// Adds a command to the history.
    /// </summary>
    /// <param name="sessionId">The session ID this command belongs to.</param>
    /// <param name="entry">The history entry to add.</param>
    Task AddCommandAsync(string sessionId, TerminalHistoryEntry entry);

    /// <summary>
    /// Gets recent commands across all sessions.
    /// </summary>
    /// <param name="count">Maximum number of entries to return.</param>
    /// <returns>List of recent history entries, newest first.</returns>
    Task<IReadOnlyList<TerminalHistoryEntry>> GetRecentCommandsAsync(int count = 100);

    /// <summary>
    /// Gets all commands for a specific session.
    /// </summary>
    /// <param name="sessionId">The session ID to retrieve history for.</param>
    /// <returns>List of history entries in chronological order.</returns>
    Task<IReadOnlyList<TerminalHistoryEntry>> GetSessionHistoryAsync(string sessionId);

    /// <summary>
    /// Searches command history using a query string.
    /// </summary>
    /// <param name="query">The search query (substring match).</param>
    /// <param name="maxResults">Maximum results to return.</param>
    /// <returns>Matching history entries, newest first.</returns>
    Task<IReadOnlyList<TerminalHistoryEntry>> SearchHistoryAsync(string query, int maxResults = 50);

    /// <summary>
    /// Clears all command history.
    /// </summary>
    Task ClearAllHistoryAsync();

    /// <summary>
    /// Clears history entries older than the specified date.
    /// </summary>
    /// <param name="cutoffDate">Entries before this date will be deleted.</param>
    Task ClearHistoryOlderThanAsync(DateTime cutoffDate);

    /// <summary>
    /// Gets session history records for browsing.
    /// </summary>
    /// <param name="count">Maximum number of sessions to return.</param>
    /// <returns>List of session history records, newest first.</returns>
    Task<IReadOnlyList<TerminalSessionHistory>> GetSessionRecordsAsync(int count = 20);

    /// <summary>
    /// Exports history to a file in the specified format.
    /// </summary>
    /// <param name="filePath">Path to write the export file.</param>
    /// <param name="format">Export format to use.</param>
    Task ExportHistoryAsync(string filePath, HistoryExportFormat format);

    /// <summary>
    /// Gets the total number of commands in history.
    /// </summary>
    /// <returns>Total command count.</returns>
    Task<int> GetTotalCommandCountAsync();

    /// <summary>
    /// Gets unique commands (deduplicated).
    /// </summary>
    /// <param name="count">Maximum number of unique commands.</param>
    /// <returns>List of unique commands, most recent first.</returns>
    Task<IReadOnlyList<string>> GetUniqueCommandsAsync(int count = 100);

    /// <summary>
    /// Raised when history changes (add, clear).
    /// </summary>
    event EventHandler<HistoryChangedEventArgs>? HistoryChanged;
}

/// <summary>
/// Event arguments for history changes.
/// </summary>
public sealed class HistoryChangedEventArgs : EventArgs
{
    /// <summary>
    /// Type of change that occurred.
    /// </summary>
    public HistoryChangeType ChangeType { get; init; }

    /// <summary>
    /// The entry that was added (for Add operations).
    /// </summary>
    public TerminalHistoryEntry? Entry { get; init; }
}

/// <summary>
/// Type of history change.
/// </summary>
public enum HistoryChangeType
{
    /// <summary>
    /// A command was added.
    /// </summary>
    Added,

    /// <summary>
    /// History was cleared.
    /// </summary>
    Cleared
}
```

### 5. TerminalHistoryEntity.cs

**Location**: `src/AIntern.Data/Entities/TerminalHistoryEntity.cs`

```csharp
namespace AIntern.Data.Entities;

using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using Microsoft.EntityFrameworkCore;

/// <summary>
/// Database entity for terminal command history.
/// </summary>
[Table("TerminalHistory")]
[Index(nameof(SessionId))]
[Index(nameof(ExecutedAt))]
[Index(nameof(Command))]
public sealed class TerminalHistoryEntity
{
    /// <summary>
    /// Unique identifier (GUID string).
    /// </summary>
    [Key]
    [MaxLength(36)]
    public string Id { get; set; } = string.Empty;

    /// <summary>
    /// Session ID this command belongs to.
    /// </summary>
    [Required]
    [MaxLength(36)]
    public string SessionId { get; set; } = string.Empty;

    /// <summary>
    /// The executed command.
    /// </summary>
    [Required]
    public string Command { get; set; } = string.Empty;

    /// <summary>
    /// When the command was executed (UTC).
    /// </summary>
    [Required]
    public DateTime ExecutedAt { get; set; }

    /// <summary>
    /// Working directory when executed.
    /// </summary>
    [MaxLength(1024)]
    public string? WorkingDirectory { get; set; }

    /// <summary>
    /// Exit code of the command.
    /// </summary>
    public int? ExitCode { get; set; }

    /// <summary>
    /// Duration in milliseconds.
    /// </summary>
    public double? DurationMs { get; set; }

    /// <summary>
    /// Shell profile ID used.
    /// </summary>
    [MaxLength(36)]
    public string? ProfileId { get; set; }
}
```

### 6. TerminalHistoryService.cs

**Location**: `src/AIntern.Services/Terminal/TerminalHistoryService.cs`

```csharp
namespace AIntern.Services.Terminal;

using System.Text;
using System.Text.Json;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;
using AIntern.Data;
using AIntern.Data.Entities;

/// <summary>
/// Service for managing terminal command history with SQLite persistence.
/// Thread-safe implementation with async operations.
/// </summary>
public sealed class TerminalHistoryService : ITerminalHistoryService
{
    private readonly IAppDbContext _dbContext;
    private readonly ILogger<TerminalHistoryService> _logger;
    private readonly SemaphoreSlim _writeLock = new(1, 1);

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    public TerminalHistoryService(
        IAppDbContext dbContext,
        ILogger<TerminalHistoryService> logger)
    {
        _dbContext = dbContext;
        _logger = logger;
    }

    /// <inheritdoc />
    public async Task AddCommandAsync(string sessionId, TerminalHistoryEntry entry)
    {
        if (string.IsNullOrWhiteSpace(entry.Command))
        {
            _logger.LogDebug("Skipping empty command");
            return;
        }

        await _writeLock.WaitAsync();
        try
        {
            var entity = new TerminalHistoryEntity
            {
                Id = entry.Id,
                SessionId = sessionId,
                Command = entry.Command,
                ExecutedAt = entry.ExecutedAt,
                WorkingDirectory = entry.WorkingDirectory,
                ExitCode = entry.ExitCode,
                DurationMs = entry.Duration?.TotalMilliseconds,
                ProfileId = entry.ProfileId
            };

            _dbContext.TerminalHistory.Add(entity);
            await _dbContext.SaveChangesAsync();

            _logger.LogDebug(
                "Added command to history: {Command} (Session: {SessionId})",
                TruncateForLog(entry.Command), sessionId);

            HistoryChanged?.Invoke(this, new HistoryChangedEventArgs
            {
                ChangeType = HistoryChangeType.Added,
                Entry = entry
            });
        }
        finally
        {
            _writeLock.Release();
        }
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<TerminalHistoryEntry>> GetRecentCommandsAsync(int count = 100)
    {
        _logger.LogDebug("Getting recent commands (count: {Count})", count);

        var entities = await _dbContext.TerminalHistory
            .OrderByDescending(h => h.ExecutedAt)
            .Take(count)
            .ToListAsync();

        return entities.Select(ToEntry).ToList();
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<TerminalHistoryEntry>> GetSessionHistoryAsync(string sessionId)
    {
        _logger.LogDebug("Getting history for session: {SessionId}", sessionId);

        var entities = await _dbContext.TerminalHistory
            .Where(h => h.SessionId == sessionId)
            .OrderBy(h => h.ExecutedAt)
            .ToListAsync();

        return entities.Select(ToEntry).ToList();
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<TerminalHistoryEntry>> SearchHistoryAsync(
        string query,
        int maxResults = 50)
    {
        if (string.IsNullOrWhiteSpace(query))
        {
            _logger.LogDebug("Empty search query, returning empty results");
            return Array.Empty<TerminalHistoryEntry>();
        }

        _logger.LogDebug("Searching history for: {Query} (max: {MaxResults})", query, maxResults);

        var entities = await _dbContext.TerminalHistory
            .Where(h => EF.Functions.Like(h.Command, $"%{query}%"))
            .OrderByDescending(h => h.ExecutedAt)
            .Take(maxResults)
            .ToListAsync();

        _logger.LogDebug("Found {Count} matching entries", entities.Count);

        return entities.Select(ToEntry).ToList();
    }

    /// <inheritdoc />
    public async Task ClearAllHistoryAsync()
    {
        _logger.LogInformation("Clearing all terminal history");

        await _writeLock.WaitAsync();
        try
        {
            await _dbContext.TerminalHistory.ExecuteDeleteAsync();

            HistoryChanged?.Invoke(this, new HistoryChangedEventArgs
            {
                ChangeType = HistoryChangeType.Cleared
            });
        }
        finally
        {
            _writeLock.Release();
        }
    }

    /// <inheritdoc />
    public async Task ClearHistoryOlderThanAsync(DateTime cutoffDate)
    {
        _logger.LogInformation("Clearing history older than: {CutoffDate}", cutoffDate);

        await _writeLock.WaitAsync();
        try
        {
            var deleted = await _dbContext.TerminalHistory
                .Where(h => h.ExecutedAt < cutoffDate)
                .ExecuteDeleteAsync();

            _logger.LogInformation("Deleted {Count} old history entries", deleted);

            if (deleted > 0)
            {
                HistoryChanged?.Invoke(this, new HistoryChangedEventArgs
                {
                    ChangeType = HistoryChangeType.Cleared
                });
            }
        }
        finally
        {
            _writeLock.Release();
        }
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<TerminalSessionHistory>> GetSessionRecordsAsync(int count = 20)
    {
        _logger.LogDebug("Getting session records (count: {Count})", count);

        // Get distinct sessions with their command counts
        var sessionGroups = await _dbContext.TerminalHistory
            .GroupBy(h => h.SessionId)
            .Select(g => new
            {
                SessionId = g.Key,
                StartedAt = g.Min(h => h.ExecutedAt),
                EndedAt = g.Max(h => h.ExecutedAt),
                CommandCount = g.Count(),
                ProfileId = g.First().ProfileId
            })
            .OrderByDescending(s => s.StartedAt)
            .Take(count)
            .ToListAsync();

        var result = new List<TerminalSessionHistory>();

        foreach (var session in sessionGroups)
        {
            var commands = await _dbContext.TerminalHistory
                .Where(h => h.SessionId == session.SessionId)
                .OrderBy(h => h.ExecutedAt)
                .ToListAsync();

            result.Add(new TerminalSessionHistory
            {
                SessionId = session.SessionId,
                StartedAt = session.StartedAt,
                EndedAt = session.EndedAt,
                ProfileId = session.ProfileId,
                Commands = commands.Select(ToEntry).ToList()
            });
        }

        return result;
    }

    /// <inheritdoc />
    public async Task ExportHistoryAsync(string filePath, HistoryExportFormat format)
    {
        _logger.LogInformation(
            "Exporting history to: {FilePath} (format: {Format})",
            filePath, format);

        var history = await GetRecentCommandsAsync(10000);

        switch (format)
        {
            case HistoryExportFormat.Json:
                await ExportAsJsonAsync(filePath, history);
                break;

            case HistoryExportFormat.Csv:
                await ExportAsCsvAsync(filePath, history);
                break;

            case HistoryExportFormat.Text:
                await ExportAsTextAsync(filePath, history);
                break;

            default:
                throw new ArgumentOutOfRangeException(nameof(format));
        }

        _logger.LogInformation("Exported {Count} entries", history.Count);
    }

    private static async Task ExportAsJsonAsync(
        string filePath,
        IReadOnlyList<TerminalHistoryEntry> history)
    {
        var json = JsonSerializer.Serialize(history, JsonOptions);
        await File.WriteAllTextAsync(filePath, json, Encoding.UTF8);
    }

    private static async Task ExportAsCsvAsync(
        string filePath,
        IReadOnlyList<TerminalHistoryEntry> history)
    {
        var sb = new StringBuilder();
        sb.AppendLine("Command,ExecutedAt,WorkingDirectory,ExitCode,DurationMs");

        foreach (var entry in history)
        {
            var command = entry.Command.Replace("\"", "\"\"");
            var workDir = entry.WorkingDirectory?.Replace("\"", "\"\"") ?? "";
            var durationMs = entry.Duration?.TotalMilliseconds.ToString("F0") ?? "";

            sb.AppendLine(
                $"\"{command}\",{entry.ExecutedAt:O},\"{workDir}\",{entry.ExitCode},{durationMs}");
        }

        await File.WriteAllTextAsync(filePath, sb.ToString(), Encoding.UTF8);
    }

    private static async Task ExportAsTextAsync(
        string filePath,
        IReadOnlyList<TerminalHistoryEntry> history)
    {
        var commands = history.Select(h => h.Command);
        await File.WriteAllLinesAsync(filePath, commands, Encoding.UTF8);
    }

    /// <inheritdoc />
    public async Task<int> GetTotalCommandCountAsync()
    {
        return await _dbContext.TerminalHistory.CountAsync();
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<string>> GetUniqueCommandsAsync(int count = 100)
    {
        _logger.LogDebug("Getting unique commands (count: {Count})", count);

        return await _dbContext.TerminalHistory
            .Select(h => h.Command)
            .Distinct()
            .Take(count)
            .ToListAsync();
    }

    /// <inheritdoc />
    public event EventHandler<HistoryChangedEventArgs>? HistoryChanged;

    // ========== Mapping ==========

    private static TerminalHistoryEntry ToEntry(TerminalHistoryEntity entity) => new()
    {
        Id = entity.Id,
        Command = entity.Command,
        ExecutedAt = entity.ExecutedAt,
        WorkingDirectory = entity.WorkingDirectory,
        ExitCode = entity.ExitCode,
        Duration = entity.DurationMs.HasValue
            ? TimeSpan.FromMilliseconds(entity.DurationMs.Value)
            : null,
        ProfileId = entity.ProfileId
    };

    private static string TruncateForLog(string text, int maxLength = 50)
    {
        if (text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }
}
```

### 7. AppDbContext Extension

**Location**: `src/AIntern.Data/AppDbContext.cs` (additions)

```csharp
// Add to AppDbContext:

public DbSet<TerminalHistoryEntity> TerminalHistory { get; set; } = null!;

// In OnModelCreating:
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // ... existing configuration ...

    // TerminalHistory configuration
    modelBuilder.Entity<TerminalHistoryEntity>(entity =>
    {
        entity.HasIndex(e => e.SessionId);
        entity.HasIndex(e => e.ExecutedAt);
        entity.HasIndex(e => e.Command);
    });
}
```

### 8. DependencyInjection Registration

**Location**: `src/AIntern.Services/DependencyInjection.cs` (additions)

```csharp
// Add to service registration:
services.AddSingleton<ITerminalHistoryService, TerminalHistoryService>();
```

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `TerminalHistoryEntry.cs` | `Core/Models/Terminal/` | History entry model |
| `TerminalSessionHistory.cs` | `Core/Models/Terminal/` | Session grouping model |
| `HistoryExportFormat.cs` | `Core/Models/Terminal/` | Export format enum |
| `ITerminalHistoryService.cs` | `Core/Interfaces/` | Service interface |
| `TerminalHistoryEntity.cs` | `Data/Entities/` | Database entity |
| `TerminalHistoryService.cs` | `Services/Terminal/` | Service implementation |

### Files to Modify

| File | Changes |
|------|---------|
| `AppDbContext.cs` | Add TerminalHistory DbSet |
| `DependencyInjection.cs` | Register history service |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `AddCommand_PersistsToDatabase` | Entry saved |
| `AddCommand_EmptyCommand_Skipped` | Empty filter |
| `GetRecentCommands_ReturnsNewestFirst` | Order check |
| `GetRecentCommands_RespectsCount` | Count limit |
| `GetSessionHistory_ReturnsChronological` | Order check |
| `SearchHistory_FindsMatches` | LIKE search |
| `SearchHistory_EmptyQuery_ReturnsEmpty` | Edge case |
| `SearchHistory_CaseInsensitive` | Case check |
| `ClearAllHistory_DeletesAll` | Full clear |
| `ClearHistoryOlderThan_DeletesOld` | Partial clear |
| `GetSessionRecords_GroupsBySession` | Grouping |
| `ExportHistory_Json_ValidFormat` | JSON export |
| `ExportHistory_Csv_ValidFormat` | CSV export |
| `ExportHistory_Text_CommandsOnly` | Text export |
| `GetTotalCommandCount_ReturnsCount` | Count query |
| `GetUniqueCommands_Deduplicates` | Distinct |
| `HistoryChanged_RaisedOnAdd` | Event test |
| `HistoryChanged_RaisedOnClear` | Event test |
| `HistoryEntry_RelativeTime_Correct` | Formatting |
| `HistoryEntry_DurationDisplay_Correct` | Formatting |

**Total Tests**: 20

---

## Verification

```bash
# Build the projects
dotnet build src/AIntern.Core
dotnet build src/AIntern.Data
dotnet build src/AIntern.Services

# Run unit tests
dotnet test --filter "TerminalHistory"

# Run EF migration (if needed)
dotnet ef migrations add AddTerminalHistory --project src/AIntern.Data

# Verify database schema
sqlite3 ~/.aintern/app.db ".schema TerminalHistory"
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Commands are persisted to SQLite |
| AC-2 | Recent commands return newest first |
| AC-3 | Session history returns chronologically |
| AC-4 | Search finds partial matches |
| AC-5 | Search is case-insensitive |
| AC-6 | Clear all deletes everything |
| AC-7 | Clear older than removes old entries only |
| AC-8 | Session records group by session |
| AC-9 | Export JSON is valid JSON |
| AC-10 | Export CSV is valid CSV |
| AC-11 | Export Text has one command per line |
| AC-12 | HistoryChanged event fires on add |
| AC-13 | Thread-safe write operations |
| AC-14 | Unique commands are deduplicated |

---

## Changelog Entry

```markdown
## v0.5.5i - History Management

### Added
- `TerminalHistoryEntry` model with:
  - Command and metadata (exit code, duration)
  - Working directory tracking
  - RelativeTime and DurationDisplay helpers

- `TerminalSessionHistory` model with:
  - Session-level command grouping
  - Duration and command count

- `ITerminalHistoryService` interface with:
  - Add, search, and retrieve operations
  - Clear and cleanup methods
  - Export functionality
  - HistoryChanged event

- `TerminalHistoryService` implementation with:
  - SQLite persistence via EF Core
  - Thread-safe write operations
  - LIKE-based search
  - JSON, CSV, Text export formats

- `TerminalHistoryEntity` database entity with:
  - Indexed columns for performance
  - Full metadata storage

### Database
- Added TerminalHistory table with indexes
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.5i | 1 day |
