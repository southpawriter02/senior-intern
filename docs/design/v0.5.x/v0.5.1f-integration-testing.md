# v0.5.1f – Integration & Testing

## Overview

This specification defines the **Integration & Testing** component for AIntern v0.5.1. This sub-version completes the Terminal Foundation by registering all terminal services with dependency injection, creating comprehensive unit tests for the ANSI parser and terminal buffer, and verifying integration with the main application.

**Parent Specification:** [v0.5.1-terminal-foundation.md](./v0.5.1-terminal-foundation.md)
**Related Specifications:**
- [v0.5.1a-project-setup.md](./v0.5.1a-project-setup.md) – Project setup and dependencies
- [v0.5.1b-terminal-models.md](./v0.5.1b-terminal-models.md) – Terminal models (TerminalBuffer, etc.)
- [v0.5.1c-ansi-parser.md](./v0.5.1c-ansi-parser.md) – ANSI parser
- [v0.5.1d-terminal-service.md](./v0.5.1d-terminal-service.md) – Terminal service
- [v0.5.1e-shell-detection.md](./v0.5.1e-shell-detection.md) – Shell detection service

---

## Table of Contents

1. [Component Purpose](#1-component-purpose)
2. [Architecture Overview](#2-architecture-overview)
3. [File Structure](#3-file-structure)
4. [TerminalServiceExtensions](#4-terminalserviceextensions)
5. [AnsiParserTests](#5-ansiparsertests)
6. [TerminalBufferTests](#6-terminalbuffertests)
7. [Application Integration](#7-application-integration)
8. [Testing Strategy](#8-testing-strategy)
9. [Verification Commands](#9-verification-commands)
10. [Implementation Checklist](#10-implementation-checklist)

---

## 1. Component Purpose

The Integration & Testing component is responsible for:

1. **DI Registration** – Providing extension methods to register all terminal services with the dependency injection container
2. **ANSI Parser Testing** – Comprehensive unit tests for escape sequence parsing, cursor movement, SGR attributes, and control characters
3. **Terminal Buffer Testing** – Unit tests for buffer operations, scrolling, line wrapping, and text selection
4. **Application Integration** – Wiring terminal services into the main desktop application

### Design Principles

- **Single Registration Point**: One extension method registers all terminal services
- **Comprehensive Coverage**: Tests cover all major ANSI escape sequences and buffer operations
- **Isolation**: Unit tests use real buffer instances but don't require PTY or shell access
- **Non-Blocking**: All async tests properly handle cancellation tokens

---

## 2. Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        v0.5.1f Integration & Testing                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    TerminalServiceExtensions                        │    │
│  │  ┌──────────────────────────────────────────────────────────────┐  │    │
│  │  │  AddTerminalServices(IServiceCollection)                      │  │    │
│  │  │  ├── AddSingleton<IShellDetectionService, ShellDetection...>  │  │    │
│  │  │  └── AddSingleton<ITerminalService, TerminalService>          │  │    │
│  │  └──────────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                         App.axaml.cs                                │    │
│  │  ┌──────────────────────────────────────────────────────────────┐  │    │
│  │  │  services.AddTerminalServices();                              │  │    │
│  │  └──────────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                              Unit Tests                                     │
│                                                                             │
│  ┌─────────────────────────────┐    ┌─────────────────────────────────┐    │
│  │     AnsiParserTests         │    │     TerminalBufferTests         │    │
│  │  ─────────────────────────  │    │  ─────────────────────────────  │    │
│  │  • Plain text writing       │    │  • Constructor initialization   │    │
│  │  • Newline handling         │    │  • WriteChar operations         │    │
│  │  • Carriage return          │    │  • Line wrapping               │    │
│  │  • Cursor movement (A,B,H)  │    │  • LineFeed and scrolling      │    │
│  │  • SGR reset/bold/color     │    │  • CarriageReturn              │    │
│  │  • 256-color & TrueColor    │    │  • Clear operations            │    │
│  │  • Erase display/line       │    │  • Resize handling             │    │
│  │  • Save/restore cursor      │    │  • Cursor position clamping    │    │
│  │  • OSC title changes        │    │  • Save/restore cursor state   │    │
│  │  • Bell character           │    │  • Text selection              │    │
│  │  • Tab/backspace            │    │  • Scroll regions              │    │
│  └─────────────────────────────┘    └─────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Service Registration Flow

```
Application Startup
        │
        ▼
App.axaml.cs ConfigureServices()
        │
        ├── services.AddTerminalServices()
        │   │
        │   ├── Register IShellDetectionService → ShellDetectionService (Singleton)
        │   └── Register ITerminalService → TerminalService (Singleton)
        │
        └── Other service registrations...
```

---

## 3. File Structure

```
src/
└── AIntern.Services/
    └── Terminal/
        └── TerminalServiceExtensions.cs    # DI registration extensions

tests/
└── AIntern.Core.Tests/
    └── Terminal/
        ├── AnsiParserTests.cs              # ANSI parser unit tests
        └── TerminalBufferTests.cs          # Terminal buffer unit tests
```

### File Responsibilities

| File | Purpose | Lines (Est.) |
|------|---------|--------------|
| `TerminalServiceExtensions.cs` | DI registration extension methods | ~25 |
| `AnsiParserTests.cs` | Comprehensive ANSI parser tests | ~200 |
| `TerminalBufferTests.cs` | Comprehensive terminal buffer tests | ~200 |

---

## 4. TerminalServiceExtensions

### Complete Implementation

```csharp
// src/AIntern.Services/Terminal/TerminalServiceExtensions.cs

namespace AIntern.Services.Terminal;

using Microsoft.Extensions.DependencyInjection;
using AIntern.Core.Interfaces;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ TERMINAL SERVICE EXTENSIONS (v0.5.1f)                                   │
// │ Extension methods for registering terminal services with DI.            │
// └─────────────────────────────────────────────────────────────────────────┘

/// <summary>
/// Extension methods for registering terminal services.
/// </summary>
/// <remarks>
/// <para>Added in v0.5.1f.</para>
/// </remarks>
public static class TerminalServiceExtensions
{
    /// <summary>
    /// Add terminal services to the service collection.
    /// </summary>
    /// <param name="services">The service collection.</param>
    /// <returns>The service collection for chaining.</returns>
    /// <remarks>
    /// <para>
    /// This registers the following services as singletons:
    /// <list type="bullet">
    ///   <item><see cref="IShellDetectionService"/> → <see cref="ShellDetectionService"/></item>
    ///   <item><see cref="ITerminalService"/> → <see cref="TerminalService"/></item>
    /// </list>
    /// </para>
    /// <para>
    /// Both services are registered as singletons because:
    /// <list type="bullet">
    ///   <item>ShellDetectionService caches detection results</item>
    ///   <item>TerminalService maintains a registry of active sessions</item>
    /// </list>
    /// </para>
    /// </remarks>
    public static IServiceCollection AddTerminalServices(this IServiceCollection services)
    {
        services.AddSingleton<IShellDetectionService, ShellDetectionService>();
        services.AddSingleton<ITerminalService, TerminalService>();

        return services;
    }
}
```

### Usage

```csharp
// In App.axaml.cs or startup configuration
services.AddTerminalServices();
```

---

## 5. AnsiParserTests

### Complete Test Class

```csharp
// tests/AIntern.Core.Tests/Terminal/AnsiParserTests.cs

namespace AIntern.Core.Tests.Terminal;

using AIntern.Core.Models.Terminal;
using AIntern.Core.Terminal;
using Xunit;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ ANSI PARSER TESTS (v0.5.1f)                                             │
// │ Unit tests for ANSI escape sequence parsing.                            │
// └─────────────────────────────────────────────────────────────────────────┘

/// <summary>
/// Unit tests for <see cref="AnsiParser"/>.
/// </summary>
/// <remarks>
/// <para>Added in v0.5.1f.</para>
/// </remarks>
public class AnsiParserTests
{
    // ─────────────────────────────────────────────────────────────────────
    // Test Setup
    // ─────────────────────────────────────────────────────────────────────

    private readonly TerminalBuffer _buffer;
    private readonly AnsiParser _parser;

    public AnsiParserTests()
    {
        _buffer = new TerminalBuffer(80, 24);
        _parser = new AnsiParser(_buffer);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Plain Text Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_PlainText_WritesToBuffer()
    {
        _parser.Parse("Hello, World!");

        var line = _buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.Equal("Hello, World!", line.GetText());
    }

    [Fact]
    public void Parse_NewLine_AdvancesCursor()
    {
        _parser.Parse("Line 1\nLine 2");

        Assert.Equal(1, _buffer.CursorY);
    }

    [Fact]
    public void Parse_CarriageReturn_ResetsCursorX()
    {
        _parser.Parse("Hello\rWorld");

        var line = _buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.Equal("World", line.GetText());
    }

    // ─────────────────────────────────────────────────────────────────────
    // Cursor Movement Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_CursorUp_MovesCursor()
    {
        _buffer.CursorY = 5;
        _parser.Parse("\x1B[2A"); // Move up 2

        Assert.Equal(3, _buffer.CursorY);
    }

    [Fact]
    public void Parse_CursorDown_MovesCursor()
    {
        _buffer.CursorY = 0;
        _parser.Parse("\x1B[3B"); // Move down 3

        Assert.Equal(3, _buffer.CursorY);
    }

    [Fact]
    public void Parse_CursorPosition_SetsCursor()
    {
        _parser.Parse("\x1B[5;10H"); // Row 5, Column 10

        Assert.Equal(4, _buffer.CursorY); // 0-indexed
        Assert.Equal(9, _buffer.CursorX); // 0-indexed
    }

    // ─────────────────────────────────────────────────────────────────────
    // SGR (Select Graphic Rendition) Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_SgrReset_ResetsAttributes()
    {
        _buffer.CurrentAttributes = _buffer.CurrentAttributes.With(bold: true);
        _parser.Parse("\x1B[0m");

        Assert.Equal(TerminalAttributes.Default, _buffer.CurrentAttributes);
    }

    [Fact]
    public void Parse_SgrBold_SetsBold()
    {
        _parser.Parse("\x1B[1m");

        Assert.True(_buffer.CurrentAttributes.Bold);
    }

    [Fact]
    public void Parse_SgrForegroundColor_SetsColor()
    {
        _parser.Parse("\x1B[31m"); // Red

        Assert.Equal(TerminalColor.FromPalette(1), _buffer.CurrentAttributes.Foreground);
    }

    [Fact]
    public void Parse_Sgr256Color_SetsColor()
    {
        _parser.Parse("\x1B[38;5;196m"); // Bright red from 256 palette

        Assert.Equal(TerminalColor.FromPalette(196), _buffer.CurrentAttributes.Foreground);
    }

    [Fact]
    public void Parse_SgrTrueColor_SetsColor()
    {
        _parser.Parse("\x1B[38;2;255;128;64m"); // RGB

        Assert.Equal(TerminalColor.FromRgb(255, 128, 64), _buffer.CurrentAttributes.Foreground);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Erase Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_EraseDisplay_ClearsScreen()
    {
        _parser.Parse("Some text");
        _parser.Parse("\x1B[2J"); // Clear entire screen

        var line = _buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.True(string.IsNullOrWhiteSpace(line.GetText()));
    }

    [Fact]
    public void Parse_EraseLine_ClearsLine()
    {
        _parser.Parse("Hello, World!");
        _buffer.CursorX = 5;
        _parser.Parse("\x1B[K"); // Clear to end of line

        var line = _buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.Equal("Hello", line.GetText());
    }

    // ─────────────────────────────────────────────────────────────────────
    // Cursor Save/Restore Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_SaveRestoreCursor_WorksCorrectly()
    {
        _buffer.CursorX = 10;
        _buffer.CursorY = 5;
        _parser.Parse("\x1B7"); // Save cursor

        _buffer.CursorX = 0;
        _buffer.CursorY = 0;
        _parser.Parse("\x1B8"); // Restore cursor

        Assert.Equal(10, _buffer.CursorX);
        Assert.Equal(5, _buffer.CursorY);
    }

    // ─────────────────────────────────────────────────────────────────────
    // OSC (Operating System Command) Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_OscTitle_RaisesEvent()
    {
        string? receivedTitle = null;
        _parser.TitleChanged += title => receivedTitle = title;

        _parser.Parse("\x1B]0;My Terminal\x07");

        Assert.Equal("My Terminal", receivedTitle);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Control Character Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Parse_Bell_RaisesEvent()
    {
        var bellReceived = false;
        _parser.Bell += () => bellReceived = true;

        _parser.Parse("\x07");

        Assert.True(bellReceived);
    }

    [Fact]
    public void Parse_Tab_MovesCursorToNextTabStop()
    {
        _buffer.CursorX = 3;
        _parser.Parse("\t");

        Assert.Equal(8, _buffer.CursorX);
    }

    [Fact]
    public void Parse_Backspace_MovesCursorBack()
    {
        _buffer.CursorX = 5;
        _parser.Parse("\x08");

        Assert.Equal(4, _buffer.CursorX);
    }
}
```

### Test Categories

| Category | Tests | Purpose |
|----------|-------|---------|
| Plain Text | 3 | Text output, newlines, carriage return |
| Cursor Movement | 3 | CUU, CUD, CUP sequences |
| SGR Attributes | 5 | Reset, bold, standard colors, 256-color, TrueColor |
| Erase Operations | 2 | ED (erase display), EL (erase line) |
| Cursor Save/Restore | 1 | DECSC/DECRC sequences |
| OSC Commands | 1 | Window title changes |
| Control Characters | 3 | Bell, tab, backspace |

---

## 6. TerminalBufferTests

### Complete Test Class

```csharp
// tests/AIntern.Core.Tests/Terminal/TerminalBufferTests.cs

namespace AIntern.Core.Tests.Terminal;

using AIntern.Core.Models.Terminal;
using Xunit;

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ TERMINAL BUFFER TESTS (v0.5.1f)                                         │
// │ Unit tests for terminal buffer operations.                              │
// └─────────────────────────────────────────────────────────────────────────┘

/// <summary>
/// Unit tests for <see cref="TerminalBuffer"/>.
/// </summary>
/// <remarks>
/// <para>Added in v0.5.1f.</para>
/// </remarks>
public class TerminalBufferTests
{
    // ─────────────────────────────────────────────────────────────────────
    // Constructor Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Constructor_InitializesCorrectly()
    {
        var buffer = new TerminalBuffer(80, 24);

        Assert.Equal(80, buffer.Columns);
        Assert.Equal(24, buffer.Rows);
        Assert.Equal(0, buffer.CursorX);
        Assert.Equal(0, buffer.CursorY);
        Assert.True(buffer.CursorVisible);
    }

    // ─────────────────────────────────────────────────────────────────────
    // WriteChar Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void WriteChar_WritesToCurrentPosition()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.WriteChar('A');

        var line = buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.Equal('A', (char)line[0].Character.Value);
        Assert.Equal(1, buffer.CursorX);
    }

    [Fact]
    public void WriteChar_AdvancesCursor()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.WriteString("Hello");

        Assert.Equal(5, buffer.CursorX);
    }

    [Fact]
    public void WriteChar_AtEndOfLine_Wraps()
    {
        var buffer = new TerminalBuffer(5, 24);
        buffer.WriteString("Hello!");

        Assert.Equal(1, buffer.CursorX);
        Assert.Equal(1, buffer.CursorY);
    }

    // ─────────────────────────────────────────────────────────────────────
    // LineFeed Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void LineFeed_MovesCursorDown()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.LineFeed();

        Assert.Equal(1, buffer.CursorY);
    }

    [Fact]
    public void LineFeed_AtBottom_Scrolls()
    {
        var buffer = new TerminalBuffer(80, 3);
        buffer.WriteString("Line 1");
        buffer.LineFeed();
        buffer.WriteString("Line 2");
        buffer.LineFeed();
        buffer.WriteString("Line 3");
        buffer.LineFeed();
        buffer.WriteString("Line 4");

        // Line 1 should have scrolled off
        var firstVisibleLine = buffer.GetLine(0);
        Assert.NotNull(firstVisibleLine);
        Assert.Equal("Line 2", firstVisibleLine.GetText());
    }

    // ─────────────────────────────────────────────────────────────────────
    // CarriageReturn Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void CarriageReturn_ResetsCursorX()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.CursorX = 10;
        buffer.CarriageReturn();

        Assert.Equal(0, buffer.CursorX);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Clear Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Clear_ClearsAllLines()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.WriteString("Hello");
        buffer.Clear();

        var line = buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.True(string.IsNullOrWhiteSpace(line.GetText()));
    }

    [Fact]
    public void ClearLine_ClearsCurrentLine()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.WriteString("Hello");
        buffer.ClearLine();

        var line = buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.True(string.IsNullOrWhiteSpace(line.GetText()));
    }

    [Fact]
    public void ClearLineToEnd_ClearsFromCursor()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.WriteString("Hello World");
        buffer.CursorX = 5;
        buffer.ClearLineToEnd();

        var line = buffer.GetLine(0);
        Assert.NotNull(line);
        Assert.Equal("Hello", line.GetText());
    }

    // ─────────────────────────────────────────────────────────────────────
    // Resize Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void Resize_AdjustsBuffer()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.Resize(120, 30);

        Assert.Equal(120, buffer.Columns);
        Assert.Equal(30, buffer.Rows);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Cursor Position Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void SetCursorPosition_ClampsToBounds()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.SetCursorPosition(100, 200); // Way out of bounds

        Assert.Equal(23, buffer.CursorY); // Clamped to Rows - 1
        Assert.Equal(79, buffer.CursorX); // Clamped to Columns - 1
    }

    // ─────────────────────────────────────────────────────────────────────
    // Cursor Save/Restore Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void SaveRestoreCursor_WorksCorrectly()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.CursorX = 10;
        buffer.CursorY = 5;
        buffer.CurrentAttributes = buffer.CurrentAttributes.With(bold: true);

        buffer.SaveCursor();

        buffer.CursorX = 0;
        buffer.CursorY = 0;
        buffer.CurrentAttributes = TerminalAttributes.Default;

        buffer.RestoreCursor();

        Assert.Equal(10, buffer.CursorX);
        Assert.Equal(5, buffer.CursorY);
        Assert.True(buffer.CurrentAttributes.Bold);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Selection Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void GetSelectedText_ReturnsCorrectText()
    {
        var buffer = new TerminalBuffer(80, 24);
        buffer.WriteString("Hello World");

        var selection = new TerminalSelection
        {
            StartLine = buffer.TotalLines - 1,
            StartColumn = 0,
            EndLine = buffer.TotalLines - 1,
            EndColumn = 4
        };

        var text = buffer.GetSelectedText(selection);
        Assert.Equal("Hello", text);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Scroll Region Tests
    // ─────────────────────────────────────────────────────────────────────

    [Fact]
    public void ScrollRegion_LimitsScrolling()
    {
        var buffer = new TerminalBuffer(80, 10);
        buffer.SetScrollRegion(3, 7); // Lines 3-7 (1-indexed)

        Assert.Equal(2, buffer.ScrollRegionTop); // 0-indexed
        Assert.Equal(7, buffer.ScrollRegionBottom);
    }
}
```

### Test Categories

| Category | Tests | Purpose |
|----------|-------|---------|
| Constructor | 1 | Initial buffer state verification |
| WriteChar | 3 | Character writing, cursor advancement, line wrapping |
| LineFeed | 2 | Cursor movement, scrolling behavior |
| CarriageReturn | 1 | Cursor X reset |
| Clear Operations | 3 | Full clear, line clear, partial line clear |
| Resize | 1 | Buffer dimension changes |
| Cursor Position | 1 | Bounds clamping |
| Save/Restore | 1 | Cursor state persistence |
| Selection | 1 | Text selection extraction |
| Scroll Region | 1 | Scroll region boundaries |

---

## 7. Application Integration

### App.axaml.cs Modification

The terminal services must be registered during application startup. Add the following to the service configuration in `App.axaml.cs`:

```csharp
// src/AIntern.Desktop/App.axaml.cs

using AIntern.Services.Terminal;

// ... existing code ...

public partial class App : Application
{
    // ... existing code ...

    private void ConfigureServices(IServiceCollection services)
    {
        // ... existing service registrations ...

        // Terminal services (v0.5.1f)
        services.AddTerminalServices();

        // ... additional service registrations ...
    }
}
```

### Integration Points

| Service | Registered As | Consumed By |
|---------|---------------|-------------|
| `IShellDetectionService` | Singleton | `ITerminalService`, future UI |
| `ITerminalService` | Singleton | ViewModels, Terminal panel (v0.5.2) |

### Service Resolution Order

```
Application Startup
        │
        ▼
ITerminalService requested
        │
        ├── Resolves IShellDetectionService (already registered)
        ├── Resolves ILogger<TerminalService>
        └── Creates TerminalService instance
```

---

## 8. Testing Strategy

### Unit Test Design

All unit tests follow these principles:

1. **Isolation**: Tests use real `TerminalBuffer` instances but don't require external resources
2. **Determinism**: Tests produce the same results on every run
3. **Independence**: Tests don't depend on each other's state
4. **Clarity**: Test names describe the scenario and expected behavior

### Test Method Naming Convention

```
[Method]_[Scenario]_[ExpectedBehavior]
```

Examples:
- `Parse_PlainText_WritesToBuffer`
- `WriteChar_AtEndOfLine_Wraps`
- `SetCursorPosition_ClampsToBounds`

### Coverage Requirements

| Component | Minimum Coverage | Critical Paths |
|-----------|------------------|----------------|
| AnsiParser | 80% | CSI sequences, SGR, control chars |
| TerminalBuffer | 80% | Write ops, scrolling, cursor movement |

### Test Dependencies

```xml
<!-- tests/AIntern.Core.Tests/AIntern.Core.Tests.csproj -->
<ItemGroup>
  <PackageReference Include="xunit" />
  <PackageReference Include="xunit.runner.visualstudio" />
  <PackageReference Include="Microsoft.NET.Test.Sdk" />
  <PackageReference Include="coverlet.collector" />
</ItemGroup>

<ItemGroup>
  <ProjectReference Include="..\..\src\AIntern.Core\AIntern.Core.csproj" />
</ItemGroup>
```

---

## 9. Verification Commands

### Build Verification

```bash
# Verify solution builds successfully
dotnet build AIntern.sln
```

### Run Unit Tests

```bash
# Run all terminal-related tests
dotnet test tests/AIntern.Core.Tests --filter "FullyQualifiedName~Terminal"

# Run with coverage
dotnet test tests/AIntern.Core.Tests --collect:"XPlat Code Coverage"
```

### Run Specific Test Classes

```bash
# Run AnsiParser tests
dotnet test tests/AIntern.Core.Tests --filter "FullyQualifiedName~AnsiParserTests"

# Run TerminalBuffer tests
dotnet test tests/AIntern.Core.Tests --filter "FullyQualifiedName~TerminalBufferTests"
```

### Application Verification

```bash
# Run the desktop application and verify no startup errors
dotnet run --project src/AIntern.Desktop
```

### Verify DI Registration

The following should not throw at runtime:
```csharp
var shellDetection = serviceProvider.GetRequiredService<IShellDetectionService>();
var terminalService = serviceProvider.GetRequiredService<ITerminalService>();
```

---

## 10. Implementation Checklist

### Files to Create

- [ ] `src/AIntern.Services/Terminal/TerminalServiceExtensions.cs`
  - [ ] TerminalServiceExtensions class
  - [ ] AddTerminalServices extension method
  - [ ] XML documentation

- [ ] `tests/AIntern.Core.Tests/Terminal/AnsiParserTests.cs`
  - [ ] AnsiParserTests class
  - [ ] Plain text tests (3)
  - [ ] Cursor movement tests (3)
  - [ ] SGR tests (5)
  - [ ] Erase tests (2)
  - [ ] Cursor save/restore tests (1)
  - [ ] OSC tests (1)
  - [ ] Control character tests (3)

- [ ] `tests/AIntern.Core.Tests/Terminal/TerminalBufferTests.cs`
  - [ ] TerminalBufferTests class
  - [ ] Constructor tests (1)
  - [ ] WriteChar tests (3)
  - [ ] LineFeed tests (2)
  - [ ] CarriageReturn tests (1)
  - [ ] Clear tests (3)
  - [ ] Resize tests (1)
  - [ ] Cursor position tests (1)
  - [ ] Save/restore tests (1)
  - [ ] Selection tests (1)
  - [ ] Scroll region tests (1)

### Files to Modify

- [ ] `src/AIntern.Desktop/App.axaml.cs`
  - [ ] Add `using AIntern.Services.Terminal;`
  - [ ] Call `services.AddTerminalServices();`

### Verification Steps

1. [ ] Build solution: `dotnet build AIntern.sln`
2. [ ] Run unit tests: `dotnet test tests/AIntern.Core.Tests`
3. [ ] Verify all 33 tests pass
4. [ ] Run application: `dotnet run --project src/AIntern.Desktop`
5. [ ] Verify no startup exceptions
6. [ ] Verify services resolve correctly at runtime

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| v0.5.1f | TBD | Initial specification |

---

## References

- [xUnit Documentation](https://xunit.net/)
- [Microsoft.Extensions.DependencyInjection](https://docs.microsoft.com/en-us/dotnet/core/extensions/dependency-injection)
- [v0.5.1-terminal-foundation.md](./v0.5.1-terminal-foundation.md) – Version scope
- [v0.5.1b-terminal-models.md](./v0.5.1b-terminal-models.md) – TerminalBuffer definition
- [v0.5.1c-ansi-parser.md](./v0.5.1c-ansi-parser.md) – AnsiParser definition
- [v0.5.1d-terminal-service.md](./v0.5.1d-terminal-service.md) – TerminalService definition
- [v0.5.1e-shell-detection.md](./v0.5.1e-shell-detection.md) – ShellDetectionService definition
