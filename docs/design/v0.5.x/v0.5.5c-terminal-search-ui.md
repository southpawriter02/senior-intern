# Design Specification: AIntern v0.5.5c "Terminal Search UI"

## Overview

**Version**: v0.5.5c
**Parent**: v0.5.5 Polish & Integration
**Focus**: Search bar UI component with keyboard navigation and visual feedback

### Purpose

This sub-version creates the terminal search UI:
1. Create `TerminalSearchBarViewModel` with search state and commands
2. Create `TerminalSearchBar` XAML control with input and navigation
3. Add search result highlighting to `TerminalRenderer`
4. Integrate search bar with `TerminalPanel`
5. Support keyboard shortcuts (Ctrl+F, Enter, Escape, etc.)
6. Implement debounced incremental search
7. Display results counter and error messages

### Dependencies

**From v0.5.5a (Terminal Search Models)**:
- `TerminalSearchResult`, `TerminalSearchState`
- `TerminalSearchOptions`, `SearchHighlightStyle`

**From v0.5.5b (Terminal Search Service)**:
- `ITerminalSearchService`

**From v0.5.2 (Terminal UI)**:
- `TerminalRenderer` - Highlight rendering
- `TerminalPanelViewModel` - Integration point

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   v0.5.5c Terminal Search UI Architecture                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     ViewModel Layer                                      â”‚ â”‚
â”‚  â”‚  src/AIntern.Desktop/ViewModels/                                        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  TerminalSearchBarViewModel : ViewModelBase                              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Dependencies:                                                      â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ ITerminalSearchService                                         â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€ ITerminalBuffer (from parent)                                  â”‚ â”‚
â”‚  â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Observable Properties:                                             â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ SearchQuery: string                                            â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ IsSearchVisible: bool                                          â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ CaseSensitive: bool                                            â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ UseRegex: bool                                                 â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ SearchState: TerminalSearchState                               â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ IsSearching: bool                                              â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ SearchResultsText: string                                      â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€ ErrorMessage: string?                                          â”‚ â”‚
â”‚  â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Commands:                                                          â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ NextSearchResultCommand                                        â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ PreviousSearchResultCommand                                    â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ CloseSearchCommand                                             â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ ToggleCaseSensitiveCommand                                     â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€ ToggleRegexCommand                                             â”‚ â”‚
â”‚  â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Events:                                                            â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ ScrollToResultRequested: EventHandler<TerminalSearchResult>    â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ SearchOpened: EventHandler                                     â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€ SearchClosed: EventHandler                                     â”‚ â”‚
â”‚  â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Behavior:                                                          â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ Debounced search on query change (150ms)                       â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ Re-search on option toggle                                     â”‚ â”‚
â”‚  â”‚      â””â”€â”€ Cancel previous search on new query                            â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       View Layer                                         â”‚ â”‚
â”‚  â”‚  src/AIntern.Desktop/Views/                                             â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  TerminalSearchBar.axaml                                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Layout: Floating border at top-right of terminal                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Search input TextBox with watermark                                â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Results counter (e.g., "3 of 15")                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Case sensitive toggle (Aa)                                         â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Regex toggle (.*)                                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Previous/Next navigation buttons                                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Close button                                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Error message display (for invalid regex)                          â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Loading spinner during search                                      â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  TerminalSearchBar.axaml.cs                                              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Keyboard handling (Enter, Shift+Enter, Escape)                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Alt+C for case toggle, Alt+R for regex toggle                      â”‚ â”‚
â”‚  â”‚  â””â”€â”€ FocusSearchInput() public method                                   â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Renderer Extensions                                   â”‚ â”‚
â”‚  â”‚  src/AIntern.Desktop/Controls/TerminalRenderer.cs                       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  RenderSearchHighlights(canvas, searchState, viewport)                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Skip results outside viewport                                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Draw semi-transparent overlay for all matches                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Draw opaque highlight for current match                            â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Draw border around current match                                   â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Search Bar Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Terminal Search Bar Layout                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Terminal Panel                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Terminal Content (TerminalRenderer)           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                 â”‚ Search Bar    â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     $ npm run build                            â”‚ (floating)    â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     > project@1.0.0 build                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     > webpack --mode production                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     Compiled successfully!                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚        [highlight]react[/highlight] -> bundle.js                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Search Bar Detail:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚ â”‚ Border.terminal-search-bar (floating, shadow)                    â”‚   â”‚ â”‚
â”‚  â”‚ â”‚                                                                   â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”      â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ â”‚ [Search input  ğŸ”„]â”‚ 3 of 15 â”‚[Aa]â”‚[.*]â”‚[â†‘] â”‚[â†“] â”‚ â”‚ â”‚[âœ•] â”‚      â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”˜      â”‚   â”‚ â”‚
â”‚  â”‚ â”‚    TextBox          Counter  Case Regex Prev Next Sep Close     â”‚   â”‚ â”‚
â”‚  â”‚ â”‚                                                                   â”‚   â”‚ â”‚
â”‚  â”‚ â”‚ [Invalid regex: missing closing bracket]  â† Error row (if any)  â”‚   â”‚ â”‚
â”‚  â”‚ â”‚                                                                   â”‚   â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Search Result Highlighting

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Search Highlight Rendering                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Terminal Buffer (rendered in SkiaSharp)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Line 0: $ npm install react react-dom                                 â”‚ â”‚
â”‚  â”‚                        â–“â–“â–“â–“â–“      â–“â–“â–“â–“â–“  â† Yellow highlight (matches) â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  Line 1: added 523 packages from 192 contributors                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  Line 2: $ cat package.json | grep react                               â”‚ â”‚
â”‚  â”‚                                   â–“â–“â–“â–“â–“  â† Yellow highlight            â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  Line 3: "react": "^18.2.0",                                           â”‚ â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â† Orange highlight + border (CURRENT)     â”‚ â”‚
â”‚  â”‚   â”‚                                                                    â”‚ â”‚
â”‚  â”‚   â””â”€â”€ CurrentMatchBackground + CurrentMatchBorder                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  Line 4: "react-dom": "^18.2.0",                                       â”‚ â”‚
â”‚  â”‚   â–“â–“â–“â–“â–“  â† Yellow highlight (match, not current)                      â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Highlight Styles:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Regular Match:                                                         â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Background: MatchBackground (#FFFF00, 70% opacity)                â”‚ â”‚
â”‚  â”‚  â””â”€â”€ No border                                                         â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  Current Match:                                                         â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ Background: CurrentMatchBackground (#FF8C00, 100% opacity)        â”‚ â”‚
â”‚  â”‚  â””â”€â”€ Border: CurrentMatchBorder (#FF4500, 2px)                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Specifications

### 1. TerminalSearchBarViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/TerminalSearchBarViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using System.Timers;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Avalonia.Threading;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// ViewModel for the terminal search bar.
/// Handles search input, navigation, and option toggling.
/// </summary>
public partial class TerminalSearchBarViewModel : ViewModelBase, IDisposable
{
    private readonly ITerminalSearchService _searchService;
    private readonly TerminalSearchOptions _options;
    private ITerminalBuffer? _buffer;
    private CancellationTokenSource? _searchCts;
    private readonly System.Timers.Timer _debounceTimer;
    private bool _disposed;

    // === Observable Properties ===

    [ObservableProperty]
    private string _searchQuery = string.Empty;

    [ObservableProperty]
    private bool _isSearchVisible;

    [ObservableProperty]
    private bool _caseSensitive;

    [ObservableProperty]
    private bool _useRegex;

    [ObservableProperty]
    private TerminalSearchState _searchState = TerminalSearchState.Empty;

    [ObservableProperty]
    private bool _isSearching;

    [ObservableProperty]
    private string _searchResultsText = string.Empty;

    [ObservableProperty]
    private string? _errorMessage;

    // === Constructor ===

    public TerminalSearchBarViewModel(
        ITerminalSearchService searchService,
        TerminalSearchOptions? options = null)
    {
        _searchService = searchService;
        _options = options ?? TerminalSearchOptions.Default;
        
        // Initialize debounce timer
        _debounceTimer = new System.Timers.Timer(_options.DebounceDelayMs);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += OnDebounceTimerElapsed;
    }

    // === Buffer Connection ===

    /// <summary>
    /// Set the terminal buffer to search within.
    /// </summary>
    public void SetBuffer(ITerminalBuffer buffer)
    {
        _buffer = buffer;
    }

    // === Property Change Handlers ===

    partial void OnSearchQueryChanged(string value)
    {
        // Reset and restart debounce timer
        _debounceTimer.Stop();
        _debounceTimer.Start();
    }

    partial void OnCaseSensitiveChanged(bool value)
    {
        TriggerSearchAsync();
    }

    partial void OnUseRegexChanged(bool value)
    {
        TriggerSearchAsync();
    }

    partial void OnIsSearchVisibleChanged(bool value)
    {
        if (value)
        {
            SearchOpened?.Invoke(this, EventArgs.Empty);
        }
        else
        {
            SearchClosed?.Invoke(this, EventArgs.Empty);
        }
    }

    // === Debounced Search ===

    private void OnDebounceTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        // Dispatch to UI thread
        Dispatcher.UIThread.Post(() => TriggerSearchAsync());
    }

    private async void TriggerSearchAsync()
    {
        if (_buffer == null) return;

        // Cancel any pending search
        _searchCts?.Cancel();
        _searchCts = new CancellationTokenSource();

        var ct = _searchCts.Token;

        try
        {
            IsSearching = true;
            ErrorMessage = null;

            var state = new TerminalSearchState
            {
                Query = SearchQuery,
                CaseSensitive = CaseSensitive,
                UseRegex = UseRegex,
                WrapAround = true,
                IncludeScrollback = true
            };

            SearchState = await _searchService.SearchAsync(
                _buffer,
                SearchQuery,
                state,
                _options,
                ct);

            UpdateResultsText();
            ErrorMessage = SearchState.ErrorMessage;

            // Request scroll to current result
            if (SearchState.CurrentResult != null)
            {
                ScrollToResultRequested?.Invoke(this, SearchState.CurrentResult);
            }
        }
        catch (OperationCanceledException)
        {
            // Search was cancelled, ignore
        }
        finally
        {
            IsSearching = false;
        }
    }

    private void UpdateResultsText()
    {
        SearchResultsText = SearchState.ResultsSummary;
    }

    // === Commands ===

    [RelayCommand]
    private void NextSearchResult()
    {
        SearchState = _searchService.NavigateNext(SearchState);
        UpdateResultsText();

        if (SearchState.CurrentResult != null)
        {
            ScrollToResultRequested?.Invoke(this, SearchState.CurrentResult);
        }
    }

    [RelayCommand]
    private void PreviousSearchResult()
    {
        SearchState = _searchService.NavigatePrevious(SearchState);
        UpdateResultsText();

        if (SearchState.CurrentResult != null)
        {
            ScrollToResultRequested?.Invoke(this, SearchState.CurrentResult);
        }
    }

    [RelayCommand]
    private void CloseSearch()
    {
        IsSearchVisible = false;
        SearchQuery = string.Empty;
        SearchState = _searchService.ClearSearch();
        ErrorMessage = null;
        UpdateResultsText();
    }

    [RelayCommand]
    private void ToggleCaseSensitive()
    {
        CaseSensitive = !CaseSensitive;
    }

    [RelayCommand]
    private void ToggleRegex()
    {
        UseRegex = !UseRegex;
    }

    // === Public Methods ===

    /// <summary>
    /// Open the search bar and focus the input.
    /// </summary>
    public void OpenSearch()
    {
        IsSearchVisible = true;
    }

    /// <summary>
    /// Navigate to a result at a specific line (e.g., from scrollbar marker click).
    /// </summary>
    public void NavigateToLine(int lineIndex)
    {
        SearchState = _searchService.NavigateToLine(
            SearchState, 
            lineIndex, 
            SearchDirection.Forward);
        
        UpdateResultsText();

        if (SearchState.CurrentResult != null)
        {
            ScrollToResultRequested?.Invoke(this, SearchState.CurrentResult);
        }
    }

    // === Events ===

    /// <summary>
    /// Raised when the terminal should scroll to show a search result.
    /// </summary>
    public event EventHandler<TerminalSearchResult>? ScrollToResultRequested;

    /// <summary>
    /// Raised when the search bar is opened.
    /// </summary>
    public event EventHandler? SearchOpened;

    /// <summary>
    /// Raised when the search bar is closed.
    /// </summary>
    public event EventHandler? SearchClosed;

    // === Cleanup ===

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;

        _debounceTimer.Stop();
        _debounceTimer.Elapsed -= OnDebounceTimerElapsed;
        _debounceTimer.Dispose();

        _searchCts?.Cancel();
        _searchCts?.Dispose();
    }
}
```

### 2. TerminalSearchBar.axaml

**Location**: `src/AIntern.Desktop/Views/TerminalSearchBar.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             x:Class="AIntern.Desktop.Views.TerminalSearchBar"
             x:DataType="vm:TerminalSearchBarViewModel">

    <UserControl.Styles>
        <!-- Search Bar Container -->
        <Style Selector="Border.terminal-search-bar">
            <Setter Property="Background" Value="{DynamicResource SearchBarBackground}" />
            <Setter Property="BorderBrush" Value="{DynamicResource SearchBarBorder}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="8" />
            <Setter Property="BoxShadow" Value="0 4 16 0 #40000000" />
        </Style>

        <!-- Option Toggle Buttons -->
        <Style Selector="ToggleButton.search-option">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="6" />
            <Setter Property="Width" Value="28" />
            <Setter Property="Height" Value="28" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>

        <Style Selector="ToggleButton.search-option:pointerover">
            <Setter Property="Background" Value="{DynamicResource HoverBrush}" />
        </Style>

        <Style Selector="ToggleButton.search-option:checked">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource AccentForeground}" />
        </Style>

        <!-- Search Input -->
        <Style Selector="TextBox.search-input">
            <Setter Property="MinWidth" Value="220" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>

        <!-- Icon Buttons -->
        <Style Selector="Button.search-nav-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="4" />
            <Setter Property="Width" Value="28" />
            <Setter Property="Height" Value="28" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>

        <Style Selector="Button.search-nav-button:pointerover">
            <Setter Property="Background" Value="{DynamicResource HoverBrush}" />
        </Style>

        <Style Selector="Button.search-nav-button:disabled">
            <Setter Property="Opacity" Value="0.4" />
        </Style>

        <!-- Error Text -->
        <Style Selector="TextBlock.search-error">
            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Margin" Value="0,4,0,0" />
        </Style>

        <!-- Spinner Animation -->
        <Style Selector="PathIcon.spinning">
            <Style.Animations>
                <Animation Duration="0:0:1" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
            <Setter Property="RenderTransform">
                <RotateTransform />
            </Setter>
        </Style>
    </UserControl.Styles>

    <Border Classes="terminal-search-bar"
            IsVisible="{Binding IsSearchVisible}"
            HorizontalAlignment="Right"
            VerticalAlignment="Top"
            Margin="16">

        <StackPanel Spacing="4">
            <!-- Main Search Row -->
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto">

                <!-- Search Input -->
                <TextBox x:Name="SearchTextBox"
                         Grid.Column="0"
                         Classes="search-input"
                         Text="{Binding SearchQuery, Mode=TwoWay}"
                         Watermark="Search terminal..."
                         KeyDown="OnSearchKeyDown">
                    <TextBox.InnerRightContent>
                        <StackPanel Orientation="Horizontal" Spacing="2" Margin="4,0">
                            <!-- Loading Spinner (visible during search) -->
                            <PathIcon Data="{StaticResource SpinnerIcon}"
                                      Width="14" Height="14"
                                      IsVisible="{Binding IsSearching}"
                                      Classes="spinning"
                                      Foreground="{DynamicResource AccentBrush}" />
                        </StackPanel>
                    </TextBox.InnerRightContent>
                </TextBox>

                <!-- Results Counter -->
                <TextBlock Grid.Column="1"
                           Text="{Binding SearchResultsText}"
                           VerticalAlignment="Center"
                           Margin="8,0"
                           MinWidth="60"
                           FontSize="12"
                           Foreground="{DynamicResource TextMuted}" />

                <!-- Case Sensitive Toggle -->
                <ToggleButton Grid.Column="2"
                              Classes="search-option"
                              IsChecked="{Binding CaseSensitive}"
                              ToolTip.Tip="Match Case (Alt+C)">
                    <TextBlock Text="Aa" 
                               FontSize="12" 
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center" />
                </ToggleButton>

                <!-- Regex Toggle -->
                <ToggleButton Grid.Column="3"
                              Classes="search-option"
                              IsChecked="{Binding UseRegex}"
                              ToolTip.Tip="Use Regular Expression (Alt+R)">
                    <TextBlock Text=".*" 
                               FontSize="12" 
                               FontFamily="Cascadia Code, Consolas, monospace"
                               HorizontalAlignment="Center" />
                </ToggleButton>

                <!-- Separator -->
                <Border Grid.Column="4"
                        Width="1"
                        Height="20"
                        Background="{DynamicResource BorderBrush}"
                        Margin="4,0" />

                <!-- Previous Result -->
                <Button Grid.Column="5"
                        Classes="search-nav-button"
                        Command="{Binding PreviousSearchResultCommand}"
                        IsEnabled="{Binding SearchState.HasResults}"
                        ToolTip.Tip="Previous Match (Shift+Enter)">
                    <PathIcon Data="{StaticResource ChevronUpIcon}" 
                              Width="14" Height="14" />
                </Button>

                <!-- Next Result -->
                <Button Grid.Column="6"
                        Classes="search-nav-button"
                        Command="{Binding NextSearchResultCommand}"
                        IsEnabled="{Binding SearchState.HasResults}"
                        ToolTip.Tip="Next Match (Enter)">
                    <PathIcon Data="{StaticResource ChevronDownIcon}" 
                              Width="14" Height="14" />
                </Button>

                <!-- Separator -->
                <Border Grid.Column="7"
                        Width="1"
                        Height="20"
                        Background="{DynamicResource BorderBrush}"
                        Margin="4,0" />

                <!-- Close Button -->
                <Button Grid.Column="8"
                        Classes="search-nav-button"
                        Command="{Binding CloseSearchCommand}"
                        ToolTip.Tip="Close (Escape)">
                    <PathIcon Data="{StaticResource CloseIcon}" 
                              Width="12" Height="12" />
                </Button>
            </Grid>

            <!-- Error Message Row -->
            <TextBlock Classes="search-error"
                       Text="{Binding ErrorMessage}"
                       IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                       TextWrapping="Wrap"
                       MaxWidth="350" />
        </StackPanel>
    </Border>
</UserControl>
```

### 3. TerminalSearchBar.axaml.cs

**Location**: `src/AIntern.Desktop/Views/TerminalSearchBar.axaml.cs`

```csharp
namespace AIntern.Desktop.Views;

using Avalonia.Controls;
using Avalonia.Input;
using AIntern.Desktop.ViewModels;

/// <summary>
/// Code-behind for the terminal search bar.
/// Handles keyboard navigation and focus management.
/// </summary>
public partial class TerminalSearchBar : UserControl
{
    public TerminalSearchBar()
    {
        InitializeComponent();
    }

    /// <summary>
    /// Handles keyboard input for search navigation.
    /// </summary>
    private void OnSearchKeyDown(object? sender, KeyEventArgs e)
    {
        if (DataContext is not TerminalSearchBarViewModel vm)
            return;

        switch (e.Key)
        {
            // Shift+Enter: Previous result
            case Key.Enter when e.KeyModifiers.HasFlag(KeyModifiers.Shift):
                vm.PreviousSearchResultCommand.Execute(null);
                e.Handled = true;
                break;

            // Enter: Next result
            case Key.Enter:
                vm.NextSearchResultCommand.Execute(null);
                e.Handled = true;
                break;

            // Escape: Close search
            case Key.Escape:
                vm.CloseSearchCommand.Execute(null);
                e.Handled = true;
                break;

            // Alt+C: Toggle case sensitivity
            case Key.C when e.KeyModifiers.HasFlag(KeyModifiers.Alt):
                vm.ToggleCaseSensitiveCommand.Execute(null);
                e.Handled = true;
                break;

            // Alt+R: Toggle regex mode
            case Key.R when e.KeyModifiers.HasFlag(KeyModifiers.Alt):
                vm.ToggleRegexCommand.Execute(null);
                e.Handled = true;
                break;

            // F3: Next result (alternative)
            case Key.F3 when !e.KeyModifiers.HasFlag(KeyModifiers.Shift):
                vm.NextSearchResultCommand.Execute(null);
                e.Handled = true;
                break;

            // Shift+F3: Previous result (alternative)
            case Key.F3 when e.KeyModifiers.HasFlag(KeyModifiers.Shift):
                vm.PreviousSearchResultCommand.Execute(null);
                e.Handled = true;
                break;
        }
    }

    /// <summary>
    /// Focuses the search input and selects all text.
    /// Called when the search bar is opened.
    /// </summary>
    public void FocusSearchInput()
    {
        SearchTextBox.Focus();
        SearchTextBox.SelectAll();
    }

    /// <summary>
    /// Called when the search bar becomes visible.
    /// </summary>
    protected override void OnPropertyChanged(Avalonia.AvaloniaPropertyChangedEventArgs change)
    {
        base.OnPropertyChanged(change);

        if (change.Property == IsVisibleProperty && IsVisible)
        {
            // Focus the input when the control becomes visible
            Avalonia.Threading.Dispatcher.UIThread.Post(() =>
            {
                FocusSearchInput();
            });
        }
    }
}
```

### 4. TerminalRenderer Search Highlight Extensions

**Location**: `src/AIntern.Desktop/Controls/TerminalRenderer.cs` (additions)

```csharp
// === Add property for search state ===

private TerminalSearchState? _searchState;
private SearchHighlightStyle _highlightStyle = SearchHighlightStyle.Default;

/// <summary>
/// Sets the current search state for highlighting.
/// </summary>
public void SetSearchState(TerminalSearchState? state)
{
    _searchState = state;
    InvalidateVisual();
}

/// <summary>
/// Sets the highlight style for search results.
/// </summary>
public void SetHighlightStyle(SearchHighlightStyle style)
{
    _highlightStyle = style;
    InvalidateVisual();
}

// === Add to Render method (after drawing text, before cursor) ===

private void RenderSearchHighlights(SKCanvas canvas)
{
    if (_searchState == null || !_searchState.HasResults)
        return;

    var viewportStartLine = _scrollOffset;
    var viewportEndLine = viewportStartLine + _visibleLineCount;

    // Create paints
    using var matchPaint = new SKPaint
    {
        Color = SKColor.Parse(_highlightStyle.MatchBackground)
            .WithAlpha((byte)(255 * _highlightStyle.MatchOpacity)),
        Style = SKPaintStyle.Fill,
        IsAntialias = true
    };

    using var currentMatchPaint = new SKPaint
    {
        Color = SKColor.Parse(_highlightStyle.CurrentMatchBackground),
        Style = SKPaintStyle.Fill,
        IsAntialias = true
    };

    using var currentMatchBorderPaint = new SKPaint
    {
        Color = SKColor.Parse(_highlightStyle.CurrentMatchBorder),
        Style = SKPaintStyle.Stroke,
        StrokeWidth = _highlightStyle.CurrentMatchBorderThickness,
        IsAntialias = true
    };

    // Get current result for comparison
    var currentResult = _searchState.CurrentResult;

    // Iterate visible results only
    foreach (var result in _searchState.Results)
    {
        // Skip results outside visible viewport
        if (result.LineIndex < viewportStartLine || result.LineIndex >= viewportEndLine)
            continue;

        // Calculate screen position
        var screenLine = result.LineIndex - viewportStartLine;
        var y = screenLine * _cellHeight;
        var x = result.StartColumn * _cellWidth;
        var width = result.Length * _cellWidth;

        var rect = new SKRect(x, y, x + width, y + _cellHeight);

        // Check if this is the current result
        var isCurrent = currentResult != null &&
                        result.LineIndex == currentResult.LineIndex &&
                        result.StartColumn == currentResult.StartColumn;

        // Draw highlight
        canvas.DrawRect(rect, isCurrent ? currentMatchPaint : matchPaint);

        // Draw border for current match
        if (isCurrent)
        {
            canvas.DrawRect(rect, currentMatchBorderPaint);
        }
    }
}

// === Scroll To Result ===

/// <summary>
/// Scrolls the terminal to show the specified search result.
/// </summary>
public void ScrollToResult(TerminalSearchResult result)
{
    if (result == null) return;

    // Check if result is already visible
    var viewportStart = _scrollOffset;
    var viewportEnd = viewportStart + _visibleLineCount;

    if (result.LineIndex >= viewportStart && result.LineIndex < viewportEnd)
    {
        // Already visible, just redraw to update highlight
        InvalidateVisual();
        return;
    }

    // Scroll to center the result in the viewport
    var targetLine = result.LineIndex - (_visibleLineCount / 2);
    targetLine = Math.Max(0, Math.Min(targetLine, _buffer.TotalLineCount - _visibleLineCount));

    ScrollTo(targetLine);
}
```

### 5. Theme Resources for Search

**Location**: `src/AIntern.Desktop/Themes/Dark.axaml` (additions)

```xml
<!-- Search Bar Resources -->
<Color x:Key="SearchBarBackgroundColor">#1E1E2E</Color>
<Color x:Key="SearchBarBorderColor">#313244</Color>
<Color x:Key="SearchMatchBackgroundColor">#FFFF00</Color>
<Color x:Key="SearchCurrentMatchBackgroundColor">#FF8C00</Color>
<Color x:Key="SearchCurrentMatchBorderColor">#FF4500</Color>

<SolidColorBrush x:Key="SearchBarBackground" Color="{DynamicResource SearchBarBackgroundColor}" />
<SolidColorBrush x:Key="SearchBarBorder" Color="{DynamicResource SearchBarBorderColor}" />
```

**Location**: `src/AIntern.Desktop/Themes/Light.axaml` (additions)

```xml
<!-- Search Bar Resources -->
<Color x:Key="SearchBarBackgroundColor">#FFFFFF</Color>
<Color x:Key="SearchBarBorderColor">#DCE0E8</Color>
<Color x:Key="SearchMatchBackgroundColor">#FFFACD</Color>
<Color x:Key="SearchCurrentMatchBackgroundColor">#FFD700</Color>
<Color x:Key="SearchCurrentMatchBorderColor">#FF8C00</Color>

<SolidColorBrush x:Key="SearchBarBackground" Color="{DynamicResource SearchBarBackgroundColor}" />
<SolidColorBrush x:Key="SearchBarBorder" Color="{DynamicResource SearchBarBorderColor}" />
```

### 6. Icon Additions

**Location**: `src/AIntern.Desktop/Assets/Icons.axaml` (additions)

```xml
<!-- Chevron Up Icon (for Previous) -->
<StreamGeometry x:Key="ChevronUpIcon">M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z</StreamGeometry>

<!-- Spinner Icon (for Loading) - if not already present -->
<StreamGeometry x:Key="SpinnerIcon">M12 4V2C6.48 2 2 6.48 2 12h2c0-4.42 3.58-8 8-8zm0 16v2c5.52 0 10-4.48 10-10h-2c0 4.42-3.58 8-8 8z</StreamGeometry>
```

---

## Keyboard Shortcuts Summary

| Shortcut | Action | Context |
|----------|--------|---------|
| `Ctrl+F` | Open search bar | Terminal panel |
| `Escape` | Close search bar | Search input focused |
| `Enter` | Next result | Search input focused |
| `Shift+Enter` | Previous result | Search input focused |
| `F3` | Next result | Search input focused |
| `Shift+F3` | Previous result | Search input focused |
| `Alt+C` | Toggle case sensitivity | Search input focused |
| `Alt+R` | Toggle regex mode | Search input focused |

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `TerminalSearchBarViewModel.cs` | `ViewModels/` | Search bar ViewModel |
| `TerminalSearchBar.axaml` | `Views/` | Search bar UI |
| `TerminalSearchBar.axaml.cs` | `Views/` | Code-behind |

### Files to Modify

| File | Changes |
|------|---------|
| `TerminalRenderer.cs` | Add `RenderSearchHighlights`, `SetSearchState`, `ScrollToResult` |
| `TerminalPanel.axaml` | Include search bar overlay |
| `TerminalPanelViewModel.cs` | Add search ViewModel, handle Ctrl+F |
| `Dark.axaml` | Add search bar theme resources |
| `Light.axaml` | Add search bar theme resources |
| `Icons.axaml` | Add ChevronUpIcon, SpinnerIcon |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `ViewModel_SearchQuery_TriggersDebounce` | Debounce timer starts |
| `ViewModel_SearchQuery_CancelsOldSearch` | Previous CTS cancelled |
| `ViewModel_CaseSensitiveChange_TriggersSearch` | Option retriggers |
| `ViewModel_UseRegexChange_TriggersSearch` | Option retriggers |
| `ViewModel_NextSearchResult_NavigatesForward` | Index increments |
| `ViewModel_PreviousSearchResult_NavigatesBackward` | Index decrements |
| `ViewModel_CloseSearch_ClearsState` | State reset |
| `ViewModel_OpenSearch_SetsVisible` | IsSearchVisible true |
| `ViewModel_ScrollToResultRequested_Raised` | Event fired |
| `ViewModel_ErrorMessage_SetFromState` | Error propagated |
| `ViewModel_Dispose_StopsTimer` | Timer disposed |
| `CodeBehind_Enter_CallsNext` | KeyDown handler |
| `CodeBehind_ShiftEnter_CallsPrevious` | KeyDown handler |
| `CodeBehind_Escape_CallsClose` | KeyDown handler |
| `CodeBehind_AltC_TogglesCase` | KeyDown handler |
| `CodeBehind_AltR_TogglesRegex` | KeyDown handler |
| `Renderer_HighlightsVisibleResults` | Only viewport rendered |
| `Renderer_CurrentMatchHasBorder` | Border drawn |
| `Renderer_ScrollToResult_CentersViewport` | Scroll calculation |

**Total Tests**: 19

---

## Verification

```bash
# Build the desktop project
dotnet build src/AIntern.Desktop

# Run unit tests
dotnet test --filter "TerminalSearchBar"

# Run application and test visually
dotnet run --project src/AIntern.Desktop
# 1. Open terminal (Ctrl+`)
# 2. Type some commands
# 3. Press Ctrl+F to open search
# 4. Type query and verify highlights
# 5. Press Enter/Shift+Enter to navigate
# 6. Press Escape to close
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Ctrl+F opens floating search bar |
| AC-2 | Search input accepts text and triggers debounced search |
| AC-3 | Results count displays correctly (e.g., "3 of 15") |
| AC-4 | "No results" shown when no matches |
| AC-5 | Case sensitive toggle (Aa) works |
| AC-6 | Regex toggle (.*) works |
| AC-7 | Invalid regex shows error message |
| AC-8 | Enter navigates to next result |
| AC-9 | Shift+Enter navigates to previous result |
| AC-10 | Escape closes search bar |
| AC-11 | All matches highlighted in yellow |
| AC-12 | Current match highlighted in orange with border |
| AC-13 | Terminal scrolls to show current result |
| AC-14 | Loading spinner shown during search |

---

## Changelog Entry

```markdown
## v0.5.5c - Terminal Search UI

### Added
- `TerminalSearchBarViewModel` with:
  - Debounced incremental search (150ms)
  - CaseSensitive, UseRegex toggles
  - Navigation: Next, Previous, Close commands
  - ScrollToResultRequested event
  - Cancellation support

- `TerminalSearchBar` control with:
  - Search input with watermark
  - Results counter display
  - Case/Regex toggle buttons
  - Previous/Next navigation buttons
  - Close button
  - Error message display
  - Loading spinner animation

- Keyboard shortcuts:
  - Enter: Next result
  - Shift+Enter: Previous result
  - Escape: Close search
  - Alt+C: Toggle case sensitivity
  - Alt+R: Toggle regex

### Extended
- `TerminalRenderer` with:
  - RenderSearchHighlights() method
  - SetSearchState() for highlight updates
  - ScrollToResult() for navigation
  - Theme-aware highlight colors

### Theme
- Added search bar resources to Dark.axaml and Light.axaml
- Added ChevronUpIcon and SpinnerIcon
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.5c | 1 day |
