# Design Specification: AIntern v0.5.2d "ViewModels"

## Overview

**Version**: v0.5.2d
**Parent**: v0.5.2 Terminal UI
**Focus**: ViewModel layer for terminal panel session management and tab navigation

### Purpose

This sub-version creates the MVVM ViewModel layer for the terminal UI:
1. `TerminalSessionViewModel` - Represents a single terminal session (tab)
2. `TerminalPanelViewModel` - Manages the terminal panel, session collection, and panel state

### Dependencies

**From v0.5.1c (Terminal Service)**:
- `ITerminalService` - Terminal session management interface
- `TerminalSession` - Session model with Id, Name, State, WorkingDirectory
- `TerminalSessionState` - Session state enum (Starting, Running, Exited, Error)
- `TerminalSessionOptions` - Options for creating new sessions
- `TerminalSize` - Terminal dimensions (columns, rows)
- Service events: `SessionCreated`, `SessionClosed`, `SessionStateChanged`, `TitleChanged`

**From v0.5.2a (Theme & Styles)**:
- `TerminalTheme` - Color theme selection

**From Desktop Framework**:
- `ViewModelBase` - Base class with `IsBusy`, `SetError`, `ClearError`
- CommunityToolkit.Mvvm - `[ObservableProperty]`, `[RelayCommand]`, `[NotifyPropertyChangedFor]`, `[NotifyCanExecuteChangedFor]`

**Optional Dependency**:
- `IWorkspaceService` - For setting initial working directory to workspace root

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        v0.5.2d ViewModels Architecture                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                      Session ViewModel Layer                             │ │
│  │  src/AIntern.Desktop/ViewModels/                                        │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                  TerminalSessionViewModel                           │ │ │
│  │  │  Extends: ViewModelBase                                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Private Fields:                                             │   │ │ │
│  │  │  │  └── _session: TerminalSession (readonly)                   │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Computed Properties:                                        │   │ │ │
│  │  │  │  ├── Id: Guid (from _session)                               │   │ │ │
│  │  │  │  ├── ShellType: string (readonly, computed once)            │   │ │ │
│  │  │  │  ├── HasExited: bool (computed from State)                  │   │ │ │
│  │  │  │  └── ExitCode: int? (from _session)                         │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Observable Properties:                                      │   │ │ │
│  │  │  │  ├── Name: string (tab display name)                        │   │ │ │
│  │  │  │  ├── IsActive: bool (selected tab indicator)                │   │ │ │
│  │  │  │  ├── State: TerminalSessionState                            │   │ │ │
│  │  │  │  └── WorkingDirectory: string                               │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Methods:                                                    │   │ │ │
│  │  │  │  ├── UpdateFromSession() - Sync observable props from model │   │ │ │
│  │  │  │  └── GetShellType(shellPath) → string (static helper)       │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Panel ViewModel Layer                              │ │
│  │  src/AIntern.Desktop/ViewModels/                                        │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                   TerminalPanelViewModel                            │ │ │
│  │  │  Extends: ViewModelBase                                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Private Fields:                                             │   │ │ │
│  │  │  │  ├── _terminalService: ITerminalService (readonly)          │   │ │ │
│  │  │  │  └── _workspaceService: IWorkspaceService? (readonly)       │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Collection Property:                                        │   │ │ │
│  │  │  │  └── Sessions: ObservableCollection<TerminalSessionViewModel>│   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Observable Properties:                                      │   │ │ │
│  │  │  │  ├── ActiveSession: TerminalSessionViewModel?               │   │ │ │
│  │  │  │  │   └── [NotifyPropertyChangedFor(HasActiveSession)]       │   │ │ │
│  │  │  │  │   └── [NotifyCanExecuteChangedFor(CloseActiveSession)]   │   │ │ │
│  │  │  │  │   └── [NotifyCanExecuteChangedFor(ClearTerminal)]        │   │ │ │
│  │  │  │  ├── IsVisible: bool (panel visibility)                     │   │ │ │
│  │  │  │  ├── IsMaximized: bool (panel maximized state)              │   │ │ │
│  │  │  │  ├── PanelHeight: double = 300 (resizable height)           │   │ │ │
│  │  │  │  ├── FontFamily: string = "Cascadia Mono"                   │   │ │ │
│  │  │  │  ├── FontSize: double = 14                                  │   │ │ │
│  │  │  │  └── Theme: TerminalTheme = TerminalTheme.Dark              │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Computed Properties:                                        │   │ │ │
│  │  │  │  └── HasActiveSession: bool (ActiveSession != null)         │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Events:                                                     │   │ │ │
│  │  │  │  └── ActiveSessionChanged: EventHandler<TerminalSessionVM?> │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Commands (TerminalPanelViewModel)                  │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌──────────────────────────────────────────┬─────────────────────────┐ │ │
│  │  │  Command                                  │  Can Execute            │ │ │
│  │  ├──────────────────────────────────────────┼─────────────────────────┤ │ │
│  │  │  NewSessionCommand                        │  Always                 │ │ │
│  │  │  CloseSessionCommand(session)             │  session != null        │ │ │
│  │  │  CloseActiveSessionCommand                │  HasActiveSession       │ │ │
│  │  │  ActivateSessionCommand(session)          │  session != null        │ │ │
│  │  │  TogglePanelCommand                       │  Always                 │ │ │
│  │  │  ShowPanelCommand                         │  Always                 │ │ │
│  │  │  HidePanelCommand                         │  Always                 │ │ │
│  │  │  ToggleMaximizeCommand                    │  Always                 │ │ │
│  │  │  ClearTerminalCommand                     │  HasActiveSession       │ │ │
│  │  │  NextTabCommand                           │  Always                 │ │ │
│  │  │  PreviousTabCommand                       │  Always                 │ │ │
│  │  └──────────────────────────────────────────┴─────────────────────────┘ │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Event Handler Flow                                 │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │  ITerminalService Events → ViewModel Handlers → UI Thread       │   │ │
│  │  │  ┌───────────────────────────────────────────────────────────┐  │   │ │
│  │  │  │  SessionCreated                                           │  │   │ │
│  │  │  │  └── OnSessionCreated                                     │  │   │ │
│  │  │  │      ├── Create TerminalSessionViewModel                  │  │   │ │
│  │  │  │      ├── Add to Sessions collection                       │  │   │ │
│  │  │  │      └── ActivateSession (auto-activate new sessions)     │  │   │ │
│  │  │  ├───────────────────────────────────────────────────────────┤  │   │ │
│  │  │  │  SessionClosed                                            │  │   │ │
│  │  │  │  └── OnSessionClosed                                      │  │   │ │
│  │  │  │      ├── Find session ViewModel by ID                     │  │   │ │
│  │  │  │      ├── Track if was active                              │  │   │ │
│  │  │  │      ├── Remove from Sessions collection                  │  │   │ │
│  │  │  │      └── Activate adjacent session if was active          │  │   │ │
│  │  │  ├───────────────────────────────────────────────────────────┤  │   │ │
│  │  │  │  SessionStateChanged                                      │  │   │ │
│  │  │  │  └── OnSessionStateChanged                                │  │   │ │
│  │  │  │      └── Find session and call UpdateFromSession()        │  │   │ │
│  │  │  ├───────────────────────────────────────────────────────────┤  │   │ │
│  │  │  │  TitleChanged                                             │  │   │ │
│  │  │  │  └── OnTitleChanged                                       │  │   │ │
│  │  │  │      └── Update session.Name                              │  │   │ │
│  │  │  └───────────────────────────────────────────────────────────┘  │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Shell Type Detection

The `TerminalSessionViewModel` includes shell type detection for displaying appropriate icons in tabs:

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Shell Type Detection                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Input: Shell executable path (e.g., "/bin/zsh", "C:\Windows\cmd.exe") │ │
│  │  Output: Normalized shell type string for icon/styling                  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Detection Logic                                                         │ │
│  │  ┌─────────────────────┬───────────────────────────────────────────────┐ │ │
│  │  │  Executable Name    │  Shell Type                                   │ │ │
│  │  ├─────────────────────┼───────────────────────────────────────────────┤ │ │
│  │  │  bash               │  "bash"                                       │ │ │
│  │  │  zsh                │  "zsh"                                        │ │ │
│  │  │  fish               │  "fish"                                       │ │ │
│  │  │  pwsh, powershell   │  "powershell"                                 │ │ │
│  │  │  cmd                │  "cmd"                                        │ │ │
│  │  │  nu                 │  "nushell"                                    │ │ │
│  │  │  (any other)        │  "terminal" (fallback)                        │ │ │
│  │  └─────────────────────┴───────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Implementation                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  1. Extract filename from path (Path.GetFileNameWithoutExtension)│  │ │
│  │  │  2. Convert to lowercase                                          │  │ │
│  │  │  3. Match against known shell names                               │  │ │
│  │  │  4. Return shell type string                                      │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Session Close Behavior

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Session Close Behavior                                 │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  When SessionClosed Event is Received                                    │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                                                                    │  │ │
│  │  │  1. Find session ViewModel by ID                                  │  │ │
│  │  │     └── sessions.FirstOrDefault(s => s.Id == e.Session.Id)        │  │ │
│  │  │                                                                    │  │ │
│  │  │  2. If session not found → exit early                             │  │ │
│  │  │                                                                    │  │ │
│  │  │  3. Track state before removal                                    │  │ │
│  │  │     ├── wasActive = session.IsActive                              │  │ │
│  │  │     └── index = Sessions.IndexOf(session)                         │  │ │
│  │  │                                                                    │  │ │
│  │  │  4. Remove from collection                                        │  │ │
│  │  │     └── Sessions.Remove(session)                                  │  │ │
│  │  │                                                                    │  │ │
│  │  │  5. Handle activation                                             │  │ │
│  │  │     ├── If wasActive AND Sessions.Count > 0:                     │  │ │
│  │  │     │   └── Activate session at min(index, Count - 1)             │  │ │
│  │  │     └── If Sessions.Count == 0:                                   │  │ │
│  │  │         └── ActiveSession = null                                  │  │ │
│  │  │                                                                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Adjacent Session Selection Example                                      │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                                                                    │  │ │
│  │  │  Before: [Tab 0] [Tab 1*] [Tab 2] [Tab 3]  (* = active)           │  │ │
│  │  │  Close Tab 1: newIndex = min(1, 3-1) = 1                          │  │ │
│  │  │  After:  [Tab 0] [Tab 2*] [Tab 3]                                 │  │ │
│  │  │                                                                    │  │ │
│  │  │  Before: [Tab 0] [Tab 1] [Tab 2] [Tab 3*]  (* = active)           │  │ │
│  │  │  Close Tab 3: newIndex = min(3, 3-1) = 2                          │  │ │
│  │  │  After:  [Tab 0] [Tab 1] [Tab 2*]                                 │  │ │
│  │  │                                                                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Tab Navigation

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Tab Navigation                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  NextTab() - Circular Navigation Forward                                 │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  [0] [1] [2*] [3] [4]                                             │  │ │
│  │  │          │                                                         │  │ │
│  │  │          ▼  NextTab()                                             │  │ │
│  │  │  [0] [1] [2] [3*] [4]                                             │  │ │
│  │  │                                                                    │  │ │
│  │  │  Formula: nextIndex = (currentIndex + 1) % Sessions.Count          │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Edge case: Wrap to beginning                                     │  │ │
│  │  │  [0] [1] [2] [3] [4*] → [0*] [1] [2] [3] [4]                      │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  PreviousTab() - Circular Navigation Backward                            │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  [0] [1] [2*] [3] [4]                                             │  │ │
│  │  │          │                                                         │  │ │
│  │  │          ▼  PreviousTab()                                         │  │ │
│  │  │  [0] [1*] [2] [3] [4]                                             │  │ │
│  │  │                                                                    │  │ │
│  │  │  Formula: prevIndex = currentIndex > 0                            │  │ │
│  │  │             ? currentIndex - 1                                    │  │ │
│  │  │             : Sessions.Count - 1                                  │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Edge case: Wrap to end                                           │  │ │
│  │  │  [0*] [1] [2] [3] [4] → [0] [1] [2] [3] [4*]                      │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Early Exit Conditions                                                   │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Both NextTab and PreviousTab early exit when:                    │  │ │
│  │  │  └── Sessions.Count <= 1 (no tab to switch to)                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Panel State Management

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Panel State Management                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Panel Visibility                                                        │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  IsVisible: bool                                                   │  │ │
│  │  │  ├── false → Panel is collapsed/hidden                            │  │ │
│  │  │  └── true → Panel is expanded and visible                         │  │ │
│  │  │                                                                    │  │ │
│  │  │  TogglePanel():                                                    │  │ │
│  │  │  └── IsVisible = !IsVisible                                        │  │ │
│  │  │                                                                    │  │ │
│  │  │  ShowPanel():                                                      │  │ │
│  │  │  ├── IsVisible = true                                              │  │ │
│  │  │  └── If Sessions.Count == 0: NewSessionAsync()                    │  │ │
│  │  │                                                                    │  │ │
│  │  │  HidePanel():                                                      │  │ │
│  │  │  ├── IsVisible = false                                             │  │ │
│  │  │  └── IsMaximized = false (reset maximize state)                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Panel Height                                                            │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  PanelHeight: double = 300 (default)                              │  │ │
│  │  │  ├── User-resizable via drag handle (in view layer)              │  │ │
│  │  │  └── Persisted for user preference                                │  │ │
│  │  │                                                                    │  │ │
│  │  │  Usage in View:                                                    │  │ │
│  │  │  └── Height="{Binding PanelHeight}" (when not maximized)          │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Maximize State                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  IsMaximized: bool                                                 │  │ │
│  │  │  ├── false → Panel uses PanelHeight                               │  │ │
│  │  │  └── true → Panel fills available space                           │  │ │
│  │  │                                                                    │  │ │
│  │  │  ToggleMaximize():                                                 │  │ │
│  │  │  └── IsMaximized = !IsMaximized                                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. TerminalSessionViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/TerminalSessionViewModel.cs`
**Type**: `partial class`
**Extends**: `ViewModelBase`
**Purpose**: ViewModel for a single terminal session (tab)

```csharp
namespace AIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using AIntern.Core.Models.Terminal;

/// <summary>
/// ViewModel for a single terminal session (tab).
/// Wraps a TerminalSession and provides observable properties for UI binding.
/// </summary>
/// <remarks>
/// Added in v0.5.2d.
/// </remarks>
public partial class TerminalSessionViewModel : ViewModelBase
{
    private readonly TerminalSession _session;

    // ═══════════════════════════════════════════════════════════════
    // Computed Properties (not observable - derived from model)
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the unique session identifier.
    /// </summary>
    public Guid Id => _session.Id;

    /// <summary>
    /// Gets the shell type for icon display (e.g., "bash", "zsh", "powershell").
    /// </summary>
    public string ShellType { get; }

    /// <summary>
    /// Gets whether the session has exited (normally or with error).
    /// </summary>
    public bool HasExited => State == TerminalSessionState.Exited ||
                             State == TerminalSessionState.Error;

    /// <summary>
    /// Gets the exit code if the session has ended, otherwise null.
    /// </summary>
    public int? ExitCode => _session.ExitCode;

    // ═══════════════════════════════════════════════════════════════
    // Observable Properties
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the display name for the tab.
    /// Updated when the session title changes.
    /// </summary>
    [ObservableProperty]
    private string _name;

    /// <summary>
    /// Gets or sets whether this session is the currently active/selected tab.
    /// </summary>
    [ObservableProperty]
    private bool _isActive;

    /// <summary>
    /// Gets or sets the current session state.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(HasExited))]
    private TerminalSessionState _state;

    /// <summary>
    /// Gets or sets the current working directory.
    /// </summary>
    [ObservableProperty]
    private string _workingDirectory;

    // ═══════════════════════════════════════════════════════════════
    // Constructor
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Creates a new TerminalSessionViewModel wrapping the specified session.
    /// </summary>
    /// <param name="session">The underlying terminal session.</param>
    public TerminalSessionViewModel(TerminalSession session)
    {
        _session = session ?? throw new ArgumentNullException(nameof(session));
        _name = session.Name;
        _state = session.State;
        _workingDirectory = session.WorkingDirectory;
        ShellType = GetShellType(session.ShellPath);
    }

    // ═══════════════════════════════════════════════════════════════
    // Methods
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Updates observable properties from the underlying session model.
    /// Called when session state or title changes.
    /// </summary>
    public void UpdateFromSession()
    {
        Name = _session.Title ?? _session.Name;
        State = _session.State;
        WorkingDirectory = _session.WorkingDirectory;
    }

    /// <summary>
    /// Determines the shell type from the shell executable path.
    /// </summary>
    /// <param name="shellPath">Full path to the shell executable.</param>
    /// <returns>A normalized shell type string for icon/styling.</returns>
    private static string GetShellType(string shellPath)
    {
        if (string.IsNullOrEmpty(shellPath))
            return "terminal";

        var fileName = Path.GetFileNameWithoutExtension(shellPath).ToLowerInvariant();
        return fileName switch
        {
            "bash" => "bash",
            "zsh" => "zsh",
            "fish" => "fish",
            "pwsh" or "powershell" => "powershell",
            "cmd" => "cmd",
            "nu" => "nushell",
            _ => "terminal"
        };
    }
}
```

---

### 2. TerminalPanelViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/TerminalPanelViewModel.cs`
**Type**: `partial class`
**Extends**: `ViewModelBase`
**Purpose**: ViewModel for the terminal panel with session management

```csharp
namespace AIntern.Desktop.ViewModels;

using System.Collections.ObjectModel;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;
using Microsoft.Extensions.Logging;

/// <summary>
/// ViewModel for the terminal panel.
/// Manages terminal sessions, tab selection, panel visibility, and settings.
/// </summary>
/// <remarks>
/// Added in v0.5.2d.
/// </remarks>
public partial class TerminalPanelViewModel : ViewModelBase
{
    private readonly ITerminalService _terminalService;
    private readonly IWorkspaceService? _workspaceService;
    private readonly ILogger<TerminalPanelViewModel>? _logger;

    // ═══════════════════════════════════════════════════════════════
    // Collections
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the collection of all terminal sessions.
    /// </summary>
    public ObservableCollection<TerminalSessionViewModel> Sessions { get; } = new();

    // ═══════════════════════════════════════════════════════════════
    // Observable Properties - Session State
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the currently active session.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(HasActiveSession))]
    [NotifyCanExecuteChangedFor(nameof(CloseActiveSessionCommand))]
    [NotifyCanExecuteChangedFor(nameof(ClearTerminalCommand))]
    private TerminalSessionViewModel? _activeSession;

    /// <summary>
    /// Gets whether there is an active session.
    /// </summary>
    public bool HasActiveSession => ActiveSession != null;

    // ═══════════════════════════════════════════════════════════════
    // Observable Properties - Panel State
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets whether the panel is visible.
    /// </summary>
    [ObservableProperty]
    private bool _isVisible;

    /// <summary>
    /// Gets or sets whether the panel is maximized.
    /// </summary>
    [ObservableProperty]
    private bool _isMaximized;

    /// <summary>
    /// Gets or sets the panel height when not maximized.
    /// </summary>
    [ObservableProperty]
    private double _panelHeight = 300;

    // ═══════════════════════════════════════════════════════════════
    // Observable Properties - Terminal Settings
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the terminal font family.
    /// </summary>
    [ObservableProperty]
    private string _fontFamily = "Cascadia Mono";

    /// <summary>
    /// Gets or sets the terminal font size.
    /// </summary>
    [ObservableProperty]
    private double _fontSize = 14;

    /// <summary>
    /// Gets or sets the current terminal theme.
    /// </summary>
    [ObservableProperty]
    private TerminalTheme _theme = TerminalTheme.Dark;

    // ═══════════════════════════════════════════════════════════════
    // Events
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Raised when the active session changes.
    /// </summary>
    public event EventHandler<TerminalSessionViewModel?>? ActiveSessionChanged;

    // ═══════════════════════════════════════════════════════════════
    // Constructor
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Creates a new TerminalPanelViewModel.
    /// </summary>
    /// <param name="terminalService">The terminal service for session management.</param>
    /// <param name="workspaceService">Optional workspace service for initial directory.</param>
    /// <param name="logger">Optional logger for diagnostics.</param>
    public TerminalPanelViewModel(
        ITerminalService terminalService,
        IWorkspaceService? workspaceService = null,
        ILogger<TerminalPanelViewModel>? logger = null)
    {
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _workspaceService = workspaceService;
        _logger = logger;

        // Subscribe to service events
        _terminalService.SessionCreated += OnSessionCreated;
        _terminalService.SessionClosed += OnSessionClosed;
        _terminalService.SessionStateChanged += OnSessionStateChanged;
        _terminalService.TitleChanged += OnTitleChanged;

        _logger?.LogDebug("TerminalPanelViewModel created");
    }

    // ═══════════════════════════════════════════════════════════════
    // Commands - Session Management
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Creates a new terminal session.
    /// </summary>
    [RelayCommand]
    private async Task NewSessionAsync()
    {
        try
        {
            IsBusy = true;
            ClearError();

            _logger?.LogInformation("Creating new terminal session");

            var options = new TerminalSessionOptions
            {
                WorkingDirectory = _workspaceService?.CurrentWorkspace?.RootPath,
                Size = new TerminalSize(80, 24)
            };

            var session = await _terminalService.CreateSessionAsync(options);
            _logger?.LogInformation("Created terminal session {SessionId}", session.Id);

            // Show panel if hidden
            IsVisible = true;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Failed to create terminal session");
            SetError($"Failed to create terminal: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    /// <summary>
    /// Closes a specific session.
    /// </summary>
    /// <param name="session">The session to close.</param>
    [RelayCommand]
    private async Task CloseSessionAsync(TerminalSessionViewModel? session)
    {
        if (session == null)
            return;

        try
        {
            _logger?.LogInformation("Closing terminal session {SessionId}", session.Id);
            await _terminalService.CloseSessionAsync(session.Id);
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Failed to close terminal session {SessionId}", session.Id);
            SetError($"Failed to close terminal: {ex.Message}");
        }
    }

    /// <summary>
    /// Closes the active session.
    /// </summary>
    [RelayCommand(CanExecute = nameof(HasActiveSession))]
    private async Task CloseActiveSessionAsync()
    {
        if (ActiveSession != null)
        {
            await CloseSessionAsync(ActiveSession);
        }
    }

    /// <summary>
    /// Activates a session (switches tabs).
    /// </summary>
    /// <param name="session">The session to activate.</param>
    [RelayCommand]
    private void ActivateSession(TerminalSessionViewModel? session)
    {
        if (session == null || session == ActiveSession)
            return;

        _logger?.LogDebug("Activating session {SessionId}", session.Id);

        // Deactivate current
        if (ActiveSession != null)
        {
            ActiveSession.IsActive = false;
        }

        // Activate new
        session.IsActive = true;
        ActiveSession = session;

        // Sync with service
        _terminalService.ActiveSession = _terminalService.Sessions
            .FirstOrDefault(s => s.Id == session.Id);

        ActiveSessionChanged?.Invoke(this, session);
    }

    // ═══════════════════════════════════════════════════════════════
    // Commands - Panel Visibility
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Toggles panel visibility.
    /// </summary>
    [RelayCommand]
    private void TogglePanel()
    {
        if (IsVisible)
        {
            HidePanel();
        }
        else
        {
            ShowPanel();
        }
    }

    /// <summary>
    /// Shows the terminal panel.
    /// Creates a new session if none exist.
    /// </summary>
    [RelayCommand]
    private void ShowPanel()
    {
        _logger?.LogDebug("Showing terminal panel");
        IsVisible = true;

        // Create a session if none exist
        if (Sessions.Count == 0)
        {
            _ = NewSessionAsync();
        }
    }

    /// <summary>
    /// Hides the terminal panel.
    /// </summary>
    [RelayCommand]
    private void HidePanel()
    {
        _logger?.LogDebug("Hiding terminal panel");
        IsVisible = false;
        IsMaximized = false;
    }

    /// <summary>
    /// Toggles maximized state.
    /// </summary>
    [RelayCommand]
    private void ToggleMaximize()
    {
        IsMaximized = !IsMaximized;
        _logger?.LogDebug("Terminal panel maximized: {IsMaximized}", IsMaximized);
    }

    // ═══════════════════════════════════════════════════════════════
    // Commands - Terminal Operations
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Clears the terminal screen.
    /// </summary>
    [RelayCommand(CanExecute = nameof(HasActiveSession))]
    private async Task ClearTerminalAsync()
    {
        if (ActiveSession == null)
            return;

        try
        {
            _logger?.LogDebug("Clearing terminal {SessionId}", ActiveSession.Id);
            await _terminalService.ExecuteCommandAsync(
                ActiveSession.Id,
                "clear");
        }
        catch (Exception ex)
        {
            // Ignore clear failures - not critical
            _logger?.LogWarning(ex, "Failed to clear terminal");
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // Commands - Tab Navigation
    // ═══════════════════════════════════════════════════════════════

    /// <summary>
    /// Navigates to the next tab (circular).
    /// </summary>
    [RelayCommand]
    private void NextTab()
    {
        if (Sessions.Count <= 1)
            return;

        var currentIndex = ActiveSession != null
            ? Sessions.IndexOf(ActiveSession)
            : -1;

        var nextIndex = (currentIndex + 1) % Sessions.Count;
        ActivateSession(Sessions[nextIndex]);
    }

    /// <summary>
    /// Navigates to the previous tab (circular).
    /// </summary>
    [RelayCommand]
    private void PreviousTab()
    {
        if (Sessions.Count <= 1)
            return;

        var currentIndex = ActiveSession != null
            ? Sessions.IndexOf(ActiveSession)
            : 0;

        var prevIndex = currentIndex > 0 ? currentIndex - 1 : Sessions.Count - 1;
        ActivateSession(Sessions[prevIndex]);
    }

    // ═══════════════════════════════════════════════════════════════
    // Event Handlers
    // ═══════════════════════════════════════════════════════════════

    private void OnSessionCreated(object? sender, TerminalSessionEventArgs e)
    {
        Avalonia.Threading.Dispatcher.UIThread.Post(() =>
        {
            _logger?.LogDebug("Session created event received: {SessionId}", e.Session.Id);

            var viewModel = new TerminalSessionViewModel(e.Session);
            Sessions.Add(viewModel);

            // Auto-activate new sessions
            ActivateSession(viewModel);
        });
    }

    private void OnSessionClosed(object? sender, TerminalSessionEventArgs e)
    {
        Avalonia.Threading.Dispatcher.UIThread.Post(() =>
        {
            _logger?.LogDebug("Session closed event received: {SessionId}", e.Session.Id);

            var session = Sessions.FirstOrDefault(s => s.Id == e.Session.Id);
            if (session == null)
                return;

            var wasActive = session.IsActive;
            var index = Sessions.IndexOf(session);

            Sessions.Remove(session);

            // Activate adjacent session if closed was active
            if (wasActive && Sessions.Count > 0)
            {
                var newIndex = Math.Min(index, Sessions.Count - 1);
                ActivateSession(Sessions[newIndex]);
            }
            else if (Sessions.Count == 0)
            {
                ActiveSession = null;
            }
        });
    }

    private void OnSessionStateChanged(object? sender, TerminalSessionEventArgs e)
    {
        Avalonia.Threading.Dispatcher.UIThread.Post(() =>
        {
            var session = Sessions.FirstOrDefault(s => s.Id == e.Session.Id);
            session?.UpdateFromSession();
        });
    }

    private void OnTitleChanged(object? sender, TerminalTitleEventArgs e)
    {
        Avalonia.Threading.Dispatcher.UIThread.Post(() =>
        {
            var session = Sessions.FirstOrDefault(s => s.Id == e.SessionId);
            if (session != null)
            {
                session.Name = e.Title;
                _logger?.LogDebug("Session {SessionId} title changed to: {Title}", e.SessionId, e.Title);
            }
        });
    }
}
```

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `TerminalSessionViewModel.cs` | `src/AIntern.Desktop/ViewModels/` | Session tab ViewModel |
| `TerminalPanelViewModel.cs` | `src/AIntern.Desktop/ViewModels/` | Panel ViewModel with commands |

### Files Modified

None - this version creates new files only.

---

## Unit Test Plan

### Test Categories

| Category | Test Count | Description |
|----------|------------|-------------|
| Shell Type Detection | 8 | Verify correct shell type strings |
| Session Lifecycle | 6 | Verify create/close/activate |
| Tab Navigation | 6 | Verify circular Next/Previous |
| Panel State | 5 | Verify visibility/maximize |
| Event Handling | 5 | Verify service event processing |

### Sample Test Cases

```csharp
public class TerminalSessionViewModelTests
{
    [Theory]
    [InlineData("/bin/bash", "bash")]
    [InlineData("/bin/zsh", "zsh")]
    [InlineData("C:\\Windows\\System32\\cmd.exe", "cmd")]
    [InlineData("/usr/bin/pwsh", "powershell")]
    [InlineData("/usr/bin/unknown", "terminal")]
    public void GetShellType_VariousPaths_ReturnsExpected(string path, string expected)
    {
        // Arrange
        var session = CreateMockSession(shellPath: path);

        // Act
        var vm = new TerminalSessionViewModel(session);

        // Assert
        Assert.Equal(expected, vm.ShellType);
    }

    [Fact]
    public void HasExited_WhenStateExited_ReturnsTrue()
    {
        var session = CreateMockSession();
        var vm = new TerminalSessionViewModel(session);

        vm.State = TerminalSessionState.Exited;

        Assert.True(vm.HasExited);
    }
}

public class TerminalPanelViewModelTests
{
    [Fact]
    public async Task NewSessionAsync_CreatesSessionAndActivates()
    {
        // Arrange
        var mockService = CreateMockTerminalService();
        var vm = new TerminalPanelViewModel(mockService);

        // Act
        await vm.NewSessionCommand.ExecuteAsync(null);

        // Assert
        Assert.Single(vm.Sessions);
        Assert.NotNull(vm.ActiveSession);
        Assert.True(vm.IsVisible);
    }

    [Fact]
    public void NextTab_CircularNavigation_WrapsToBeginning()
    {
        var vm = CreateViewModelWithSessions(3);
        vm.ActivateSession(vm.Sessions[2]); // Last tab

        vm.NextTab();

        Assert.Equal(vm.Sessions[0], vm.ActiveSession);
    }

    [Fact]
    public void PreviousTab_CircularNavigation_WrapsToEnd()
    {
        var vm = CreateViewModelWithSessions(3);
        vm.ActivateSession(vm.Sessions[0]); // First tab

        vm.PreviousTab();

        Assert.Equal(vm.Sessions[2], vm.ActiveSession);
    }
}
```

---

## Verification Steps

### 1. Build Verification

```bash
# Verify Desktop project builds
dotnet build src/AIntern.Desktop
```

### 2. Runtime Verification

After building, manually verify:
1. New terminal creates session and shows tab
2. Multiple tabs can be created
3. Clicking tabs switches active session
4. Close button removes session from collection
5. Closing active tab activates adjacent tab
6. Tab name updates when shell sets title
7. Panel toggle shows/hides panel
8. Maximize fills available space

---

## Integration Notes

### Usage in v0.5.2e (Terminal Panel)

The ViewModels will be bound to the TerminalPanel view:

```xml
<!-- TerminalPanel.axaml -->
<UserControl x:Name="TerminalPanel"
             DataContext="{Binding TerminalPanel}">

    <!-- Tab bar bound to Sessions -->
    <ItemsControl ItemsSource="{Binding Sessions}">
        <ItemsControl.ItemTemplate>
            <DataTemplate>
                <Button Command="{Binding ActivateSessionCommand}"
                        CommandParameter="{Binding}"
                        Classes.active="{Binding IsActive}">
                    <TextBlock Text="{Binding Name}" />
                </Button>
            </DataTemplate>
        </ItemsControl.ItemTemplate>
    </ItemsControl>

    <!-- Terminal content -->
    <local:TerminalControl DataContext="{Binding ActiveSession}" />
</UserControl>
```

### Threading Considerations

All service event handlers dispatch to UI thread:
```csharp
Avalonia.Threading.Dispatcher.UIThread.Post(() => { ... });
```

---

## Changelog Entry

```markdown
## v0.5.2d - ViewModels

### Added
- `TerminalSessionViewModel` for individual terminal session (tab) representation
  - Observable properties: Name, IsActive, State, WorkingDirectory
  - Computed properties: Id, ShellType, HasExited, ExitCode
  - Shell type detection for bash, zsh, fish, powershell, cmd, nushell
  - UpdateFromSession() for syncing with model changes

- `TerminalPanelViewModel` for terminal panel management
  - Sessions collection (ObservableCollection<TerminalSessionViewModel>)
  - Panel state: IsVisible, IsMaximized, PanelHeight
  - Terminal settings: FontFamily, FontSize, Theme
  - Commands:
    - NewSessionCommand - Create new terminal
    - CloseSessionCommand - Close specific session
    - CloseActiveSessionCommand - Close active session
    - ActivateSessionCommand - Switch tabs
    - TogglePanelCommand, ShowPanelCommand, HidePanelCommand
    - ToggleMaximizeCommand
    - ClearTerminalCommand - Clear screen
    - NextTabCommand, PreviousTabCommand - Circular navigation
  - Event handlers for SessionCreated, SessionClosed, SessionStateChanged, TitleChanged
  - ActiveSessionChanged event for view binding

- Adjacent session activation on close (maintains tab context)
- Auto-activate new sessions
- Circular tab navigation (Next/Previous wrap around)

### Files Created
- `src/AIntern.Desktop/ViewModels/TerminalSessionViewModel.cs`
- `src/AIntern.Desktop/ViewModels/TerminalPanelViewModel.cs`
```
