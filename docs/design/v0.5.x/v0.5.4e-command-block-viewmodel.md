# Design Specification: AIntern v0.5.4e "Command Block ViewModel"

## Overview

**Version**: v0.5.4e
**Parent**: v0.5.4 Command Integration
**Focus**: MVVM presentation layer for command blocks with user interactions

### Purpose

This sub-version creates the ViewModel layer for command block presentation:
1. Wrap `CommandBlock` model with reactive properties for UI binding
2. Implement Copy, Send to Terminal, and Execute commands
3. Handle dangerous command confirmation workflow
4. React to status changes from the execution service
5. Provide computed display properties (preview, badges, status text)
6. Support multi-line command expansion
7. Create factory for ViewModel instantiation with DI

### Dependencies

**From v0.5.4a (Command Block Models)**:
- `CommandBlock` - Underlying data model
- `CommandBlockStatus` - Status enumeration

**From v0.5.4c (Command Execution)**:
- `ICommandExecutionService` - Execution operations
- `CommandStatusChangedEventArgs` - Status change events

**From v0.5.1 (Terminal Foundation)**:
- `ITerminalService` - Session availability check

**From CommunityToolkit.Mvvm**:
- `ObservableProperty`, `RelayCommand` - MVVM infrastructure

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                 v0.5.4e Command Block ViewModel Architecture                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     ViewModel Layer                                      │ │
│  │  src/AIntern.Desktop/ViewModels/                                        │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  CommandBlockViewModel : ViewModelBase                                   │ │
│  │  ├── Dependencies:                                                      │ │
│  │  │   ├── ICommandExecutionService                                       │ │
│  │  │   └── ITerminalService                                               │ │
│  │  │                                                                       │ │
│  │  ├── Observable Properties:                                             │ │
│  │  │   ├── Command: CommandBlock                                          │ │
│  │  │   ├── Status: CommandBlockStatus                                     │ │
│  │  │   ├── IsExecuting: bool                                              │ │
│  │  │   ├── StatusMessage: string?                                         │ │
│  │  │   ├── ShowDangerWarning: bool                                        │ │
│  │  │   ├── DangerConfirmed: bool                                          │ │
│  │  │   └── IsExpanded: bool                                               │ │
│  │  │                                                                       │ │
│  │  ├── Computed Properties (for UI binding):                              │ │
│  │  │   ├── CommandText: string                                            │ │
│  │  │   ├── CommandPreview: string (first line, truncated)                │ │
│  │  │   ├── Description: string?                                           │ │
│  │  │   ├── LanguageBadge: string? (uppercase)                            │ │
│  │  │   ├── IsMultiLine: bool                                              │ │
│  │  │   ├── LineCount: int                                                 │ │
│  │  │   ├── IsDangerous: bool                                              │ │
│  │  │   ├── DangerWarning: string?                                         │ │
│  │  │   ├── StatusText: string                                             │ │
│  │  │   ├── ShowStatus: bool                                               │ │
│  │  │   ├── StatusClass: string (for styling)                             │ │
│  │  │   ├── HasActiveTerminal: bool                                        │ │
│  │  │   └── CanExecute: bool                                               │ │
│  │  │                                                                       │ │
│  │  ├── Commands (RelayCommand):                                           │ │
│  │  │   ├── CopyAsync()                                                    │ │
│  │  │   ├── SendToTerminalAsync()                                          │ │
│  │  │   ├── ExecuteAsync()                                                 │ │
│  │  │   ├── ConfirmDanger()                                                │ │
│  │  │   ├── CancelDanger()                                                 │ │
│  │  │   └── ToggleExpanded()                                               │ │
│  │  │                                                                       │ │
│  │  └── Event Handlers:                                                    │ │
│  │      ├── OnStatusChanged() - from ICommandExecutionService              │ │
│  │      └── OnSessionStateChanged() - from ITerminalService                │ │
│  │                                                                          │ │
│  │  CommandBlockViewModelFactory                                            │ │
│  │  ├── Create(CommandBlock) → CommandBlockViewModel                       │ │
│  │  └── CreateRange(IEnumerable<CommandBlock>) → IEnumerable<ViewModel>   │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## User Interaction Flows

### Copy Command Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           Copy Command Flow                                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User clicks "Copy" button                                                   │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  CopyCommand.Execute()                                                  │ │
│  │  └── await _executionService.CopyToClipboardAsync(Command)              │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  StatusMessage = "Copied to clipboard"                                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  await Task.Delay(2000)                                                 │ │
│  │  StatusMessage = null  // Clear after 2 seconds                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Status badge shows "Copied" (via StatusChanged event)                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Dangerous Command Confirmation Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    Dangerous Command Confirmation Flow                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User clicks "Execute" on dangerous command                                  │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  Check: IsDangerous && !DangerConfirmed                                 │ │
│  └──────────────────────┬─────────────────────────────────────────────────┘ │
│                         │                                                    │
│            ┌────────────┴────────────┐                                      │
│            │                         │                                       │
│          TRUE                      FALSE                                     │
│            │                         │                                       │
│            ▼                         ▼                                       │
│  ┌────────────────────┐    ┌────────────────────────────────────────────┐   │
│  │ ShowDangerWarning  │    │ Proceed with ExecuteAsync()               │   │
│  │      = true        │    │ (normal execution flow)                   │   │
│  └─────────┬──────────┘    └────────────────────────────────────────────┘   │
│            │                                                                 │
│            ▼                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  UI shows danger warning overlay with:                                  │ │
│  │  ├── Warning icon + DangerWarning text                                 │ │
│  │  ├── "I understand, proceed" button → ConfirmDangerCommand             │ │
│  │  └── "Cancel" button → CancelDangerCommand                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                    │                         │                               │
│                    ▼                         ▼                               │
│  ┌────────────────────────────┐  ┌────────────────────────────────────────┐ │
│  │  ConfirmDanger():          │  │  CancelDanger():                       │ │
│  │  DangerConfirmed = true    │  │  ShowDangerWarning = false            │ │
│  │  ShowDangerWarning = false │  │  (no execution)                       │ │
│  │  → Retry original command  │  └────────────────────────────────────────┘ │
│  └────────────────────────────┘                                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Execute Command Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Execute Command Flow                                 │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ExecuteAsync() called (after danger confirmation if needed)                 │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  IsExecuting = true                                                     │ │
│  │  UI: Show spinner, disable buttons                                      │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  try:                                                                   │ │
│  │    result = await _executionService.ExecuteAsync(Command,               │ │
│  │                                      captureOutput: true)               │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  During execution:                                                      │ │
│  │  ├── ICommandExecutionService.StatusChanged event fires                │ │
│  │  │     → OnStatusChanged() updates Status property                     │ │
│  │  └── UI: Status shows "Running...", spinner active                     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  On completion:                                                         │ │
│  │  ├── Status → Executed/Failed/Cancelled                                │ │
│  │  ├── StatusMessage = "Executed successfully" / "Execution failed"     │ │
│  │  └── result.OutputCapture available for AI context                    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                  │
│           ▼                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  finally:                                                               │ │
│  │    IsExecuting = false                                                  │ │
│  │    UI: Hide spinner, re-enable buttons                                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Property Bindings

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      ViewModel to View Property Bindings                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Display Properties                                                   │   │
│  │  ────────────────────────────────────────────────────────────────────│   │
│  │  Property         │ UI Element              │ Purpose                 │   │
│  │  ─────────────────┼─────────────────────────┼────────────────────────│   │
│  │  CommandText      │ CodeBlock.Text          │ Full command content   │   │
│  │  CommandPreview   │ Collapsed header        │ First line (60 chars)  │   │
│  │  Description      │ Header text             │ Context description    │   │
│  │  LanguageBadge    │ Language tag            │ "BASH", "POWERSHELL"   │   │
│  │  IsMultiLine      │ Expand button visible   │ Show expand control    │   │
│  │  LineCount        │ "+N lines" badge        │ Additional line count  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Status Properties                                                    │   │
│  │  ────────────────────────────────────────────────────────────────────│   │
│  │  Property         │ Binding                 │ Values                  │   │
│  │  ─────────────────┼─────────────────────────┼────────────────────────│   │
│  │  Status           │ Internal state          │ Pending → Executed     │   │
│  │  StatusText       │ Status badge text       │ "Copied", "Running..." │   │
│  │  ShowStatus       │ Badge visibility        │ true if != Pending     │   │
│  │  StatusClass      │ Badge style class       │ "success", "error"...  │   │
│  │  IsExecuting      │ Spinner visibility      │ true during execution  │   │
│  │  StatusMessage    │ Toast/tooltip           │ Temporary feedback     │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Danger Properties                                                    │   │
│  │  ────────────────────────────────────────────────────────────────────│   │
│  │  Property         │ Binding                 │ Purpose                 │   │
│  │  ─────────────────┼─────────────────────────┼────────────────────────│   │
│  │  IsDangerous      │ Border style class      │ Red border if true     │   │
│  │  DangerWarning    │ Warning popup text      │ Specific warning msg   │   │
│  │  ShowDangerWarning│ Popup visibility        │ Confirmation dialog    │   │
│  │  DangerConfirmed  │ Internal flag           │ User acknowledged      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Command Bindings                                                     │   │
│  │  ────────────────────────────────────────────────────────────────────│   │
│  │  Command             │ Button            │ Can Execute               │   │
│  │  ────────────────────┼───────────────────┼──────────────────────────│   │
│  │  CopyCommand         │ Copy button       │ Always                    │   │
│  │  SendToTerminalCmd   │ Send button       │ HasActiveTerminal         │   │
│  │  ExecuteCommand      │ Run button        │ !IsExecuting              │   │
│  │  ConfirmDangerCmd    │ "Proceed" button  │ ShowDangerWarning         │   │
│  │  CancelDangerCmd     │ "Cancel" button   │ ShowDangerWarning         │   │
│  │  ToggleExpandedCmd   │ Expand chevron    │ IsMultiLine               │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. CommandBlockViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/CommandBlockViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// ViewModel for an individual command block in chat messages.
/// Handles user interactions and status display.
/// </summary>
public partial class CommandBlockViewModel : ViewModelBase
{
    private readonly ICommandExecutionService _executionService;
    private readonly ITerminalService _terminalService;

    // === Observable Properties ===

    [ObservableProperty]
    private CommandBlock _command = null!;

    [ObservableProperty]
    private CommandBlockStatus _status = CommandBlockStatus.Pending;

    [ObservableProperty]
    private bool _isExecuting;

    [ObservableProperty]
    private string? _statusMessage;

    [ObservableProperty]
    private bool _showDangerWarning;

    [ObservableProperty]
    private bool _dangerConfirmed;

    [ObservableProperty]
    private bool _isExpanded;

    // === Computed Display Properties ===

    /// <summary>Full command text for display.</summary>
    public string CommandText => Command.Command;

    /// <summary>Short preview (first line, max 60 chars).</summary>
    public string CommandPreview
    {
        get
        {
            var firstLine = Command.Command.Split('\n').FirstOrDefault() ?? string.Empty;
            return firstLine.Length > 60 ? firstLine[..57] + "..." : firstLine;
        }
    }

    /// <summary>Description extracted from context.</summary>
    public string? Description => Command.Description;

    /// <summary>Language badge text (uppercase).</summary>
    public string? LanguageBadge => Command.Language?.ToUpperInvariant();

    /// <summary>Whether command spans multiple lines.</summary>
    public bool IsMultiLine => Command.IsMultiLine;

    /// <summary>Number of lines in the command.</summary>
    public int LineCount => Command.LineCount;

    /// <summary>Additional lines text for collapsed view.</summary>
    public string AdditionalLinesText => 
        LineCount > 1 ? $"+{LineCount - 1} more lines" : string.Empty;

    /// <summary>Whether command is potentially dangerous.</summary>
    public bool IsDangerous => Command.IsPotentiallyDangerous;

    /// <summary>Danger warning message.</summary>
    public string? DangerWarning => Command.DangerWarning;

    /// <summary>Confidence score for display (percentage).</summary>
    public string ConfidenceText => $"{(int)(Command.ConfidenceScore * 100)}%";

    /// <summary>Whether to show confidence indicator.</summary>
    public bool ShowConfidence => Command.ConfidenceScore < 0.80f;

    // === Status Display Properties ===

    /// <summary>Status text for badge display.</summary>
    public string StatusText => Status switch
    {
        CommandBlockStatus.Pending => "",
        CommandBlockStatus.Copied => "Copied",
        CommandBlockStatus.SentToTerminal => "Sent",
        CommandBlockStatus.Executing => "Running...",
        CommandBlockStatus.Executed => "Executed",
        CommandBlockStatus.Failed => "Failed",
        CommandBlockStatus.Cancelled => "Cancelled",
        _ => ""
    };

    /// <summary>Whether to show the status badge.</summary>
    public bool ShowStatus => Status != CommandBlockStatus.Pending;

    /// <summary>CSS-like class name for status styling.</summary>
    public string StatusClass => Status switch
    {
        CommandBlockStatus.Executed => "success",
        CommandBlockStatus.Failed => "error",
        CommandBlockStatus.Cancelled => "warning",
        CommandBlockStatus.Executing => "running",
        CommandBlockStatus.Copied => "info",
        CommandBlockStatus.SentToTerminal => "info",
        _ => ""
    };

    /// <summary>Icon name for status.</summary>
    public string StatusIcon => Status.ToIconName();

    // === Terminal State ===

    /// <summary>Whether there's an active terminal session.</summary>
    public bool HasActiveTerminal => _terminalService.ActiveSession != null;

    /// <summary>Whether the command can be executed right now.</summary>
    public bool CanExecute => !IsExecuting && !Status.IsTerminal();

    // === Constructor ===

    public CommandBlockViewModel(
        ICommandExecutionService executionService,
        ITerminalService terminalService)
    {
        _executionService = executionService;
        _terminalService = terminalService;

        // Subscribe to status changes
        _executionService.StatusChanged += OnStatusChanged;
        _terminalService.SessionStateChanged += OnSessionStateChanged;
    }

    // === Event Handlers ===

    private void OnStatusChanged(object? sender, CommandStatusChangedEventArgs e)
    {
        if (e.CommandId == Command.Id)
        {
            Status = e.NewStatus;
            IsExecuting = e.NewStatus == CommandBlockStatus.Executing;
        }
    }

    private void OnSessionStateChanged(object? sender, EventArgs e)
    {
        OnPropertyChanged(nameof(HasActiveTerminal));
    }

    // === Commands ===

    [RelayCommand]
    private async Task CopyAsync()
    {
        try
        {
            await _executionService.CopyToClipboardAsync(Command);
            StatusMessage = "Copied to clipboard";
            await ClearStatusMessageAfterDelayAsync();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Copy failed: {ex.Message}";
        }
    }

    [RelayCommand(CanExecute = nameof(HasActiveTerminal))]
    private async Task SendToTerminalAsync()
    {
        // Check for dangerous command confirmation
        if (IsDangerous && !DangerConfirmed)
        {
            ShowDangerWarning = true;
            return;
        }

        try
        {
            await _executionService.SendToTerminalAsync(Command);
            StatusMessage = "Sent to terminal";
            await ClearStatusMessageAfterDelayAsync();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Send failed: {ex.Message}";
        }
    }

    [RelayCommand(CanExecute = nameof(CanExecute))]
    private async Task ExecuteAsync()
    {
        // Check for dangerous command confirmation
        if (IsDangerous && !DangerConfirmed)
        {
            ShowDangerWarning = true;
            return;
        }

        try
        {
            IsExecuting = true;
            var result = await _executionService.ExecuteAsync(
                Command, 
                captureOutput: true);

            StatusMessage = result.Status == CommandBlockStatus.Executed
                ? "Executed successfully"
                : $"Execution {result.Status.ToString().ToLowerInvariant()}";

            await ClearStatusMessageAfterDelayAsync();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Execution failed: {ex.Message}";
        }
        finally
        {
            IsExecuting = false;
        }
    }

    [RelayCommand]
    private void ConfirmDanger()
    {
        DangerConfirmed = true;
        ShowDangerWarning = false;
        
        // Re-trigger the original action that was blocked
        // The user will need to click the button again after confirming
    }

    [RelayCommand]
    private void CancelDanger()
    {
        ShowDangerWarning = false;
    }

    [RelayCommand]
    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }

    // === Helper Methods ===

    private async Task ClearStatusMessageAfterDelayAsync()
    {
        await Task.Delay(2000);
        StatusMessage = null;
    }

    // === Property Change Handlers ===

    partial void OnCommandChanged(CommandBlock value)
    {
        Status = value.Status;
        
        // Notify all computed properties
        OnPropertyChanged(nameof(CommandText));
        OnPropertyChanged(nameof(CommandPreview));
        OnPropertyChanged(nameof(Description));
        OnPropertyChanged(nameof(LanguageBadge));
        OnPropertyChanged(nameof(IsMultiLine));
        OnPropertyChanged(nameof(LineCount));
        OnPropertyChanged(nameof(AdditionalLinesText));
        OnPropertyChanged(nameof(IsDangerous));
        OnPropertyChanged(nameof(DangerWarning));
        OnPropertyChanged(nameof(ConfidenceText));
        OnPropertyChanged(nameof(ShowConfidence));
    }

    partial void OnStatusChanged(CommandBlockStatus value)
    {
        OnPropertyChanged(nameof(StatusText));
        OnPropertyChanged(nameof(ShowStatus));
        OnPropertyChanged(nameof(StatusClass));
        OnPropertyChanged(nameof(StatusIcon));
        OnPropertyChanged(nameof(CanExecute));
        
        // Notify command can-execute
        ExecuteCommand.NotifyCanExecuteChanged();
    }

    partial void OnIsExecutingChanged(bool value)
    {
        OnPropertyChanged(nameof(CanExecute));
        ExecuteCommand.NotifyCanExecuteChanged();
    }

    // === Cleanup ===

    public void Dispose()
    {
        _executionService.StatusChanged -= OnStatusChanged;
        _terminalService.SessionStateChanged -= OnSessionStateChanged;
    }
}
```

### 2. CommandBlockViewModelFactory.cs

**Location**: `src/AIntern.Desktop/ViewModels/CommandBlockViewModelFactory.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// Factory for creating CommandBlockViewModel instances with proper DI.
/// </summary>
public sealed class CommandBlockViewModelFactory
{
    private readonly ICommandExecutionService _executionService;
    private readonly ITerminalService _terminalService;

    public CommandBlockViewModelFactory(
        ICommandExecutionService executionService,
        ITerminalService terminalService)
    {
        _executionService = executionService;
        _terminalService = terminalService;
    }

    /// <summary>
    /// Create a ViewModel for a single command block.
    /// </summary>
    /// <param name="command">The command block to wrap.</param>
    /// <returns>Configured ViewModel instance.</returns>
    public CommandBlockViewModel Create(CommandBlock command)
    {
        ArgumentNullException.ThrowIfNull(command);
        
        return new CommandBlockViewModel(_executionService, _terminalService)
        {
            Command = command
        };
    }

    /// <summary>
    /// Create ViewModels for multiple command blocks.
    /// </summary>
    /// <param name="commands">Command blocks to wrap.</param>
    /// <returns>Sequence of ViewModels in order.</returns>
    public IEnumerable<CommandBlockViewModel> CreateRange(IEnumerable<CommandBlock> commands)
    {
        ArgumentNullException.ThrowIfNull(commands);
        return commands.Select(Create);
    }

    /// <summary>
    /// Create ViewModels from an extraction result.
    /// </summary>
    /// <param name="result">Extraction result containing commands.</param>
    /// <returns>Sequence of ViewModels for all extracted commands.</returns>
    public IEnumerable<CommandBlockViewModel> CreateFromResult(CommandExtractionResult result)
    {
        ArgumentNullException.ThrowIfNull(result);
        return CreateRange(result.Commands);
    }
}
```

---

## File Summary

| File | Location | Purpose |
|------|----------|---------|
| `CommandBlockViewModel.cs` | `src/AIntern.Desktop/ViewModels/` | MVVM ViewModel for command blocks |
| `CommandBlockViewModelFactory.cs` | `src/AIntern.Desktop/ViewModels/` | Factory for ViewModel creation |

### Files to Modify

| File | Changes |
|------|---------|
| `src/AIntern.Desktop/DependencyInjection.cs` | Register CommandBlockViewModelFactory as singleton |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `CommandText_ReturnsFullCommand` | Returns Command.Command |
| `CommandPreview_TruncatesLongLines` | 60+ chars truncated |
| `CommandPreview_ReturnsFirstLine` | Multi-line shows first |
| `LanguageBadge_ReturnsUppercase` | "bash" → "BASH" |
| `StatusText_MapsCorrectly` | Each status maps to text |
| `ShowStatus_FalseWhenPending` | No badge for pending |
| `StatusClass_ReturnsCorrectClass` | Executed → "success" |
| `IsDangerous_DelegatestoModel` | Reads from CommandBlock |
| `HasActiveTerminal_QueriesService` | Checks terminal service |
| `CanExecute_FalseWhenExecuting` | Disabled during run |
| `CanExecute_FalseWhenTerminal` | Disabled after completion |
| `CopyAsync_CallsExecutionService` | Clipboard service called |
| `CopyAsync_SetsStatusMessage` | Shows "Copied" message |
| `CopyAsync_ClearsMessageAfterDelay` | Message clears in 2s |
| `SendToTerminal_ShowsWarningIfDangerous` | Danger flow triggered |
| `SendToTerminal_ProceedsIfConfirmed` | Executes after confirm |
| `ExecuteAsync_SetsIsExecuting` | Flag set during run |
| `ExecuteAsync_CallsWithCaptureOutput` | Capture enabled |
| `ExecuteAsync_UnsetesIsExecutingOnComplete` | Flag cleared after |
| `ConfirmDanger_SetsDangerConfirmed` | Flag set to true |
| `ConfirmDanger_HidesWarning` | ShowDangerWarning false |
| `CancelDanger_HidesWarning` | ShowDangerWarning false |
| `CancelDanger_KeepsDangerUnconfirmed` | DangerConfirmed still false |
| `ToggleExpanded_TogglesState` | IsExpanded flips |
| `OnStatusChanged_UpdatesFromEvent` | Reacts to service event |
| `OnCommandChanged_NotifiesComputed` | Properties refresh |
| `Factory_Create_SetsCommand` | Command property set |
| `Factory_CreateRange_CreatesAll` | Multiple ViewModels |

**Total Tests**: 28

---

## Verification

```bash
# Verify compilation
dotnet build src/AIntern.Desktop

# Run unit tests
dotnet test --filter "CommandBlockViewModel"

# Verify DI registration
grep -n "CommandBlockViewModelFactory" src/AIntern.Desktop/DependencyInjection.cs
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Copy command copies text and updates status |
| AC-2 | Send to terminal works with active session |
| AC-3 | Send to terminal disabled without active session |
| AC-4 | Execute runs command and sets IsExecuting |
| AC-5 | Execute captures output |
| AC-6 | Dangerous commands show warning before execution |
| AC-7 | Danger confirmation allows execution to proceed |
| AC-8 | Danger cancellation prevents execution |
| AC-9 | Status updates from service events reflect in UI |
| AC-10 | Multi-line commands can be expanded/collapsed |
| AC-11 | Factory creates ViewModels with proper DI |
| AC-12 | Status messages clear after 2 seconds |

---

## Changelog Entry

```markdown
## v0.5.4e - Command Block ViewModel

### Added
- `CommandBlockViewModel` with:
  - Observable properties: Command, Status, IsExecuting, StatusMessage,
    ShowDangerWarning, DangerConfirmed, IsExpanded
  - Computed properties: CommandText, CommandPreview, Description,
    LanguageBadge, IsMultiLine, LineCount, IsDangerous, DangerWarning,
    StatusText, ShowStatus, StatusClass, HasActiveTerminal, CanExecute
  - Commands: CopyAsync, SendToTerminalAsync, ExecuteAsync,
    ConfirmDanger, CancelDanger, ToggleExpanded
  - Event subscriptions: StatusChanged, SessionStateChanged
  - Dangerous command confirmation workflow
  - Auto-clearing status messages (2 second delay)

- `CommandBlockViewModelFactory` with:
  - Create(CommandBlock) method
  - CreateRange(IEnumerable<CommandBlock>) method
  - CreateFromResult(CommandExtractionResult) method
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.4e | 0.5 day |
