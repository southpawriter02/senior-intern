# Design Specification: AIntern v0.5.5g "Shell Profile Editor"

## Overview

**Version**: v0.5.5g
**Parent**: v0.5.5 Polish & Integration
**Focus**: Shell profile editor dialog for creating and editing shell configurations

### Purpose

This sub-version creates the shell profile editor dialog:
1. Create `ShellProfileEditorViewModel` with profile properties
2. Create `ShellProfileEditor` window with form fields
3. Support shell path validation and auto-detection
4. Implement file/folder browser dialogs
5. Parse environment variables in KEY=value format
6. Auto-detect shell type and version
7. Support platform-specific options (ConPTY)

### Dependencies

**From v0.5.3c (Shell Profile Models)**:
- `ShellProfile` model

**From v0.5.3a (Shell Detection)**:
- `IShellDetectionService` for path validation and type detection

**From v0.5.5f (Terminal Settings Panel)**:
- Integration with shell profiles list

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.5.5g Shell Profile Editor Architecture                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     ViewModel Layer                                      │ │
│  │  src/AIntern.Desktop/ViewModels/                                        │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ShellProfileEditorViewModel : ViewModelBase                             │ │
│  │  ├── Dependencies:                                                      │ │
│  │  │   └── IShellDetectionService                                         │ │
│  │  │                                                                       │ │
│  │  ├── State:                                                             │ │
│  │  │   ├── _originalProfile: ShellProfile (backup)                        │ │
│  │  │   └── _isNewProfile: bool                                            │ │
│  │  │                                                                       │ │
│  │  ├── Observable Properties:                                             │ │
│  │  │   ├── ProfileName: string                                            │ │
│  │  │   ├── ShellPath: string                                              │ │
│  │  │   ├── Arguments: string                                              │ │
│  │  │   ├── WorkingDirectory: string                                       │ │
│  │  │   ├── EnvironmentVariables: string (multiline)                       │ │
│  │  │   ├── ShellType: ShellType (enum)                                    │ │
│  │  │   ├── Icon: string                                                   │ │
│  │  │   ├── IsLoginShell: bool                                             │ │
│  │  │   ├── UseConPty: bool (Windows only)                                 │ │
│  │  │   ├── PathError: string?                                             │ │
│  │  │   ├── NameError: string?                                             │ │
│  │  │   ├── IsValid: bool                                                  │ │
│  │  │   └── DetectedVersion: string?                                       │ │
│  │  │                                                                       │ │
│  │  ├── Commands:                                                          │ │
│  │  │   ├── BrowseShellPathCommand → OpenFileDialog                        │ │
│  │  │   ├── BrowseWorkingDirectoryCommand → OpenFolderDialog               │ │
│  │  │   ├── DetectFromPathCommand                                          │ │
│  │  │   ├── SaveCommand → raises SaveRequested                             │ │
│  │  │   └── CancelCommand → raises CancelRequested                         │ │
│  │  │                                                                       │ │
│  │  ├── Methods:                                                           │ │
│  │  │   ├── Validate()                                                     │ │
│  │  │   ├── DetectShellType()                                              │ │
│  │  │   ├── DetectVersion()                                                │ │
│  │  │   └── GetProfile() → ShellProfile                                    │ │
│  │  │                                                                       │ │
│  │  └── Events:                                                            │ │
│  │      ├── SaveRequested: EventHandler<ShellProfile>                      │ │
│  │      └── CancelRequested: EventHandler                                  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        View Layer                                        │ │
│  │  src/AIntern.Desktop/Views/                                             │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ShellProfileEditor.axaml (Window)                                       │ │
│  │  ├── Title: "New Shell Profile" or "Edit Shell Profile"                │ │
│  │  ├── Fixed size: 500 x 600                                              │ │
│  │  ├── Modal dialog                                                       │ │
│  │  │                                                                       │ │
│  │  ├── Form Fields:                                                       │ │
│  │  │   ├── Profile Name (TextBox + error)                                 │ │
│  │  │   ├── Shell Path (TextBox + Browse button + version)                 │ │
│  │  │   ├── Shell Type (ComboBox, auto-detected)                           │ │
│  │  │   ├── Arguments (TextBox + hint)                                     │ │
│  │  │   ├── Working Directory (TextBox + Browse button)                    │ │
│  │  │   ├── Environment Variables (multiline TextBox + hint)               │ │
│  │  │   └── Options (CheckBox: Login shell, ConPTY)                        │ │
│  │  │                                                                       │ │
│  │  └── Dialog Buttons:                                                    │ │
│  │      ├── Cancel (left)                                                  │ │
│  │      └── Save (right, primary, enabled when IsValid)                    │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Editor Dialog Layout

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      Shell Profile Editor Dialog                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  New Shell Profile                                              [×]   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                         │ │
│  │  Profile Name                                                           │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │ │
│  │  │ My Custom Shell                                                   │  │ │
│  │  └──────────────────────────────────────────────────────────────────┘  │ │
│  │  ⚠ Profile name is required                                            │ │
│  │                                                                         │ │
│  │  Shell Path                                                             │ │
│  │  ┌────────────────────────────────────────────────────────┐ [Browse..] │ │
│  │  │ /usr/local/bin/fish                                     │           │ │
│  │  └────────────────────────────────────────────────────────┘           │ │
│  │  Version: fish 3.6.0                                                   │ │
│  │                                                                         │ │
│  │  Shell Type                                                             │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │ │
│  │  │ ▼ Fish                                                            │  │ │
│  │  └──────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                         │ │
│  │  Arguments (optional)                                                   │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │ │
│  │  │ --login --private                                                 │  │ │
│  │  └──────────────────────────────────────────────────────────────────┘  │ │
│  │  Command line arguments passed to the shell                            │ │
│  │                                                                         │ │
│  │  Working Directory (optional)                                           │ │
│  │  ┌────────────────────────────────────────────────────────┐ [Browse..] │ │
│  │  │ ~/Projects                                              │           │ │
│  │  └────────────────────────────────────────────────────────┘           │ │
│  │                                                                         │ │
│  │  Environment Variables (optional)                                       │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │ │
│  │  │ EDITOR=vim                                                        │  │ │
│  │  │ PAGER=less                                                        │  │ │
│  │  │ MYVAR=custom_value                                                │  │ │
│  │  └──────────────────────────────────────────────────────────────────┘  │ │
│  │  One variable per line in KEY=value format                             │ │
│  │                                                                         │ │
│  │  Options                                                                │ │
│  │  ☑ Run as login shell                                                  │ │
│  │  ☐ Use ConPTY (Windows)                                                │ │
│  │                                                                         │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  [Cancel]                                                     [Save]   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. ShellProfileEditorViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/ShellProfileEditorViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Microsoft.Extensions.Logging;
using Avalonia.Controls;
using Avalonia.Platform.Storage;
using AIntern.Core.Interfaces;
using AIntern.Core.Models.Terminal;

/// <summary>
/// ViewModel for the shell profile editor dialog.
/// Supports creating new profiles and editing existing ones.
/// </summary>
public partial class ShellProfileEditorViewModel : ViewModelBase
{
    private readonly ILogger<ShellProfileEditorViewModel> _logger;
    private readonly IShellDetectionService _shellDetectionService;
    private readonly ShellProfile _originalProfile;
    private readonly bool _isNewProfile;

    // ========== Observable Properties ==========

    [ObservableProperty]
    private string _profileName = string.Empty;

    [ObservableProperty]
    private string _shellPath = string.Empty;

    [ObservableProperty]
    private string _arguments = string.Empty;

    [ObservableProperty]
    private string _workingDirectory = string.Empty;

    [ObservableProperty]
    private string _environmentVariables = string.Empty;

    [ObservableProperty]
    private ShellType _shellType = ShellType.Unknown;

    [ObservableProperty]
    private string _icon = string.Empty;

    [ObservableProperty]
    private bool _isLoginShell;

    [ObservableProperty]
    private bool _useConPty = true;

    [ObservableProperty]
    private string? _pathError;

    [ObservableProperty]
    private string? _nameError;

    [ObservableProperty]
    private bool _isValid;

    [ObservableProperty]
    private string? _detectedVersion;

    [ObservableProperty]
    private bool _isDetectingVersion;

    // ========== Static Properties ==========

    public IReadOnlyList<ShellType> ShellTypes { get; } = Enum.GetValues<ShellType>();

    public string Title => _isNewProfile ? "New Shell Profile" : "Edit Shell Profile";

    public bool IsWindows => OperatingSystem.IsWindows();

    // ========== Constructor ==========

    public ShellProfileEditorViewModel(
        ILogger<ShellProfileEditorViewModel> logger,
        IShellDetectionService shellDetectionService,
        ShellProfile? profile = null)
    {
        _logger = logger;
        _shellDetectionService = shellDetectionService;
        _isNewProfile = profile == null;
        _originalProfile = profile ?? new ShellProfile 
        { 
            Id = Guid.NewGuid().ToString(),
            Name = "New Profile"
        };

        LoadFromProfile(_originalProfile);
        Validate();
    }

    // ========== Loading ==========

    private void LoadFromProfile(ShellProfile profile)
    {
        ProfileName = profile.Name;
        ShellPath = profile.ShellPath;
        Arguments = profile.Arguments ?? string.Empty;
        WorkingDirectory = profile.WorkingDirectory ?? string.Empty;
        EnvironmentVariables = FormatEnvironmentVariables(profile.EnvironmentVariables);
        ShellType = profile.ShellType;
        Icon = profile.Icon ?? string.Empty;
        IsLoginShell = profile.IsLoginShell;
        UseConPty = profile.UseConPty;
    }

    private static string FormatEnvironmentVariables(Dictionary<string, string>? vars)
    {
        if (vars == null || vars.Count == 0)
            return string.Empty;

        return string.Join(Environment.NewLine, vars.Select(kv => $"{kv.Key}={kv.Value}"));
    }

    private static Dictionary<string, string>? ParseEnvironmentVariables(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return null;

        var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        foreach (var line in text.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
        {
            var equalsIndex = line.IndexOf('=');
            if (equalsIndex > 0)
            {
                var key = line[..equalsIndex].Trim();
                var value = line[(equalsIndex + 1)..].Trim();
                
                if (!string.IsNullOrEmpty(key))
                {
                    result[key] = value;
                }
            }
        }

        return result.Count > 0 ? result : null;
    }

    // ========== Property Change Handlers ==========

    partial void OnProfileNameChanged(string value) => Validate();

    partial void OnShellPathChanged(string value)
    {
        Validate();
        DetectShellTypeFromPath();
        DetectVersionAsync();
    }

    // ========== Validation ==========

    private void Validate()
    {
        // Validate name
        NameError = string.IsNullOrWhiteSpace(ProfileName)
            ? "Profile name is required"
            : null;

        // Validate path
        PathError = null;
        if (string.IsNullOrWhiteSpace(ShellPath))
        {
            PathError = "Shell path is required";
        }
        else if (!_shellDetectionService.ValidateShellPath(ShellPath))
        {
            PathError = "Shell executable not found or not executable";
        }

        IsValid = NameError == null && PathError == null;
    }

    private void DetectShellTypeFromPath()
    {
        if (string.IsNullOrEmpty(ShellPath))
        {
            ShellType = ShellType.Unknown;
            return;
        }

        ShellType = _shellDetectionService.DetectShellType(ShellPath);
        _logger.LogDebug("Detected shell type: {Type} from path: {Path}", ShellType, ShellPath);
    }

    private async void DetectVersionAsync()
    {
        if (string.IsNullOrEmpty(ShellPath))
        {
            DetectedVersion = null;
            return;
        }

        IsDetectingVersion = true;
        
        try
        {
            DetectedVersion = await _shellDetectionService.GetShellVersionAsync(ShellPath);
            _logger.LogDebug("Detected version: {Version} for {Path}", DetectedVersion, ShellPath);
        }
        catch (Exception ex)
        {
            _logger.LogDebug(ex, "Failed to detect version for: {Path}", ShellPath);
            DetectedVersion = null;
        }
        finally
        {
            IsDetectingVersion = false;
        }
    }

    // ========== Commands ==========

    [RelayCommand]
    private async Task BrowseShellPathAsync(Window parentWindow)
    {
        var storageProvider = parentWindow.StorageProvider;

        var options = new FilePickerOpenOptions
        {
            Title = "Select Shell Executable",
            AllowMultiple = false
        };

        if (OperatingSystem.IsWindows())
        {
            options.FileTypeFilter = new[]
            {
                new FilePickerFileType("Executables")
                {
                    Patterns = new[] { "*.exe", "*.cmd", "*.bat" }
                },
                new FilePickerFileType("All Files")
                {
                    Patterns = new[] { "*" }
                }
            };
        }

        var result = await storageProvider.OpenFilePickerAsync(options);
        
        if (result.Count > 0)
        {
            ShellPath = result[0].Path.LocalPath;
        }
    }

    [RelayCommand]
    private async Task BrowseWorkingDirectoryAsync(Window parentWindow)
    {
        var storageProvider = parentWindow.StorageProvider;

        var options = new FolderPickerOpenOptions
        {
            Title = "Select Working Directory",
            AllowMultiple = false
        };

        var result = await storageProvider.OpenFolderPickerAsync(options);
        
        if (result.Count > 0)
        {
            WorkingDirectory = result[0].Path.LocalPath;
        }
    }

    [RelayCommand]
    private void DetectFromPath()
    {
        if (string.IsNullOrEmpty(ShellPath))
            return;

        var shellName = Path.GetFileNameWithoutExtension(ShellPath);
        var detected = _shellDetectionService.FindInPath(shellName);
        
        if (detected != null)
        {
            ShellPath = detected;
            _logger.LogInformation("Detected shell in PATH: {Path}", detected);
        }
    }

    [RelayCommand]
    private void ClearWorkingDirectory()
    {
        WorkingDirectory = string.Empty;
    }

    [RelayCommand]
    private void ClearEnvironmentVariables()
    {
        EnvironmentVariables = string.Empty;
    }

    [RelayCommand]
    private void AddEnvironmentVariable()
    {
        if (string.IsNullOrEmpty(EnvironmentVariables))
        {
            EnvironmentVariables = "KEY=value";
        }
        else
        {
            EnvironmentVariables += Environment.NewLine + "KEY=value";
        }
    }

    [RelayCommand]
    private void Save()
    {
        if (!IsValid)
        {
            _logger.LogWarning("Cannot save invalid profile");
            return;
        }

        var profile = GetProfile();
        _logger.LogInformation("Saving profile: {Name} ({Id})", profile.Name, profile.Id);
        
        SaveRequested?.Invoke(this, profile);
    }

    [RelayCommand]
    private void Cancel()
    {
        _logger.LogDebug("Profile editor cancelled");
        CancelRequested?.Invoke(this, EventArgs.Empty);
    }

    // ========== Public Methods ==========

    /// <summary>
    /// Builds a ShellProfile from the current field values.
    /// </summary>
    public ShellProfile GetProfile()
    {
        return new ShellProfile
        {
            Id = _originalProfile.Id,
            Name = ProfileName.Trim(),
            ShellPath = ShellPath.Trim(),
            Arguments = string.IsNullOrWhiteSpace(Arguments) ? null : Arguments.Trim(),
            WorkingDirectory = string.IsNullOrWhiteSpace(WorkingDirectory) ? null : WorkingDirectory.Trim(),
            EnvironmentVariables = ParseEnvironmentVariables(EnvironmentVariables),
            ShellType = ShellType,
            Icon = string.IsNullOrWhiteSpace(Icon) ? null : Icon.Trim(),
            IsLoginShell = IsLoginShell,
            UseConPty = UseConPty,
            IsBuiltIn = false // Custom profiles are never built-in
        };
    }

    /// <summary>
    /// Checks if there are unsaved changes.
    /// </summary>
    public bool HasChanges()
    {
        var current = GetProfile();
        return current.Name != _originalProfile.Name ||
               current.ShellPath != _originalProfile.ShellPath ||
               current.Arguments != _originalProfile.Arguments ||
               current.WorkingDirectory != _originalProfile.WorkingDirectory ||
               current.IsLoginShell != _originalProfile.IsLoginShell ||
               current.UseConPty != _originalProfile.UseConPty;
    }

    // ========== Events ==========

    /// <summary>
    /// Raised when the Save button is clicked with valid data.
    /// </summary>
    public event EventHandler<ShellProfile>? SaveRequested;

    /// <summary>
    /// Raised when the Cancel button is clicked.
    /// </summary>
    public event EventHandler? CancelRequested;
}
```

### 2. ShellProfileEditor.axaml

**Location**: `src/AIntern.Desktop/Views/ShellProfileEditor.axaml`

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AIntern.Desktop.ViewModels"
        x:Class="AIntern.Desktop.Views.ShellProfileEditor"
        x:DataType="vm:ShellProfileEditorViewModel"
        Title="{Binding Title}"
        Width="520"
        Height="640"
        MinWidth="400"
        MinHeight="500"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        ExtendClientAreaToDecorationsHint="True">

    <Window.Styles>
        <!-- Field Label -->
        <Style Selector="TextBlock.field-label">
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Margin" Value="0,0,0,6" />
        </Style>

        <!-- Required Indicator -->
        <Style Selector="TextBlock.required">
            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
        </Style>

        <!-- Error Text -->
        <Style Selector="TextBlock.error-text">
            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Margin" Value="0,4,0,0" />
        </Style>

        <!-- Hint Text -->
        <Style Selector="TextBlock.hint-text">
            <Setter Property="Foreground" Value="{DynamicResource TextMuted}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Margin" Value="0,4,0,0" />
        </Style>

        <!-- Field Group -->
        <Style Selector="StackPanel.field-group">
            <Setter Property="Margin" Value="0,0,0,20" />
        </Style>

        <!-- Version Text -->
        <Style Selector="TextBlock.version-text">
            <Setter Property="Foreground" Value="{DynamicResource AccentBrush}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Margin" Value="0,4,0,0" />
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="*, Auto">

        <!-- Scrollable Form Content -->
        <ScrollViewer Padding="24,24,24,0"
                      VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <!-- ========== PROFILE NAME ========== -->
                <StackPanel Classes="field-group">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Classes="field-label" Text="Profile Name" />
                        <TextBlock Classes="required" Text=" *" />
                    </StackPanel>
                    <TextBox Text="{Binding ProfileName}"
                             Watermark="e.g., My Development Shell"
                             Classes.error="{Binding NameError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                    <TextBlock Classes="error-text"
                               Text="{Binding NameError}"
                               IsVisible="{Binding NameError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                </StackPanel>

                <!-- ========== SHELL PATH ========== -->
                <StackPanel Classes="field-group">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Classes="field-label" Text="Shell Path" />
                        <TextBlock Classes="required" Text=" *" />
                    </StackPanel>
                    <Grid ColumnDefinitions="*, Auto, Auto">
                        <TextBox Text="{Binding ShellPath}"
                                 Watermark="/bin/bash or C:\Windows\System32\cmd.exe"
                                 Classes.error="{Binding PathError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                        <Button Grid.Column="1"
                                Content="Detect"
                                Command="{Binding DetectFromPathCommand}"
                                ToolTip.Tip="Find shell in PATH"
                                Margin="8,0,0,0"
                                Classes="secondary" />
                        <Button Grid.Column="2"
                                Content="Browse..."
                                Command="{Binding BrowseShellPathCommand}"
                                CommandParameter="{Binding $parent[Window]}"
                                Margin="8,0,0,0" />
                    </Grid>
                    <TextBlock Classes="error-text"
                               Text="{Binding PathError}"
                               IsVisible="{Binding PathError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                    
                    <!-- Version Display -->
                    <StackPanel Orientation="Horizontal" 
                                Margin="0,4,0,0"
                                IsVisible="{Binding DetectedVersion, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Classes="hint-text" Text="Version: " />
                        <TextBlock Classes="version-text" Text="{Binding DetectedVersion}" />
                    </StackPanel>
                    
                    <!-- Version Loading -->
                    <StackPanel Orientation="Horizontal"
                                Margin="0,4,0,0"
                                IsVisible="{Binding IsDetectingVersion}">
                        <PathIcon Data="{StaticResource SpinnerIcon}"
                                  Width="12" Height="12"
                                  Classes="spinning"
                                  Foreground="{DynamicResource TextMuted}" />
                        <TextBlock Classes="hint-text" Text=" Detecting version..." Margin="4,0,0,0" />
                    </StackPanel>
                </StackPanel>

                <!-- ========== SHELL TYPE ========== -->
                <StackPanel Classes="field-group">
                    <TextBlock Classes="field-label" Text="Shell Type" />
                    <ComboBox ItemsSource="{Binding ShellTypes}"
                              SelectedItem="{Binding ShellType}"
                              HorizontalAlignment="Stretch" />
                    <TextBlock Classes="hint-text" 
                               Text="Auto-detected from shell path. Override if incorrect." />
                </StackPanel>

                <!-- ========== ARGUMENTS ========== -->
                <StackPanel Classes="field-group">
                    <TextBlock Classes="field-label" Text="Arguments" />
                    <TextBox Text="{Binding Arguments}"
                             Watermark="-l --norc" />
                    <TextBlock Classes="hint-text" 
                               Text="Command line arguments passed to the shell on startup" />
                </StackPanel>

                <!-- ========== WORKING DIRECTORY ========== -->
                <StackPanel Classes="field-group">
                    <TextBlock Classes="field-label" Text="Working Directory" />
                    <Grid ColumnDefinitions="*, Auto, Auto">
                        <TextBox Text="{Binding WorkingDirectory}"
                                 Watermark="Leave empty to use workspace directory" />
                        <Button Grid.Column="1"
                                Classes="icon-button"
                                Command="{Binding ClearWorkingDirectoryCommand}"
                                ToolTip.Tip="Clear"
                                Margin="8,0,0,0"
                                IsVisible="{Binding WorkingDirectory, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                            <PathIcon Data="{StaticResource CloseIcon}" Width="12" Height="12" />
                        </Button>
                        <Button Grid.Column="2"
                                Content="Browse..."
                                Command="{Binding BrowseWorkingDirectoryCommand}"
                                CommandParameter="{Binding $parent[Window]}"
                                Margin="8,0,0,0" />
                    </Grid>
                </StackPanel>

                <!-- ========== ENVIRONMENT VARIABLES ========== -->
                <StackPanel Classes="field-group">
                    <Grid ColumnDefinitions="*, Auto">
                        <TextBlock Classes="field-label" Text="Environment Variables" />
                        <Button Grid.Column="1"
                                Classes="secondary"
                                Command="{Binding AddEnvironmentVariableCommand}"
                                Padding="8,2">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <PathIcon Data="{StaticResource AddIcon}" Width="10" Height="10" />
                                <TextBlock Text="Add" FontSize="11" />
                            </StackPanel>
                        </Button>
                    </Grid>
                    <TextBox Text="{Binding EnvironmentVariables}"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Height="100"
                             Watermark="KEY=value&#x0a;ANOTHER_KEY=another_value"
                             FontFamily="{StaticResource MonospaceFontFamily}" />
                    <TextBlock Classes="hint-text" 
                               Text="One variable per line in KEY=value format. These are added to the shell environment." />
                </StackPanel>

                <!-- ========== OPTIONS ========== -->
                <StackPanel Classes="field-group">
                    <TextBlock Classes="field-label" Text="Options" />
                    
                    <CheckBox IsChecked="{Binding IsLoginShell}"
                              Margin="0,4,0,0">
                        <StackPanel>
                            <TextBlock Text="Run as login shell" />
                            <TextBlock Classes="hint-text" 
                                       Text="Executes shell profile scripts (.bash_profile, .zprofile, etc.)"
                                       Margin="0" />
                        </StackPanel>
                    </CheckBox>

                    <CheckBox IsChecked="{Binding UseConPty}"
                              IsVisible="{Binding IsWindows}"
                              Margin="0,12,0,0">
                        <StackPanel>
                            <TextBlock Text="Use ConPTY" />
                            <TextBlock Classes="hint-text"
                                       Text="Windows pseudo-console for better terminal emulation"
                                       Margin="0" />
                        </StackPanel>
                    </CheckBox>
                </StackPanel>

            </StackPanel>
        </ScrollViewer>

        <!-- ========== DIALOG BUTTONS ========== -->
        <Border Grid.Row="1"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Background="{DynamicResource SurfaceBrush}"
                Padding="24,16">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <!-- Cancel Button (left) -->
                <Button Content="Cancel"
                        Command="{Binding CancelCommand}"
                        MinWidth="80" />

                <!-- Status Indicator (center) -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            IsVisible="{Binding !IsValid}">
                    <PathIcon Data="{StaticResource WarningIcon}"
                              Width="14" Height="14"
                              Foreground="{DynamicResource WarningBrush}" />
                    <TextBlock Text="Fix validation errors to save"
                               FontSize="12"
                               Foreground="{DynamicResource TextMuted}"
                               Margin="6,0,0,0" />
                </StackPanel>

                <!-- Save Button (right) -->
                <Button Grid.Column="2"
                        Content="Save Profile"
                        Command="{Binding SaveCommand}"
                        IsEnabled="{Binding IsValid}"
                        Classes="primary"
                        MinWidth="100" />
            </Grid>
        </Border>

    </Grid>
</Window>
```

### 3. ShellProfileEditor.axaml.cs

**Location**: `src/AIntern.Desktop/Views/ShellProfileEditor.axaml.cs`

```csharp
namespace AIntern.Desktop.Views;

using Avalonia.Controls;
using Avalonia.Interactivity;
using AIntern.Desktop.ViewModels;
using AIntern.Core.Models.Terminal;

/// <summary>
/// Code-behind for the shell profile editor dialog.
/// </summary>
public partial class ShellProfileEditor : Window
{
    private ShellProfileEditorViewModel? _viewModel;

    public ShellProfileEditor()
    {
        InitializeComponent();
    }

    protected override void OnLoaded(RoutedEventArgs e)
    {
        base.OnLoaded(e);

        _viewModel = DataContext as ShellProfileEditorViewModel;
        
        if (_viewModel != null)
        {
            _viewModel.SaveRequested += OnSaveRequested;
            _viewModel.CancelRequested += OnCancelRequested;
        }
    }

    protected override void OnUnloaded(RoutedEventArgs e)
    {
        base.OnUnloaded(e);

        if (_viewModel != null)
        {
            _viewModel.SaveRequested -= OnSaveRequested;
            _viewModel.CancelRequested -= OnCancelRequested;
        }
    }

    private void OnSaveRequested(object? sender, ShellProfile profile)
    {
        Close(profile);
    }

    private void OnCancelRequested(object? sender, EventArgs e)
    {
        Close(null);
    }

    /// <summary>
    /// Shows the editor dialog and returns the saved profile, or null if cancelled.
    /// </summary>
    public static async Task<ShellProfile?> ShowAsync(
        Window owner,
        ShellProfileEditorViewModel viewModel)
    {
        var dialog = new ShellProfileEditor
        {
            DataContext = viewModel
        };

        return await dialog.ShowDialog<ShellProfile?>(owner);
    }
}
```

### 4. Integration with TerminalSettingsViewModel

**Location**: `src/AIntern.Desktop/ViewModels/TerminalSettingsViewModel.cs` (additions)

```csharp
// Add to TerminalSettingsViewModel class:

/// <summary>
/// Opens the profile editor for a new or existing profile.
/// </summary>
public async Task OpenProfileEditorAsync(Window parentWindow, ShellProfile? profile = null)
{
    var editorViewModel = new ShellProfileEditorViewModel(
        _logger.CreateLogger<ShellProfileEditorViewModel>(),
        _shellDetectionService,
        profile
    );

    var result = await ShellProfileEditor.ShowAsync(parentWindow, editorViewModel);

    if (result != null)
    {
        if (profile == null)
        {
            // New profile
            ShellProfiles.Add(result);
            Settings.CustomProfiles.Add(result);
        }
        else
        {
            // Updated profile
            UpdateProfile(result);
        }

        MarkDirty();
    }
}
```

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `ShellProfileEditorViewModel.cs` | `ViewModels/` | Editor ViewModel |
| `ShellProfileEditor.axaml` | `Views/` | Editor window |
| `ShellProfileEditor.axaml.cs` | `Views/` | Code-behind |

### Files to Modify

| File | Changes |
|------|---------|
| `TerminalSettingsViewModel.cs` | Add `OpenProfileEditorAsync` method |
| `TerminalSettingsPanel.axaml` | Wire up profile edit requests |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `ViewModel_Constructor_LoadsExistingProfile` | Profile data loaded |
| `ViewModel_NewProfile_GeneratesId` | New ID created |
| `ViewModel_Validate_ErrorOnEmptyName` | Name required |
| `ViewModel_Validate_ErrorOnEmptyPath` | Path required |
| `ViewModel_Validate_ErrorOnInvalidPath` | Path must exist |
| `ViewModel_ShellPathChanged_DetectsType` | Auto-detection |
| `ViewModel_ShellPathChanged_DetectsVersion` | Version fetched |
| `ViewModel_GetProfile_BuildsCorrectly` | Profile construction |
| `ViewModel_GetProfile_ParsesEnvVars` | Environment parsing |
| `ViewModel_Save_RaisesEvent` | Save event fired |
| `ViewModel_Cancel_RaisesEvent` | Cancel event fired |
| `ViewModel_HasChanges_DetectsModifications` | Change tracking |
| `ParseEnvironmentVariables_HandlesMultiline` | Parsing works |
| `ParseEnvironmentVariables_IgnoresInvalid` | Invalid lines skipped |
| `FormatEnvironmentVariables_FormatsCorrectly` | Formatting works |

**Total Tests**: 15

---

## Verification

```bash
# Build the desktop project
dotnet build src/AIntern.Desktop

# Run unit tests
dotnet test --filter "ShellProfileEditor"

# Run application and test visually
dotnet run --project src/AIntern.Desktop
# 1. Open Settings → Terminal
# 2. Click "Add Profile"
# 3. Enter profile name
# 4. Browse for shell path
# 5. Verify auto-detection works
# 6. Test environment variables
# 7. Save and verify profile appears
# 8. Edit existing profile
# 9. Verify cancel works
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Dialog opens for new profile |
| AC-2 | Dialog opens for edit with data loaded |
| AC-3 | Profile name validation works |
| AC-4 | Shell path validation works |
| AC-5 | Browse button opens file picker |
| AC-6 | Working directory browse works |
| AC-7 | Shell type auto-detected |
| AC-8 | Version displayed when detectable |
| AC-9 | Environment variables parsed correctly |
| AC-10 | Login shell option works |
| AC-11 | ConPTY option visible only on Windows |
| AC-12 | Save button disabled when invalid |
| AC-13 | Save returns profile to parent |
| AC-14 | Cancel closes without changes |

---

## Changelog Entry

```markdown
## v0.5.5g - Shell Profile Editor

### Added
- `ShellProfileEditorViewModel` with:
  - Profile property binding
  - Path and name validation
  - Shell type auto-detection
  - Version detection (async)
  - Environment variable parsing
  - File/folder browser commands
  - Save/Cancel events

- `ShellProfileEditor` dialog with:
  - Profile name field (required)
  - Shell path field with Browse and Detect buttons
  - Shell type dropdown
  - Arguments field
  - Working directory with Browse
  - Environment variables multiline editor
  - Login shell checkbox
  - ConPTY option (Windows only)
  - Cancel/Save buttons with validation state

### Integration
- Connected to TerminalSettingsPanel profile list
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.5.5g | 0.75 day |
