# Design Specification: AIntern v0.5.3a "Shell Detection Service"

## Overview

**Version**: v0.5.3a
**Parent**: v0.5.3 Shell Integration
**Focus**: Cross-platform shell discovery, PATH searching, version detection

### Purpose

This sub-version creates a robust shell detection service that:
1. Discovers available shells on the user's system
2. Identifies the default/preferred shell per platform
3. Extracts version information from shell executables
4. Provides PATH searching utilities

### Dependencies

**From v0.5.1 (Terminal Foundation)**:
- `ITerminalService` - For eventual shell selection integration

**External**:
- `System.Diagnostics.Process` - For version detection
- `Microsoft.Extensions.Logging` - For diagnostic logging

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                   v0.5.3a Shell Detection Architecture                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Interface Layer                                   │ │
│  │  src/AIntern.Core/Interfaces/                                           │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  IShellDetectionService                                                  │ │
│  │  ├── GetDefaultShellAsync() → string                                    │ │
│  │  ├── GetAvailableShellsAsync() → IReadOnlyList<ShellInfo>               │ │
│  │  ├── DetectShellType(path) → ShellType                                  │ │
│  │  ├── GetShellVersionAsync(path) → string?                               │ │
│  │  ├── ValidateShellPath(path) → bool                                     │ │
│  │  └── FindInPath(name) → string?                                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Model Layer                                       │ │
│  │  src/AIntern.Core/Models/Terminal/                                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  ShellType (enum)           │  ShellInfo (class)                        │ │
│  │  ├── Unknown                │  ├── Name: string                         │ │
│  │  ├── Bash                   │  ├── Path: string                         │ │
│  │  ├── Zsh                    │  ├── Type: ShellType                      │ │
│  │  ├── Fish                   │  ├── Version: string?                     │ │
│  │  ├── PowerShell             │  ├── IsDefault: bool                      │ │
│  │  ├── Cmd                    │  ├── IconPath: string?                    │ │
│  │  ├── Sh                     │  ├── DefaultArguments: string?            │ │
│  │  ├── Tcsh, Ksh              │  └── Description: string?                 │ │
│  │  ├── Nushell                │                                           │ │
│  │  └── Wsl                    │                                           │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     Implementation Layer                                 │ │
│  │  src/AIntern.Services/Terminal/                                         │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  ShellDetectionService                                                   │ │
│  │  ├── Platform Detection (OperatingSystem.IsWindows/IsMacOS/IsLinux)    │ │
│  │  ├── Windows Discovery:                                                 │ │
│  │  │   ├── PowerShell Core (pwsh in PATH)                                │ │
│  │  │   ├── Windows PowerShell (System32\WindowsPowerShell)               │ │
│  │  │   ├── Command Prompt (System32\cmd.exe)                             │ │
│  │  │   ├── Git Bash (Program Files\Git\bin\bash.exe)                     │ │
│  │  │   ├── WSL distributions (wsl -l -q)                                 │ │
│  │  │   └── Nushell (nu in PATH)                                          │ │
│  │  └── Unix Discovery:                                                    │ │
│  │      ├── Parse /etc/shells                                              │ │
│  │      ├── SHELL environment variable                                     │ │
│  │      └── Common paths (/bin/bash, /bin/zsh, etc.)                      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Platform-Specific Detection

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    Default Shell Detection by Platform                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Windows:                                                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Priority Order:                                                       │  │
│  │  1. PowerShell Core (pwsh) - if found in PATH                         │  │
│  │  2. Windows PowerShell - %SystemRoot%\System32\WindowsPowerShell\...  │  │
│  │  3. Command Prompt - %SystemRoot%\System32\cmd.exe (fallback)         │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  macOS / Linux:                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Priority Order:                                                       │  │
│  │  1. $SHELL environment variable (if file exists)                      │  │
│  │  2. /bin/zsh (macOS default since Catalina)                           │  │
│  │  3. /bin/bash                                                          │  │
│  │  4. /bin/sh (POSIX fallback)                                          │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Version Detection

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Version Detection Commands                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────┬───────────────────────────────────────────────────┐  │
│  │  Shell Type       │  Version Command                                  │  │
│  ├───────────────────┼───────────────────────────────────────────────────┤  │
│  │  Bash             │  bash --version                                   │  │
│  │  Zsh              │  zsh --version                                    │  │
│  │  Fish             │  fish --version                                   │  │
│  │  PowerShell       │  pwsh -Command "$PSVersionTable.PSVersion..."    │  │
│  │  Cmd              │  cmd /c ver                                       │  │
│  │  Sh               │  sh --version                                     │  │
│  │  Nushell          │  nu --version                                     │  │
│  └───────────────────┴───────────────────────────────────────────────────┘  │
│                                                                              │
│  Version Parsing: Extract first line, match regex (\d+\.[\d.]+)             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. ShellType.cs

**Location**: `src/AIntern.Core/Models/Terminal/ShellType.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Enumeration of known shell types.
/// </summary>
public enum ShellType
{
    Unknown = 0,
    Bash,
    Zsh,
    Fish,
    PowerShell,
    Cmd,
    Sh,
    Tcsh,
    Ksh,
    Nushell,
    Wsl
}
```

### 2. ShellInfo.cs

**Location**: `src/AIntern.Core/Models/Terminal/ShellInfo.cs`

```csharp
namespace AIntern.Core.Models.Terminal;

/// <summary>
/// Information about a discovered shell on the system.
/// </summary>
public sealed class ShellInfo
{
    public string Name { get; init; } = string.Empty;
    public string Path { get; init; } = string.Empty;
    public ShellType Type { get; init; }
    public string? Version { get; init; }
    public bool IsDefault { get; init; }
    public string? IconPath { get; init; }
    public string? DefaultArguments { get; init; }
    public string? Description { get; init; }
}
```

### 3. IShellDetectionService.cs

**Location**: `src/AIntern.Core/Interfaces/IShellDetectionService.cs`

```csharp
namespace AIntern.Core.Interfaces;

using AIntern.Core.Models.Terminal;

/// <summary>
/// Service for detecting available shells on the system.
/// </summary>
public interface IShellDetectionService
{
    Task<string> GetDefaultShellAsync(CancellationToken ct = default);
    Task<IReadOnlyList<ShellInfo>> GetAvailableShellsAsync(CancellationToken ct = default);
    ShellType DetectShellType(string shellPath);
    Task<string?> GetShellVersionAsync(string shellPath, CancellationToken ct = default);
    bool ValidateShellPath(string shellPath);
    string? FindInPath(string executableName);
}
```

### 4. ShellDetectionService.cs

**Location**: `src/AIntern.Services/Terminal/ShellDetectionService.cs`

Full implementation with:
- `GetDefaultShellAsync()` - Platform-specific default detection
- `GetAvailableShellsAsync()` - Discover all shells
- `DetectShellType()` - Match executable name to ShellType
- `GetShellVersionAsync()` - Run version command, parse output
- `ValidateShellPath()` - Check file exists and is executable
- `FindInPath()` - Search PATH with platform-specific extensions
- `GetWslDistributionsAsync()` - List WSL distros on Windows

---

## File Summary

| File | Location | Purpose |
|------|----------|---------|
| `ShellType.cs` | `src/AIntern.Core/Models/Terminal/` | Shell type enumeration |
| `ShellInfo.cs` | `src/AIntern.Core/Models/Terminal/` | Shell information model |
| `IShellDetectionService.cs` | `src/AIntern.Core/Interfaces/` | Detection service interface |
| `ShellDetectionService.cs` | `src/AIntern.Services/Terminal/` | Detection implementation |

### Files to Modify

| File | Changes |
|------|---------|
| `DependencyInjection.cs` | Register `IShellDetectionService` |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `DetectShellType_Bash_ReturnsBash` | Various executable names |
| `DetectShellType_Pwsh_ReturnsPowerShell` | PowerShell variants |
| `FindInPath_ExistingExecutable_ReturnsPath` | PATH searching |
| `ValidateShellPath_NonExistent_ReturnsFalse` | Path validation |
| `GetDefaultShell_ReturnsValidPath` | Default shell exists |

---

## Verification

```bash
dotnet build src/AIntern.Services
dotnet test --filter "ShellDetection"
```

---

## Changelog Entry

```markdown
## v0.5.3a - Shell Detection Service

### Added
- `ShellType` enumeration (Bash, Zsh, Fish, PowerShell, Cmd, Sh, Tcsh, Ksh, Nushell, Wsl)
- `ShellInfo` model with Name, Path, Type, Version, IsDefault, IconPath, DefaultArguments, Description
- `IShellDetectionService` interface for shell discovery
- `ShellDetectionService` implementation with:
  - Cross-platform default shell detection
  - Windows: PowerShell Core > Windows PowerShell > cmd.exe priority
  - Unix: $SHELL > /bin/zsh > /bin/bash > /bin/sh fallback
  - Shell discovery from /etc/shells (Unix) or known paths (Windows)
  - Version extraction via shell-specific commands
  - PATH searching with platform-appropriate extensions
  - WSL distribution enumeration on Windows
  - Shell path validation
```
