# Design Specification: AIntern v0.7.5h "Chat Interface RAG Integration"

## Overview

**Version**: v0.7.5h  
**Parent**: v0.7.5 UI & Integration  
**Focus**: RAG toggle in chat input area and context source display in responses

### Purpose

This sub-version integrates RAG into the chat interface:
1. RAG toggle button in chat input toolbar
2. Context source display showing which files contributed to responses
3. ChatViewModel integration with RAG query service

### Dependencies

**From v0.7.5a**: `RagSettings` (EnableRagInChat, MaxRagContextTokens, MaxRagChunks)  
**From v0.7.4**: `IRagQueryService`, `RagContext`, `RetrievedChunk`  
**From Existing UI**: `ChatView`, `ChatViewModel`, `MessageBubble`

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  v0.7.5h Chat Interface RAG Integration                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Chat View                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Message List                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  [User Message]                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  How does the authentication service work?                        â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  [Assistant Message]                                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  The authentication service handles user login...                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  ğŸ“š Sources (3 files)                              [Expand] â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ src/Services/AuthService.cs (92% match)               â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€â”€ src/Models/User.cs (87% match)                        â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€ docs/auth-flow.md (75% match)                         â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Chat Input Area                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  [ğŸ“š RAG]  [ğŸ“ Attach]  [âŒ˜ Tools]                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â†‘                                                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Toggle button (on/off state)                                     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Type your message...                                      [Send]â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Visual Components

### RAG Toggle Button States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG Toggle Button States                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Enabled (Active)                                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚     â”‚ ğŸ“š RAG: On  â”‚  Background: Accent color, Icon: Filled book            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚     Tooltip: "RAG enabled - relevant code context will be included"         â”‚
â”‚                                                                              â”‚
â”‚  2. Disabled (Inactive)                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚     â”‚ ğŸ“– RAG: Off â”‚  Background: Default, Icon: Outline book                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚     Tooltip: "Click to enable RAG context"                                  â”‚
â”‚                                                                              â”‚
â”‚  3. Unavailable (No Index)                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚     â”‚ ğŸ“– RAG      â”‚  Background: Dimmed, Icon: Grayed out                   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚     Tooltip: "No index available. Open Index Manager to create one."        â”‚
â”‚     IsEnabled: false                                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Context Sources Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Sources Display (Collapsed)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“š Sources (3 files)                                         [â–¼]      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Context Sources Display (Expanded)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“š Sources (3 files)                                         [â–²]      â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚  src/Services/AuthService.cs                           92% match   â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Lines 45-67                                                       â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  public async Task<AuthResult> LoginAsync(...)               â”‚ â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  {                                                            â”‚ â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚      var user = await _userRepo.FindByEmail(email);          â”‚ â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚      ...                                                      â”‚ â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                     [Open File]    â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚  src/Models/User.cs                                    87% match   â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Lines 12-28                                                       â”‚â”‚ â”‚
â”‚  â”‚  â”‚  ...                                                               â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Specifications

### 1. RagToggleButton.axaml

**Location**: `src/AIntern.Desktop/Controls/RagToggleButton.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             x:Class="AIntern.Desktop.Controls.RagToggleButton"
             x:DataType="vm:RagToggleViewModel">

    <ToggleButton IsChecked="{Binding IsRagEnabled}"
                  IsEnabled="{Binding IsRagAvailable}"
                  Command="{Binding ToggleRagCommand}"
                  Padding="8,4"
                  CornerRadius="4">
        <ToggleButton.Styles>
            <Style Selector="ToggleButton:checked">
                <Setter Property="Background" Value="{DynamicResource AccentBrush}"/>
            </Style>
        </ToggleButton.Styles>
        
        <ToolTip.Tip>
            <TextBlock Text="{Binding TooltipText}"/>
        </ToolTip.Tip>

        <StackPanel Orientation="Horizontal" Spacing="4">
            <PathIcon Data="{Binding RagIcon}" Width="14" Height="14"/>
            <TextBlock Text="{Binding ButtonText}" FontSize="12"/>
        </StackPanel>
    </ToggleButton>
</UserControl>
```

### 2. ContextSourcesPanel.axaml

**Location**: `src/AIntern.Desktop/Controls/ContextSourcesPanel.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             x:Class="AIntern.Desktop.Controls.ContextSourcesPanel"
             x:DataType="vm:ContextSourcesViewModel"
             IsVisible="{Binding HasSources}">

    <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,8,0,0">
        <Expander IsExpanded="{Binding IsExpanded}">
            <Expander.Header>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <PathIcon Data="{StaticResource book_regular}" Width="14" Height="14"/>
                    <TextBlock>
                        <Run Text="Sources ("/>
                        <Run Text="{Binding SourceCount}"/>
                        <Run Text=" files)"/>
                    </TextBlock>
                </StackPanel>
            </Expander.Header>

            <ItemsControl ItemsSource="{Binding Sources}" Margin="8">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:ContextSourceItemViewModel">
                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,0,0,8">
                            <StackPanel>
                                <!-- Header -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding FilePath}"
                                                   FontWeight="SemiBold"
                                                   FontSize="12"/>
                                        <TextBlock Text="{Binding LineRange}"
                                                   Opacity="0.7"
                                                   FontSize="11"/>
                                    </StackPanel>
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding RelevanceText}"
                                               Foreground="{Binding RelevanceColor}"
                                               FontWeight="SemiBold"/>
                                </Grid>

                                <!-- Code Preview -->
                                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                                        CornerRadius="4"
                                        Padding="8"
                                        Margin="0,8,0,0">
                                    <TextBlock Text="{Binding CodePreview}"
                                               FontFamily="Consolas,Monaco,monospace"
                                               FontSize="11"
                                               TextTrimming="CharacterEllipsis"
                                               MaxLines="4"/>
                                </Border>

                                <!-- Open File Button -->
                                <Button Content="Open File"
                                        Command="{Binding OpenFileCommand}"
                                        HorizontalAlignment="Right"
                                        Margin="0,8,0,0"
                                        Padding="8,4"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Expander>
    </Border>
</UserControl>
```

### 3. RagToggleViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/RagToggleViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using Avalonia.Media;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using AIntern.Core.RAG.Settings;
using AIntern.Core.RAG.Storage;

/// <summary>
/// ViewModel for the RAG toggle button in chat input.
/// </summary>
public partial class RagToggleViewModel : ObservableObject
{
    private readonly IRagSettingsService _settingsService;
    private readonly IVectorStore _vectorStore;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(ButtonText))]
    [NotifyPropertyChangedFor(nameof(TooltipText))]
    [NotifyPropertyChangedFor(nameof(RagIcon))]
    private bool _isRagEnabled;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(TooltipText))]
    private bool _isRagAvailable;

    public string ButtonText => IsRagEnabled ? "RAG: On" : "RAG: Off";

    public string TooltipText
    {
        get
        {
            if (!IsRagAvailable)
                return "No index available. Open Index Manager to create one.";
            return IsRagEnabled
                ? "RAG enabled - relevant code context will be included"
                : "Click to enable RAG context";
        }
    }

    public StreamGeometry RagIcon => IsRagEnabled
        ? (StreamGeometry)App.Current!.FindResource("book_filled")!
        : (StreamGeometry)App.Current!.FindResource("book_regular")!;

    public RagToggleViewModel(
        IRagSettingsService settingsService,
        IVectorStore vectorStore)
    {
        _settingsService = settingsService;
        _vectorStore = vectorStore;
    }

    public async Task InitializeAsync()
    {
        var settings = await _settingsService.GetSettingsAsync();
        IsRagEnabled = settings.EnableRagInChat;
        
        // Check if index exists
        if (!string.IsNullOrEmpty(settings.LastWorkspacePath))
        {
            var info = await _vectorStore.GetIndexInfoAsync(settings.LastWorkspacePath);
            IsRagAvailable = info != null;
        }
    }

    [RelayCommand]
    private async Task ToggleRagAsync()
    {
        IsRagEnabled = !IsRagEnabled;
        
        var settings = await _settingsService.GetSettingsAsync();
        settings.EnableRagInChat = IsRagEnabled;
        await _settingsService.SaveSettingsAsync(settings);
    }
}
```

### 4. ContextSourcesViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/ContextSourcesViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using System.Collections.ObjectModel;
using Avalonia.Media;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using AIntern.Core.RAG.Retrieval;

/// <summary>
/// ViewModel for the context sources panel.
/// </summary>
public partial class ContextSourcesViewModel : ObservableObject
{
    [ObservableProperty]
    private ObservableCollection<ContextSourceItemViewModel> _sources = new();

    [ObservableProperty]
    private bool _isExpanded;

    public bool HasSources => Sources.Count > 0;
    public int SourceCount => Sources.Count;

    public void LoadFromContext(RagContext context)
    {
        Sources.Clear();
        
        foreach (var chunk in context.Chunks)
        {
            Sources.Add(new ContextSourceItemViewModel
            {
                FilePath = chunk.RelativeFilePath,
                LineRange = $"Lines {chunk.StartLine}-{chunk.EndLine}",
                RelevanceScore = chunk.RelevanceScore,
                CodePreview = TruncatePreview(chunk.Content, 200)
            });
        }

        OnPropertyChanged(nameof(HasSources));
        OnPropertyChanged(nameof(SourceCount));
    }

    private static string TruncatePreview(string content, int maxLength)
    {
        if (content.Length <= maxLength)
            return content;
        return content[..maxLength] + "...";
    }
}

/// <summary>
/// ViewModel for individual context source items.
/// </summary>
public partial class ContextSourceItemViewModel : ObservableObject
{
    private readonly Func<string, Task>? _openFileAction;

    [ObservableProperty]
    private string _filePath = string.Empty;

    [ObservableProperty]
    private string _lineRange = string.Empty;

    [ObservableProperty]
    private double _relevanceScore;

    [ObservableProperty]
    private string _codePreview = string.Empty;

    public string RelevanceText => $"{RelevanceScore:P0} match";

    public IBrush RelevanceColor
    {
        get
        {
            return RelevanceScore switch
            {
                >= 0.9 => Brushes.LimeGreen,
                >= 0.7 => Brushes.DodgerBlue,
                >= 0.5 => Brushes.Orange,
                _ => Brushes.Gray
            };
        }
    }

    [RelayCommand]
    private async Task OpenFileAsync()
    {
        if (_openFileAction != null)
            await _openFileAction(FilePath);
    }
}
```

### 5. ChatViewModel Integration

**Location**: Modifications to `src/AIntern.Desktop/ViewModels/ChatViewModel.cs`

```csharp
// Add to ChatViewModel class

#region RAG Integration

[ObservableProperty]
private RagToggleViewModel _ragToggle;

private async Task<string> BuildPromptWithRagAsync(string userMessage)
{
    if (!RagToggle.IsRagEnabled || !RagToggle.IsRagAvailable)
        return userMessage;

    _logger.LogDebug("Retrieving RAG context for query");

    try
    {
        var settings = await _settingsService.GetSettingsAsync();
        var context = await _ragQueryService.GetContextAsync(
            userMessage,
            settings.MaxRagContextTokens,
            settings.MaxRagChunks,
            settings.MinRelevanceScore);

        if (context.Chunks.Count == 0)
        {
            _logger.LogDebug("No relevant context found");
            return userMessage;
        }

        _logger.LogInformation("Found {Count} relevant chunks", context.Chunks.Count);

        // Store context for display in response
        _lastRagContext = context;

        // Build augmented prompt
        return BuildAugmentedPrompt(userMessage, context);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to retrieve RAG context");
        return userMessage;
    }
}

private string BuildAugmentedPrompt(string userMessage, RagContext context)
{
    var sb = new StringBuilder();
    
    sb.AppendLine("The following code context is relevant to the user's question:");
    sb.AppendLine();
    
    foreach (var chunk in context.Chunks)
    {
        sb.AppendLine($"--- {chunk.RelativeFilePath} (lines {chunk.StartLine}-{chunk.EndLine}) ---");
        sb.AppendLine(chunk.Content);
        sb.AppendLine();
    }
    
    sb.AppendLine("---");
    sb.AppendLine();
    sb.AppendLine("User question:");
    sb.AppendLine(userMessage);

    return sb.ToString();
}

private void AttachContextToMessage(MessageViewModel message, RagContext context)
{
    message.ContextSources.LoadFromContext(context);
}

#endregion
```

---

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG-Enabled Chat Flow                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. User types message                                                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚  "How does login work?"                          â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â–¼                                                   â”‚
â”‚  2. Check RAG toggle                                                         â”‚
â”‚     IsRagEnabled? â”€â”€â”€â–º Yes â”€â”€â”€â–º Continue                                    â”‚
â”‚                   â”‚                                                          â”‚
â”‚                   â””â”€â”€â–º No â”€â”€â”€â–º Send directly to LLM                         â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â–¼                                                   â”‚
â”‚  3. Query RAG service                                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚  IRagQueryService.GetContextAsync(query)         â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â–¼                                                   â”‚
â”‚  4. Build augmented prompt                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚  Context: AuthService.cs, User.cs...             â”‚                    â”‚
â”‚     â”‚  Question: How does login work?                  â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â–¼                                                   â”‚
â”‚  5. Send to LLM                                                              â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â–¼                                                   â”‚
â”‚  6. Display response with sources                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚  [Response text]                                 â”‚                    â”‚
â”‚     â”‚  ğŸ“š Sources (3 files)                            â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Unit Test Requirements

**File**: `tests/AIntern.Desktop.Tests/ViewModels/RagToggleViewModelTests.cs`

| Test | Description |
|------|-------------|
| `InitializeAsync_LoadsSettingsState` | Verify initial state |
| `ToggleRagCommand_TogglesState` | Verify toggle works |
| `ToggleRagCommand_PersistsToSettings` | Verify settings saved |
| `IsRagAvailable_FalseWhenNoIndex` | Verify availability check |
| `ButtonText_ReflectsState` | Verify text changes |
| `TooltipText_ReflectsAvailability` | Verify tooltip |

**File**: `tests/AIntern.Desktop.Tests/ViewModels/ContextSourcesViewModelTests.cs`

| Test | Description |
|------|-------------|
| `LoadFromContext_PopulatesSources` | Verify loading |
| `HasSources_TrueWhenLoaded` | Verify visibility |
| `RelevanceColor_GreenForHighScore` | Verify color mapping |
| `TruncatePreview_LimitsLength` | Verify truncation |

---

## Acceptance Criteria

- [ ] RAG toggle button appears in chat input toolbar
- [ ] Toggle shows On/Off state with appropriate styling
- [ ] Toggle disabled when no index available
- [ ] Tooltip explains current state
- [ ] RAG context retrieved when enabled
- [ ] Context sources panel appears on assistant messages
- [ ] Sources show file path, line range, relevance
- [ ] Code preview displayed in expandable section
- [ ] Open File button navigates to source
- [ ] Relevance color-coded (green/blue/orange/gray)
- [ ] Unit tests achieve >90% coverage

---

## Changelog Entry

```markdown
## v0.7.5h - Chat Interface RAG Integration

### Added

- `RagToggleButton.axaml` control with:
  - Toggle button in chat input toolbar
  - On/Off visual states with accent highlight
  - Disabled state when no index available
  - Descriptive tooltips
- `RagToggleViewModel` with:
  - Settings-backed toggle state
  - Index availability check
  - Persistence on toggle
- `ContextSourcesPanel.axaml` control with:
  - Collapsible sources display
  - File path, line range, relevance for each source
  - Code preview with monospace font
  - Open File button per source
- `ContextSourcesViewModel` with:
  - Load from `RagContext`
  - Relevance color mapping
  - Preview truncation
- ChatViewModel RAG integration:
  - `BuildPromptWithRagAsync()` for context retrieval
  - `BuildAugmentedPrompt()` for prompt construction
  - Context attachment to response messages
```
