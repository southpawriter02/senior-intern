# Design Specification: AIntern v0.7.5d "Indexing Progress Dialog"

## Overview

**Version**: v0.7.5d  
**Parent**: v0.7.5 UI & Integration  
**Focus**: Progress dialog for indexing operations with real-time updates and cancellation support

### Purpose

This sub-version creates the indexing progress UI and its backing ViewModel:
1. `IndexingProgressDialog.axaml` - Modal dialog showing progress bar, file count, current file, and cancel button
2. `IndexingProgressDialog.axaml.cs` - Code-behind for dialog lifecycle
3. `IndexingProgressViewModel.cs` - ViewModel receiving progress updates from indexing pipeline

### Dependencies

**From v0.7.3**: `IIndexingPipeline`, `IndexingProgress`, `IndexingResult`  
**From v0.7.5c**: Pattern for dialog ViewModel with `CloseRequested` event  
**From Avalonia**: `ProgressBar`, `Window`, `Button` controls

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                   v0.7.5d Indexing Progress Dialog Architecture              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  IndexingProgressDialog                                                  │ │
│  │  src/AIntern.Desktop/Views/Dialogs/IndexingProgressDialog.axaml         │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Header                                                            │  │ │
│  │  │  ├── Title: "Indexing Workspace"                                  │  │ │
│  │  │  └── Subtitle: Workspace path                                     │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Progress Section                                                  │  │ │
│  │  │  ├── ProgressBar (0-100%)                                         │  │ │
│  │  │  ├── Status Text: "Processing file 42 of 156..."                  │  │ │
│  │  │  ├── Current File: "src/Services/MyService.cs"                    │  │ │
│  │  │  └── Elapsed Time: "00:01:23"                                     │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Statistics Section (visible during/after indexing)               │  │ │
│  │  │  ├── Files Processed: 42                                          │  │ │
│  │  │  ├── Chunks Created: 287                                          │  │ │
│  │  │  ├── Files Skipped: 3                                             │  │ │
│  │  │  └── Errors: 0                                                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Footer                                                            │  │ │
│  │  │  ├── Cancel Button (during indexing)                              │  │ │
│  │  │  └── Close Button (after completion)                              │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  IndexingProgressViewModel                                               │ │
│  │  src/AIntern.Desktop/ViewModels/IndexingProgressViewModel.cs            │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  Properties:                                                             │ │
│  │  ├── WorkspacePath, ProgressPercent, StatusText, CurrentFile           │ │
│  │  ├── ElapsedTime, FilesProcessed, ChunksCreated, FilesSkipped, Errors  │ │
│  │  ├── IsIndexing, IsComplete, IsCancelled, HasErrors                    │ │
│  │  │                                                                       │ │
│  │  Methods:                                                                │ │
│  │  ├── StartAsync(CancellationToken) - Begin indexing                     │ │
│  │  ├── OnProgressUpdate(IndexingProgress) - Handle pipeline events        │ │
│  │  │                                                                       │ │
│  │  Commands:                                                               │ │
│  │  ├── CancelCommand - Request cancellation                               │ │
│  │  └── CloseCommand - Close dialog                                        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Data Flow:                                                                  │
│  ┌──────────────┐    Progress     ┌──────────────────┐    Binding           │
│  │ Indexing     │ ──────────────► │ ViewModel        │ ──────────────►      │
│  │ Pipeline     │   IProgress<T>  │                  │   Observable         │
│  │ (v0.7.3)     │                 │                  │   Properties         │
│  └──────────────┘                 └──────────────────┘                      │
│         │                                  │                                 │
│         │ CancellationToken                │ CloseRequested                  │
│         ▼                                  ▼                                 │
│  ┌──────────────┐                 ┌──────────────────┐                      │
│  │ Cancel       │                 │ Dialog           │                      │
│  │ Requested    │                 │ Closes           │                      │
│  └──────────────┘                 └──────────────────┘                      │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Visual Layout

```
┌─────────────────────────────────────────────────────────────────┐
│  Indexing Workspace                                              │
│  /Users/dev/projects/myapp                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  27%        │
│                                                                  │
│  Processing file 42 of 156...                                    │
│  src/Services/AuthenticationService.cs                           │
│                                                                  │
│  Elapsed: 00:01:23                                               │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Files Processed    Chunks Created    Skipped     Errors   ││
│  │       42                 287             3           0      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                               [Cancel]           │
└─────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. IndexingProgressDialog.axaml

**Location**: `src/AIntern.Desktop/Views/Dialogs/IndexingProgressDialog.axaml`

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AIntern.Desktop.ViewModels"
        x:Class="AIntern.Desktop.Views.Dialogs.IndexingProgressDialog"
        x:DataType="vm:IndexingProgressViewModel"
        Title="Indexing Workspace"
        Width="500"
        Height="350"
        MinWidth="400"
        MinHeight="300"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        ShowInTaskbar="False">

    <Grid RowDefinitions="Auto,*,Auto" Margin="20">

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="Indexing Workspace"
                       FontSize="18"
                       FontWeight="Bold"/>
            <TextBlock Text="{Binding WorkspacePath}"
                       Opacity="0.7"
                       TextTrimming="CharacterEllipsis"
                       Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Progress Section -->
        <StackPanel Grid.Row="1">
            <!-- Progress Bar -->
            <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,8">
                <ProgressBar Grid.Column="0"
                             Value="{Binding ProgressPercent}"
                             Minimum="0"
                             Maximum="100"
                             Height="20"/>
                <TextBlock Grid.Column="1"
                           Text="{Binding ProgressPercent, StringFormat={}{0:0}%}"
                           VerticalAlignment="Center"
                           Margin="8,0,0,0"
                           FontWeight="SemiBold"/>
            </Grid>

            <!-- Status Text -->
            <TextBlock Text="{Binding StatusText}"
                       Margin="0,0,0,4"/>

            <!-- Current File -->
            <TextBlock Text="{Binding CurrentFile}"
                       Opacity="0.7"
                       FontFamily="Consolas,Monaco,monospace"
                       FontSize="12"
                       TextTrimming="CharacterEllipsis"
                       Margin="0,0,0,8"/>

            <!-- Elapsed Time -->
            <TextBlock Margin="0,0,0,16">
                <Run Text="Elapsed: "/>
                <Run Text="{Binding ElapsedTime}" FontWeight="SemiBold"/>
            </TextBlock>

            <!-- Statistics Grid -->
            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="12">
                <Grid ColumnDefinitions="*,*,*,*">
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding FilesProcessed}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Processed"
                                   Opacity="0.7"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding ChunksCreated}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Chunks"
                                   Opacity="0.7"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding FilesSkipped}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Skipped"
                                   Opacity="0.7"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding ErrorCount}"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="{Binding ErrorCountColor}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Errors"
                                   Opacity="0.7"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Border>
        </StackPanel>

        <!-- Footer -->
        <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,16,0,0">
            <Button Content="Cancel"
                    Command="{Binding CancelCommand}"
                    IsVisible="{Binding IsIndexing}"
                    Width="80"/>
            <Button Content="Close"
                    Command="{Binding CloseCommand}"
                    IsVisible="{Binding IsComplete}"
                    Classes="accent"
                    Width="80"/>
        </StackPanel>
    </Grid>
</Window>
```

### 2. IndexingProgressDialog.axaml.cs

**Location**: `src/AIntern.Desktop/Views/Dialogs/IndexingProgressDialog.axaml.cs`

```csharp
namespace AIntern.Desktop.Views.Dialogs;

using Avalonia.Controls;
using AIntern.Desktop.ViewModels;

/// <summary>
/// Code-behind for the Indexing Progress dialog.
/// </summary>
public partial class IndexingProgressDialog : Window
{
    public IndexingProgressDialog()
    {
        InitializeComponent();
    }

    public IndexingProgressDialog(IndexingProgressViewModel viewModel) : this()
    {
        DataContext = viewModel;
        viewModel.CloseRequested += (_, _) => Close();
    }

    protected override void OnOpened(EventArgs e)
    {
        base.OnOpened(e);
        
        if (DataContext is IndexingProgressViewModel vm)
        {
            _ = vm.StartAsync();
        }
    }
}
```

### 3. IndexingProgressViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/IndexingProgressViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using System.Diagnostics;
using Avalonia.Media;
using Avalonia.Threading;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Microsoft.Extensions.Logging;
using AIntern.Core.RAG.Indexing;

/// <summary>
/// ViewModel for the Indexing Progress dialog.
/// </summary>
public partial class IndexingProgressViewModel : ObservableObject
{
    private readonly IIndexingPipeline _pipeline;
    private readonly string _workspacePath;
    private readonly bool _fullReindex;
    private readonly ILogger<IndexingProgressViewModel> _logger;
    private readonly Stopwatch _stopwatch = new();
    private readonly DispatcherTimer _elapsedTimer;
    private CancellationTokenSource? _cts;

    public event EventHandler? CloseRequested;

    #region Observable Properties

    [ObservableProperty]
    private string _workspacePath_Display = string.Empty;

    [ObservableProperty]
    private double _progressPercent;

    [ObservableProperty]
    private string _statusText = "Preparing...";

    [ObservableProperty]
    private string _currentFile = string.Empty;

    [ObservableProperty]
    private string _elapsedTime = "00:00:00";

    [ObservableProperty]
    private int _filesProcessed;

    [ObservableProperty]
    private int _chunksCreated;

    [ObservableProperty]
    private int _filesSkipped;

    [ObservableProperty]
    private int _errorCount;

    [ObservableProperty]
    private IBrush _errorCountColor = Brushes.White;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(IsComplete))]
    private bool _isIndexing = true;

    [ObservableProperty]
    private bool _isCancelled;

    public bool IsComplete => !IsIndexing;

    #endregion

    public IndexingProgressViewModel(
        IIndexingPipeline pipeline,
        string workspacePath,
        bool fullReindex,
        ILogger<IndexingProgressViewModel> logger)
    {
        _pipeline = pipeline;
        _workspacePath = workspacePath;
        _fullReindex = fullReindex;
        _logger = logger;
        WorkspacePath_Display = workspacePath;

        _elapsedTimer = new DispatcherTimer
        {
            Interval = TimeSpan.FromSeconds(1)
        };
        _elapsedTimer.Tick += (_, _) => UpdateElapsedTime();
    }

    public async Task StartAsync()
    {
        _logger.LogInformation("Starting indexing for {Path}, FullReindex={Full}",
            _workspacePath, _fullReindex);

        _cts = new CancellationTokenSource();
        _stopwatch.Start();
        _elapsedTimer.Start();

        var progress = new Progress<IndexingProgress>(OnProgressUpdate);

        try
        {
            var result = _fullReindex
                ? await _pipeline.IndexWorkspaceAsync(_workspacePath, progress, _cts.Token)
                : await _pipeline.UpdateChangedAsync(_workspacePath, progress, _cts.Token);

            OnIndexingComplete(result);
        }
        catch (OperationCanceledException)
        {
            OnIndexingCancelled();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Indexing failed");
            OnIndexingError(ex);
        }
        finally
        {
            _stopwatch.Stop();
            _elapsedTimer.Stop();
            IsIndexing = false;
        }
    }

    private void OnProgressUpdate(IndexingProgress progress)
    {
        Dispatcher.UIThread.Post(() =>
        {
            ProgressPercent = progress.PercentComplete;
            StatusText = $"Processing file {progress.CurrentFileIndex} of {progress.TotalFiles}...";
            CurrentFile = progress.CurrentFilePath ?? string.Empty;
            FilesProcessed = progress.FilesProcessed;
            ChunksCreated = progress.ChunksCreated;
            FilesSkipped = progress.FilesSkipped;
            ErrorCount = progress.Errors;
            ErrorCountColor = progress.Errors > 0 ? Brushes.Tomato : Brushes.White;
        });
    }

    private void OnIndexingComplete(IndexingResult result)
    {
        StatusText = result.Success ? "Indexing complete!" : "Indexing completed with errors";
        _logger.LogInformation("Indexing complete: {Files} files, {Chunks} chunks",
            result.FilesProcessed, result.ChunksCreated);
    }

    private void OnIndexingCancelled()
    {
        IsCancelled = true;
        StatusText = "Indexing cancelled";
        _logger.LogWarning("Indexing cancelled by user");
    }

    private void OnIndexingError(Exception ex)
    {
        StatusText = $"Error: {ex.Message}";
        ErrorCount++;
        ErrorCountColor = Brushes.Tomato;
    }

    private void UpdateElapsedTime()
    {
        ElapsedTime = _stopwatch.Elapsed.ToString(@"hh\:mm\:ss");
    }

    [RelayCommand]
    private void Cancel()
    {
        _logger.LogDebug("Cancellation requested");
        _cts?.Cancel();
        StatusText = "Cancelling...";
    }

    [RelayCommand]
    private void Close()
    {
        CloseRequested?.Invoke(this, EventArgs.Empty);
    }
}
```

---

## Unit Test Requirements

**File**: `tests/AIntern.Desktop.Tests/ViewModels/IndexingProgressViewModelTests.cs`

| Test | Description |
|------|-------------|
| `StartAsync_StartsStopwatchAndTimer` | Verify timing starts |
| `StartAsync_CallsPipelineWithProgress` | Verify pipeline invoked |
| `OnProgressUpdate_UpdatesAllProperties` | Verify UI properties updated |
| `OnProgressUpdate_SetsErrorColorWhenErrorsExist` | Verify error highlighting |
| `CancelCommand_RequestsCancellation` | Verify cancellation token triggered |
| `CancelCommand_UpdatesStatusText` | Verify "Cancelling..." displayed |
| `OnIndexingComplete_SetsSuccessMessage` | Verify completion message |
| `OnIndexingCancelled_SetsIsCancelledTrue` | Verify cancelled state |
| `IsComplete_TrueWhenNotIndexing` | Verify computed property |
| `Close_RaisesCloseRequestedEvent` | Verify dialog close |

---

## Acceptance Criteria

- [ ] Dialog shows workspace path in header
- [ ] Progress bar updates in real-time via binding
- [ ] Percentage displays next to progress bar
- [ ] Status text shows "Processing file X of Y..."
- [ ] Current file path displays with monospace font
- [ ] Elapsed time updates every second
- [ ] Statistics grid shows Processed/Chunks/Skipped/Errors
- [ ] Error count turns red when errors > 0
- [ ] Cancel button visible during indexing
- [ ] Close button visible after completion
- [ ] Cancellation stops pipeline and updates UI
- [ ] Dialog auto-starts indexing on open
- [ ] Unit tests achieve >90% coverage

---

## Changelog Entry

```markdown
## v0.7.5d - Indexing Progress Dialog

### Added

- `IndexingProgressDialog.axaml` with:
  - Header showing "Indexing Workspace" and path
  - ProgressBar with percentage display
  - Status text and current file path
  - Elapsed time with live updates
  - Statistics grid (Processed, Chunks, Skipped, Errors)
  - Cancel/Close footer buttons
- `IndexingProgressDialog.axaml.cs` with:
  - Auto-start indexing on `OnOpened`
  - CloseRequested event handling
- `IndexingProgressViewModel` with:
  - `IProgress<IndexingProgress>` integration
  - Real-time property updates via Dispatcher
  - Stopwatch and DispatcherTimer for elapsed time
  - Cancellation support via CancellationTokenSource
  - Error highlighting (Tomato color when errors > 0)
  - Cancel and Close commands
```
