# Design Specification: AIntern v0.7.5c "Index Manager ViewModel"

## Overview

**Version**: v0.7.5c  
**Parent**: v0.7.5 UI & Integration  
**Focus**: ViewModel for Index Manager dialog with commands and property change notifications

### Purpose

This sub-version creates the ViewModel backing the Index Manager dialog:
1. `IndexManagerViewModel.cs` - Main ViewModel with observable properties, commands, and business logic
2. `PatternEditorViewModel.cs` - ViewModel for the pattern editor dialog

### Dependencies

**From v0.7.5a**: `RagSettings`, `WorkspaceIndexInfo`, `IRagSettingsService`  
**From v0.7.5b**: `IndexManagerDialog`, `PatternEditorDialog`  
**From v0.7.2**: `IVectorStore` for index statistics  
**From v0.7.1**: `IEmbeddingService` for model info  
**From CommunityToolkit.Mvvm**: `ObservableObject`, `RelayCommand`

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    v0.7.5c Index Manager ViewModel Architecture              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  IndexManagerViewModel : ObservableObject                                │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  Dependencies (Injected):                                                │ │
│  │  ├── IRagSettingsService _settingsService                               │ │
│  │  ├── IVectorStore _vectorStore                                          │ │
│  │  ├── IEmbeddingService _embeddingService                                │ │
│  │  └── ILogger<IndexManagerViewModel> _logger                             │ │
│  │                                                                          │ │
│  │  Observable Properties:                                                  │ │
│  │  ├── WorkspacePath, EmbeddingModelPath                                  │ │
│  │  ├── StatusColor, StatusText, IsIndexed                                 │ │
│  │  ├── FileCount, ChunkCount, IndexSize, LastUpdatedText                  │ │
│  │  ├── EmbeddingDimension, MaxTokens, IsModelLoaded, IsLoadingModel       │ │
│  │  ├── AutoIndexEnabled, RespectGitignore, IndexHiddenFiles               │ │
│  │  ├── ChunkSize, ChunkOverlap, MaxFileSizeKb                             │ │
│  │  ├── IncludePatterns, ExcludePatterns                                   │ │
│  │  ├── HasValidationErrors, ValidationErrorMessage                        │ │
│  │  └── CanStartIndexing                                                   │ │
│  │                                                                          │ │
│  │  Commands:                                                               │ │
│  │  ├── BrowseWorkspaceCommand, BrowseEmbeddingModelCommand                │ │
│  │  ├── EditPatternsCommand                                                │ │
│  │  ├── ReindexAllCommand, UpdateChangedCommand, ClearIndexCommand        │ │
│  │  └── SaveCommand, CancelCommand                                         │ │
│  │                                                                          │ │
│  │  Events:                                                                 │ │
│  │  └── CloseRequested : EventHandler<bool>                                │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  PatternEditorViewModel : ObservableObject                               │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  Properties: IncludePatterns, ExcludePatterns                           │ │
│  │  Commands: AddCommonIncludesCommand, ClearIncludesCommand               │ │
│  │            AddCommonExcludesCommand, ClearExcludesCommand               │ │
│  │            ApplyCommand, CancelCommand                                  │ │
│  │  Events: CloseRequested, PatternsApplied                                │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. IndexManagerViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/IndexManagerViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using System.Collections.ObjectModel;
using Avalonia.Media;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Microsoft.Extensions.Logging;
using AIntern.Core.RAG.Settings;
using AIntern.Core.RAG.Storage;
using AIntern.Core.RAG.Embedding;

/// <summary>
/// ViewModel for the Index Manager dialog.
/// Manages RAG settings, index status, and indexing operations.
/// </summary>
public partial class IndexManagerViewModel : ObservableObject
{
    #region Dependencies

    private readonly IRagSettingsService _settingsService;
    private readonly IVectorStore _vectorStore;
    private readonly IEmbeddingService _embeddingService;
    private readonly ILogger<IndexManagerViewModel> _logger;

    #endregion

    #region Events

    /// <summary>
    /// Raised when the dialog should close.
    /// </summary>
    public event EventHandler<bool>? CloseRequested;

    #endregion

    #region Observable Properties - Workspace

    [ObservableProperty]
    [NotifyCanExecuteChangedFor(nameof(ReindexAllCommand))]
    [NotifyCanExecuteChangedFor(nameof(UpdateChangedCommand))]
    private string _workspacePath = string.Empty;

    #endregion

    #region Observable Properties - Index Status

    [ObservableProperty]
    private IBrush _statusColor = Brushes.Gray;

    [ObservableProperty]
    private string _statusText = "Not Indexed";

    [ObservableProperty]
    [NotifyCanExecuteChangedFor(nameof(ClearIndexCommand))]
    private bool _isIndexed;

    [ObservableProperty]
    private int _fileCount;

    [ObservableProperty]
    private int _chunkCount;

    [ObservableProperty]
    private string _indexSize = "0 KB";

    [ObservableProperty]
    private string _lastUpdatedText = string.Empty;

    #endregion

    #region Observable Properties - Embedding Model

    [ObservableProperty]
    [NotifyCanExecuteChangedFor(nameof(ReindexAllCommand))]
    [NotifyCanExecuteChangedFor(nameof(UpdateChangedCommand))]
    private string _embeddingModelPath = string.Empty;

    [ObservableProperty]
    private int _embeddingDimension;

    [ObservableProperty]
    private int _maxTokens;

    [ObservableProperty]
    private bool _isModelLoaded;

    [ObservableProperty]
    private bool _isLoadingModel;

    #endregion

    #region Observable Properties - Index Options

    [ObservableProperty]
    private bool _autoIndexEnabled = true;

    [ObservableProperty]
    private bool _respectGitignore = true;

    [ObservableProperty]
    private bool _indexHiddenFiles;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(HasValidationErrors))]
    [NotifyPropertyChangedFor(nameof(ValidationErrorMessage))]
    private int _chunkSize = 512;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(HasValidationErrors))]
    [NotifyPropertyChangedFor(nameof(ValidationErrorMessage))]
    private int _chunkOverlap = 64;

    [ObservableProperty]
    private int _maxFileSizeKb = 1024;

    #endregion

    #region Observable Properties - File Filters

    [ObservableProperty]
    private string _includePatterns = string.Empty;

    [ObservableProperty]
    private string _excludePatterns = string.Empty;

    #endregion

    #region Observable Properties - Validation

    public bool HasValidationErrors => !string.IsNullOrEmpty(ValidationErrorMessage);

    public string ValidationErrorMessage
    {
        get
        {
            if (ChunkOverlap >= ChunkSize)
                return "Chunk overlap must be less than chunk size";
            if (ChunkSize < 100 || ChunkSize > 2000)
                return "Chunk size must be between 100 and 2000";
            return string.Empty;
        }
    }

    #endregion

    #region Computed Properties

    public bool CanStartIndexing =>
        !string.IsNullOrEmpty(WorkspacePath) &&
        !string.IsNullOrEmpty(EmbeddingModelPath) &&
        IsModelLoaded &&
        !HasValidationErrors;

    #endregion

    #region Constructor

    public IndexManagerViewModel(
        IRagSettingsService settingsService,
        IVectorStore vectorStore,
        IEmbeddingService embeddingService,
        ILogger<IndexManagerViewModel> logger)
    {
        _settingsService = settingsService;
        _vectorStore = vectorStore;
        _embeddingService = embeddingService;
        _logger = logger;
    }

    #endregion

    #region Initialization

    /// <summary>
    /// Load current settings and index status.
    /// </summary>
    public async Task InitializeAsync()
    {
        _logger.LogDebug("Initializing IndexManagerViewModel");

        try
        {
            var settings = await _settingsService.GetSettingsAsync();
            LoadFromSettings(settings);
            await RefreshIndexStatusAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to initialize IndexManagerViewModel");
        }
    }

    private void LoadFromSettings(RagSettings settings)
    {
        WorkspacePath = settings.LastWorkspacePath ?? string.Empty;
        EmbeddingModelPath = settings.EmbeddingModelPath ?? string.Empty;
        AutoIndexEnabled = settings.AutoIndexEnabled;
        RespectGitignore = settings.RespectGitignore;
        IndexHiddenFiles = settings.IndexHiddenFiles;
        ChunkSize = settings.ChunkSize;
        ChunkOverlap = settings.ChunkOverlap;
        MaxFileSizeKb = settings.MaxFileSizeKb;
        IncludePatterns = string.Join(", ", settings.IncludePatterns);
        ExcludePatterns = string.Join(", ", settings.ExcludePatterns);
    }

    #endregion

    #region Commands - Browse

    [RelayCommand]
    private async Task BrowseWorkspaceAsync()
    {
        _logger.LogDebug("Opening folder browser for workspace");
        // Implementation delegates to dialog service (v0.7.5d)
    }

    [RelayCommand]
    private async Task BrowseEmbeddingModelAsync()
    {
        _logger.LogDebug("Opening file browser for embedding model");
        // Implementation delegates to dialog service (v0.7.5d)
    }

    #endregion

    #region Commands - Patterns

    [RelayCommand]
    private async Task EditPatternsAsync()
    {
        _logger.LogDebug("Opening pattern editor dialog");
        // Implementation opens PatternEditorDialog (v0.7.5d)
    }

    #endregion

    #region Commands - Index Operations

    [RelayCommand(CanExecute = nameof(CanStartIndexing))]
    private async Task ReindexAllAsync()
    {
        _logger.LogInformation("Starting full reindex for {Path}", WorkspacePath);
        // Implementation triggers indexing pipeline (v0.7.5d)
    }

    [RelayCommand(CanExecute = nameof(CanStartIndexing))]
    private async Task UpdateChangedAsync()
    {
        _logger.LogInformation("Updating changed files for {Path}", WorkspacePath);
        // Implementation triggers incremental indexing (v0.7.5d)
    }

    [RelayCommand(CanExecute = nameof(IsIndexed))]
    private async Task ClearIndexAsync()
    {
        _logger.LogWarning("Clearing index for {Path}", WorkspacePath);
        // Implementation clears vector store (v0.7.5d)
    }

    #endregion

    #region Commands - Dialog

    [RelayCommand]
    private async Task SaveAsync()
    {
        _logger.LogDebug("Saving RAG settings");

        try
        {
            var settings = BuildSettings();
            var errors = settings.Validate();
            
            if (errors.Count > 0)
            {
                _logger.LogWarning("Settings validation failed: {Errors}", 
                    string.Join(", ", errors));
                return;
            }

            await _settingsService.SaveSettingsAsync(settings);
            CloseRequested?.Invoke(this, true);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to save settings");
        }
    }

    [RelayCommand]
    private void Cancel()
    {
        _logger.LogDebug("Cancelling Index Manager dialog");
        CloseRequested?.Invoke(this, false);
    }

    #endregion

    #region Private Methods

    private RagSettings BuildSettings()
    {
        return new RagSettings
        {
            LastWorkspacePath = WorkspacePath,
            EmbeddingModelPath = EmbeddingModelPath,
            AutoIndexEnabled = AutoIndexEnabled,
            RespectGitignore = RespectGitignore,
            IndexHiddenFiles = IndexHiddenFiles,
            ChunkSize = ChunkSize,
            ChunkOverlap = ChunkOverlap,
            MaxFileSizeKb = MaxFileSizeKb,
            IncludePatterns = ParsePatterns(IncludePatterns),
            ExcludePatterns = ParsePatterns(ExcludePatterns)
        };
    }

    private static List<string> ParsePatterns(string patternsText)
    {
        return patternsText
            .Split(new[] { ',', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(p => p.Trim())
            .Where(p => !string.IsNullOrEmpty(p))
            .ToList();
    }

    private async Task RefreshIndexStatusAsync()
    {
        if (string.IsNullOrEmpty(WorkspacePath))
        {
            UpdateStatusNotIndexed();
            return;
        }

        try
        {
            var info = await _vectorStore.GetIndexInfoAsync(WorkspacePath);
            if (info != null)
            {
                UpdateStatusIndexed(info);
            }
            else
            {
                UpdateStatusNotIndexed();
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get index status");
            UpdateStatusError();
        }
    }

    private void UpdateStatusIndexed(WorkspaceIndexInfo info)
    {
        IsIndexed = true;
        StatusColor = Brushes.LimeGreen;
        StatusText = "Indexed";
        FileCount = info.FileCount;
        ChunkCount = info.ChunkCount;
        IndexSize = info.FormattedSize;
        LastUpdatedText = $"Last updated: {info.FormattedLastUpdate}";
    }

    private void UpdateStatusNotIndexed()
    {
        IsIndexed = false;
        StatusColor = Brushes.Gray;
        StatusText = "Not Indexed";
        FileCount = 0;
        ChunkCount = 0;
        IndexSize = "0 KB";
        LastUpdatedText = string.Empty;
    }

    private void UpdateStatusError()
    {
        IsIndexed = false;
        StatusColor = Brushes.Tomato;
        StatusText = "Error";
    }

    #endregion
}
```

---

### 2. PatternEditorViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/PatternEditorViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using AIntern.Core.RAG.Settings;

/// <summary>
/// ViewModel for the Pattern Editor dialog.
/// </summary>
public partial class PatternEditorViewModel : ObservableObject
{
    #region Events

    public event EventHandler<bool>? CloseRequested;
    public event EventHandler<(List<string> Include, List<string> Exclude)>? PatternsApplied;

    #endregion

    #region Observable Properties

    [ObservableProperty]
    private string _includePatterns = string.Empty;

    [ObservableProperty]
    private string _excludePatterns = string.Empty;

    #endregion

    #region Constructor

    public PatternEditorViewModel(List<string> includePatterns, List<string> excludePatterns)
    {
        IncludePatterns = string.Join(Environment.NewLine, includePatterns);
        ExcludePatterns = string.Join(Environment.NewLine, excludePatterns);
    }

    #endregion

    #region Commands - Include

    [RelayCommand]
    private void AddCommonIncludes()
    {
        var common = RagSettings.Default.IncludePatterns;
        IncludePatterns = string.Join(Environment.NewLine, common);
    }

    [RelayCommand]
    private void ClearIncludes()
    {
        IncludePatterns = string.Empty;
    }

    #endregion

    #region Commands - Exclude

    [RelayCommand]
    private void AddCommonExcludes()
    {
        var common = RagSettings.Default.ExcludePatterns;
        ExcludePatterns = string.Join(Environment.NewLine, common);
    }

    [RelayCommand]
    private void ClearExcludes()
    {
        ExcludePatterns = string.Empty;
    }

    #endregion

    #region Commands - Dialog

    [RelayCommand]
    private void Apply()
    {
        var include = ParsePatterns(IncludePatterns);
        var exclude = ParsePatterns(ExcludePatterns);
        PatternsApplied?.Invoke(this, (include, exclude));
        CloseRequested?.Invoke(this, true);
    }

    [RelayCommand]
    private void Cancel()
    {
        CloseRequested?.Invoke(this, false);
    }

    #endregion

    #region Private Methods

    private static List<string> ParsePatterns(string text)
    {
        return text
            .Split(new[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(p => p.Trim())
            .Where(p => !string.IsNullOrEmpty(p))
            .ToList();
    }

    #endregion
}
```

---

## Data Binding Summary

| ViewModel Property | UI Element | Binding Mode |
|-------------------|------------|--------------|
| `WorkspacePath` | Workspace TextBox | TwoWay |
| `StatusColor` | Status Ellipse Fill | OneWay |
| `StatusText` | Status TextBlock | OneWay |
| `IsIndexed` | Statistics Grid Visibility | OneWay |
| `FileCount` | Files TextBlock | OneWay |
| `ChunkCount` | Chunks TextBlock | OneWay |
| `IndexSize` | Size TextBlock | OneWay |
| `LastUpdatedText` | Last Updated TextBlock | OneWay |
| `EmbeddingModelPath` | Model TextBox | TwoWay |
| `EmbeddingDimension` | Dimension TextBlock | OneWay |
| `MaxTokens` | Max Tokens TextBlock | OneWay |
| `IsModelLoaded` | Model Info Visibility | OneWay |
| `IsLoadingModel` | Loading Spinner Visibility | OneWay |
| `AutoIndexEnabled` | Auto-Index CheckBox | TwoWay |
| `RespectGitignore` | Gitignore CheckBox | TwoWay |
| `IndexHiddenFiles` | Hidden Files CheckBox | TwoWay |
| `ChunkSize` | Chunk Size NumericUpDown | TwoWay |
| `ChunkOverlap` | Overlap NumericUpDown | TwoWay |
| `MaxFileSizeKb` | Max File NumericUpDown | TwoWay |
| `IncludePatterns` | Include TextBox | TwoWay |
| `ExcludePatterns` | Exclude TextBox | TwoWay |
| `HasValidationErrors` | Error Panel Visibility | OneWay |
| `ValidationErrorMessage` | Error TextBlock | OneWay |

---

## Unit Test Requirements

**File**: `tests/AIntern.Desktop.Tests/ViewModels/IndexManagerViewModelTests.cs`

| Test | Description |
|------|-------------|
| `InitializeAsync_LoadsSettingsFromService` | Verify settings loaded on init |
| `InitializeAsync_RefreshesIndexStatus` | Verify index info loaded |
| `SaveCommand_BuildsSettingsCorrectly` | Verify settings object built |
| `SaveCommand_ValidatesBeforeSave` | Verify validation errors prevent save |
| `SaveCommand_InvokesCloseRequested` | Verify dialog closes on save |
| `CancelCommand_InvokesCloseRequested` | Verify dialog closes on cancel |
| `ValidationErrorMessage_ChunkOverlapTooLarge` | Verify overlap validation |
| `ValidationErrorMessage_ChunkSizeOutOfRange` | Verify size validation |
| `CanStartIndexing_RequiresWorkspacePath` | Verify prerequisite check |
| `CanStartIndexing_RequiresModelLoaded` | Verify model check |
| `ParsePatterns_SplitsOnCommaAndNewline` | Verify pattern parsing |
| `UpdateStatusIndexed_SetsCorrectValues` | Verify indexed status display |
| `UpdateStatusNotIndexed_ResetsValues` | Verify not indexed display |

**File**: `tests/AIntern.Desktop.Tests/ViewModels/PatternEditorViewModelTests.cs`

| Test | Description |
|------|-------------|
| `Constructor_LoadsPatternsFromLists` | Verify initial load |
| `AddCommonIncludes_SetsDefaultPatterns` | Verify common patterns |
| `ClearIncludes_EmptiesPatterns` | Verify clear operation |
| `Apply_ParsesPatternsAndRaisesEvent` | Verify apply logic |
| `Cancel_RaisesCloseRequested` | Verify cancel logic |

---

## Acceptance Criteria

- [ ] `IndexManagerViewModel` extends `ObservableObject`
- [ ] All observable properties use `[ObservableProperty]` attribute
- [ ] Commands use `[RelayCommand]` with appropriate `CanExecute`
- [ ] `InitializeAsync` loads settings and refreshes index status
- [ ] `SaveCommand` validates and saves settings via service
- [ ] `CloseRequested` event raised on Save/Cancel
- [ ] Validation errors prevent saving and display message
- [ ] Status colors correctly reflect index state
- [ ] `PatternEditorViewModel` handles add common/clear operations
- [ ] Pattern parsing handles comma and newline separators
- [ ] Unit tests achieve >90% coverage

---

## Changelog Entry

```markdown
## v0.7.5c - Index Manager ViewModel

### Added

- `IndexManagerViewModel` with:
  - Observable properties for workspace, status, model, options, filters
  - `InitializeAsync()` for loading settings and index status
  - Browse commands for workspace and model selection
  - Index operation commands (ReindexAll, UpdateChanged, ClearIndex)
  - Save/Cancel dialog commands with validation
  - `CloseRequested` event for dialog lifecycle
  - Real-time validation with `HasValidationErrors` and `ValidationErrorMessage`
  - Status color updates (LimeGreen, Gray, Tomato)
- `PatternEditorViewModel` with:
  - Include/Exclude pattern text properties
  - AddCommon/Clear commands for quick pattern management
  - Apply/Cancel commands with `PatternsApplied` event
  - Pattern parsing (comma and newline delimited)
```
