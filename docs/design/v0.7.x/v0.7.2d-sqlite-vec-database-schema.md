# Design Specification: AIntern v0.7.2d "SQLite-vec Database Schema"

## Overview

**Version**: v0.7.2d
**Parent**: v0.7.2 Vector Storage
**Focus**: Define the database schema for SQLite-vec, including vector tables, metadata tables, and indexes

### Purpose

Define the complete database schema for vector storage:
1. Create `VectorStoreSchema` static class with SQL schema definitions
2. Create `VectorStoreMigrations` class for schema versioning and migrations
3. Define tables: schema_version, vector_indexes, indexed_files, chunk_metadata, search_history
4. Define vector virtual table template for sqlite-vec
5. Provide schema creation and migration utilities

### Dependencies

**From v0.7.2a-c (Models)**:
- `VectorIndex` → `vector_indexes` table
- `IndexedFile` → `indexed_files` table
- `StoredChunk` → `chunk_metadata` table
- `VectorSearchOptions` → `search_history.search_options_json`

**External Dependencies**:
- `Microsoft.Data.Sqlite` - SQLite database access
- `sqlite-vec` extension - Vector similarity operations

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      v0.7.2d SQLite-vec Database Schema                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Database Layout:                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  vectorstore.db                                                          │ │
│  │  ├── schema_version          ← Migration tracking                       │ │
│  │  ├── vector_indexes          ← Index metadata                           │ │
│  │  ├── indexed_files           ← File tracking                            │ │
│  │  ├── chunk_metadata          ← Chunk content & metadata                 │ │
│  │  ├── search_history          ← Search analytics                         │ │
│  │  └── vectors_{index_id}      ← Virtual table per index (sqlite-vec)     │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Table Relationships:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  vector_indexes                                                          │ │
│  │       │ 1                                                                │ │
│  │       │                                                                  │ │
│  │       ├──────── N │ indexed_files                                       │ │
│  │       │                 │ 1                                              │ │
│  │       │                 │                                                │ │
│  │       │                 └──────── N │ chunk_metadata                    │ │
│  │       │                                    │                             │ │
│  │       │                                    │ 1:1                         │ │
│  │       │                                    │                             │ │
│  │       │                              vectors_{id}                        │ │
│  │       │                              (embedding data)                    │ │
│  │       │                                                                  │ │
│  │       └──────── N │ search_history                                      │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Schema Version Strategy

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Schema Versioning & Migration                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Migration Flow:                                                             │
│                                                                              │
│  App Start                                                                   │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  VectorStoreMigrations.MigrateAsync()                                    │ │
│  │       │                                                                  │ │
│  │       ▼                                                                  │ │
│  │  GetCurrentVersionAsync()                                                │ │
│  │       │                                                                  │ │
│  │       ├── schema_version exists?                                         │ │
│  │       │       │                                                          │ │
│  │       │       ├── NO ──▶ CreateSchemaAsync()                            │ │
│  │       │       │           └── Create all tables                          │ │
│  │       │       │           └── Record version 1                           │ │
│  │       │       │                                                          │ │
│  │       │       └── YES ─▶ Get MAX(version)                               │ │
│  │       │                       │                                          │ │
│  │       │                       ▼                                          │ │
│  │       │               Current < Target?                                  │ │
│  │       │                       │                                          │ │
│  │       │                       ├── YES ─▶ ApplyMigrationsAsync()         │ │
│  │       │                       │           └── Run V1→V2, V2→V3, etc.    │ │
│  │       │                       │           └── Record each version        │ │
│  │       │                       │                                          │ │
│  │       │                       └── NO ──▶ Schema up to date              │ │
│  │       │                                                                  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Version History (schema_version table):                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  version │ applied_at           │ description                           │ │
│  │  ────────│──────────────────────│──────────────────────────────────────  │ │
│  │  1       │ 2026-01-17 12:00:00  │ Initial schema                        │ │
│  │  2       │ (future)             │ Added full-text search                │ │
│  │  3       │ (future)             │ Added index compression               │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Table Specifications

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           Table: schema_version                               │
├──────────────────────────────────────────────────────────────────────────────┤
│  Purpose: Track database schema versions for migrations                       │
│                                                                              │
│  Columns:                                                                     │
│  ┌────────────┬──────────────┬───────────────────────────────────────────┐  │
│  │ Column     │ Type         │ Description                                │  │
│  │ ───────────│──────────────│───────────────────────────────────────────│  │
│  │ version    │ INTEGER (PK) │ Schema version number                      │  │
│  │ applied_at │ TEXT         │ When migration was applied (datetime)      │  │
│  │ description│ TEXT         │ Human-readable migration description       │  │
│  └────────────┴──────────────┴───────────────────────────────────────────┘  │
│                                                                              │
│  Indexes: None needed (small table, version is PK)                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                           Table: vector_indexes                               │
├──────────────────────────────────────────────────────────────────────────────┤
│  Purpose: Store metadata for each vector index (one per workspace)           │
│                                                                              │
│  Columns:                                                                     │
│  ┌────────────────────────────┬──────────────┬───────────────────────────┐  │
│  │ Column                     │ Type         │ Description                │  │
│  │ ───────────────────────────│──────────────│───────────────────────────│  │
│  │ id                         │ TEXT (PK)    │ GUID identifier            │  │
│  │ name                       │ TEXT NOT NULL│ Human-readable name        │  │
│  │ workspace_path             │ TEXT UNIQUE  │ Absolute workspace path    │  │
│  │ created_at                 │ TEXT         │ Creation timestamp         │  │
│  │ updated_at                 │ TEXT         │ Last modification          │  │
│  │ embedding_model            │ TEXT NOT NULL│ Model name/path            │  │
│  │ embedding_dimension        │ INTEGER      │ Vector dimension (384,768) │  │
│  │ chunk_count                │ INTEGER      │ Total chunks in index      │  │
│  │ file_count                 │ INTEGER      │ Total files indexed        │  │
│  │ total_file_size_bytes      │ INTEGER      │ Sum of file sizes          │  │
│  │ status                     │ TEXT         │ IndexStatus enum value     │  │
│  │ settings_json              │ TEXT         │ VectorIndexSettings JSON   │  │
│  │ schema_version             │ INTEGER      │ Index schema version       │  │
│  │ description                │ TEXT         │ User notes                 │  │
│  │ last_error                 │ TEXT         │ Last error message         │  │
│  │ last_full_index_at         │ TEXT         │ Last full rebuild          │  │
│  │ last_incremental_update_at │ TEXT         │ Last incremental update    │  │
│  └────────────────────────────┴──────────────┴───────────────────────────┘  │
│                                                                              │
│  Indexes:                                                                     │
│  • idx_vector_indexes_workspace ON (workspace_path)                          │
│  • idx_vector_indexes_status ON (status)                                     │
│                                                                              │
│  Constraints:                                                                 │
│  • workspace_path is UNIQUE (only one index per workspace)                   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                           Table: indexed_files                                │
├──────────────────────────────────────────────────────────────────────────────┤
│  Purpose: Track files that have been indexed and their hashes                │
│                                                                              │
│  Columns:                                                                     │
│  ┌─────────────────────┬──────────────┬───────────────────────────────────┐ │
│  │ Column              │ Type         │ Description                        │ │
│  │ ────────────────────│──────────────│─────────────────────────────────── │ │
│  │ id                  │ TEXT (PK)    │ GUID identifier                    │ │
│  │ index_id            │ TEXT (FK)    │ Reference to vector_indexes        │ │
│  │ file_path           │ TEXT NOT NULL│ Relative path in workspace         │ │
│  │ file_hash           │ TEXT NOT NULL│ SHA-256 content hash               │ │
│  │ file_size           │ INTEGER      │ File size in bytes                 │ │
│  │ last_modified       │ TEXT         │ File modification timestamp        │ │
│  │ indexed_at          │ TEXT         │ When file was indexed              │ │
│  │ chunk_count         │ INTEGER      │ Number of chunks from file         │ │
│  │ language            │ TEXT         │ Detected language                  │ │
│  │ encoding            │ TEXT         │ File encoding (UTF-8, etc.)        │ │
│  │ line_count          │ INTEGER      │ Total lines in file                │ │
│  │ status              │ TEXT         │ FileIndexStatus enum value         │ │
│  │ error_message       │ TEXT         │ Error details if failed            │ │
│  │ indexing_duration_ms│ INTEGER      │ Processing time in ms              │ │
│  └─────────────────────┴──────────────┴───────────────────────────────────┘ │
│                                                                              │
│  Indexes:                                                                     │
│  • idx_indexed_files_index ON (index_id)                                     │
│  • idx_indexed_files_hash ON (file_hash)                                     │
│  • idx_indexed_files_path ON (file_path)                                     │
│  • idx_indexed_files_status ON (status)                                      │
│                                                                              │
│  Constraints:                                                                 │
│  • FOREIGN KEY (index_id) REFERENCES vector_indexes(id) ON DELETE CASCADE   │
│  • UNIQUE(index_id, file_path)                                               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                          Table: chunk_metadata                                │
├──────────────────────────────────────────────────────────────────────────────┤
│  Purpose: Store chunk content and metadata (pairs with vector table)         │
│                                                                              │
│  Columns:                                                                     │
│  ┌─────────────────┬──────────────┬─────────────────────────────────────────┐│
│  │ Column          │ Type         │ Description                              ││
│  │ ────────────────│──────────────│──────────────────────────────────────────││
│  │ id              │ TEXT (PK)    │ GUID, matches vectors_{index_id}.id      ││
│  │ index_id        │ TEXT (FK)    │ Reference to vector_indexes              ││
│  │ file_id         │ TEXT (FK)    │ Reference to indexed_files               ││
│  │ content         │ TEXT NOT NULL│ The actual text content                  ││
│  │ start_line      │ INTEGER      │ Starting line (1-based)                  ││
│  │ end_line        │ INTEGER      │ Ending line (1-based)                    ││
│  │ start_offset    │ INTEGER      │ Character offset from file start         ││
│  │ end_offset      │ INTEGER      │ End character offset                     ││
│  │ chunk_type      │ TEXT         │ ChunkType enum value                     ││
│  │ language        │ TEXT         │ Programming language                     ││
│  │ symbol_name     │ TEXT         │ Function/class name if applicable        ││
│  │ symbol_type     │ TEXT         │ SymbolType enum value                    ││
│  │ parent_symbol   │ TEXT         │ Containing class/module                  ││
│  │ token_count     │ INTEGER      │ Approximate token count                  ││
│  │ indexed_at      │ TEXT         │ When chunk was created                   ││
│  └─────────────────┴──────────────┴─────────────────────────────────────────┘│
│                                                                              │
│  Indexes:                                                                     │
│  • idx_chunk_metadata_index ON (index_id)                                    │
│  • idx_chunk_metadata_file ON (file_id)                                      │
│  • idx_chunk_metadata_symbol ON (symbol_name)                                │
│  • idx_chunk_metadata_type ON (chunk_type)                                   │
│  • idx_chunk_metadata_language ON (language)                                 │
│  • idx_chunk_metadata_symbol_type ON (symbol_type)                           │
│                                                                              │
│  Constraints:                                                                 │
│  • FOREIGN KEY (index_id) REFERENCES vector_indexes(id) ON DELETE CASCADE   │
│  • FOREIGN KEY (file_id) REFERENCES indexed_files(id) ON DELETE CASCADE     │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                    Virtual Table: vectors_{index_id}                          │
├──────────────────────────────────────────────────────────────────────────────┤
│  Purpose: Store embedding vectors using sqlite-vec extension                 │
│                                                                              │
│  Definition (per index):                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  CREATE VIRTUAL TABLE vectors_{sanitized_index_id} USING vec0(          │ │
│  │      id TEXT PRIMARY KEY,                                                │ │
│  │      embedding FLOAT[{dimension}]                                        │ │
│  │  );                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Columns:                                                                     │
│  ┌─────────────┬──────────────────────┬──────────────────────────────────┐  │
│  │ Column      │ Type                 │ Description                       │  │
│  │ ────────────│──────────────────────│──────────────────────────────────│  │
│  │ id          │ TEXT (PK)            │ Matches chunk_metadata.id         │  │
│  │ embedding   │ FLOAT[dimension]     │ Vector data (384, 768, etc.)      │  │
│  └─────────────┴──────────────────────┴──────────────────────────────────┘  │
│                                                                              │
│  Notes:                                                                       │
│  • One virtual table per index (isolated vector spaces)                      │
│  • {index_id} is sanitized to be SQL-safe (alphanumeric + underscore)       │
│  • {dimension} matches the index's embedding_dimension                       │
│  • Supports vec0 similarity search operations                                │
│                                                                              │
│  Example queries:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  -- Insert vector                                                        │ │
│  │  INSERT INTO vectors_abc123 (id, embedding)                              │ │
│  │  VALUES ('chunk1', vec_f32('[0.1, 0.2, ...]'));                          │ │
│  │                                                                          │ │
│  │  -- Search similar vectors                                               │ │
│  │  SELECT id, distance                                                     │ │
│  │  FROM vectors_abc123                                                     │ │
│  │  WHERE embedding MATCH vec_f32('[0.1, 0.2, ...]')                        │ │
│  │  ORDER BY distance                                                       │ │
│  │  LIMIT 10;                                                               │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                          Table: search_history                                │
├──────────────────────────────────────────────────────────────────────────────┤
│  Purpose: Track search queries for analytics and debugging                   │
│                                                                              │
│  Columns:                                                                     │
│  ┌───────────────────┬──────────────┬────────────────────────────────────┐  │
│  │ Column            │ Type         │ Description                         │  │
│  │ ──────────────────│──────────────│────────────────────────────────────│  │
│  │ id                │ TEXT (PK)    │ GUID identifier                     │  │
│  │ index_id          │ TEXT (FK)    │ Reference to vector_indexes         │  │
│  │ query_text        │ TEXT         │ Original query text (optional)      │  │
│  │ result_count      │ INTEGER      │ Number of results returned          │  │
│  │ top_score         │ REAL         │ Highest similarity score            │  │
│  │ search_options_json│ TEXT        │ VectorSearchOptions as JSON         │  │
│  │ duration_ms       │ INTEGER      │ Search execution time               │  │
│  │ searched_at       │ TEXT         │ When search was performed           │  │
│  └───────────────────┴──────────────┴────────────────────────────────────┘  │
│                                                                              │
│  Indexes:                                                                     │
│  • idx_search_history_index ON (index_id)                                    │
│  • idx_search_history_time ON (searched_at)                                  │
│                                                                              │
│  Constraints:                                                                 │
│  • FOREIGN KEY (index_id) REFERENCES vector_indexes(id) ON DELETE CASCADE   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. VectorStoreSchema.cs

**Location**: `src/SeniorIntern.Services/VectorStore/VectorStoreSchema.cs`

```csharp
namespace SeniorIntern.Services.VectorStore;

/// <summary>
/// SQL schema definitions for the vector store database.
/// </summary>
/// <remarks>
/// <para>
/// Defines all table structures, indexes, and constraints for the SQLite-vec
/// vector storage system. Tables are created during initialization and migrated
/// as the schema evolves.
/// </para>
/// <para>
/// Table overview:
/// <list type="bullet">
///   <item><c>schema_version</c> - Migration tracking</item>
///   <item><c>vector_indexes</c> - Index metadata (one per workspace)</item>
///   <item><c>indexed_files</c> - File tracking for change detection</item>
///   <item><c>chunk_metadata</c> - Chunk content and metadata</item>
///   <item><c>vectors_{id}</c> - Virtual tables for embedding storage</item>
///   <item><c>search_history</c> - Query analytics</item>
/// </list>
/// </para>
/// </remarks>
public static class VectorStoreSchema
{
    #region Version

    /// <summary>
    /// Current schema version for migrations.
    /// </summary>
    /// <remarks>
    /// Increment this when adding new tables, columns, or indexes.
    /// Migrations are applied sequentially to bring older databases up to date.
    /// </remarks>
    public const int CurrentSchemaVersion = 1;

    #endregion

    #region Schema Version Table

    /// <summary>
    /// SQL to create the schema version tracking table.
    /// </summary>
    public const string CreateSchemaVersionTable = """
        CREATE TABLE IF NOT EXISTS schema_version (
            version INTEGER PRIMARY KEY,
            applied_at TEXT NOT NULL DEFAULT (datetime('now')),
            description TEXT
        );
        """;

    #endregion

    #region Vector Indexes Table

    /// <summary>
    /// SQL to create the vector indexes metadata table.
    /// </summary>
    /// <remarks>
    /// Stores metadata for each index including:
    /// - Identity (id, name, workspace_path)
    /// - Embedding configuration (model, dimension)
    /// - Statistics (chunk_count, file_count, size)
    /// - Status and settings
    /// </remarks>
    public const string CreateVectorIndexesTable = """
        CREATE TABLE IF NOT EXISTS vector_indexes (
            id TEXT PRIMARY KEY,
            name TEXT NOT NULL,
            workspace_path TEXT NOT NULL UNIQUE,
            created_at TEXT NOT NULL DEFAULT (datetime('now')),
            updated_at TEXT NOT NULL DEFAULT (datetime('now')),
            embedding_model TEXT NOT NULL,
            embedding_dimension INTEGER NOT NULL,
            chunk_count INTEGER DEFAULT 0,
            file_count INTEGER DEFAULT 0,
            total_file_size_bytes INTEGER DEFAULT 0,
            status TEXT NOT NULL DEFAULT 'Active',
            settings_json TEXT,
            schema_version INTEGER DEFAULT 1,
            description TEXT,
            last_error TEXT,
            last_full_index_at TEXT,
            last_incremental_update_at TEXT
        );

        CREATE INDEX IF NOT EXISTS idx_vector_indexes_workspace
            ON vector_indexes(workspace_path);
        CREATE INDEX IF NOT EXISTS idx_vector_indexes_status
            ON vector_indexes(status);
        """;

    #endregion

    #region Indexed Files Table

    /// <summary>
    /// SQL to create the indexed files tracking table.
    /// </summary>
    /// <remarks>
    /// Tracks each file's hash for change detection.
    /// The file_hash column is indexed for efficient comparison.
    /// </remarks>
    public const string CreateIndexedFilesTable = """
        CREATE TABLE IF NOT EXISTS indexed_files (
            id TEXT PRIMARY KEY,
            index_id TEXT NOT NULL,
            file_path TEXT NOT NULL,
            file_hash TEXT NOT NULL,
            file_size INTEGER NOT NULL,
            last_modified TEXT NOT NULL,
            indexed_at TEXT NOT NULL DEFAULT (datetime('now')),
            chunk_count INTEGER DEFAULT 0,
            language TEXT,
            encoding TEXT,
            line_count INTEGER DEFAULT 0,
            status TEXT NOT NULL DEFAULT 'Indexed',
            error_message TEXT,
            indexing_duration_ms INTEGER DEFAULT 0,
            FOREIGN KEY (index_id) REFERENCES vector_indexes(id) ON DELETE CASCADE,
            UNIQUE(index_id, file_path)
        );

        CREATE INDEX IF NOT EXISTS idx_indexed_files_index
            ON indexed_files(index_id);
        CREATE INDEX IF NOT EXISTS idx_indexed_files_hash
            ON indexed_files(file_hash);
        CREATE INDEX IF NOT EXISTS idx_indexed_files_path
            ON indexed_files(file_path);
        CREATE INDEX IF NOT EXISTS idx_indexed_files_status
            ON indexed_files(status);
        """;

    #endregion

    #region Chunk Metadata Table

    /// <summary>
    /// SQL to create the chunk metadata table.
    /// </summary>
    /// <remarks>
    /// <para>
    /// Stores chunk content and metadata. The id column matches the id in the
    /// corresponding vectors_{index_id} virtual table, enabling joins.
    /// </para>
    /// <para>
    /// Content is stored here (not in the vector table) because:
    /// 1. SQLite-vec virtual tables don't support arbitrary columns well
    /// 2. Content retrieval doesn't require vector operations
    /// 3. Allows efficient filtering before vector search
    /// </para>
    /// </remarks>
    public const string CreateChunkMetadataTable = """
        CREATE TABLE IF NOT EXISTS chunk_metadata (
            id TEXT PRIMARY KEY,
            index_id TEXT NOT NULL,
            file_id TEXT NOT NULL,
            content TEXT NOT NULL,
            start_line INTEGER NOT NULL,
            end_line INTEGER NOT NULL,
            start_offset INTEGER NOT NULL,
            end_offset INTEGER NOT NULL,
            chunk_type TEXT NOT NULL,
            language TEXT,
            symbol_name TEXT,
            symbol_type TEXT,
            parent_symbol TEXT,
            token_count INTEGER DEFAULT 0,
            indexed_at TEXT NOT NULL DEFAULT (datetime('now')),
            FOREIGN KEY (index_id) REFERENCES vector_indexes(id) ON DELETE CASCADE,
            FOREIGN KEY (file_id) REFERENCES indexed_files(id) ON DELETE CASCADE
        );

        CREATE INDEX IF NOT EXISTS idx_chunk_metadata_index
            ON chunk_metadata(index_id);
        CREATE INDEX IF NOT EXISTS idx_chunk_metadata_file
            ON chunk_metadata(file_id);
        CREATE INDEX IF NOT EXISTS idx_chunk_metadata_symbol
            ON chunk_metadata(symbol_name);
        CREATE INDEX IF NOT EXISTS idx_chunk_metadata_type
            ON chunk_metadata(chunk_type);
        CREATE INDEX IF NOT EXISTS idx_chunk_metadata_language
            ON chunk_metadata(language);
        CREATE INDEX IF NOT EXISTS idx_chunk_metadata_symbol_type
            ON chunk_metadata(symbol_type);
        """;

    #endregion

    #region Vector Table Template

    /// <summary>
    /// SQL template to create a vector table for a specific index.
    /// </summary>
    /// <remarks>
    /// <para>
    /// Replace {index_id} with sanitized index ID and {dimension} with embedding dimension.
    /// </para>
    /// <para>
    /// The vec0 virtual table provides:
    /// - Efficient vector storage
    /// - MATCH operator for similarity search
    /// - Automatic distance calculation
    /// </para>
    /// </remarks>
    /// <example>
    /// <code>
    /// var sql = VectorStoreSchema.CreateVectorTableTemplate
    ///     .Replace("{index_id}", sanitizedId)
    ///     .Replace("{dimension}", "384");
    /// </code>
    /// </example>
    public const string CreateVectorTableTemplate = """
        CREATE VIRTUAL TABLE IF NOT EXISTS vectors_{index_id} USING vec0(
            id TEXT PRIMARY KEY,
            embedding FLOAT[{dimension}]
        );
        """;

    /// <summary>
    /// SQL template to drop a vector table.
    /// </summary>
    public const string DropVectorTableTemplate = """
        DROP TABLE IF EXISTS vectors_{index_id};
        """;

    #endregion

    #region Search History Table

    /// <summary>
    /// SQL to create the search history table (for analytics).
    /// </summary>
    /// <remarks>
    /// Optional tracking of search queries for:
    /// - Performance monitoring (duration_ms)
    /// - Quality analysis (top_score, result_count)
    /// - Usage patterns (query_text, options)
    /// </remarks>
    public const string CreateSearchHistoryTable = """
        CREATE TABLE IF NOT EXISTS search_history (
            id TEXT PRIMARY KEY,
            index_id TEXT NOT NULL,
            query_text TEXT,
            result_count INTEGER,
            top_score REAL,
            search_options_json TEXT,
            duration_ms INTEGER,
            searched_at TEXT NOT NULL DEFAULT (datetime('now')),
            FOREIGN KEY (index_id) REFERENCES vector_indexes(id) ON DELETE CASCADE
        );

        CREATE INDEX IF NOT EXISTS idx_search_history_index
            ON search_history(index_id);
        CREATE INDEX IF NOT EXISTS idx_search_history_time
            ON search_history(searched_at);
        """;

    #endregion

    #region Utility Methods

    /// <summary>
    /// Gets all schema creation statements in order.
    /// </summary>
    /// <remarks>
    /// Order matters due to foreign key constraints.
    /// </remarks>
    public static string[] GetSchemaCreationStatements() =>
    [
        CreateSchemaVersionTable,
        CreateVectorIndexesTable,
        CreateIndexedFilesTable,
        CreateChunkMetadataTable,
        CreateSearchHistoryTable
    ];

    /// <summary>
    /// SQL to drop all tables (for testing/reset).
    /// </summary>
    /// <remarks>
    /// Order matters due to foreign key constraints.
    /// Note: This does NOT drop vector tables (vectors_*), which must be 
    /// dropped individually per index.
    /// </remarks>
    public const string DropAllTables = """
        DROP TABLE IF EXISTS search_history;
        DROP TABLE IF EXISTS chunk_metadata;
        DROP TABLE IF EXISTS indexed_files;
        DROP TABLE IF EXISTS vector_indexes;
        DROP TABLE IF EXISTS schema_version;
        """;

    /// <summary>
    /// SQL to get all vector table names for cleanup.
    /// </summary>
    public const string GetAllVectorTables = """
        SELECT name FROM sqlite_master 
        WHERE type = 'table' AND name LIKE 'vectors_%';
        """;

    /// <summary>
    /// Sanitizes an index ID for use in table names.
    /// </summary>
    /// <param name="indexId">The raw index ID (GUID).</param>
    /// <returns>A SQL-safe table name suffix.</returns>
    /// <remarks>
    /// Removes hyphens and ensures alphanumeric characters only.
    /// </remarks>
    public static string SanitizeTableName(string indexId)
    {
        // Remove hyphens from GUID and take first 32 chars
        return indexId.Replace("-", "").ToLowerInvariant()[..32];
    }

    #endregion

    #region Common Queries

    /// <summary>
    /// SQL template to insert a vector.
    /// </summary>
    public const string InsertVectorTemplate = """
        INSERT INTO vectors_{index_id} (id, embedding)
        VALUES (@id, vec_f32(@embedding));
        """;

    /// <summary>
    /// SQL template to search for similar vectors.
    /// </summary>
    public const string SearchVectorTemplate = """
        SELECT id, distance
        FROM vectors_{index_id}
        WHERE embedding MATCH vec_f32(@query)
        ORDER BY distance
        LIMIT @limit;
        """;

    /// <summary>
    /// SQL template to delete a vector.
    /// </summary>
    public const string DeleteVectorTemplate = """
        DELETE FROM vectors_{index_id}
        WHERE id = @id;
        """;

    /// <summary>
    /// SQL to count vectors in an index.
    /// </summary>
    public const string CountVectorsTemplate = """
        SELECT COUNT(*) FROM vectors_{index_id};
        """;

    #endregion
}
```

### 2. VectorStoreMigrations.cs

**Location**: `src/SeniorIntern.Services/VectorStore/VectorStoreMigrations.cs`

```csharp
namespace SeniorIntern.Services.VectorStore;

using System;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Data.Sqlite;
using Microsoft.Extensions.Logging;

/// <summary>
/// Handles database schema migrations for the vector store.
/// </summary>
/// <remarks>
/// <para>
/// Responsible for:
/// <list type="bullet">
///   <item>Creating initial schema for new databases</item>
///   <item>Detecting current schema version</item>
///   <item>Applying migrations to upgrade schema</item>
///   <item>Recording migration history</item>
/// </list>
/// </para>
/// <para>
/// Migration strategy:
/// 1. Each schema version has a migration method (MigrateToVersion2, etc.)
/// 2. Migrations are applied sequentially
/// 3. Each migration is wrapped in a transaction
/// 4. Version is recorded after successful migration
/// </para>
/// </remarks>
public sealed class VectorStoreMigrations
{
    private readonly SqliteConnection _connection;
    private readonly ILogger<VectorStoreMigrations> _logger;

    /// <summary>
    /// Initializes a new instance of the migrations handler.
    /// </summary>
    /// <param name="connection">Open database connection.</param>
    /// <param name="logger">Logger instance.</param>
    public VectorStoreMigrations(
        SqliteConnection connection,
        ILogger<VectorStoreMigrations> logger)
    {
        _connection = connection ?? throw new ArgumentNullException(nameof(connection));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    #region Public API

    /// <summary>
    /// Applies all pending migrations to bring database to current version.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <remarks>
    /// Safe to call on every startup. Does nothing if already at current version.
    /// </remarks>
    public async Task MigrateAsync(CancellationToken ct = default)
    {
        var currentVersion = await GetCurrentVersionAsync(ct);

        _logger.LogInformation(
            "Current schema version: {Current}, Target: {Target}",
            currentVersion,
            VectorStoreSchema.CurrentSchemaVersion);

        if (currentVersion == 0)
        {
            // Fresh database, create schema
            await CreateSchemaAsync(ct);
        }
        else if (currentVersion < VectorStoreSchema.CurrentSchemaVersion)
        {
            // Need to migrate
            await ApplyMigrationsAsync(currentVersion, ct);
        }
        else
        {
            _logger.LogDebug("Schema is up to date");
        }
    }

    /// <summary>
    /// Creates fresh schema (for new databases).
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    public async Task CreateSchemaAsync(CancellationToken ct = default)
    {
        _logger.LogInformation("Creating vector store schema...");

        await using var transaction = await _connection.BeginTransactionAsync(ct);
        try
        {
            foreach (var statement in VectorStoreSchema.GetSchemaCreationStatements())
            {
                await ExecuteNonQueryAsync(statement, transaction, ct);
            }

            await RecordVersionAsync(
                VectorStoreSchema.CurrentSchemaVersion,
                "Initial schema",
                transaction,
                ct);

            await transaction.CommitAsync(ct);

            _logger.LogInformation(
                "Schema created at version {Version}",
                VectorStoreSchema.CurrentSchemaVersion);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to create schema");
            await transaction.RollbackAsync(ct);
            throw;
        }
    }

    /// <summary>
    /// Gets the current schema version, or 0 if not initialized.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>Current version number, or 0 if not initialized.</returns>
    public async Task<int> GetCurrentVersionAsync(CancellationToken ct = default)
    {
        try
        {
            await using var cmd = _connection.CreateCommand();
            cmd.CommandText = "SELECT MAX(version) FROM schema_version";
            var result = await cmd.ExecuteScalarAsync(ct);

            if (result is DBNull or null)
                return 0;

            return Convert.ToInt32(result);
        }
        catch (SqliteException ex) when (ex.SqliteErrorCode == 1) // SQLITE_ERROR
        {
            // Table doesn't exist yet
            _logger.LogDebug("schema_version table does not exist");
            return 0;
        }
    }

    /// <summary>
    /// Resets the database by dropping all tables.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <remarks>
    /// WARNING: This deletes all data. Use only for testing or recovery.
    /// </remarks>
    public async Task ResetSchemaAsync(CancellationToken ct = default)
    {
        _logger.LogWarning("Resetting vector store schema - all data will be lost");

        // First, drop all vector tables
        await DropAllVectorTablesAsync(ct);

        // Then drop regular tables
        await ExecuteNonQueryAsync(VectorStoreSchema.DropAllTables, null, ct);

        _logger.LogInformation("Schema reset complete");
    }

    #endregion

    #region Migration Methods

    private async Task ApplyMigrationsAsync(int fromVersion, CancellationToken ct)
    {
        _logger.LogInformation("Applying migrations from version {From}...", fromVersion);

        // Apply each migration in order
        for (int version = fromVersion + 1; version <= VectorStoreSchema.CurrentSchemaVersion; version++)
        {
            await ApplyMigrationAsync(version, ct);
        }

        _logger.LogInformation("Migrations complete");
    }

    private async Task ApplyMigrationAsync(int toVersion, CancellationToken ct)
    {
        _logger.LogInformation("Applying migration to version {Version}...", toVersion);

        await using var transaction = await _connection.BeginTransactionAsync(ct);
        try
        {
            // Apply version-specific migration
            var description = toVersion switch
            {
                // Add migration handlers here as schema evolves
                // 2 => await MigrateToVersion2Async(transaction, ct),
                // 3 => await MigrateToVersion3Async(transaction, ct),
                _ => throw new InvalidOperationException(
                    $"No migration handler for version {toVersion}")
            };

            await RecordVersionAsync(toVersion, description, transaction, ct);
            await transaction.CommitAsync(ct);

            _logger.LogInformation(
                "Migration to version {Version} complete: {Description}",
                toVersion, description);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Migration to version {Version} failed", toVersion);
            await transaction.RollbackAsync(ct);
            throw;
        }
    }

    // Example migration method (to be implemented when needed):
    // private async Task<string> MigrateToVersion2Async(
    //     SqliteTransaction transaction,
    //     CancellationToken ct)
    // {
    //     // Add new column
    //     await ExecuteNonQueryAsync(
    //         "ALTER TABLE vector_indexes ADD COLUMN compression_enabled INTEGER DEFAULT 0",
    //         transaction,
    //         ct);
    //     
    //     return "Added compression support";
    // }

    #endregion

    #region Helper Methods

    private async Task RecordVersionAsync(
        int version,
        string description,
        SqliteTransaction? transaction,
        CancellationToken ct)
    {
        await using var cmd = _connection.CreateCommand();
        cmd.Transaction = transaction;
        cmd.CommandText = """
            INSERT INTO schema_version (version, description)
            VALUES (@version, @description)
            """;
        cmd.Parameters.AddWithValue("@version", version);
        cmd.Parameters.AddWithValue("@description", description);
        await cmd.ExecuteNonQueryAsync(ct);
    }

    private async Task ExecuteNonQueryAsync(
        string sql,
        SqliteTransaction? transaction,
        CancellationToken ct)
    {
        await using var cmd = _connection.CreateCommand();
        cmd.Transaction = transaction;
        cmd.CommandText = sql;
        await cmd.ExecuteNonQueryAsync(ct);
    }

    private async Task DropAllVectorTablesAsync(CancellationToken ct)
    {
        // Find all vector tables
        var vectorTables = new System.Collections.Generic.List<string>();

        await using var cmd = _connection.CreateCommand();
        cmd.CommandText = VectorStoreSchema.GetAllVectorTables;

        await using var reader = await cmd.ExecuteReaderAsync(ct);
        while (await reader.ReadAsync(ct))
        {
            vectorTables.Add(reader.GetString(0));
        }

        // Drop each vector table
        foreach (var tableName in vectorTables)
        {
            await using var dropCmd = _connection.CreateCommand();
            dropCmd.CommandText = $"DROP TABLE IF EXISTS {tableName}";
            await dropCmd.ExecuteNonQueryAsync(ct);
            _logger.LogDebug("Dropped vector table: {Table}", tableName);
        }
    }

    #endregion
}
```

---

## Index Naming Convention

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     Vector Table Naming Convention                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Problem: GUIDs contain hyphens which are invalid in SQL identifiers         │
│                                                                              │
│  Solution: Sanitize index ID for table name                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  Index ID (GUID):                                                        │ │
│  │  "a1b2c3d4-e5f6-7890-abcd-ef1234567890"                                 │ │
│  │                     │                                                    │ │
│  │                     ▼                                                    │ │
│  │  SanitizeTableName():                                                    │ │
│  │  1. Remove hyphens                                                       │ │
│  │  2. Lowercase                                                            │ │
│  │  3. Take first 32 chars                                                  │ │
│  │                     │                                                    │ │
│  │                     ▼                                                    │ │
│  │  Sanitized ID:                                                           │ │
│  │  "a1b2c3d4e5f67890abcdef1234567890"                                     │ │
│  │                     │                                                    │ │
│  │                     ▼                                                    │ │
│  │  Vector Table Name:                                                      │ │
│  │  "vectors_a1b2c3d4e5f67890abcdef1234567890"                             │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Database Configuration

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         SQLite Optimizations                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Recommended PRAGMA Settings (applied in SqliteVectorStore.InitializeAsync): │
│                                                                              │
│  ┌────────────────────────┬────────────┬───────────────────────────────────┐ │
│  │ PRAGMA                 │ Value      │ Purpose                            │ │
│  │ ───────────────────────│────────────│─────────────────────────────────── │ │
│  │ journal_mode           │ WAL        │ Better concurrent read/write       │ │
│  │ synchronous            │ NORMAL     │ Balance safety and speed           │ │
│  │ cache_size             │ -10240     │ 10MB cache (negative = KB)         │ │
│  │ temp_store             │ MEMORY     │ Temp tables in memory              │ │
│  │ mmap_size              │ 268435456  │ 256MB memory-mapped I/O            │ │
│  │ busy_timeout           │ 5000       │ 5 second wait on lock              │ │
│  │ foreign_keys           │ ON         │ Enforce FK constraints             │ │
│  └────────────────────────┴────────────┴───────────────────────────────────┘ │
│                                                                              │
│  Connection String:                                                           │
│  "Data Source={path};Mode=ReadWriteCreate;Cache=Shared"                      │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `VectorStoreSchema_CurrentSchemaVersion_IsPositive` | Version is > 0 |
| `VectorStoreSchema_GetSchemaCreationStatements_ReturnsAll` | Returns 5 statements |
| `VectorStoreSchema_SanitizeTableName_RemovesHyphens` | GUID sanitization |
| `VectorStoreSchema_SanitizeTableName_ReturnsLowercase` | Lowercase output |
| `VectorStoreSchema_CreateVectorTableTemplate_HasPlaceholders` | Template valid |
| `VectorStoreMigrations_GetCurrentVersion_NewDb_ReturnsZero` | Fresh database |
| `VectorStoreMigrations_CreateSchema_CreatesAllTables` | Schema creation |
| `VectorStoreMigrations_CreateSchema_RecordsVersion` | Version tracking |
| `VectorStoreMigrations_Migrate_UpToDate_NoChanges` | Idempotent |
| `VectorStoreMigrations_ResetSchema_DropsAllTables` | Reset works |

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `VectorStoreSchema.cs` | `Services/VectorStore/` | SQL schema definitions | ~250 |
| `VectorStoreMigrations.cs` | `Services/VectorStore/` | Migration handler | ~200 |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Schema version table tracks migration history |
| AC-2 | Vector indexes table stores all VectorIndex fields |
| AC-3 | Indexed files table tracks file hashes |
| AC-4 | Chunk metadata table stores all StoredChunk fields |
| AC-5 | Vector table template creates valid sqlite-vec table |
| AC-6 | All tables have appropriate indexes |
| AC-7 | Foreign keys cascade on delete |
| AC-8 | Migrations apply incrementally |
| AC-9 | SanitizeTableName produces valid SQL identifiers |

---

## Changelog Entry

```markdown
## v0.7.2d - SQLite-vec Database Schema

### Added
- `VectorStoreSchema` static class (`Services/VectorStore/`)
  - CurrentSchemaVersion constant
  - CreateSchemaVersionTable SQL
  - CreateVectorIndexesTable SQL with indexes
  - CreateIndexedFilesTable SQL with indexes
  - CreateChunkMetadataTable SQL with indexes
  - CreateVectorTableTemplate for sqlite-vec virtual tables
  - CreateSearchHistoryTable SQL for analytics
  - GetSchemaCreationStatements() utility
  - DropAllTables SQL for reset
  - SanitizeTableName() for GUID→table name
  - Common query templates (Insert, Search, Delete vectors)
- `VectorStoreMigrations` class (`Services/VectorStore/`)
  - MigrateAsync() - Apply pending migrations
  - CreateSchemaAsync() - Create fresh schema
  - GetCurrentVersionAsync() - Get current version
  - ResetSchemaAsync() - Drop all tables
  - Version recording and tracking

### Schema Design
- 5 core tables: schema_version, vector_indexes, indexed_files, chunk_metadata, search_history
- Dynamic vector tables: vectors_{sanitized_id} per index
- Foreign key cascade deletes for data integrity
- Optimized indexes for common query patterns

### Database Optimizations
- WAL mode for concurrent access
- Memory-mapped I/O
- Shared cache
- Foreign key enforcement
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.7.2d | 0.5 day |
