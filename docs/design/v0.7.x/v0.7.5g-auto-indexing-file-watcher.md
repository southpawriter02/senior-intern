# Design Specification: AIntern v0.7.5g "Auto-Indexing File Watcher"

## Overview

**Version**: v0.7.5g  
**Parent**: v0.7.5 UI & Integration  
**Focus**: File system watcher service for automatic incremental re-indexing on file changes

### Purpose

This sub-version creates the auto-indexing infrastructure:
1. `IFileWatcherService` - Interface for file system monitoring
2. `FileWatcherService` - Implementation using `FileSystemWatcher`
3. `AutoIndexingCoordinator` - Debounced coordination between watcher and indexing pipeline

### Dependencies

**From v0.7.5a**: `RagSettings` (AutoIndexEnabled, AutoIndexDelaySeconds)  
**From v0.7.3**: `IIndexingPipeline` for triggering incremental updates  
**From v0.7.2**: `IVectorStore` for stale file detection  
**From .NET**: `FileSystemWatcher` for OS-level file monitoring

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.7.5g Auto-Indexing File Watcher Architecture             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  File System Events                                                      │ │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │ │
│  │  │ Created │  │ Changed │  │ Deleted │  │ Renamed │                     │ │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                     │ │
│  │       │            │            │            │                           │ │
│  │       └────────────┴────────────┴────────────┘                          │ │
│  │                          │                                               │ │
│  │                          ▼                                               │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  FileWatcherService : IFileWatcherService                         │  │ │
│  │  │  ├── FileSystemWatcher _watcher                                   │  │ │
│  │  │  ├── HashSet<string> _changedFiles (pending changes)              │  │ │
│  │  │  └── Events: FileChanged, FileCreated, FileDeleted, FileRenamed   │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                          │                                               │ │
│  │                          │ Aggregate Events                              │ │
│  │                          ▼                                               │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  AutoIndexingCoordinator                                          │  │ │
│  │  │  ├── Timer _debounceTimer (delay from settings)                   │  │ │
│  │  │  ├── Queue<FileChangeEvent> _pendingChanges                       │  │ │
│  │  │  ├── ProcessPendingChangesAsync()                                 │  │ │
│  │  │  └── Respects RagSettings.AutoIndexEnabled                        │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                          │                                               │ │
│  │                          │ After Debounce Delay                          │ │
│  │                          ▼                                               │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  IIndexingPipeline.UpdateFilesAsync(changedPaths)                 │  │ │
│  │  │  (v0.7.3)                                                         │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Settings Integration:                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  IRagSettingsService.SettingsChanged                                    │ │
│  │  ├── AutoIndexEnabled: true/false → Start/Stop watching                │ │
│  │  ├── AutoIndexDelaySeconds → Update debounce timer                      │ │
│  │  ├── IncludePatterns → Update filter                                    │ │
│  │  └── ExcludePatterns → Update filter                                    │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Event Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Auto-Indexing Event Flow                                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Time ─────────────────────────────────────────────────────────────────────► │
│                                                                              │
│  File Events:                                                                │
│  ────────────────────────────────────────────────────────────────────────    │
│       │         │    │              │                                        │
│       ▼         ▼    ▼              ▼                                        │
│    Created   Changed Changed     Deleted                                     │
│    foo.cs    bar.ts  bar.ts      baz.py                                     │
│       │         │    │              │                                        │
│       └─────────┴────┴──────────────┘                                       │
│                      │                                                       │
│                      ▼                                                       │
│  Pending Set: { foo.cs, bar.ts, baz.py }                                    │
│                      │                                                       │
│                      │  Debounce Timer: 5s                                   │
│                      │  ════════════════════                                 │
│                      ▼                                                       │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  ProcessPendingChangesAsync()                                        │   │
│  │  1. Lock and copy pending set                                        │   │
│  │  2. Filter by include/exclude patterns                               │   │
│  │  3. Call IIndexingPipeline.UpdateFilesAsync()                        │   │
│  │  4. Clear pending set                                                │   │
│  │  5. Raise IndexingTriggered event                                    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. IFileWatcherService.cs

**Location**: `src/AIntern.Core/RAG/Indexing/IFileWatcherService.cs`

```csharp
namespace AIntern.Core.RAG.Indexing;

/// <summary>
/// Service for monitoring file system changes in a workspace.
/// </summary>
public interface IFileWatcherService : IDisposable
{
    /// <summary>
    /// Start watching the specified workspace path.
    /// </summary>
    /// <param name="workspacePath">Root path to monitor.</param>
    /// <param name="includePatterns">Glob patterns for files to include.</param>
    /// <param name="excludePatterns">Glob patterns for files to exclude.</param>
    void StartWatching(string workspacePath, 
        IReadOnlyList<string> includePatterns, 
        IReadOnlyList<string> excludePatterns);

    /// <summary>
    /// Stop watching the current workspace.
    /// </summary>
    void StopWatching();

    /// <summary>
    /// Whether the watcher is currently active.
    /// </summary>
    bool IsWatching { get; }

    /// <summary>
    /// Current workspace being watched.
    /// </summary>
    string? WatchedPath { get; }

    /// <summary>
    /// Raised when a file is created.
    /// </summary>
    event EventHandler<FileChangeEventArgs>? FileCreated;

    /// <summary>
    /// Raised when a file is changed.
    /// </summary>
    event EventHandler<FileChangeEventArgs>? FileChanged;

    /// <summary>
    /// Raised when a file is deleted.
    /// </summary>
    event EventHandler<FileChangeEventArgs>? FileDeleted;

    /// <summary>
    /// Raised when a file is renamed.
    /// </summary>
    event EventHandler<FileRenamedEventArgs>? FileRenamed;

    /// <summary>
    /// Raised when an error occurs during watching.
    /// </summary>
    event EventHandler<FileWatcherErrorEventArgs>? Error;
}

/// <summary>
/// Event args for file change events.
/// </summary>
public class FileChangeEventArgs : EventArgs
{
    public required string FilePath { get; init; }
    public required FileChangeType ChangeType { get; init; }
    public DateTime Timestamp { get; init; } = DateTime.UtcNow;
}

/// <summary>
/// Event args for file rename events.
/// </summary>
public class FileRenamedEventArgs : FileChangeEventArgs
{
    public required string OldPath { get; init; }
}

/// <summary>
/// Event args for watcher errors.
/// </summary>
public class FileWatcherErrorEventArgs : EventArgs
{
    public required Exception Exception { get; init; }
}

/// <summary>
/// Types of file system changes.
/// </summary>
public enum FileChangeType
{
    Created,
    Changed,
    Deleted,
    Renamed
}
```

### 2. FileWatcherService.cs

**Location**: `src/AIntern.Services/RAG/Indexing/FileWatcherService.cs`

```csharp
namespace AIntern.Services.RAG.Indexing;

using Microsoft.Extensions.Logging;
using Microsoft.Extensions.FileSystemGlobbing;
using AIntern.Core.RAG.Indexing;

/// <summary>
/// File system watcher implementation using FileSystemWatcher.
/// </summary>
public class FileWatcherService : IFileWatcherService
{
    private readonly ILogger<FileWatcherService> _logger;
    private FileSystemWatcher? _watcher;
    private Matcher? _includeMatcher;
    private Matcher? _excludeMatcher;
    private bool _disposed;

    public bool IsWatching => _watcher?.EnableRaisingEvents ?? false;
    public string? WatchedPath => _watcher?.Path;

    public event EventHandler<FileChangeEventArgs>? FileCreated;
    public event EventHandler<FileChangeEventArgs>? FileChanged;
    public event EventHandler<FileChangeEventArgs>? FileDeleted;
    public event EventHandler<FileRenamedEventArgs>? FileRenamed;
    public event EventHandler<FileWatcherErrorEventArgs>? Error;

    public FileWatcherService(ILogger<FileWatcherService> logger)
    {
        _logger = logger;
    }

    public void StartWatching(string workspacePath, 
        IReadOnlyList<string> includePatterns, 
        IReadOnlyList<string> excludePatterns)
    {
        StopWatching();

        _logger.LogInformation("Starting file watcher for {Path}", workspacePath);

        // Setup glob matchers
        _includeMatcher = new Matcher();
        foreach (var pattern in includePatterns)
            _includeMatcher.AddInclude(pattern);

        _excludeMatcher = new Matcher();
        foreach (var pattern in excludePatterns)
            _excludeMatcher.AddInclude(pattern);

        // Create watcher
        _watcher = new FileSystemWatcher(workspacePath)
        {
            IncludeSubdirectories = true,
            NotifyFilter = NotifyFilters.FileName 
                         | NotifyFilters.LastWrite 
                         | NotifyFilters.CreationTime
        };

        _watcher.Created += OnFileCreated;
        _watcher.Changed += OnFileChanged;
        _watcher.Deleted += OnFileDeleted;
        _watcher.Renamed += OnFileRenamed;
        _watcher.Error += OnError;

        _watcher.EnableRaisingEvents = true;
        _logger.LogDebug("File watcher started with {Inc} include and {Exc} exclude patterns",
            includePatterns.Count, excludePatterns.Count);
    }

    public void StopWatching()
    {
        if (_watcher != null)
        {
            _logger.LogInformation("Stopping file watcher");
            _watcher.EnableRaisingEvents = false;
            _watcher.Dispose();
            _watcher = null;
        }
    }

    private bool ShouldProcess(string filePath)
    {
        if (_includeMatcher == null || _excludeMatcher == null)
            return false;

        var relativePath = Path.GetRelativePath(WatchedPath!, filePath);
        
        // Must match include and not match exclude
        var includeResult = _includeMatcher.Match(relativePath);
        if (!includeResult.HasMatches)
            return false;

        var excludeResult = _excludeMatcher.Match(relativePath);
        return !excludeResult.HasMatches;
    }

    private void OnFileCreated(object sender, FileSystemEventArgs e)
    {
        if (!ShouldProcess(e.FullPath)) return;
        
        _logger.LogDebug("File created: {Path}", e.FullPath);
        FileCreated?.Invoke(this, new FileChangeEventArgs
        {
            FilePath = e.FullPath,
            ChangeType = FileChangeType.Created
        });
    }

    private void OnFileChanged(object sender, FileSystemEventArgs e)
    {
        if (!ShouldProcess(e.FullPath)) return;
        
        _logger.LogDebug("File changed: {Path}", e.FullPath);
        FileChanged?.Invoke(this, new FileChangeEventArgs
        {
            FilePath = e.FullPath,
            ChangeType = FileChangeType.Changed
        });
    }

    private void OnFileDeleted(object sender, FileSystemEventArgs e)
    {
        if (!ShouldProcess(e.FullPath)) return;
        
        _logger.LogDebug("File deleted: {Path}", e.FullPath);
        FileDeleted?.Invoke(this, new FileChangeEventArgs
        {
            FilePath = e.FullPath,
            ChangeType = FileChangeType.Deleted
        });
    }

    private void OnFileRenamed(object sender, RenamedEventArgs e)
    {
        _logger.LogDebug("File renamed: {OldPath} → {NewPath}", e.OldFullPath, e.FullPath);
        FileRenamed?.Invoke(this, new FileRenamedEventArgs
        {
            FilePath = e.FullPath,
            OldPath = e.OldFullPath,
            ChangeType = FileChangeType.Renamed
        });
    }

    private void OnError(object sender, ErrorEventArgs e)
    {
        _logger.LogError(e.GetException(), "File watcher error");
        Error?.Invoke(this, new FileWatcherErrorEventArgs
        {
            Exception = e.GetException()
        });
    }

    public void Dispose()
    {
        if (_disposed) return;
        StopWatching();
        _disposed = true;
    }
}
```

### 3. AutoIndexingCoordinator.cs

**Location**: `src/AIntern.Services/RAG/Indexing/AutoIndexingCoordinator.cs`

```csharp
namespace AIntern.Services.RAG.Indexing;

using Microsoft.Extensions.Logging;
using AIntern.Core.RAG.Indexing;
using AIntern.Core.RAG.Settings;

/// <summary>
/// Coordinates auto-indexing by debouncing file changes.
/// </summary>
public class AutoIndexingCoordinator : IDisposable
{
    private readonly IFileWatcherService _watcher;
    private readonly IIndexingPipeline _pipeline;
    private readonly IRagSettingsService _settingsService;
    private readonly ILogger<AutoIndexingCoordinator> _logger;

    private readonly HashSet<string> _pendingChanges = new();
    private readonly HashSet<string> _pendingDeletes = new();
    private readonly object _lock = new();
    private Timer? _debounceTimer;
    private RagSettings _currentSettings;
    private bool _disposed;

    /// <summary>
    /// Raised when auto-indexing is triggered.
    /// </summary>
    public event EventHandler<AutoIndexingEventArgs>? IndexingTriggered;

    public AutoIndexingCoordinator(
        IFileWatcherService watcher,
        IIndexingPipeline pipeline,
        IRagSettingsService settingsService,
        ILogger<AutoIndexingCoordinator> logger)
    {
        _watcher = watcher;
        _pipeline = pipeline;
        _settingsService = settingsService;
        _logger = logger;
        _currentSettings = RagSettings.Default;

        // Subscribe to watcher events
        _watcher.FileCreated += OnFileChanged;
        _watcher.FileChanged += OnFileChanged;
        _watcher.FileDeleted += OnFileDeleted;
        _watcher.FileRenamed += OnFileRenamed;

        // Subscribe to settings changes
        _settingsService.SettingsChanged += OnSettingsChanged;
    }

    /// <summary>
    /// Initialize with current settings.
    /// </summary>
    public async Task InitializeAsync()
    {
        _currentSettings = await _settingsService.GetSettingsAsync();
        
        if (_currentSettings.AutoIndexEnabled && 
            !string.IsNullOrEmpty(_currentSettings.LastWorkspacePath))
        {
            StartWatching(_currentSettings.LastWorkspacePath);
        }
    }

    /// <summary>
    /// Start watching a workspace.
    /// </summary>
    public void StartWatching(string workspacePath)
    {
        if (!_currentSettings.AutoIndexEnabled)
        {
            _logger.LogDebug("Auto-indexing disabled, not starting watcher");
            return;
        }

        _logger.LogInformation("Starting auto-indexing for {Path}", workspacePath);
        _watcher.StartWatching(
            workspacePath,
            _currentSettings.IncludePatterns,
            _currentSettings.ExcludePatterns);
    }

    /// <summary>
    /// Stop watching.
    /// </summary>
    public void StopWatching()
    {
        _logger.LogInformation("Stopping auto-indexing");
        _watcher.StopWatching();
        _debounceTimer?.Dispose();
        _debounceTimer = null;
    }

    private void OnFileChanged(object? sender, FileChangeEventArgs e)
    {
        lock (_lock)
        {
            _pendingChanges.Add(e.FilePath);
            _pendingDeletes.Remove(e.FilePath);
        }
        ResetDebounceTimer();
    }

    private void OnFileDeleted(object? sender, FileChangeEventArgs e)
    {
        lock (_lock)
        {
            _pendingDeletes.Add(e.FilePath);
            _pendingChanges.Remove(e.FilePath);
        }
        ResetDebounceTimer();
    }

    private void OnFileRenamed(object? sender, FileRenamedEventArgs e)
    {
        lock (_lock)
        {
            _pendingDeletes.Add(e.OldPath);
            _pendingChanges.Add(e.FilePath);
        }
        ResetDebounceTimer();
    }

    private void ResetDebounceTimer()
    {
        var delay = TimeSpan.FromSeconds(_currentSettings.AutoIndexDelaySeconds);
        
        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(
            _ => _ = ProcessPendingChangesAsync(),
            null,
            delay,
            Timeout.InfiniteTimeSpan);
    }

    private async Task ProcessPendingChangesAsync()
    {
        List<string> changedFiles;
        List<string> deletedFiles;

        lock (_lock)
        {
            if (_pendingChanges.Count == 0 && _pendingDeletes.Count == 0)
                return;

            changedFiles = _pendingChanges.ToList();
            deletedFiles = _pendingDeletes.ToList();
            _pendingChanges.Clear();
            _pendingDeletes.Clear();
        }

        _logger.LogInformation(
            "Processing {Changed} changed and {Deleted} deleted files",
            changedFiles.Count, deletedFiles.Count);

        try
        {
            IndexingTriggered?.Invoke(this, new AutoIndexingEventArgs
            {
                ChangedFiles = changedFiles,
                DeletedFiles = deletedFiles
            });

            await _pipeline.UpdateFilesAsync(changedFiles, deletedFiles);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Auto-indexing failed");
        }
    }

    private async void OnSettingsChanged(object? sender, RagSettings settings)
    {
        var wasEnabled = _currentSettings.AutoIndexEnabled;
        _currentSettings = settings;

        if (settings.AutoIndexEnabled && !wasEnabled)
        {
            if (!string.IsNullOrEmpty(settings.LastWorkspacePath))
                StartWatching(settings.LastWorkspacePath);
        }
        else if (!settings.AutoIndexEnabled && wasEnabled)
        {
            StopWatching();
        }
    }

    public void Dispose()
    {
        if (_disposed) return;
        
        _watcher.FileCreated -= OnFileChanged;
        _watcher.FileChanged -= OnFileChanged;
        _watcher.FileDeleted -= OnFileDeleted;
        _watcher.FileRenamed -= OnFileRenamed;
        _settingsService.SettingsChanged -= OnSettingsChanged;
        
        StopWatching();
        _disposed = true;
    }
}

/// <summary>
/// Event args for auto-indexing triggers.
/// </summary>
public class AutoIndexingEventArgs : EventArgs
{
    public IReadOnlyList<string> ChangedFiles { get; init; } = Array.Empty<string>();
    public IReadOnlyList<string> DeletedFiles { get; init; } = Array.Empty<string>();
}
```

---

## Unit Test Requirements

**File**: `tests/AIntern.Services.Tests/RAG/FileWatcherServiceTests.cs`

| Test | Description |
|------|-------------|
| `StartWatching_SetsIsWatchingTrue` | Verify watcher starts |
| `StopWatching_SetsIsWatchingFalse` | Verify watcher stops |
| `FileCreated_RaisesEvent` | Verify created event |
| `FileChanged_RaisesEvent` | Verify changed event |
| `FileDeleted_RaisesEvent` | Verify deleted event |
| `FileRenamed_RaisesEventWithBothPaths` | Verify rename event |
| `ShouldProcess_RespectsIncludePatterns` | Verify include filter |
| `ShouldProcess_RespectsExcludePatterns` | Verify exclude filter |

**File**: `tests/AIntern.Services.Tests/RAG/AutoIndexingCoordinatorTests.cs`

| Test | Description |
|------|-------------|
| `OnFileChanged_AddsToP endingSet` | Verify change tracked |
| `OnFileDeleted_AddsToDeleteSet` | Verify delete tracked |
| `DebounceTimer_WaitsBeforeProcessing` | Verify debounce delay |
| `ProcessPending_CallsPipelineWithFiles` | Verify pipeline called |
| `ProcessPending_ClearsPendingSets` | Verify sets cleared |
| `OnSettingsChanged_StartsWatcherWhenEnabled` | Verify auto-start |
| `OnSettingsChanged_StopsWatcherWhenDisabled` | Verify auto-stop |
| `Dispose_CleansUpResources` | Verify cleanup |

---

## Acceptance Criteria

- [ ] `IFileWatcherService` interface defines all events and methods
- [ ] `FileWatcherService` wraps `FileSystemWatcher` correctly
- [ ] Include/exclude pattern filtering works with glob matcher
- [ ] Events raised for create, change, delete, rename operations
- [ ] `AutoIndexingCoordinator` debounces rapid file changes
- [ ] Debounce delay respects `AutoIndexDelaySeconds` setting
- [ ] Changed and deleted files tracked separately
- [ ] `IndexingTriggered` event raised before pipeline call
- [ ] Coordinator responds to settings enable/disable changes
- [ ] Proper disposal of timer and event subscriptions
- [ ] Unit tests achieve >90% coverage

---

## Changelog Entry

```markdown
## v0.7.5g - Auto-Indexing File Watcher

### Added

- `IFileWatcherService` interface with:
  - `StartWatching()` / `StopWatching()` methods
  - `FileCreated`, `FileChanged`, `FileDeleted`, `FileRenamed` events
  - Include/exclude pattern support
- `FileWatcherService` implementation with:
  - `FileSystemWatcher` integration
  - `Microsoft.Extensions.FileSystemGlobbing` for pattern matching
  - Subdirectory monitoring
- `FileChangeEventArgs` and `FileRenamedEventArgs` event data
- `FileChangeType` enum (Created, Changed, Deleted, Renamed)
- `AutoIndexingCoordinator` with:
  - Debounced change aggregation
  - Separate tracking for changed vs deleted files
  - Settings-reactive enable/disable
  - `IndexingTriggered` event for UI notifications
- `AutoIndexingEventArgs` with file lists
```
