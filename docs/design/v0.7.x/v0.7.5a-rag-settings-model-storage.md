# Design Specification: AIntern v0.7.5a "RAG Settings Model & Storage"

## Overview

**Version**: v0.7.5a
**Parent**: v0.7.5 UI & Integration
**Focus**: RAG settings models, workspace index information, and settings service interface

### Purpose

This sub-version establishes the settings infrastructure for the RAG system:
1. `RagSettings` model for all RAG configuration options with validation
2. `WorkspaceIndexInfo` model for indexed workspace metadata
3. `IRagSettingsService` interface for settings persistence and change notifications
4. Integration with existing `AppSettings` class

### Dependencies

**From v0.7.4 (Retrieval & Context)**:
- `RerankingStrategy` enum for search result reranking configuration

**From v0.7.1 (Embedding Foundation)**:
- `EmbeddingModelType` enum for model type configuration

**From Existing Infrastructure**:
- `AppSettings` class from `src/AIntern.Core/Models/`
- Settings persistence patterns from v0.3.x

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                 v0.7.5a RAG Settings Model & Storage Architecture            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                          Core Model Layer                                │ │
│  │  src/AIntern.Core/Models/                                               │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                         RagSettings                                 │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Global Settings:                                           │   │ │ │
│  │  │  │  ├── Enabled: bool                    (RAG on/off)          │   │ │ │
│  │  │  │  ├── EmbeddingModelPath: string?      (model file path)     │   │ │ │
│  │  │  │  └── EmbeddingModelType: enum?        (Gguf/Onnx)           │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Auto-Indexing Settings:                                    │   │ │ │
│  │  │  │  ├── AutoIndexEnabled: bool           (file watcher)        │   │ │ │
│  │  │  │  └── AutoIndexDelaySeconds: int       (debounce delay)      │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  File Filter Settings:                                      │   │ │ │
│  │  │  │  ├── RespectGitignore: bool           (honor .gitignore)    │   │ │ │
│  │  │  │  ├── IndexHiddenFiles: bool           (include hidden)      │   │ │ │
│  │  │  │  ├── MaxFileSizeKb: int               (skip large files)    │   │ │ │
│  │  │  │  ├── IncludePatterns: List<string>    (glob patterns)       │   │ │ │
│  │  │  │  └── ExcludePatterns: List<string>    (glob patterns)       │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Chunking Settings:                                         │   │ │ │
│  │  │  │  ├── ChunkSize: int                   (tokens per chunk)    │   │ │ │
│  │  │  │  └── ChunkOverlap: int                (overlap tokens)      │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  RAG Chat Settings:                                         │   │ │ │
│  │  │  │  ├── EnableRagInChat: bool            (default toggle)      │   │ │ │
│  │  │  │  ├── MaxRagContextTokens: int         (context budget)      │   │ │ │
│  │  │  │  ├── MaxRagChunks: int                (result limit)        │   │ │ │
│  │  │  │  ├── MinRelevanceScore: float         (0.0 to 1.0)          │   │ │ │
│  │  │  │  └── RerankingStrategy: enum          (from v0.7.4)         │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  UI Settings:                                               │   │ │ │
│  │  │  │  ├── ShowStatusIndicator: bool        (main window)         │   │ │ │
│  │  │  │  ├── ShowIndexingNotifications: bool  (toast messages)      │   │ │ │
│  │  │  │  └── LastWorkspacePath: string?       (session restore)     │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Methods:                                                   │   │ │ │
│  │  │  │  ├── Validate() → IReadOnlyList<string>                    │   │ │ │
│  │  │  │  └── static Default → RagSettings                          │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                     WorkspaceIndexInfo                              │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Identity:                                                  │   │ │ │
│  │  │  │  ├── IndexId: string                  (unique identifier)  │   │ │ │
│  │  │  │  ├── WorkspacePath: string            (directory path)     │   │ │ │
│  │  │  │  └── DisplayName: string              (folder name)        │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Timestamps:                                                │   │ │ │
│  │  │  │  ├── CreatedAt: DateTime              (first indexed)      │   │ │ │
│  │  │  │  └── LastUpdated: DateTime            (last refresh)       │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Statistics:                                                │   │ │ │
│  │  │  │  ├── FileCount: int                   (indexed files)      │   │ │ │
│  │  │  │  ├── ChunkCount: int                  (total chunks)       │   │ │ │
│  │  │  │  ├── IndexSizeBytes: long             (storage size)       │   │ │ │
│  │  │  │  └── StaleFileCount: int              (changed files)      │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Model Info:                                                │   │ │ │
│  │  │  │  ├── EmbeddingModel: string?          (model name)         │   │ │ │
│  │  │  │  └── EmbeddingDimension: int          (vector size)        │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  State:                                                     │   │ │ │
│  │  │  │  └── IsActive: bool                   (current workspace)  │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Computed:                                                  │   │ │ │
│  │  │  │  ├── FormattedSize → string           (human-readable)     │   │ │ │
│  │  │  │  └── FormattedLastUpdate → string     (relative time)      │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Service Interface Layer                           │ │
│  │  src/AIntern.Services/Settings/                                         │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                     IRagSettingsService                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Methods:                                                   │   │ │ │
│  │  │  │  ├── GetSettingsAsync(ct) → RagSettings                    │   │ │ │
│  │  │  │  ├── SaveSettingsAsync(settings, ct) → Task                │   │ │ │
│  │  │  │  └── ResetToDefaultsAsync(ct) → Task                       │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │ │ │
│  │  │  │  Events:                                                    │   │ │ │
│  │  │  │  └── SettingsChanged: EventHandler<RagSettings>            │   │ │ │
│  │  │  └─────────────────────────────────────────────────────────────┘   │ │ │
│  │  └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         AppSettings Integration                          │ │
│  │  src/AIntern.Core/Models/AppSettings.cs                                 │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Modification:                                                      │ │ │
│  │  │  Add property: Rag: RagSettings                                     │ │ │
│  │  │  (Nested object serialized with parent settings)                    │ │ │
│  │  └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Settings Persistence Flow                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────────────────┐ │
│  │  UI Component  │───►│ IRagSettings   │───►│    AppSettings.json        │ │
│  │  (Settings     │    │ Service        │    │    ┌──────────────────┐    │ │
│  │   Panel)       │    │                │    │    │ "rag": {         │    │ │
│  └────────────────┘    └────────────────┘    │    │   "enabled":true,│    │ │
│         │                     │              │    │   "chunkSize":512│    │ │
│         │                     │              │    │   ...            │    │ │
│         ▼                     ▼              │    │ }                │    │ │
│  ┌────────────────┐    ┌────────────────┐    │    └──────────────────┘    │ │
│  │  Validate()    │    │SettingsChanged │    └────────────────────────────┘ │
│  │  (client-side) │    │   Event        │                                   │
│  └────────────────┘    └───────┬────────┘                                   │
│                                │                                             │
│                 ┌──────────────┼──────────────┐                             │
│                 ▼              ▼              ▼                             │
│          ┌──────────┐   ┌──────────┐   ┌──────────┐                        │
│          │ Index    │   │FileWatcher│   │Chat RAG  │                        │
│          │ Manager  │   │ Service   │   │Integration│                       │
│          └──────────┘   └──────────┘   └──────────┘                        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Validation Rules

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        RagSettings Validation Rules                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Chunking Constraints                                                    │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  ChunkSize:                                                        │  │ │
│  │  │    ├── Minimum: 100 tokens                                        │  │ │
│  │  │    ├── Maximum: 2000 tokens                                       │  │ │
│  │  │    └── Default: 512 tokens                                        │  │ │
│  │  │                                                                    │  │ │
│  │  │  ChunkOverlap:                                                     │  │ │
│  │  │    ├── Minimum: 0 tokens                                          │  │ │
│  │  │    ├── Maximum: ChunkSize - 1 (must be less than chunk size)      │  │ │
│  │  │    └── Default: 64 tokens                                         │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  File Constraints                                                        │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  MaxFileSizeKb:                                                    │  │ │
│  │  │    ├── Minimum: 1 KB                                              │  │ │
│  │  │    ├── Maximum: 10240 KB (10 MB)                                  │  │ │
│  │  │    └── Default: 1024 KB (1 MB)                                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  RAG Context Constraints                                                 │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  MaxRagContextTokens:                                              │  │ │
│  │  │    ├── Minimum: 500 tokens                                        │  │ │
│  │  │    ├── Maximum: 16000 tokens                                      │  │ │
│  │  │    └── Default: 4000 tokens                                       │  │ │
│  │  │                                                                    │  │ │
│  │  │  MinRelevanceScore:                                                │  │ │
│  │  │    ├── Minimum: 0.0                                               │  │ │
│  │  │    ├── Maximum: 1.0                                               │  │ │
│  │  │    └── Default: 0.5                                               │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Auto-Index Constraints                                                  │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │  AutoIndexDelaySeconds:                                            │  │ │
│  │  │    ├── Minimum: 1 second                                          │  │ │
│  │  │    ├── Maximum: 60 seconds                                        │  │ │
│  │  │    └── Default: 2 seconds                                         │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Default File Patterns

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Default Include Patterns                             │
├──────────────────────────────────────────────────────────────────────────────┤
│  **/*.cs      │  **/*.ts     │  **/*.tsx    │  **/*.js     │  **/*.jsx     │
│  **/*.py      │  **/*.java   │  **/*.go     │  **/*.rs     │  **/*.cpp     │
│  **/*.c       │  **/*.h      │  **/*.hpp    │  **/*.md     │  **/*.json    │
│  **/*.yaml    │  **/*.yml    │  **/*.xml    │  **/*.html   │  **/*.css     │
│  **/*.scss    │              │              │              │               │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                          Default Exclude Patterns                             │
├──────────────────────────────────────────────────────────────────────────────┤
│  **/node_modules/**  │  **/bin/**        │  **/obj/**         │             │
│  **/.git/**          │  **/dist/**       │  **/build/**       │             │
│  **/target/**        │  **/__pycache__/**│  **/.venv/**       │             │
│  **/vendor/**        │  **/*.min.js      │  **/*.min.css      │             │
│  **/package-lock.json│  **/yarn.lock     │                    │             │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. RagSettings.cs

**Location**: `src/AIntern.Core/Models/RagSettings.cs`
**Purpose**: Configuration settings for RAG functionality

```csharp
namespace AIntern.Core.Models;

using System;
using System.Collections.Generic;
using System.Text.Json.Serialization;

/// <summary>
/// Configuration settings for RAG (Retrieval-Augmented Generation) functionality.
/// Persisted as part of application settings.
/// </summary>
public sealed class RagSettings
{
    #region Global Settings

    /// <summary>
    /// Whether RAG functionality is enabled globally.
    /// Default: true
    /// </summary>
    public bool Enabled { get; set; } = true;

    /// <summary>
    /// Path to the embedding model file (GGUF or ONNX).
    /// </summary>
    public string? EmbeddingModelPath { get; set; }

    /// <summary>
    /// Type of embedding model (auto-detected from extension if not specified).
    /// </summary>
    [JsonConverter(typeof(JsonStringEnumConverter))]
    public EmbeddingModelType? EmbeddingModelType { get; set; }

    #endregion

    #region Auto-Indexing Settings

    /// <summary>
    /// Whether to automatically index files when they change.
    /// Default: true
    /// </summary>
    public bool AutoIndexEnabled { get; set; } = true;

    /// <summary>
    /// Delay in seconds before auto-indexing changed files (debounce).
    /// Default: 2
    /// </summary>
    public int AutoIndexDelaySeconds { get; set; } = 2;

    #endregion

    #region File Filter Settings

    /// <summary>
    /// Whether to respect .gitignore when indexing.
    /// Default: true
    /// </summary>
    public bool RespectGitignore { get; set; } = true;

    /// <summary>
    /// Whether to index hidden files and directories.
    /// Default: false
    /// </summary>
    public bool IndexHiddenFiles { get; set; } = false;

    /// <summary>
    /// Maximum file size to index in kilobytes.
    /// Files larger than this are skipped.
    /// Default: 1024 (1MB)
    /// </summary>
    public int MaxFileSizeKb { get; set; } = 1024;

    /// <summary>
    /// File patterns to include in indexing (glob patterns).
    /// Default: Common code file extensions
    /// </summary>
    public List<string> IncludePatterns { get; set; } = new()
    {
        "**/*.cs", "**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx",
        "**/*.py", "**/*.java", "**/*.go", "**/*.rs", "**/*.cpp",
        "**/*.c", "**/*.h", "**/*.hpp", "**/*.md", "**/*.json",
        "**/*.yaml", "**/*.yml", "**/*.xml", "**/*.html",
        "**/*.css", "**/*.scss"
    };

    /// <summary>
    /// File patterns to exclude from indexing (glob patterns).
    /// Default: Common build/dependency directories
    /// </summary>
    public List<string> ExcludePatterns { get; set; } = new()
    {
        "**/node_modules/**", "**/bin/**", "**/obj/**",
        "**/.git/**", "**/dist/**", "**/build/**",
        "**/target/**", "**/__pycache__/**", "**/.venv/**",
        "**/vendor/**", "**/*.min.js", "**/*.min.css",
        "**/package-lock.json", "**/yarn.lock"
    };

    #endregion

    #region Chunking Settings

    /// <summary>
    /// Target chunk size in tokens.
    /// Default: 512
    /// </summary>
    public int ChunkSize { get; set; } = 512;

    /// <summary>
    /// Overlap between consecutive chunks in tokens.
    /// Default: 64
    /// </summary>
    public int ChunkOverlap { get; set; } = 64;

    #endregion

    #region RAG Chat Settings

    /// <summary>
    /// Enable RAG context in chat by default.
    /// Default: true
    /// </summary>
    public bool EnableRagInChat { get; set; } = true;

    /// <summary>
    /// Maximum tokens for RAG context in chat prompts.
    /// Default: 4000
    /// </summary>
    public int MaxRagContextTokens { get; set; } = 4000;

    /// <summary>
    /// Maximum chunks to retrieve for context.
    /// Default: 10
    /// </summary>
    public int MaxRagChunks { get; set; } = 10;

    /// <summary>
    /// Minimum relevance score for including chunks (0.0 to 1.0).
    /// Default: 0.5
    /// </summary>
    public float MinRelevanceScore { get; set; } = 0.5f;

    /// <summary>
    /// Reranking strategy to use for search results.
    /// Default: KeywordBoost
    /// </summary>
    [JsonConverter(typeof(JsonStringEnumConverter))]
    public RerankingStrategy RerankingStrategy { get; set; } = RerankingStrategy.KeywordBoost;

    #endregion

    #region UI Settings

    /// <summary>
    /// Show RAG status indicator in the main window.
    /// Default: true
    /// </summary>
    public bool ShowStatusIndicator { get; set; } = true;

    /// <summary>
    /// Show notifications for indexing events.
    /// Default: true
    /// </summary>
    public bool ShowIndexingNotifications { get; set; } = true;

    /// <summary>
    /// Last workspace path that was indexed.
    /// Used to restore state on startup.
    /// </summary>
    public string? LastWorkspacePath { get; set; }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Create default settings.
    /// </summary>
    public static RagSettings Default => new();

    #endregion

    #region Validation

    /// <summary>
    /// Validate settings and return any errors.
    /// </summary>
    /// <returns>List of validation error messages (empty if valid).</returns>
    public IReadOnlyList<string> Validate()
    {
        var errors = new List<string>();

        // Chunking validation
        if (ChunkSize < 100 || ChunkSize > 2000)
            errors.Add("Chunk size must be between 100 and 2000 tokens");

        if (ChunkOverlap < 0 || ChunkOverlap >= ChunkSize)
            errors.Add("Chunk overlap must be between 0 and chunk size");

        // File size validation
        if (MaxFileSizeKb < 1 || MaxFileSizeKb > 10240)
            errors.Add("Max file size must be between 1 KB and 10 MB");

        // RAG context validation
        if (MaxRagContextTokens < 500 || MaxRagContextTokens > 16000)
            errors.Add("Max RAG context tokens must be between 500 and 16000");

        if (MinRelevanceScore < 0 || MinRelevanceScore > 1)
            errors.Add("Min relevance score must be between 0 and 1");

        // Auto-index validation
        if (AutoIndexDelaySeconds < 1 || AutoIndexDelaySeconds > 60)
            errors.Add("Auto index delay must be between 1 and 60 seconds");

        return errors;
    }

    #endregion
}
```

---

### 2. WorkspaceIndexInfo.cs

**Location**: `src/AIntern.Core/Models/WorkspaceIndexInfo.cs`
**Purpose**: Information about an indexed workspace

```csharp
namespace AIntern.Core.Models;

using System;

/// <summary>
/// Information about an indexed workspace.
/// </summary>
public sealed class WorkspaceIndexInfo
{
    #region Identity

    /// <summary>
    /// Unique identifier for the index.
    /// </summary>
    public string IndexId { get; init; } = string.Empty;

    /// <summary>
    /// Path to the workspace directory.
    /// </summary>
    public string WorkspacePath { get; init; } = string.Empty;

    /// <summary>
    /// Display name for the workspace.
    /// </summary>
    public string DisplayName { get; init; } = string.Empty;

    #endregion

    #region Timestamps

    /// <summary>
    /// When the workspace was first indexed.
    /// </summary>
    public DateTime CreatedAt { get; init; }

    /// <summary>
    /// When the index was last updated.
    /// </summary>
    public DateTime LastUpdated { get; init; }

    #endregion

    #region Statistics

    /// <summary>
    /// Total number of indexed files.
    /// </summary>
    public int FileCount { get; init; }

    /// <summary>
    /// Total number of chunks in the index.
    /// </summary>
    public int ChunkCount { get; init; }

    /// <summary>
    /// Size of the index in bytes.
    /// </summary>
    public long IndexSizeBytes { get; init; }

    /// <summary>
    /// Number of files that have changed since last update.
    /// </summary>
    public int StaleFileCount { get; init; }

    #endregion

    #region Model Info

    /// <summary>
    /// Embedding model used for this index.
    /// </summary>
    public string? EmbeddingModel { get; init; }

    /// <summary>
    /// Embedding dimension.
    /// </summary>
    public int EmbeddingDimension { get; init; }

    #endregion

    #region State

    /// <summary>
    /// Whether this is the currently active workspace.
    /// </summary>
    public bool IsActive { get; set; }

    #endregion

    #region Computed Properties

    /// <summary>
    /// Human-readable index size.
    /// </summary>
    public string FormattedSize => FormatBytes(IndexSizeBytes);

    /// <summary>
    /// Human-readable last update time.
    /// </summary>
    public string FormattedLastUpdate => FormatTimeAgo(LastUpdated);

    #endregion

    #region Private Helpers

    private static string FormatBytes(long bytes)
    {
        return bytes switch
        {
            < 1024 => $"{bytes} B",
            < 1024 * 1024 => $"{bytes / 1024.0:F1} KB",
            < 1024 * 1024 * 1024 => $"{bytes / (1024.0 * 1024):F1} MB",
            _ => $"{bytes / (1024.0 * 1024 * 1024):F2} GB"
        };
    }

    private static string FormatTimeAgo(DateTime dateTime)
    {
        var elapsed = DateTime.UtcNow - dateTime;

        return elapsed switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)elapsed.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)elapsed.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)elapsed.TotalDays}d ago",
            _ => dateTime.ToLocalTime().ToString("MMM d, yyyy")
        };
    }

    #endregion
}
```

---

### 3. IRagSettingsService.cs

**Location**: `src/AIntern.Services/Settings/IRagSettingsService.cs`
**Purpose**: Service interface for managing RAG settings

```csharp
namespace AIntern.Services.Settings;

using System;
using System.Threading;
using System.Threading.Tasks;
using AIntern.Core.Models;

/// <summary>
/// Service for managing RAG settings.
/// </summary>
public interface IRagSettingsService
{
    /// <summary>
    /// Get current RAG settings.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>Current settings (never null).</returns>
    Task<RagSettings> GetSettingsAsync(CancellationToken ct = default);

    /// <summary>
    /// Save RAG settings.
    /// </summary>
    /// <param name="settings">Settings to save.</param>
    /// <param name="ct">Cancellation token.</param>
    /// <exception cref="ArgumentNullException">
    /// Thrown when settings is null.
    /// </exception>
    /// <exception cref="InvalidOperationException">
    /// Thrown when settings validation fails.
    /// </exception>
    Task SaveSettingsAsync(RagSettings settings, CancellationToken ct = default);

    /// <summary>
    /// Reset settings to defaults.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    Task ResetToDefaultsAsync(CancellationToken ct = default);

    /// <summary>
    /// Event raised when settings change.
    /// </summary>
    event EventHandler<RagSettings>? SettingsChanged;
}
```

---

### 4. AppSettings.cs Modification

**Location**: `src/AIntern.Core/Models/AppSettings.cs`
**Change Type**: Add property

```csharp
// Add to existing AppSettings class:

/// <summary>
/// RAG (Retrieval-Augmented Generation) settings.
/// </summary>
public RagSettings Rag { get; set; } = new();
```

---

## File Summary

### Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `RagSettings.cs` | `src/AIntern.Core/Models/` | RAG configuration model with validation |
| `WorkspaceIndexInfo.cs` | `src/AIntern.Core/Models/` | Indexed workspace metadata |
| `IRagSettingsService.cs` | `src/AIntern.Services/Settings/` | Settings service interface |

### Files to Modify

| File | Location | Change |
|------|----------|--------|
| `AppSettings.cs` | `src/AIntern.Core/Models/` | Add `Rag` property |

### Directory Structure

```
src/
├── AIntern.Core/
│   └── Models/
│       ├── AppSettings.cs           (MODIFY - add Rag property)
│       ├── RagSettings.cs           (NEW - v0.7.5a)
│       └── WorkspaceIndexInfo.cs    (NEW - v0.7.5a)
└── AIntern.Services/
    └── Settings/
        └── IRagSettingsService.cs   (NEW - v0.7.5a)
```

---

## Unit Test Requirements

### Test File: `RagSettingsTests.cs`

**Location**: `tests/AIntern.Core.Tests/Models/RagSettingsTests.cs`
**Test Count**: ~25 tests

```csharp
// Default values tests
[Fact] DefaultValues_AreCorrect()
[Fact] IncludePatterns_ContainsCommonExtensions()
[Fact] ExcludePatterns_ContainsCommonDirectories()

// Validation tests
[Theory] ChunkSize_OutOfRange_ReturnsError()
[Theory] ChunkOverlap_ExceedsChunkSize_ReturnsError()
[Fact] ChunkOverlap_EqualToChunkSize_ReturnsError()
[Theory] MaxFileSizeKb_OutOfRange_ReturnsError()
[Theory] MaxRagContextTokens_OutOfRange_ReturnsError()
[Theory] MinRelevanceScore_OutOfRange_ReturnsError()
[Theory] AutoIndexDelaySeconds_OutOfRange_ReturnsError()
[Fact] ValidSettings_ReturnsEmptyErrorList()
[Fact] MultipleInvalidSettings_ReturnsAllErrors()

// Static factory tests
[Fact] Default_ReturnsNewInstance()
[Fact] Default_HasValidConfiguration()
```

### Test File: `WorkspaceIndexInfoTests.cs`

**Location**: `tests/AIntern.Core.Tests/Models/WorkspaceIndexInfoTests.cs`
**Test Count**: ~12 tests

```csharp
// FormattedSize tests
[Theory] FormattedSize_Bytes_FormatsCorrectly()
[Theory] FormattedSize_Kilobytes_FormatsCorrectly()
[Theory] FormattedSize_Megabytes_FormatsCorrectly()
[Theory] FormattedSize_Gigabytes_FormatsCorrectly()

// FormattedLastUpdate tests
[Fact] FormattedLastUpdate_JustNow_ReturnsCorrectString()
[Fact] FormattedLastUpdate_MinutesAgo_ReturnsCorrectString()
[Fact] FormattedLastUpdate_HoursAgo_ReturnsCorrectString()
[Fact] FormattedLastUpdate_DaysAgo_ReturnsCorrectString()
[Fact] FormattedLastUpdate_OlderThanWeek_ReturnsFormattedDate()
```

---

## Acceptance Criteria

- [ ] `RagSettings` class defined with all configuration properties
- [ ] `RagSettings.Validate()` returns appropriate error messages for invalid configurations
- [ ] `RagSettings.Default` returns a valid, default configuration
- [ ] Default include patterns cover common programming languages
- [ ] Default exclude patterns cover common build/dependency directories
- [ ] `WorkspaceIndexInfo` class defined with all metadata properties
- [ ] `WorkspaceIndexInfo.FormattedSize` correctly formats byte sizes
- [ ] `WorkspaceIndexInfo.FormattedLastUpdate` correctly formats relative times
- [ ] `IRagSettingsService` interface defined with all methods and events
- [ ] `AppSettings.Rag` property added to existing class
- [ ] All classes have comprehensive XML documentation comments
- [ ] Build succeeds with no warnings
- [ ] ~37 unit tests implemented and passing

---

## Changelog Entry

```markdown
## v0.7.5a - RAG Settings Model & Storage

### Added

- `RagSettings` model with 18 configuration properties across 5 categories:
  - Global settings (Enabled, EmbeddingModelPath, EmbeddingModelType)
  - Auto-indexing settings (AutoIndexEnabled, AutoIndexDelaySeconds)
  - File filter settings (RespectGitignore, IndexHiddenFiles, MaxFileSizeKb, IncludePatterns, ExcludePatterns)
  - Chunking settings (ChunkSize, ChunkOverlap)
  - RAG chat settings (EnableRagInChat, MaxRagContextTokens, MaxRagChunks, MinRelevanceScore, RerankingStrategy)
  - UI settings (ShowStatusIndicator, ShowIndexingNotifications, LastWorkspacePath)
- `RagSettings.Validate()` method with 6 validation rules
- `RagSettings.Default` static factory property
- Default include patterns for 21 file extensions
- Default exclude patterns for 14 directories/files
- `WorkspaceIndexInfo` model with 12 properties for index metadata
- `WorkspaceIndexInfo.FormattedSize` computed property
- `WorkspaceIndexInfo.FormattedLastUpdate` computed property
- `IRagSettingsService` interface with GetSettingsAsync, SaveSettingsAsync, ResetToDefaultsAsync
- `IRagSettingsService.SettingsChanged` event for reactive updates
- `AppSettings.Rag` property integration

### Dependencies

- Requires `RerankingStrategy` enum from v0.7.4
- Requires `EmbeddingModelType` enum from v0.7.1a
```

---

## Integration Notes

### Usage in v0.7.5b (Index Manager Dialog UI)

The `RagSettings` model will be used by `IndexManagerViewModel` to:
- Populate UI controls with current settings
- Build `IndexingOptions` for indexing operations
- Persist user preferences via `IRagSettingsService`

### Usage in v0.7.5f (RAG Settings Panel)

The settings panel will display all `RagSettings` properties organized by category:
- Binding to individual properties via data context
- Calling `Validate()` before save
- Raising `SettingsChanged` event for dependent services

### Usage in v0.7.5g (Auto-Indexing File Watcher)

The `IFileWatcherService` will subscribe to `SettingsChanged` to:
- Enable/disable watching based on `AutoIndexEnabled`
- Apply `AutoIndexDelaySeconds` debounce
- Honor `RespectGitignore` and `IndexHiddenFiles` settings

### JSON Serialization Example

```json
{
  "rag": {
    "enabled": true,
    "embeddingModelPath": "/models/nomic-embed-text-v1.5.Q8_0.gguf",
    "embeddingModelType": "Gguf",
    "autoIndexEnabled": true,
    "autoIndexDelaySeconds": 2,
    "respectGitignore": true,
    "indexHiddenFiles": false,
    "maxFileSizeKb": 1024,
    "includePatterns": ["**/*.cs", "**/*.ts", "**/*.py"],
    "excludePatterns": ["**/node_modules/**", "**/bin/**"],
    "chunkSize": 512,
    "chunkOverlap": 64,
    "enableRagInChat": true,
    "maxRagContextTokens": 4000,
    "maxRagChunks": 10,
    "minRelevanceScore": 0.5,
    "rerankingStrategy": "KeywordBoost",
    "showStatusIndicator": true,
    "showIndexingNotifications": true,
    "lastWorkspacePath": "/Users/dev/projects/myapp"
  }
}
```
