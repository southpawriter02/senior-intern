# Design Specification: AIntern v0.7.5e "RAG Status Indicator"

## Overview

**Version**: v0.7.5e  
**Parent**: v0.7.5 UI & Integration  
**Focus**: Status bar indicator showing RAG status with tooltip and click-to-open functionality

### Purpose

This sub-version creates a compact status indicator displayed in the main window:
1. `RagStatusIndicator.axaml` - UserControl with colored dot, text, and tooltip
2. `RagStatusIndicator.axaml.cs` - Code-behind for click handling
3. `RagStatusViewModel.cs` - ViewModel tracking index status and providing click command

### Dependencies

**From v0.7.5a**: `RagSettings`, `WorkspaceIndexInfo`, `IRagSettingsService`  
**From v0.7.2**: `IVectorStore` for index info queries  
**From v0.7.5b-d**: `IndexManagerDialog` for click-to-open  
**From Avalonia**: `UserControl`, `ToolTip`, `Ellipse` controls

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     v0.7.5e RAG Status Indicator Architecture                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Main Window Status Bar                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  [Other Status Items]                    [RagStatusIndicator]           │ │
│  │                                          ● RAG: Indexed (1,234 files)   │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  RagStatusIndicator : UserControl                                        │ │
│  │  src/AIntern.Desktop/Controls/RagStatusIndicator.axaml                  │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  Visual Structure:                                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  [●] RAG: {StatusText}                                              ││ │
│  │  │   ↑                                                                  ││ │
│  │  │   StatusColor (Green/Gray/Blue/Orange/Red)                          ││ │
│  │  │                                                                      ││ │
│  │  │  ToolTip:                                                           ││ │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  ││ │
│  │  │  │  Workspace: /path/to/project                                  │  ││ │
│  │  │  │  Files: 1,234  |  Chunks: 8,567                               │  ││ │
│  │  │  │  Last Updated: 2 hours ago                                    │  ││ │
│  │  │  │  Click to open Index Manager                                  │  ││ │
│  │  │  └───────────────────────────────────────────────────────────────┘  ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  RagStatusViewModel                                                      │ │
│  │  src/AIntern.Desktop/ViewModels/RagStatusViewModel.cs                   │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  Status States:                                                          │ │
│  │  ├── Disabled   → Gray    "RAG: Disabled"                               │ │
│  │  ├── NotIndexed → Gray    "RAG: Not Indexed"                            │ │
│  │  ├── Indexed    → Green   "RAG: Indexed (N files)"                      │ │
│  │  ├── Indexing   → Blue    "RAG: Indexing..."                            │ │
│  │  ├── Stale      → Orange  "RAG: Stale (N outdated)"                     │ │
│  │  └── Error      → Red     "RAG: Error"                                  │ │
│  │                                                                          │ │
│  │  Properties:                                                             │ │
│  │  ├── StatusColor, StatusText, TooltipText                               │ │
│  │  ├── IsVisible, WorkspacePath                                           │ │
│  │  ├── FileCount, ChunkCount, StaleCount, LastUpdated                     │ │
│  │  │                                                                       │ │
│  │  Commands:                                                               │ │
│  │  └── OpenIndexManagerCommand                                            │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Event Flow:                                                                 │
│  ┌────────────────┐   SettingsChanged    ┌──────────────────┐               │
│  │ IRagSettings   │ ───────────────────► │ RagStatusVM      │               │
│  │ Service        │                      │                  │               │
│  └────────────────┘                      └──────────────────┘               │
│                                                   │                          │
│  ┌────────────────┐   IndexChanged       ┌───────▼──────────┐               │
│  │ IVectorStore   │ ───────────────────► │ RefreshStatus()  │               │
│  │                │                      │                  │               │
│  └────────────────┘                      └──────────────────┘               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Visual States

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Status Indicator Visual States                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. Disabled (Gray)                                                          │
│     ○ RAG: Disabled                                                          │
│     Tooltip: "RAG is disabled. Click to configure."                          │
│                                                                              │
│  2. Not Indexed (Gray)                                                       │
│     ○ RAG: Not Indexed                                                       │
│     Tooltip: "No workspace indexed. Click to index a workspace."             │
│                                                                              │
│  3. Indexed (Green)                                                          │
│     ● RAG: Indexed (1,234 files)                                             │
│     Tooltip: "Workspace: /path/to/project                                    │
│               Files: 1,234 | Chunks: 8,567                                   │
│               Last Updated: 2 hours ago                                      │
│               Click to open Index Manager"                                   │
│                                                                              │
│  4. Indexing (Blue, animated)                                                │
│     ◐ RAG: Indexing... 45%                                                   │
│     Tooltip: "Indexing in progress: 45 of 100 files                          │
│               Click to view progress"                                        │
│                                                                              │
│  5. Stale (Orange)                                                           │
│     ● RAG: Stale (12 outdated)                                               │
│     Tooltip: "12 files have changed since last index.                        │
│               Click to update index."                                        │
│                                                                              │
│  6. Error (Red)                                                              │
│     ● RAG: Error                                                             │
│     Tooltip: "Index error: [error message]                                   │
│               Click to view details."                                        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. RagStatusIndicator.axaml

**Location**: `src/AIntern.Desktop/Controls/RagStatusIndicator.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             x:Class="AIntern.Desktop.Controls.RagStatusIndicator"
             x:DataType="vm:RagStatusViewModel"
             IsVisible="{Binding IsVisible}">

    <UserControl.Styles>
        <!-- Hover effect -->
        <Style Selector="Border.StatusContainer:pointerover">
            <Setter Property="Background" 
                    Value="{DynamicResource SystemControlBackgroundListLowBrush}"/>
        </Style>
    </UserControl.Styles>

    <Border Classes="StatusContainer"
            CornerRadius="4"
            Padding="8,4"
            Cursor="Hand">
        
        <Border.InputBindings>
            <Binding Path="OpenIndexManagerCommand"/>
        </Border.InputBindings>

        <ToolTip.Tip>
            <StackPanel MaxWidth="300">
                <TextBlock Text="{Binding TooltipTitle}"
                           FontWeight="SemiBold"
                           Margin="0,0,0,4"/>
                <TextBlock Text="{Binding TooltipDetails}"
                           TextWrapping="Wrap"
                           Opacity="0.8"/>
                <Separator Margin="0,8"/>
                <TextBlock Text="Click to open Index Manager"
                           Opacity="0.6"
                           FontSize="11"/>
            </StackPanel>
        </ToolTip.Tip>

        <StackPanel Orientation="Horizontal" Spacing="6">
            <!-- Status Dot -->
            <Ellipse Width="8" Height="8"
                     Fill="{Binding StatusColor}"
                     VerticalAlignment="Center"/>

            <!-- Status Text -->
            <TextBlock Text="{Binding StatusText}"
                       VerticalAlignment="Center"
                       FontSize="12"/>
        </StackPanel>
    </Border>
</UserControl>
```

### 2. RagStatusIndicator.axaml.cs

**Location**: `src/AIntern.Desktop/Controls/RagStatusIndicator.axaml.cs`

```csharp
namespace AIntern.Desktop.Controls;

using Avalonia.Controls;
using Avalonia.Input;
using AIntern.Desktop.ViewModels;

/// <summary>
/// Status indicator control for RAG/indexing state.
/// </summary>
public partial class RagStatusIndicator : UserControl
{
    public RagStatusIndicator()
    {
        InitializeComponent();
    }

    protected override void OnPointerPressed(PointerPressedEventArgs e)
    {
        base.OnPointerPressed(e);
        
        if (DataContext is RagStatusViewModel vm && 
            vm.OpenIndexManagerCommand.CanExecute(null))
        {
            vm.OpenIndexManagerCommand.Execute(null);
        }
    }
}
```

### 3. RagStatusViewModel.cs

**Location**: `src/AIntern.Desktop/ViewModels/RagStatusViewModel.cs`

```csharp
namespace AIntern.Desktop.ViewModels;

using Avalonia.Media;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Microsoft.Extensions.Logging;
using AIntern.Core.RAG.Settings;
using AIntern.Core.RAG.Storage;

/// <summary>
/// ViewModel for the RAG status indicator control.
/// </summary>
public partial class RagStatusViewModel : ObservableObject, IDisposable
{
    private readonly IRagSettingsService _settingsService;
    private readonly IVectorStore _vectorStore;
    private readonly ILogger<RagStatusViewModel> _logger;
    private readonly Func<Task> _openIndexManagerAction;

    #region Observable Properties

    [ObservableProperty]
    private bool _isVisible = true;

    [ObservableProperty]
    private IBrush _statusColor = Brushes.Gray;

    [ObservableProperty]
    private string _statusText = "RAG: Not Indexed";

    [ObservableProperty]
    private string _tooltipTitle = "RAG Status";

    [ObservableProperty]
    private string _tooltipDetails = string.Empty;

    [ObservableProperty]
    private RagStatus _currentStatus = RagStatus.NotIndexed;

    #endregion

    #region Constructor

    public RagStatusViewModel(
        IRagSettingsService settingsService,
        IVectorStore vectorStore,
        Func<Task> openIndexManagerAction,
        ILogger<RagStatusViewModel> logger)
    {
        _settingsService = settingsService;
        _vectorStore = vectorStore;
        _openIndexManagerAction = openIndexManagerAction;
        _logger = logger;

        // Subscribe to settings changes
        _settingsService.SettingsChanged += OnSettingsChanged;
        _vectorStore.IndexChanged += OnIndexChanged;
    }

    #endregion

    #region Initialization

    public async Task InitializeAsync()
    {
        _logger.LogDebug("Initializing RagStatusViewModel");
        await RefreshStatusAsync();
    }

    #endregion

    #region Status Refresh

    public async Task RefreshStatusAsync()
    {
        try
        {
            var settings = await _settingsService.GetSettingsAsync();

            if (!settings.Enabled)
            {
                SetStatus(RagStatus.Disabled, "RAG: Disabled", Brushes.Gray,
                    "RAG Disabled", "RAG is disabled. Click to configure.");
                return;
            }

            IsVisible = settings.ShowStatusIndicator;

            if (string.IsNullOrEmpty(settings.LastWorkspacePath))
            {
                SetStatus(RagStatus.NotIndexed, "RAG: Not Indexed", Brushes.Gray,
                    "Not Indexed", "No workspace indexed. Click to index a workspace.");
                return;
            }

            var info = await _vectorStore.GetIndexInfoAsync(settings.LastWorkspacePath);

            if (info == null)
            {
                SetStatus(RagStatus.NotIndexed, "RAG: Not Indexed", Brushes.Gray,
                    "Not Indexed", "No workspace indexed. Click to index a workspace.");
                return;
            }

            if (info.StaleFileCount > 0)
            {
                SetStatus(RagStatus.Stale, 
                    $"RAG: Stale ({info.StaleFileCount} outdated)", 
                    Brushes.Orange,
                    "Index Stale",
                    $"{info.StaleFileCount} files have changed since last index.\n" +
                    $"Workspace: {info.WorkspacePath}\n" +
                    $"Last Updated: {info.FormattedLastUpdate}");
                return;
            }

            SetStatus(RagStatus.Indexed,
                $"RAG: Indexed ({info.FileCount:N0} files)",
                Brushes.LimeGreen,
                "Index Ready",
                $"Workspace: {info.WorkspacePath}\n" +
                $"Files: {info.FileCount:N0} | Chunks: {info.ChunkCount:N0}\n" +
                $"Last Updated: {info.FormattedLastUpdate}");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to refresh RAG status");
            SetStatus(RagStatus.Error, "RAG: Error", Brushes.Tomato,
                "Error", $"Failed to load index status: {ex.Message}");
        }
    }

    private void SetStatus(RagStatus status, string text, IBrush color, 
        string title, string details)
    {
        CurrentStatus = status;
        StatusText = text;
        StatusColor = color;
        TooltipTitle = title;
        TooltipDetails = details;
    }

    #endregion

    #region Event Handlers

    private async void OnSettingsChanged(object? sender, RagSettings settings)
    {
        _logger.LogDebug("Settings changed, refreshing status");
        await RefreshStatusAsync();
    }

    private async void OnIndexChanged(object? sender, string workspacePath)
    {
        _logger.LogDebug("Index changed for {Path}, refreshing status", workspacePath);
        await RefreshStatusAsync();
    }

    #endregion

    #region Commands

    [RelayCommand]
    private async Task OpenIndexManagerAsync()
    {
        _logger.LogDebug("Opening Index Manager from status indicator");
        await _openIndexManagerAction();
    }

    #endregion

    #region IDisposable

    public void Dispose()
    {
        _settingsService.SettingsChanged -= OnSettingsChanged;
        _vectorStore.IndexChanged -= OnIndexChanged;
    }

    #endregion
}

/// <summary>
/// RAG status states.
/// </summary>
public enum RagStatus
{
    Disabled,
    NotIndexed,
    Indexed,
    Indexing,
    Stale,
    Error
}
```

---

## Integration with MainWindow

```xml
<!-- In MainWindow.axaml status bar area -->
<Border Grid.Row="2" 
        Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
        Height="24">
    <Grid ColumnDefinitions="*,Auto">
        <!-- Other status items -->
        <StackPanel Grid.Column="0" Orientation="Horizontal">
            <!-- ... -->
        </StackPanel>
        
        <!-- RAG Status Indicator -->
        <controls:RagStatusIndicator Grid.Column="1"
                                      DataContext="{Binding RagStatus}"
                                      Margin="8,0"/>
    </Grid>
</Border>
```

---

## Unit Test Requirements

**File**: `tests/AIntern.Desktop.Tests/ViewModels/RagStatusViewModelTests.cs`

| Test | Description |
|------|-------------|
| `RefreshStatusAsync_Disabled_SetsGrayStatus` | Verify disabled state |
| `RefreshStatusAsync_NotIndexed_SetsGrayStatus` | Verify not indexed state |
| `RefreshStatusAsync_Indexed_SetsGreenStatus` | Verify indexed state |
| `RefreshStatusAsync_Stale_SetsOrangeStatus` | Verify stale state |
| `RefreshStatusAsync_Error_SetsRedStatus` | Verify error state |
| `OnSettingsChanged_RefreshesStatus` | Verify settings event handling |
| `OnIndexChanged_RefreshesStatus` | Verify index event handling |
| `OpenIndexManagerCommand_InvokesAction` | Verify click action |
| `IsVisible_RespectsSettingsFlag` | Verify visibility binding |
| `Dispose_UnsubscribesFromEvents` | Verify cleanup |

---

## Acceptance Criteria

- [ ] Control displays colored dot and text
- [ ] Dot color matches status (Green/Gray/Blue/Orange/Red)
- [ ] Text shows file count when indexed
- [ ] Tooltip displays workspace path, file/chunk counts, and last update
- [ ] Clicking opens Index Manager dialog
- [ ] Hover effect highlights control
- [ ] Status auto-refreshes on settings/index changes
- [ ] Control respects `ShowStatusIndicator` setting
- [ ] Unit tests achieve >90% coverage

---

## Changelog Entry

```markdown
## v0.7.5e - RAG Status Indicator

### Added

- `RagStatusIndicator.axaml` UserControl with:
  - Colored status dot (8x8 Ellipse)
  - Status text showing state and file count
  - Rich tooltip with workspace info and statistics
  - Hover highlight effect
  - Click-to-open Index Manager
- `RagStatusIndicator.axaml.cs` with pointer press handling
- `RagStatusViewModel` with:
  - Six status states: Disabled, NotIndexed, Indexed, Indexing, Stale, Error
  - Color mapping: Gray, Green, Blue, Orange, Red
  - Event subscriptions to `SettingsChanged` and `IndexChanged`
  - `RefreshStatusAsync()` for status updates
  - `OpenIndexManagerCommand` for click handling
  - `IDisposable` for proper cleanup
- `RagStatus` enum defining all possible states
- MainWindow integration in status bar
```
