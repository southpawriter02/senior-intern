# Design Specification: The Senior Intern v0.4.2e "Side-by-Side View"

**Status**: _IMPLEMENTED_

## Executive Summary

This document provides a detailed implementation specification for v0.4.2e, which creates the main DiffViewerPanel UserControl with synchronized side-by-side scrolling. This panel is the primary visual component for displaying file diffs, combining the ViewModels (v0.4.2d) with Avalonia UI controls.

The DiffViewerPanel provides a complete diff viewing experience with: a header showing file information, statistics, navigation controls, and view options; two synchronized scroll panels displaying original and proposed content; a resizable splitter between panels; footer actions for applying or rejecting changes; and loading/error overlays for async operations.

### v0.4.2e Scope

- Create `DiffViewerPanel.axaml` with complete side-by-side layout structure
- Create `DiffViewerPanel.axaml.cs` with synchronized scrolling logic
- Implement header with file info, diff stats, hunk navigation, and toolbar
- Implement side-by-side content panels with `ScrollViewer` controls
- Implement `GridSplitter` for resizable panel widths
- Implement footer with Apply/Reject action buttons
- Implement loading and error overlay states
- Wire up event handlers for hunk navigation scrolling

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| DiffViewerPanel.axaml | Main XAML layout with header, side-by-side panels, footer, overlays |
| DiffViewerPanel.axaml.cs | Code-behind with synchronized scrolling and navigation |
| Synchronized Scrolling | Bidirectional scroll sync using `_isSyncingScroll` guard |
| Hunk Navigation Handler | `OnHunkNavigationRequested` event handler with `BringIntoView` |
| Header Layout | File info, language badge, new file badge, statistics display |
| Navigation Controls | Previous/Next hunk buttons with current/total display |
| Toolbar Controls | Toggle buttons for inline changes, word wrap, sync scroll |
| Footer Actions | Apply Changes, Reject, and Open in Editor buttons |
| Overlay States | Loading overlay with progress, error overlay with message |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.4.2e Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  DiffViewerPanel                                                  │
│  ├── Header Section (Grid.Row="0")                                │
│  │   ├── File Info (Column 0)                                     │
│  │   │   ├── FileCodeIcon                                         │
│  │   │   ├── FileName TextBlock                                   │
│  │   │   ├── Language Badge (conditional)                         │
│  │   │   └── NEW FILE Badge (conditional)                         │
│  │   │                                                            │
│  │   ├── Statistics Display (Column 1, centered)                  │
│  │   │   ├── Added Lines (+N) in green                            │
│  │   │   ├── Removed Lines (-N) in red                            │
│  │   │   └── Hunk Count (N hunks)                                 │
│  │   │                                                            │
│  │   ├── Navigation Controls (Column 2)                           │
│  │   │   ├── Position Display (N/M with converter)                │
│  │   │   ├── Previous Hunk Button (Ctrl+↑)                        │
│  │   │   └── Next Hunk Button (Ctrl+↓)                            │
│  │   │                                                            │
│  │   └── Toolbar (Column 3)                                       │
│  │       ├── Toggle Inline Changes (HighlightIcon)                │
│  │       ├── Toggle Word Wrap (WrapTextIcon)                      │
│  │       └── Toggle Synchronized Scroll (LinkIcon)                │
│  │                                                                │
│  ├── Side-by-Side Content (Grid.Row="1")                          │
│  │   ├── Original Panel (Column 0)                                │
│  │   │   ├── Panel Header ("Original")                            │
│  │   │   └── ScrollViewer (x:Name="OriginalScrollViewer")         │
│  │   │       └── ItemsControl with DiffHunkControl (Side=Original)│
│  │   │                                                            │
│  │   ├── GridSplitter (Column 1)                                  │
│  │   │   └── Resizable divider, 1px width                         │
│  │   │                                                            │
│  │   └── Proposed Panel (Column 2)                                │
│  │       ├── Panel Header ("Proposed")                            │
│  │       └── ScrollViewer (x:Name="ProposedScrollViewer")         │
│  │           └── ItemsControl with DiffHunkControl (Side=Proposed)│
│  │                                                                │
│  ├── Footer Section (Grid.Row="2")                                │
│  │   ├── Open in Editor Button (secondary, left)                  │
│  │   └── Action Buttons (right)                                   │
│  │       ├── Reject Button (secondary)                            │
│  │       └── Apply Changes Button (primary accent)                │
│  │                                                                │
│  ├── Loading Overlay (Grid.RowSpan="3")                           │
│  │   ├── Semi-transparent background                              │
│  │   ├── Indeterminate ProgressBar                                │
│  │   └── "Computing diff..." text                                 │
│  │                                                                │
│  └── Error Overlay (Grid.RowSpan="3")                             │
│      ├── Error background color                                   │
│      ├── ErrorIcon                                                │
│      └── Error message with text wrapping                         │
│                                                                   │
│  Code-Behind Features                                             │
│  ├── Synchronized Scrolling                                       │
│  │   ├── _isSyncingScroll guard flag                              │
│  │   ├── OnOriginalScrollChanged handler                          │
│  │   └── OnProposedScrollChanged handler                          │
│  │                                                                │
│  ├── Event Subscription                                           │
│  │   └── OnDataContextChanged → HunkNavigationRequested           │
│  │                                                                │
│  └── Hunk Navigation                                              │
│      ├── OnHunkNavigationRequested handler                        │
│      └── ScrollToHunk with BringIntoView                          │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Panel Layout Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                     DiffViewerPanel                              │
├─────────────────────────────────────────────────────────────────┤
│  Grid RowDefinitions="Auto, *, Auto"                             │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Row 0: Header (Auto)                                       │   │
│  │  ColumnDefinitions="Auto, *, Auto, Auto"                   │   │
│  │  ┌──────────┬───────────────┬──────────┬──────────┐        │   │
│  │  │ FileInfo │    Stats      │ Nav Btns │ Toolbar  │        │   │
│  │  │ (Auto)   │ (centered, *) │ (Auto)   │ (Auto)   │        │   │
│  │  └──────────┴───────────────┴──────────┴──────────┘        │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Row 1: Content (*)                                         │   │
│  │  ColumnDefinitions="*, 1, *"                               │   │
│  │  ┌──────────────────┬─┬──────────────────┐                 │   │
│  │  │   Original       │█│   Proposed       │                 │   │
│  │  │                  │ │                  │                 │   │
│  │  │  ┌────────────┐  │S│  ┌────────────┐  │                 │   │
│  │  │  │ScrollViewer│  │p│  │ScrollViewer│  │                 │   │
│  │  │  │   (sync)   │◄─┼l┼─►│   (sync)   │  │                 │   │
│  │  │  │            │  │i│  │            │  │                 │   │
│  │  │  │ ItemsCtrl  │  │t│  │ ItemsCtrl  │  │                 │   │
│  │  │  │ (Hunks)    │  │ │  │ (Hunks)    │  │                 │   │
│  │  │  └────────────┘  │ │  └────────────┘  │                 │   │
│  │  │       (*)        │1│       (*)        │                 │   │
│  │  └──────────────────┴─┴──────────────────┘                 │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Row 2: Footer (Auto)                                       │   │
│  │  ColumnDefinitions="Auto, *, Auto"                         │   │
│  │  ┌────────────────┬─────────────────┬─────────────────┐    │   │
│  │  │ Open in Editor │                 │ Reject │ Apply  │    │   │
│  │  │    (Auto)      │       (*)       │     (Auto)      │    │   │
│  │  └────────────────┴─────────────────┴─────────────────┘    │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Overlay Layers (Grid.RowSpan="3", conditional visibility)       │
│  ├── Loading Overlay (IsVisible="{Binding IsLoading}")           │
│  └── Error Overlay (IsVisible=ErrorMessage != null)              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Synchronized Scrolling Flow

```
┌──────────────────────────────────────────────────────────────────┐
│                  Synchronized Scrolling Logic                     │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  User scrolls Original panel:                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                                                              │  │
│  │    OriginalScrollViewer                                      │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │    ScrollChanged event fires                                 │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │    OnOriginalScrollChanged()                                 │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │    ┌─────────────────────────────┐                           │  │
│  │    │ if (_isSyncingScroll)       │──── true ──→ return       │  │
│  │    └─────────────────────────────┘                           │  │
│  │          │ false                                             │  │
│  │          ▼                                                   │  │
│  │    ┌─────────────────────────────┐                           │  │
│  │    │ if (SynchronizedScroll)     │──── false ─→ return       │  │
│  │    └─────────────────────────────┘                           │  │
│  │          │ true                                              │  │
│  │          ▼                                                   │  │
│  │    _isSyncingScroll = true       ◄─── Set guard              │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │    ProposedScrollViewer.Offset = OriginalScrollViewer.Offset │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │    _isSyncingScroll = false      ◄─── Clear guard            │  │
│  │                                                              │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  The guard prevents infinite scroll loops:                        │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │  Original scrolls → fires event → syncs Proposed             │  │
│  │       ↑                                    │                 │  │
│  │       │      BLOCKED by _isSyncingScroll   │                 │  │
│  │       └────────────────────────────────────┘                 │  │
│  │  (Proposed.ScrollChanged fires but handler returns early)    │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### Hunk Navigation Flow

```
┌──────────────────────────────────────────────────────────────────┐
│                    Hunk Navigation Flow                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ 1. User clicks Previous/Next button or presses Ctrl+↑/↓    │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ 2. DiffViewerViewModel executes PreviousHunk/NextHunkCmd   │   │
│  │    - Updates CurrentHunkIndex                               │   │
│  │    - Raises HunkNavigationRequested(newIndex) event         │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ 3. DiffViewerPanel.OnHunkNavigationRequested receives event │   │
│  │    (subscribed in OnDataContextChanged)                     │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ 4. ScrollToHunk(hunkIndex) called                           │   │
│  │    - Gets ItemsControl from OriginalScrollViewer.Content    │   │
│  │    - Finds container at index via ItemContainerGenerator    │   │
│  │    - Calls BringIntoView() on hunk control                  │   │
│  └────────────────────────────────────────────────────────────┘   │
│                           │                                       │
│                           ▼                                       │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ 5. Both panels scroll to show the hunk                      │   │
│  │    (synchronized scrolling handles Proposed panel)          │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### DiffViewerPanel.axaml

The main XAML file defines the complete visual layout of the diff viewer panel.

```xml
<!-- src/SeniorIntern.Desktop/Views/DiffViewerPanel.axaml -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             xmlns:controls="using:SeniorIntern.Desktop.Controls"
             x:Class="SeniorIntern.Desktop.Views.DiffViewerPanel"
             x:DataType="vm:DiffViewerViewModel">

    <Grid RowDefinitions="Auto, *, Auto">
        <!-- Header -->
        <Border Grid.Row="0" Classes="diff-header">
            <Grid ColumnDefinitions="Auto, *, Auto, Auto">
                <!-- File info -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="12,8">
                    <PathIcon Data="{StaticResource FileCodeIcon}"
                              Width="16" Height="16" />
                    <TextBlock Text="{Binding FileName}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center" />
                    <Border Classes="language-badge"
                            IsVisible="{Binding Language,
                                Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding Language}" FontSize="11" />
                    </Border>
                    <Border Classes="new-file-badge" IsVisible="{Binding IsNewFile}">
                        <TextBlock Text="NEW FILE" FontSize="10" FontWeight="Bold" />
                    </Border>
                </StackPanel>

                <!-- Stats -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Spacing="16"
                            Margin="0,8">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="+"
                                   Foreground="{DynamicResource DiffAddedForeground}"
                                   FontWeight="Bold" />
                        <TextBlock Text="{Binding DiffResult.Stats.AddedLines}"
                                   Foreground="{DynamicResource DiffAddedForeground}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="-"
                                   Foreground="{DynamicResource DiffRemovedForeground}"
                                   FontWeight="Bold" />
                        <TextBlock Text="{Binding DiffResult.Stats.RemovedLines}"
                                   Foreground="{DynamicResource DiffRemovedForeground}" />
                    </StackPanel>
                    <TextBlock Text="{Binding TotalHunks, StringFormat='{}{0} hunks'}"
                               Foreground="{DynamicResource TextMuted}"
                               FontSize="12" />
                </StackPanel>

                <!-- Navigation -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="4"
                            Margin="8">
                    <TextBlock VerticalAlignment="Center"
                               Margin="0,0,8,0">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0}/{1}">
                                <Binding Path="CurrentHunkIndex"
                                         Converter="{StaticResource IncrementConverter}" />
                                <Binding Path="TotalHunks" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                    <Button Classes="icon-button"
                            Command="{Binding PreviousHunkCommand}"
                            IsEnabled="{Binding CanNavigatePrevious}"
                            ToolTip.Tip="Previous change (Ctrl+↑)">
                        <PathIcon Data="{StaticResource ChevronUpIcon}" Width="14" Height="14" />
                    </Button>
                    <Button Classes="icon-button"
                            Command="{Binding NextHunkCommand}"
                            IsEnabled="{Binding CanNavigateNext}"
                            ToolTip.Tip="Next change (Ctrl+↓)">
                        <PathIcon Data="{StaticResource ChevronDownIcon}" Width="14" Height="14" />
                    </Button>
                </StackPanel>

                <!-- Toolbar -->
                <StackPanel Grid.Column="3"
                            Orientation="Horizontal"
                            Spacing="4"
                            Margin="8">
                    <ToggleButton Classes="icon-button"
                                  IsChecked="{Binding ShowInlineChanges}"
                                  ToolTip.Tip="Show character-level changes">
                        <PathIcon Data="{StaticResource HighlightIcon}" Width="14" Height="14" />
                    </ToggleButton>
                    <ToggleButton Classes="icon-button"
                                  IsChecked="{Binding WordWrap}"
                                  ToolTip.Tip="Word wrap">
                        <PathIcon Data="{StaticResource WrapTextIcon}" Width="14" Height="14" />
                    </ToggleButton>
                    <ToggleButton Classes="icon-button"
                                  IsChecked="{Binding SynchronizedScroll}"
                                  ToolTip.Tip="Synchronized scrolling">
                        <PathIcon Data="{StaticResource LinkIcon}" Width="14" Height="14" />
                    </ToggleButton>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Side-by-Side Content -->
        <Grid Grid.Row="1" ColumnDefinitions="*, 1, *">
            <!-- Original Panel -->
            <Border Grid.Column="0" Classes="diff-panel original">
                <Grid RowDefinitions="Auto, *">
                    <Border Classes="panel-header" Padding="12,6">
                        <TextBlock Text="Original"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextMuted}" />
                    </Border>
                    <ScrollViewer Grid.Row="1"
                                  x:Name="OriginalScrollViewer"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding Hunks}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:DiffHunkViewModel}">
                                    <controls:DiffHunkControl
                                        Side="Original"
                                        ShowInlineChanges="{Binding ShowInlineChanges}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1"
                          Width="1"
                          Background="{DynamicResource DiffSplitterBackground}"
                          ResizeDirection="Columns" />

            <!-- Proposed Panel -->
            <Border Grid.Column="2" Classes="diff-panel proposed">
                <Grid RowDefinitions="Auto, *">
                    <Border Classes="panel-header" Padding="12,6">
                        <TextBlock Text="Proposed"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextMuted}" />
                    </Border>
                    <ScrollViewer Grid.Row="1"
                                  x:Name="ProposedScrollViewer"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding Hunks}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:DiffHunkViewModel}">
                                    <controls:DiffHunkControl
                                        Side="Proposed"
                                        ShowInlineChanges="{Binding ShowInlineChanges}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- Footer Actions -->
        <Border Grid.Row="2" Classes="diff-footer" Padding="12,8">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <Button Content="Open in Editor"
                        Classes="secondary"
                        Command="{Binding OpenInEditorCommand}" />

                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="8">
                    <Button Content="Reject"
                            Classes="secondary"
                            Command="{Binding RequestRejectCommand}" />
                    <Button Content="Apply Changes"
                            Classes="primary accent"
                            Command="{Binding RequestApplyCommand}" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Loading Overlay -->
        <Border Grid.RowSpan="3"
                Background="#80000000"
                IsVisible="{Binding IsLoading}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="12">
                <ProgressBar IsIndeterminate="True" Width="120" />
                <TextBlock Text="Computing diff..."
                           Foreground="White" />
            </StackPanel>
        </Border>

        <!-- Error Overlay -->
        <Border Grid.RowSpan="3"
                Background="{DynamicResource ErrorBackground}"
                IsVisible="{Binding ErrorMessage,
                    Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Padding="24">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="12">
                <PathIcon Data="{StaticResource ErrorIcon}"
                          Width="32" Height="32"
                          Foreground="{DynamicResource ErrorForeground}" />
                <TextBlock Text="{Binding ErrorMessage}"
                           TextWrapping="Wrap"
                           MaxWidth="400"
                           TextAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
```

### Header Section Details

The header provides comprehensive file and diff information:

| Element | Purpose | Binding |
|---------|---------|---------|
| FileCodeIcon | Visual indicator for code file | Static resource |
| FileName | Display the file being diffed | `{Binding FileName}` |
| Language Badge | Show detected language | `{Binding Language}` with visibility converter |
| NEW FILE Badge | Indicate new file creation | `{Binding IsNewFile}` |
| Added Lines | Green "+N" display | `{Binding DiffResult.Stats.AddedLines}` |
| Removed Lines | Red "-N" display | `{Binding DiffResult.Stats.RemovedLines}` |
| Hunk Count | "N hunks" text | `{Binding TotalHunks}` |
| Position Display | "N/M" current position | MultiBinding with IncrementConverter |
| Previous Button | Navigate to previous hunk | `{Binding PreviousHunkCommand}` |
| Next Button | Navigate to next hunk | `{Binding NextHunkCommand}` |
| Inline Changes Toggle | Show character-level diffs | `{Binding ShowInlineChanges}` |
| Word Wrap Toggle | Enable text wrapping | `{Binding WordWrap}` |
| Sync Scroll Toggle | Lock scroll positions | `{Binding SynchronizedScroll}` |

### DiffViewerPanel.axaml.cs

The code-behind implements synchronized scrolling and hunk navigation.

```csharp
// src/SeniorIntern.Desktop/Views/DiffViewerPanel.axaml.cs
using Avalonia.Controls;
using Avalonia.Controls.Primitives;
using SeniorIntern.Desktop.ViewModels;
using System;

namespace SeniorIntern.Desktop.Views;

/// <summary>
/// Main diff viewer panel with side-by-side synchronized scrolling.
/// </summary>
public partial class DiffViewerPanel : UserControl
{
    /// <summary>
    /// Guard flag to prevent infinite scroll synchronization loops.
    /// When true, scroll change handlers return early without propagating.
    /// </summary>
    private bool _isSyncingScroll;

    public DiffViewerPanel()
    {
        InitializeComponent();

        // Wire up synchronized scrolling event handlers
        OriginalScrollViewer.ScrollChanged += OnOriginalScrollChanged;
        ProposedScrollViewer.ScrollChanged += OnProposedScrollChanged;
    }

    /// <summary>
    /// Subscribe to ViewModel events when DataContext changes.
    /// </summary>
    protected override void OnDataContextChanged(EventArgs e)
    {
        base.OnDataContextChanged(e);

        if (DataContext is DiffViewerViewModel vm)
        {
            // Subscribe to hunk navigation events from the ViewModel
            vm.HunkNavigationRequested += OnHunkNavigationRequested;
        }
    }

    /// <summary>
    /// Handles scroll changes on the Original panel.
    /// Synchronizes the Proposed panel if sync is enabled.
    /// </summary>
    private void OnOriginalScrollChanged(object? sender, ScrollChangedEventArgs e)
    {
        // If we're already syncing, don't process to avoid infinite loop
        if (_isSyncingScroll) return;

        // Check if synchronized scrolling is enabled in the ViewModel
        if (DataContext is DiffViewerViewModel { SynchronizedScroll: true })
        {
            _isSyncingScroll = true;
            try
            {
                // Copy scroll offset from Original to Proposed
                ProposedScrollViewer.Offset = OriginalScrollViewer.Offset;
            }
            finally
            {
                _isSyncingScroll = false;
            }
        }
    }

    /// <summary>
    /// Handles scroll changes on the Proposed panel.
    /// Synchronizes the Original panel if sync is enabled.
    /// </summary>
    private void OnProposedScrollChanged(object? sender, ScrollChangedEventArgs e)
    {
        // If we're already syncing, don't process to avoid infinite loop
        if (_isSyncingScroll) return;

        // Check if synchronized scrolling is enabled in the ViewModel
        if (DataContext is DiffViewerViewModel { SynchronizedScroll: true })
        {
            _isSyncingScroll = true;
            try
            {
                // Copy scroll offset from Proposed to Original
                OriginalScrollViewer.Offset = ProposedScrollViewer.Offset;
            }
            finally
            {
                _isSyncingScroll = false;
            }
        }
    }

    /// <summary>
    /// Handles hunk navigation events from the ViewModel.
    /// Scrolls to bring the specified hunk into view.
    /// </summary>
    private void OnHunkNavigationRequested(object? sender, int hunkIndex)
    {
        ScrollToHunk(hunkIndex);
    }

    /// <summary>
    /// Scrolls to bring the specified hunk into view.
    /// Uses ItemContainerGenerator to find the hunk control.
    /// </summary>
    private void ScrollToHunk(int hunkIndex)
    {
        // Get the ItemsControl containing the hunks
        if (OriginalScrollViewer.Content is ItemsControl itemsControl)
        {
            // Find the container for the specified hunk index
            var container = itemsControl.ContainerFromIndex(hunkIndex);

            if (container is Control hunkControl)
            {
                // Scroll the control into view
                hunkControl.BringIntoView();
            }
        }
    }
}
```

### Synchronized Scrolling Implementation

The synchronized scrolling mechanism uses a guard pattern to prevent infinite loops:

**Problem**: When Panel A scrolls, it updates Panel B. Panel B's scroll change then tries to update Panel A, creating an infinite loop.

**Solution**: Use `_isSyncingScroll` as a guard flag:

```csharp
// Step 1: User scrolls Original panel
// Step 2: OnOriginalScrollChanged fires
// Step 3: Check guard - false, so continue
// Step 4: Set guard = true
// Step 5: Update Proposed.Offset (triggers OnProposedScrollChanged)
// Step 6: OnProposedScrollChanged checks guard - true, so return early
// Step 7: Set guard = false
// Step 8: Done - no infinite loop
```

The pattern uses try/finally to ensure the guard is always cleared, even if an exception occurs during offset assignment.

### Hunk Navigation Implementation

Hunk navigation involves coordination between the ViewModel and View:

1. **ViewModel raises event**: When `NextHunkCommand` or `PreviousHunkCommand` executes, the ViewModel updates `CurrentHunkIndex` and raises `HunkNavigationRequested(newIndex)`

2. **View handles event**: `OnHunkNavigationRequested` receives the hunk index and calls `ScrollToHunk()`

3. **ScrollToHunk finds control**: Uses `ItemsControl.ContainerFromIndex()` to get the visual container for the hunk at the specified index

4. **BringIntoView scrolls**: Calls `BringIntoView()` on the hunk control, which scrolls the parent ScrollViewer to make it visible

5. **Sync propagates**: The scroll change is synchronized to the other panel automatically

### Required Value Converters

The panel requires these value converters for data binding:

| Converter | Purpose | Implementation |
|-----------|---------|----------------|
| IncrementConverter | Convert 0-based index to 1-based display | `return (int)value + 1;` |
| StringConverters.IsNotNullOrEmpty | Visibility for non-empty strings | Built-in Avalonia converter |

**IncrementConverter Implementation:**

```csharp
// src/SeniorIntern.Desktop/Converters/IncrementConverter.cs
using Avalonia.Data.Converters;
using System;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts a 0-based index to 1-based display number.
/// </summary>
public class IncrementConverter : IValueConverter
{
    public static readonly IncrementConverter Instance = new();

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is int intValue)
        {
            return intValue + 1;
        }
        return value;
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is int intValue)
        {
            return intValue - 1;
        }
        return value;
    }
}
```

### Required Static Resources

The panel references these static resources that must be defined in the application:

| Resource | Type | Usage |
|----------|------|-------|
| FileCodeIcon | StreamGeometry | File icon in header |
| ChevronUpIcon | StreamGeometry | Previous hunk button |
| ChevronDownIcon | StreamGeometry | Next hunk button |
| HighlightIcon | StreamGeometry | Inline changes toggle |
| WrapTextIcon | StreamGeometry | Word wrap toggle |
| LinkIcon | StreamGeometry | Sync scroll toggle |
| ErrorIcon | StreamGeometry | Error overlay icon |
| DiffAddedForeground | SolidColorBrush | Green text for additions |
| DiffRemovedForeground | SolidColorBrush | Red text for removals |
| TextMuted | SolidColorBrush | Subdued text color |
| DiffSplitterBackground | SolidColorBrush | Splitter line color |
| ErrorBackground | SolidColorBrush | Error overlay background |
| ErrorForeground | SolidColorBrush | Error icon/text color |

### Required Styles

The panel uses these CSS-like style classes:

| Class | Applied To | Purpose |
|-------|------------|---------|
| diff-header | Border | Header background and padding |
| diff-footer | Border | Footer background and padding |
| diff-panel | Border | Panel container styling |
| original | Border | Original panel specific styling |
| proposed | Border | Proposed panel specific styling |
| panel-header | Border | Panel header bar styling |
| icon-button | Button/ToggleButton | Compact toolbar button |
| language-badge | Border | Language indicator styling |
| new-file-badge | Border | NEW FILE indicator styling |
| secondary | Button | Secondary button style |
| primary | Button | Primary button style |
| accent | Button | Accent color modifier |

---

## Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/Views/DiffViewerPanel.axaml` | Main diff viewer XAML layout |
| `src/SeniorIntern.Desktop/Views/DiffViewerPanel.axaml.cs` | Code-behind with sync scrolling |
| `src/SeniorIntern.Desktop/Converters/IncrementConverter.cs` | Index to 1-based converter |

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/App.axaml` | Register IncrementConverter as static resource |
| `src/SeniorIntern.Desktop/Themes/Dark.axaml` | Add diff panel color resources |
| `src/SeniorIntern.Desktop/Themes/Light.axaml` | Add diff panel color resources |
| `src/SeniorIntern.Desktop/Resources/Icons.axaml` | Add required icon geometries |
| `src/SeniorIntern.Desktop/Styles/Controls.axaml` | Add diff panel style classes |

---

## Dependencies

### Internal Dependencies (v0.4.2 Series)

| Dependency | Provides |
|------------|----------|
| v0.4.2d DiffViewerViewModel | DataContext with Hunks, navigation commands, view options |
| v0.4.2d DiffHunkViewModel | Hunk data for ItemsControl binding |
| v0.4.2f DiffHunkControl | Hunk rendering control (referenced in ItemTemplate) |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Avalonia | 11.x | UI framework, UserControl, ScrollViewer |
| Avalonia.Controls | 11.x | GridSplitter, ItemsControl, ToggleButton |

---

## Testing Strategy

### Unit Tests

| Test Class | Coverage |
|------------|----------|
| IncrementConverterTests | Convert and ConvertBack methods |

### Integration Tests

| Test | Verification |
|------|--------------|
| SynchronizedScrolling | Verify both panels scroll together |
| ScrollGuardPreventsLoop | Verify _isSyncingScroll prevents recursion |
| HunkNavigation | Verify BringIntoView is called |

### Manual Testing Checklist

- [ ] Scroll Original panel, verify Proposed follows
- [ ] Scroll Proposed panel, verify Original follows
- [ ] Toggle sync off, verify independent scrolling
- [ ] Toggle sync on, verify panels re-sync
- [ ] Click Next/Previous buttons, verify scroll to hunk
- [ ] Verify splitter allows resizing
- [ ] Verify loading overlay appears during async load
- [ ] Verify error overlay shows on failure
- [ ] Verify all toolbar toggles work
- [ ] Verify Apply/Reject buttons invoke commands

---

## Acceptance Criteria

- [ ] Side-by-side panels display correctly
- [ ] Synchronized scrolling works bidirectionally
- [ ] Sync scroll toggle enables/disables feature
- [ ] Navigation buttons work correctly
- [ ] Position display shows N/M format (1-based)
- [ ] Stats display correctly (added, removed, hunks)
- [ ] Toolbar toggles function properly
- [ ] Loading overlay shows during computation
- [ ] Error overlay shows on failure with message
- [ ] Splitter allows resizing panels
- [ ] Footer buttons invoke correct commands
- [ ] Header shows file info, language, new file badge
- [ ] No infinite scroll loops occur
- [ ] Hunk navigation scrolls to correct position

---

## Related Documents

- [v0.4.2 Diff Engine](v0.4.2-diff-engine.md) - Parent design document
- [v0.4.2d Diff ViewModels](v0.4.2d-diff-viewmodels.md) - ViewModel layer this view binds to
- [v0.4.2f Diff Line Rendering](v0.4.2f-diff-line-rendering.md) - DiffHunkControl and DiffLineControl used in ItemTemplates
