# Design Specification: The Senior Intern v0.4.1d "Block Classification"

**Status**: _IMPLEMENTED_

## Executive Summary

This document provides a detailed implementation specification for v0.4.1d, which implements the service to classify code blocks as CompleteFile, Snippet, Example, Command, Output, or Config based on context analysis and content structure. Classification determines what actions are available for each code block in the UI.

### v0.4.1d Scope

- Create `IBlockClassificationService` interface with ClassifyBlock method
- Implement `BlockClassificationService` with multi-factor classification
- Support context phrase analysis (example vs apply indicators)
- Support language-based classification (shell → Command, config → Config)
- Support content structure analysis for complete file detection
- Provide classification confidence scores
- Handle edge cases gracefully

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| IBlockClassificationService | Interface for block classification |
| BlockClassificationService | Multi-factor classification implementation |
| ExampleIndicators | Phrases suggesting illustrative code |
| ApplyIndicators | Phrases suggesting actionable code |
| OutputIndicators | Phrases suggesting output/logs |
| HasCompleteFileStructure | Language-specific structure detection |
| Confidence scoring | Classification confidence calculation |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.4.1d Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  IBlockClassificationService                                      │
│  ├── ClassifyBlock(content, language, surroundingText)           │
│  │   └── Returns: CodeBlockType                                  │
│  │                                                                │
│  └── GetClassificationConfidence(block)                          │
│      └── Returns: float (0.0 - 1.0)                              │
│                                                                   │
│  BlockClassificationService                                       │
│  ├── Dependencies                                                │
│  │   └── ILanguageDetectionService                               │
│  │                                                                │
│  ├── Static Indicator Arrays                                     │
│  │   ├── ExampleIndicators (16 phrases)                          │
│  │   │   └── "for example", "such as", "like this"...           │
│  │   │                                                           │
│  │   ├── ApplyIndicators (17 phrases)                            │
│  │   │   └── "update", "modify", "here's the"...                │
│  │   │                                                           │
│  │   └── OutputIndicators (9 phrases)                            │
│  │       └── "output:", "result:", "will print"...              │
│  │                                                                │
│  ├── ClassifyBlock()                                             │
│  │   ├── Step 1: Check shell language → Command                 │
│  │   ├── Step 2: Check config language → Config                 │
│  │   ├── Step 3: Check output indicators → Output               │
│  │   ├── Step 4: Score example vs apply indicators              │
│  │   │   └── exampleScore > applyScore → Example                │
│  │   ├── Step 5: Check complete file structure → CompleteFile   │
│  │   └── Step 6: Default → Snippet                              │
│  │                                                                │
│  ├── GetClassificationConfidence()                               │
│  │   ├── Command → 0.95                                         │
│  │   ├── Config → 0.90                                          │
│  │   ├── Output → 0.85                                          │
│  │   ├── CompleteFile → 0.80                                    │
│  │   ├── Example → 0.75                                         │
│  │   └── Snippet → 0.70                                         │
│  │                                                                │
│  └── Private Methods                                             │
│      ├── CalculateIndicatorScore(text, indicators)              │
│      │   └── Count matching indicator phrases                   │
│      │                                                           │
│      └── HasCompleteFileStructure(content, language)            │
│          └── Language-specific structure detection              │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Classification Decision Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Classification Decision Flow                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ClassifyBlock(content, language, surroundingText)               │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Step 1: Shell Language Check                               │  │
│  │                                                             │  │
│  │ if (_languageService.IsShellLanguage(language))            │  │
│  │     return Command;                                        │  │
│  │                                                             │  │
│  │ Examples: bash, powershell, cmd, fish, sh, zsh             │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (not shell)                                           │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Step 2: Config Language Check                              │  │
│  │                                                             │  │
│  │ if (_languageService.IsConfigLanguage(language))           │  │
│  │     return Config;                                         │  │
│  │                                                             │  │
│  │ Examples: json, yaml, xml, toml, ini, terraform            │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (not config)                                          │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Step 3: Output Indicator Check                             │  │
│  │                                                             │  │
│  │ if (OutputIndicators.Any(ind => context.Contains(ind)))    │  │
│  │     return Output;                                         │  │
│  │                                                             │  │
│  │ Indicators: "output:", "result:", "will print"...          │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (no output indicators)                                │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Step 4: Example vs Apply Scoring                           │  │
│  │                                                             │  │
│  │ exampleScore = count of ExampleIndicators in context       │  │
│  │ applyScore = count of ApplyIndicators in context           │  │
│  │                                                             │  │
│  │ if (exampleScore > applyScore && exampleScore > 0)         │  │
│  │     return Example;                                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (apply wins or neutral)                               │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Step 5: Complete File Structure Check                      │  │
│  │                                                             │  │
│  │ if (applyScore > 0 || HasCompleteFileStructure(content))   │  │
│  │     return CompleteFile;                                   │  │
│  │                                                             │  │
│  │ Language-specific patterns for C#, JS, Python, etc.        │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (no complete structure)                               │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Step 6: Default to Snippet                                 │  │
│  │                                                             │  │
│  │ return Snippet;                                            │  │
│  │                                                             │  │
│  │ For partial code without clear classification              │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Indicator Phrase Categories

```
┌─────────────────────────────────────────────────────────────────┐
│                    Indicator Phrase Categories                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ExampleIndicators (16 phrases)                              │ │
│  │ → Suggest illustrative/educational code, NOT to be applied │ │
│  │                                                              │ │
│  │ Weak signals:                                               │ │
│  │   "for example", "e.g.", "such as", "like this"            │ │
│  │                                                              │ │
│  │ Medium signals:                                             │ │
│  │   "example:", "an example", "would look like"              │ │
│  │   "something like", "here's an example"                    │ │
│  │                                                              │ │
│  │ Strong signals:                                             │ │
│  │   "consider the following", "suppose we have"              │ │
│  │   "imagine", "let's say", "hypothetically"                 │ │
│  │   "for instance"                                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ApplyIndicators (17 phrases)                                │ │
│  │ → Suggest actionable code that should be applied           │ │
│  │                                                              │ │
│  │ Action words:                                               │ │
│  │   "update", "modify", "change", "replace", "create"        │ │
│  │                                                              │ │
│  │ Directive phrases:                                          │ │
│  │   "add this", "here's the", "here is the"                  │ │
│  │   "updated version", "fixed version", "corrected"          │ │
│  │                                                              │ │
│  │ Solution phrases:                                           │ │
│  │   "the fix", "the solution", "should be"                   │ │
│  │   "needs to be", "change it to", "replace with"            │ │
│  │   "use this instead"                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ OutputIndicators (9 phrases)                                │ │
│  │ → Suggest output/logs that are readonly                    │ │
│  │                                                              │ │
│  │ "output:", "result:", "returns:", "produces:"              │ │
│  │ "will print", "will output", "you'll see"                  │ │
│  │ "the output is", "this prints"                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Complete File Structure Detection

```
┌─────────────────────────────────────────────────────────────────┐
│                    Complete File Structure Detection             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  HasCompleteFileStructure(content, language)                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ C# / csharp                                                 │ │
│  │                                                              │ │
│  │ (namespace OR using) AND (class OR interface OR record)     │ │
│  │                                                              │ │
│  │ Examples:                                                   │ │
│  │   ✓ using System; namespace Foo { public class Bar { } }   │ │
│  │   ✓ namespace Foo; public record User(string Name);        │ │
│  │   ✗ public void DoSomething() { }  (method only)           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ JavaScript / TypeScript                                     │ │
│  │                                                              │ │
│  │ import OR export OR module.exports                          │ │
│  │                                                              │ │
│  │ Examples:                                                   │ │
│  │   ✓ import React from 'react'; export default function...  │ │
│  │   ✓ export class UserService { }                           │ │
│  │   ✗ const x = 5;  (small snippet)                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Python                                                      │ │
│  │                                                              │ │
│  │ (def OR class) AND (import OR shebang)                      │ │
│  │                                                              │ │
│  │ Examples:                                                   │ │
│  │   ✓ import os; class FileHandler: def read(self): ...      │ │
│  │   ✓ #!/usr/bin/env python; def main(): ...                 │ │
│  │   ✗ x = 5  (expression only)                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Other Languages                                             │ │
│  │                                                              │ │
│  │ Java: public class OR package                               │ │
│  │ Go: package AND func                                        │ │
│  │ Rust: (fn OR struct) AND (use OR mod)                       │ │
│  │ XML: <?xml OR <Project OR <configuration                    │ │
│  │ JSON: starts with { AND ends with }                         │ │
│  │ YAML: contains ": " AND doesn't start with -                │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Interfaces/
    └── IBlockClassificationService.cs                (NEW)

src/SeniorIntern.Services/
└── BlockClassificationService.cs                     (NEW)
```

---

## Implementation Details

### Task 1: Create IBlockClassificationService Interface

**File:** `src/SeniorIntern.Core/Interfaces/IBlockClassificationService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models;

/// <summary>
/// Service for classifying the type/purpose of a code block.
/// </summary>
public interface IBlockClassificationService
{
    /// <summary>
    /// Classify a code block based on its content and surrounding context.
    /// </summary>
    /// <param name="content">The code content.</param>
    /// <param name="language">Detected language (may be null).</param>
    /// <param name="surroundingText">Text before and after the code block.</param>
    /// <returns>The classified block type.</returns>
    CodeBlockType ClassifyBlock(string content, string? language, string surroundingText);

    /// <summary>
    /// Get the confidence score for a classification.
    /// Higher scores indicate more certainty in the classification.
    /// </summary>
    /// <param name="block">The classified code block.</param>
    /// <returns>Confidence score from 0.0 (uncertain) to 1.0 (certain).</returns>
    float GetClassificationConfidence(CodeBlock block);
}
```

### Task 2: Implement BlockClassificationService

**File:** `src/SeniorIntern.Services/BlockClassificationService.cs`

```csharp
namespace SeniorIntern.Services;

using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;

public sealed class BlockClassificationService : IBlockClassificationService
{
    private readonly ILanguageDetectionService _languageService;

    // Phrases that strongly suggest example/illustration code
    private static readonly string[] ExampleIndicators = new[]
    {
        "for example",
        "e.g.",
        "such as",
        "like this",
        "example:",
        "an example",
        "would look like",
        "something like",
        "here's an example",
        "consider the following",
        "suppose we have",
        "imagine",
        "let's say",
        "hypothetically",
        "for instance",
        "could be something like"
    };

    // Phrases that strongly suggest actionable/applicable code
    private static readonly string[] ApplyIndicators = new[]
    {
        "update",
        "modify",
        "change",
        "replace",
        "add this",
        "create",
        "here's the",
        "here is the",
        "updated version",
        "fixed version",
        "corrected",
        "the fix",
        "the solution",
        "should be",
        "needs to be",
        "change it to",
        "replace with",
        "use this instead"
    };

    // Phrases suggesting output/logs
    private static readonly string[] OutputIndicators = new[]
    {
        "output:",
        "result:",
        "returns:",
        "produces:",
        "will print",
        "will output",
        "you'll see",
        "the output is",
        "this prints"
    };

    public BlockClassificationService(ILanguageDetectionService languageService)
    {
        _languageService = languageService;
    }

    public CodeBlockType ClassifyBlock(
        string content,
        string? language,
        string surroundingText)
    {
        var lowerContext = surroundingText.ToLowerInvariant();
        var lowerContent = content.ToLowerInvariant();

        // 1. Check for shell/command language (highest priority)
        if (_languageService.IsShellLanguage(language))
        {
            return CodeBlockType.Command;
        }

        // 2. Check for config language
        if (_languageService.IsConfigLanguage(language))
        {
            return CodeBlockType.Config;
        }

        // 3. Check for output indicators
        if (OutputIndicators.Any(ind => lowerContext.Contains(ind)))
        {
            return CodeBlockType.Output;
        }

        // 4. Check for example indicators (score-based)
        var exampleScore = CalculateIndicatorScore(lowerContext, ExampleIndicators);
        var applyScore = CalculateIndicatorScore(lowerContext, ApplyIndicators);

        if (exampleScore > applyScore && exampleScore > 0)
        {
            return CodeBlockType.Example;
        }

        // 5. Analyze content structure
        if (applyScore > 0 || HasCompleteFileStructure(content, language))
        {
            return CodeBlockType.CompleteFile;
        }

        // 6. Default to Snippet for partial code
        return CodeBlockType.Snippet;
    }

    public float GetClassificationConfidence(CodeBlock block)
    {
        // Higher confidence for explicit classifications
        return block.BlockType switch
        {
            CodeBlockType.Command => 0.95f,      // Shell language is explicit
            CodeBlockType.Config => 0.90f,       // Config language is explicit
            CodeBlockType.Output => 0.85f,       // Output indicators are clear
            CodeBlockType.CompleteFile => 0.80f, // Structure-based
            CodeBlockType.Example => 0.75f,      // Context-based
            CodeBlockType.Snippet => 0.70f,      // Default classification
            _ => 0.50f
        };
    }

    private static int CalculateIndicatorScore(string text, string[] indicators)
    {
        return indicators.Count(ind => text.Contains(ind));
    }

    private bool HasCompleteFileStructure(string content, string? language)
    {
        if (string.IsNullOrEmpty(language))
            return false;

        var trimmed = content.Trim();
        var normalized = language.ToLowerInvariant();

        return normalized switch
        {
            "csharp" or "cs" =>
                (trimmed.Contains("namespace ") || trimmed.Contains("using "))
                && (trimmed.Contains("class ") || trimmed.Contains("interface ")
                    || trimmed.Contains("record ") || trimmed.Contains("struct ")),

            "javascript" or "js" or "typescript" or "ts" =>
                trimmed.Contains("import ") || trimmed.Contains("export ")
                || trimmed.Contains("module.exports"),

            "python" or "py" =>
                (trimmed.Contains("def ") || trimmed.Contains("class "))
                && (trimmed.Contains("import ") || trimmed.StartsWith("#!")),

            "java" =>
                trimmed.Contains("public class ") || trimmed.Contains("package "),

            "go" or "golang" =>
                trimmed.Contains("package ") && trimmed.Contains("func "),

            "rust" or "rs" =>
                (trimmed.Contains("fn ") || trimmed.Contains("struct "))
                && (trimmed.Contains("use ") || trimmed.Contains("mod ")),

            "xml" =>
                trimmed.StartsWith("<?xml") || trimmed.StartsWith("<Project")
                || trimmed.StartsWith("<configuration"),

            "json" =>
                trimmed.StartsWith('{') && trimmed.EndsWith('}'),

            "yaml" or "yml" =>
                trimmed.Contains(": ") && !trimmed.StartsWith('-'),

            _ => false
        };
    }
}
```

---

## Classification Priority Order

| Priority | Check | Result | Confidence |
|----------|-------|--------|------------|
| 1 | Shell language | Command | 0.95 |
| 2 | Config language | Config | 0.90 |
| 3 | Output indicators | Output | 0.85 |
| 4 | Example > Apply score | Example | 0.75 |
| 5 | Apply score > 0 OR complete structure | CompleteFile | 0.80 |
| 6 | Default | Snippet | 0.70 |

---

## Indicator Phrases Reference

### Example Indicators (16)

| Phrase | Signal Strength |
|--------|-----------------|
| for example | Weak |
| e.g. | Weak |
| such as | Weak |
| like this | Weak |
| example: | Medium |
| an example | Medium |
| would look like | Medium |
| something like | Medium |
| here's an example | Medium |
| consider the following | Strong |
| suppose we have | Strong |
| imagine | Strong |
| let's say | Strong |
| hypothetically | Strong |
| for instance | Strong |
| could be something like | Medium |

### Apply Indicators (17)

| Phrase | Type |
|--------|------|
| update | Action |
| modify | Action |
| change | Action |
| replace | Action |
| create | Action |
| add this | Directive |
| here's the | Directive |
| here is the | Directive |
| updated version | Directive |
| fixed version | Directive |
| corrected | Directive |
| the fix | Solution |
| the solution | Solution |
| should be | Solution |
| needs to be | Solution |
| change it to | Solution |
| replace with | Solution |
| use this instead | Solution |

### Output Indicators (9)

| Phrase |
|--------|
| output: |
| result: |
| returns: |
| produces: |
| will print |
| will output |
| you'll see |
| the output is |
| this prints |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| ClassifyBlock (shell) | 3 | bash, powershell, cmd |
| ClassifyBlock (config) | 3 | json, yaml, xml |
| ClassifyBlock (output) | 2 | Output indicators |
| ClassifyBlock (example) | 3 | Various example phrases |
| ClassifyBlock (apply) | 3 | Various apply phrases |
| ClassifyBlock (complete) | 5 | C#, JS, Python, Go, Rust structures |
| ClassifyBlock (snippet) | 2 | Default cases |
| GetClassificationConfidence | 6 | All block types |
| CalculateIndicatorScore | 2 | Score calculation |
| HasCompleteFileStructure | 5 | Various languages |
| **Total** | **34** | |

---

## Files Summary

### Files to Create (2)

| File | Lines |
|------|-------|
| `Core/Interfaces/IBlockClassificationService.cs` | 25 |
| `Services/BlockClassificationService.cs` | 160 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Register service |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Shell languages (bash, powershell, cmd) classified as Command |
| AC-2 | Config languages (json, yaml, xml) classified as Config |
| AC-3 | Output indicator phrases trigger Output classification |
| AC-4 | Example indicator phrases trigger Example when score > apply score |
| AC-5 | Apply indicator phrases with structure trigger CompleteFile |
| AC-6 | Language-specific complete file structures detected |
| AC-7 | Default classification is Snippet |
| AC-8 | Classification confidence scores match expected values |
| AC-9 | Case-insensitive matching for indicator phrases |
| AC-10 | Unit tests pass for all classification scenarios |

---

## Dependencies

| Dependency | Description |
|------------|-------------|
| v0.4.1a | CodeBlock, CodeBlockType models |
| v0.4.1c | ILanguageDetectionService for IsShellLanguage, IsConfigLanguage |

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Empty content | Classify based on language/context only |
| No language | Skip language-based checks |
| Empty surrounding text | Skip indicator scoring |
| Mixed signals (example + apply) | Higher score wins |
| Tie in scores | Apply takes precedence |
| Unknown language | Skip HasCompleteFileStructure |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.4.1d | 0.5 day |
