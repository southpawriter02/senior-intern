# v0.4.3h: Undo Toast - Design Specification

**Status**: _IMPLEMENTED_

## Executive Summary

This specification details the implementation of the **Undo Toast** notification system for The Senior Intern's Apply Changes Workflow. The Undo Toast provides a temporary, non-modal notification that appears after successfully applying changes, displaying the action taken and offering a one-click undo option with a visible countdown timer showing remaining undo availability.

### Key Deliverables
- `UndoToastViewModel` with live countdown updates and undo functionality
- `UndoToast.axaml` UserControl with notification UI and animations
- `UndoToast.axaml.cs` code-behind for animation control
- Integration with `UndoManager` for undo operations
- Toast overlay positioning in `MainWindow`
- Auto-hide behavior with configurable timeout
- Smooth entrance/exit animations

---

## Feature Overview

```
v0.4.3h: Undo Toast
├── ViewModel (UndoToastViewModel)
│   ├── Observable Properties
│   │   ├── IsVisible (controls toast visibility)
│   │   ├── Message (action description)
│   │   ├── FilePath (full path to changed file)
│   │   ├── FileName (extracted filename)
│   │   ├── TimeRemaining (countdown TimeSpan)
│   │   ├── FormattedTimeRemaining (mm:ss string)
│   │   ├── IsUndoing (undo operation in progress)
│   │   └── ChangeType (Created, Modified, etc.)
│   ├── Commands
│   │   ├── UndoCommand (trigger undo operation)
│   │   └── DismissCommand (hide toast immediately)
│   └── Event Handlers
│       ├── OnUndoAvailable (from UndoManager)
│       └── OnUndoExpired (from UndoManager)
├── View (UndoToast.axaml)
│   ├── Toast Container (Border with shadow)
│   ├── Success Icon
│   ├── Message Text
│   ├── Time Remaining Display
│   ├── Undo Button (link style)
│   └── Dismiss Button (X icon)
├── Animations
│   ├── Entrance (slide up + fade in)
│   ├── Exit (slide down + fade out)
│   └── Pulse (when time is expiring soon)
├── Positioning
│   └── Bottom-center of MainWindow
├── Auto-Hide Behavior
│   ├── Default: 10 seconds
│   ├── Cancellable by user interaction
│   └── Resets on new undo available
└── Theme Integration
    ├── Dark theme colors
    ├── Light theme colors
    └── Toast-specific resources
```

---

## Architecture Diagrams

### Toast Lifecycle

```
┌─────────────────────────────────────────────────────────────────┐
│                      Undo Toast Lifecycle                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   FileChangeService                                             │
│   ApplyCodeBlockAsync()                                         │
│          │                                                       │
│          ▼                                                       │
│   ┌──────────────────┐                                          │
│   │   UndoManager    │                                          │
│   │ RegisterChange() │                                          │
│   └────────┬─────────┘                                          │
│            │                                                     │
│            │ UndoAvailable event                                │
│            ▼                                                     │
│   ┌──────────────────┐                                          │
│   │ UndoToastViewModel│                                          │
│   │ OnUndoAvailable() │                                          │
│   └────────┬─────────┘                                          │
│            │                                                     │
│            ▼                                                     │
│   ┌──────────────────┐     ┌─────────────────────────────┐     │
│   │    Show Toast    │────▶│   Start Auto-Hide Timer     │     │
│   │  IsVisible=true  │     │   Start Countdown Updates   │     │
│   └────────┬─────────┘     └─────────────────────────────┘     │
│            │                                                     │
│     ┌──────┴──────┬─────────────────┬────────────────┐         │
│     │             │                 │                │         │
│     ▼             ▼                 ▼                ▼         │
│ ┌────────┐  ┌──────────┐    ┌───────────────┐  ┌─────────┐   │
│ │  User  │  │  User    │    │  Auto-Hide    │  │  Undo   │   │
│ │ clicks │  │ clicks   │    │  Timer Fires  │  │ Expired │   │
│ │  Undo  │  │ Dismiss  │    │  (10 sec)     │  │  Event  │   │
│ └───┬────┘  └────┬─────┘    └───────┬───────┘  └────┬────┘   │
│     │            │                  │               │         │
│     ▼            │                  │               │         │
│ ┌────────────┐   │                  │               │         │
│ │ Execute    │   │                  │               │         │
│ │ Undo via   │   │                  │               │         │
│ │ UndoManager│   │                  │               │         │
│ └──────┬─────┘   │                  │               │         │
│        │         │                  │               │         │
│        ▼         ▼                  ▼               ▼         │
│   ┌──────────────────────────────────────────────────────┐    │
│   │                    Hide Toast                         │    │
│   │              IsVisible = false                        │    │
│   │        Cancel timers, reset state                     │    │
│   └──────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Toast UI Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│                        MainWindow                                │
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                          │   │
│   │                    Main Content                          │   │
│   │                                                          │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                          │   │
│   │   ┌─────────────────────────────────────────────────┐   │   │
│   │   │ ✓  Modified Program.cs   Undo: 2:45   [Undo] [×]│   │   │
│   │   └─────────────────────────────────────────────────┘   │   │
│   │              ▲                                           │   │
│   │              │                                           │   │
│   │         UndoToast                                       │   │
│   │    (bottom-center overlay)                              │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Toast Component Structure

```
┌─────────────────────────────────────────────────────────────────┐
│  UndoToast Component Layout                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Border (undo-toast class)                                  │  │
│  │ - Background: ToastBackground                             │  │
│  │ - Border: ToastBorder, 1px                                │  │
│  │ - CornerRadius: 8                                         │  │
│  │ - BoxShadow: 0 4 16 0 rgba(0,0,0,0.25)                   │  │
│  │ - Padding: 16,12                                          │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Grid (5 columns)                                     │  │  │
│  │  │                                                      │  │  │
│  │  │ Col 0: Icon     Col 1: Message   Col 2: Time        │  │  │
│  │  │ ┌─────────┐    ┌─────────────┐  ┌──────────────┐   │  │  │
│  │  │ │   ✓     │    │ Modified    │  │ Undo: 2:45   │   │  │  │
│  │  │ │  20x20  │    │ Program.cs  │  │              │   │  │  │
│  │  │ │ Success │    │             │  │              │   │  │  │
│  │  │ └─────────┘    └─────────────┘  └──────────────┘   │  │  │
│  │  │                                                      │  │  │
│  │  │ Col 3: Undo     Col 4: Dismiss                      │  │  │
│  │  │ ┌───────────┐  ┌──────────┐                        │  │  │
│  │  │ │   Undo    │  │    ×     │                        │  │  │
│  │  │ │  (link)   │  │  12x12   │                        │  │  │
│  │  │ └───────────┘  └──────────┘                        │  │  │
│  │  │                                                      │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Timer Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      Timer Architecture                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  UndoToastViewModel                        │  │
│  │                                                            │  │
│  │  ┌─────────────────────┐    ┌─────────────────────────┐   │  │
│  │  │   _autoHideCts      │    │  _countdownCts          │   │  │
│  │  │ CancellationToken   │    │ CancellationToken       │   │  │
│  │  │   Source            │    │   Source                │   │  │
│  │  └──────────┬──────────┘    └──────────┬──────────────┘   │  │
│  │             │                          │                   │  │
│  │             ▼                          ▼                   │  │
│  │  ┌─────────────────────┐    ┌─────────────────────────┐   │  │
│  │  │  StartAutoHide()    │    │ StartCountdownUpdates() │   │  │
│  │  │                     │    │                         │   │  │
│  │  │  await Task.Delay   │    │  while (IsVisible)      │   │  │
│  │  │  (10000, ct)        │    │    TimeRemaining =      │   │  │
│  │  │                     │    │      GetFromUndoMgr()   │   │  │
│  │  │  Then: Hide()       │    │    await Delay(1000)    │   │  │
│  │  └─────────────────────┘    └─────────────────────────┘   │  │
│  │                                                            │  │
│  │  Cancel both when:                                        │  │
│  │  - Hide() called                                          │  │
│  │  - New undo available (reset)                             │  │
│  │  - Undo executed                                          │  │
│  │  - Dismiss clicked                                        │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### 1. UndoToastViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/UndoToastViewModel.cs
using System.IO;
using Avalonia.Threading;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Services;
using SeniorIntern.Services.Enums;
using SeniorIntern.Services.Events;

namespace SeniorIntern.Desktop.ViewModels;

/// <summary>
/// ViewModel for the Undo Toast notification.
/// Displays after applying changes with an option to undo.
/// </summary>
public partial class UndoToastViewModel : ViewModelBase, IDisposable
{
    private readonly IUndoManager _undoManager;
    private CancellationTokenSource? _autoHideCts;
    private CancellationTokenSource? _countdownCts;
    private string? _currentChangeId;
    private bool _disposed;

    /// <summary>
    /// Auto-hide delay in milliseconds. Default: 10 seconds.
    /// </summary>
    public const int AutoHideDelayMs = 10000;

    /// <summary>
    /// Countdown update interval in milliseconds.
    /// </summary>
    private const int CountdownUpdateIntervalMs = 1000;

    /// <summary>
    /// Threshold for "expiring soon" warning state.
    /// </summary>
    private static readonly TimeSpan ExpiringSoonThreshold = TimeSpan.FromSeconds(30);

    #region Observable Properties

    /// <summary>
    /// Gets whether the toast is currently visible.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(ShouldAnimate))]
    private bool _isVisible;

    /// <summary>
    /// Gets the message describing the action taken.
    /// </summary>
    [ObservableProperty]
    private string _message = string.Empty;

    /// <summary>
    /// Gets the full path to the changed file.
    /// </summary>
    [ObservableProperty]
    private string _filePath = string.Empty;

    /// <summary>
    /// Gets the file name (without directory).
    /// </summary>
    [ObservableProperty]
    private string _fileName = string.Empty;

    /// <summary>
    /// Gets the time remaining until undo expires.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(FormattedTimeRemaining))]
    [NotifyPropertyChangedFor(nameof(IsExpiringSoon))]
    [NotifyPropertyChangedFor(nameof(ProgressPercentage))]
    private TimeSpan _timeRemaining;

    /// <summary>
    /// Gets whether an undo operation is in progress.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(CanUndo))]
    private bool _isUndoing;

    /// <summary>
    /// Gets the type of change that was made.
    /// </summary>
    [ObservableProperty]
    private FileChangeType _changeType;

    /// <summary>
    /// Gets the total undo window duration for progress calculation.
    /// </summary>
    [ObservableProperty]
    private TimeSpan _totalUndoWindow;

    #endregion

    #region Computed Properties

    /// <summary>
    /// Gets the formatted time remaining string (mm:ss).
    /// </summary>
    public string FormattedTimeRemaining
    {
        get
        {
            if (TimeRemaining <= TimeSpan.Zero)
                return "0:00";

            if (TimeRemaining.TotalHours >= 1)
                return TimeRemaining.ToString(@"h\:mm\:ss");

            return TimeRemaining.ToString(@"m\:ss");
        }
    }

    /// <summary>
    /// Gets whether the undo is expiring soon (under 30 seconds).
    /// </summary>
    public bool IsExpiringSoon => TimeRemaining > TimeSpan.Zero &&
                                   TimeRemaining <= ExpiringSoonThreshold;

    /// <summary>
    /// Gets the progress percentage (100% = full time, 0% = expired).
    /// </summary>
    public double ProgressPercentage
    {
        get
        {
            if (TotalUndoWindow <= TimeSpan.Zero)
                return 0;

            var percentage = TimeRemaining.TotalMilliseconds / TotalUndoWindow.TotalMilliseconds * 100;
            return Math.Clamp(percentage, 0, 100);
        }
    }

    /// <summary>
    /// Gets whether the undo button should be enabled.
    /// </summary>
    public bool CanUndo => !IsUndoing && TimeRemaining > TimeSpan.Zero;

    /// <summary>
    /// Gets whether animations should be applied.
    /// </summary>
    public bool ShouldAnimate => true;

    /// <summary>
    /// Gets the icon based on change type.
    /// </summary>
    public string IconKey => ChangeType switch
    {
        FileChangeType.Created => "FilePlusIcon",
        FileChangeType.Modified => "CheckCircleIcon",
        FileChangeType.Deleted => "FileMinusIcon",
        _ => "CheckCircleIcon"
    };

    /// <summary>
    /// Gets the icon foreground brush key based on change type.
    /// </summary>
    public string IconBrushKey => ChangeType switch
    {
        FileChangeType.Created => "SuccessForeground",
        FileChangeType.Modified => "SuccessForeground",
        FileChangeType.Deleted => "WarningForeground",
        _ => "SuccessForeground"
    };

    #endregion

    /// <summary>
    /// Initializes a new instance of the UndoToastViewModel.
    /// </summary>
    /// <param name="undoManager">The undo manager service.</param>
    public UndoToastViewModel(IUndoManager undoManager)
    {
        _undoManager = undoManager ?? throw new ArgumentNullException(nameof(undoManager));

        // Subscribe to undo manager events
        _undoManager.UndoAvailable += OnUndoAvailable;
        _undoManager.UndoExpired += OnUndoExpired;
        _undoManager.UndoCompleted += OnUndoCompleted;
    }

    #region Event Handlers

    /// <summary>
    /// Handles the UndoAvailable event from UndoManager.
    /// </summary>
    private void OnUndoAvailable(object? sender, UndoAvailableEventArgs e)
    {
        Dispatcher.UIThread.Post(() =>
        {
            _currentChangeId = e.ChangeId;
            FilePath = e.FilePath;
            FileName = Path.GetFileName(e.FilePath);
            ChangeType = e.ChangeType;
            TotalUndoWindow = e.UndoWindow;
            TimeRemaining = e.ExpiresAt - DateTime.UtcNow;

            Message = FormatMessage(e.ChangeType, FileName);

            Show();
        });
    }

    /// <summary>
    /// Handles the UndoExpired event from UndoManager.
    /// </summary>
    private void OnUndoExpired(object? sender, UndoExpiredEventArgs e)
    {
        Dispatcher.UIThread.Post(() =>
        {
            if (e.ChangeId == _currentChangeId)
            {
                Hide();
            }
        });
    }

    /// <summary>
    /// Handles the UndoCompleted event from UndoManager.
    /// </summary>
    private void OnUndoCompleted(object? sender, UndoCompletedEventArgs e)
    {
        Dispatcher.UIThread.Post(() =>
        {
            if (e.ChangeId == _currentChangeId && e.Success)
            {
                // Show success message briefly before hiding
                Message = $"Restored {FileName}";
                _ = DelayedHideAsync(2000);
            }
        });
    }

    #endregion

    #region Public Methods

    /// <summary>
    /// Shows the toast notification.
    /// </summary>
    public void Show()
    {
        // Cancel any existing timers
        CancelTimers();

        // Create new cancellation token sources
        _autoHideCts = new CancellationTokenSource();
        _countdownCts = new CancellationTokenSource();

        IsVisible = true;

        // Start background tasks
        StartAutoHide(_autoHideCts.Token);
        StartCountdownUpdates(_countdownCts.Token);
    }

    /// <summary>
    /// Hides the toast notification.
    /// </summary>
    public void Hide()
    {
        CancelTimers();
        IsVisible = false;
        _currentChangeId = null;
    }

    #endregion

    #region Commands

    /// <summary>
    /// Executes the undo operation.
    /// </summary>
    [RelayCommand(CanExecute = nameof(CanUndo))]
    private async Task UndoAsync()
    {
        if (IsUndoing || string.IsNullOrEmpty(_currentChangeId))
            return;

        try
        {
            IsUndoing = true;
            UndoCommand.NotifyCanExecuteChanged();

            var result = await _undoManager.UndoAsync(_currentChangeId);

            if (result.Success)
            {
                // Success message shown via UndoCompleted event
            }
            else
            {
                // Show error briefly
                Message = result.ErrorMessage ?? "Undo failed";
                await DelayedHideAsync(3000);
            }
        }
        finally
        {
            IsUndoing = false;
            UndoCommand.NotifyCanExecuteChanged();
        }
    }

    /// <summary>
    /// Dismisses the toast immediately.
    /// </summary>
    [RelayCommand]
    private void Dismiss()
    {
        Hide();
    }

    #endregion

    #region Private Methods

    /// <summary>
    /// Starts the auto-hide timer.
    /// </summary>
    private async void StartAutoHide(CancellationToken ct)
    {
        try
        {
            await Task.Delay(AutoHideDelayMs, ct);
            Hide();
        }
        catch (OperationCanceledException)
        {
            // Expected when cancelled
        }
    }

    /// <summary>
    /// Starts the countdown update loop.
    /// </summary>
    private async void StartCountdownUpdates(CancellationToken ct)
    {
        try
        {
            while (!ct.IsCancellationRequested && IsVisible)
            {
                if (!string.IsNullOrEmpty(_currentChangeId))
                {
                    var remaining = _undoManager.GetTimeRemaining(_currentChangeId);
                    TimeRemaining = remaining ?? TimeSpan.Zero;

                    if (TimeRemaining <= TimeSpan.Zero)
                    {
                        Hide();
                        break;
                    }
                }

                await Task.Delay(CountdownUpdateIntervalMs, ct);
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when cancelled
        }
    }

    /// <summary>
    /// Hides the toast after a delay.
    /// </summary>
    private async Task DelayedHideAsync(int delayMs)
    {
        try
        {
            await Task.Delay(delayMs);
            Hide();
        }
        catch (OperationCanceledException)
        {
            // Ignore
        }
    }

    /// <summary>
    /// Formats the message based on change type.
    /// </summary>
    private static string FormatMessage(FileChangeType changeType, string fileName)
    {
        return changeType switch
        {
            FileChangeType.Created => $"Created {fileName}",
            FileChangeType.Modified => $"Modified {fileName}",
            FileChangeType.Deleted => $"Deleted {fileName}",
            _ => $"Changed {fileName}"
        };
    }

    /// <summary>
    /// Cancels all running timers.
    /// </summary>
    private void CancelTimers()
    {
        _autoHideCts?.Cancel();
        _autoHideCts?.Dispose();
        _autoHideCts = null;

        _countdownCts?.Cancel();
        _countdownCts?.Dispose();
        _countdownCts = null;
    }

    #endregion

    #region IDisposable

    /// <summary>
    /// Disposes the ViewModel and unsubscribes from events.
    /// </summary>
    public void Dispose()
    {
        if (_disposed) return;

        CancelTimers();

        _undoManager.UndoAvailable -= OnUndoAvailable;
        _undoManager.UndoExpired -= OnUndoExpired;
        _undoManager.UndoCompleted -= OnUndoCompleted;

        _disposed = true;
    }

    #endregion
}

/// <summary>
/// Specifies the type of file change.
/// </summary>
public enum FileChangeType
{
    /// <summary>
    /// A new file was created.
    /// </summary>
    Created,

    /// <summary>
    /// An existing file was modified.
    /// </summary>
    Modified,

    /// <summary>
    /// A file was deleted.
    /// </summary>
    Deleted
}
```

### 2. UndoToast.axaml (View)

```xml
<!-- src/SeniorIntern.Desktop/Controls/UndoToast.axaml -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             mc:Ignorable="d"
             x:Class="SeniorIntern.Desktop.Controls.UndoToast"
             x:DataType="vm:UndoToastViewModel"
             IsVisible="{Binding IsVisible}"
             HorizontalAlignment="Center"
             VerticalAlignment="Bottom"
             Margin="0,0,0,24">

    <UserControl.Styles>
        <!-- Entrance/Exit Animations -->
        <Style Selector="UserControl[IsVisible=True]">
            <Style.Animations>
                <Animation Duration="0:0:0.25" FillMode="Forward" Easing="CubicEaseOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="RenderTransform">
                            <TranslateTransform Y="20" />
                        </Setter>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1" />
                        <Setter Property="RenderTransform">
                            <TranslateTransform Y="0" />
                        </Setter>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- Pulse animation when expiring soon -->
        <Style Selector="Border.expiring-soon">
            <Style.Animations>
                <Animation Duration="0:0:1" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.7" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- Link button style -->
        <Style Selector="Button.link-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="4,2" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <Style Selector="Button.link-button:pointerover">
            <Setter Property="Background" Value="Transparent" />
        </Style>

        <Style Selector="Button.link-button:pointerover TextBlock">
            <Setter Property="TextDecorations" Value="Underline" />
        </Style>

        <!-- Icon button style -->
        <Style Selector="Button.icon-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="6" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>

        <Style Selector="Button.icon-button:pointerover">
            <Setter Property="Opacity" Value="1" />
            <Setter Property="Background" Value="{DynamicResource ToastButtonHoverBrush}" />
        </Style>
    </UserControl.Styles>

    <Border Classes="undo-toast"
            Classes.expiring-soon="{Binding IsExpiringSoon}"
            Background="{DynamicResource ToastBackgroundBrush}"
            BorderBrush="{DynamicResource ToastBorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="16,12"
            BoxShadow="0 4 16 0 #40000000"
            MinWidth="320"
            MaxWidth="500">

        <Grid ColumnDefinitions="Auto, *, Auto, Auto, Auto">

            <!-- Success/Status Icon -->
            <Border Grid.Column="0"
                    Background="{DynamicResource SuccessBackgroundSubtle}"
                    CornerRadius="12"
                    Width="24"
                    Height="24"
                    Margin="0,0,12,0"
                    VerticalAlignment="Center">
                <PathIcon Data="{DynamicResource CheckCircleIcon}"
                          Width="14"
                          Height="14"
                          Foreground="{DynamicResource SuccessForeground}" />
            </Border>

            <!-- Message -->
            <TextBlock Grid.Column="1"
                       Text="{Binding Message}"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource ToastForegroundBrush}"
                       FontSize="13"
                       TextTrimming="CharacterEllipsis"
                       ToolTip.Tip="{Binding FilePath}" />

            <!-- Time Remaining -->
            <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Margin="16,0,0,0">
                <TextBlock Text="Undo: "
                           Foreground="{DynamicResource TextMuted}"
                           FontSize="12"
                           VerticalAlignment="Center" />
                <TextBlock Text="{Binding FormattedTimeRemaining}"
                           Foreground="{DynamicResource ToastForegroundBrush}"
                           FontSize="12"
                           FontWeight="SemiBold"
                           FontFamily="Cascadia Code, Consolas, monospace"
                           VerticalAlignment="Center"
                           Classes.warning="{Binding IsExpiringSoon}">
                    <TextBlock.Styles>
                        <Style Selector="TextBlock.warning">
                            <Setter Property="Foreground" Value="{DynamicResource WarningForeground}" />
                        </Style>
                    </TextBlock.Styles>
                </TextBlock>
            </StackPanel>

            <!-- Undo Button -->
            <Button Grid.Column="3"
                    Command="{Binding UndoCommand}"
                    IsEnabled="{Binding CanUndo}"
                    Classes="link-button"
                    Margin="12,0,0,0"
                    ToolTip.Tip="Undo this change">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <!-- Loading spinner when undoing -->
                    <Border IsVisible="{Binding IsUndoing}"
                            Width="12"
                            Height="12">
                        <PathIcon Data="{StaticResource SpinnerIcon}"
                                  Width="12"
                                  Height="12"
                                  Classes="spinning"
                                  Foreground="{DynamicResource AccentBrush}" />
                    </Border>
                    <TextBlock Text="{Binding IsUndoing, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Undoing...|Undo'}"
                               Foreground="{DynamicResource AccentBrush}"
                               FontSize="13"
                               FontWeight="SemiBold" />
                </StackPanel>
            </Button>

            <!-- Dismiss Button -->
            <Button Grid.Column="4"
                    Command="{Binding DismissCommand}"
                    Classes="icon-button"
                    Margin="8,0,0,0"
                    ToolTip.Tip="Dismiss"
                    VerticalAlignment="Center">
                <PathIcon Data="{StaticResource CloseIcon}"
                          Width="10"
                          Height="10"
                          Foreground="{DynamicResource ToastForegroundBrush}" />
            </Button>
        </Grid>
    </Border>
</UserControl>
```

### 3. UndoToast.axaml.cs (Code-Behind)

```csharp
// src/SeniorIntern.Desktop/Controls/UndoToast.axaml.cs
using Avalonia.Controls;

namespace SeniorIntern.Desktop.Controls;

/// <summary>
/// Undo Toast notification control.
/// Displays after applying changes with an undo option.
/// </summary>
public partial class UndoToast : UserControl
{
    /// <summary>
    /// Initializes a new instance of the UndoToast control.
    /// </summary>
    public UndoToast()
    {
        InitializeComponent();
    }
}
```

### 4. MainWindow Integration

```xml
<!-- Additions to MainWindow.axaml -->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:controls="using:SeniorIntern.Desktop.Controls"
        x:Class="SeniorIntern.Desktop.Views.MainWindow">

    <!-- Main content grid with overlay -->
    <Grid>
        <!-- Existing main content -->
        <Grid x:Name="MainContent">
            <!-- ... existing layout ... -->
        </Grid>

        <!-- Toast overlay layer -->
        <Panel x:Name="ToastOverlay"
               IsHitTestVisible="False">
            <controls:UndoToast DataContext="{Binding UndoToastViewModel}"
                                IsHitTestVisible="True"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Bottom" />
        </Panel>
    </Grid>
</Window>
```

### 5. MainWindowViewModel Integration

```csharp
// Additions to MainWindowViewModel.cs
public partial class MainWindowViewModel : ViewModelBase
{
    /// <summary>
    /// Gets the undo toast ViewModel.
    /// </summary>
    [ObservableProperty]
    private UndoToastViewModel _undoToastViewModel;

    public MainWindowViewModel(
        /* existing params */,
        IUndoManager undoManager)
    {
        // existing init...

        UndoToastViewModel = new UndoToastViewModel(undoManager);
    }
}
```

### 6. Toast Theme Resources

```xml
<!-- src/SeniorIntern.Desktop/Themes/ToastResources.axaml -->
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Dark Theme Toast Colors -->
    <ResourceDictionary.ThemeDictionaries>
        <ResourceDictionary x:Key="Dark">
            <Color x:Key="ToastBackground">#2D2D2D</Color>
            <Color x:Key="ToastBorder">#404040</Color>
            <Color x:Key="ToastForeground">#E0E0E0</Color>
            <Color x:Key="ToastButtonHover">#3D3D3D</Color>

            <SolidColorBrush x:Key="ToastBackgroundBrush" Color="{StaticResource ToastBackground}" />
            <SolidColorBrush x:Key="ToastBorderBrush" Color="{StaticResource ToastBorder}" />
            <SolidColorBrush x:Key="ToastForegroundBrush" Color="{StaticResource ToastForeground}" />
            <SolidColorBrush x:Key="ToastButtonHoverBrush" Color="{StaticResource ToastButtonHover}" />
        </ResourceDictionary>

        <ResourceDictionary x:Key="Light">
            <Color x:Key="ToastBackground">#FFFFFF</Color>
            <Color x:Key="ToastBorder">#E0E0E0</Color>
            <Color x:Key="ToastForeground">#1A1A1A</Color>
            <Color x:Key="ToastButtonHover">#F5F5F5</Color>

            <SolidColorBrush x:Key="ToastBackgroundBrush" Color="{StaticResource ToastBackground}" />
            <SolidColorBrush x:Key="ToastBorderBrush" Color="{StaticResource ToastBorder}" />
            <SolidColorBrush x:Key="ToastForegroundBrush" Color="{StaticResource ToastForeground}" />
            <SolidColorBrush x:Key="ToastButtonHoverBrush" Color="{StaticResource ToastButtonHover}" />
        </ResourceDictionary>
    </ResourceDictionary.ThemeDictionaries>

</ResourceDictionary>
```

### 7. Toast Styles

```xml
<!-- src/SeniorIntern.Desktop/Styles/ToastStyles.axaml -->
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Undo Toast Base Style -->
    <Style Selector="Border.undo-toast">
        <Setter Property="Transitions">
            <Transitions>
                <DoubleTransition Property="Opacity" Duration="0:0:0.2" Easing="CubicEaseOut" />
                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut" />
            </Transitions>
        </Setter>
    </Style>

    <!-- Spinning animation for loading indicator -->
    <Style Selector="PathIcon.spinning">
        <Style.Animations>
            <Animation Duration="0:0:1" IterationCount="Infinite">
                <KeyFrame Cue="0%">
                    <Setter Property="RenderTransform">
                        <RotateTransform Angle="0" />
                    </Setter>
                </KeyFrame>
                <KeyFrame Cue="100%">
                    <Setter Property="RenderTransform">
                        <RotateTransform Angle="360" />
                    </Setter>
                </KeyFrame>
            </Animation>
        </Style.Animations>
        <Setter Property="RenderTransformOrigin" Value="0.5, 0.5" />
    </Style>

</Styles>
```

### 8. Required Icon Resources

```xml
<!-- Additions to Icons.axaml -->
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Check Circle Icon (Success) -->
    <StreamGeometry x:Key="CheckCircleIcon">
        M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z
    </StreamGeometry>

    <!-- Close Icon -->
    <StreamGeometry x:Key="CloseIcon">
        M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z
    </StreamGeometry>

    <!-- Spinner Icon -->
    <StreamGeometry x:Key="SpinnerIcon">
        M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z
    </StreamGeometry>

</ResourceDictionary>
```

### 9. UndoManager Event Args (Referenced)

```csharp
// These should already exist in v0.4.3d, but shown here for reference
// src/SeniorIntern.Services/Events/UndoEvents.cs

namespace SeniorIntern.Services.Events;

/// <summary>
/// Event args for when an undo becomes available.
/// </summary>
public sealed class UndoAvailableEventArgs : EventArgs
{
    /// <summary>
    /// Gets the unique change identifier.
    /// </summary>
    public required string ChangeId { get; init; }

    /// <summary>
    /// Gets the path to the changed file.
    /// </summary>
    public required string FilePath { get; init; }

    /// <summary>
    /// Gets the type of change.
    /// </summary>
    public required FileChangeType ChangeType { get; init; }

    /// <summary>
    /// Gets when the undo expires.
    /// </summary>
    public required DateTime ExpiresAt { get; init; }

    /// <summary>
    /// Gets the total undo window duration.
    /// </summary>
    public required TimeSpan UndoWindow { get; init; }
}

/// <summary>
/// Event args for when an undo expires.
/// </summary>
public sealed class UndoExpiredEventArgs : EventArgs
{
    /// <summary>
    /// Gets the unique change identifier.
    /// </summary>
    public required string ChangeId { get; init; }

    /// <summary>
    /// Gets the path to the changed file.
    /// </summary>
    public required string FilePath { get; init; }
}

/// <summary>
/// Event args for when an undo is completed.
/// </summary>
public sealed class UndoCompletedEventArgs : EventArgs
{
    /// <summary>
    /// Gets the unique change identifier.
    /// </summary>
    public required string ChangeId { get; init; }

    /// <summary>
    /// Gets the path to the changed file.
    /// </summary>
    public required string FilePath { get; init; }

    /// <summary>
    /// Gets whether the undo was successful.
    /// </summary>
    public required bool Success { get; init; }

    /// <summary>
    /// Gets the error message if unsuccessful.
    /// </summary>
    public string? ErrorMessage { get; init; }
}
```

---

## Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/UndoToastViewModel.cs` | Toast ViewModel with countdown logic |
| `src/SeniorIntern.Desktop/Controls/UndoToast.axaml` | Toast UI definition |
| `src/SeniorIntern.Desktop/Controls/UndoToast.axaml.cs` | Toast code-behind |
| `src/SeniorIntern.Desktop/Themes/ToastResources.axaml` | Toast theme resources |
| `src/SeniorIntern.Desktop/Styles/ToastStyles.axaml` | Toast-specific styles |

## Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add toast overlay layer |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add UndoToastViewModel property |
| `src/SeniorIntern.Desktop/Resources/Icons.axaml` | Add CheckCircleIcon, CloseIcon, SpinnerIcon |
| `src/SeniorIntern.Desktop/App.axaml` | Include ToastResources and ToastStyles |

---

## Testing Strategy

### Unit Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/ViewModels/UndoToastViewModelTests.cs
namespace SeniorIntern.Desktop.Tests.ViewModels;

public class UndoToastViewModelTests
{
    private readonly Mock<IUndoManager> _mockUndoManager;
    private readonly UndoToastViewModel _viewModel;

    public UndoToastViewModelTests()
    {
        _mockUndoManager = new Mock<IUndoManager>();
        _viewModel = new UndoToastViewModel(_mockUndoManager.Object);
    }

    #region Initialization Tests

    [Fact]
    public void Constructor_SubscribesToUndoManagerEvents()
    {
        // Arrange & Act
        var vm = new UndoToastViewModel(_mockUndoManager.Object);

        // Assert - events are subscribed (verified by no exception)
        Assert.NotNull(vm);
    }

    [Fact]
    public void Constructor_InitializesWithHiddenState()
    {
        // Assert
        Assert.False(_viewModel.IsVisible);
    }

    [Fact]
    public void Constructor_NullUndoManager_ThrowsArgumentNullException()
    {
        // Act & Assert
        Assert.Throws<ArgumentNullException>(() => new UndoToastViewModel(null!));
    }

    #endregion

    #region Show/Hide Tests

    [Fact]
    public void Show_SetsIsVisibleTrue()
    {
        // Act
        _viewModel.Show();

        // Assert
        Assert.True(_viewModel.IsVisible);
    }

    [Fact]
    public void Hide_SetsIsVisibleFalse()
    {
        // Arrange
        _viewModel.Show();

        // Act
        _viewModel.Hide();

        // Assert
        Assert.False(_viewModel.IsVisible);
    }

    [Fact]
    public void Show_AfterHide_ShowsAgain()
    {
        // Arrange
        _viewModel.Show();
        _viewModel.Hide();

        // Act
        _viewModel.Show();

        // Assert
        Assert.True(_viewModel.IsVisible);
    }

    #endregion

    #region UndoAvailable Event Tests

    [Fact]
    public void OnUndoAvailable_SetsMessageFromChangeType()
    {
        // Arrange
        var args = CreateUndoAvailableArgs(FileChangeType.Modified, "test.cs");

        // Act
        RaiseUndoAvailable(args);

        // Assert - use dispatcher sync for Avalonia
        Assert.Contains("Modified", _viewModel.Message);
        Assert.Contains("test.cs", _viewModel.Message);
    }

    [Fact]
    public void OnUndoAvailable_SetsFilePath()
    {
        // Arrange
        var args = CreateUndoAvailableArgs(filePath: "/path/to/file.cs");

        // Act
        RaiseUndoAvailable(args);

        // Assert
        Assert.Equal("/path/to/file.cs", _viewModel.FilePath);
    }

    [Fact]
    public void OnUndoAvailable_SetsFileName()
    {
        // Arrange
        var args = CreateUndoAvailableArgs(filePath: "/path/to/MyFile.cs");

        // Act
        RaiseUndoAvailable(args);

        // Assert
        Assert.Equal("MyFile.cs", _viewModel.FileName);
    }

    [Fact]
    public void OnUndoAvailable_ShowsToast()
    {
        // Arrange
        var args = CreateUndoAvailableArgs();

        // Act
        RaiseUndoAvailable(args);

        // Assert
        Assert.True(_viewModel.IsVisible);
    }

    [Fact]
    public void OnUndoAvailable_SetsTimeRemaining()
    {
        // Arrange
        var expiresAt = DateTime.UtcNow.AddMinutes(5);
        var args = CreateUndoAvailableArgs(expiresAt: expiresAt);

        // Act
        RaiseUndoAvailable(args);

        // Assert
        Assert.True(_viewModel.TimeRemaining > TimeSpan.Zero);
    }

    #endregion

    #region UndoExpired Event Tests

    [Fact]
    public void OnUndoExpired_HidesToast_WhenMatchingChangeId()
    {
        // Arrange
        var availableArgs = CreateUndoAvailableArgs(changeId: "change-123");
        RaiseUndoAvailable(availableArgs);
        Assert.True(_viewModel.IsVisible);

        var expiredArgs = new UndoExpiredEventArgs
        {
            ChangeId = "change-123",
            FilePath = "/test/file.cs"
        };

        // Act
        RaiseUndoExpired(expiredArgs);

        // Assert
        Assert.False(_viewModel.IsVisible);
    }

    [Fact]
    public void OnUndoExpired_DoesNotHide_WhenDifferentChangeId()
    {
        // Arrange
        var availableArgs = CreateUndoAvailableArgs(changeId: "change-123");
        RaiseUndoAvailable(availableArgs);

        var expiredArgs = new UndoExpiredEventArgs
        {
            ChangeId = "change-different",
            FilePath = "/test/file.cs"
        };

        // Act
        RaiseUndoExpired(expiredArgs);

        // Assert
        Assert.True(_viewModel.IsVisible);
    }

    #endregion

    #region FormattedTimeRemaining Tests

    [Theory]
    [InlineData(0, "0:00")]
    [InlineData(30, "0:30")]
    [InlineData(90, "1:30")]
    [InlineData(3661, "1:01:01")]
    public void FormattedTimeRemaining_FormatsCorrectly(int seconds, string expected)
    {
        // Arrange
        SetTimeRemaining(TimeSpan.FromSeconds(seconds));

        // Assert
        Assert.Equal(expected, _viewModel.FormattedTimeRemaining);
    }

    #endregion

    #region IsExpiringSoon Tests

    [Theory]
    [InlineData(10, true)]
    [InlineData(29, true)]
    [InlineData(30, true)]
    [InlineData(31, false)]
    [InlineData(60, false)]
    [InlineData(0, false)] // Already expired
    public void IsExpiringSoon_CorrectForTimeRemaining(int seconds, bool expected)
    {
        // Arrange
        SetTimeRemaining(TimeSpan.FromSeconds(seconds));

        // Assert
        Assert.Equal(expected, _viewModel.IsExpiringSoon);
    }

    #endregion

    #region ProgressPercentage Tests

    [Fact]
    public void ProgressPercentage_Returns100_WhenFullTimeRemaining()
    {
        // Arrange
        var totalWindow = TimeSpan.FromMinutes(5);
        SetTimeRemainingWithTotal(totalWindow, totalWindow);

        // Assert
        Assert.Equal(100, _viewModel.ProgressPercentage);
    }

    [Fact]
    public void ProgressPercentage_Returns50_WhenHalfTimeRemaining()
    {
        // Arrange
        var totalWindow = TimeSpan.FromMinutes(4);
        SetTimeRemainingWithTotal(TimeSpan.FromMinutes(2), totalWindow);

        // Assert
        Assert.Equal(50, _viewModel.ProgressPercentage, precision: 1);
    }

    [Fact]
    public void ProgressPercentage_Returns0_WhenExpired()
    {
        // Arrange
        SetTimeRemainingWithTotal(TimeSpan.Zero, TimeSpan.FromMinutes(5));

        // Assert
        Assert.Equal(0, _viewModel.ProgressPercentage);
    }

    #endregion

    #region UndoCommand Tests

    [Fact]
    public async Task UndoCommand_CallsUndoManager()
    {
        // Arrange
        var args = CreateUndoAvailableArgs(changeId: "change-123");
        RaiseUndoAvailable(args);

        _mockUndoManager
            .Setup(um => um.UndoAsync("change-123", It.IsAny<CancellationToken>()))
            .ReturnsAsync(UndoResult.Success());

        // Act
        await _viewModel.UndoCommand.ExecuteAsync(null);

        // Assert
        _mockUndoManager.Verify(
            um => um.UndoAsync("change-123", It.IsAny<CancellationToken>()),
            Times.Once);
    }

    [Fact]
    public async Task UndoCommand_SetsIsUndoing_DuringOperation()
    {
        // Arrange
        var args = CreateUndoAvailableArgs();
        RaiseUndoAvailable(args);

        var tcs = new TaskCompletionSource<UndoResult>();
        _mockUndoManager
            .Setup(um => um.UndoAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .Returns(tcs.Task);

        // Act
        var undoTask = _viewModel.UndoCommand.ExecuteAsync(null);
        Assert.True(_viewModel.IsUndoing);

        tcs.SetResult(UndoResult.Success());
        await undoTask;

        // Assert
        Assert.False(_viewModel.IsUndoing);
    }

    [Fact]
    public async Task UndoCommand_CannotExecute_WhenAlreadyUndoing()
    {
        // Arrange
        var args = CreateUndoAvailableArgs();
        RaiseUndoAvailable(args);

        var tcs = new TaskCompletionSource<UndoResult>();
        _mockUndoManager
            .Setup(um => um.UndoAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .Returns(tcs.Task);

        // Start first undo
        var firstUndo = _viewModel.UndoCommand.ExecuteAsync(null);

        // Assert
        Assert.False(_viewModel.CanUndo);

        tcs.SetResult(UndoResult.Success());
        await firstUndo;
    }

    #endregion

    #region DismissCommand Tests

    [Fact]
    public void DismissCommand_HidesToast()
    {
        // Arrange
        _viewModel.Show();
        Assert.True(_viewModel.IsVisible);

        // Act
        _viewModel.DismissCommand.Execute(null);

        // Assert
        Assert.False(_viewModel.IsVisible);
    }

    #endregion

    #region Dispose Tests

    [Fact]
    public void Dispose_UnsubscribesFromEvents()
    {
        // Arrange
        var vm = new UndoToastViewModel(_mockUndoManager.Object);

        // Act
        vm.Dispose();

        // Assert - raising events after dispose should not affect the disposed VM
        var args = CreateUndoAvailableArgs();
        RaiseUndoAvailable(args);
        // No exception means unsubscribed successfully
    }

    [Fact]
    public void Dispose_CanBeCalledMultipleTimes()
    {
        // Act & Assert - should not throw
        _viewModel.Dispose();
        _viewModel.Dispose();
    }

    #endregion

    #region Helper Methods

    private UndoAvailableEventArgs CreateUndoAvailableArgs(
        FileChangeType changeType = FileChangeType.Modified,
        string filePath = "/test/file.cs",
        string changeId = "change-1",
        DateTime? expiresAt = null)
    {
        return new UndoAvailableEventArgs
        {
            ChangeId = changeId,
            FilePath = filePath,
            ChangeType = changeType,
            ExpiresAt = expiresAt ?? DateTime.UtcNow.AddMinutes(5),
            UndoWindow = TimeSpan.FromMinutes(5)
        };
    }

    private void RaiseUndoAvailable(UndoAvailableEventArgs args)
    {
        _mockUndoManager.Raise(um => um.UndoAvailable += null, args);
    }

    private void RaiseUndoExpired(UndoExpiredEventArgs args)
    {
        _mockUndoManager.Raise(um => um.UndoExpired += null, args);
    }

    private void SetTimeRemaining(TimeSpan remaining)
    {
        // Use reflection or make property internal for testing
        typeof(UndoToastViewModel)
            .GetProperty(nameof(UndoToastViewModel.TimeRemaining))!
            .SetValue(_viewModel, remaining);
    }

    private void SetTimeRemainingWithTotal(TimeSpan remaining, TimeSpan total)
    {
        SetTimeRemaining(remaining);
        typeof(UndoToastViewModel)
            .GetProperty(nameof(UndoToastViewModel.TotalUndoWindow))!
            .SetValue(_viewModel, total);
    }

    #endregion
}
```

### Integration Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/Integration/UndoToastIntegrationTests.cs
namespace SeniorIntern.Desktop.Tests.Integration;

public class UndoToastIntegrationTests
{
    [Fact]
    public async Task FullWorkflow_ApplyShowsToast_UndoRestores()
    {
        // Integration test for:
        // 1. Apply changes
        // 2. Toast appears
        // 3. Click undo
        // 4. File restored
        // 5. Toast hides
    }

    [Fact]
    public async Task AutoHide_ToastDisappearsAfterTimeout()
    {
        // Test that toast auto-hides after 10 seconds
    }

    [Fact]
    public async Task CountdownUpdates_TimeRemainingDecrements()
    {
        // Test that time remaining updates every second
    }
}
```

### Visual/Manual Tests

```markdown
## Manual Test Cases

### TC-001: Toast Appearance After Apply
1. Apply changes to a file
2. Verify toast appears at bottom-center
3. Verify success icon is visible
4. Verify message shows "Modified [filename]"
5. Verify countdown timer is visible
6. Verify Undo and Dismiss buttons are present

### TC-002: Countdown Timer
1. Apply changes
2. Watch countdown timer
3. Verify it decrements every second
4. Verify format is "m:ss" (e.g., "4:59")
5. When < 30 seconds, verify warning color/pulse

### TC-003: Undo Operation
1. Apply changes
2. Click "Undo" button
3. Verify loading state shown
4. Verify file is restored
5. Verify success message briefly shown
6. Verify toast disappears

### TC-004: Dismiss Button
1. Apply changes
2. Click dismiss (×) button
3. Verify toast disappears immediately
4. Verify undo is still available via keyboard shortcut

### TC-005: Auto-Hide
1. Apply changes
2. Do not interact with toast
3. After 10 seconds, verify toast disappears

### TC-006: Animation
1. Apply changes
2. Verify toast slides up and fades in
3. Dismiss toast
4. Verify toast slides down and fades out

### TC-007: Multiple Changes
1. Apply first change
2. Toast appears for first change
3. Apply second change before first toast hides
4. Verify toast updates to show second change
5. Verify countdown resets
```

---

## Acceptance Criteria

### Functional Requirements

- [ ] **Toast appears after applying changes** - Automatically shown when changes applied
- [ ] **Message shows file name and action** - "Modified Program.cs", "Created NewFile.cs"
- [ ] **Time remaining updates live** - Countdown decrements every second
- [ ] **Formatted time display** - Shows as "m:ss" or "h:mm:ss" for longer durations
- [ ] **Undo button triggers undo** - Clicking Undo restores file to previous state
- [ ] **Loading state during undo** - Spinner shown while undo in progress
- [ ] **Dismiss button hides toast** - Immediately hides without undoing
- [ ] **Auto-hide after 10 seconds** - Toast disappears if not interacted with
- [ ] **Expiring soon warning** - Visual indicator when < 30 seconds remain
- [ ] **Success message after undo** - Brief "Restored [filename]" message shown

### Non-Functional Requirements

- [ ] **Smooth animations** - Entrance (slide up + fade in), exit (slide down + fade out)
- [ ] **Non-blocking** - Toast doesn't prevent interaction with main window
- [ ] **Theme-aware** - Colors adapt to dark/light theme
- [ ] **Responsive layout** - Toast adjusts to content width
- [ ] **Memory efficient** - Timers properly cancelled and disposed

### Integration Requirements

- [ ] **UndoManager integration** - Subscribes to UndoAvailable, UndoExpired, UndoCompleted events
- [ ] **MainWindow overlay** - Positioned at bottom-center of main window
- [ ] **Keyboard accessible** - Can dismiss with keyboard (Escape in parent)
- [ ] **Service lifetime** - ViewModel disposed when MainWindow closes

---

## Design Decisions

### 1. UserControl vs Window for Toast

**Decision**: Implement toast as a UserControl overlaid on MainWindow.

**Rationale**:
- Non-modal behavior - doesn't block user interaction
- Simpler positioning within parent window
- Shares window focus and lifetime
- No additional window management overhead

**Alternative Considered**:
- Separate popup window - more complex, focus issues

### 2. Auto-Hide with Cancellation

**Decision**: 10-second auto-hide with cancellation on any interaction.

**Rationale**:
- Long enough to read and decide
- Short enough to not be annoying
- Respects user attention when they interact
- Can be dismissed immediately if unwanted

### 3. Live Countdown Updates

**Decision**: Update time remaining every second with live binding.

**Rationale**:
- Gives user clear sense of urgency
- Visual feedback that undo is time-limited
- Matches user expectation from similar UIs
- 1-second interval is efficient and smooth

### 4. Single Toast Instance

**Decision**: One toast instance, updated for new changes.

**Rationale**:
- Avoids toast stack/queue complexity
- Latest change is most relevant for undo
- Simpler implementation and testing
- Cleaner visual experience

**Trade-off**:
- Can't undo earlier change if new one appears
- Acceptable since undo is still available via other means

### 5. Dispatcher.UIThread.Post for Events

**Decision**: Marshal UndoManager events to UI thread via Dispatcher.

**Rationale**:
- UndoManager events may fire from background threads
- UI updates must happen on UI thread
- Post (async) avoids potential deadlocks
- Standard Avalonia pattern

### 6. Bottom-Center Positioning

**Decision**: Position toast at bottom-center of MainWindow.

**Rationale**:
- Non-intrusive position
- Common location for transient notifications
- Doesn't overlap with important content
- Visible but not demanding attention

---

## Accessibility Considerations

### Keyboard Navigation

| Key | Action |
|-----|--------|
| Tab | Focus moves to Undo button, then Dismiss |
| Enter/Space | Activate focused button |
| Escape | Dismiss toast (if parent supports) |

### Screen Reader Support

- Toast container has appropriate ARIA role
- Message announces file name and action
- Countdown announced periodically (every 30s or on major change)
- Button states (enabled/disabled) announced

### Visual Accessibility

- Sufficient color contrast for all text
- Success icon uses both color and shape
- Warning state (expiring soon) has visual indicator beyond color
- Animations can be disabled via system settings

---

## Performance Considerations

### Timer Efficiency

- Single Task.Delay for auto-hide (not polling)
- 1-second interval for countdown (not sub-second)
- Timers cancelled immediately when hiding
- No timer running when toast hidden

### Memory Management

- CancellationTokenSource disposed after use
- Event handlers unsubscribed on dispose
- No closures capturing large objects
- Single ViewModel instance reused

### UI Thread

- Minimal work on UI thread
- Complex calculations done before dispatch
- No blocking calls in event handlers
- Animations use GPU acceleration

---

## Future Enhancements

1. **Toast queue** - Stack multiple toasts for rapid changes
2. **Keyboard shortcut** - Global Ctrl+Z to undo last change
3. **Progress bar** - Visual progress indicator for undo window
4. **Sound notification** - Optional audio cue when toast appears
5. **Position preference** - User-configurable toast position
6. **Extended toast** - Show diff preview on hover
7. **Undo history** - Toast with dropdown for multiple undos
