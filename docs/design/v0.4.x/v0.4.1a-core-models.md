# Design Specification: The Senior Intern v0.4.1a "Core Models"

**Status**: _IMPLEMENTED_

## Executive Summary

This document provides a detailed implementation specification for v0.4.1a, which defines the foundational data models for representing code blocks extracted from LLM responses. These models form the core data structures used throughout the entire v0.4.1 "Code Block Extraction" feature set.

### v0.4.1a Scope

- Create `CodeBlock` model for representing extracted code blocks
- Create `CodeBlockType` enum for classifying block purposes
- Create `CodeBlockStatus` enum for tracking workflow states
- Create `TextRange` record struct for character positions
- Create `LineRange` record struct for line ranges
- Create `CodeProposal` model for grouping related code blocks
- Create `ProposalStatus` enum for tracking proposal states
- Ensure all models are immutable where appropriate

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| CodeBlock | Core model for extracted code blocks |
| CodeBlockType | Enum: CompleteFile, Snippet, Example, Command, Output, Config |
| CodeBlockStatus | Enum: Pending, Applied, Rejected, Skipped, Conflict, Error |
| TextRange | Character position range (Start, End) |
| LineRange | Line number range (StartLine, EndLine) |
| CodeProposal | Collection of code blocks from one message |
| ProposalStatus | Enum: Pending, PartiallyApplied, FullyApplied, Rejected, Expired |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.4.1a Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  CodeBlock                                                        │
│  ├── Identity                                                    │
│  │   ├── Id: Guid (auto-generated)                              │
│  │   ├── MessageId: Guid (source message)                       │
│  │   └── SequenceNumber: int (position in message)              │
│  │                                                                │
│  ├── Content                                                     │
│  │   ├── Content: string (raw code without fences)              │
│  │   ├── Language: string? (e.g., "csharp", "python")           │
│  │   ├── DisplayLanguage: string? (e.g., "C#", "Python")        │
│  │   └── LineCount: int (computed)                              │
│  │                                                                │
│  ├── Target                                                      │
│  │   ├── TargetFilePath: string? (relative to workspace)        │
│  │   └── ReplacementRange: LineRange? (for partial replacements)│
│  │                                                                │
│  ├── Classification                                              │
│  │   ├── BlockType: CodeBlockType                               │
│  │   └── ConfidenceScore: float (0.0 to 1.0)                    │
│  │                                                                │
│  ├── Source Location                                             │
│  │   └── SourceRange: TextRange (position in message)           │
│  │                                                                │
│  ├── Workflow                                                    │
│  │   └── Status: CodeBlockStatus                                │
│  │                                                                │
│  ├── Computed Properties                                         │
│  │   ├── IsApplicable → bool                                    │
│  │   │   └── (CompleteFile|Snippet) && HasTargetPath            │
│  │   └── LineCount → int                                        │
│  │                                                                │
│  └── Metadata                                                    │
│      └── ExtractedAt: DateTime                                  │
│                                                                   │
│  CodeBlockType (enum)                                             │
│  ├── CompleteFile    → Full file to create/replace              │
│  ├── Snippet         → Partial code to insert/replace           │
│  ├── Example         → Illustration (not meant to be applied)   │
│  ├── Command         → Shell/terminal command                   │
│  ├── Output          → Log/output content (readonly)            │
│  └── Config          → Configuration file (JSON, YAML, etc.)    │
│                                                                   │
│  CodeBlockStatus (enum)                                           │
│  ├── Pending         → Not yet processed                        │
│  ├── Applied         → Successfully applied                     │
│  ├── Rejected        → User rejected                            │
│  ├── Skipped         → User skipped or not applicable           │
│  ├── Conflict        → Conflict with current file               │
│  └── Error           → Error during apply                       │
│                                                                   │
│  TextRange (record struct)                                        │
│  ├── Start: int                                                 │
│  ├── End: int                                                   │
│  ├── Length → End - Start                                       │
│  ├── IsEmpty → Start == End                                     │
│  └── Empty → static factory                                     │
│                                                                   │
│  LineRange (record struct)                                        │
│  ├── StartLine: int (1-indexed)                                 │
│  ├── EndLine: int (1-indexed)                                   │
│  ├── LineCount → EndLine - StartLine + 1                        │
│  ├── IsValid → StartLine > 0 && EndLine >= StartLine            │
│  ├── Empty → static factory                                     │
│  └── SingleLine(line) → static factory                          │
│                                                                   │
│  CodeProposal                                                     │
│  ├── Identity                                                    │
│  │   ├── Id: Guid                                               │
│  │   └── MessageId: Guid                                        │
│  │                                                                │
│  ├── Content                                                     │
│  │   └── CodeBlocks: IReadOnlyList<CodeBlock>                   │
│  │                                                                │
│  ├── Filters                                                     │
│  │   ├── ApplicableBlocks → Where(IsApplicable)                 │
│  │   ├── ExampleBlocks → Where(Type == Example)                 │
│  │   └── CommandBlocks → Where(Type == Command)                 │
│  │                                                                │
│  ├── Status                                                      │
│  │   ├── Status: ProposalStatus                                 │
│  │   └── IsFullyProcessed → All(Status != Pending)              │
│  │                                                                │
│  ├── Statistics                                                  │
│  │   ├── ApplicableCount: int                                   │
│  │   ├── AppliedCount: int                                      │
│  │   ├── TargetFiles: IEnumerable<string>                       │
│  │   └── AffectedFileCount: int                                 │
│  │                                                                │
│  └── Metadata                                                    │
│      └── CreatedAt: DateTime                                    │
│                                                                   │
│  ProposalStatus (enum)                                            │
│  ├── Pending         → No blocks processed yet                  │
│  ├── PartiallyApplied → Some applied, others pending            │
│  ├── FullyApplied    → All applicable blocks applied            │
│  ├── Rejected        → User rejected entire proposal            │
│  └── Expired         → File changed since proposal              │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Model Relationships

```
┌─────────────────────────────────────────────────────────────────┐
│                    Model Relationships                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │                    CodeProposal                           │    │
│  │                                                           │    │
│  │  Id: Guid                                                 │    │
│  │  MessageId: Guid ─────────────────────────────────┐       │    │
│  │  Status: ProposalStatus                           │       │    │
│  │  CreatedAt: DateTime                              │       │    │
│  │                                                   │       │    │
│  │  CodeBlocks: IReadOnlyList<CodeBlock>             │       │    │
│  │       │                                           │       │    │
│  └───────┼───────────────────────────────────────────┼───────┘    │
│          │ 1..*                                      │            │
│          ▼                                           ▼            │
│  ┌───────────────────────────┐          ┌────────────────────┐   │
│  │       CodeBlock           │          │   ChatMessage      │   │
│  │                           │          │                    │   │
│  │  Id: Guid                 │          │  (from v0.2.x)     │   │
│  │  Content: string          │          └────────────────────┘   │
│  │  Language: string?        │                                   │
│  │  DisplayLanguage: string? │                                   │
│  │  TargetFilePath: string?  │                                   │
│  │  BlockType: CodeBlockType │──┐                               │
│  │  Status: CodeBlockStatus  │──┼───────────────┐               │
│  │  ConfidenceScore: float   │  │               │               │
│  │  MessageId: Guid ─────────┼──┘               │               │
│  │  SequenceNumber: int      │                  ▼               │
│  │  SourceRange: TextRange   │──┐     ┌─────────────────┐       │
│  │  ReplacementRange:        │  │     │ CodeBlockType   │       │
│  │    LineRange?             │──┼─┐   │                 │       │
│  │  ExtractedAt: DateTime    │  │ │   │ ○ CompleteFile  │       │
│  └───────────────────────────┘  │ │   │ ○ Snippet       │       │
│                                 │ │   │ ○ Example       │       │
│                                 │ │   │ ○ Command       │       │
│            ┌────────────────────┘ │   │ ○ Output        │       │
│            ▼                      │   │ ○ Config        │       │
│  ┌─────────────────┐              │   └─────────────────┘       │
│  │ TextRange       │              │                              │
│  │                 │              │   ┌─────────────────┐       │
│  │ Start: int      │              │   │ CodeBlockStatus │       │
│  │ End: int        │              │   │                 │       │
│  │ Length (calc)   │              │   │ ○ Pending       │       │
│  │ IsEmpty (calc)  │              │   │ ○ Applied       │       │
│  └─────────────────┘              │   │ ○ Rejected      │       │
│                                   │   │ ○ Skipped       │       │
│            ┌──────────────────────┘   │ ○ Conflict      │       │
│            ▼                          │ ○ Error         │       │
│  ┌─────────────────┐                  └─────────────────┘       │
│  │ LineRange       │                                             │
│  │                 │                  ┌─────────────────┐       │
│  │ StartLine: int  │                  │ ProposalStatus  │       │
│  │ EndLine: int    │                  │                 │       │
│  │ LineCount (calc)│                  │ ○ Pending       │       │
│  │ IsValid (calc)  │                  │ ○ Partial       │       │
│  └─────────────────┘                  │ ○ FullyApplied  │       │
│                                       │ ○ Rejected      │       │
│                                       │ ○ Expired       │       │
│                                       └─────────────────┘       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Block Type Classification

```
┌─────────────────────────────────────────────────────────────────┐
│                    Block Type Classification                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    CodeBlockType                             │ │
│  ├─────────────────────────────────────────────────────────────┤ │
│  │                                                              │ │
│  │  CompleteFile                                                │ │
│  │  ├── Has full file structure (using statements, namespace)  │ │
│  │  ├── Typically has file path specified or inferred          │ │
│  │  └── IsApplicable: TRUE                                     │ │
│  │                                                              │ │
│  │  Snippet                                                     │ │
│  │  ├── Partial code meant to be inserted/replaced             │ │
│  │  ├── May have ReplacementRange for targeted updates         │ │
│  │  └── IsApplicable: TRUE (if TargetFilePath set)             │ │
│  │                                                              │ │
│  │  Example                                                     │ │
│  │  ├── Illustrative code (e.g., "here's how you would...")    │ │
│  │  ├── Not meant to be directly applied                       │ │
│  │  └── IsApplicable: FALSE                                    │ │
│  │                                                              │ │
│  │  Command                                                     │ │
│  │  ├── Shell/terminal commands (bash, powershell, cmd)        │ │
│  │  ├── Actions: Copy to clipboard, Run in terminal            │ │
│  │  └── IsApplicable: FALSE                                    │ │
│  │                                                              │ │
│  │  Output                                                      │ │
│  │  ├── Expected output, logs, error messages                  │ │
│  │  ├── Readonly display only                                  │ │
│  │  └── IsApplicable: FALSE                                    │ │
│  │                                                              │ │
│  │  Config                                                      │ │
│  │  ├── Configuration files (JSON, YAML, XML, TOML)            │ │
│  │  ├── Similar handling to CompleteFile                       │ │
│  │  └── IsApplicable: TRUE (if TargetFilePath set)             │ │
│  │                                                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Status Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Code Block Status Workflow                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                          ┌───────────┐                           │
│                          │  Pending  │                           │
│                          └─────┬─────┘                           │
│                                │                                 │
│            ┌───────────────────┼───────────────────┐             │
│            │                   │                   │             │
│            ▼                   ▼                   ▼             │
│     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     │
│     │   Applied   │     │   Skipped   │     │  Rejected   │     │
│     │     ✓       │     │     ⊘       │     │     ✕       │     │
│     └─────────────┘     └─────────────┘     └─────────────┘     │
│            │                                                     │
│            │ (file changed since apply)                          │
│            ▼                                                     │
│     ┌─────────────┐                                              │
│     │  Conflict   │                                              │
│     │     ⚠       │                                              │
│     └─────────────┘                                              │
│                                                                  │
│     ┌─────────────┐                                              │
│     │   Error     │  ← (any step can fail)                      │
│     │     ✕       │                                              │
│     └─────────────┘                                              │
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│                    Proposal Status Workflow                      │
│                                                                  │
│                          ┌───────────┐                           │
│                          │  Pending  │                           │
│                          └─────┬─────┘                           │
│                                │ (user applies some blocks)     │
│                                ▼                                 │
│                     ┌──────────────────┐                         │
│                     │ PartiallyApplied │                         │
│                     └────────┬─────────┘                         │
│                              │ (all blocks processed)           │
│         ┌────────────────────┼────────────────────┐              │
│         ▼                    ▼                    ▼              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐        │
│  │ FullyApplied│     │  Rejected   │     │   Expired   │        │
│  └─────────────┘     └─────────────┘     └─────────────┘        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Models/
    ├── CodeBlock.cs                                  (NEW)
    ├── CodeBlockTypes.cs                             (NEW)
    └── CodeProposal.cs                               (NEW)
```

---

## Implementation Details

### Task 1: Create CodeBlock Model

**File:** `src/SeniorIntern.Core/Models/CodeBlock.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Represents a single code block extracted from an LLM response.
/// </summary>
public sealed class CodeBlock
{
    /// <summary>
    /// Unique identifier for this code block.
    /// </summary>
    public Guid Id { get; init; } = Guid.NewGuid();

    /// <summary>
    /// Raw content of the code block (without markdown fences).
    /// </summary>
    public string Content { get; init; } = string.Empty;

    /// <summary>
    /// Detected or specified programming language identifier.
    /// Examples: "csharp", "python", "javascript", "bash"
    /// </summary>
    public string? Language { get; init; }

    /// <summary>
    /// Normalized language name for display.
    /// Examples: "C#", "Python", "JavaScript", "Bash"
    /// </summary>
    public string? DisplayLanguage { get; init; }

    /// <summary>
    /// Inferred or specified target file path (relative to workspace).
    /// May be set by fence hint (```csharp:src/Foo.cs) or inferred from context.
    /// </summary>
    public string? TargetFilePath { get; set; }

    /// <summary>
    /// Classification of this code block's purpose.
    /// </summary>
    public CodeBlockType BlockType { get; init; } = CodeBlockType.Snippet;

    /// <summary>
    /// Line range in original file this block should replace (for snippets).
    /// Null for complete file replacements or unknown targets.
    /// </summary>
    public LineRange? ReplacementRange { get; set; }

    /// <summary>
    /// Source message ID that contains this code block.
    /// </summary>
    public Guid MessageId { get; init; }

    /// <summary>
    /// Position in message (0-based index for multiple code blocks).
    /// </summary>
    public int SequenceNumber { get; init; }

    /// <summary>
    /// Start and end character positions in the original message content.
    /// </summary>
    public TextRange SourceRange { get; init; }

    /// <summary>
    /// Confidence level for inferred properties (0.0 to 1.0).
    /// Lower confidence may indicate uncertain language or path inference.
    /// </summary>
    public float ConfidenceScore { get; set; } = 1.0f;

    /// <summary>
    /// Timestamp when this code block was extracted.
    /// </summary>
    public DateTime ExtractedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Current status of this code block in the apply workflow.
    /// </summary>
    public CodeBlockStatus Status { get; set; } = CodeBlockStatus.Pending;

    /// <summary>
    /// Whether this block can be applied (has target path and is applicable type).
    /// </summary>
    public bool IsApplicable =>
        BlockType is CodeBlockType.CompleteFile or CodeBlockType.Snippet or CodeBlockType.Config
        && !string.IsNullOrEmpty(TargetFilePath);

    /// <summary>
    /// Line count of the code content.
    /// </summary>
    public int LineCount => Content.Split('\n').Length;

    /// <summary>
    /// Creates a copy of this CodeBlock with the specified modifications.
    /// </summary>
    public CodeBlock With(
        string? content = null,
        string? language = null,
        string? targetFilePath = null,
        CodeBlockType? blockType = null,
        CodeBlockStatus? status = null,
        float? confidenceScore = null)
    {
        return new CodeBlock
        {
            Id = Id,
            Content = content ?? Content,
            Language = language ?? Language,
            DisplayLanguage = DisplayLanguage,
            TargetFilePath = targetFilePath ?? TargetFilePath,
            BlockType = blockType ?? BlockType,
            ReplacementRange = ReplacementRange,
            MessageId = MessageId,
            SequenceNumber = SequenceNumber,
            SourceRange = SourceRange,
            ConfidenceScore = confidenceScore ?? ConfidenceScore,
            ExtractedAt = ExtractedAt,
            Status = status ?? Status
        };
    }
}
```

### Task 2: Create Supporting Types

**File:** `src/SeniorIntern.Core/Models/CodeBlockTypes.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Classification of a code block's purpose.
/// </summary>
public enum CodeBlockType
{
    /// <summary>
    /// A complete file to be created or replaced entirely.
    /// </summary>
    CompleteFile,

    /// <summary>
    /// A partial snippet to be inserted or to replace a section of a file.
    /// </summary>
    Snippet,

    /// <summary>
    /// Example/illustration code (not meant to be applied).
    /// </summary>
    Example,

    /// <summary>
    /// Shell/terminal command (not a code file).
    /// </summary>
    Command,

    /// <summary>
    /// Output/log content (readonly, not applicable).
    /// </summary>
    Output,

    /// <summary>
    /// Configuration or data file (JSON, YAML, XML, TOML, etc.).
    /// </summary>
    Config
}

/// <summary>
/// Status of a code block in the apply workflow.
/// </summary>
public enum CodeBlockStatus
{
    /// <summary>
    /// Not yet processed by user.
    /// </summary>
    Pending,

    /// <summary>
    /// Successfully applied to target file.
    /// </summary>
    Applied,

    /// <summary>
    /// User rejected this code block.
    /// </summary>
    Rejected,

    /// <summary>
    /// Skipped (e.g., not applicable or user chose to skip).
    /// </summary>
    Skipped,

    /// <summary>
    /// Conflict detected with current file state.
    /// </summary>
    Conflict,

    /// <summary>
    /// Error occurred during apply.
    /// </summary>
    Error
}

/// <summary>
/// Represents a range of text by character positions.
/// </summary>
public readonly record struct TextRange(int Start, int End)
{
    /// <summary>
    /// Length of this range in characters.
    /// </summary>
    public int Length => End - Start;

    /// <summary>
    /// Whether this is an empty range.
    /// </summary>
    public bool IsEmpty => Start == End;

    /// <summary>
    /// Whether this is a valid range (non-negative, end >= start).
    /// </summary>
    public bool IsValid => Start >= 0 && End >= Start;

    /// <summary>
    /// An empty range at position 0.
    /// </summary>
    public static TextRange Empty => new(0, 0);

    /// <summary>
    /// Creates a range from a start position and length.
    /// </summary>
    public static TextRange FromLength(int start, int length) => new(start, start + length);

    /// <summary>
    /// Whether this range contains the specified position.
    /// </summary>
    public bool Contains(int position) => position >= Start && position < End;

    /// <summary>
    /// Whether this range overlaps with another range.
    /// </summary>
    public bool Overlaps(TextRange other) =>
        Start < other.End && other.Start < End;
}

/// <summary>
/// Represents a range of lines in a file.
/// </summary>
public readonly record struct LineRange(int StartLine, int EndLine)
{
    /// <summary>
    /// Number of lines in this range (inclusive).
    /// </summary>
    public int LineCount => EndLine - StartLine + 1;

    /// <summary>
    /// Whether this is a valid range (start <= end, both positive).
    /// </summary>
    public bool IsValid => StartLine > 0 && EndLine >= StartLine;

    /// <summary>
    /// Whether this is an empty/invalid range.
    /// </summary>
    public bool IsEmpty => StartLine == 0 && EndLine == 0;

    /// <summary>
    /// An empty line range.
    /// </summary>
    public static LineRange Empty => new(0, 0);

    /// <summary>
    /// Creates a range for a single line.
    /// </summary>
    public static LineRange SingleLine(int line) => new(line, line);

    /// <summary>
    /// Whether this range contains the specified line.
    /// </summary>
    public bool Contains(int line) => line >= StartLine && line <= EndLine;

    /// <summary>
    /// Whether this range overlaps with another range.
    /// </summary>
    public bool Overlaps(LineRange other) =>
        StartLine <= other.EndLine && other.StartLine <= EndLine;

    /// <summary>
    /// Returns a string representation of this range.
    /// </summary>
    public override string ToString() =>
        StartLine == EndLine ? $"Line {StartLine}" : $"Lines {StartLine}-{EndLine}";
}
```

### Task 3: Create CodeProposal Model

**File:** `src/SeniorIntern.Core/Models/CodeProposal.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Represents a collection of code blocks from a single LLM response,
/// forming a cohesive proposal for code changes.
/// </summary>
public sealed class CodeProposal
{
    /// <summary>
    /// Unique identifier for this proposal.
    /// </summary>
    public Guid Id { get; init; } = Guid.NewGuid();

    /// <summary>
    /// The message ID that generated this proposal.
    /// </summary>
    public Guid MessageId { get; init; }

    /// <summary>
    /// When this proposal was created.
    /// </summary>
    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// All code blocks in this proposal.
    /// </summary>
    public IReadOnlyList<CodeBlock> CodeBlocks { get; init; } = Array.Empty<CodeBlock>();

    /// <summary>
    /// Overall status of the proposal.
    /// </summary>
    public ProposalStatus Status { get; set; } = ProposalStatus.Pending;

    // === Filtered Views ===

    /// <summary>
    /// Code blocks that can be applied (have target paths and are applicable types).
    /// </summary>
    public IEnumerable<CodeBlock> ApplicableBlocks =>
        CodeBlocks.Where(b => b.IsApplicable);

    /// <summary>
    /// Code blocks classified as examples (not meant to be applied).
    /// </summary>
    public IEnumerable<CodeBlock> ExampleBlocks =>
        CodeBlocks.Where(b => b.BlockType == CodeBlockType.Example);

    /// <summary>
    /// Code blocks classified as commands.
    /// </summary>
    public IEnumerable<CodeBlock> CommandBlocks =>
        CodeBlocks.Where(b => b.BlockType == CodeBlockType.Command);

    /// <summary>
    /// Code blocks classified as output/logs.
    /// </summary>
    public IEnumerable<CodeBlock> OutputBlocks =>
        CodeBlocks.Where(b => b.BlockType == CodeBlockType.Output);

    /// <summary>
    /// Code blocks that have not been processed yet.
    /// </summary>
    public IEnumerable<CodeBlock> PendingBlocks =>
        CodeBlocks.Where(b => b.Status == CodeBlockStatus.Pending && b.IsApplicable);

    // === Statistics ===

    /// <summary>
    /// Number of applicable code blocks.
    /// </summary>
    public int ApplicableCount => ApplicableBlocks.Count();

    /// <summary>
    /// Number of blocks that have been applied.
    /// </summary>
    public int AppliedCount => CodeBlocks.Count(b => b.Status == CodeBlockStatus.Applied);

    /// <summary>
    /// Number of blocks that have been rejected.
    /// </summary>
    public int RejectedCount => CodeBlocks.Count(b => b.Status == CodeBlockStatus.Rejected);

    /// <summary>
    /// Number of blocks still pending.
    /// </summary>
    public int PendingCount => PendingBlocks.Count();

    /// <summary>
    /// Whether all applicable blocks have been processed.
    /// </summary>
    public bool IsFullyProcessed => ApplicableBlocks.All(
        b => b.Status is not CodeBlockStatus.Pending);

    /// <summary>
    /// Unique target files in this proposal.
    /// </summary>
    public IEnumerable<string> TargetFiles =>
        ApplicableBlocks
            .Select(b => b.TargetFilePath!)
            .Distinct();

    /// <summary>
    /// Number of unique files affected.
    /// </summary>
    public int AffectedFileCount => TargetFiles.Count();

    // === Helper Methods ===

    /// <summary>
    /// Gets code blocks targeting a specific file.
    /// </summary>
    public IEnumerable<CodeBlock> GetBlocksForFile(string filePath) =>
        ApplicableBlocks.Where(b => 
            string.Equals(b.TargetFilePath, filePath, StringComparison.OrdinalIgnoreCase));

    /// <summary>
    /// Recalculates the overall status based on individual block statuses.
    /// </summary>
    public void UpdateStatus()
    {
        if (!ApplicableBlocks.Any())
        {
            Status = ProposalStatus.Pending;
            return;
        }

        if (ApplicableBlocks.All(b => b.Status == CodeBlockStatus.Applied))
        {
            Status = ProposalStatus.FullyApplied;
        }
        else if (ApplicableBlocks.All(b => b.Status == CodeBlockStatus.Rejected))
        {
            Status = ProposalStatus.Rejected;
        }
        else if (ApplicableBlocks.Any(b => b.Status != CodeBlockStatus.Pending))
        {
            Status = ProposalStatus.PartiallyApplied;
        }
        else
        {
            Status = ProposalStatus.Pending;
        }
    }
}

/// <summary>
/// Overall status of a code proposal.
/// </summary>
public enum ProposalStatus
{
    /// <summary>
    /// No blocks have been processed yet.
    /// </summary>
    Pending,

    /// <summary>
    /// Some blocks have been applied, others pending.
    /// </summary>
    PartiallyApplied,

    /// <summary>
    /// All applicable blocks have been applied.
    /// </summary>
    FullyApplied,

    /// <summary>
    /// User rejected the entire proposal.
    /// </summary>
    Rejected,

    /// <summary>
    /// Proposal has expired (e.g., file changed since proposal).
    /// </summary>
    Expired
}
```

---

## Property Summary Tables

### CodeBlock Properties

| Property | Type | Description |
|----------|------|-------------|
| Id | Guid | Unique identifier |
| Content | string | Raw code without fences |
| Language | string? | Language identifier (e.g., "csharp") |
| DisplayLanguage | string? | Display name (e.g., "C#") |
| TargetFilePath | string? | Relative file path |
| BlockType | CodeBlockType | Classification |
| ReplacementRange | LineRange? | Lines to replace |
| MessageId | Guid | Source message |
| SequenceNumber | int | Position in message |
| SourceRange | TextRange | Character positions |
| ConfidenceScore | float | Inference confidence |
| ExtractedAt | DateTime | When extracted |
| Status | CodeBlockStatus | Workflow state |
| IsApplicable | bool | Can be applied (computed) |
| LineCount | int | Number of lines (computed) |

### CodeProposal Properties

| Property | Type | Description |
|----------|------|-------------|
| Id | Guid | Unique identifier |
| MessageId | Guid | Source message |
| CreatedAt | DateTime | When created |
| CodeBlocks | IReadOnlyList | All blocks |
| Status | ProposalStatus | Overall status |
| ApplicableBlocks | IEnumerable | Blocks that can apply (computed) |
| ApplicableCount | int | Count of applicable (computed) |
| AppliedCount | int | Count of applied (computed) |
| IsFullyProcessed | bool | All processed (computed) |
| TargetFiles | IEnumerable | Unique file paths (computed) |
| AffectedFileCount | int | Unique file count (computed) |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| CodeBlock.IsApplicable | 4 | All block types, with/without path |
| CodeBlock.LineCount | 2 | Single line, multi-line |
| CodeBlock.With | 2 | Partial updates |
| TextRange | 5 | Length, IsEmpty, Contains, Overlaps, FromLength |
| LineRange | 6 | LineCount, IsValid, Contains, Overlaps, SingleLine, ToString |
| CodeProposal.ApplicableBlocks | 2 | Filters correctly |
| CodeProposal.Statistics | 3 | Counts correct |
| CodeProposal.UpdateStatus | 4 | All status transitions |
| CodeProposal.GetBlocksForFile | 2 | Finds matching, case-insensitive |
| **Total** | **30** | |

---

## Files Summary

### Files to Create (3)

| File | Lines |
|------|-------|
| `Core/Models/CodeBlock.cs` | 130 |
| `Core/Models/CodeBlockTypes.cs` | 150 |
| `Core/Models/CodeProposal.cs` | 170 |

### Files to Modify (0)

(None - these are new files)

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | CodeBlock model has all required properties |
| AC-2 | CodeBlockType enum covers all classification scenarios (6 types) |
| AC-3 | CodeBlockStatus enum covers all workflow states (6 states) |
| AC-4 | LineRange correctly calculates line counts (inclusive) |
| AC-5 | TextRange correctly calculates character ranges |
| AC-6 | CodeProposal correctly filters applicable blocks |
| AC-7 | CodeProposal.UpdateStatus transitions correctly |
| AC-8 | All models are immutable where appropriate (using init) |
| AC-9 | Unit tests pass for all model behaviors |
| AC-10 | All XML documentation complete |

---

## Dependencies

| Dependency | Description |
|------------|-------------|
| None | Core models have no external dependencies |

---

## Future Considerations

| Item | Description |
|------|-------------|
| Persistence | Models may need serialization attributes for storage |
| Equality | May need IEquatable implementations for comparison |
| Events | Status changes may need to raise events for UI updates |
| Versioning | Model structure should be stable for backward compatibility |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.4.1a | 0.5 day |
