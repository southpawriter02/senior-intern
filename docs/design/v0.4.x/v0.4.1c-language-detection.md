# Design Specification: The Senior Intern v0.4.1c "Language Detection"

**Status**: _IMPLEMENTED_

## Executive Summary

This document provides a detailed implementation specification for v0.4.1c, which implements robust language detection from fence specifiers, file extensions, and content analysis. The service provides language normalization, display name mapping, and categorization (shell/config) for downstream processing.

### v0.4.1c Scope

- Create `ILanguageDetectionService` interface with detection and lookup methods
- Implement `LanguageDetectionService` with 30+ language definitions
- Support language alias normalization (e.g., "cs" → "csharp")
- Support file extension to language mapping (e.g., ".cs" → "csharp")
- Implement content-based detection heuristics for common languages
- Provide display name mapping (e.g., "csharp" → "C#")
- Classify languages as shell or config types
- Handle unknown languages gracefully

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ILanguageDetectionService | Interface for language detection |
| LanguageDetectionService | Main implementation |
| LanguageInfo record | Internal language definition |
| Language dictionary | 30+ language definitions |
| Alias map | Language alias normalization |
| Extension map | File extension to language |
| Content detection | Heuristic-based fallback |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.4.1c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ILanguageDetectionService                                        │
│  ├── DetectLanguage(fenceLanguage, content, filePath)            │
│  │   ├── Returns (Language, DisplayLanguage) tuple              │
│  │   ├── Priority 1: Explicit fence language                    │
│  │   ├── Priority 2: File extension                             │
│  │   └── Priority 3: Content-based heuristics                   │
│  │                                                                │
│  ├── NormalizeLanguageId(languageAlias)                          │
│  │   └── Maps aliases to canonical IDs ("cs" → "csharp")        │
│  │                                                                │
│  ├── GetDisplayName(languageId)                                  │
│  │   └── Returns user-friendly name ("csharp" → "C#")           │
│  │                                                                │
│  ├── GetFileExtension(languageId)                                │
│  │   └── Returns primary extension ("csharp" → ".cs")           │
│  │                                                                │
│  ├── GetLanguageForExtension(extension)                          │
│  │   └── Reverse lookup (".cs" → "csharp")                      │
│  │                                                                │
│  ├── IsShellLanguage(languageId)                                 │
│  │   └── Returns true for bash, powershell, cmd                 │
│  │                                                                │
│  └── IsConfigLanguage(languageId)                                │
│      └── Returns true for json, yaml, xml, toml, ini            │
│                                                                   │
│  LanguageDetectionService                                         │
│  ├── Static Data                                                 │
│  │   ├── Languages: Dictionary<string, LanguageInfo>            │
│  │   │   └── 30+ language definitions                           │
│  │   ├── ExtensionMap: Dictionary<string, string>               │
│  │   │   └── Maps extensions to language IDs                    │
│  │   └── AliasMap: Dictionary<string, string>                   │
│  │       └── Maps aliases to canonical IDs                      │
│  │                                                                │
│  ├── Static Constructor                                          │
│  │   └── Builds ExtensionMap and AliasMap from Languages        │
│  │                                                                │
│  └── Private Methods                                             │
│      └── DetectFromContent(content) → string?                   │
│          ├── C# indicators (namespace, using, class)            │
│          ├── TypeScript/JavaScript (import from, export)        │
│          ├── Python (def, class, import)                        │
│          ├── JSON ({ ... })                                     │
│          ├── XML/HTML (<?xml, <!DOCTYPE)                         │
│          └── Shell ($ prefix, # prefix)                         │
│                                                                   │
│  LanguageInfo (record)                                            │
│  ├── Id: string           (canonical identifier)                │
│  ├── DisplayName: string  (user-friendly name)                  │
│  ├── Extension: string    (primary file extension)              │
│  ├── Aliases: string[]    (alternative names)                   │
│  ├── IsShell: bool        (is shell/command language)           │
│  └── IsConfig: bool       (is configuration file)               │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Detection Priority Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Language Detection Priority                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  DetectLanguage(fenceLanguage, content, filePath)                │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Priority 1: Explicit Fence Language                        │  │
│  │                                                             │  │
│  │ if (!string.IsNullOrWhiteSpace(fenceLanguage))             │  │
│  │ {                                                           │  │
│  │     var normalized = NormalizeLanguageId(fenceLanguage);   │  │
│  │     if (normalized != null)                                │  │
│  │         return (normalized, GetDisplayName(normalized));   │  │
│  │ }                                                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (not found)                                           │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Priority 2: File Extension                                 │  │
│  │                                                             │  │
│  │ if (!string.IsNullOrEmpty(filePath))                       │  │
│  │ {                                                           │  │
│  │     var ext = Path.GetExtension(filePath);                 │  │
│  │     var langFromExt = GetLanguageForExtension(ext);        │  │
│  │     if (langFromExt != null)                               │  │
│  │         return (langFromExt, GetDisplayName(langFromExt)); │  │
│  │ }                                                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (not found)                                           │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Priority 3: Content-Based Heuristics                       │  │
│  │                                                             │  │
│  │ var detected = DetectFromContent(content);                 │  │
│  │ if (detected != null)                                      │  │
│  │     return (detected, GetDisplayName(detected));           │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │ (not found)                                           │
│         ▼                                                        │
│  return (null, null);                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Language Definition Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                    Language Definition Structure                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  LanguageInfo Record:                                            │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                                                              │ │
│  │  Id: "csharp"              ← Canonical identifier           │ │
│  │  DisplayName: "C#"         ← User-friendly display          │ │
│  │  Extension: ".cs"          ← Primary file extension         │ │
│  │  Aliases: ["cs", "c#"]     ← Alternative identifiers        │ │
│  │  IsShell: false            ← Shell/command language?        │ │
│  │  IsConfig: false           ← Configuration file?            │ │
│  │                                                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Built Maps (Static Constructor):                                │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ AliasMap (case-insensitive)                                 │ │
│  │                                                              │ │
│  │ "csharp" → "csharp"                                         │ │
│  │ "cs"     → "csharp"                                         │ │
│  │ "c#"     → "csharp"                                         │ │
│  │ "python" → "python"                                         │ │
│  │ "py"     → "python"                                         │ │
│  │ "py3"    → "python"                                         │ │
│  │ ...                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ExtensionMap (case-insensitive)                             │ │
│  │                                                              │ │
│  │ ".cs"     → "csharp"                                        │ │
│  │ ".py"     → "python"                                        │ │
│  │ ".js"     → "javascript"                                    │ │
│  │ ".ts"     → "typescript"                                    │ │
│  │ ".json"   → "json"                                          │ │
│  │ ".axaml"  → "axaml"                                         │ │
│  │ ...                                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Content-Based Detection

```
┌─────────────────────────────────────────────────────────────────┐
│                    Content-Based Detection                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  DetectFromContent(content)                                      │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ C# Detection                                                │ │
│  │                                                              │ │
│  │ if (content.Contains("namespace ") &&                       │ │
│  │     content.Contains("using "))                             │ │
│  │     return "csharp";                                        │ │
│  │                                                              │ │
│  │ if (Regex.IsMatch(content,                                   │ │
│  │     @"^\s*(public|private|internal)\s+(class|interface)"))  │ │
│  │     return "csharp";                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ TypeScript / JavaScript Detection                           │ │
│  │                                                              │ │
│  │ if (content.Contains("import ") &&                          │ │
│  │     content.Contains("from "))                              │ │
│  │     return content.Contains(": ") ? "typescript"            │ │
│  │                                   : "javascript";           │ │
│  │                                                              │ │
│  │ if (content.Contains("export default") ||                   │ │
│  │     content.Contains("export class"))                       │ │
│  │     return "javascript";                                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Python Detection                                            │ │
│  │                                                              │ │
│  │ if (Regex.IsMatch(content,                                   │ │
│  │     @"^(def |class |import |from .+ import)"))              │ │
│  │     return "python";                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ JSON Detection                                              │ │
│  │                                                              │ │
│  │ if (content.StartsWith('{') &&                              │ │
│  │     content.TrimEnd().EndsWith('}'))                        │ │
│  │     return "json";                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ XML / HTML Detection                                        │ │
│  │                                                              │ │
│  │ if (content.StartsWith("<?xml") ||                          │ │
│  │     content.StartsWith("<Project"))                         │ │
│  │     return "xml";                                           │ │
│  │                                                              │ │
│  │ if (content.StartsWith("<!DOCTYPE html") ||                 │ │
│  │     content.StartsWith("<html"))                            │ │
│  │     return "html";                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Shell Detection                                             │ │
│  │                                                              │ │
│  │ if (content.StartsWith("$ ") ||                             │ │
│  │     (content.StartsWith("# ") && !content.Contains('\n')))  │ │
│  │     return "bash";                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  return null;  // No detection                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Interfaces/
    └── ILanguageDetectionService.cs                  (NEW)

src/SeniorIntern.Services/
└── LanguageDetectionService.cs                       (NEW)
```

---

## Implementation Details

### Task 1: Create ILanguageDetectionService Interface

**File:** `src/SeniorIntern.Core/Interfaces/ILanguageDetectionService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

/// <summary>
/// Service for detecting and normalizing programming language identifiers.
/// </summary>
public interface ILanguageDetectionService
{
    /// <summary>
    /// Detect the programming language of a code block.
    /// Uses a priority system: fence language > file extension > content heuristics.
    /// </summary>
    /// <param name="fenceLanguage">Language specified in the fence (may be null).</param>
    /// <param name="content">The code content.</param>
    /// <param name="filePath">Optional file path for extension-based detection.</param>
    /// <returns>Tuple of (normalized language ID, display name).</returns>
    (string? Language, string? DisplayLanguage) DetectLanguage(
        string? fenceLanguage,
        string content,
        string? filePath = null);

    /// <summary>
    /// Get the canonical language ID for an alias.
    /// </summary>
    /// <param name="languageAlias">Language alias (e.g., "cs", "c#", "py").</param>
    /// <returns>Canonical language ID or null if unknown.</returns>
    string? NormalizeLanguageId(string languageAlias);

    /// <summary>
    /// Get the display name for a language ID.
    /// </summary>
    /// <param name="languageId">Canonical language ID (e.g., "csharp").</param>
    /// <returns>User-friendly display name (e.g., "C#") or null.</returns>
    string? GetDisplayName(string languageId);

    /// <summary>
    /// Get the primary file extension for a language.
    /// </summary>
    /// <param name="languageId">Canonical language ID.</param>
    /// <returns>Primary file extension with dot (e.g., ".cs") or null.</returns>
    string? GetFileExtension(string languageId);

    /// <summary>
    /// Get the language ID for a file extension.
    /// </summary>
    /// <param name="extension">File extension with or without dot.</param>
    /// <returns>Canonical language ID or null if unknown.</returns>
    string? GetLanguageForExtension(string extension);

    /// <summary>
    /// Check if a language is a shell/command language.
    /// </summary>
    /// <param name="languageId">Language ID to check.</param>
    /// <returns>True for bash, powershell, cmd, etc.</returns>
    bool IsShellLanguage(string? languageId);

    /// <summary>
    /// Check if a language is for configuration files.
    /// </summary>
    /// <param name="languageId">Language ID to check.</param>
    /// <returns>True for json, yaml, xml, toml, ini, etc.</returns>
    bool IsConfigLanguage(string? languageId);

    /// <summary>
    /// Get all supported language IDs.
    /// </summary>
    /// <returns>Collection of canonical language IDs.</returns>
    IReadOnlyCollection<string> GetSupportedLanguages();
}
```

### Task 2: Implement LanguageDetectionService

**File:** `src/SeniorIntern.Services/LanguageDetectionService.cs`

```csharp
namespace SeniorIntern.Services;

using System.Text.RegularExpressions;
using SeniorIntern.Core.Interfaces;

public sealed class LanguageDetectionService : ILanguageDetectionService
{
    // Language definitions with aliases and metadata
    private static readonly Dictionary<string, LanguageInfo> Languages = new(
        StringComparer.OrdinalIgnoreCase)
    {
        // === C-Family ===
        ["csharp"] = new("csharp", "C#", ".cs", new[] { "cs", "c#" }),
        ["c"] = new("c", "C", ".c", new[] { "h" }),
        ["cpp"] = new("cpp", "C++", ".cpp", new[] { "c++", "cxx", "cc", "hpp", "hxx" }),
        ["objective-c"] = new("objective-c", "Objective-C", ".m", new[] { "objc", "obj-c" }),

        // === Web ===
        ["javascript"] = new("javascript", "JavaScript", ".js", new[] { "js", "mjs", "cjs", "jsx" }),
        ["typescript"] = new("typescript", "TypeScript", ".ts", new[] { "ts", "tsx" }),
        ["html"] = new("html", "HTML", ".html", new[] { "htm" }),
        ["css"] = new("css", "CSS", ".css", Array.Empty<string>()),
        ["scss"] = new("scss", "SCSS", ".scss", new[] { "sass" }),
        ["less"] = new("less", "Less", ".less", Array.Empty<string>()),
        ["vue"] = new("vue", "Vue", ".vue", Array.Empty<string>()),
        ["svelte"] = new("svelte", "Svelte", ".svelte", Array.Empty<string>()),

        // === Scripting ===
        ["python"] = new("python", "Python", ".py", new[] { "py", "py3" }),
        ["ruby"] = new("ruby", "Ruby", ".rb", new[] { "rb" }),
        ["perl"] = new("perl", "Perl", ".pl", new[] { "pm" }),
        ["php"] = new("php", "PHP", ".php", Array.Empty<string>()),
        ["lua"] = new("lua", "Lua", ".lua", Array.Empty<string>()),

        // === JVM ===
        ["java"] = new("java", "Java", ".java", Array.Empty<string>()),
        ["kotlin"] = new("kotlin", "Kotlin", ".kt", new[] { "kts" }),
        ["scala"] = new("scala", "Scala", ".scala", Array.Empty<string>()),
        ["groovy"] = new("groovy", "Groovy", ".groovy", Array.Empty<string>()),
        ["clojure"] = new("clojure", "Clojure", ".clj", new[] { "cljs", "cljc" }),

        // === Systems ===
        ["rust"] = new("rust", "Rust", ".rs", new[] { "rs" }),
        ["go"] = new("go", "Go", ".go", new[] { "golang" }),
        ["swift"] = new("swift", "Swift", ".swift", Array.Empty<string>()),
        ["zig"] = new("zig", "Zig", ".zig", Array.Empty<string>()),

        // === Shell (IsShell = true) ===
        ["bash"] = new("bash", "Bash", ".sh", new[] { "sh", "shell", "zsh" }, isShell: true),
        ["powershell"] = new("powershell", "PowerShell", ".ps1", new[] { "ps", "ps1", "pwsh" }, isShell: true),
        ["cmd"] = new("cmd", "Command Prompt", ".cmd", new[] { "bat", "batch" }, isShell: true),
        ["fish"] = new("fish", "Fish", ".fish", Array.Empty<string>(), isShell: true),

        // === Config/Data (IsConfig = true) ===
        ["json"] = new("json", "JSON", ".json", new[] { "jsonc" }, isConfig: true),
        ["yaml"] = new("yaml", "YAML", ".yaml", new[] { "yml" }, isConfig: true),
        ["xml"] = new("xml", "XML", ".xml", new[] { "xsl", "xslt" }, isConfig: true),
        ["toml"] = new("toml", "TOML", ".toml", Array.Empty<string>(), isConfig: true),
        ["ini"] = new("ini", "INI", ".ini", new[] { "cfg", "conf" }, isConfig: true),
        ["properties"] = new("properties", "Properties", ".properties", Array.Empty<string>(), isConfig: true),
        ["env"] = new("env", "Environment", ".env", Array.Empty<string>(), isConfig: true),

        // === Markup ===
        ["markdown"] = new("markdown", "Markdown", ".md", new[] { "md", "mdx" }),
        ["latex"] = new("latex", "LaTeX", ".tex", new[] { "tex" }),
        ["rst"] = new("rst", "reStructuredText", ".rst", Array.Empty<string>()),

        // === .NET Specific ===
        ["fsharp"] = new("fsharp", "F#", ".fs", new[] { "fs", "f#", "fsx", "fsi" }),
        ["vb"] = new("vb", "Visual Basic", ".vb", new[] { "vbnet", "visualbasic", "vb.net" }),
        ["razor"] = new("razor", "Razor", ".razor", new[] { "cshtml" }),
        ["axaml"] = new("axaml", "Avalonia XAML", ".axaml", Array.Empty<string>()),
        ["xaml"] = new("xaml", "XAML", ".xaml", Array.Empty<string>()),

        // === Database ===
        ["sql"] = new("sql", "SQL", ".sql", new[] { "mysql", "postgresql", "postgres", "sqlite", "tsql", "plsql" }),
        ["graphql"] = new("graphql", "GraphQL", ".graphql", new[] { "gql" }),

        // === Build/DevOps ===
        ["dockerfile"] = new("dockerfile", "Dockerfile", "", new[] { "docker" }),
        ["makefile"] = new("makefile", "Makefile", "", new[] { "make" }),
        ["terraform"] = new("terraform", "Terraform", ".tf", new[] { "tf", "hcl" }, isConfig: true),

        // === Other ===
        ["regex"] = new("regex", "Regex", "", new[] { "regexp" }),
        ["diff"] = new("diff", "Diff", ".diff", new[] { "patch" }),
        ["plaintext"] = new("plaintext", "Plain Text", ".txt", new[] { "text", "txt" }),
    };

    // Extension to language mapping (built from Languages)
    private static readonly Dictionary<string, string> ExtensionMap;

    // Alias to canonical ID mapping (built from Languages)
    private static readonly Dictionary<string, string> AliasMap;

    static LanguageDetectionService()
    {
        ExtensionMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        AliasMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        foreach (var (id, info) in Languages)
        {
            // Map extension to language
            if (!string.IsNullOrEmpty(info.Extension))
            {
                ExtensionMap[info.Extension] = id;
            }

            // Map aliases to canonical ID
            foreach (var alias in info.Aliases)
            {
                AliasMap[alias] = id;
            }
            AliasMap[id] = id; // Map ID to itself
        }
    }

    public (string? Language, string? DisplayLanguage) DetectLanguage(
        string? fenceLanguage,
        string content,
        string? filePath = null)
    {
        // Priority 1: Explicit fence language
        if (!string.IsNullOrWhiteSpace(fenceLanguage))
        {
            var normalized = NormalizeLanguageId(fenceLanguage.Trim());
            if (normalized != null)
            {
                return (normalized, GetDisplayName(normalized));
            }
        }

        // Priority 2: File extension
        if (!string.IsNullOrEmpty(filePath))
        {
            var ext = Path.GetExtension(filePath);
            if (!string.IsNullOrEmpty(ext))
            {
                var langFromExt = GetLanguageForExtension(ext);
                if (langFromExt != null)
                {
                    return (langFromExt, GetDisplayName(langFromExt));
                }
            }
        }

        // Priority 3: Content-based detection (heuristics)
        var detected = DetectFromContent(content);
        if (detected != null)
        {
            return (detected, GetDisplayName(detected));
        }

        return (null, null);
    }

    public string? NormalizeLanguageId(string languageAlias)
    {
        if (string.IsNullOrWhiteSpace(languageAlias))
            return null;

        return AliasMap.TryGetValue(languageAlias.Trim(), out var id) ? id : null;
    }

    public string? GetDisplayName(string languageId)
    {
        return Languages.TryGetValue(languageId, out var info) ? info.DisplayName : null;
    }

    public string? GetFileExtension(string languageId)
    {
        if (Languages.TryGetValue(languageId, out var info) && 
            !string.IsNullOrEmpty(info.Extension))
        {
            return info.Extension;
        }
        return null;
    }

    public string? GetLanguageForExtension(string extension)
    {
        var ext = extension.StartsWith('.') ? extension : $".{extension}";
        return ExtensionMap.TryGetValue(ext, out var lang) ? lang : null;
    }

    public bool IsShellLanguage(string? languageId)
    {
        if (string.IsNullOrEmpty(languageId))
            return false;
        return Languages.TryGetValue(languageId, out var info) && info.IsShell;
    }

    public bool IsConfigLanguage(string? languageId)
    {
        if (string.IsNullOrEmpty(languageId))
            return false;
        return Languages.TryGetValue(languageId, out var info) && info.IsConfig;
    }

    public IReadOnlyCollection<string> GetSupportedLanguages()
    {
        return Languages.Keys.ToList();
    }

    // === Private Content Detection ===

    private static string? DetectFromContent(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return null;

        var trimmed = content.TrimStart();

        // C# indicators
        if (trimmed.Contains("namespace ") && trimmed.Contains("using "))
            return "csharp";
        if (Regex.IsMatch(trimmed, @"^\s*(public|private|internal|protected)\s+(class|interface|record|struct)"))
            return "csharp";

        // TypeScript/JavaScript
        if (trimmed.Contains("import ") && trimmed.Contains("from "))
            return trimmed.Contains(": ") || trimmed.Contains("<") ? "typescript" : "javascript";
        if (trimmed.Contains("export default") || trimmed.Contains("export class"))
            return "javascript";
        if (Regex.IsMatch(trimmed, @"^(const|let|var)\s+\w+\s*="))
            return "javascript";

        // Python
        if (Regex.IsMatch(trimmed, @"^(def |class |import |from .+ import)", RegexOptions.Multiline))
            return "python";
        if (trimmed.StartsWith("#!/usr/bin/env python") || trimmed.StartsWith("#!/usr/bin/python"))
            return "python";

        // Go
        if (trimmed.StartsWith("package ") && trimmed.Contains("func "))
            return "go";

        // Rust
        if (Regex.IsMatch(trimmed, @"^(fn |pub fn |use |mod |impl |struct |enum )", RegexOptions.Multiline))
            return "rust";

        // Java
        if (Regex.IsMatch(trimmed, @"^(public |private |protected )?(class|interface|enum)\s+\w+"))
            if (!trimmed.Contains("namespace ")) // Distinguish from C#
                return "java";

        // JSON
        if ((trimmed.StartsWith('{') && trimmed.TrimEnd().EndsWith('}')) ||
            (trimmed.StartsWith('[') && trimmed.TrimEnd().EndsWith(']')))
            return "json";

        // YAML
        if (Regex.IsMatch(trimmed, @"^\w+:\s*$", RegexOptions.Multiline) && !trimmed.Contains('{'))
            return "yaml";

        // XML/HTML
        if (trimmed.StartsWith("<?xml") || trimmed.StartsWith("<Project") || trimmed.StartsWith("<Configuration"))
            return "xml";
        if (trimmed.StartsWith("<!DOCTYPE html") || trimmed.StartsWith("<html"))
            return "html";

        // Shell commands (single line with $ or #)
        if (trimmed.StartsWith("$ ") || (trimmed.StartsWith("# ") && !trimmed.Contains('\n')))
            return "bash";

        // SQL
        if (Regex.IsMatch(trimmed, @"^(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\s", 
            RegexOptions.IgnoreCase | RegexOptions.Multiline))
            return "sql";

        return null;
    }

    // === Private Types ===

    private sealed record LanguageInfo(
        string Id,
        string DisplayName,
        string Extension,
        string[] Aliases,
        bool IsShell = false,
        bool IsConfig = false);
}
```

---

## Language Reference Tables

### Supported Languages (50+)

| Category | Languages |
|----------|-----------|
| **C-Family** | csharp, c, cpp, objective-c |
| **Web** | javascript, typescript, html, css, scss, less, vue, svelte |
| **Scripting** | python, ruby, perl, php, lua |
| **JVM** | java, kotlin, scala, groovy, clojure |
| **Systems** | rust, go, swift, zig |
| **Shell** | bash, powershell, cmd, fish |
| **Config** | json, yaml, xml, toml, ini, properties, env, terraform |
| **Markup** | markdown, latex, rst |
| **.NET** | fsharp, vb, razor, axaml, xaml |
| **Database** | sql, graphql |
| **DevOps** | dockerfile, makefile |
| **Other** | regex, diff, plaintext |

### Common Aliases

| Alias | Canonical ID |
|-------|--------------|
| cs, c# | csharp |
| js, mjs, cjs | javascript |
| ts, tsx | typescript |
| py, py3 | python |
| rb | ruby |
| sh, shell, zsh | bash |
| ps, ps1, pwsh | powershell |
| yml | yaml |
| fs, f# | fsharp |
| golang | go |
| bat, batch | cmd |

### Shell Languages

| Language | Primary Extension |
|----------|-------------------|
| bash | .sh |
| powershell | .ps1 |
| cmd | .cmd |
| fish | .fish |

### Config Languages

| Language | Primary Extension |
|----------|-------------------|
| json | .json |
| yaml | .yaml |
| xml | .xml |
| toml | .toml |
| ini | .ini |
| properties | .properties |
| env | .env |
| terraform | .tf |

---

## Content Detection Heuristics

| Language | Detection Pattern |
|----------|-------------------|
| csharp | `namespace` + `using`, or access modifier + class/interface |
| typescript | `import` + `from` + type annotations |
| javascript | `import` + `from`, `export`, `const\|let\|var` |
| python | `def\|class\|import\|from...import` at line start |
| go | `package` + `func` |
| rust | `fn\|pub fn\|use\|mod\|impl\|struct\|enum` |
| java | Access modifier + class (without namespace) |
| json | Starts with `{` or `[`, ends with `}` or `]` |
| yaml | `key:` pattern without braces |
| xml | `<?xml`, `<Project>`, `<Configuration>` |
| html | `<!DOCTYPE html>`, `<html>` |
| bash | Starts with `$` or single-line `#` |
| sql | `SELECT\|INSERT\|UPDATE\|DELETE\|CREATE` |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| DetectLanguage (fence) | 6 | Various aliases |
| DetectLanguage (extension) | 5 | Common extensions |
| DetectLanguage (content) | 8 | Each heuristic |
| NormalizeLanguageId | 4 | Aliases, unknown |
| GetDisplayName | 3 | Known, unknown |
| GetFileExtension | 3 | With/without extension |
| GetLanguageForExtension | 4 | With/without dot |
| IsShellLanguage | 4 | Shell and non-shell |
| IsConfigLanguage | 4 | Config and non-config |
| GetSupportedLanguages | 1 | Returns all |
| **Total** | **42** | |

---

## Files Summary

### Files to Create (2)

| File | Lines |
|------|-------|
| `Core/Interfaces/ILanguageDetectionService.cs` | 65 |
| `Services/LanguageDetectionService.cs` | 280 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Desktop/Extensions/ServiceCollectionExtensions.cs` | Register service |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Language aliases map to canonical IDs (50+ aliases) |
| AC-2 | File extensions map to languages correctly |
| AC-3 | Content-based detection works for C#, JS, TS, Python, JSON, XML, HTML, SQL, Bash |
| AC-4 | Display names are user-friendly (e.g., "C#" not "csharp") |
| AC-5 | Shell languages correctly identified (bash, powershell, cmd, fish) |
| AC-6 | Config languages correctly identified (json, yaml, xml, toml, ini, terraform) |
| AC-7 | Unknown languages return null gracefully |
| AC-8 | Detection priority: fence > extension > content |
| AC-9 | Case-insensitive matching for aliases and extensions |
| AC-10 | Unit tests pass for all detection scenarios |

---

## Dependencies

| Dependency | Description |
|------------|-------------|
| None | No external dependencies |

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Empty fence language | Use extension/content fallback |
| Unknown alias | Return null |
| Extension without dot | Automatically prefix with dot |
| Uppercase extension | Case-insensitive match |
| Empty content | Return null from content detection |
| Ambiguous content | First matching heuristic wins |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.4.1c | 0.5 day |
