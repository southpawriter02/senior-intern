# Design Specification: The Senior Intern v0.4.2f "Diff Line Rendering"

**Status**: _IMPLEMENTED_

## Executive Summary

This document provides a detailed implementation specification for v0.4.2f, which creates the custom controls for rendering diff hunks and individual diff lines with inline change highlighting. These controls are the core visual building blocks used within the DiffViewerPanel (v0.4.2e) to display side-by-side diff content.

The DiffHunkControl renders a complete hunk with its header showing statistics and contains an ItemsControl of DiffLineControl instances. The DiffLineControl renders individual lines with a line number gutter, content area, and optional inline segment highlighting for character-level changes.

### v0.4.2f Scope

- Create `DiffHunkControl.axaml` with hunk header and lines container
- Create `DiffHunkControl.axaml.cs` with Side and ShowInlineChanges properties
- Create `DiffLineControl.axaml` with gutter, content, and inline segments
- Create `DiffLineControl.axaml.cs` with minimal code-behind
- Implement conditional styling for added/removed/modified/placeholder lines
- Implement inline segment rendering with WrapPanel
- Create required value converters for inline segment styling

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| DiffHunkControl.axaml | Hunk container with header showing stats and lines ItemsControl |
| DiffHunkControl.axaml.cs | Code-behind with Side and ShowInlineChanges StyledProperties |
| DiffLineControl.axaml | Line rendering with gutter, content, and inline segments |
| DiffLineControl.axaml.cs | Minimal code-behind with InitializeComponent |
| InlineAddedConverter | Value converter for inline-added CSS class binding |
| InlineRemovedConverter | Value converter for inline-removed CSS class binding |
| DiffSide Enum | Enum distinguishing Original vs Proposed panels |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.4.2f Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Diff Line Rendering Controls                                     │
│  ├── DiffHunkControl                                              │
│  │   ├── Layout Structure                                         │
│  │   │   ├── Border.diff-hunk (container with margin)             │
│  │   │   └── Grid (RowDefinitions="Auto, Auto")                   │
│  │   │                                                            │
│  │   ├── Hunk Header (Row 0)                                      │
│  │   │   ├── Border.hunk-header (styled background)               │
│  │   │   ├── Header TextBlock (e.g., "@@ -10,5 +12,7 @@")         │
│  │   │   └── Stats StackPanel                                     │
│  │   │       ├── Added count (+N in green)                        │
│  │   │       └── Removed count (-N in red)                        │
│  │   │                                                            │
│  │   ├── Lines Container (Row 1)                                  │
│  │   │   ├── ItemsControl (x:Name="LinesContainer")               │
│  │   │   └── ItemTemplate → DiffLineControl                       │
│  │   │                                                            │
│  │   ├── Styled Properties                                        │
│  │   │   ├── Side (DiffSide) - Original or Proposed               │
│  │   │   └── ShowInlineChanges (bool) - Enable inline highlights  │
│  │   │                                                            │
│  │   └── Code-Behind Logic                                        │
│  │       ├── OnPropertyChanged → UpdateLinesSource()              │
│  │       └── OnDataContextChanged → UpdateLinesSource()           │
│  │                                                                │
│  ├── DiffLineControl                                              │
│  │   ├── Layout Structure                                         │
│  │   │   └── Grid (ColumnDefinitions="48, *", MinHeight="20")     │
│  │   │                                                            │
│  │   ├── Conditional Classes (on Grid)                            │
│  │   │   ├── Classes.added="{Binding IsAdded}"                    │
│  │   │   ├── Classes.removed="{Binding IsRemoved}"                │
│  │   │   ├── Classes.modified="{Binding IsModified}"              │
│  │   │   └── Classes.placeholder="{Binding IsPlaceholder}"        │
│  │   │                                                            │
│  │   ├── Line Number Gutter (Column 0)                            │
│  │   │   ├── Border.line-gutter                                   │
│  │   │   ├── TextBlock with right alignment                       │
│  │   │   └── Hidden for placeholder lines                         │
│  │   │                                                            │
│  │   ├── Line Content (Column 1)                                  │
│  │   │   ├── Border.line-content with padding                     │
│  │   │   ├── Placeholder Rectangle (when IsPlaceholder)           │
│  │   │   ├── Regular SelectableTextBlock (no inline segments)     │
│  │   │   └── ItemsControl with WrapPanel (inline segments)        │
│  │   │                                                            │
│  │   └── Inline Segments Rendering                                │
│  │       ├── ItemsControl (ItemsSource=InlineSegments)            │
│  │       ├── ItemsPanelTemplate → WrapPanel Horizontal            │
│  │       └── TextBlock with inline-added/inline-removed classes   │
│  │                                                                │
│  └── Supporting Types                                             │
│      ├── DiffSide Enum (Original, Proposed)                       │
│      ├── InlineAddedConverter (IsChanged + Side → bool)           │
│      └── InlineRemovedConverter (IsChanged + Side → bool)         │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Control Hierarchy

```
┌─────────────────────────────────────────────────────────────────┐
│                       Control Hierarchy                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  DiffViewerPanel (from v0.4.2e)                                  │
│  └── ScrollViewer (x2: Original + Proposed)                      │
│      └── ItemsControl (ItemsSource="{Binding Hunks}")            │
│          └── DiffHunkControl (per DiffHunkViewModel)             │
│              ├── DataContext: DiffHunkViewModel                  │
│              ├── Side: DiffSide.Original OR DiffSide.Proposed    │
│              ├── ShowInlineChanges: bound from parent            │
│              │                                                   │
│              └── ItemsControl (LinesContainer)                   │
│                  ├── ItemsSource: OriginalLines OR ProposedLines │
│                  └── DiffLineControl (per DiffLineViewModel)     │
│                      ├── DataContext: DiffLineViewModel          │
│                      ├── Grid with conditional classes           │
│                      ├── Line gutter with number                 │
│                      └── Line content with inline segments       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### DiffHunkControl Visual Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                    DiffHunkControl Layout                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Border.diff-hunk (Margin="0,0,0,8")                             │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Grid (RowDefinitions="Auto, Auto")                         │   │
│  │                                                            │   │
│  │ Row 0: Border.hunk-header                                  │   │
│  │ ┌─────────────────────────────────────────────────────────┐│   │
│  │ │ Grid (ColumnDefinitions="*, Auto")                      ││   │
│  │ │ ┌─────────────────────────┬─────────────────────────┐   ││   │
│  │ │ │ "@@ -10,5 +12,7 @@"    │    +3    -1             │   ││   │
│  │ │ │ (monospace, muted)      │ (green) (red)          │   ││   │
│  │ │ └─────────────────────────┴─────────────────────────┘   ││   │
│  │ └─────────────────────────────────────────────────────────┘│   │
│  │                                                            │   │
│  │ Row 1: ItemsControl (LinesContainer)                       │   │
│  │ ┌─────────────────────────────────────────────────────────┐│   │
│  │ │ DiffLineControl (line 1)                                ││   │
│  │ │ DiffLineControl (line 2)                                ││   │
│  │ │ DiffLineControl (line 3)                                ││   │
│  │ │ ...                                                     ││   │
│  │ └─────────────────────────────────────────────────────────┘│   │
│  │                                                            │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### DiffLineControl Visual Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                    DiffLineControl Layout                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Grid (ColumnDefinitions="48, *", MinHeight="20")                │
│  Classes: added | removed | modified | placeholder               │
│                                                                  │
│  ┌────────────────┬──────────────────────────────────────────┐   │
│  │ Column 0 (48px)│ Column 1 (*)                              │   │
│  │ Line Gutter    │ Line Content                              │   │
│  │                │                                           │   │
│  │ ┌────────────┐ │ ┌───────────────────────────────────────┐ │   │
│  │ │Border.gutter│ │ Border.line-content (Padding="8,1")   │ │   │
│  │ │            │ │ │                                       │ │   │
│  │ │  "  42"   │ │ │ Option A: Placeholder Rectangle       │ │   │
│  │ │ (right    │ │ │   └── IsVisible={Binding IsPlaceholder}│ │   │
│  │ │  aligned) │ │ │                                       │ │   │
│  │ │            │ │ │ Option B: Plain Text                  │ │   │
│  │ │ Hidden if  │ │ │   └── SelectableTextBlock             │ │   │
│  │ │ placeholder│ │ │   └── IsVisible={!HasInlineSegments} │ │   │
│  │ │            │ │ │                                       │ │   │
│  │ └────────────┘ │ │ Option C: Inline Segments             │ │   │
│  │                │ │   └── ItemsControl with WrapPanel     │ │   │
│  │                │ │   └── IsVisible={HasInlineSegments}  │ │   │
│  │                │ │                                       │ │   │
│  │                │ └───────────────────────────────────────┘ │   │
│  └────────────────┴──────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Inline Segments Rendering

```
┌─────────────────────────────────────────────────────────────────┐
│                  Inline Segments Rendering                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Example line: "const message = 'Hello World!';"                 │
│  Modified from: "const msg = 'Hello';"                           │
│                                                                  │
│  Segments:                                                       │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │const │message│ = '│Hello │World!│';│                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│         ▲           ▲        ▲                                   │
│         │           │        └── inline-added (green bg)         │
│         │           └────────── unchanged (no highlight)         │
│         └────────────────────── inline-added (was "msg")         │
│                                                                  │
│  ItemsControl with WrapPanel:                                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ WrapPanel (Orientation="Horizontal")                        │ │
│  │ ┌──────┬─────────┬────┬───────┬────────┬────┐               │ │
│  │ │TextB │TextBlock│Text│TextBlk│TextBlk │Text│               │ │
│  │ │"const│"message"│" = │"Hello │"World!"│"';│               │ │
│  │ │"     │ .added  │"'" │       │.added  │    │               │ │
│  │ └──────┴─────────┴────┴───────┴────────┴────┘               │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Each TextBlock binds:                                           │
│  - Text="{Binding Text}"                                         │
│  - Classes.inline-added="{Binding IsChanged, Converter=...}"     │
│  - Classes.inline-removed="{Binding IsChanged, Converter=...}"   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Side Property Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     Side Property Flow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  DiffViewerPanel (v0.4.2e)                                       │
│  │                                                               │
│  ├── Original Panel                                              │
│  │   └── ItemsControl                                            │
│  │       └── DataTemplate                                        │
│  │           └── DiffHunkControl Side="Original"                 │
│  │               │                                               │
│  │               ▼ OnPropertyChanged(SideProperty)               │
│  │               UpdateLinesSource()                             │
│  │               │                                               │
│  │               ▼                                               │
│  │               LinesContainer.ItemsSource = vm.OriginalLines   │
│  │                                                               │
│  └── Proposed Panel                                              │
│      └── ItemsControl                                            │
│          └── DataTemplate                                        │
│              └── DiffHunkControl Side="Proposed"                 │
│                  │                                               │
│                  ▼ OnPropertyChanged(SideProperty)               │
│                  UpdateLinesSource()                             │
│                  │                                               │
│                  ▼                                               │
│                  LinesContainer.ItemsSource = vm.ProposedLines   │
│                                                                  │
│  The same DiffHunkViewModel is used for both sides, but          │
│  the Side property determines which line collection to display.  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### 1. DiffSide Enum

**File**: `src/SeniorIntern.Core/Enums/DiffSide.cs`

This enum already may exist from v0.4.2a, but we document it here for reference.

```csharp
// src/SeniorIntern.Core/Enums/DiffSide.cs
namespace SeniorIntern.Core.Enums;

/// <summary>
/// Represents which side of a diff comparison is being displayed.
/// </summary>
public enum DiffSide
{
    /// <summary>
    /// The original (left) side showing content before changes.
    /// </summary>
    Original = 0,

    /// <summary>
    /// The proposed (right) side showing content after changes.
    /// </summary>
    Proposed = 1
}
```

### 2. DiffHunkControl.axaml

**File**: `src/SeniorIntern.Desktop/Controls/DiffHunkControl.axaml`

```xml
<!-- src/SeniorIntern.Desktop/Controls/DiffHunkControl.axaml -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             xmlns:controls="using:SeniorIntern.Desktop.Controls"
             x:Class="SeniorIntern.Desktop.Controls.DiffHunkControl"
             x:DataType="vm:DiffHunkViewModel">

    <UserControl.Styles>
        <!-- Hunk header styling -->
        <Style Selector="Border.hunk-header">
            <Setter Property="Background" Value="{DynamicResource DiffHunkHeaderBackground}" />
            <Setter Property="Padding" Value="8,4" />
        </Style>
    </UserControl.Styles>

    <Border Classes="diff-hunk" Margin="0,0,0,8">
        <Grid RowDefinitions="Auto, Auto">
            <!-- Hunk Header -->
            <Border Grid.Row="0" Classes="hunk-header">
                <Grid ColumnDefinitions="*, Auto">
                    <!-- Header text (e.g., "@@ -10,5 +12,7 @@") -->
                    <TextBlock Text="{Binding Header}"
                               FontFamily="Cascadia Code, Consolas, monospace"
                               FontSize="11"
                               Foreground="{DynamicResource DiffHunkHeaderForeground}" />

                    <!-- Stats display -->
                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="8">
                        <!-- Added count -->
                        <TextBlock Text="{Binding AddedCount, StringFormat='+{0}'}"
                                   Foreground="{DynamicResource DiffAddedForeground}"
                                   FontSize="11" />
                        <!-- Removed count -->
                        <TextBlock Text="{Binding RemovedCount, StringFormat='-{0}'}"
                                   Foreground="{DynamicResource DiffRemovedForeground}"
                                   FontSize="11" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Lines container -->
            <ItemsControl Grid.Row="1"
                          ItemsSource="{Binding Lines}"
                          x:Name="LinesContainer">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:DiffLineViewModel}">
                        <controls:DiffLineControl />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </Border>
</UserControl>
```

### 3. DiffHunkControl.axaml.cs

**File**: `src/SeniorIntern.Desktop/Controls/DiffHunkControl.axaml.cs`

```csharp
// src/SeniorIntern.Desktop/Controls/DiffHunkControl.axaml.cs
using Avalonia;
using Avalonia.Controls;
using SeniorIntern.Core.Enums;
using SeniorIntern.Desktop.ViewModels;
using System;

namespace SeniorIntern.Desktop.Controls;

/// <summary>
/// Control for rendering a diff hunk with header and lines.
/// </summary>
/// <remarks>
/// This control receives a DiffHunkViewModel and displays either the
/// OriginalLines or ProposedLines collection based on the Side property.
/// The Side property is set by the parent DiffViewerPanel to indicate
/// which side of the diff this control is rendering.
/// </remarks>
public partial class DiffHunkControl : UserControl
{
    #region Styled Properties

    /// <summary>
    /// Identifies the <see cref="Side"/> styled property.
    /// </summary>
    public static readonly StyledProperty<DiffSide> SideProperty =
        AvaloniaProperty.Register<DiffHunkControl, DiffSide>(nameof(Side));

    /// <summary>
    /// Identifies the <see cref="ShowInlineChanges"/> styled property.
    /// </summary>
    public static readonly StyledProperty<bool> ShowInlineChangesProperty =
        AvaloniaProperty.Register<DiffHunkControl, bool>(nameof(ShowInlineChanges), true);

    /// <summary>
    /// Gets or sets which side of the diff this control displays.
    /// </summary>
    /// <remarks>
    /// When set to Original, displays the OriginalLines collection.
    /// When set to Proposed, displays the ProposedLines collection.
    /// </remarks>
    public DiffSide Side
    {
        get => GetValue(SideProperty);
        set => SetValue(SideProperty, value);
    }

    /// <summary>
    /// Gets or sets whether to show character-level inline change highlighting.
    /// </summary>
    public bool ShowInlineChanges
    {
        get => GetValue(ShowInlineChangesProperty);
        set => SetValue(ShowInlineChangesProperty, value);
    }

    #endregion

    #region Constructor

    public DiffHunkControl()
    {
        InitializeComponent();
    }

    #endregion

    #region Lifecycle Overrides

    /// <summary>
    /// Handle property changes to update the lines source.
    /// </summary>
    protected override void OnPropertyChanged(AvaloniaPropertyChangedEventArgs change)
    {
        base.OnPropertyChanged(change);

        if (change.Property == SideProperty)
        {
            UpdateLinesSource();
        }
    }

    /// <summary>
    /// Handle data context changes to update the lines source.
    /// </summary>
    protected override void OnDataContextChanged(EventArgs e)
    {
        base.OnDataContextChanged(e);
        UpdateLinesSource();
    }

    #endregion

    #region Private Methods

    /// <summary>
    /// Update the ItemsSource of LinesContainer based on the Side property.
    /// </summary>
    private void UpdateLinesSource()
    {
        if (DataContext is DiffHunkViewModel vm)
        {
            LinesContainer.ItemsSource = Side == DiffSide.Original
                ? vm.OriginalLines
                : vm.ProposedLines;
        }
    }

    #endregion
}
```

### 4. DiffLineControl.axaml

**File**: `src/SeniorIntern.Desktop/Controls/DiffLineControl.axaml`

```xml
<!-- src/SeniorIntern.Desktop/Controls/DiffLineControl.axaml -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             x:Class="SeniorIntern.Desktop.Controls.DiffLineControl"
             x:DataType="vm:DiffLineViewModel">

    <!--
    Main Grid layout:
    - Column 0 (48px): Line number gutter
    - Column 1 (*): Line content

    CSS-like classes are conditionally applied based on line type:
    - added: Line was added (green background)
    - removed: Line was removed (red background)
    - modified: Line was modified (yellow/amber background)
    - placeholder: Empty line for alignment (dimmed background)
    -->
    <Grid ColumnDefinitions="48, *"
          MinHeight="20"
          Classes.added="{Binding IsAdded}"
          Classes.removed="{Binding IsRemoved}"
          Classes.modified="{Binding IsModified}"
          Classes.placeholder="{Binding IsPlaceholder}">

        <!-- Line Number Gutter -->
        <Border Grid.Column="0" Classes="line-gutter">
            <TextBlock Text="{Binding LineNumberDisplay}"
                       HorizontalAlignment="Right"
                       Padding="0,0,8,0"
                       FontFamily="Cascadia Code, Consolas, monospace"
                       FontSize="12"
                       Foreground="{DynamicResource DiffGutterForeground}"
                       IsVisible="{Binding !IsPlaceholder}" />
        </Border>

        <!-- Line Content -->
        <Border Grid.Column="1" Classes="line-content" Padding="8,1">

            <!-- Panel is used to overlay multiple children, only one visible at a time -->
            <Panel>

                <!-- Option A: Placeholder (empty line for alignment) -->
                <Rectangle Fill="{DynamicResource DiffPlaceholderBackground}"
                           Height="18"
                           HorizontalAlignment="Stretch"
                           IsVisible="{Binding IsPlaceholder}" />

                <!-- Option B: Regular content (no inline changes) -->
                <SelectableTextBlock Text="{Binding Content}"
                                     FontFamily="Cascadia Code, Consolas, monospace"
                                     FontSize="13"
                                     IsVisible="{Binding !HasInlineSegments}"
                                     Classes.content-visible="{Binding !IsPlaceholder}" />

                <!-- Option C: Content with inline changes -->
                <ItemsControl ItemsSource="{Binding InlineSegments}"
                              IsVisible="{Binding HasInlineSegments}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Text}"
                                       FontFamily="Cascadia Code, Consolas, monospace"
                                       FontSize="13"
                                       Classes.inline-added="{Binding IsChanged,
                                           Converter={StaticResource InlineAddedConverter}}"
                                       Classes.inline-removed="{Binding IsChanged,
                                           Converter={StaticResource InlineRemovedConverter}}" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

            </Panel>

        </Border>
    </Grid>
</UserControl>
```

### 5. DiffLineControl.axaml.cs

**File**: `src/SeniorIntern.Desktop/Controls/DiffLineControl.axaml.cs`

```csharp
// src/SeniorIntern.Desktop/Controls/DiffLineControl.axaml.cs
using Avalonia.Controls;

namespace SeniorIntern.Desktop.Controls;

/// <summary>
/// Control for rendering a single diff line with gutter and content.
/// </summary>
/// <remarks>
/// This control is purely declarative - all logic is handled via data binding
/// to the DiffLineViewModel. The control supports:
/// - Line number display in the gutter
/// - Conditional background colors based on change type
/// - Inline segment rendering for character-level changes
/// - Placeholder lines for side-by-side alignment
/// </remarks>
public partial class DiffLineControl : UserControl
{
    public DiffLineControl()
    {
        InitializeComponent();
    }
}
```

### 6. InlineAddedConverter

**File**: `src/SeniorIntern.Desktop/Converters/InlineAddedConverter.cs`

```csharp
// src/SeniorIntern.Desktop/Converters/InlineAddedConverter.cs
using Avalonia.Data.Converters;
using System;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts InlineSegment.IsChanged to a boolean for the inline-added class.
/// </summary>
/// <remarks>
/// Returns true when the segment is marked as changed AND is on the Proposed side,
/// which means this text was added in the new version.
/// </remarks>
public class InlineAddedConverter : IValueConverter
{
    /// <summary>
    /// Singleton instance for static resource usage.
    /// </summary>
    public static readonly InlineAddedConverter Instance = new();

    /// <summary>
    /// Convert IsChanged to inline-added class application.
    /// </summary>
    /// <param name="value">The IsChanged boolean value from InlineSegment.</param>
    /// <param name="targetType">The target type (bool).</param>
    /// <param name="parameter">Optional parameter (not used).</param>
    /// <param name="culture">Culture info.</param>
    /// <returns>True if this segment should have the inline-added class.</returns>
    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        // For InlineSegments on the Proposed side, IsChanged means "added"
        // The segment already knows it's changed; we apply inline-added style
        return value is bool isChanged && isChanged;
    }

    /// <summary>
    /// Convert back (not implemented).
    /// </summary>
    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}
```

### 7. InlineRemovedConverter

**File**: `src/SeniorIntern.Desktop/Converters/InlineRemovedConverter.cs`

```csharp
// src/SeniorIntern.Desktop/Converters/InlineRemovedConverter.cs
using Avalonia.Data.Converters;
using System;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts InlineSegment.IsChanged to a boolean for the inline-removed class.
/// </summary>
/// <remarks>
/// Returns true when the segment is marked as changed AND is on the Original side,
/// which means this text was removed in the new version.
///
/// Note: In the current design, InlineSegments are side-specific, so removed
/// segments only appear on the Original side. This converter is provided for
/// completeness and potential future use cases.
/// </remarks>
public class InlineRemovedConverter : IValueConverter
{
    /// <summary>
    /// Singleton instance for static resource usage.
    /// </summary>
    public static readonly InlineRemovedConverter Instance = new();

    /// <summary>
    /// Convert IsChanged to inline-removed class application.
    /// </summary>
    /// <param name="value">The IsChanged boolean value from InlineSegment.</param>
    /// <param name="targetType">The target type (bool).</param>
    /// <param name="parameter">Optional parameter indicating side context.</param>
    /// <param name="culture">Culture info.</param>
    /// <returns>True if this segment should have the inline-removed class.</returns>
    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        // For InlineSegments on the Original side, IsChanged means "removed"
        // Return false by default - removed highlighting only on original side
        // The InlineSegment already tracks this via its Type property
        return false; // Removed segments use IsRemoved, not IsChanged
    }

    /// <summary>
    /// Convert back (not implemented).
    /// </summary>
    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}
```

### Alternative: Multi-Value Converter Approach

If we need both IsChanged and Side context, we can use a MultiBinding with IMultiValueConverter.

**File**: `src/SeniorIntern.Desktop/Converters/InlineChangeMultiConverter.cs`

```csharp
// src/SeniorIntern.Desktop/Converters/InlineChangeMultiConverter.cs
using Avalonia.Data.Converters;
using SeniorIntern.Core.Enums;
using System;
using System.Collections.Generic;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Multi-value converter for inline segment styling based on IsChanged and Side.
/// </summary>
public class InlineChangeMultiConverter : IMultiValueConverter
{
    /// <summary>
    /// The type of change to check for.
    /// </summary>
    public enum ChangeType
    {
        Added,
        Removed
    }

    /// <summary>
    /// Which change type this converter instance checks for.
    /// </summary>
    public ChangeType Type { get; set; }

    /// <summary>
    /// Convert (IsChanged, Side) to boolean for class application.
    /// </summary>
    public object? Convert(IList<object?> values, Type targetType, object? parameter, CultureInfo culture)
    {
        if (values.Count < 2)
            return false;

        if (values[0] is not bool isChanged || values[1] is not DiffSide side)
            return false;

        if (!isChanged)
            return false;

        return Type switch
        {
            ChangeType.Added => side == DiffSide.Proposed,
            ChangeType.Removed => side == DiffSide.Original,
            _ => false
        };
    }
}
```

---

## Style Definitions

### Line Type Styles

These styles should be added to the application's theme files (referenced from v0.4.2h but needed here for context).

```xml
<!-- Required styles for DiffLineControl -->

<!-- Added line (green background) -->
<Style Selector="Grid.added">
    <Setter Property="Background" Value="{DynamicResource DiffAddedBackgroundBrush}" />
</Style>

<Style Selector="Grid.added Border.line-gutter">
    <Setter Property="Background" Value="{DynamicResource DiffAddedGutterBrush}" />
</Style>

<!-- Removed line (red background) -->
<Style Selector="Grid.removed">
    <Setter Property="Background" Value="{DynamicResource DiffRemovedBackgroundBrush}" />
</Style>

<Style Selector="Grid.removed Border.line-gutter">
    <Setter Property="Background" Value="{DynamicResource DiffRemovedGutterBrush}" />
</Style>

<!-- Modified line (amber/yellow background) -->
<Style Selector="Grid.modified">
    <Setter Property="Background" Value="{DynamicResource DiffModifiedBackgroundBrush}" />
</Style>

<!-- Placeholder line (dimmed, for alignment) -->
<Style Selector="Grid.placeholder">
    <Setter Property="Background" Value="{DynamicResource DiffPlaceholderBackgroundBrush}" />
    <Setter Property="Opacity" Value="0.5" />
</Style>

<!-- Line gutter base style -->
<Style Selector="Border.line-gutter">
    <Setter Property="Background" Value="{DynamicResource DiffGutterBackgroundBrush}" />
    <Setter Property="BorderBrush" Value="{DynamicResource DiffGutterBorderBrush}" />
    <Setter Property="BorderThickness" Value="0,0,1,0" />
    <Setter Property="MinWidth" Value="48" />
</Style>

<!-- Inline added segment (bright green highlight) -->
<Style Selector="TextBlock.inline-added">
    <Setter Property="Background" Value="{DynamicResource DiffInlineAddedBackgroundBrush}" />
    <Setter Property="Foreground" Value="{DynamicResource DiffAddedForegroundBrush}" />
</Style>

<!-- Inline removed segment (bright red highlight with strikethrough) -->
<Style Selector="TextBlock.inline-removed">
    <Setter Property="Background" Value="{DynamicResource DiffInlineRemovedBackgroundBrush}" />
    <Setter Property="Foreground" Value="{DynamicResource DiffRemovedForegroundBrush}" />
    <Setter Property="TextDecorations" Value="Strikethrough" />
</Style>

<!-- Hunk header style -->
<Style Selector="Border.hunk-header">
    <Setter Property="Background" Value="{DynamicResource DiffHunkHeaderBackgroundBrush}" />
    <Setter Property="Padding" Value="8,4" />
</Style>

<!-- Hunk container style -->
<Style Selector="Border.diff-hunk">
    <Setter Property="BorderBrush" Value="{DynamicResource DiffHunkBorderBrush}" />
    <Setter Property="BorderThickness" Value="1" />
    <Setter Property="CornerRadius" Value="4" />
</Style>
```

---

## Data Binding Summary

### DiffHunkControl Bindings

| Element | Property | Binding | Source |
|---------|----------|---------|--------|
| Header TextBlock | Text | `{Binding Header}` | DiffHunkViewModel.Header |
| Added count TextBlock | Text | `{Binding AddedCount, StringFormat='+{0}'}` | DiffHunkViewModel.AddedCount |
| Removed count TextBlock | Text | `{Binding RemovedCount, StringFormat='-{0}'}` | DiffHunkViewModel.RemovedCount |
| LinesContainer ItemsControl | ItemsSource | Set in code-behind | OriginalLines or ProposedLines |

### DiffLineControl Bindings

| Element | Property | Binding | Source |
|---------|----------|---------|--------|
| Grid | Classes.added | `{Binding IsAdded}` | DiffLineViewModel.IsAdded |
| Grid | Classes.removed | `{Binding IsRemoved}` | DiffLineViewModel.IsRemoved |
| Grid | Classes.modified | `{Binding IsModified}` | DiffLineViewModel.IsModified |
| Grid | Classes.placeholder | `{Binding IsPlaceholder}` | DiffLineViewModel.IsPlaceholder |
| Line number TextBlock | Text | `{Binding LineNumberDisplay}` | DiffLineViewModel.LineNumberDisplay |
| Line number TextBlock | IsVisible | `{Binding !IsPlaceholder}` | DiffLineViewModel.IsPlaceholder |
| Placeholder Rectangle | IsVisible | `{Binding IsPlaceholder}` | DiffLineViewModel.IsPlaceholder |
| Regular TextBlock | Text | `{Binding Content}` | DiffLineViewModel.Content |
| Regular TextBlock | IsVisible | `{Binding !HasInlineSegments}` | DiffLineViewModel.HasInlineSegments |
| Inline ItemsControl | ItemsSource | `{Binding InlineSegments}` | DiffLineViewModel.InlineSegments |
| Inline ItemsControl | IsVisible | `{Binding HasInlineSegments}` | DiffLineViewModel.HasInlineSegments |
| Inline TextBlock | Text | `{Binding Text}` | InlineSegment.Text |
| Inline TextBlock | Classes.inline-added | `{Binding IsChanged, Converter=...}` | InlineSegment.IsChanged |

---

## Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/Controls/DiffHunkControl.axaml` | Hunk container control XAML |
| `src/SeniorIntern.Desktop/Controls/DiffHunkControl.axaml.cs` | Hunk control code-behind with Side property |
| `src/SeniorIntern.Desktop/Controls/DiffLineControl.axaml` | Line rendering control XAML |
| `src/SeniorIntern.Desktop/Controls/DiffLineControl.axaml.cs` | Line control code-behind |
| `src/SeniorIntern.Desktop/Converters/InlineAddedConverter.cs` | Converter for inline-added class |
| `src/SeniorIntern.Desktop/Converters/InlineRemovedConverter.cs` | Converter for inline-removed class |

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/App.axaml` | Register converters as static resources |
| `src/SeniorIntern.Desktop/Themes/Dark.axaml` | Add diff line styles (may already exist from v0.4.2h) |

---

## Dependencies

### Internal Dependencies (v0.4.2 Series)

| Dependency | Provides |
|------------|----------|
| v0.4.2a DiffModels | DiffLineType enum, InlineSegment model |
| v0.4.2d DiffViewModels | DiffHunkViewModel, DiffLineViewModel |
| v0.4.2e DiffViewerPanel | Parent control that uses DiffHunkControl |
| v0.4.2h Theming | Style definitions and color resources |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Avalonia | 11.x | UserControl, StyledProperty, ItemsControl |
| Avalonia.Controls | 11.x | SelectableTextBlock, WrapPanel |

---

## Testing Strategy

### Unit Tests

| Test Class | Coverage |
|------------|----------|
| InlineAddedConverterTests | Convert returns correct values for changed/unchanged |
| InlineRemovedConverterTests | Convert returns correct values |

### Integration Tests

| Test | Verification |
|------|--------------|
| DiffHunkControl_SideProperty | Verify ItemsSource changes when Side changes |
| DiffLineControl_ConditionalClasses | Verify correct classes applied for each line type |

### Manual Testing Checklist

- [ ] Added lines display with green background
- [ ] Removed lines display with red background
- [ ] Modified lines display with amber background
- [ ] Placeholder lines display with dimmed background
- [ ] Line numbers display in gutter, right-aligned
- [ ] Line numbers hidden for placeholder lines
- [ ] Monospace font used consistently
- [ ] Inline segments render with WrapPanel
- [ ] Inline added segments have green highlight
- [ ] Inline removed segments have red highlight with strikethrough
- [ ] Hunk header shows unified diff format
- [ ] Hunk stats show +N -M counts
- [ ] Side property correctly switches OriginalLines/ProposedLines
- [ ] ShowInlineChanges property affects inline segment visibility

---

## Acceptance Criteria

- [ ] Hunk headers display correctly with unified diff format
- [ ] Hunk stats show added (+N) and removed (-N) counts
- [ ] Line numbers shown in gutter with right alignment
- [ ] Line numbers hidden for placeholder lines
- [ ] Added lines have green background (DiffAddedBackground)
- [ ] Removed lines have red background (DiffRemovedBackground)
- [ ] Modified lines have amber background (DiffModifiedBackground)
- [ ] Placeholder lines show for alignment with dimmed background
- [ ] Inline changes highlighted within lines using segments
- [ ] Inline added segments have distinct highlight
- [ ] Inline removed segments have distinct highlight with strikethrough
- [ ] Monospace font used consistently (Cascadia Code, Consolas)
- [ ] Side property correctly determines OriginalLines vs ProposedLines
- [ ] Controls render correctly in both Original and Proposed panels

---

## Design Decisions

### Decision 1: Side Property on DiffHunkControl

**Decision**: Use a StyledProperty on DiffHunkControl to determine which line collection to display.

**Rationale**: The same DiffHunkViewModel contains both OriginalLines and ProposedLines. Rather than duplicating ViewModels, the control uses a property to select which collection to bind. This keeps the ViewModel layer clean and reduces memory usage.

### Decision 2: Conditional Classes vs Computed Styles

**Decision**: Use Avalonia's conditional class syntax (`Classes.added="{Binding IsAdded}"`) rather than style triggers or computed style properties.

**Rationale**: Conditional classes are the idiomatic Avalonia approach for state-based styling. They provide clear CSS-like semantics and work well with the theming system.

### Decision 3: WrapPanel for Inline Segments

**Decision**: Use WrapPanel as the ItemsPanel for inline segments.

**Rationale**: While text typically doesn't wrap within a diff line, WrapPanel ensures proper horizontal flow. StackPanel with Horizontal orientation would also work, but WrapPanel provides better behavior if content exceeds container width.

### Decision 4: Panel Overlay for Content Options

**Decision**: Use Panel to overlay placeholder, regular content, and inline segments, with visibility toggled by bindings.

**Rationale**: Only one content type is visible at a time (placeholder OR regular text OR inline segments). Panel overlays children at the same position, and visibility bindings ensure only the appropriate content displays.

### Decision 5: SelectableTextBlock for Content

**Decision**: Use SelectableTextBlock for regular line content.

**Rationale**: Users should be able to select and copy code from the diff viewer. SelectableTextBlock provides this capability without requiring a TextBox.

---

## Future Considerations

| Item | Target Version | Rationale |
|------|----------------|-----------|
| Syntax highlighting | v0.4.3+ | Would require language-aware tokenization |
| Line-level selection | v0.5.0+ | Allow selecting specific lines for partial apply |
| Collapsible hunks | v0.4.3+ | Hide unchanged regions for large diffs |
| Search within diff | v0.5.0+ | Find and highlight text in diff content |

---

## Related Documents

- [v0.4.2 Diff Engine](v0.4.2-diff-engine.md) - Parent design document
- [v0.4.2d Diff ViewModels](v0.4.2d-diff-viewmodels.md) - ViewModel layer these controls bind to
- [v0.4.2e Side-by-Side View](v0.4.2e-side-by-side-view.md) - Parent panel that hosts DiffHunkControl
- [v0.4.2h Theming & Polish](v0.4.2h-theming-polish.md) - Style definitions used by these controls
