# v0.4.4f: Batch Preview - Design Specification

**Status**: _IMPLEMENTED_

## Executive Summary

This specification details the **Batch Preview** dialog for The Senior Intern's Multi-File Creation system. This modal dialog allows users to preview all file changes in a multi-file proposal before applying them, displaying diffs for each file with tabbed navigation, summary statistics, and the ability to confirm or cancel the entire batch operation. It integrates with the existing diff viewer infrastructure (v0.4.2) and the proposal panel (v0.4.4e).

### Key Deliverables

| Component | Type | Purpose |
|-----------|------|---------|
| `BatchPreviewDialog.axaml` | Window | Modal dialog for batch preview display |
| `BatchPreviewDialog.axaml.cs` | Code-behind | Dialog lifecycle and keyboard handling |
| `BatchPreviewDialogViewModel` | ViewModel | Dialog state management and commands |
| `DiffPreviewViewModel` | ViewModel | Individual diff preview for each file |
| `FileTabControl.axaml` | UserControl | Tabbed file navigation component |
| `BatchPreviewSummaryControl.axaml` | UserControl | Summary statistics display |
| `IncrementConverter` | IValueConverter | Converts 0-based index to 1-based display |
| `ReferenceEqualsConverter` | IValueConverter | Compares object references for selection |

---

## Feature Overview

```
v0.4.4f: Batch Preview
├── BatchPreviewDialog (Window)
│   ├── Layout Structure (3-row Grid)
│   │   ├── Row 0: Header Section
│   │   │   ├── Summary Statistics
│   │   │   │   ├── Total Files Count
│   │   │   │   ├── New Files Count (green)
│   │   │   │   └── Modified Files Count (blue)
│   │   │   └── File Tabs (horizontal scrollable)
│   │   │       ├── FileTabControl per file
│   │   │       │   ├── File Name
│   │   │       │   ├── "NEW" Badge (for new files)
│   │   │       │   └── +/- Stats (for modified)
│   │   │       └── Selected State Indicator
│   │   ├── Row 1: Diff Content (main area)
│   │   │   └── DiffViewerPanel
│   │   │       └── Bound to SelectedPreview.DiffViewModel
│   │   └── Row 2: Footer Section
│   │       ├── Navigation Controls
│   │       │   ├── Previous Button (←)
│   │       │   ├── Next Button (→)
│   │       │   └── "File X of Y" Text
│   │       └── Action Buttons
│   │           ├── Cancel Button
│   │           └── Create All Files Button (accent)
│   ├── Keyboard Shortcuts
│   │   ├── Left Arrow / Ctrl+PageUp → Previous file
│   │   ├── Right Arrow / Ctrl+PageDown → Next file
│   │   ├── Escape → Cancel and close
│   │   ├── Enter / Ctrl+Enter → Apply all
│   │   ├── Home → First file
│   │   └── End → Last file
│   └── Dialog Result
│       ├── true → User clicked "Create All Files"
│       └── false → User clicked "Cancel" or closed
├── BatchPreviewDialogViewModel
│   ├── Observable Properties
│   │   ├── DiffPreviews (ObservableCollection<DiffPreviewViewModel>)
│   │   ├── SelectedPreview (DiffPreviewViewModel?)
│   │   ├── SelectedIndex (int)
│   │   ├── IsApplying (bool)
│   │   └── Progress (double)
│   ├── Computed Properties
│   │   ├── TotalFiles (int)
│   │   ├── NewFiles (int)
│   │   ├── ModifiedFiles (int)
│   │   ├── TotalAddedLines (int)
│   │   ├── TotalRemovedLines (int)
│   │   ├── CanNavigateNext (bool)
│   │   ├── CanNavigatePrevious (bool)
│   │   └── HasMultipleFiles (bool)
│   ├── Commands
│   │   ├── NextFileCommand
│   │   ├── PreviousFileCommand
│   │   ├── GoToFileCommand(index)
│   │   ├── SelectPreviewCommand(DiffPreviewViewModel)
│   │   ├── ApplyAllCommand
│   │   └── CancelCommand
│   └── Methods
│       ├── Constructor(IReadOnlyList<DiffResult>, Window)
│       ├── NavigateToFile(int index)
│       └── Close(bool result)
├── DiffPreviewViewModel
│   ├── Constructor(DiffResult)
│   ├── Properties
│   │   ├── DiffResult (underlying model)
│   │   ├── DiffViewModel (DiffViewerViewModel)
│   │   ├── FileName (string)
│   │   ├── FilePath (string)
│   │   ├── IsNewFile (bool)
│   │   ├── AddedLines (int)
│   │   ├── RemovedLines (int)
│   │   ├── Language (string?)
│   │   └── FileIcon (string)
│   └── Computed Properties
│       ├── HasChanges (bool)
│       ├── NetChange (int) - Added minus Removed
│       ├── ChangesSummary (string) - "+X -Y"
│       └── DisplayName (string) - Truncated if long
├── FileTabControl
│   ├── Properties
│   │   ├── Preview (DiffPreviewViewModel)
│   │   ├── IsSelected (bool)
│   │   └── Index (int)
│   ├── Visual Elements
│   │   ├── File Icon
│   │   ├── File Name (truncated)
│   │   ├── NEW Badge or Change Stats
│   │   └── Selection Indicator
│   └── Interactions
│       ├── Click → Select this file
│       └── Hover → Show full path tooltip
└── Supporting Components
    ├── IncrementConverter
    │   └── Adds 1 to convert 0-based to 1-based index
    ├── ReferenceEqualsConverter
    │   └── Returns true if objects are same reference
    └── BatchPreviewStyles.axaml
        ├── Dialog Layout Styles
        ├── File Tab Styles
        ├── Summary Statistics Styles
        └── Navigation Button Styles
```

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BatchPreviewDialog                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ HEADER (Row 0)                                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Summary: 5 files to create  •  3 new  •  2 modified             │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ ┌──────────┐┌──────────┐┌──────────┐┌──────────┐┌──────────┐    │  │  │
│  │  │ │User.cs   ││Auth.cs   ││Token.cs  ││Config.cs ││Tests.cs  │    │  │  │
│  │  │ │  NEW     ││ +12 -3   ││  NEW     ││ +5 -1    ││  NEW     │    │  │  │
│  │  │ └──────────┘└──────────┘└──────────┘└──────────┘└──────────┘    │  │  │
│  │  │      ▲ selected                                                  │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ DIFF CONTENT (Row 1) - Main scrollable area                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                                                                  │  │  │
│  │  │  ┌─────────────────────┐  ┌─────────────────────┐               │  │  │
│  │  │  │   ORIGINAL (empty)  │  │     PROPOSED        │               │  │  │
│  │  │  │                     │  │  1  using System;   │               │  │  │
│  │  │  │                     │  │  2                  │               │  │  │
│  │  │  │                     │  │  3  namespace App   │               │  │  │
│  │  │  │                     │  │  4  {               │               │  │  │
│  │  │  │                     │  │  5    public class  │               │  │  │
│  │  │  │                     │  │  ...                │               │  │  │
│  │  │  └─────────────────────┘  └─────────────────────┘               │  │  │
│  │  │                                                                  │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ FOOTER (Row 2)                                                         │  │
│  │  ┌─────────────────────────┐          ┌────────┐ ┌──────────────────┐ │  │
│  │  │ ← Previous │ Next →     │          │ Cancel │ │ Create All Files │ │  │
│  │  │     File 1 of 5         │          └────────┘ └──────────────────┘ │  │
│  │  └─────────────────────────┘                                          │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Component Relationships

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Component Data Flow                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  FileTreeProposalPanel                                                      │
│  │                                                                          │
│  │ PreviewCommand.Execute()                                                 │
│  ▼                                                                          │
│  IFileTreeProposalService.PreviewProposalAsync()                           │
│  │                                                                          │
│  │ Returns IReadOnlyList<DiffResult>                                       │
│  ▼                                                                          │
│  new BatchPreviewDialog(diffs)                                              │
│  │                                                                          │
│  │ ShowDialog<bool>(parentWindow)                                          │
│  ▼                                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                  BatchPreviewDialogViewModel                           │  │
│  │                                                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │  │  DiffPreviews: ObservableCollection<DiffPreviewViewModel>       │   │  │
│  │  │                                                                  │   │  │
│  │  │  [0] DiffPreviewViewModel ──────► DiffViewerViewModel           │   │  │
│  │  │       └─ DiffResult                   └─ Hunks, Lines           │   │  │
│  │  │                                                                  │   │  │
│  │  │  [1] DiffPreviewViewModel ──────► DiffViewerViewModel           │   │  │
│  │  │       └─ DiffResult                   └─ Hunks, Lines           │   │  │
│  │  │                                                                  │   │  │
│  │  │  [N] ...                                                        │   │  │
│  │  └─────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                         │  │
│  │  SelectedPreview ─────────► DiffViewerPanel.DataContext                │  │
│  │                                                                         │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  Dialog.Close(true)  → Apply all files                                     │
│  Dialog.Close(false) → Cancel operation                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Navigation State Machine

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        File Navigation Flow                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Initial State: SelectedIndex = 0, SelectedPreview = DiffPreviews[0]       │
│                                                                             │
│  ┌────────────┐  NextFileCommand   ┌────────────┐  NextFileCommand         │
│  │  File 0    │ ───────────────►   │  File 1    │ ───────────────►  ...    │
│  │ (Selected) │                    │ (Selected) │                          │
│  └────────────┘                    └────────────┘                          │
│        ▲                                 │                                  │
│        │                                 │                                  │
│        └─── PreviousFileCommand ─────────┘                                 │
│                                                                             │
│  Navigation Guards:                                                         │
│  - PreviousFile: CanExecute when SelectedIndex > 0                         │
│  - NextFile: CanExecute when SelectedIndex < TotalFiles - 1                │
│                                                                             │
│  Tab Click: GoToFileCommand(index) or SelectPreviewCommand(preview)        │
│                                                                             │
│  Keyboard:                                                                  │
│  - Home → SelectedIndex = 0                                                │
│  - End → SelectedIndex = TotalFiles - 1                                    │
│  - 1-9 → SelectedIndex = key - 1 (if valid)                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### BatchPreviewDialog.axaml

```xml
<!-- src/SeniorIntern.Desktop/Views/BatchPreviewDialog.axaml -->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
        xmlns:views="using:SeniorIntern.Desktop.Views"
        xmlns:controls="using:SeniorIntern.Desktop.Controls"
        xmlns:converters="using:SeniorIntern.Desktop.Converters"
        mc:Ignorable="d"
        d:DesignWidth="1000" d:DesignHeight="700"
        x:Class="SeniorIntern.Desktop.Views.BatchPreviewDialog"
        x:DataType="vm:BatchPreviewDialogViewModel"
        Title="Preview All Changes"
        Width="1000" Height="700"
        MinWidth="800" MinHeight="500"
        MaxWidth="1400" MaxHeight="900"
        WindowStartupLocation="CenterOwner"
        CanResize="True"
        ShowInTaskbar="False"
        SystemDecorations="Full">

    <Window.Resources>
        <converters:IncrementConverter x:Key="IncrementConverter" />
        <converters:ReferenceEqualsConverter x:Key="ReferenceEqualsConverter" />
    </Window.Resources>

    <Window.Styles>
        <!-- File Tab Button -->
        <Style Selector="Button.file-tab">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0,0,0,2" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="CornerRadius" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.file-tab:pointerover">
            <Setter Property="Background" Value="{DynamicResource ControlBackground}" />
        </Style>
        <Style Selector="Button.file-tab.selected">
            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
            <Setter Property="Background" Value="{DynamicResource ControlBackground}" />
        </Style>

        <!-- NEW Badge -->
        <Style Selector="Border.new-badge">
            <Setter Property="Background" Value="{DynamicResource SuccessBackground}" />
            <Setter Property="Padding" Value="4,1" />
            <Setter Property="CornerRadius" Value="3" />
        </Style>

        <!-- Stats Text -->
        <Style Selector="TextBlock.added-text">
            <Setter Property="Foreground" Value="{DynamicResource DiffAddedForeground}" />
        </Style>
        <Style Selector="TextBlock.removed-text">
            <Setter Property="Foreground" Value="{DynamicResource DiffRemovedForeground}" />
        </Style>
        <Style Selector="TextBlock.modified-text">
            <Setter Property="Foreground" Value="{DynamicResource DiffModifiedForeground}" />
        </Style>

        <!-- Navigation Button -->
        <Style Selector="Button.nav-button">
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="MinWidth" Value="100" />
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="Auto, *, Auto">

        <!-- Row 0: Header with Stats and File Tabs -->
        <Border Grid.Row="0"
                Background="{DynamicResource SurfaceBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid RowDefinitions="Auto, Auto">

                <!-- Summary Statistics -->
                <StackPanel Orientation="Horizontal"
                            Spacing="16"
                            Margin="0,0,0,12">
                    <TextBlock FontSize="14" FontWeight="SemiBold">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} files to create">
                                <Binding Path="TotalFiles" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Classes="added-text"
                                       Text="{Binding NewFiles, StringFormat='{}{0} new'}" />
                        </StackPanel>
                        <TextBlock Text="•"
                                   Foreground="{DynamicResource TextMuted}" />
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Classes="modified-text"
                                       Text="{Binding ModifiedFiles, StringFormat='{}{0} modified'}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Total Lines Changed -->
                    <StackPanel Orientation="Horizontal"
                                Spacing="8"
                                IsVisible="{Binding HasModifiedFiles}">
                        <TextBlock Text="•"
                                   Foreground="{DynamicResource TextMuted}" />
                        <TextBlock Classes="added-text"
                                   Text="{Binding TotalAddedLines, StringFormat='+{0}'}" />
                        <TextBlock Classes="removed-text"
                                   Text="{Binding TotalRemovedLines, StringFormat='-{0}'}" />
                    </StackPanel>
                </StackPanel>

                <!-- File Tabs -->
                <ScrollViewer Grid.Row="1"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding DiffPreviews}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="4" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:DiffPreviewViewModel}">
                                <Button Classes="file-tab"
                                        Classes.selected="{Binding $self.DataContext,
                                            Converter={StaticResource ReferenceEqualsConverter},
                                            ConverterParameter={Binding $parent[Window].DataContext.SelectedPreview}}"
                                        Command="{Binding $parent[Window].DataContext.SelectPreviewCommand}"
                                        CommandParameter="{Binding}"
                                        ToolTip.Tip="{Binding FilePath}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <!-- File Icon -->
                                        <PathIcon Data="{Binding FileIcon, Converter={StaticResource IconNameConverter}}"
                                                  Width="14" Height="14"
                                                  Foreground="{DynamicResource TextMuted}" />

                                        <!-- File Name -->
                                        <TextBlock Text="{Binding DisplayName}"
                                                   MaxWidth="120"
                                                   TextTrimming="CharacterEllipsis" />

                                        <!-- NEW Badge (for new files) -->
                                        <Border Classes="new-badge"
                                                IsVisible="{Binding IsNewFile}">
                                            <TextBlock Text="NEW"
                                                       FontSize="9"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource SuccessForeground}" />
                                        </Border>

                                        <!-- Change Stats (for modified files) -->
                                        <StackPanel Orientation="Horizontal"
                                                    Spacing="4"
                                                    IsVisible="{Binding !IsNewFile}">
                                            <TextBlock Classes="added-text"
                                                       Text="{Binding AddedLines, StringFormat='+{0}'}"
                                                       FontSize="11" />
                                            <TextBlock Classes="removed-text"
                                                       Text="{Binding RemovedLines, StringFormat='-{0}'}"
                                                       FontSize="11" />
                                        </StackPanel>
                                    </StackPanel>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Row 1: Diff Content -->
        <Border Grid.Row="1"
                Background="{DynamicResource WindowBackground}">
            <Panel>
                <!-- Diff Viewer -->
                <views:DiffViewerPanel DataContext="{Binding SelectedPreview.DiffViewModel}"
                                       IsVisible="{Binding SelectedPreview, Converter={x:Static ObjectConverters.IsNotNull}}" />

                <!-- Empty State (no selection) -->
                <StackPanel VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            IsVisible="{Binding SelectedPreview, Converter={x:Static ObjectConverters.IsNull}}">
                    <PathIcon Data="{StaticResource FileIcon}"
                              Width="48" Height="48"
                              Foreground="{DynamicResource TextMuted}"
                              Margin="0,0,0,16" />
                    <TextBlock Text="Select a file to preview"
                               Foreground="{DynamicResource TextMuted}"
                               FontSize="14" />
                </StackPanel>
            </Panel>
        </Border>

        <!-- Row 2: Footer with Navigation and Actions -->
        <Border Grid.Row="2"
                Background="{DynamicResource SurfaceBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,12">
            <Grid ColumnDefinitions="Auto, *, Auto">

                <!-- Navigation Controls -->
                <StackPanel Orientation="Horizontal"
                            Spacing="8"
                            IsVisible="{Binding HasMultipleFiles}">
                    <Button Content="← Previous"
                            Command="{Binding PreviousFileCommand}"
                            Classes="nav-button"
                            ToolTip.Tip="Previous file (Left Arrow)" />
                    <Button Content="Next →"
                            Command="{Binding NextFileCommand}"
                            Classes="nav-button"
                            ToolTip.Tip="Next file (Right Arrow)" />

                    <TextBlock VerticalAlignment="Center"
                               Margin="12,0,0,0"
                               Foreground="{DynamicResource TextMuted}">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="File {0} of {1}">
                                <Binding Path="SelectedIndex"
                                         Converter="{StaticResource IncrementConverter}" />
                                <Binding Path="TotalFiles" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>

                <!-- Keyboard Hint (when single file) -->
                <TextBlock Grid.Column="0"
                           IsVisible="{Binding !HasMultipleFiles}"
                           Text="Press Enter to create or Escape to cancel"
                           Foreground="{DynamicResource TextMuted}"
                           VerticalAlignment="Center" />

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="8">
                    <Button Content="Cancel"
                            Command="{Binding CancelCommand}"
                            IsCancel="True"
                            ToolTip.Tip="Cancel (Escape)"
                            Padding="16,8" />
                    <Button Content="Create All Files"
                            Command="{Binding ApplyAllCommand}"
                            IsDefault="True"
                            Classes="accent"
                            ToolTip.Tip="Create all files (Enter)"
                            Padding="16,8" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
```

### BatchPreviewDialog.axaml.cs

```csharp
// src/SeniorIntern.Desktop/Views/BatchPreviewDialog.axaml.cs
using Avalonia.Controls;
using Avalonia.Input;
using Avalonia.Interactivity;
using SeniorIntern.Core.Models;
using SeniorIntern.Desktop.ViewModels;

namespace SeniorIntern.Desktop.Views;

/// <summary>
/// Modal dialog for previewing all file changes in a batch proposal.
/// </summary>
public partial class BatchPreviewDialog : Window
{
    private BatchPreviewDialogViewModel? _viewModel;

    /// <summary>
    /// Creates a new BatchPreviewDialog with the specified diffs.
    /// </summary>
    /// <param name="diffs">The diff results to preview.</param>
    public BatchPreviewDialog(IReadOnlyList<DiffResult> diffs)
    {
        InitializeComponent();

        _viewModel = new BatchPreviewDialogViewModel(diffs, this);
        DataContext = _viewModel;

        // Setup keyboard handling
        KeyDown += OnKeyDown;
    }

    /// <summary>
    /// Parameterless constructor for XAML designer support.
    /// </summary>
    public BatchPreviewDialog()
    {
        InitializeComponent();
    }

    private void OnKeyDown(object? sender, KeyEventArgs e)
    {
        if (_viewModel == null)
            return;

        switch (e.Key)
        {
            case Key.Left:
            case Key.PageUp when e.KeyModifiers.HasFlag(KeyModifiers.Control):
                if (_viewModel.PreviousFileCommand.CanExecute(null))
                {
                    _viewModel.PreviousFileCommand.Execute(null);
                    e.Handled = true;
                }
                break;

            case Key.Right:
            case Key.PageDown when e.KeyModifiers.HasFlag(KeyModifiers.Control):
                if (_viewModel.NextFileCommand.CanExecute(null))
                {
                    _viewModel.NextFileCommand.Execute(null);
                    e.Handled = true;
                }
                break;

            case Key.Home:
                _viewModel.GoToFileCommand.Execute(0);
                e.Handled = true;
                break;

            case Key.End:
                _viewModel.GoToFileCommand.Execute(_viewModel.TotalFiles - 1);
                e.Handled = true;
                break;

            // Number keys 1-9 for quick navigation
            case Key.D1:
            case Key.D2:
            case Key.D3:
            case Key.D4:
            case Key.D5:
            case Key.D6:
            case Key.D7:
            case Key.D8:
            case Key.D9:
                var index = e.Key - Key.D1;
                if (index < _viewModel.TotalFiles)
                {
                    _viewModel.GoToFileCommand.Execute(index);
                    e.Handled = true;
                }
                break;

            case Key.NumPad1:
            case Key.NumPad2:
            case Key.NumPad3:
            case Key.NumPad4:
            case Key.NumPad5:
            case Key.NumPad6:
            case Key.NumPad7:
            case Key.NumPad8:
            case Key.NumPad9:
                var numIndex = e.Key - Key.NumPad1;
                if (numIndex < _viewModel.TotalFiles)
                {
                    _viewModel.GoToFileCommand.Execute(numIndex);
                    e.Handled = true;
                }
                break;
        }
    }

    protected override void OnClosing(WindowClosingEventArgs e)
    {
        base.OnClosing(e);
        KeyDown -= OnKeyDown;
    }
}
```

### BatchPreviewDialogViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/BatchPreviewDialogViewModel.cs
using System.Collections.ObjectModel;
using Avalonia.Controls;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Models;

namespace SeniorIntern.Desktop.ViewModels;

/// <summary>
/// ViewModel for the batch preview dialog, managing navigation and actions.
/// </summary>
public partial class BatchPreviewDialogViewModel : ViewModelBase
{
    private readonly Window _dialog;

    #region Observable Properties

    /// <summary>
    /// Collection of diff previews for all files in the batch.
    /// </summary>
    [ObservableProperty]
    private ObservableCollection<DiffPreviewViewModel> _diffPreviews = new();

    /// <summary>
    /// Currently selected preview for display in the diff viewer.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(SelectedIndex))]
    [NotifyCanExecuteChangedFor(nameof(NextFileCommand))]
    [NotifyCanExecuteChangedFor(nameof(PreviousFileCommand))]
    private DiffPreviewViewModel? _selectedPreview;

    /// <summary>
    /// Index of the currently selected preview.
    /// </summary>
    [ObservableProperty]
    [NotifyCanExecuteChangedFor(nameof(NextFileCommand))]
    [NotifyCanExecuteChangedFor(nameof(PreviousFileCommand))]
    private int _selectedIndex;

    /// <summary>
    /// Whether an apply operation is in progress.
    /// </summary>
    [ObservableProperty]
    private bool _isApplying;

    /// <summary>
    /// Progress percentage of the apply operation.
    /// </summary>
    [ObservableProperty]
    private double _progress;

    #endregion

    #region Computed Properties

    /// <summary>
    /// Total number of files in the preview.
    /// </summary>
    public int TotalFiles => DiffPreviews.Count;

    /// <summary>
    /// Number of new files (files that don't exist yet).
    /// </summary>
    public int NewFiles => DiffPreviews.Count(d => d.IsNewFile);

    /// <summary>
    /// Number of modified files (files that already exist).
    /// </summary>
    public int ModifiedFiles => DiffPreviews.Count(d => !d.IsNewFile);

    /// <summary>
    /// Whether there are any modified files.
    /// </summary>
    public bool HasModifiedFiles => ModifiedFiles > 0;

    /// <summary>
    /// Total lines added across all files.
    /// </summary>
    public int TotalAddedLines => DiffPreviews.Sum(d => d.AddedLines);

    /// <summary>
    /// Total lines removed across all files.
    /// </summary>
    public int TotalRemovedLines => DiffPreviews.Sum(d => d.RemovedLines);

    /// <summary>
    /// Whether there are multiple files to navigate between.
    /// </summary>
    public bool HasMultipleFiles => TotalFiles > 1;

    /// <summary>
    /// Whether navigation to previous file is possible.
    /// </summary>
    public bool CanNavigatePrevious => SelectedIndex > 0;

    /// <summary>
    /// Whether navigation to next file is possible.
    /// </summary>
    public bool CanNavigateNext => SelectedIndex < TotalFiles - 1;

    #endregion

    #region Constructor

    /// <summary>
    /// Creates a new BatchPreviewDialogViewModel.
    /// </summary>
    /// <param name="diffs">The diff results to preview.</param>
    /// <param name="dialog">The parent dialog window.</param>
    public BatchPreviewDialogViewModel(IReadOnlyList<DiffResult> diffs, Window dialog)
    {
        _dialog = dialog;

        // Create preview ViewModels for each diff
        foreach (var diff in diffs)
        {
            DiffPreviews.Add(new DiffPreviewViewModel(diff));
        }

        // Select first file by default
        if (DiffPreviews.Count > 0)
        {
            SelectedPreview = DiffPreviews[0];
            SelectedIndex = 0;
        }
    }

    #endregion

    #region Navigation Commands

    /// <summary>
    /// Navigates to the next file in the list.
    /// </summary>
    [RelayCommand(CanExecute = nameof(CanNavigateNext))]
    private void NextFile()
    {
        if (SelectedIndex < DiffPreviews.Count - 1)
        {
            SelectedIndex++;
            SelectedPreview = DiffPreviews[SelectedIndex];
        }
    }

    /// <summary>
    /// Navigates to the previous file in the list.
    /// </summary>
    [RelayCommand(CanExecute = nameof(CanNavigatePrevious))]
    private void PreviousFile()
    {
        if (SelectedIndex > 0)
        {
            SelectedIndex--;
            SelectedPreview = DiffPreviews[SelectedIndex];
        }
    }

    /// <summary>
    /// Navigates to a specific file by index.
    /// </summary>
    /// <param name="index">The index of the file to navigate to.</param>
    [RelayCommand]
    private void GoToFile(int index)
    {
        if (index >= 0 && index < DiffPreviews.Count)
        {
            SelectedIndex = index;
            SelectedPreview = DiffPreviews[index];
        }
    }

    /// <summary>
    /// Selects a specific preview.
    /// </summary>
    /// <param name="preview">The preview to select.</param>
    [RelayCommand]
    private void SelectPreview(DiffPreviewViewModel? preview)
    {
        if (preview == null)
            return;

        var index = DiffPreviews.IndexOf(preview);
        if (index >= 0)
        {
            SelectedIndex = index;
            SelectedPreview = preview;
        }
    }

    #endregion

    #region Action Commands

    /// <summary>
    /// Confirms and applies all files.
    /// </summary>
    [RelayCommand]
    private void ApplyAll()
    {
        _dialog.Close(true);
    }

    /// <summary>
    /// Cancels the preview and closes the dialog.
    /// </summary>
    [RelayCommand]
    private void Cancel()
    {
        _dialog.Close(false);
    }

    #endregion

    #region Partial Methods

    partial void OnSelectedIndexChanged(int value)
    {
        OnPropertyChanged(nameof(CanNavigatePrevious));
        OnPropertyChanged(nameof(CanNavigateNext));
    }

    #endregion
}
```

### DiffPreviewViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/DiffPreviewViewModel.cs
using CommunityToolkit.Mvvm.ComponentModel;
using SeniorIntern.Core.Models;

namespace SeniorIntern.Desktop.ViewModels;

/// <summary>
/// ViewModel for an individual file diff preview within the batch preview dialog.
/// </summary>
public partial class DiffPreviewViewModel : ViewModelBase
{
    private readonly DiffResult _diff;

    #region Observable Properties

    /// <summary>
    /// The diff viewer ViewModel for displaying the diff content.
    /// </summary>
    [ObservableProperty]
    private DiffViewerViewModel _diffViewModel;

    #endregion

    #region Properties

    /// <summary>
    /// The underlying diff result.
    /// </summary>
    public DiffResult DiffResult => _diff;

    /// <summary>
    /// The file name without path.
    /// </summary>
    public string FileName => Path.GetFileName(_diff.OriginalFilePath);

    /// <summary>
    /// The full file path.
    /// </summary>
    public string FilePath => _diff.OriginalFilePath;

    /// <summary>
    /// Whether this is a new file (original didn't exist).
    /// </summary>
    public bool IsNewFile => _diff.IsNewFile;

    /// <summary>
    /// Whether this is a modification of an existing file.
    /// </summary>
    public bool IsModification => !_diff.IsNewFile && !_diff.IsDeleteFile;

    /// <summary>
    /// Number of lines added.
    /// </summary>
    public int AddedLines => _diff.Stats.AddedLines;

    /// <summary>
    /// Number of lines removed.
    /// </summary>
    public int RemovedLines => _diff.Stats.RemovedLines;

    /// <summary>
    /// Net change in lines (added - removed).
    /// </summary>
    public int NetChange => AddedLines - RemovedLines;

    /// <summary>
    /// The detected programming language.
    /// </summary>
    public string? Language => _diff.Language;

    /// <summary>
    /// Icon name based on file type.
    /// </summary>
    public string FileIcon => GetFileIcon();

    /// <summary>
    /// Truncated display name for tabs.
    /// </summary>
    public string DisplayName
    {
        get
        {
            var name = FileName;
            if (name.Length > 20)
            {
                return name[..17] + "...";
            }
            return name;
        }
    }

    /// <summary>
    /// Summary of changes (e.g., "+12 -3").
    /// </summary>
    public string ChangesSummary
    {
        get
        {
            if (IsNewFile)
                return $"+{AddedLines}";
            return $"+{AddedLines} -{RemovedLines}";
        }
    }

    /// <summary>
    /// Whether the diff has any actual changes.
    /// </summary>
    public bool HasChanges => _diff.HasChanges;

    /// <summary>
    /// File extension without the dot.
    /// </summary>
    public string Extension => Path.GetExtension(FilePath).TrimStart('.');

    /// <summary>
    /// Total line count of the proposed content.
    /// </summary>
    public int TotalLines => _diff.ProposedContent?.Split('\n').Length ?? 0;

    #endregion

    #region Constructor

    /// <summary>
    /// Creates a new DiffPreviewViewModel.
    /// </summary>
    /// <param name="diff">The diff result to preview.</param>
    public DiffPreviewViewModel(DiffResult diff)
    {
        _diff = diff;

        // Create the diff viewer ViewModel
        _diffViewModel = new DiffViewerViewModel();
        _diffViewModel.LoadDiff(diff);
    }

    #endregion

    #region Methods

    /// <summary>
    /// Gets the appropriate icon name based on file extension.
    /// </summary>
    private string GetFileIcon()
    {
        return Path.GetExtension(FilePath).ToLowerInvariant() switch
        {
            ".cs" => "CSharpIcon",
            ".ts" or ".tsx" => "TypeScriptIcon",
            ".js" or ".jsx" or ".mjs" => "JavaScriptIcon",
            ".py" => "PythonIcon",
            ".json" => "JsonIcon",
            ".xml" or ".axaml" or ".xaml" => "XmlIcon",
            ".md" or ".markdown" => "MarkdownIcon",
            ".html" or ".htm" => "HtmlIcon",
            ".css" or ".scss" or ".sass" or ".less" => "CssIcon",
            ".yaml" or ".yml" => "YamlIcon",
            ".sql" => "SqlIcon",
            ".sh" or ".bash" => "BashIcon",
            ".ps1" => "PowerShellIcon",
            ".java" => "JavaIcon",
            ".rb" => "RubyIcon",
            ".go" => "GoIcon",
            ".rs" => "RustIcon",
            ".cpp" or ".cc" or ".cxx" or ".c" or ".h" or ".hpp" => "CppIcon",
            ".swift" => "SwiftIcon",
            ".kt" or ".kts" => "KotlinIcon",
            ".php" => "PhpIcon",
            ".vue" => "VueIcon",
            ".svelte" => "SvelteIcon",
            ".razor" => "RazorIcon",
            _ => "FileIcon"
        };
    }

    #endregion
}
```

### IncrementConverter

```csharp
// src/SeniorIntern.Desktop/Converters/IncrementConverter.cs
using System.Globalization;
using Avalonia.Data.Converters;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts an integer by adding 1 to convert from 0-based to 1-based indexing.
/// </summary>
public class IncrementConverter : IValueConverter
{
    /// <summary>
    /// Singleton instance for use in XAML.
    /// </summary>
    public static readonly IncrementConverter Instance = new();

    /// <summary>
    /// Amount to increment by (default 1).
    /// </summary>
    public int IncrementAmount { get; set; } = 1;

    /// <summary>
    /// Converts an integer by adding the increment amount.
    /// </summary>
    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is int intValue)
        {
            var increment = IncrementAmount;

            // Allow parameter to override increment amount
            if (parameter is int paramInt)
                increment = paramInt;
            else if (parameter is string paramStr && int.TryParse(paramStr, out var parsed))
                increment = parsed;

            return intValue + increment;
        }

        return value;
    }

    /// <summary>
    /// Converts back by subtracting the increment amount.
    /// </summary>
    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is int intValue)
        {
            var increment = IncrementAmount;

            if (parameter is int paramInt)
                increment = paramInt;
            else if (parameter is string paramStr && int.TryParse(paramStr, out var parsed))
                increment = parsed;

            return intValue - increment;
        }

        return value;
    }
}
```

### ReferenceEqualsConverter

```csharp
// src/SeniorIntern.Desktop/Converters/ReferenceEqualsConverter.cs
using System.Globalization;
using Avalonia.Data.Converters;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Compares two objects by reference to determine if they are the same instance.
/// Useful for determining selection state in ItemsControl scenarios.
/// </summary>
public class ReferenceEqualsConverter : IValueConverter
{
    /// <summary>
    /// Singleton instance for use in XAML.
    /// </summary>
    public static readonly ReferenceEqualsConverter Instance = new();

    /// <summary>
    /// Returns true if value and parameter are the same object reference.
    /// </summary>
    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        return ReferenceEquals(value, parameter);
    }

    /// <summary>
    /// Not supported - this is a one-way converter.
    /// </summary>
    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        throw new NotSupportedException("ReferenceEqualsConverter is one-way only.");
    }
}
```

### BatchPreviewStyles.axaml

```xml
<!-- src/SeniorIntern.Desktop/Themes/BatchPreviewStyles.axaml -->
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Dialog-specific colors -->
    <SolidColorBrush x:Key="DialogOverlayBackground" Color="#80000000" />
    <SolidColorBrush x:Key="DialogShadow" Color="#40000000" />

    <!-- File tab indicator animation -->
    <Animation x:Key="TabSelectAnimation"
               Duration="0:0:0.15"
               FillMode="Forward">
        <KeyFrame Cue="0%">
            <Setter Property="Border.BorderThickness" Value="0,0,0,0" />
        </KeyFrame>
        <KeyFrame Cue="100%">
            <Setter Property="Border.BorderThickness" Value="0,0,0,2" />
        </KeyFrame>
    </Animation>

    <!-- Tab scroll indicators -->
    <StreamGeometry x:Key="ChevronLeftIcon">M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z</StreamGeometry>
    <StreamGeometry x:Key="ChevronRightIcon">M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z</StreamGeometry>

    <!-- Empty state icon -->
    <StreamGeometry x:Key="PreviewIcon">M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z</StreamGeometry>

    <!-- Dialog window style -->
    <Style Selector="Window.batch-preview-dialog">
        <Setter Property="Background" Value="{DynamicResource WindowBackground}" />
    </Style>

    <!-- File tab container -->
    <Style Selector="Border.file-tabs-container">
        <Setter Property="Background" Value="{DynamicResource SurfaceBackground}" />
        <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="0,0,0,1" />
    </Style>

    <!-- Summary section -->
    <Style Selector="StackPanel.preview-summary">
        <Setter Property="Margin" Value="0,0,0,12" />
    </Style>

    <!-- Footer navigation -->
    <Style Selector="StackPanel.nav-controls">
        <Setter Property="Spacing" Value="8" />
    </Style>

    <!-- Footer actions -->
    <Style Selector="StackPanel.action-controls">
        <Setter Property="Spacing" Value="8" />
    </Style>

    <!-- Progress indicator for multi-file preview loading -->
    <Style Selector="ProgressBar.preview-loading">
        <Setter Property="IsIndeterminate" Value="True" />
        <Setter Property="Height" Value="4" />
        <Setter Property="CornerRadius" Value="2" />
    </Style>

</ResourceDictionary>
```

---

## Files to Create

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/Views/BatchPreviewDialog.axaml` | Dialog UI markup |
| `src/SeniorIntern.Desktop/Views/BatchPreviewDialog.axaml.cs` | Dialog code-behind |
| `src/SeniorIntern.Desktop/ViewModels/BatchPreviewDialogViewModel.cs` | Dialog ViewModel |
| `src/SeniorIntern.Desktop/ViewModels/DiffPreviewViewModel.cs` | Individual file preview ViewModel |
| `src/SeniorIntern.Desktop/Converters/IncrementConverter.cs` | Index increment converter |
| `src/SeniorIntern.Desktop/Converters/ReferenceEqualsConverter.cs` | Reference equality converter |
| `src/SeniorIntern.Desktop/Themes/BatchPreviewStyles.axaml` | Dialog-specific styles |
| `tests/SeniorIntern.Desktop.Tests/ViewModels/BatchPreviewDialogViewModelTests.cs` | ViewModel unit tests |
| `tests/SeniorIntern.Desktop.Tests/ViewModels/DiffPreviewViewModelTests.cs` | Preview ViewModel tests |

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/App.axaml` | Include BatchPreviewStyles.axaml, register converters |
| `src/SeniorIntern.Desktop/Controls/FileTreeProposalPanel.axaml.cs` | Open BatchPreviewDialog on preview |

---

## Testing Strategy

### Unit Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/ViewModels/BatchPreviewDialogViewModelTests.cs
using Moq;
using Xunit;
using SeniorIntern.Core.Models;
using SeniorIntern.Desktop.ViewModels;

namespace SeniorIntern.Desktop.Tests.ViewModels;

public class BatchPreviewDialogViewModelTests
{
    private readonly Mock<Avalonia.Controls.Window> _dialogMock;

    public BatchPreviewDialogViewModelTests()
    {
        _dialogMock = new Mock<Avalonia.Controls.Window>();
    }

    [Fact]
    public void Constructor_PopulatesDiffPreviews()
    {
        var diffs = CreateTestDiffs(3);

        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        Assert.Equal(3, viewModel.DiffPreviews.Count);
        Assert.Equal(3, viewModel.TotalFiles);
    }

    [Fact]
    public void Constructor_SelectsFirstFile()
    {
        var diffs = CreateTestDiffs(3);

        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        Assert.NotNull(viewModel.SelectedPreview);
        Assert.Equal(0, viewModel.SelectedIndex);
        Assert.Same(viewModel.DiffPreviews[0], viewModel.SelectedPreview);
    }

    [Fact]
    public void Constructor_EmptyDiffs_NoSelection()
    {
        var diffs = new List<DiffResult>();

        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        Assert.Null(viewModel.SelectedPreview);
        Assert.Equal(0, viewModel.TotalFiles);
    }

    [Fact]
    public void NextFile_AdvancesSelection()
    {
        var diffs = CreateTestDiffs(3);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        viewModel.NextFileCommand.Execute(null);

        Assert.Equal(1, viewModel.SelectedIndex);
        Assert.Same(viewModel.DiffPreviews[1], viewModel.SelectedPreview);
    }

    [Fact]
    public void NextFile_AtEnd_DoesNotAdvance()
    {
        var diffs = CreateTestDiffs(3);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);
        viewModel.GoToFileCommand.Execute(2); // Go to last

        viewModel.NextFileCommand.Execute(null);

        Assert.Equal(2, viewModel.SelectedIndex);
    }

    [Fact]
    public void PreviousFile_RetreatSelection()
    {
        var diffs = CreateTestDiffs(3);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);
        viewModel.NextFileCommand.Execute(null); // Go to index 1

        viewModel.PreviousFileCommand.Execute(null);

        Assert.Equal(0, viewModel.SelectedIndex);
    }

    [Fact]
    public void PreviousFile_AtStart_DoesNotRetreat()
    {
        var diffs = CreateTestDiffs(3);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        viewModel.PreviousFileCommand.Execute(null);

        Assert.Equal(0, viewModel.SelectedIndex);
    }

    [Fact]
    public void GoToFile_ValidIndex_NavigatesCorrectly()
    {
        var diffs = CreateTestDiffs(5);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        viewModel.GoToFileCommand.Execute(3);

        Assert.Equal(3, viewModel.SelectedIndex);
        Assert.Same(viewModel.DiffPreviews[3], viewModel.SelectedPreview);
    }

    [Fact]
    public void GoToFile_InvalidIndex_DoesNothing()
    {
        var diffs = CreateTestDiffs(3);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        viewModel.GoToFileCommand.Execute(10);

        Assert.Equal(0, viewModel.SelectedIndex);
    }

    [Fact]
    public void SelectPreview_UpdatesSelection()
    {
        var diffs = CreateTestDiffs(3);
        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        viewModel.SelectPreviewCommand.Execute(viewModel.DiffPreviews[2]);

        Assert.Equal(2, viewModel.SelectedIndex);
        Assert.Same(viewModel.DiffPreviews[2], viewModel.SelectedPreview);
    }

    [Fact]
    public void NewFiles_CountsCorrectly()
    {
        var diffs = new List<DiffResult>
        {
            CreateDiffResult("file1.cs", isNewFile: true),
            CreateDiffResult("file2.cs", isNewFile: false),
            CreateDiffResult("file3.cs", isNewFile: true),
        };

        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        Assert.Equal(2, viewModel.NewFiles);
        Assert.Equal(1, viewModel.ModifiedFiles);
    }

    [Fact]
    public void TotalAddedLines_SumsCorrectly()
    {
        var diffs = new List<DiffResult>
        {
            CreateDiffResult("file1.cs", addedLines: 10, removedLines: 2),
            CreateDiffResult("file2.cs", addedLines: 5, removedLines: 3),
        };

        var viewModel = new BatchPreviewDialogViewModel(diffs, _dialogMock.Object);

        Assert.Equal(15, viewModel.TotalAddedLines);
        Assert.Equal(5, viewModel.TotalRemovedLines);
    }

    [Fact]
    public void HasMultipleFiles_TrueWhenMoreThanOne()
    {
        var single = new BatchPreviewDialogViewModel(CreateTestDiffs(1), _dialogMock.Object);
        var multiple = new BatchPreviewDialogViewModel(CreateTestDiffs(3), _dialogMock.Object);

        Assert.False(single.HasMultipleFiles);
        Assert.True(multiple.HasMultipleFiles);
    }

    [Fact]
    public void CanNavigatePrevious_FalseAtStart()
    {
        var viewModel = new BatchPreviewDialogViewModel(CreateTestDiffs(3), _dialogMock.Object);

        Assert.False(viewModel.CanNavigatePrevious);
        Assert.True(viewModel.CanNavigateNext);
    }

    [Fact]
    public void CanNavigateNext_FalseAtEnd()
    {
        var viewModel = new BatchPreviewDialogViewModel(CreateTestDiffs(3), _dialogMock.Object);
        viewModel.GoToFileCommand.Execute(2);

        Assert.True(viewModel.CanNavigatePrevious);
        Assert.False(viewModel.CanNavigateNext);
    }

    private List<DiffResult> CreateTestDiffs(int count)
    {
        var diffs = new List<DiffResult>();
        for (int i = 0; i < count; i++)
        {
            diffs.Add(CreateDiffResult($"file{i + 1}.cs"));
        }
        return diffs;
    }

    private DiffResult CreateDiffResult(
        string path,
        bool isNewFile = true,
        int addedLines = 10,
        int removedLines = 0)
    {
        return new DiffResult
        {
            Id = Guid.NewGuid(),
            OriginalFilePath = path,
            IsNewFile = isNewFile,
            Stats = new DiffStats
            {
                AddedLines = addedLines,
                RemovedLines = removedLines
            },
            Hunks = new List<DiffHunk>()
        };
    }
}
```

### DiffPreviewViewModel Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/ViewModels/DiffPreviewViewModelTests.cs
using Xunit;
using SeniorIntern.Core.Models;
using SeniorIntern.Desktop.ViewModels;

namespace SeniorIntern.Desktop.Tests.ViewModels;

public class DiffPreviewViewModelTests
{
    [Fact]
    public void FileName_ExtractsFromPath()
    {
        var diff = CreateDiffResult("src/Services/UserService.cs");

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal("UserService.cs", viewModel.FileName);
    }

    [Fact]
    public void FilePath_ReturnsFullPath()
    {
        var diff = CreateDiffResult("src/Services/UserService.cs");

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal("src/Services/UserService.cs", viewModel.FilePath);
    }

    [Fact]
    public void IsNewFile_ReflectsDiffResult()
    {
        var newFile = new DiffPreviewViewModel(CreateDiffResult("new.cs", isNewFile: true));
        var existingFile = new DiffPreviewViewModel(CreateDiffResult("existing.cs", isNewFile: false));

        Assert.True(newFile.IsNewFile);
        Assert.False(existingFile.IsNewFile);
    }

    [Fact]
    public void AddedLines_ReturnsFromStats()
    {
        var diff = CreateDiffResult("file.cs", addedLines: 25, removedLines: 5);

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal(25, viewModel.AddedLines);
        Assert.Equal(5, viewModel.RemovedLines);
    }

    [Fact]
    public void NetChange_CalculatesCorrectly()
    {
        var diff = CreateDiffResult("file.cs", addedLines: 25, removedLines: 10);

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal(15, viewModel.NetChange);
    }

    [Theory]
    [InlineData("file.cs", "CSharpIcon")]
    [InlineData("file.ts", "TypeScriptIcon")]
    [InlineData("file.tsx", "TypeScriptIcon")]
    [InlineData("file.js", "JavaScriptIcon")]
    [InlineData("file.py", "PythonIcon")]
    [InlineData("file.json", "JsonIcon")]
    [InlineData("file.md", "MarkdownIcon")]
    [InlineData("file.unknown", "FileIcon")]
    public void FileIcon_ReturnsCorrectIcon(string fileName, string expectedIcon)
    {
        var diff = CreateDiffResult(fileName);

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal(expectedIcon, viewModel.FileIcon);
    }

    [Fact]
    public void DisplayName_TruncatesLongNames()
    {
        var diff = CreateDiffResult("ThisIsAVeryLongFileNameThatShouldBeTruncated.cs");

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.True(viewModel.DisplayName.Length <= 20);
        Assert.EndsWith("...", viewModel.DisplayName);
    }

    [Fact]
    public void DisplayName_KeepsShortNames()
    {
        var diff = CreateDiffResult("Short.cs");

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal("Short.cs", viewModel.DisplayName);
    }

    [Fact]
    public void ChangesSummary_NewFile_ShowsOnlyAdded()
    {
        var diff = CreateDiffResult("file.cs", isNewFile: true, addedLines: 50);

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal("+50", viewModel.ChangesSummary);
    }

    [Fact]
    public void ChangesSummary_ModifiedFile_ShowsBoth()
    {
        var diff = CreateDiffResult("file.cs", isNewFile: false, addedLines: 10, removedLines: 5);

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.Equal("+10 -5", viewModel.ChangesSummary);
    }

    [Fact]
    public void DiffViewModel_IsInitialized()
    {
        var diff = CreateDiffResult("file.cs");

        var viewModel = new DiffPreviewViewModel(diff);

        Assert.NotNull(viewModel.DiffViewModel);
    }

    private DiffResult CreateDiffResult(
        string path,
        bool isNewFile = true,
        int addedLines = 10,
        int removedLines = 0)
    {
        return new DiffResult
        {
            Id = Guid.NewGuid(),
            OriginalFilePath = path,
            IsNewFile = isNewFile,
            Stats = new DiffStats
            {
                AddedLines = addedLines,
                RemovedLines = removedLines
            },
            Hunks = new List<DiffHunk>()
        };
    }
}
```

### Converter Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/Converters/IncrementConverterTests.cs
using System.Globalization;
using Xunit;
using SeniorIntern.Desktop.Converters;

namespace SeniorIntern.Desktop.Tests.Converters;

public class IncrementConverterTests
{
    private readonly IncrementConverter _converter = new();

    [Theory]
    [InlineData(0, 1)]
    [InlineData(5, 6)]
    [InlineData(-1, 0)]
    public void Convert_IncrementsInteger(int input, int expected)
    {
        var result = _converter.Convert(input, typeof(int), null, CultureInfo.InvariantCulture);

        Assert.Equal(expected, result);
    }

    [Fact]
    public void Convert_NonInteger_ReturnsValue()
    {
        var result = _converter.Convert("test", typeof(int), null, CultureInfo.InvariantCulture);

        Assert.Equal("test", result);
    }

    [Fact]
    public void Convert_WithParameter_UsesParameterAmount()
    {
        var result = _converter.Convert(5, typeof(int), 10, CultureInfo.InvariantCulture);

        Assert.Equal(15, result);
    }

    [Fact]
    public void ConvertBack_DecrementsInteger()
    {
        var result = _converter.ConvertBack(5, typeof(int), null, CultureInfo.InvariantCulture);

        Assert.Equal(4, result);
    }
}

// tests/SeniorIntern.Desktop.Tests/Converters/ReferenceEqualsConverterTests.cs
public class ReferenceEqualsConverterTests
{
    private readonly ReferenceEqualsConverter _converter = new();

    [Fact]
    public void Convert_SameReference_ReturnsTrue()
    {
        var obj = new object();

        var result = _converter.Convert(obj, typeof(bool), obj, CultureInfo.InvariantCulture);

        Assert.True((bool)result!);
    }

    [Fact]
    public void Convert_DifferentReference_ReturnsFalse()
    {
        var obj1 = new object();
        var obj2 = new object();

        var result = _converter.Convert(obj1, typeof(bool), obj2, CultureInfo.InvariantCulture);

        Assert.False((bool)result!);
    }

    [Fact]
    public void Convert_BothNull_ReturnsTrue()
    {
        var result = _converter.Convert(null, typeof(bool), null, CultureInfo.InvariantCulture);

        Assert.True((bool)result!);
    }

    [Fact]
    public void ConvertBack_ThrowsNotSupportedException()
    {
        Assert.Throws<NotSupportedException>(() =>
            _converter.ConvertBack(true, typeof(object), null, CultureInfo.InvariantCulture));
    }
}
```

---

## Acceptance Criteria

### BatchPreviewDialog

- [ ] Dialog opens centered over parent window
- [ ] Dialog shows correct title "Preview All Changes"
- [ ] Dialog is resizable with min/max constraints
- [ ] Summary shows total files, new files, modified files
- [ ] Summary shows total added/removed lines for modified files
- [ ] File tabs display for all files in batch
- [ ] File tabs scroll horizontally when overflow
- [ ] File tabs show file name, icon, and status
- [ ] File tabs show "NEW" badge for new files
- [ ] File tabs show +/- stats for modified files
- [ ] Selected tab has visual indicator
- [ ] Clicking tab selects that file
- [ ] Diff viewer shows selected file's diff
- [ ] Empty state shown when no selection
- [ ] Previous/Next buttons navigate between files
- [ ] Navigation buttons disabled at boundaries
- [ ] "File X of Y" text updates correctly
- [ ] Cancel button closes dialog with false
- [ ] Create All Files button closes dialog with true
- [ ] Escape key cancels dialog
- [ ] Enter key confirms dialog

### Keyboard Navigation

- [ ] Left Arrow goes to previous file
- [ ] Right Arrow goes to next file
- [ ] Ctrl+PageUp goes to previous file
- [ ] Ctrl+PageDown goes to next file
- [ ] Home goes to first file
- [ ] End goes to last file
- [ ] Number keys 1-9 go to that file index
- [ ] Escape closes dialog (cancel)
- [ ] Enter confirms dialog (apply)

### DiffPreviewViewModel

- [ ] FileName extracts name from path
- [ ] FilePath returns full path
- [ ] IsNewFile reflects DiffResult
- [ ] AddedLines/RemovedLines from stats
- [ ] NetChange calculates correctly
- [ ] FileIcon returns correct icon for extension
- [ ] DisplayName truncates long names
- [ ] ChangesSummary formats correctly
- [ ] DiffViewModel is initialized and loaded

### Converters

- [ ] IncrementConverter adds 1 by default
- [ ] IncrementConverter respects parameter
- [ ] IncrementConverter handles non-integers
- [ ] ReferenceEqualsConverter returns true for same reference
- [ ] ReferenceEqualsConverter returns false for different references

---

## Design Decisions

### Decision 1: Modal Dialog vs Inline Expansion

**Context:** Preview could be shown in a modal dialog or expanded inline within the proposal panel.

**Options:**
1. Modal dialog (full-screen-ish overlay)
2. Inline expansion within proposal panel
3. Slide-out panel

**Decision:** Option 1 - Modal dialog

**Rationale:**
- Provides dedicated space for diff review
- Doesn't disrupt chat flow
- Allows larger diff viewing area
- Standard pattern for preview/confirmation workflows
- Can be dismissed easily

### Decision 2: Tab-based vs List-based File Navigation

**Context:** Need to navigate between multiple file diffs.

**Options:**
1. Horizontal tabs (like browser tabs)
2. Vertical file list sidebar
3. Dropdown selector

**Decision:** Option 1 - Horizontal tabs

**Rationale:**
- Familiar pattern from code editors
- Shows all files at a glance
- Visual indication of new vs modified
- Supports keyboard navigation
- Scrollable for large batches

### Decision 3: Separate DiffPreviewViewModel

**Context:** Could reuse DiffViewerViewModel directly or create wrapper.

**Options:**
1. Use DiffViewerViewModel directly
2. Create DiffPreviewViewModel wrapper

**Decision:** Option 2 - Create DiffPreviewViewModel wrapper

**Rationale:**
- Additional computed properties needed (FileIcon, DisplayName, ChangesSummary)
- Cleaner separation between dialog concerns and diff viewing
- Tab-specific display logic isolated
- Easier to add batch-specific features later

### Decision 4: Dialog Result Pattern

**Context:** Need to communicate user action back to caller.

**Options:**
1. Event-based notification
2. Dialog result (bool)
3. Custom result object

**Decision:** Option 2 - Dialog result (bool)

**Rationale:**
- Simple binary outcome (apply or cancel)
- Standard Avalonia dialog pattern
- Easy to await in calling code
- Additional details not needed (caller has DiffResults)

---

## Accessibility Considerations

### Keyboard Navigation

| Key | Action |
|-----|--------|
| Tab | Move focus between controls |
| Left/Right | Navigate between files |
| Ctrl+PageUp/Down | Navigate between files |
| Home/End | First/last file |
| 1-9 | Go to file by number |
| Enter | Confirm (Create All Files) |
| Escape | Cancel |
| Space | Activate focused button |

### Screen Reader Support

- Dialog announces title on open
- File tabs announce name, type (new/modified), and stats
- Selection changes announced
- Navigation position announced ("File 2 of 5")
- Diff content readable via DiffViewerPanel accessibility

### Visual Accessibility

- Sufficient contrast for all text
- Color not sole indicator (badges + text)
- Focus indicators visible
- Tab selection clearly indicated
- Hover states distinct from selected

---

## Performance Considerations

### Lazy Loading

- DiffViewerViewModel created per preview but not all loaded at once
- Syntax highlighting applied on-demand when file selected
- Large diffs virtualized in DiffViewerPanel

### Memory Management

- DiffResults kept as references, not duplicated
- DiffViewerViewModels cleaned up on dialog close
- Tab scroll position preserved during navigation

### Responsiveness

- Dialog opens quickly with minimal initialization
- File switching is instant (ViewModels pre-created)
- Diff rendering doesn't block UI thread

---

## Future Enhancements

### Potential Improvements

1. **Search in Preview** - Find text across all files
2. **Individual File Toggle** - Exclude specific files from apply
3. **Unified Diff View** - Single scrollable view of all changes
4. **Export Preview** - Save diff summary to file
5. **Split View** - Side-by-side file comparison
6. **Syntax Highlighting in Tabs** - Color-coded by language
7. **File Grouping** - Group by directory in tabs
8. **Thumbnail Preview** - Mini diff preview on hover
9. **Keyboard File Switching** - Alt+1-9 for quick access
10. **Remember Size** - Persist dialog size between sessions

---

## Dependencies

### Internal Dependencies

| Component | Version | Purpose |
|-----------|---------|---------|
| v0.4.2a Diff Models | v0.4.2 | DiffResult, DiffStats, DiffHunk |
| v0.4.2d Diff ViewModels | v0.4.2 | DiffViewerViewModel |
| v0.4.2e Side-by-Side View | v0.4.2 | DiffViewerPanel |
| v0.4.4c Proposal Service | v0.4.4 | PreviewProposalAsync |
| v0.4.4e Proposal Panel | v0.4.4 | Preview button trigger |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Avalonia | 11.x | Window, controls |
| CommunityToolkit.Mvvm | 8.x | ObservableProperty, RelayCommand |

---

## Glossary

| Term | Definition |
|------|------------|
| Batch Preview | Modal dialog showing all file diffs before apply |
| File Tab | Clickable tab representing a single file in the batch |
| Diff Preview | ViewModel wrapping DiffResult with display properties |
| Increment Converter | Converts 0-based index to 1-based for display |
| Reference Equals | Compares objects by reference for selection state |
