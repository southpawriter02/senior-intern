# v0.4.5e: Snippet Options UI - Design Specification

**Status**: _PLANNED_

## Executive Summary

This specification details the **Snippet Options UI** for The Senior Intern, providing a user-friendly popup interface for configuring how code snippets are applied to files. The UI enables users to select insert modes (replace, insert before/after, append, prepend), specify line ranges, preview changes with live diff computation, and leverage AI-suggested insertion locations.

### Key Deliverables

| Component | Type | Purpose |
|-----------|------|---------|
| `SnippetApplyOptionsViewModel` | ViewModel | Manages state and logic for options popup |
| `SnippetApplyOptionsPopup` | View | AXAML popup for snippet configuration |
| `InsertModeDescriptor` | Record | Display metadata for insert modes |
| `EnumToBoolConverter` | Converter | Two-way binding for RadioButton groups |
| `LineRangeInputControl` | UserControl | Reusable line range input component |
| `SnippetPreviewPanel` | UserControl | Preview stats and warnings display |

---

## Feature Overview

```
v0.4.5e: Snippet Options UI
├── ViewModel Layer
│   └── SnippetApplyOptionsViewModel
│       ├── Observable Properties
│       │   ├── FilePath (string)
│       │   ├── SnippetContent (string)
│       │   ├── InsertMode (SnippetInsertMode)
│       │   ├── TargetLine (int, for Before/After)
│       │   ├── StartLine (int, for Replace range)
│       │   ├── EndLine (int, for Replace range)
│       │   ├── PreserveIndentation (bool)
│       │   ├── AddBlankLineBefore (bool)
│       │   ├── AddBlankLineAfter (bool)
│       │   ├── Preview (SnippetApplyPreview?)
│       │   ├── IsPreviewLoading (bool)
│       │   ├── ErrorMessage (string?)
│       │   ├── Suggestion (SnippetLocationSuggestion?)
│       │   ├── TotalLines (int)
│       │   ├── FileContent (string?)
│       │   └── DetectedIndentation (IndentationStyle?)
│       ├── Computed Properties
│       │   ├── IsReplaceMode (bool)
│       │   ├── IsInsertMode (bool)
│       │   ├── ShowTargetLine (bool)
│       │   ├── ShowRangeInputs (bool)
│       │   ├── CanApply (bool)
│       │   ├── HasSuggestion (bool)
│       │   ├── SuggestionConfidenceLevel (string)
│       │   └── FileName (string)
│       ├── Commands
│       │   ├── ApplySuggestionCommand
│       │   ├── RefreshPreviewCommand
│       │   ├── ApplyCommand
│       │   ├── CancelCommand
│       │   └── OpenFileCommand
│       └── Methods
│           ├── InitializeAsync
│           ├── BuildOptions (private)
│           └── Debounced preview refresh
├── View Layer
│   ├── SnippetApplyOptionsPopup.axaml
│   │   ├── Header Section
│   │   │   ├── Title
│   │   │   ├── File path display
│   │   │   └── File info (lines, size)
│   │   ├── Suggestion Banner
│   │   │   ├── Confidence indicator
│   │   │   ├── Reason text
│   │   │   └── "Use Suggestion" button
│   │   ├── Insert Mode Section
│   │   │   ├── RadioButton group (6 modes)
│   │   │   ├── Line range inputs (conditional)
│   │   │   └── Target line input (conditional)
│   │   ├── Options Section
│   │   │   ├── Preserve indentation checkbox
│   │   │   ├── Add blank line before checkbox
│   │   │   ├── Add blank line after checkbox
│   │   │   └── Indentation style display
│   │   ├── Preview Section
│   │   │   ├── Loading spinner
│   │   │   ├── Line stats (+/- display)
│   │   │   ├── Warnings list
│   │   │   └── Preview diff link
│   │   └── Actions Section
│   │       ├── Cancel button
│   │       ├── Preview Diff button
│   │       └── Apply button (accent)
│   └── SnippetApplyOptionsPopup.axaml.cs
│       └── Code-behind with popup management
├── Reusable Controls
│   ├── LineRangeInputControl
│   │   ├── Properties
│   │   │   ├── StartLine (int)
│   │   │   ├── EndLine (int)
│   │   │   ├── MinLine (int, default 1)
│   │   │   ├── MaxLine (int)
│   │   │   └── IsEnabled (bool)
│   │   └── Validation
│   │       ├── Start <= End
│   │       └── Within Min/Max bounds
│   └── SnippetPreviewPanel
│       ├── Properties
│       │   ├── Preview (SnippetApplyPreview)
│       │   └── IsLoading (bool)
│       └── Display
│           ├── +N / -M lines
│           ├── Net change
│           └── Warnings with icons
├── Value Converters
│   ├── EnumToBoolConverter
│   │   └── Bidirectional enum-RadioButton binding
│   ├── ConfidenceToColorConverter
│   │   └── Suggestion confidence → color
│   ├── InsertModeToDescriptionConverter
│   │   └── Mode → human-readable description
│   └── LineCountToVisibilityConverter
│       └── Show/hide based on file having lines
└── Styling
    ├── popup-container (Border class)
    ├── info-banner (suggestion banner style)
    ├── preview-container (preview section style)
    ├── line-stats (stats display style)
    └── warning-text (warning message style)
```

---

## Architecture

### Component Interaction Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        Code Block Quick Action                            │
│                         "Apply with Options..."                           │
└─────────────────────────────────┬────────────────────────────────────────┘
                                  │ Opens popup with file path & snippet
                                  ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                     SnippetApplyOptionsPopup                             │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                SnippetApplyOptionsViewModel                        │  │
│  │                                                                    │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │  │
│  │  │ InsertMode   │  │  LineRange   │  │   Preview State          │ │  │
│  │  │ Selection    │  │  Inputs      │  │   + Loading + Errors     │ │  │
│  │  └──────┬───────┘  └──────┬───────┘  └────────────┬─────────────┘ │  │
│  │         │                 │                        │               │  │
│  │         └─────────────────┼────────────────────────┘               │  │
│  │                           │ BuildOptions()                         │  │
│  │                           ▼                                        │  │
│  │         ┌─────────────────────────────────────┐                   │  │
│  │         │         SnippetApplyOptions         │                   │  │
│  │         │  (InsertMode, Range, Indentation)   │                   │  │
│  │         └─────────────────┬───────────────────┘                   │  │
│  │                           │                                        │  │
│  └───────────────────────────┼────────────────────────────────────────┘  │
│                              │                                           │
└──────────────────────────────┼───────────────────────────────────────────┘
                               │
          ┌────────────────────┼────────────────────┐
          │                    │                    │
          ▼                    ▼                    ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│ISnippetApplyService│ │ISnippetApplyService│ │ISnippetApplyService│
│PreviewSnippetAsync│ │SuggestLocationAsync│ │  ApplySnippetAsync │
└────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
         │                     │                     │
         ▼                     ▼                     ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│SnippetApplyPreview│ │SnippetLocation   │  │SnippetApplyResult│
│  + Diff + Stats   │  │   Suggestion    │  │   + BackupPath   │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

### Popup Lifecycle Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Popup Lifecycle                                  │
└─────────────────────────────────────────────────────────────────────────┘

  User clicks "Apply with Options..."
         │
         ▼
  ┌──────────────────┐
  │ Create ViewModel │◄─── Inject ISnippetApplyService, IDiffService
  └────────┬─────────┘
           │
           ▼
  ┌──────────────────┐
  │ InitializeAsync  │
  │ (filePath,       │
  │  snippetContent) │
  └────────┬─────────┘
           │
           ├─────────────────────────────────────────┐
           │                                         │
           ▼                                         ▼
  ┌──────────────────┐                    ┌──────────────────┐
  │ Read file content│                    │SuggestLocationAsync│
  │ Get line count   │                    │ Get AI suggestion │
  └────────┬─────────┘                    └────────┬─────────┘
           │                                       │
           └──────────────┬────────────────────────┘
                          │
                          ▼
  ┌──────────────────────────────────────────┐
  │ If suggestion exists && high confidence: │
  │   → ApplySuggestion() auto-fills inputs │
  └────────────────────────┬─────────────────┘
                           │
                           ▼
  ┌──────────────────┐
  │RefreshPreviewAsync│◄─── Initial preview computation
  └────────┬─────────┘
           │
           ▼
  ┌──────────────────┐
  │ Show Popup       │◄─── User can now interact
  └────────┬─────────┘
           │
  ┌────────┴────────────────────────────────────┐
  │                                             │
  ▼                                             ▼
User changes settings                     User clicks Apply
  │                                             │
  ▼                                             ▼
┌──────────────────┐                    ┌──────────────────┐
│RefreshPreviewAsync│                   │  ApplyAsync()    │
│ (debounced 300ms)│                    │                  │
└──────────────────┘                    └────────┬─────────┘
                                                 │
                                                 ▼
                                        ┌──────────────────┐
                                        │SnippetApplyResult│
                                        │   Success/Fail   │
                                        └────────┬─────────┘
                                                 │
                                                 ▼
                                        ┌──────────────────┐
                                        │  Close Popup     │
                                        │  Return Result   │
                                        └──────────────────┘
```

### Visual Layout Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│  Apply Snippet Options                                      [X] │
│  src/Services/MyService.cs  •  245 lines                        │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ ✨ Suggested: Replace method 'ProcessData' (85% confidence) │ │
│ │    Found matching method signature on line 42               │ │
│ │                                             [Use Suggestion]│ │
│ └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Insert Mode                                                    │
│                                                                 │
│  ○ Replace entire file                                          │
│  ● Replace specific lines                                       │
│      From line: [42  ▾]  to: [58  ▾]                           │
│  ○ Insert after line                                            │
│  ○ Insert before line                                           │
│      Line: [   ▾]                                               │
│  ○ Append to end of file                                        │
│  ○ Prepend to beginning                                         │
├─────────────────────────────────────────────────────────────────┤
│  Options                                                        │
│                                                                 │
│  ☑ Preserve target indentation                                  │
│  ☐ Add blank line before                                        │
│  ☐ Add blank line after                                         │
│                                                                 │
│  Detected: 4 spaces per indent                                  │
├─────────────────────────────────────────────────────────────────┤
│  Preview                                                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  +24 lines  -17 lines  (net +7)                           │  │
│  │                                                           │  │
│  │  ⚠ Replace range extends beyond current method scope     │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                         [Cancel]  [Preview Diff]  [✓ Apply]     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Detailed Design

### 1. SnippetApplyOptionsViewModel

```csharp
// src/SeniorIntern.Desktop/ViewModels/SnippetApplyOptionsViewModel.cs
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using System.Diagnostics;

namespace SeniorIntern.Desktop.ViewModels;

/// <summary>
/// ViewModel for the snippet apply options popup.
/// Manages user selections and coordinates with services for preview and apply.
/// </summary>
public partial class SnippetApplyOptionsViewModel : ViewModelBase
{
    private readonly ISnippetApplyService _snippetApplyService;
    private readonly IDiffService _diffService;
    private readonly IDialogService _dialogService;
    private CancellationTokenSource? _previewCts;
    private readonly Stopwatch _debounceTimer = new();
    private const int DebounceDelayMs = 300;

    #region Observable Properties

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(FileName))]
    private string _filePath = string.Empty;

    [ObservableProperty]
    private string _snippetContent = string.Empty;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(IsReplaceMode))]
    [NotifyPropertyChangedFor(nameof(IsInsertMode))]
    [NotifyPropertyChangedFor(nameof(ShowTargetLine))]
    [NotifyPropertyChangedFor(nameof(ShowRangeInputs))]
    [NotifyPropertyChangedFor(nameof(InsertModeDescription))]
    private SnippetInsertMode _insertMode = SnippetInsertMode.ReplaceFile;

    [ObservableProperty]
    private int _targetLine = 1;

    [ObservableProperty]
    private int _startLine = 1;

    [ObservableProperty]
    private int _endLine = 1;

    [ObservableProperty]
    private bool _preserveIndentation = true;

    [ObservableProperty]
    private bool _addBlankLineBefore;

    [ObservableProperty]
    private bool _addBlankLineAfter;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(CanApply))]
    [NotifyPropertyChangedFor(nameof(HasPreview))]
    private SnippetApplyPreview? _preview;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(CanApply))]
    private bool _isPreviewLoading;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(HasError))]
    private string? _errorMessage;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(HasSuggestion))]
    [NotifyPropertyChangedFor(nameof(SuggestionConfidenceLevel))]
    [NotifyPropertyChangedFor(nameof(SuggestionConfidenceColor))]
    private SnippetLocationSuggestion? _suggestion;

    [ObservableProperty]
    private int _totalLines;

    [ObservableProperty]
    private string? _fileContent;

    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(IndentationDescription))]
    private IndentationStyle? _detectedIndentation;

    [ObservableProperty]
    private bool _isInitializing;

    [ObservableProperty]
    private long _fileSizeBytes;

    #endregion

    #region Computed Properties

    /// <summary>
    /// True if the current mode is Replace (specific line range).
    /// </summary>
    public bool IsReplaceMode => InsertMode == SnippetInsertMode.Replace;

    /// <summary>
    /// True if the current mode requires a target line (InsertBefore/InsertAfter).
    /// </summary>
    public bool IsInsertMode =>
        InsertMode is SnippetInsertMode.InsertBefore or SnippetInsertMode.InsertAfter;

    /// <summary>
    /// Show target line input for InsertBefore/InsertAfter modes.
    /// </summary>
    public bool ShowTargetLine => IsInsertMode;

    /// <summary>
    /// Show line range inputs for Replace mode.
    /// </summary>
    public bool ShowRangeInputs => IsReplaceMode;

    /// <summary>
    /// True if we can apply (have preview and not loading).
    /// </summary>
    public bool CanApply => Preview is not null && !IsPreviewLoading && !HasError;

    /// <summary>
    /// True if a preview is available.
    /// </summary>
    public bool HasPreview => Preview is not null;

    /// <summary>
    /// True if there's an error message.
    /// </summary>
    public bool HasError => !string.IsNullOrEmpty(ErrorMessage);

    /// <summary>
    /// True if a location suggestion is available.
    /// </summary>
    public bool HasSuggestion => Suggestion is not null;

    /// <summary>
    /// Human-readable confidence level for the suggestion.
    /// </summary>
    public string SuggestionConfidenceLevel => Suggestion?.Confidence switch
    {
        >= 0.8 => "High",
        >= 0.5 => "Medium",
        _ => "Low"
    };

    /// <summary>
    /// Color key for the suggestion confidence.
    /// </summary>
    public string SuggestionConfidenceColor => Suggestion?.Confidence switch
    {
        >= 0.8 => "SuccessBrush",
        >= 0.5 => "WarningBrush",
        _ => "TextMuted"
    };

    /// <summary>
    /// File name extracted from path.
    /// </summary>
    public string FileName => Path.GetFileName(FilePath);

    /// <summary>
    /// Human-readable description of detected indentation.
    /// </summary>
    public string IndentationDescription => DetectedIndentation switch
    {
        { UseTabs: true } => "Tabs",
        { SpacesPerIndent: var n } => $"{n} spaces per indent",
        _ => "Unknown"
    };

    /// <summary>
    /// Human-readable description of the current insert mode.
    /// </summary>
    public string InsertModeDescription => InsertMode switch
    {
        SnippetInsertMode.ReplaceFile => "Replace entire file content",
        SnippetInsertMode.Replace => $"Replace lines {StartLine}-{EndLine}",
        SnippetInsertMode.InsertBefore => $"Insert before line {TargetLine}",
        SnippetInsertMode.InsertAfter => $"Insert after line {TargetLine}",
        SnippetInsertMode.Append => "Add to end of file",
        SnippetInsertMode.Prepend => "Add to beginning of file",
        _ => "Unknown mode"
    };

    /// <summary>
    /// Available insert modes with descriptions for the UI.
    /// </summary>
    public IReadOnlyList<InsertModeDescriptor> AvailableInsertModes { get; } = new[]
    {
        new InsertModeDescriptor(
            SnippetInsertMode.ReplaceFile,
            "Replace entire file",
            "Replace all content with the snippet"),
        new InsertModeDescriptor(
            SnippetInsertMode.Replace,
            "Replace specific lines",
            "Replace a range of lines with the snippet"),
        new InsertModeDescriptor(
            SnippetInsertMode.InsertAfter,
            "Insert after line",
            "Insert snippet after a specific line"),
        new InsertModeDescriptor(
            SnippetInsertMode.InsertBefore,
            "Insert before line",
            "Insert snippet before a specific line"),
        new InsertModeDescriptor(
            SnippetInsertMode.Append,
            "Append to end",
            "Add snippet at the end of the file"),
        new InsertModeDescriptor(
            SnippetInsertMode.Prepend,
            "Prepend to beginning",
            "Add snippet at the beginning of the file")
    };

    #endregion

    #region Events

    /// <summary>
    /// Raised when the popup should be closed.
    /// </summary>
    public event EventHandler<SnippetApplyResult?>? RequestClose;

    /// <summary>
    /// Raised when the user wants to see a full diff preview.
    /// </summary>
    public event EventHandler<DiffResult?>? RequestDiffPreview;

    #endregion

    public SnippetApplyOptionsViewModel(
        ISnippetApplyService snippetApplyService,
        IDiffService diffService,
        IDialogService dialogService)
    {
        _snippetApplyService = snippetApplyService ??
            throw new ArgumentNullException(nameof(snippetApplyService));
        _diffService = diffService ??
            throw new ArgumentNullException(nameof(diffService));
        _dialogService = dialogService ??
            throw new ArgumentNullException(nameof(dialogService));
    }

    #region Initialization

    /// <summary>
    /// Initializes the ViewModel with file and snippet information.
    /// Loads file metadata, gets AI suggestion, and computes initial preview.
    /// </summary>
    public async Task InitializeAsync(
        string filePath,
        string snippetContent,
        CancellationToken cancellationToken = default)
    {
        IsInitializing = true;
        ErrorMessage = null;

        try
        {
            FilePath = filePath;
            SnippetContent = snippetContent;

            // Load file info in parallel with getting suggestion
            var fileInfoTask = LoadFileInfoAsync(filePath, cancellationToken);
            var suggestionTask = _snippetApplyService.SuggestLocationAsync(
                filePath, snippetContent, cancellationToken);
            var indentationTask = _snippetApplyService.DetectIndentationAsync(
                filePath, cancellationToken);

            await Task.WhenAll(fileInfoTask, suggestionTask, indentationTask);

            Suggestion = await suggestionTask;
            DetectedIndentation = await indentationTask;

            // Auto-apply high-confidence suggestions
            if (Suggestion is { Confidence: >= 0.7 })
            {
                ApplySuggestion();
            }

            // Compute initial preview
            await RefreshPreviewAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to initialize: {ex.Message}";
        }
        finally
        {
            IsInitializing = false;
        }
    }

    private async Task LoadFileInfoAsync(string filePath, CancellationToken cancellationToken)
    {
        if (File.Exists(filePath))
        {
            var fileInfo = new FileInfo(filePath);
            FileSizeBytes = fileInfo.Length;

            FileContent = await File.ReadAllTextAsync(filePath, cancellationToken);
            TotalLines = FileContent.Split('\n').Length;
            EndLine = TotalLines;
        }
        else
        {
            // New file
            TotalLines = 0;
            EndLine = 0;
            FileContent = null;
            FileSizeBytes = 0;
        }
    }

    #endregion

    #region Commands

    /// <summary>
    /// Applies the current suggestion to the form inputs.
    /// </summary>
    [RelayCommand]
    private void ApplySuggestion()
    {
        if (Suggestion is null) return;

        InsertMode = Suggestion.SuggestedMode;

        if (Suggestion.SuggestedLine.HasValue)
        {
            TargetLine = Suggestion.SuggestedLine.Value;
        }

        if (Suggestion.SuggestedRange.HasValue)
        {
            StartLine = Suggestion.SuggestedRange.Value.StartLine;
            EndLine = Suggestion.SuggestedRange.Value.EndLine;
        }
    }

    /// <summary>
    /// Refreshes the preview with current options.
    /// </summary>
    [RelayCommand]
    private async Task RefreshPreviewAsync()
    {
        // Cancel any pending preview computation
        _previewCts?.Cancel();
        _previewCts = new CancellationTokenSource();
        var token = _previewCts.Token;

        IsPreviewLoading = true;
        ErrorMessage = null;

        try
        {
            var options = BuildOptions();

            if (!options.IsValid)
            {
                ErrorMessage = "Invalid options configuration. Check your line range selections.";
                Preview = null;
                return;
            }

            Preview = await _snippetApplyService.PreviewSnippetAsync(
                FilePath, SnippetContent, options, token);
        }
        catch (OperationCanceledException)
        {
            // Ignore cancellation
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
            Preview = null;
        }
        finally
        {
            if (!token.IsCancellationRequested)
            {
                IsPreviewLoading = false;
            }
        }
    }

    /// <summary>
    /// Applies the snippet with current options.
    /// </summary>
    [RelayCommand(CanExecute = nameof(CanApply))]
    private async Task ApplyAsync()
    {
        var options = BuildOptions();

        if (!options.IsValid)
        {
            ErrorMessage = "Invalid options configuration";
            return;
        }

        try
        {
            IsPreviewLoading = true;
            var result = await _snippetApplyService.ApplySnippetAsync(
                FilePath, SnippetContent, options);

            if (result.IsSuccess)
            {
                RequestClose?.Invoke(this, result);
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "Apply failed";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsPreviewLoading = false;
        }
    }

    /// <summary>
    /// Cancels and closes the popup.
    /// </summary>
    [RelayCommand]
    private void Cancel()
    {
        _previewCts?.Cancel();
        RequestClose?.Invoke(this, null);
    }

    /// <summary>
    /// Opens a full diff preview dialog.
    /// </summary>
    [RelayCommand]
    private void ShowDiffPreview()
    {
        if (Preview?.Diff is not null)
        {
            RequestDiffPreview?.Invoke(this, Preview.Diff);
        }
    }

    /// <summary>
    /// Opens the target file in the default editor.
    /// </summary>
    [RelayCommand]
    private async Task OpenFileAsync()
    {
        try
        {
            await _dialogService.OpenFileInEditorAsync(FilePath);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to open file: {ex.Message}";
        }
    }

    #endregion

    #region Property Change Handlers

    partial void OnInsertModeChanged(SnippetInsertMode value)
    {
        SchedulePreviewRefresh();
    }

    partial void OnTargetLineChanged(int value)
    {
        SchedulePreviewRefresh();
    }

    partial void OnStartLineChanged(int value)
    {
        // Ensure EndLine >= StartLine
        if (EndLine < value)
        {
            EndLine = value;
        }
        SchedulePreviewRefresh();
    }

    partial void OnEndLineChanged(int value)
    {
        // Ensure StartLine <= EndLine
        if (StartLine > value)
        {
            StartLine = value;
        }
        SchedulePreviewRefresh();
    }

    partial void OnPreserveIndentationChanged(bool value)
    {
        SchedulePreviewRefresh();
    }

    partial void OnAddBlankLineBeforeChanged(bool value)
    {
        SchedulePreviewRefresh();
    }

    partial void OnAddBlankLineAfterChanged(bool value)
    {
        SchedulePreviewRefresh();
    }

    private void SchedulePreviewRefresh()
    {
        // Don't refresh during initialization
        if (IsInitializing) return;

        // Simple debouncing
        _ = Task.Run(async () =>
        {
            await Task.Delay(DebounceDelayMs);
            await RefreshPreviewAsync();
        });
    }

    #endregion

    #region Private Methods

    private SnippetApplyOptions BuildOptions() => InsertMode switch
    {
        SnippetInsertMode.ReplaceFile => SnippetApplyOptions.FullReplace with
        {
            PreserveIndentation = PreserveIndentation,
            AddBlankLineBefore = AddBlankLineBefore,
            AddBlankLineAfter = AddBlankLineAfter
        },

        SnippetInsertMode.Replace => SnippetApplyOptions.ReplaceLines(StartLine, EndLine) with
        {
            PreserveIndentation = PreserveIndentation,
            AddBlankLineBefore = AddBlankLineBefore,
            AddBlankLineAfter = AddBlankLineAfter
        },

        SnippetInsertMode.InsertBefore => SnippetApplyOptions.InsertBeforeLine(TargetLine) with
        {
            PreserveIndentation = PreserveIndentation,
            AddBlankLineBefore = AddBlankLineBefore,
            AddBlankLineAfter = AddBlankLineAfter
        },

        SnippetInsertMode.InsertAfter => SnippetApplyOptions.InsertAfterLine(TargetLine) with
        {
            PreserveIndentation = PreserveIndentation,
            AddBlankLineBefore = AddBlankLineBefore,
            AddBlankLineAfter = AddBlankLineAfter
        },

        SnippetInsertMode.Append => SnippetApplyOptions.AppendToFile with
        {
            PreserveIndentation = PreserveIndentation,
            AddBlankLineBefore = AddBlankLineBefore,
            AddBlankLineAfter = AddBlankLineAfter
        },

        SnippetInsertMode.Prepend => SnippetApplyOptions.PrependToFile with
        {
            PreserveIndentation = PreserveIndentation,
            AddBlankLineBefore = AddBlankLineBefore,
            AddBlankLineAfter = AddBlankLineAfter
        },

        _ => throw new InvalidOperationException($"Unknown insert mode: {InsertMode}")
    };

    #endregion
}
```

### 2. InsertModeDescriptor

```csharp
// src/SeniorIntern.Desktop/ViewModels/InsertModeDescriptor.cs
using SeniorIntern.Core.Models;

namespace SeniorIntern.Desktop.ViewModels;

/// <summary>
/// Describes an insert mode for display in the UI.
/// </summary>
/// <param name="Mode">The insert mode value</param>
/// <param name="Label">Short display label</param>
/// <param name="Description">Longer description for tooltips</param>
public sealed record InsertModeDescriptor(
    SnippetInsertMode Mode,
    string Label,
    string Description);
```

### 3. SnippetApplyOptionsPopup View

```xml
<!-- src/SeniorIntern.Desktop/Views/SnippetApplyOptionsPopup.axaml -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             xmlns:controls="using:SeniorIntern.Desktop.Controls"
             xmlns:converters="using:SeniorIntern.Desktop.Converters"
             x:Class="SeniorIntern.Desktop.Views.SnippetApplyOptionsPopup"
             x:DataType="vm:SnippetApplyOptionsViewModel"
             MinWidth="400"
             MaxWidth="500">

    <UserControl.Resources>
        <converters:EnumToBoolConverter x:Key="EnumToBoolConverter" />
        <converters:ConfidenceToColorConverter x:Key="ConfidenceToColorConverter" />
        <converters:FileSizeConverter x:Key="FileSizeConverter" />
    </UserControl.Resources>

    <Border Classes="popup-container"
            Padding="16"
            CornerRadius="8"
            BoxShadow="0 4 12 0 #40000000">

        <Grid RowDefinitions="Auto, Auto, Auto, Auto, Auto, Auto, Auto">

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Header -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="Apply Snippet Options"
                               FontWeight="SemiBold"
                               FontSize="16" />
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                        <TextBlock Text="{Binding FileName}"
                                   FontSize="13"
                                   FontWeight="Medium"
                                   Foreground="{DynamicResource AccentBrush}" />
                        <TextBlock Text="•"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextMuted}" />
                        <TextBlock FontSize="12"
                                   Foreground="{DynamicResource TextMuted}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} lines">
                                    <Binding Path="TotalLines" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                        <TextBlock Text="•"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextMuted}"
                                   IsVisible="{Binding FileSizeBytes}" />
                        <TextBlock Text="{Binding FileSizeBytes, Converter={StaticResource FileSizeConverter}}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextMuted}"
                                   IsVisible="{Binding FileSizeBytes}" />
                    </StackPanel>
                    <TextBlock Text="{Binding FilePath}"
                               FontSize="11"
                               Foreground="{DynamicResource TextMuted}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding FilePath}"
                               Margin="0,2,0,0" />
                </StackPanel>

                <!-- Open file button -->
                <Button Grid.Column="1"
                        Command="{Binding OpenFileCommand}"
                        ToolTip.Tip="Open file in editor"
                        Classes="icon-button">
                    <PathIcon Data="{StaticResource OpenFileIcon}" Width="16" Height="16" />
                </Button>
            </Grid>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Loading Indicator -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="1"
                    IsVisible="{Binding IsInitializing}"
                    Padding="16"
                    Margin="0,0,0,12">
                <StackPanel HorizontalAlignment="Center" Spacing="8">
                    <ProgressRing IsActive="True" Width="24" Height="24" />
                    <TextBlock Text="Analyzing file..."
                               FontSize="12"
                               Foreground="{DynamicResource TextMuted}" />
                </StackPanel>
            </Border>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Suggestion Banner -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="2"
                    IsVisible="{Binding HasSuggestion}"
                    Classes="info-banner"
                    Padding="12"
                    Margin="0,0,0,12"
                    CornerRadius="6">
                <Grid ColumnDefinitions="Auto, *, Auto">
                    <!-- Confidence indicator -->
                    <Border Grid.Column="0"
                            Width="4"
                            CornerRadius="2"
                            Margin="0,0,12,0"
                            Background="{Binding SuggestionConfidenceColor, Converter={StaticResource BrushConverter}}" />

                    <StackPanel Grid.Column="1">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Suggested Location"
                                       FontWeight="SemiBold"
                                       FontSize="12" />
                            <Border Classes="badge"
                                    Padding="4,1"
                                    CornerRadius="3">
                                <TextBlock Text="{Binding SuggestionConfidenceLevel}"
                                           FontSize="10"
                                           FontWeight="Medium" />
                            </Border>
                        </StackPanel>
                        <TextBlock Text="{Binding Suggestion.Reason}"
                                   FontSize="11"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource TextMuted}"
                                   Margin="0,4,0,0" />
                        <TextBlock Text="{Binding Suggestion.MatchedContext}"
                                   FontSize="10"
                                   FontFamily="Consolas, Menlo, monospace"
                                   Foreground="{DynamicResource TextMuted}"
                                   TextTrimming="CharacterEllipsis"
                                   IsVisible="{Binding Suggestion.MatchedContext, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   Margin="0,4,0,0" />
                    </StackPanel>

                    <Button Grid.Column="2"
                            Content="Use"
                            Command="{Binding ApplySuggestionCommand}"
                            Classes="accent small"
                            VerticalAlignment="Center"
                            Margin="12,0,0,0" />
                </Grid>
            </Border>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Insert Mode Selection -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <StackPanel Grid.Row="3" Spacing="8" Margin="0,0,0,16">
                <TextBlock Text="Insert Mode" FontWeight="SemiBold" FontSize="13" />

                <!-- ReplaceFile -->
                <RadioButton GroupName="InsertMode"
                             IsChecked="{Binding InsertMode,
                                 Converter={StaticResource EnumToBoolConverter},
                                 ConverterParameter=ReplaceFile}">
                    <StackPanel>
                        <TextBlock Text="Replace entire file" />
                        <TextBlock Text="Replace all content with the snippet"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMuted}" />
                    </StackPanel>
                </RadioButton>

                <!-- Replace -->
                <StackPanel Spacing="4">
                    <RadioButton GroupName="InsertMode"
                                 IsChecked="{Binding InsertMode,
                                     Converter={StaticResource EnumToBoolConverter},
                                     ConverterParameter=Replace}">
                        <StackPanel>
                            <TextBlock Text="Replace specific lines" />
                            <TextBlock Text="Replace a range of lines with the snippet"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextMuted}" />
                        </StackPanel>
                    </RadioButton>

                    <!-- Line Range Inputs -->
                    <Grid ColumnDefinitions="Auto, 90, Auto, 90, *"
                          Margin="28,4,0,0"
                          IsVisible="{Binding ShowRangeInputs}">
                        <TextBlock Text="From line:"
                                   VerticalAlignment="Center"
                                   FontSize="12" />
                        <NumericUpDown Grid.Column="1"
                                       Value="{Binding StartLine}"
                                       Minimum="1"
                                       Maximum="{Binding TotalLines}"
                                       FormatString="N0"
                                       Margin="8,0"
                                       Classes="compact" />
                        <TextBlock Grid.Column="2"
                                   Text="to:"
                                   VerticalAlignment="Center"
                                   FontSize="12" />
                        <NumericUpDown Grid.Column="3"
                                       Value="{Binding EndLine}"
                                       Minimum="{Binding StartLine}"
                                       Maximum="{Binding TotalLines}"
                                       FormatString="N0"
                                       Margin="8,0"
                                       Classes="compact" />
                        <TextBlock Grid.Column="4"
                                   VerticalAlignment="Center"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMuted}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="({0} lines)">
                                    <Binding Path="EndLine" />
                                    <Binding Path="StartLine" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </Grid>
                </StackPanel>

                <!-- InsertAfter -->
                <StackPanel Spacing="4">
                    <RadioButton GroupName="InsertMode"
                                 IsChecked="{Binding InsertMode,
                                     Converter={StaticResource EnumToBoolConverter},
                                     ConverterParameter=InsertAfter}">
                        <StackPanel>
                            <TextBlock Text="Insert after line" />
                            <TextBlock Text="Insert snippet after a specific line"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextMuted}" />
                        </StackPanel>
                    </RadioButton>

                    <!-- Target Line Input (shared with InsertBefore) -->
                    <Grid ColumnDefinitions="Auto, 90"
                          Margin="28,4,0,0"
                          IsVisible="{Binding InsertMode,
                              Converter={StaticResource EnumToBoolConverter},
                              ConverterParameter=InsertAfter}">
                        <TextBlock Text="After line:"
                                   VerticalAlignment="Center"
                                   FontSize="12" />
                        <NumericUpDown Grid.Column="1"
                                       Value="{Binding TargetLine}"
                                       Minimum="0"
                                       Maximum="{Binding TotalLines}"
                                       FormatString="N0"
                                       Margin="8,0"
                                       Classes="compact" />
                    </Grid>
                </StackPanel>

                <!-- InsertBefore -->
                <StackPanel Spacing="4">
                    <RadioButton GroupName="InsertMode"
                                 IsChecked="{Binding InsertMode,
                                     Converter={StaticResource EnumToBoolConverter},
                                     ConverterParameter=InsertBefore}">
                        <StackPanel>
                            <TextBlock Text="Insert before line" />
                            <TextBlock Text="Insert snippet before a specific line"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextMuted}" />
                        </StackPanel>
                    </RadioButton>

                    <Grid ColumnDefinitions="Auto, 90"
                          Margin="28,4,0,0"
                          IsVisible="{Binding InsertMode,
                              Converter={StaticResource EnumToBoolConverter},
                              ConverterParameter=InsertBefore}">
                        <TextBlock Text="Before line:"
                                   VerticalAlignment="Center"
                                   FontSize="12" />
                        <NumericUpDown Grid.Column="1"
                                       Value="{Binding TargetLine}"
                                       Minimum="1"
                                       Maximum="{Binding TotalLines, FallbackValue=1}"
                                       FormatString="N0"
                                       Margin="8,0"
                                       Classes="compact" />
                    </Grid>
                </StackPanel>

                <!-- Append -->
                <RadioButton GroupName="InsertMode"
                             IsChecked="{Binding InsertMode,
                                 Converter={StaticResource EnumToBoolConverter},
                                 ConverterParameter=Append}">
                    <StackPanel>
                        <TextBlock Text="Append to end of file" />
                        <TextBlock Text="Add snippet at the end of the file"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMuted}" />
                    </StackPanel>
                </RadioButton>

                <!-- Prepend -->
                <RadioButton GroupName="InsertMode"
                             IsChecked="{Binding InsertMode,
                                 Converter={StaticResource EnumToBoolConverter},
                                 ConverterParameter=Prepend}">
                    <StackPanel>
                        <TextBlock Text="Prepend to beginning" />
                        <TextBlock Text="Add snippet at the beginning of the file"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMuted}" />
                    </StackPanel>
                </RadioButton>
            </StackPanel>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Additional Options -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <StackPanel Grid.Row="4" Spacing="8" Margin="0,0,0,16">
                <TextBlock Text="Options" FontWeight="SemiBold" FontSize="13" />

                <CheckBox IsChecked="{Binding PreserveIndentation}">
                    <StackPanel>
                        <TextBlock Text="Preserve target indentation" />
                        <TextBlock Text="{Binding IndentationDescription, StringFormat='Detected: {0}'}"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMuted}" />
                    </StackPanel>
                </CheckBox>

                <CheckBox Content="Add blank line before snippet"
                          IsChecked="{Binding AddBlankLineBefore}" />

                <CheckBox Content="Add blank line after snippet"
                          IsChecked="{Binding AddBlankLineAfter}" />
            </StackPanel>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Preview Section -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="5"
                    Classes="preview-container"
                    MinHeight="80"
                    Padding="12"
                    Margin="0,0,0,16"
                    CornerRadius="6">
                <Grid>
                    <!-- Loading State -->
                    <StackPanel IsVisible="{Binding IsPreviewLoading}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Spacing="8">
                        <ProgressRing IsActive="True" Width="20" Height="20" />
                        <TextBlock Text="Computing preview..."
                                   FontSize="12"
                                   Foreground="{DynamicResource TextMuted}" />
                    </StackPanel>

                    <!-- Error State -->
                    <StackPanel IsVisible="{Binding HasError}"
                                Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Data="{StaticResource ErrorIcon}"
                                      Width="14" Height="14"
                                      Foreground="{DynamicResource ErrorBrush}" />
                            <TextBlock Text="Error"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource ErrorBrush}" />
                        </StackPanel>
                        <TextBlock Text="{Binding ErrorMessage}"
                                   TextWrapping="Wrap"
                                   FontSize="12"
                                   Foreground="{DynamicResource ErrorBrush}" />
                    </StackPanel>

                    <!-- Preview Stats -->
                    <StackPanel IsVisible="{Binding HasPreview}"
                                Spacing="8">
                        <TextBlock Text="Preview" FontWeight="SemiBold" FontSize="12" />

                        <!-- Line Stats -->
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="+"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource AdditionBrush}" />
                                <TextBlock Text="{Binding Preview.LinesAdded}"
                                           FontWeight="Medium" />
                                <TextBlock Text="lines"
                                           Foreground="{DynamicResource TextMuted}"
                                           FontSize="12" />
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="-"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource DeletionBrush}" />
                                <TextBlock Text="{Binding Preview.LinesRemoved}"
                                           FontWeight="Medium" />
                                <TextBlock Text="lines"
                                           Foreground="{DynamicResource TextMuted}"
                                           FontSize="12" />
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="net"
                                           Foreground="{DynamicResource TextMuted}"
                                           FontSize="12" />
                                <TextBlock FontWeight="Medium">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0:+#;-#;0}">
                                            <Binding Path="Preview.NetLineChange" />
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </StackPanel>
                        </StackPanel>

                        <!-- Affected Range -->
                        <TextBlock FontSize="11"
                                   Foreground="{DynamicResource TextMuted}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="Affects lines {0}-{1}">
                                    <Binding Path="Preview.AffectedRange.StartLine" />
                                    <Binding Path="Preview.AffectedRange.EndLine" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>

                        <!-- Warnings -->
                        <ItemsControl ItemsSource="{Binding Preview.Warnings}"
                                      IsVisible="{Binding Preview.HasWarnings}"
                                      Margin="0,4,0,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,2">
                                        <PathIcon Data="{StaticResource WarningIcon}"
                                                  Width="12" Height="12"
                                                  Foreground="{DynamicResource WarningBrush}" />
                                        <TextBlock Text="{Binding}"
                                                   FontSize="11"
                                                   Foreground="{DynamicResource WarningBrush}"
                                                   TextWrapping="Wrap" />
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- Actions -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Grid Grid.Row="6" ColumnDefinitions="*, Auto, Auto, Auto">
                <!-- Mode description -->
                <TextBlock Text="{Binding InsertModeDescription}"
                           FontSize="11"
                           Foreground="{DynamicResource TextMuted}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis" />

                <Button Grid.Column="1"
                        Content="Cancel"
                        Command="{Binding CancelCommand}"
                        Margin="0,0,8,0" />

                <Button Grid.Column="2"
                        Content="Preview Diff"
                        Command="{Binding ShowDiffPreviewCommand}"
                        IsEnabled="{Binding HasPreview}"
                        Margin="0,0,8,0" />

                <Button Grid.Column="3"
                        Content="Apply"
                        Command="{Binding ApplyCommand}"
                        Classes="accent"
                        IsEnabled="{Binding CanApply}" />
            </Grid>
        </Grid>
    </Border>
</UserControl>
```

### 4. Code-Behind

```csharp
// src/SeniorIntern.Desktop/Views/SnippetApplyOptionsPopup.axaml.cs
using Avalonia.Controls;
using Avalonia.Controls.Primitives;
using SeniorIntern.Desktop.ViewModels;

namespace SeniorIntern.Desktop.Views;

/// <summary>
/// Popup for configuring snippet apply options.
/// </summary>
public partial class SnippetApplyOptionsPopup : UserControl
{
    public SnippetApplyOptionsPopup()
    {
        InitializeComponent();
    }

    protected override void OnDataContextChanged(EventArgs e)
    {
        base.OnDataContextChanged(e);

        if (DataContext is SnippetApplyOptionsViewModel viewModel)
        {
            viewModel.RequestClose += OnRequestClose;
            viewModel.RequestDiffPreview += OnRequestDiffPreview;
        }
    }

    protected override void OnDetachedFromVisualTree(Avalonia.VisualTreeAttachmentEventArgs e)
    {
        base.OnDetachedFromVisualTree(e);

        if (DataContext is SnippetApplyOptionsViewModel viewModel)
        {
            viewModel.RequestClose -= OnRequestClose;
            viewModel.RequestDiffPreview -= OnRequestDiffPreview;
        }
    }

    private void OnRequestClose(object? sender, Core.Models.SnippetApplyResult? result)
    {
        // Find parent popup and close it
        var popup = this.FindAncestorOfType<Popup>();
        if (popup is not null)
        {
            popup.IsOpen = false;
        }
    }

    private void OnRequestDiffPreview(object? sender, Core.Models.DiffResult? diff)
    {
        // This would typically be handled by a parent component
        // that can show a diff dialog
    }
}
```

### 5. EnumToBoolConverter

```csharp
// src/SeniorIntern.Desktop/Converters/EnumToBoolConverter.cs
using Avalonia.Data.Converters;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts between an enum value and a boolean for RadioButton binding.
/// Supports two-way binding.
/// </summary>
public class EnumToBoolConverter : IValueConverter
{
    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is null || parameter is null)
            return false;

        var enumValue = value.ToString();
        var targetValue = parameter.ToString();

        return string.Equals(enumValue, targetValue, StringComparison.Ordinal);
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is bool isChecked && isChecked && parameter is not null)
        {
            return Enum.Parse(targetType, parameter.ToString()!);
        }

        return Avalonia.Data.BindingOperations.DoNothing;
    }
}
```

### 6. ConfidenceToColorConverter

```csharp
// src/SeniorIntern.Desktop/Converters/ConfidenceToColorConverter.cs
using Avalonia.Data.Converters;
using Avalonia.Media;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts a confidence value (0.0-1.0) to a color.
/// High = Green, Medium = Yellow/Orange, Low = Gray.
/// </summary>
public class ConfidenceToColorConverter : IValueConverter
{
    public IBrush HighConfidenceBrush { get; set; } = Brushes.Green;
    public IBrush MediumConfidenceBrush { get; set; } = Brushes.Orange;
    public IBrush LowConfidenceBrush { get; set; } = Brushes.Gray;

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is not double confidence)
            return LowConfidenceBrush;

        return confidence switch
        {
            >= 0.8 => HighConfidenceBrush,
            >= 0.5 => MediumConfidenceBrush,
            _ => LowConfidenceBrush
        };
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        throw new NotSupportedException();
    }
}
```

### 7. FileSizeConverter

```csharp
// src/SeniorIntern.Desktop/Converters/FileSizeConverter.cs
using Avalonia.Data.Converters;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts a file size in bytes to a human-readable string.
/// </summary>
public class FileSizeConverter : IValueConverter
{
    private static readonly string[] SizeSuffixes = { "B", "KB", "MB", "GB", "TB" };

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is not long bytes || bytes <= 0)
            return "0 B";

        var magnitude = (int)Math.Log(bytes, 1024);
        magnitude = Math.Min(magnitude, SizeSuffixes.Length - 1);

        var adjustedSize = bytes / Math.Pow(1024, magnitude);

        return magnitude == 0
            ? $"{adjustedSize:N0} {SizeSuffixes[magnitude]}"
            : $"{adjustedSize:N1} {SizeSuffixes[magnitude]}";
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        throw new NotSupportedException();
    }
}
```

### 8. BrushConverter (Dynamic Resource Helper)

```csharp
// src/SeniorIntern.Desktop/Converters/BrushConverter.cs
using Avalonia;
using Avalonia.Data.Converters;
using Avalonia.Media;
using System.Globalization;

namespace SeniorIntern.Desktop.Converters;

/// <summary>
/// Converts a resource key string to a brush from application resources.
/// </summary>
public class BrushConverter : IValueConverter
{
    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is not string resourceKey)
            return Brushes.Transparent;

        if (Application.Current?.TryFindResource(resourceKey, out var resource) == true
            && resource is IBrush brush)
        {
            return brush;
        }

        return Brushes.Transparent;
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        throw new NotSupportedException();
    }
}
```

### 9. Popup Host Service

```csharp
// src/SeniorIntern.Desktop/Services/PopupHostService.cs
using Avalonia.Controls;
using Avalonia.Controls.Primitives;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Desktop.ViewModels;
using SeniorIntern.Desktop.Views;

namespace SeniorIntern.Desktop.Services;

/// <summary>
/// Service for showing and managing popup dialogs.
/// </summary>
public interface IPopupHostService
{
    /// <summary>
    /// Shows the snippet apply options popup and returns the result.
    /// </summary>
    Task<SnippetApplyResult?> ShowSnippetApplyOptionsAsync(
        Control anchor,
        string filePath,
        string snippetContent,
        CancellationToken cancellationToken = default);
}

public class PopupHostService : IPopupHostService
{
    private readonly ISnippetApplyService _snippetApplyService;
    private readonly IDiffService _diffService;
    private readonly IDialogService _dialogService;

    public PopupHostService(
        ISnippetApplyService snippetApplyService,
        IDiffService diffService,
        IDialogService dialogService)
    {
        _snippetApplyService = snippetApplyService;
        _diffService = diffService;
        _dialogService = dialogService;
    }

    public async Task<SnippetApplyResult?> ShowSnippetApplyOptionsAsync(
        Control anchor,
        string filePath,
        string snippetContent,
        CancellationToken cancellationToken = default)
    {
        var tcs = new TaskCompletionSource<SnippetApplyResult?>();

        // Create ViewModel
        var viewModel = new SnippetApplyOptionsViewModel(
            _snippetApplyService,
            _diffService,
            _dialogService);

        // Create View
        var popup = new Popup
        {
            PlacementTarget = anchor,
            Placement = PlacementMode.Bottom,
            IsLightDismissEnabled = true,
            Child = new SnippetApplyOptionsPopup
            {
                DataContext = viewModel
            }
        };

        // Handle close
        viewModel.RequestClose += (s, result) =>
        {
            popup.IsOpen = false;
            tcs.TrySetResult(result);
        };

        popup.Closed += (s, e) =>
        {
            tcs.TrySetResult(null);
        };

        // Initialize and show
        await viewModel.InitializeAsync(filePath, snippetContent, cancellationToken);
        popup.IsOpen = true;

        return await tcs.Task;
    }
}
```

### 10. Styles

```css
/* src/SeniorIntern.Desktop/Styles/SnippetOptionsPopup.axaml */
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Popup Container -->
    <Style Selector="Border.popup-container">
        <Setter Property="Background" Value="{DynamicResource PopupBackground}" />
        <Setter Property="BorderBrush" Value="{DynamicResource PopupBorder}" />
        <Setter Property="BorderThickness" Value="1" />
    </Style>

    <!-- Info Banner (Suggestion) -->
    <Style Selector="Border.info-banner">
        <Setter Property="Background" Value="{DynamicResource InfoBannerBackground}" />
        <Setter Property="BorderBrush" Value="{DynamicResource InfoBannerBorder}" />
        <Setter Property="BorderThickness" Value="1" />
    </Style>

    <!-- Preview Container -->
    <Style Selector="Border.preview-container">
        <Setter Property="Background" Value="{DynamicResource PreviewBackground}" />
        <Setter Property="BorderBrush" Value="{DynamicResource PreviewBorder}" />
        <Setter Property="BorderThickness" Value="1" />
    </Style>

    <!-- Badge -->
    <Style Selector="Border.badge">
        <Setter Property="Background" Value="{DynamicResource BadgeBackground}" />
    </Style>

    <!-- Compact NumericUpDown -->
    <Style Selector="NumericUpDown.compact">
        <Setter Property="MinWidth" Value="80" />
        <Setter Property="Height" Value="28" />
    </Style>

    <!-- Small Button -->
    <Style Selector="Button.small">
        <Setter Property="Padding" Value="8,4" />
        <Setter Property="FontSize" Value="12" />
    </Style>

    <!-- Icon Button -->
    <Style Selector="Button.icon-button">
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="BorderThickness" Value="0" />
        <Setter Property="Padding" Value="4" />
    </Style>

    <Style Selector="Button.icon-button:pointerover">
        <Setter Property="Background" Value="{DynamicResource ButtonHoverBackground}" />
    </Style>

    <!-- Accent Button -->
    <Style Selector="Button.accent">
        <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
        <Setter Property="Foreground" Value="{DynamicResource AccentForeground}" />
    </Style>

    <Style Selector="Button.accent:pointerover">
        <Setter Property="Background" Value="{DynamicResource AccentHoverBrush}" />
    </Style>

    <Style Selector="Button.accent:disabled">
        <Setter Property="Background" Value="{DynamicResource AccentDisabledBrush}" />
        <Setter Property="Opacity" Value="0.5" />
    </Style>

</Styles>
```

---

## Unit Tests

### SnippetApplyOptionsViewModel Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/ViewModels/SnippetApplyOptionsViewModelTests.cs
using Moq;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Desktop.ViewModels;
using Xunit;

namespace SeniorIntern.Desktop.Tests.ViewModels;

public class SnippetApplyOptionsViewModelTests : IDisposable
{
    private readonly Mock<ISnippetApplyService> _mockSnippetService;
    private readonly Mock<IDiffService> _mockDiffService;
    private readonly Mock<IDialogService> _mockDialogService;
    private readonly SnippetApplyOptionsViewModel _viewModel;
    private readonly string _testDirectory;

    public SnippetApplyOptionsViewModelTests()
    {
        _mockSnippetService = new Mock<ISnippetApplyService>();
        _mockDiffService = new Mock<IDiffService>();
        _mockDialogService = new Mock<IDialogService>();

        _viewModel = new SnippetApplyOptionsViewModel(
            _mockSnippetService.Object,
            _mockDiffService.Object,
            _mockDialogService.Object);

        _testDirectory = Path.Combine(Path.GetTempPath(), $"SnippetOptionsTests_{Guid.NewGuid():N}");
        Directory.CreateDirectory(_testDirectory);

        SetupDefaultMocks();
    }

    private void SetupDefaultMocks()
    {
        _mockSnippetService
            .Setup(x => x.PreviewSnippetAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<SnippetApplyOptions>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync(new SnippetApplyPreview
            {
                ResultContent = "result",
                Diff = DiffResult.Empty("test.cs"),
                AffectedRange = new LineRange(1, 10),
                LinesAdded = 10,
                LinesRemoved = 5
            });

        _mockSnippetService
            .Setup(x => x.SuggestLocationAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync((SnippetLocationSuggestion?)null);

        _mockSnippetService
            .Setup(x => x.DetectIndentationAsync(
                It.IsAny<string>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync(IndentationStyle.Default);
    }

    public void Dispose()
    {
        if (Directory.Exists(_testDirectory))
        {
            Directory.Delete(_testDirectory, recursive: true);
        }
    }

    #region Initialization Tests

    [Fact]
    public async Task InitializeAsync_LoadsFileInfo()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "test.cs");
        File.WriteAllText(filePath, "line1\nline2\nline3\nline4\nline5");

        // Act
        await _viewModel.InitializeAsync(filePath, "snippet content");

        // Assert
        Assert.Equal(filePath, _viewModel.FilePath);
        Assert.Equal("snippet content", _viewModel.SnippetContent);
        Assert.Equal(5, _viewModel.TotalLines);
        Assert.Equal("test.cs", _viewModel.FileName);
    }

    [Fact]
    public async Task InitializeAsync_NewFile_SetsTotalLinesToZero()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "new_file.cs");

        // Act
        await _viewModel.InitializeAsync(filePath, "snippet content");

        // Assert
        Assert.Equal(0, _viewModel.TotalLines);
    }

    [Fact]
    public async Task InitializeAsync_WithSuggestion_AppliesHighConfidenceSuggestion()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "suggest.cs");
        File.WriteAllText(filePath, "line1\nline2\nline3");

        _mockSnippetService
            .Setup(x => x.SuggestLocationAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync(new SnippetLocationSuggestion
            {
                SuggestedMode = SnippetInsertMode.InsertAfter,
                SuggestedLine = 2,
                Confidence = 0.85,
                Reason = "Found method"
            });

        // Act
        await _viewModel.InitializeAsync(filePath, "snippet");

        // Assert
        Assert.Equal(SnippetInsertMode.InsertAfter, _viewModel.InsertMode);
        Assert.Equal(2, _viewModel.TargetLine);
    }

    [Fact]
    public async Task InitializeAsync_WithLowConfidenceSuggestion_DoesNotAutoApply()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "low_confidence.cs");
        File.WriteAllText(filePath, "content");

        _mockSnippetService
            .Setup(x => x.SuggestLocationAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync(new SnippetLocationSuggestion
            {
                SuggestedMode = SnippetInsertMode.InsertAfter,
                SuggestedLine = 5,
                Confidence = 0.3,
                Reason = "Low confidence"
            });

        // Act
        await _viewModel.InitializeAsync(filePath, "snippet");

        // Assert
        Assert.Equal(SnippetInsertMode.ReplaceFile, _viewModel.InsertMode); // Default
    }

    #endregion

    #region Insert Mode Tests

    [Theory]
    [InlineData(SnippetInsertMode.ReplaceFile, false, false)]
    [InlineData(SnippetInsertMode.Replace, true, false)]
    [InlineData(SnippetInsertMode.InsertBefore, false, true)]
    [InlineData(SnippetInsertMode.InsertAfter, false, true)]
    [InlineData(SnippetInsertMode.Append, false, false)]
    [InlineData(SnippetInsertMode.Prepend, false, false)]
    public void InsertMode_UpdatesVisibilityProperties(
        SnippetInsertMode mode,
        bool expectShowRange,
        bool expectShowTarget)
    {
        // Act
        _viewModel.InsertMode = mode;

        // Assert
        Assert.Equal(expectShowRange, _viewModel.ShowRangeInputs);
        Assert.Equal(expectShowTarget, _viewModel.ShowTargetLine);
    }

    [Fact]
    public void IsReplaceMode_TrueOnlyForReplace()
    {
        // Act & Assert
        _viewModel.InsertMode = SnippetInsertMode.Replace;
        Assert.True(_viewModel.IsReplaceMode);

        _viewModel.InsertMode = SnippetInsertMode.ReplaceFile;
        Assert.False(_viewModel.IsReplaceMode);
    }

    [Fact]
    public void IsInsertMode_TrueForBeforeAndAfter()
    {
        // Act & Assert
        _viewModel.InsertMode = SnippetInsertMode.InsertBefore;
        Assert.True(_viewModel.IsInsertMode);

        _viewModel.InsertMode = SnippetInsertMode.InsertAfter;
        Assert.True(_viewModel.IsInsertMode);

        _viewModel.InsertMode = SnippetInsertMode.Append;
        Assert.False(_viewModel.IsInsertMode);
    }

    #endregion

    #region Line Range Validation Tests

    [Fact]
    public void StartLineChange_EnsuresEndLineIsValid()
    {
        // Arrange
        _viewModel.StartLine = 5;
        _viewModel.EndLine = 10;

        // Act
        _viewModel.StartLine = 15;

        // Assert
        Assert.Equal(15, _viewModel.EndLine);
    }

    [Fact]
    public void EndLineChange_EnsuresStartLineIsValid()
    {
        // Arrange
        _viewModel.StartLine = 10;
        _viewModel.EndLine = 20;

        // Act
        _viewModel.EndLine = 5;

        // Assert
        Assert.Equal(5, _viewModel.StartLine);
    }

    #endregion

    #region Preview Tests

    [Fact]
    public async Task RefreshPreviewAsync_UpdatesPreviewProperty()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "preview.cs");
        File.WriteAllText(filePath, "content");
        await _viewModel.InitializeAsync(filePath, "snippet");

        // Act
        await _viewModel.RefreshPreviewCommand.ExecuteAsync(null);

        // Assert
        Assert.NotNull(_viewModel.Preview);
        Assert.Equal(10, _viewModel.Preview.LinesAdded);
        Assert.Equal(5, _viewModel.Preview.LinesRemoved);
    }

    [Fact]
    public async Task RefreshPreviewAsync_SetsErrorOnFailure()
    {
        // Arrange
        _mockSnippetService
            .Setup(x => x.PreviewSnippetAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<SnippetApplyOptions>(),
                It.IsAny<CancellationToken>()))
            .ThrowsAsync(new Exception("Preview failed"));

        var filePath = Path.Combine(_testDirectory, "error.cs");
        File.WriteAllText(filePath, "content");

        // Act
        await _viewModel.InitializeAsync(filePath, "snippet");

        // Assert
        Assert.True(_viewModel.HasError);
        Assert.Contains("Preview failed", _viewModel.ErrorMessage);
    }

    [Fact]
    public async Task CanApply_FalseWhenNoPreview()
    {
        // Arrange
        _viewModel.Preview = null;

        // Assert
        Assert.False(_viewModel.CanApply);
    }

    [Fact]
    public async Task CanApply_FalseWhenLoading()
    {
        // Arrange
        _viewModel.IsPreviewLoading = true;

        // Assert
        Assert.False(_viewModel.CanApply);
    }

    #endregion

    #region Apply Tests

    [Fact]
    public async Task ApplyAsync_CallsServiceAndRaisesEvent()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "apply.cs");
        File.WriteAllText(filePath, "content");
        await _viewModel.InitializeAsync(filePath, "snippet");

        _mockSnippetService
            .Setup(x => x.ApplySnippetAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<SnippetApplyOptions>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync(SnippetApplyResult.Succeeded(filePath, SnippetApplyOptions.FullReplace, null, 10, 10, 0));

        SnippetApplyResult? resultFromEvent = null;
        _viewModel.RequestClose += (s, r) => resultFromEvent = r;

        // Act
        await _viewModel.ApplyCommand.ExecuteAsync(null);

        // Assert
        Assert.NotNull(resultFromEvent);
        Assert.True(resultFromEvent.IsSuccess);
    }

    [Fact]
    public async Task ApplyAsync_SetsErrorOnFailure()
    {
        // Arrange
        var filePath = Path.Combine(_testDirectory, "apply_fail.cs");
        File.WriteAllText(filePath, "content");
        await _viewModel.InitializeAsync(filePath, "snippet");

        _mockSnippetService
            .Setup(x => x.ApplySnippetAsync(
                It.IsAny<string>(),
                It.IsAny<string>(),
                It.IsAny<SnippetApplyOptions>(),
                It.IsAny<CancellationToken>()))
            .ReturnsAsync(SnippetApplyResult.Failed(filePath, "Apply failed"));

        // Act
        await _viewModel.ApplyCommand.ExecuteAsync(null);

        // Assert
        Assert.True(_viewModel.HasError);
        Assert.Contains("Apply failed", _viewModel.ErrorMessage);
    }

    #endregion

    #region Suggestion Tests

    [Fact]
    public void ApplySuggestion_UpdatesInputs()
    {
        // Arrange
        _viewModel.Suggestion = new SnippetLocationSuggestion
        {
            SuggestedMode = SnippetInsertMode.Replace,
            SuggestedRange = new LineRange(10, 20),
            Confidence = 0.9,
            Reason = "Test"
        };

        // Act
        _viewModel.ApplySuggestionCommand.Execute(null);

        // Assert
        Assert.Equal(SnippetInsertMode.Replace, _viewModel.InsertMode);
        Assert.Equal(10, _viewModel.StartLine);
        Assert.Equal(20, _viewModel.EndLine);
    }

    [Theory]
    [InlineData(0.9, "High")]
    [InlineData(0.7, "Medium")]
    [InlineData(0.5, "Medium")]
    [InlineData(0.3, "Low")]
    public void SuggestionConfidenceLevel_ReturnsCorrectLevel(double confidence, string expected)
    {
        // Arrange
        _viewModel.Suggestion = new SnippetLocationSuggestion
        {
            SuggestedMode = SnippetInsertMode.Append,
            Confidence = confidence,
            Reason = "Test"
        };

        // Assert
        Assert.Equal(expected, _viewModel.SuggestionConfidenceLevel);
    }

    #endregion

    #region Cancel Tests

    [Fact]
    public void Cancel_RaisesCloseEventWithNull()
    {
        // Arrange
        SnippetApplyResult? result = new SnippetApplyResult
        {
            IsSuccess = true,
            FilePath = "dummy"
        };

        _viewModel.RequestClose += (s, r) => result = r;

        // Act
        _viewModel.CancelCommand.Execute(null);

        // Assert
        Assert.Null(result);
    }

    #endregion
}
```

### Converter Tests

```csharp
// tests/SeniorIntern.Desktop.Tests/Converters/EnumToBoolConverterTests.cs
using SeniorIntern.Core.Models;
using SeniorIntern.Desktop.Converters;
using System.Globalization;
using Xunit;

namespace SeniorIntern.Desktop.Tests.Converters;

public class EnumToBoolConverterTests
{
    private readonly EnumToBoolConverter _converter = new();

    [Fact]
    public void Convert_MatchingValue_ReturnsTrue()
    {
        // Arrange
        var value = SnippetInsertMode.Replace;
        var parameter = "Replace";

        // Act
        var result = _converter.Convert(value, typeof(bool), parameter, CultureInfo.InvariantCulture);

        // Assert
        Assert.True((bool)result!);
    }

    [Fact]
    public void Convert_NonMatchingValue_ReturnsFalse()
    {
        // Arrange
        var value = SnippetInsertMode.Replace;
        var parameter = "Append";

        // Act
        var result = _converter.Convert(value, typeof(bool), parameter, CultureInfo.InvariantCulture);

        // Assert
        Assert.False((bool)result!);
    }

    [Fact]
    public void ConvertBack_TrueWithParameter_ReturnsEnumValue()
    {
        // Arrange
        var value = true;
        var parameter = "InsertAfter";

        // Act
        var result = _converter.ConvertBack(
            value,
            typeof(SnippetInsertMode),
            parameter,
            CultureInfo.InvariantCulture);

        // Assert
        Assert.Equal(SnippetInsertMode.InsertAfter, result);
    }

    [Fact]
    public void ConvertBack_False_ReturnsDoNothing()
    {
        // Act
        var result = _converter.ConvertBack(
            false,
            typeof(SnippetInsertMode),
            "Replace",
            CultureInfo.InvariantCulture);

        // Assert
        Assert.Equal(Avalonia.Data.BindingOperations.DoNothing, result);
    }
}

// tests/SeniorIntern.Desktop.Tests/Converters/FileSizeConverterTests.cs
namespace SeniorIntern.Desktop.Tests.Converters;

public class FileSizeConverterTests
{
    private readonly FileSizeConverter _converter = new();

    [Theory]
    [InlineData(0L, "0 B")]
    [InlineData(512L, "512 B")]
    [InlineData(1024L, "1.0 KB")]
    [InlineData(1536L, "1.5 KB")]
    [InlineData(1048576L, "1.0 MB")]
    [InlineData(1073741824L, "1.0 GB")]
    public void Convert_VariousSizes_ReturnsCorrectFormat(long bytes, string expected)
    {
        // Act
        var result = _converter.Convert(bytes, typeof(string), null, CultureInfo.InvariantCulture);

        // Assert
        Assert.Equal(expected, result);
    }

    [Fact]
    public void Convert_NegativeValue_ReturnsZero()
    {
        // Act
        var result = _converter.Convert(-100L, typeof(string), null, CultureInfo.InvariantCulture);

        // Assert
        Assert.Equal("0 B", result);
    }
}
```

---

## Files to Create

| File Path | Type | Purpose |
|-----------|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/SnippetApplyOptionsViewModel.cs` | ViewModel | Main ViewModel for options popup |
| `src/SeniorIntern.Desktop/ViewModels/InsertModeDescriptor.cs` | Record | Insert mode display metadata |
| `src/SeniorIntern.Desktop/Views/SnippetApplyOptionsPopup.axaml` | View | Popup XAML layout |
| `src/SeniorIntern.Desktop/Views/SnippetApplyOptionsPopup.axaml.cs` | Code-behind | Popup code-behind |
| `src/SeniorIntern.Desktop/Converters/EnumToBoolConverter.cs` | Converter | Enum-RadioButton binding |
| `src/SeniorIntern.Desktop/Converters/ConfidenceToColorConverter.cs` | Converter | Confidence to color mapping |
| `src/SeniorIntern.Desktop/Converters/FileSizeConverter.cs` | Converter | File size formatting |
| `src/SeniorIntern.Desktop/Converters/BrushConverter.cs` | Converter | Resource key to brush |
| `src/SeniorIntern.Desktop/Services/PopupHostService.cs` | Service | Popup display management |
| `src/SeniorIntern.Desktop/Styles/SnippetOptionsPopup.axaml` | Styles | Popup-specific styles |
| `tests/SeniorIntern.Desktop.Tests/ViewModels/SnippetApplyOptionsViewModelTests.cs` | Tests | ViewModel unit tests |
| `tests/SeniorIntern.Desktop.Tests/Converters/EnumToBoolConverterTests.cs` | Tests | Converter tests |
| `tests/SeniorIntern.Desktop.Tests/Converters/FileSizeConverterTests.cs` | Tests | File size converter tests |

## Files to Modify

| File Path | Changes |
|-----------|---------|
| `src/SeniorIntern.Desktop/App.axaml` | Register converters as resources |
| `src/SeniorIntern.Desktop/App.axaml.cs` | Register `IPopupHostService` in DI |
| `src/SeniorIntern.Desktop/Styles/App.axaml` | Include `SnippetOptionsPopup.axaml` styles |

---

## Dependencies

### Internal Dependencies (from previous v0.4.x specifications)

| Component | Source | Usage |
|-----------|--------|-------|
| `ISnippetApplyService` | v0.4.5d | Preview and apply operations |
| `SnippetApplyOptions` | v0.4.5c | Options configuration |
| `SnippetInsertMode` | v0.4.5c | Insert mode enumeration |
| `LineRange` | v0.4.5c | Line range representation |
| `SnippetApplyPreview` | v0.4.5d | Preview result model |
| `SnippetApplyResult` | v0.4.5d | Apply result model |
| `SnippetLocationSuggestion` | v0.4.5d | AI suggestion model |
| `IndentationStyle` | v0.4.5c | Indentation detection |
| `IDiffService` | v0.4.2 | Diff computation |
| `DiffResult` | v0.4.2 | Diff display |
| `IDialogService` | v0.3.x | File open in editor |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `Avalonia` | 11.x | UI framework |
| `Avalonia.Controls` | 11.x | Control library |
| `CommunityToolkit.Mvvm` | 8.x | MVVM source generators |

---

## Acceptance Criteria

### Functional Requirements

1. **Popup Display**
   - [ ] Popup appears when triggered from code block quick action
   - [ ] Shows file name, path, and line count
   - [ ] Displays file size for existing files
   - [ ] Closes on outside click (light dismiss)

2. **Insert Mode Selection**
   - [ ] All 6 insert modes selectable via RadioButtons
   - [ ] Line range inputs appear only for Replace mode
   - [ ] Target line input appears only for InsertBefore/InsertAfter
   - [ ] Mode descriptions display correctly

3. **Line Range Input**
   - [ ] NumericUpDown controls for line numbers
   - [ ] Minimum 1, maximum = file line count
   - [ ] EndLine >= StartLine validation
   - [ ] StartLine <= EndLine validation

4. **Suggestion Banner**
   - [ ] Shows when suggestion available
   - [ ] Displays confidence level (High/Medium/Low)
   - [ ] Shows reason text
   - [ ] "Use" button applies suggestion
   - [ ] High-confidence suggestions auto-apply on init

5. **Options**
   - [ ] Preserve indentation checkbox (default: checked)
   - [ ] Add blank line before checkbox
   - [ ] Add blank line after checkbox
   - [ ] Shows detected indentation style

6. **Preview**
   - [ ] Computes preview on every option change
   - [ ] Shows +N / -M lines stats
   - [ ] Shows net line change
   - [ ] Displays warnings with icons
   - [ ] Debounces preview computation (300ms)

7. **Actions**
   - [ ] Cancel closes popup without applying
   - [ ] Preview Diff opens diff viewer dialog
   - [ ] Apply button disabled until preview ready
   - [ ] Apply closes popup and returns result

### Non-Functional Requirements

1. **Performance**
   - [ ] Initial load < 500ms for typical files
   - [ ] Preview computation debounced appropriately
   - [ ] No UI freezing during async operations

2. **Accessibility**
   - [ ] All controls keyboard-accessible
   - [ ] Tab order logical
   - [ ] Screen reader compatible labels

3. **Visual Design**
   - [ ] Consistent with app theme (Light/Dark)
   - [ ] Clear visual hierarchy
   - [ ] Appropriate spacing and padding
   - [ ] Error states clearly visible

---

## Design Decisions

### 1. Popup vs Dialog

**Decision**: Use a Popup anchored to the triggering button rather than a modal dialog.

**Rationale**:
- Maintains context - user can still see the code block
- Faster to dismiss (click outside)
- Feels lighter weight for a configuration task
- Can see file in background for reference

**Trade-offs**:
- (+) Quick access, non-blocking
- (+) Maintains spatial context
- (-) Less screen space for content
- (-) Can be dismissed accidentally

### 2. Auto-Apply High-Confidence Suggestions

**Decision**: Automatically apply suggestions with >= 70% confidence.

**Rationale**:
- Reduces clicks for obvious cases
- User can easily change if wrong
- Provides smart defaults
- Saves time for common patterns

**Trade-offs**:
- (+) Faster for common cases
- (+) Demonstrates AI capability
- (-) May surprise users
- (-) Could apply wrong suggestion

### 3. Debounced Preview Refresh

**Decision**: Debounce preview computation with 300ms delay.

**Rationale**:
- Prevents excessive API calls while typing
- Keeps UI responsive
- Balances responsiveness with efficiency
- User doesn't need instant preview while adjusting

**Trade-offs**:
- (+) Reduced computation
- (+) Smoother UI
- (-) Slight delay before seeing preview
- (-) Complexity in implementation

### 4. RadioButton Group for Insert Modes

**Decision**: Use RadioButton group instead of ComboBox for mode selection.

**Rationale**:
- All options visible at once
- Can include descriptions inline
- More touch-friendly
- Easier to add conditional sub-inputs

**Trade-offs**:
- (+) All options visible
- (+) Can show descriptions
- (-) Takes more vertical space
- (-) More complex layout

### 5. Inline Line Inputs vs Separate Section

**Decision**: Show line inputs indented under their parent RadioButton.

**Rationale**:
- Clear visual association with mode
- Only appears when relevant
- Progressive disclosure
- Reduces visual noise

**Trade-offs**:
- (+) Clear context
- (+) Less cluttered when not needed
- (-) Slightly more complex layout
- (-) Content shifts when switching modes

### 6. Confidence Color Coding

**Decision**: Use green/yellow/gray color coding for suggestion confidence.

**Rationale**:
- Universal color associations (traffic light)
- Quick visual assessment
- Helps user decide whether to trust suggestion
- Accessible color choices

**Trade-offs**:
- (+) Intuitive interpretation
- (+) Quick scanning
- (-) Color-blind users may miss nuance
- (-) Cultural differences in color meaning

---

## Future Considerations

### Potential Enhancements

1. **Anchor-Based Mode**
   - Add UI for specifying text anchors
   - Search and highlight matching text
   - Preview anchor resolution

2. **History Integration**
   - Remember last used settings per file type
   - Quick access to recent configurations
   - Persist preferred defaults

3. **Inline Diff Preview**
   - Show actual diff lines in popup
   - Scrollable preview area
   - Syntax highlighting

4. **Keyboard Shortcuts**
   - Quick mode switching (1-6)
   - Apply with Enter
   - Cancel with Escape

5. **File Preview**
   - Show target file content
   - Highlight affected lines
   - Jump to line in editor

6. **Batch Operations**
   - Apply same options to multiple blocks
   - Template configurations
   - Preset management
