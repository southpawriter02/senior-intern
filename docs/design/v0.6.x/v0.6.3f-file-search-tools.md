# Design Specification: AIntern v0.6.3f "File Search Tools"

## Overview

**Version**: v0.6.3f
**Parent**: v0.6.3 Built-in Tools
**Focus**: SearchFilesTool for finding files by glob patterns with intelligent exclusions

### Purpose

Implement file search tools that enable the AI agent to:
1. Find files by name using glob patterns
2. Support recursive directory matching (`**/*.ts`)
3. Exclude common build artifacts by default
4. Support custom exclusion patterns
5. Limit results to prevent overflow
6. Optionally include hidden files
7. Provide fast, indexed-style searching

### Dependencies

**From v0.6.3a (File Read Tools)**:
- `ToolPathHelper` for path validation

**From v0.6.1 (Tool Framework)**:
- `ToolBase`, `ToolResult`
- `JsonSchemaBuilder`, `RiskLevel`

**From v0.3.x (Workspace Awareness)**:
- `IWorkspaceService`, `IFileSystemService`

**External**:
- `Microsoft.Extensions.FileSystemGlobbing` for glob pattern matching

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    v0.6.3f File Search Tools Architecture                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  src/SeniorIntern.Services/Tools/Search/                                     │
│  ├─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  SearchFilesTool : ToolBase                                              │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  Id: "search-files"                                                  ││ │
│  │  │  DefaultRiskLevel: Safe                                              ││ │
│  │  │                                                                      ││ │
│  │  │  Parameters                                                           ││ │
│  │  │  ├── pattern: string (required) - Glob pattern                       ││ │
│  │  │  ├── path: string (default: ".") - Starting directory                ││ │
│  │  │  ├── exclude: string[] (optional) - Custom exclusions                ││ │
│  │  │  ├── max_results: int (default: 100, max: 1000)                      ││ │
│  │  │  └── include_hidden: bool (default: false)                           ││ │
│  │  │                                                                      ││ │
│  │  │  Default Exclusions                                                   ││ │
│  │  │  ├── **/node_modules/**                                              ││ │
│  │  │  ├── **/bin/**                                                       ││ │
│  │  │  ├── **/obj/**                                                       ││ │
│  │  │  ├── **/.git/**                                                      ││ │
│  │  │  ├── **/dist/**                                                      ││ │
│  │  │  ├── **/build/**                                                     ││ │
│  │  │  ├── **/.vs/**                                                       ││ │
│  │  │  └── **/__pycache__/**                                               ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  │  SearchFileResult    SearchFilesResultData                               │ │
│  │  ├── Path: string    ├── Pattern: string                                │ │
│  │  └── Stem: string    ├── Path: string                                   │ │
│  │                      ├── MatchCount: int                                 │ │
│  │                      ├── TotalMatches: int                               │ │
│  │                      └── WasTruncated: bool                              │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  External Dependency: Microsoft.Extensions.FileSystemGlobbing                │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Matcher                                                                 │ │
│  │  ├── AddInclude(pattern) - Add include glob pattern                     │ │
│  │  ├── AddExclude(pattern) - Add exclude glob pattern                     │ │
│  │  └── Execute(directory) - Run match and return results                  │ │
│  │                                                                          │ │
│  │  DirectoryInfoWrapper                                                    │ │
│  │  └── Wraps DirectoryInfo for glob matching                              │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Glob Pattern Examples

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Glob Pattern Reference                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Pattern              Matches                                                │
│  ──────────────────────────────────────────────────────────────────────────  │
│  *.cs                 All C# files in current directory only                 │
│  **/*.cs              All C# files recursively                               │
│  src/**/*.ts          All TypeScript files under src/                        │
│  **/test*.js          All JS files starting with 'test' anywhere             │
│  **/*.{js,ts}         All JavaScript and TypeScript files                    │
│  src/**/index.*       All index.* files under src/                           │
│  [Tt]est*.cs          Test or test files in current dir                      │
│  **/*Controller.cs    All controller files recursively                       │
│                                                                              │
│  Special Characters:                                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  *     - Matches any sequence of characters (except directory sep)     │ │
│  │  **    - Matches any sequence including directories (recursive)        │ │
│  │  ?     - Matches exactly one character                                  │ │
│  │  [abc] - Matches any single character in set                            │ │
│  │  [!abc]- Matches any single character NOT in set                        │ │
│  │  {a,b} - Matches either pattern a or b                                  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Default Exclusions

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Default Exclusion Patterns                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Pattern                 Purpose                                             │
│  ──────────────────────────────────────────────────────────────────────────  │
│  **/node_modules/**      NPM packages (JavaScript/TypeScript)                │
│  **/bin/**               Binary output (.NET, C/C++)                         │
│  **/obj/**               Object files (.NET intermediate)                    │
│  **/.git/**              Git repository data                                 │
│  **/dist/**              Distribution builds (frontend)                      │
│  **/build/**             Build output (various)                              │
│  **/.vs/**               Visual Studio settings                              │
│  **/__pycache__/**       Python bytecode cache                               │
│                                                                              │
│  These patterns are ALWAYS applied to avoid searching large/irrelevant       │
│  directories. Custom exclusions via the 'exclude' parameter are ADDED to    │
│  these defaults.                                                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Execution Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      SearchFilesTool Execution Flow                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ExecuteAsync(context)                                                       │
│      │                                                                       │
│      ▼                                                                       │
│  ┌─────────────────────────────┐                                             │
│  │  1. Extract Parameters      │                                             │
│  │  ├── pattern (required)     │                                             │
│  │  ├── path (default: ".")    │                                             │
│  │  ├── exclude (optional)     │                                             │
│  │  ├── max_results            │                                             │
│  │  └── include_hidden         │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  2. Clamp max_results       │                                             │
│  │  Min(input, AbsoluteMax)    │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  3. Validate Path           │                                             │
│  │  ToolPathHelper.ValidatePath│                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  4. Check Directory Exists  │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  5. Build Matcher           │                                             │
│  │  ├── AddInclude(pattern)    │                                             │
│  │  └── AddExclude(defaults +  │                                             │
│  │      custom exclusions)     │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  6. Execute Matcher         │                                             │
│  │  matcher.Execute(directory) │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  7. Filter Results          │                                             │
│  │  ├── Remove hidden          │                                             │
│  │  │   (unless include_hidden)│                                             │
│  │  └── Take(max_results)      │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  8. Format Output           │                                             │
│  │  One path per line          │                                             │
│  └─────────────┬───────────────┘                                             │
│                │                                                             │
│                ▼                                                             │
│  ┌─────────────────────────────┐                                             │
│  │  9. Build Result            │                                             │
│  │  ├── Formatted output       │                                             │
│  │  ├── SearchFilesResultData  │                                             │
│  │  └── Summary message        │                                             │
│  └─────────────────────────────┘                                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. SearchFilesTool.cs

**Location**: `src/SeniorIntern.Services/Tools/Search/SearchFilesTool.cs`

```csharp
namespace SeniorIntern.Services.Tools.Search;

using System.Text.Json;
using Microsoft.Extensions.FileSystemGlobbing;
using Microsoft.Extensions.FileSystemGlobbing.Abstractions;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Core.Tools;
using SeniorIntern.Services.Tools;

/// <summary>
/// Tool for searching files by name pattern.
/// </summary>
/// <remarks>
/// <para>
/// SearchFilesTool enables the AI agent to find files using glob patterns:
/// </para>
/// <list type="bullet">
/// <item>Simple patterns: <c>*.cs</c>, <c>*.json</c></item>
/// <item>Recursive patterns: <c>**/*.ts</c></item>
/// <item>Path-specific: <c>src/**/*.tsx</c></item>
/// </list>
/// <para>
/// Common build directories (node_modules, bin, obj, etc.) are excluded by default.
/// </para>
/// </remarks>
public sealed class SearchFilesTool : ToolBase
{
    #region Tool Metadata

    public override string Id => "search-files";

    public override string Name => "Search Files";

    public override string Description => """
        Search for files by name pattern in the workspace.
        Supports glob patterns for flexible matching.

        Pattern examples:
        - *.cs - All C# files in current directory
        - **/*.cs - All C# files recursively
        - src/**/*.ts - All TypeScript files under src/
        - **/test*.js - All JS files starting with 'test'
        """;

    public override ToolCategory Category => ToolCategory.Search;

    public override RiskLevel DefaultRiskLevel => RiskLevel.Safe;

    public override IReadOnlyList<string> Tags => new[] { "search", "files", "find", "glob" };

    public override JsonSchema InputSchema => JsonSchemaBuilder.Create()
        .WithDescription("Parameters for file search")
        .AddString("pattern", "Glob pattern to match (e.g., '**/*.cs')", required: true)
        .AddString("path", "Starting directory (default: workspace root)", required: false)
        .AddArray("exclude", "Patterns to exclude (e.g., ['**/tests/**'])", required: false)
        .AddInteger("max_results", "Maximum results to return (default: 100)", required: false)
        .AddBoolean("include_hidden", "Include hidden files (default: false)", required: false)
        .Build();

    #endregion

    #region Dependencies

    private readonly IFileSystemService _fileSystem;
    private readonly IWorkspaceService _workspace;
    private readonly ILogger<SearchFilesTool> _logger;

    #endregion

    #region Constants

    /// <summary>
    /// Default maximum results.
    /// </summary>
    public const int DefaultMaxResults = 100;

    /// <summary>
    /// Absolute maximum results.
    /// </summary>
    public const int AbsoluteMaxResults = 1000;

    /// <summary>
    /// Default exclusion patterns for common build/cache directories.
    /// </summary>
    private static readonly string[] DefaultExcludes =
    {
        "**/node_modules/**",
        "**/bin/**",
        "**/obj/**",
        "**/.git/**",
        "**/dist/**",
        "**/build/**",
        "**/.vs/**",
        "**/__pycache__/**"
    };

    #endregion

    public SearchFilesTool(
        IFileSystemService fileSystem,
        IWorkspaceService workspace,
        ILogger<SearchFilesTool> logger)
    {
        _fileSystem = fileSystem ?? throw new ArgumentNullException(nameof(fileSystem));
        _workspace = workspace ?? throw new ArgumentNullException(nameof(workspace));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    public override bool IsAvailable => _workspace.CurrentWorkspace != null;

    #region ExecuteAsync

    public override async Task<ToolResult> ExecuteAsync(
        ToolExecutionContext context,
        CancellationToken ct = default)
    {
        // Extract parameters
        var pattern = GetRequiredParameter<string>(context.Parameters, "pattern");
        var path = GetOptionalParameter(context.Parameters, "path", ".");
        var customExcludes = GetOptionalParameter<string[]?>(context.Parameters, "exclude", null);
        var maxResults = GetOptionalParameter(context.Parameters, "max_results", DefaultMaxResults);
        var includeHidden = GetOptionalParameter(context.Parameters, "include_hidden", false);

        _logger.LogDebug(
            "SearchFilesTool executing: pattern={Pattern}, path={Path}, max={Max}",
            pattern, path, maxResults);

        // Clamp max results
        maxResults = Math.Min(maxResults, AbsoluteMaxResults);

        // Resolve and validate path
        var fullPath = ToolPathHelper.ResolvePath(context.WorkspacePath, path);
        var pathValidation = ToolPathHelper.ValidatePath(fullPath, context.WorkspacePath);

        if (!pathValidation.IsValid)
        {
            return ToolResult.Failed(pathValidation.ErrorMessage!);
        }

        // Check directory exists
        if (!await _fileSystem.DirectoryExistsAsync(fullPath, ct))
        {
            return ToolResult.Failed($"Directory not found: {path}");
        }

        try
        {
            // Build matcher with include pattern
            var matcher = new Matcher();
            matcher.AddInclude(pattern);

            // Add all exclusions (defaults + custom)
            var allExcludes = customExcludes != null
                ? DefaultExcludes.Concat(customExcludes).ToArray()
                : DefaultExcludes;

            foreach (var exclude in allExcludes)
            {
                matcher.AddExclude(exclude);
            }

            // Execute search
            var directoryInfo = new DirectoryInfo(fullPath);
            var matchResult = matcher.Execute(new DirectoryInfoWrapper(directoryInfo));

            var totalFound = matchResult.Files.Count();

            // Filter and limit results
            var files = matchResult.Files
                .Where(f => includeHidden || !IsHiddenPath(f.Path))
                .Take(maxResults)
                .Select(f => new SearchFileResult
                {
                    Path = f.Path,
                    Stem = f.Stem
                })
                .ToList();

            var truncated = totalFound > maxResults;

            // Format output (one path per line)
            var output = files.Count > 0
                ? string.Join('\n', files.Select(f => f.Path))
                : "(no files found)";

            var resultData = new SearchFilesResultData
            {
                Pattern = pattern,
                Path = path,
                MatchCount = files.Count,
                TotalMatches = totalFound,
                WasTruncated = truncated
            };

            var message = truncated
                ? $"Found {files.Count}+ files matching '{pattern}' (showing first {maxResults})"
                : $"Found {files.Count} files matching '{pattern}'";

            _logger.LogInformation(
                "SearchFilesTool success: pattern={Pattern}, matches={Count}, truncated={Truncated}",
                pattern, files.Count, truncated);

            return ToolResult.Success(output, resultData, message);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Search failed for pattern: {Pattern}", pattern);
            return ToolResult.Failed($"Search failed: {ex.Message}");
        }
    }

    #endregion

    #region Helper Methods

    /// <summary>
    /// Check if a path contains hidden components.
    /// </summary>
    private static bool IsHiddenPath(string path)
    {
        var parts = path.Split(
            Path.DirectorySeparatorChar,
            Path.AltDirectorySeparatorChar);

        return parts.Any(p => p.StartsWith('.') && p.Length > 1);
    }

    #endregion

    #region Overrides

    public override string GetExecutionSummary(JsonElement parameters)
    {
        var pattern = parameters.TryGetProperty("pattern", out var p)
            ? p.GetString() ?? "?"
            : "?";
        var shortPattern = pattern.Length > 30 ? pattern[..27] + "..." : pattern;
        return $"Search for files: {shortPattern}";
    }

    public override ToolValidationResult Validate(JsonElement parameters)
    {
        var errors = new List<ToolValidationError>();

        if (!parameters.TryGetProperty("pattern", out var patternProp) ||
            string.IsNullOrWhiteSpace(patternProp.GetString()))
        {
            errors.Add(ToolValidationError.Required("pattern"));
        }

        // Validate max_results range
        if (parameters.TryGetProperty("max_results", out var maxProp))
        {
            var max = maxProp.GetInt32();
            if (max < 1 || max > AbsoluteMaxResults)
            {
                errors.Add(new ToolValidationError
                {
                    ParameterName = "max_results",
                    Message = $"Must be between 1 and {AbsoluteMaxResults}",
                    Code = "INVALID_RANGE"
                });
            }
        }

        return errors.Count > 0
            ? ToolValidationResult.Invalid(errors)
            : ToolValidationResult.Valid();
    }

    #endregion
}
```

### 2. SearchFilesResultData.cs

**Location**: `src/SeniorIntern.Services/Tools/Search/SearchFilesResultData.cs`

```csharp
namespace SeniorIntern.Services.Tools.Search;

/// <summary>
/// A single file search result.
/// </summary>
public sealed class SearchFileResult
{
    /// <summary>
    /// Relative path to the matched file.
    /// </summary>
    public string Path { get; init; } = string.Empty;

    /// <summary>
    /// File name without extension.
    /// </summary>
    public string Stem { get; init; } = string.Empty;

    /// <summary>
    /// File name with extension.
    /// </summary>
    public string FileName => System.IO.Path.GetFileName(Path);

    /// <summary>
    /// File extension (including dot).
    /// </summary>
    public string Extension => System.IO.Path.GetExtension(Path);

    /// <summary>
    /// Parent directory path.
    /// </summary>
    public string Directory => System.IO.Path.GetDirectoryName(Path) ?? "";
}

/// <summary>
/// Result data for file search operations.
/// </summary>
public sealed class SearchFilesResultData
{
    /// <summary>
    /// The glob pattern that was searched.
    /// </summary>
    public string Pattern { get; init; } = string.Empty;

    /// <summary>
    /// Starting path for the search.
    /// </summary>
    public string Path { get; init; } = string.Empty;

    /// <summary>
    /// Number of matches returned.
    /// </summary>
    public int MatchCount { get; init; }

    /// <summary>
    /// Total matches found (before truncation).
    /// </summary>
    public int TotalMatches { get; init; }

    /// <summary>
    /// Whether results were truncated due to max_results.
    /// </summary>
    public bool WasTruncated { get; init; }

    /// <summary>
    /// Percentage of total matches returned.
    /// </summary>
    public double PercentageReturned => TotalMatches > 0
        ? Math.Round((double)MatchCount / TotalMatches * 100, 1)
        : 100;
}
```

---

## Output Format

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      SearchFilesTool Output Examples                          │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Query: **/*.cs                                                              │
│  Output:                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  src/Program.cs                                                         │ │
│  │  src/Models/User.cs                                                     │ │
│  │  src/Models/Order.cs                                                    │ │
│  │  src/Services/UserService.cs                                            │ │
│  │  src/Services/OrderService.cs                                           │ │
│  │  tests/UserTests.cs                                                     │ │
│  │  tests/OrderTests.cs                                                    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│  Message: Found 7 files matching '**/*.cs'                                   │
│                                                                              │
│  Query: src/**/*Service.cs (with max_results: 3)                            │
│  Output:                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  src/Services/UserService.cs                                            │ │
│  │  src/Services/OrderService.cs                                           │ │
│  │  src/Services/EmailService.cs                                           │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│  Message: Found 3+ files matching 'src/**/*Service.cs' (showing first 3)    │
│                                                                              │
│  Query: **/*.xyz (no matches)                                                │
│  Output:                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  (no files found)                                                       │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│  Message: Found 0 files matching '**/*.xyz'                                  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `SearchFilesTool.cs` | `Services/Tools/Search/` | File search by pattern | ~200 |
| `SearchFilesResultData.cs` | `Services/Tools/Search/` | Result data models | ~55 |

---

## NuGet Dependencies

Add this package reference to `SeniorIntern.Services`:

```xml
<PackageReference Include="Microsoft.Extensions.FileSystemGlobbing" Version="8.0.0" />
```

This package provides the `Matcher` class for efficient glob pattern matching.

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `SearchFilesTool_SimplePattern_FindsFiles` | Basic *.cs pattern |
| `SearchFilesTool_RecursivePattern_FindsNested` | **/*.ts pattern |
| `SearchFilesTool_PathPrefix_FiltersCorrectly` | src/**/*.tsx |
| `SearchFilesTool_DefaultExcludes_SkipsNodeModules` | Exclusion behavior |
| `SearchFilesTool_CustomExcludes_Applied` | Custom exclusions |
| `SearchFilesTool_MaxResults_Truncates` | Truncation |
| `SearchFilesTool_HiddenFiles_FilteredByDefault` | Hidden filtering |
| `SearchFilesTool_IncludeHidden_ShowsAll` | Show hidden |
| `SearchFilesTool_NoMatches_ReturnsEmpty` | Empty result |
| `SearchFilesTool_EmptyPattern_ReturnsError` | Validation |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | SearchFilesTool finds files by glob pattern |
| AC-2 | Common directories are excluded by default |
| AC-3 | Custom exclusions can be specified |
| AC-4 | Results are limited to prevent overflow |
| AC-5 | Hidden files are optionally included |

---

## Changelog Entry

```markdown
## v0.6.3f - File Search Tools

### Added
- `SearchFilesTool` for finding files by glob pattern
  - Supports recursive patterns (**/*.cs)
  - Default exclusions for common build directories
    - node_modules, bin, obj, .git, dist, build, .vs, __pycache__
  - Custom exclusion patterns via 'exclude' parameter
  - Hidden file filtering (optional)
  - Result limiting (default: 100, max: 1000)
- `SearchFileResult` for individual match data
- `SearchFilesResultData` for search metadata
- Integration with Microsoft.Extensions.FileSystemGlobbing

### Dependencies
- Added Microsoft.Extensions.FileSystemGlobbing 8.0.0
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.3f | 0.5 day |
