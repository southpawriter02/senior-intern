# Design Specification: AIntern v0.6.4a "Permission Policy Models"

## Overview

**Version**: v0.6.4a
**Parent**: v0.6.4 Safety & Approval
**Focus**: Policy models governing permission evaluation, security patterns, and tool overrides

### Purpose

Define the core policy models that control how the permission system operates:
1. Global policy modes (Disabled, AlwaysAsk, AskForRisky, AutoApprove)
2. Risk level thresholds for requiring approval
3. Tool-specific permission overrides
4. Blocked command patterns for dangerous operations
5. Protected path patterns for sensitive files
6. Rate limiting configuration
7. Audit logging settings
8. Approval dialog behavior settings

### Dependencies

**From v0.6.1 (Tool Framework)**:
- `RiskLevel` enum
- `ToolCategory` enum

**From v0.3.x (Workspace Awareness)**:
- Path expansion utilities

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                   v0.6.4a Permission Policy Architecture                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  src/SeniorIntern.Core/Models/Permissions/                                   │
│  ├─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  PermissionPolicy                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │                                                                      ││ │
│  │  │  Global Settings                                                     ││ │
│  │  │  ├── Mode: PolicyMode (AskForRisky, etc.)                           ││ │
│  │  │  ├── ApprovalThreshold: RiskLevel (Medium)                          ││ │
│  │  │  └── ApprovalTimeoutSeconds: int (300)                              ││ │
│  │  │                                                                      ││ │
│  │  │  Tool Overrides                                                       ││ │
│  │  │  ├── ToolOverrides: Dict<string, ToolPermissionOverride>            ││ │
│  │  │  ├── BlockedTools: HashSet<string>                                  ││ │
│  │  │  ├── TrustedTools: HashSet<string>                                  ││ │
│  │  │  └── DisabledCategories: HashSet<ToolCategory>                      ││ │
│  │  │                                                                      ││ │
│  │  │  Security Patterns                                                    ││ │
│  │  │  ├── BlockedCommandPatterns: List<BlockedPattern>                   ││ │
│  │  │  └── ProtectedPaths: List<ProtectedPath>                            ││ │
│  │  │                                                                      ││ │
│  │  │  Rate Limiting                                                        ││ │
│  │  │  ├── RateLimitPerMinute: int (30)                                   ││ │
│  │  │  └── RateLimitPerHour: int (300)                                    ││ │
│  │  │                                                                      ││ │
│  │  │  Audit Settings                                                       ││ │
│  │  │  ├── AuditAllExecutions: bool (true)                                ││ │
│  │  │  ├── AuditDeniedCalls: bool (true)                                  ││ │
│  │  │  └── AuditRetentionDays: int (30)                                   ││ │
│  │  │                                                                      ││ │
│  │  │  UI Settings                                                          ││ │
│  │  │  ├── ShowParametersInApproval: bool (true)                          ││ │
│  │  │  └── AllowParameterEditing: bool (true)                             ││ │
│  │  │                                                                      ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  │  PolicyMode (enum)                                                       │ │
│  │  ├── Disabled = 0      (Block all tool calls)                           │ │
│  │  ├── AlwaysAsk = 1     (Prompt for every call)                          │ │
│  │  ├── AskForRisky = 2   (Auto-approve safe, ask for risky)               │ │
│  │  └── AutoApprove = 3   (DANGEROUS: Approve all)                         │ │
│  │                                                                          │ │
│  │  ToolPermissionOverride                                                  │ │
│  │  ├── ToolId: string                                                      │ │
│  │  ├── Action: OverrideAction                                              │ │
│  │  ├── CustomRiskLevel: RiskLevel?                                        │ │
│  │  ├── Reason: string?                                                     │ │
│  │  ├── CreatedAt: DateTime                                                 │ │
│  │  └── IsUserDefined: bool                                                 │ │
│  │                                                                          │ │
│  │  OverrideAction (enum)                                                   │ │
│  │  ├── UseDefault = 0    (Follow global policy)                           │ │
│  │  ├── AlwaysAllow = 1   (Auto-approve this tool)                         │ │
│  │  ├── AlwaysAsk = 2     (Always prompt for this tool)                    │ │
│  │  └── Block = 3         (Block this tool entirely)                       │ │
│  │                                                                          │ │
│  │  BlockedPattern                                                          │ │
│  │  ├── Name: string                                                        │ │
│  │  ├── Pattern: string (regex)                                             │ │
│  │  ├── Reason: string                                                      │ │
│  │  ├── IsEnabled: bool                                                     │ │
│  │  └── IsBuiltIn: bool                                                     │ │
│  │                                                                          │ │
│  │  ProtectedPath                                                           │ │
│  │  ├── Pattern: string (glob)                                              │ │
│  │  ├── Description: string                                                 │ │
│  │  ├── IsEnabled: bool                                                     │ │
│  │  ├── IsBuiltIn: bool                                                     │ │
│  │  └── ElevatedRiskLevel: RiskLevel                                       │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Policy Modes

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           Policy Mode Comparison                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Mode          Safe    Low     Medium   High    Critical   Use Case         │
│  ────────────────────────────────────────────────────────────────────────── │
│  Disabled      ✗       ✗       ✗        ✗       ✗          Read-only AI     │
│  AlwaysAsk     ?       ?       ?        ?       ?          Maximum security │
│  AskForRisky   ✓       ✓       ?        ?       ?          Recommended      │
│  AutoApprove   ✓       ✓       ✓        ✓       ✓          ⚠️ DANGEROUS    │
│                                                                              │
│  Legend: ✓ = Auto-approved, ? = Needs approval, ✗ = Blocked                 │
│                                                                              │
│  AskForRisky with ApprovalThreshold:                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                         │ │
│  │  Threshold = Safe                                                       │ │
│  │  └── Only Safe auto-approved; Low+ needs approval                      │ │
│  │                                                                         │ │
│  │  Threshold = Low                                                        │ │
│  │  └── Safe, Low auto-approved; Medium+ needs approval                   │ │
│  │                                                                         │ │
│  │  Threshold = Medium (DEFAULT)                                           │ │
│  │  └── Safe, Low, Medium auto-approved; High+ needs approval             │ │
│  │                                                                         │ │
│  │  Threshold = High                                                       │ │
│  │  └── Safe-High auto-approved; only Critical needs approval             │ │
│  │                                                                         │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Default Blocked Patterns

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     Built-in Blocked Command Patterns                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  # | Name                   | Pattern                    | Reason            │
│  ──────────────────────────────────────────────────────────────────────────  │
│  1 | rm -rf /               | rm\s+-rf\s+/               | Delete root       │
│  2 | rm -rf ~               | rm\s+-rf\s+~               | Delete home       │
│  3 | sudo rm                | sudo\s+rm\s+-rf            | Sudo delete       │
│  4 | Format drive           | format\s+[a-zA-Z]:         | Windows format    │
│  5 | mkfs                   | mkfs\.                     | Linux format      │
│  6 | Fork bomb              | :\(\)\{:\|:&\};:           | Fork bomb attack  │
│  7 | dd to device           | dd\s+if=.*/dev/            | Direct disk write │
│  8 | Write to block device  | >\s*/dev/sd[a-z]           | Block device      │
│  9 | chmod 777 /            | chmod\s+(-R\s+)?777\s+/    | Bad permissions   │
│  10| chown root /           | chown\s+(-R\s+)?root\s+/   | Bad ownership     │
│                                                                              │
│  These patterns are applied to terminal commands before execution.           │
│  Matching commands are immediately blocked with no option to override.       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Default Protected Paths

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Built-in Protected Path Patterns                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Pattern               Elevated To    Description                            │
│  ────────────────────────────────────────────────────────────────────────── │
│  ~/.ssh/*              High           SSH keys and configuration             │
│  ~/.aws/*              High           AWS credentials                        │
│  ~/.azure/*            High           Azure credentials                      │
│  ~/.config/gcloud/*    High           Google Cloud credentials               │
│  ~/.kube/*             High           Kubernetes configuration               │
│  ~/.docker/*           High           Docker configuration                   │
│  **/.env               High           Environment files                      │
│  **/.env.*             High           Environment files (variants)           │
│  **/secrets/**         High           Secrets directories                    │
│  **/credentials*       High           Credentials files                      │
│  **/*.pem              High           Certificate files                      │
│  **/*.key              High           Private key files                      │
│  **/id_rsa*            High           SSH private keys                       │
│                                                                              │
│  Operations on these paths elevate the risk level to at least High.          │
│  User must explicitly approve operations on protected paths.                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. PermissionPolicy.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/PermissionPolicy.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using System.Text.Json.Serialization;
using SeniorIntern.Core.Tools;

/// <summary>
/// Comprehensive policy configuration for tool permissions.
/// Controls how the system decides whether to allow, block, or prompt for tool calls.
/// </summary>
/// <remarks>
/// <para>
/// This policy follows a layered evaluation approach:
/// </para>
/// <list type="number">
/// <item>BlockedTools - Immediately blocked, no override</item>
/// <item>DisabledCategories - Category-level blocking</item>
/// <item>ToolOverrides - Per-tool custom behavior</item>
/// <item>TrustedTools - Auto-approved tools</item>
/// <item>BlockedCommandPatterns - Dangerous command detection</item>
/// <item>ProtectedPaths - Sensitive path elevation</item>
/// <item>Global Mode + Threshold - Final decision</item>
/// </list>
/// </remarks>
[Serializable]
public sealed class PermissionPolicy
{
    #region Global Settings

    /// <summary>
    /// Global policy mode determining default behavior.
    /// </summary>
    /// <remarks>
    /// <list type="bullet">
    /// <item><b>Disabled</b>: All tool calls blocked</item>
    /// <item><b>AlwaysAsk</b>: Every call needs approval</item>
    /// <item><b>AskForRisky</b>: Auto-approve safe, ask for risky (recommended)</item>
    /// <item><b>AutoApprove</b>: All calls approved (DANGEROUS)</item>
    /// </list>
    /// </remarks>
    public PolicyMode Mode { get; set; } = PolicyMode.AskForRisky;

    /// <summary>
    /// Risk level threshold for requiring approval.
    /// Tools at or above this level require explicit user approval.
    /// </summary>
    /// <remarks>
    /// Only applies when <see cref="Mode"/> is <see cref="PolicyMode.AskForRisky"/>.
    /// Default is <see cref="RiskLevel.Medium"/>, meaning Safe and Low
    /// operations auto-approve while Medium+ requires approval.
    /// </remarks>
    public RiskLevel ApprovalThreshold { get; set; } = RiskLevel.Medium;

    /// <summary>
    /// Timeout for user approval in seconds.
    /// Request is denied if not responded within this time.
    /// </summary>
    public int ApprovalTimeoutSeconds { get; set; } = 300; // 5 minutes

    #endregion

    #region Tool Overrides

    /// <summary>
    /// Tool-specific permission overrides.
    /// Key is the tool ID (e.g., "file-write", "terminal-run").
    /// </summary>
    public Dictionary<string, ToolPermissionOverride> ToolOverrides { get; set; } = new();

    /// <summary>
    /// Tools that are completely blocked and cannot be executed.
    /// Takes precedence over all other settings.
    /// </summary>
    public HashSet<string> BlockedTools { get; set; } = new();

    /// <summary>
    /// Tools that are always allowed without approval.
    /// Only applies when Mode is not Disabled.
    /// </summary>
    public HashSet<string> TrustedTools { get; set; } = new();

    /// <summary>
    /// Categories of tools that are disabled entirely.
    /// </summary>
    public HashSet<ToolCategory> DisabledCategories { get; set; } = new();

    #endregion

    #region Security Patterns

    /// <summary>
    /// Regex patterns for commands that are always blocked.
    /// Applied to terminal/command tools.
    /// </summary>
    public List<BlockedPattern> BlockedCommandPatterns { get; set; } = CreateDefaultBlockedPatterns();

    /// <summary>
    /// Glob patterns for paths that require elevated approval.
    /// Operations on these paths are elevated to High risk.
    /// </summary>
    public List<ProtectedPath> ProtectedPaths { get; set; } = CreateDefaultProtectedPaths();

    #endregion

    #region Rate Limiting

    /// <summary>
    /// Maximum tool calls allowed per minute.
    /// Prevents runaway agent loops.
    /// </summary>
    public int RateLimitPerMinute { get; set; } = 30;

    /// <summary>
    /// Maximum tool calls allowed per hour.
    /// Additional safety limit.
    /// </summary>
    public int RateLimitPerHour { get; set; } = 300;

    #endregion

    #region Audit Settings

    /// <summary>
    /// Whether to log all tool executions to the audit log.
    /// </summary>
    public bool AuditAllExecutions { get; set; } = true;

    /// <summary>
    /// Whether to log denied/blocked tool calls.
    /// </summary>
    public bool AuditDeniedCalls { get; set; } = true;

    /// <summary>
    /// Number of days to retain audit logs.
    /// Set to 0 for indefinite retention.
    /// </summary>
    public int AuditRetentionDays { get; set; } = 30;

    #endregion

    #region UI Settings

    /// <summary>
    /// Whether to show detailed parameters in approval dialogs.
    /// May be disabled for privacy.
    /// </summary>
    public bool ShowParametersInApproval { get; set; } = true;

    /// <summary>
    /// Whether to allow editing parameters before approval.
    /// </summary>
    public bool AllowParameterEditing { get; set; } = true;

    #endregion

    #region Factory Methods

    /// <summary>
    /// Create default blocked command patterns.
    /// </summary>
    private static List<BlockedPattern> CreateDefaultBlockedPatterns() => new()
    {
        new BlockedPattern("rm -rf /", @"rm\s+-rf\s+/", "Recursive delete of root directory"),
        new BlockedPattern("rm -rf ~", @"rm\s+-rf\s+~", "Recursive delete of home directory"),
        new BlockedPattern("sudo rm -rf", @"sudo\s+rm\s+-rf", "Sudo recursive delete"),
        new BlockedPattern("Format drive", @"format\s+[a-zA-Z]:", "Windows drive format"),
        new BlockedPattern("mkfs", @"mkfs\.", "Linux filesystem format"),
        new BlockedPattern("Fork bomb", @":\(\)\{:\|:&\};:", "Fork bomb attack"),
        new BlockedPattern("dd to device", @"dd\s+if=.*/dev/", "Direct disk write"),
        new BlockedPattern("Write to block device", @">\s*/dev/sd[a-z]", "Write to block device"),
        new BlockedPattern("chmod 777 /", @"chmod\s+(-R\s+)?777\s+/", "Dangerous permission change"),
        new BlockedPattern("chown root /", @"chown\s+(-R\s+)?root\s+/", "Dangerous ownership change"),
    };

    /// <summary>
    /// Create default protected path patterns.
    /// </summary>
    private static List<ProtectedPath> CreateDefaultProtectedPaths() => new()
    {
        new ProtectedPath("~/.ssh/*", "SSH keys and configuration"),
        new ProtectedPath("~/.aws/*", "AWS credentials"),
        new ProtectedPath("~/.azure/*", "Azure credentials"),
        new ProtectedPath("~/.config/gcloud/*", "Google Cloud credentials"),
        new ProtectedPath("~/.kube/*", "Kubernetes configuration"),
        new ProtectedPath("~/.docker/*", "Docker configuration"),
        new ProtectedPath("**/.env", "Environment files"),
        new ProtectedPath("**/.env.*", "Environment files"),
        new ProtectedPath("**/secrets/**", "Secrets directory"),
        new ProtectedPath("**/credentials*", "Credentials files"),
        new ProtectedPath("**/*.pem", "Certificate files"),
        new ProtectedPath("**/*.key", "Private key files"),
        new ProtectedPath("**/id_rsa*", "SSH private keys"),
    };

    #endregion

    #region Preset Policies

    /// <summary>
    /// Creates a restrictive policy (AlwaysAsk mode).
    /// </summary>
    public static PermissionPolicy CreateRestrictive() => new()
    {
        Mode = PolicyMode.AlwaysAsk,
        ApprovalThreshold = RiskLevel.Safe
    };

    /// <summary>
    /// Creates a balanced policy (AskForRisky with Medium threshold).
    /// </summary>
    public static PermissionPolicy CreateBalanced() => new()
    {
        Mode = PolicyMode.AskForRisky,
        ApprovalThreshold = RiskLevel.Medium
    };

    /// <summary>
    /// Creates a permissive policy (AskForRisky with High threshold).
    /// </summary>
    public static PermissionPolicy CreatePermissive() => new()
    {
        Mode = PolicyMode.AskForRisky,
        ApprovalThreshold = RiskLevel.High
    };

    #endregion
}
```

### 2. PolicyMode.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/PolicyMode.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

/// <summary>
/// Global policy modes for tool permission handling.
/// </summary>
/// <remarks>
/// The mode determines the overall security posture of the agent.
/// Choose based on your trust level and use case requirements.
/// </remarks>
public enum PolicyMode
{
    /// <summary>
    /// All tool calls are blocked. Agent cannot execute any tools.
    /// Use when you want AI assistance without any system modifications.
    /// </summary>
    /// <remarks>
    /// The agent can still:
    /// <list type="bullet">
    /// <item>Generate code suggestions</item>
    /// <item>Answer questions</item>
    /// <item>Provide explanations</item>
    /// </list>
    /// But it cannot execute any tool actions.
    /// </remarks>
    Disabled = 0,

    /// <summary>
    /// All tool calls require explicit user approval.
    /// Most secure mode - nothing happens without consent.
    /// </summary>
    /// <remarks>
    /// Recommended for:
    /// <list type="bullet">
    /// <item>First-time users</item>
    /// <item>Sensitive production environments</item>
    /// <item>When learning the agent's behavior</item>
    /// </list>
    /// </remarks>
    AlwaysAsk = 1,

    /// <summary>
    /// Safe operations auto-approve, risky ones require approval.
    /// Recommended balance of security and convenience.
    /// </summary>
    /// <remarks>
    /// The <see cref="PermissionPolicy.ApprovalThreshold"/> determines
    /// what constitutes "risky". Default threshold is Medium, meaning:
    /// <list type="bullet">
    /// <item>Safe, Low: Auto-approved</item>
    /// <item>Medium, High, Critical: Require approval</item>
    /// </list>
    /// </remarks>
    AskForRisky = 2,

    /// <summary>
    /// All tool calls are automatically approved.
    /// </summary>
    /// <remarks>
    /// <para>
    /// ⚠️ <b>DANGEROUS</b>: Only use in fully trusted, isolated environments.
    /// </para>
    /// <para>
    /// This mode grants the agent full autonomous control over tool execution.
    /// BlockedTools and BlockedCommandPatterns still apply, but all other
    /// operations proceed without user confirmation.
    /// </para>
    /// <para>
    /// Appropriate uses:
    /// <list type="bullet">
    /// <item>Isolated development containers</item>
    /// <item>CI/CD automation environments</item>
    /// <item>Sandboxed testing environments</item>
    /// </list>
    /// </para>
    /// </remarks>
    AutoApprove = 3
}
```

### 3. ToolPermissionOverride.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/ToolPermissionOverride.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using SeniorIntern.Core.Tools;

/// <summary>
/// Override settings for a specific tool.
/// </summary>
/// <remarks>
/// Allows fine-grained control over individual tools, overriding
/// the global policy behavior. Useful for:
/// <list type="bullet">
/// <item>Trusting frequently-used safe tools</item>
/// <item>Adding extra approval for specific risky tools</item>
/// <item>Blocking tools you don't want the agent to use</item>
/// </list>
/// </remarks>
[Serializable]
public sealed class ToolPermissionOverride
{
    /// <summary>
    /// Tool ID this override applies to.
    /// </summary>
    /// <example>file-write, terminal-run, git-push</example>
    public string ToolId { get; init; } = string.Empty;

    /// <summary>
    /// Action to take for this tool.
    /// </summary>
    public OverrideAction Action { get; init; } = OverrideAction.UseDefault;

    /// <summary>
    /// Custom risk level override.
    /// Only used when Action is UseDefault.
    /// </summary>
    /// <remarks>
    /// Set this to override the tool's default risk level.
    /// For example, elevate a tool from Low to High risk.
    /// </remarks>
    public RiskLevel? CustomRiskLevel { get; init; }

    /// <summary>
    /// Reason for this override (for audit purposes).
    /// </summary>
    /// <example>Trusted tool for this project</example>
    public string? Reason { get; init; }

    /// <summary>
    /// When this override was created.
    /// </summary>
    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Whether this override was set by the user or system.
    /// </summary>
    /// <remarks>
    /// User-defined overrides take precedence over system defaults.
    /// </remarks>
    public bool IsUserDefined { get; init; } = true;

    /// <summary>
    /// Optional expiration time for temporary overrides.
    /// </summary>
    public DateTime? ExpiresAt { get; init; }

    /// <summary>
    /// Check if this override has expired.
    /// </summary>
    public bool IsExpired => ExpiresAt.HasValue && DateTime.UtcNow > ExpiresAt.Value;

    /// <summary>
    /// Create an AlwaysAllow override.
    /// </summary>
    public static ToolPermissionOverride AllowAlways(string toolId, string? reason = null) => new()
    {
        ToolId = toolId,
        Action = OverrideAction.AlwaysAllow,
        Reason = reason
    };

    /// <summary>
    /// Create an AlwaysAsk override.
    /// </summary>
    public static ToolPermissionOverride AskAlways(string toolId, string? reason = null) => new()
    {
        ToolId = toolId,
        Action = OverrideAction.AlwaysAsk,
        Reason = reason
    };

    /// <summary>
    /// Create a Block override.
    /// </summary>
    public static ToolPermissionOverride Block(string toolId, string? reason = null) => new()
    {
        ToolId = toolId,
        Action = OverrideAction.Block,
        Reason = reason
    };
}

/// <summary>
/// Actions that can be taken for tool permission overrides.
/// </summary>
public enum OverrideAction
{
    /// <summary>
    /// Use default policy behavior.
    /// The tool's risk level is evaluated against the global policy.
    /// </summary>
    UseDefault = 0,

    /// <summary>
    /// Always allow without asking.
    /// Tool executes immediately without user confirmation.
    /// </summary>
    AlwaysAllow = 1,

    /// <summary>
    /// Always ask for approval regardless of risk level.
    /// User must confirm every invocation of this tool.
    /// </summary>
    AlwaysAsk = 2,

    /// <summary>
    /// Block this tool entirely.
    /// Tool cannot be executed regardless of other settings.
    /// </summary>
    Block = 3
}
```

### 4. BlockedPattern.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/BlockedPattern.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using System.Text.RegularExpressions;

/// <summary>
/// A regex pattern for blocking dangerous commands.
/// </summary>
/// <remarks>
/// <para>
/// Blocked patterns are evaluated against terminal commands before execution.
/// If a command matches any enabled pattern, it is immediately blocked with
/// no option to override (unless the pattern itself is disabled).
/// </para>
/// <para>
/// Patterns use .NET regular expression syntax with IgnoreCase option.
/// </para>
/// </remarks>
[Serializable]
public sealed class BlockedPattern
{
    /// <summary>
    /// Human-readable name for this pattern.
    /// </summary>
    /// <example>rm -rf /, Fork bomb, sudo rm</example>
    public string Name { get; init; }

    /// <summary>
    /// Regex pattern to match against commands.
    /// </summary>
    /// <example>rm\s+-rf\s+/</example>
    public string Pattern { get; init; }

    /// <summary>
    /// Explanation of why this pattern is dangerous.
    /// Shown to users when a command is blocked.
    /// </summary>
    public string Reason { get; init; }

    /// <summary>
    /// Whether this pattern is enabled.
    /// Disabled patterns are not evaluated.
    /// </summary>
    public bool IsEnabled { get; init; } = true;

    /// <summary>
    /// Whether this is a built-in pattern (cannot be deleted).
    /// Built-in patterns can only be disabled, not removed.
    /// </summary>
    public bool IsBuiltIn { get; init; } = true;

    /// <summary>
    /// Category of danger this pattern represents.
    /// </summary>
    public BlockedPatternCategory Category { get; init; } = BlockedPatternCategory.SystemDamage;

    /// <summary>
    /// Cached compiled regex for performance.
    /// </summary>
    [NonSerialized]
    private Regex? _compiledRegex;

    public BlockedPattern(string name, string pattern, string reason)
    {
        Name = name;
        Pattern = pattern;
        Reason = reason;
    }

    /// <summary>
    /// Get the compiled regex for matching.
    /// </summary>
    public Regex GetCompiledRegex()
    {
        return _compiledRegex ??= new Regex(
            Pattern,
            RegexOptions.Compiled | RegexOptions.IgnoreCase);
    }

    /// <summary>
    /// Check if a command matches this pattern.
    /// </summary>
    public bool Matches(string command)
    {
        if (!IsEnabled) return false;
        return GetCompiledRegex().IsMatch(command);
    }
}

/// <summary>
/// Categories of blocked patterns.
/// </summary>
public enum BlockedPatternCategory
{
    /// <summary>Commands that could damage the system.</summary>
    SystemDamage,

    /// <summary>Commands that could delete data.</summary>
    DataLoss,

    /// <summary>Commands that could compromise security.</summary>
    SecurityRisk,

    /// <summary>Commands that could affect external systems.</summary>
    NetworkRisk,

    /// <summary>Commands that could cause denial of service.</summary>
    ResourceExhaustion
}
```

### 5. ProtectedPath.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/ProtectedPath.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using Microsoft.Extensions.FileSystemGlobbing;
using SeniorIntern.Core.Tools;

/// <summary>
/// A glob pattern for paths that require elevated approval.
/// </summary>
/// <remarks>
/// <para>
/// Protected paths are evaluated for file system operations.
/// If an operation targets a protected path, its risk level is
/// elevated to at least <see cref="ElevatedRiskLevel"/>.
/// </para>
/// <para>
/// Patterns use glob syntax:
/// <list type="bullet">
/// <item><c>*</c> matches any file name</item>
/// <item><c>**</c> matches any path (recursive)</item>
/// <item><c>~</c> expands to home directory</item>
/// </list>
/// </para>
/// </remarks>
[Serializable]
public sealed class ProtectedPath
{
    /// <summary>
    /// Glob pattern to match against file paths.
    /// </summary>
    /// <example>~/.ssh/*, **/.env, **/secrets/**</example>
    public string Pattern { get; init; }

    /// <summary>
    /// Description of what this path contains.
    /// Shown to users to explain why approval is needed.
    /// </summary>
    public string Description { get; init; }

    /// <summary>
    /// Whether this protection is enabled.
    /// Disabled protections are not evaluated.
    /// </summary>
    public bool IsEnabled { get; init; } = true;

    /// <summary>
    /// Whether this is a built-in protection (cannot be deleted).
    /// Built-in protections can only be disabled, not removed.
    /// </summary>
    public bool IsBuiltIn { get; init; } = true;

    /// <summary>
    /// Risk level to apply when this path is matched.
    /// </summary>
    public RiskLevel ElevatedRiskLevel { get; init; } = RiskLevel.High;

    /// <summary>
    /// Category of protection.
    /// </summary>
    public ProtectedPathCategory Category { get; init; } = ProtectedPathCategory.Credentials;

    public ProtectedPath(string pattern, string description)
    {
        Pattern = pattern;
        Description = description;
    }

    /// <summary>
    /// Check if a path matches this protection pattern.
    /// </summary>
    public bool Matches(string path)
    {
        if (!IsEnabled) return false;

        // Expand ~ to home directory
        var expandedPattern = ExpandTilde(Pattern);
        var expandedPath = ExpandTilde(path);

        // Use glob matching
        var matcher = new Matcher();
        matcher.AddInclude(expandedPattern);

        var directory = Path.GetDirectoryName(expandedPath) ?? "";
        var fileName = Path.GetFileName(expandedPath);

        // Check if the file matches the pattern
        return MatchesGlobPattern(expandedPath, expandedPattern);
    }

    /// <summary>
    /// Expand ~ to user's home directory.
    /// </summary>
    private static string ExpandTilde(string path)
    {
        if (path.StartsWith("~"))
        {
            var home = Environment.GetFolderPath(Environment.SpecialFolder.UserProfile);
            return home + path[1..];
        }
        return path;
    }

    /// <summary>
    /// Simple glob pattern matching.
    /// </summary>
    private static bool MatchesGlobPattern(string path, string pattern)
    {
        // Convert glob to simple regex
        var regexPattern = "^" + System.Text.RegularExpressions.Regex.Escape(pattern)
            .Replace(@"\*\*", ".*")
            .Replace(@"\*", "[^/\\\\]*")
            .Replace(@"\?", ".")
            + "$";

        return System.Text.RegularExpressions.Regex.IsMatch(
            path,
            regexPattern,
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }
}

/// <summary>
/// Categories of protected paths.
/// </summary>
public enum ProtectedPathCategory
{
    /// <summary>Credential and authentication files.</summary>
    Credentials,

    /// <summary>Configuration files.</summary>
    Configuration,

    /// <summary>Private keys and certificates.</summary>
    Cryptographic,

    /// <summary>System files.</summary>
    System,

    /// <summary>User-defined protected paths.</summary>
    Custom
}
```

---

## Serialization Support

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     Policy Serialization (JSON Format)                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  {                                                                           │
│    "mode": "AskForRisky",                                                    │
│    "approvalThreshold": "Medium",                                            │
│    "approvalTimeoutSeconds": 300,                                            │
│    "toolOverrides": {                                                        │
│      "file-write": {                                                         │
│        "toolId": "file-write",                                               │
│        "action": "AlwaysAsk",                                                │
│        "reason": "Project requires review"                                   │
│      }                                                                       │
│    },                                                                        │
│    "blockedTools": [],                                                       │
│    "trustedTools": ["file-read", "directory-list"],                          │
│    "rateLimitPerMinute": 30,                                                 │
│    "rateLimitPerHour": 300,                                                  │
│    "auditAllExecutions": true                                                │
│  }                                                                           │
│                                                                              │
│  Stored at: ~/.seniorintern/permission-policy.json                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `PermissionPolicy.cs` | `Core/Models/Permissions/` | Main policy configuration | ~200 |
| `PolicyMode.cs` | `Core/Models/Permissions/` | Policy mode enum | ~60 |
| `ToolPermissionOverride.cs` | `Core/Models/Permissions/` | Tool override model | ~120 |
| `BlockedPattern.cs` | `Core/Models/Permissions/` | Blocked pattern model | ~100 |
| `ProtectedPath.cs` | `Core/Models/Permissions/` | Protected path model | ~110 |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `PermissionPolicy_DefaultValues_AreCorrect` | Verify defaults |
| `PermissionPolicy_CreateRestrictive_SetsAlwaysAsk` | Factory method |
| `PermissionPolicy_CreateBalanced_SetsAskForRisky` | Factory method |
| `PolicyMode_Values_AreCorrectlyOrdered` | Enum ordering |
| `ToolPermissionOverride_AllowAlways_CreatesCorrectly` | Factory method |
| `ToolPermissionOverride_IsExpired_WorksCorrectly` | Expiration logic |
| `BlockedPattern_Matches_DetectsDangerousCommands` | Pattern matching |
| `BlockedPattern_Disabled_DoesNotMatch` | Disabled behavior |
| `ProtectedPath_Matches_DetectsSensitivePaths` | Path matching |
| `ProtectedPath_ExpandsTilde_Correctly` | Home expansion |
| `PermissionPolicy_Serialization_RoundTrips` | JSON serialization |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | PermissionPolicy captures all configuration options |
| AC-2 | PolicyMode enum covers all use cases |
| AC-3 | Built-in blocked patterns cover dangerous commands |
| AC-4 | Protected paths include common credential locations |
| AC-5 | Models are serializable for persistence |

---

## Changelog Entry

```markdown
## v0.6.4a - Permission Policy Models

### Added
- `PermissionPolicy` for comprehensive permission configuration
  - Global policy modes (Disabled, AlwaysAsk, AskForRisky, AutoApprove)
  - Risk level threshold configuration
  - Tool-specific overrides
  - Rate limiting settings
  - Audit configuration
  - Approval dialog settings
- `PolicyMode` enum with 4 security levels
- `ToolPermissionOverride` for per-tool customization
  - Override actions (UseDefault, AlwaysAllow, AlwaysAsk, Block)
  - Custom risk level assignment
  - Expiration support
  - Factory methods
- `BlockedPattern` for dangerous command detection
  - 10 built-in patterns (rm -rf, fork bomb, etc.)
  - Compiled regex caching
  - Category classification
- `ProtectedPath` for sensitive file protection
  - 13 built-in path patterns
  - Home directory expansion
  - Glob pattern matching
  - Risk elevation support
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.4a | 0.5 day |
