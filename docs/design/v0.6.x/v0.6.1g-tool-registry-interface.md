# Design Specification: AIntern v0.6.1g "Tool Registry Interface"

## Overview

**Version**: v0.6.1g
**Parent**: v0.6.1 Tool Framework
**Focus**: Tool registry interface, availability context, function definition generation, and registry events

### Purpose

This sub-version defines the registry interface for tool management:
1. Create `IToolRegistry` interface for tool storage and lookup
2. Create `ToolAvailabilityContext` for context-dependent filtering
3. Create `FunctionDefinition` for LLM function calling format
4. Create `ToolRegistryChangedEventArgs` for registry change events
5. Define filtering and query capabilities
6. Support dynamic function definition generation

### Dependencies

**From v0.6.1a (Tool Core Models)**:
- `ITool` interface for tool registration
- `ToolCategory` enum for filtering
- `RiskLevel` enum for filtering

**From v0.6.1e (JSON Schema System)**:
- `JsonSchema` for function parameters

**Future consumers**:
- v0.6.1h: Tool Registry Implementation
- v0.6.1i: Tool Execution Service
- v0.6.2: Semantic Kernel Integration
- v0.6.3: Built-in Tools registration

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                 v0.6.1g Tool Registry Interface Architecture                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  src/AIntern.Core/Interfaces/                                                │
│  ├─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  IToolRegistry                                                           │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │                                                                      ││ │
│  │  │  Properties                                                          ││ │
│  │  │  ├── Tools: IReadOnlyList<ITool>     (all registered tools)         ││ │
│  │  │  └── Count: int                       (total count)                  ││ │
│  │  │                                                                      ││ │
│  │  │  Registration                                                        ││ │
│  │  │  ├── RegisterTool(tool) → void        (throws if duplicate)         ││ │
│  │  │  ├── TryRegisterTool(tool) → bool     (returns false if duplicate)  ││ │
│  │  │  └── UnregisterTool(toolId) → bool    (returns false if not found)  ││ │
│  │  │                                                                      ││ │
│  │  │  Lookup                                                              ││ │
│  │  │  ├── GetTool(toolId) → ITool?         (by ID)                       ││ │
│  │  │  └── HasTool(toolId) → bool           (existence check)             ││ │
│  │  │                                                                      ││ │
│  │  │  Filtering                                                           ││ │
│  │  │  ├── GetAvailableTools(context?) → IReadOnlyList<ITool>             ││ │
│  │  │  ├── GetToolsByCategory(category) → IReadOnlyList<ITool>            ││ │
│  │  │  ├── GetToolsByTag(tag) → IReadOnlyList<ITool>                      ││ │
│  │  │  ├── GetToolsByRiskLevel(maxLevel) → IReadOnlyList<ITool>           ││ │
│  │  │  └── SearchTools(query) → IReadOnlyList<ITool>                      ││ │
│  │  │                                                                      ││ │
│  │  │  Function Definitions                                                ││ │
│  │  │  ├── GetFunctionDefinitions(context?) → IReadOnlyList<FunctionDef>  ││ │
│  │  │  └── GetFunctionDefinition(toolId) → FunctionDefinition?            ││ │
│  │  │                                                                      ││ │
│  │  │  Events                                                              ││ │
│  │  │  └── ToolsChanged: EventHandler<ToolRegistryChangedEventArgs>       ││ │
│  │  │                                                                      ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  src/AIntern.Core/Tools/                                                     │
│  ├─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  ToolAvailabilityContext                                                 │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │                                                                      ││ │
│  │  │  Whitelist/Blacklist                                                 ││ │
│  │  │  ├── EnabledToolIds: IReadOnlySet<string>?  (whitelist)             ││ │
│  │  │  └── DisabledToolIds: IReadOnlySet<string>? (blacklist)             ││ │
│  │  │                                                                      ││ │
│  │  │  Risk Filtering                                                      ││ │
│  │  │  └── MaxRiskLevel: RiskLevel?               (max allowed)            ││ │
│  │  │                                                                      ││ │
│  │  │  Category Filtering                                                  ││ │
│  │  │  ├── IncludedCategories: IReadOnlySet<ToolCategory>?                ││ │
│  │  │  └── ExcludedCategories: IReadOnlySet<ToolCategory>?                ││ │
│  │  │                                                                      ││ │
│  │  │  Tag Filtering                                                       ││ │
│  │  │  └── RequiredTags: IReadOnlySet<string>?    (must have all)         ││ │
│  │  │                                                                      ││ │
│  │  │  Context Availability                                                ││ │
│  │  │  ├── HasWorkspace: bool                     (workspace tools)        ││ │
│  │  │  ├── HasTerminal: bool                      (terminal tools)         ││ │
│  │  │  ├── HasEditor: bool                        (editor tools)           ││ │
│  │  │  └── HasGitRepository: bool                 (git tools)              ││ │
│  │  │                                                                      ││ │
│  │  │  Builder                                                             ││ │
│  │  │  ├── Create() → ToolAvailabilityContextBuilder                      ││ │
│  │  │  └── Default → ToolAvailabilityContext                              ││ │
│  │  │                                                                      ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  │  FunctionDefinition                                                      │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │                                                                      ││ │
│  │  │  OpenAI Function Format                                              ││ │
│  │  │  ├── Name: string                           (tool ID)                ││ │
│  │  │  ├── Description: string                    (tool description)       ││ │
│  │  │  └── Parameters: JsonSchema                 (input schema)           ││ │
│  │  │                                                                      ││ │
│  │  │  Methods                                                             ││ │
│  │  │  ├── FromTool(tool) → FunctionDefinition                            ││ │
│  │  │  └── ToJson() → string                                              ││ │
│  │  │                                                                      ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  │  ToolRegistryChangedEventArgs                                            │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │                                                                      ││ │
│  │  │  ├── ChangeType: ToolRegistryChangeType                             ││ │
│  │  │  │   ├── Added                                                       ││ │
│  │  │  │   ├── Removed                                                     ││ │
│  │  │  │   └── Updated                                                     ││ │
│  │  │  └── Tool: ITool                            (affected tool)          ││ │
│  │  │                                                                      ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Filtering Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Tool Filtering Flow                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  All Registered Tools                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │ file-read, file-write, file-delete, terminal-execute,                 │   │
│  │ search-grep, git-status, git-commit, network-fetch, ...               │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│         │                                                                    │
│         ▼ Filter by IsAvailable == true                                      │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ Remove tools that report IsAvailable = false                           │  │
│  │ (e.g., terminal-execute when no terminal connected)                   │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│         │                                                                    │
│         ▼ Apply ToolAvailabilityContext filters                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                         │  │
│  │  1. Whitelist (EnabledToolIds)                                          │  │
│  │     If set: Keep only tools in the whitelist                           │  │
│  │                                                                         │  │
│  │  2. Blacklist (DisabledToolIds)                                         │  │
│  │     Remove tools in the blacklist                                       │  │
│  │                                                                         │  │
│  │  3. Risk Level (MaxRiskLevel)                                           │  │
│  │     Remove tools with DefaultRiskLevel > MaxRiskLevel                  │  │
│  │                                                                         │  │
│  │  4. Categories (IncludedCategories, ExcludedCategories)                 │  │
│  │     Filter by category membership                                       │  │
│  │                                                                         │  │
│  │  5. Tags (RequiredTags)                                                 │  │
│  │     Keep only tools that have ALL required tags                        │  │
│  │                                                                         │  │
│  │  6. Context Availability                                                │  │
│  │     HasWorkspace=false → Remove Workspace category                     │  │
│  │     HasTerminal=false → Remove Terminal category                       │  │
│  │     HasEditor=false → Remove Editor category                           │  │
│  │     HasGitRepository=false → Remove Git category                       │  │
│  │                                                                         │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│         │                                                                    │
│         ▼                                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ Available Tools                                                         │  │
│  │ (Ready for function definition generation)                             │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Function Definition Format

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     OpenAI Function Definition Format                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  OpenAI API "tools" array element:                                           │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │ {                                                                      │   │
│  │   "type": "function",                                                 │   │
│  │   "function": {                  ◄── FunctionDefinition               │   │
│  │     "name": "file-read",         ◄── FunctionDefinition.Name          │   │
│  │     "description": "Read the...",◄── FunctionDefinition.Description   │   │
│  │     "parameters": {              ◄── FunctionDefinition.Parameters    │   │
│  │       "type": "object",                                               │   │
│  │       "properties": {...},                                            │   │
│  │       "required": [...]                                               │   │
│  │     }                                                                  │   │
│  │   }                                                                    │   │
│  │ }                                                                      │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Generated from ITool:                                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                                                                        │   │
│  │  ITool.Id           ─────►  FunctionDefinition.Name                   │   │
│  │  ITool.Description  ─────►  FunctionDefinition.Description            │   │
│  │  ITool.InputSchema  ─────►  FunctionDefinition.Parameters             │   │
│  │                                                                        │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. IToolRegistry.cs

**Location**: `src/AIntern.Core/Interfaces/IToolRegistry.cs`

```csharp
namespace AIntern.Core.Interfaces;

using AIntern.Core.Tools;

/// <summary>
/// Registry for managing available tools.
/// </summary>
/// <remarks>
/// <para>
/// The tool registry is the central store for all tools that can be invoked
/// by the AI agent. It provides:
/// </para>
/// <list type="bullet">
/// <item>Tool registration and unregistration</item>
/// <item>Tool lookup by ID</item>
/// <item>Filtered queries by category, risk level, and tags</item>
/// <item>Context-aware availability filtering</item>
/// <item>Function definition generation for LLM APIs</item>
/// </list>
/// <para>
/// The registry should be registered as a singleton in the DI container
/// and populated during application startup.
/// </para>
/// </remarks>
public interface IToolRegistry
{
    #region Properties

    /// <summary>
    /// Get all registered tools.
    /// </summary>
    /// <remarks>
    /// Returns all tools regardless of availability status.
    /// Use <see cref="GetAvailableTools"/> for filtered results.
    /// </remarks>
    IReadOnlyList<ITool> Tools { get; }

    /// <summary>
    /// Get the count of registered tools.
    /// </summary>
    int Count { get; }

    #endregion

    #region Registration

    /// <summary>
    /// Register a tool.
    /// </summary>
    /// <remarks>
    /// Throws <see cref="InvalidOperationException"/> if a tool with the
    /// same ID is already registered. Use <see cref="TryRegisterTool"/>
    /// for non-throwing registration.
    /// </remarks>
    /// <param name="tool">Tool to register.</param>
    /// <exception cref="InvalidOperationException">Tool ID already registered.</exception>
    void RegisterTool(ITool tool);

    /// <summary>
    /// Try to register a tool.
    /// </summary>
    /// <remarks>
    /// Returns false if a tool with the same ID is already registered.
    /// </remarks>
    /// <param name="tool">Tool to register.</param>
    /// <returns>True if registered, false if ID already exists.</returns>
    bool TryRegisterTool(ITool tool);

    /// <summary>
    /// Unregister a tool by ID.
    /// </summary>
    /// <remarks>
    /// Returns false if no tool with the given ID exists.
    /// </remarks>
    /// <param name="toolId">ID of the tool to unregister.</param>
    /// <returns>True if unregistered, false if not found.</returns>
    bool UnregisterTool(string toolId);

    #endregion

    #region Lookup

    /// <summary>
    /// Get a tool by ID.
    /// </summary>
    /// <param name="toolId">Tool ID to look up.</param>
    /// <returns>The tool, or null if not found.</returns>
    ITool? GetTool(string toolId);

    /// <summary>
    /// Check if a tool is registered.
    /// </summary>
    /// <param name="toolId">Tool ID to check.</param>
    /// <returns>True if a tool with this ID is registered.</returns>
    bool HasTool(string toolId);

    #endregion

    #region Filtering

    /// <summary>
    /// Get available tools with optional context filtering.
    /// </summary>
    /// <remarks>
    /// <para>
    /// Returns tools that are:
    /// </para>
    /// <list type="bullet">
    /// <item>Registered in the registry</item>
    /// <item>Report <see cref="ITool.IsAvailable"/> as true</item>
    /// <item>Pass the context filters (if provided)</item>
    /// </list>
    /// </remarks>
    /// <param name="context">Optional filtering context.</param>
    /// <returns>List of available tools.</returns>
    IReadOnlyList<ITool> GetAvailableTools(ToolAvailabilityContext? context = null);

    /// <summary>
    /// Get tools by category.
    /// </summary>
    /// <remarks>
    /// Only returns available tools (IsAvailable == true).
    /// </remarks>
    /// <param name="category">Category to filter by.</param>
    /// <returns>Tools in the specified category.</returns>
    IReadOnlyList<ITool> GetToolsByCategory(ToolCategory category);

    /// <summary>
    /// Get tools by tag.
    /// </summary>
    /// <remarks>
    /// Returns tools that have the specified tag. Only returns available tools.
    /// </remarks>
    /// <param name="tag">Tag to filter by.</param>
    /// <returns>Tools with the specified tag.</returns>
    IReadOnlyList<ITool> GetToolsByTag(string tag);

    /// <summary>
    /// Get tools up to a maximum risk level.
    /// </summary>
    /// <remarks>
    /// Returns available tools where DefaultRiskLevel &lt;= maxRiskLevel.
    /// </remarks>
    /// <param name="maxRiskLevel">Maximum risk level to include.</param>
    /// <returns>Tools at or below the risk level.</returns>
    IReadOnlyList<ITool> GetToolsByRiskLevel(RiskLevel maxRiskLevel);

    /// <summary>
    /// Search tools by query string.
    /// </summary>
    /// <remarks>
    /// Searches across:
    /// <list type="bullet">
    /// <item>Tool ID</item>
    /// <item>Tool name</item>
    /// <item>Tool description</item>
    /// <item>Tool tags</item>
    /// </list>
    /// Returns available tools that match any of these fields.
    /// </remarks>
    /// <param name="query">Search query.</param>
    /// <returns>Matching tools.</returns>
    IReadOnlyList<ITool> SearchTools(string query);

    #endregion

    #region Function Definitions

    /// <summary>
    /// Get function definitions for LLM API.
    /// </summary>
    /// <remarks>
    /// <para>
    /// Generates function definitions in the format expected by LLM APIs
    /// (e.g., OpenAI function calling format). Only includes available tools
    /// that pass the context filters.
    /// </para>
    /// <para>
    /// The returned definitions can be passed directly to the LLM API.
    /// </para>
    /// </remarks>
    /// <param name="context">Optional filtering context.</param>
    /// <returns>Function definitions for available tools.</returns>
    IReadOnlyList<FunctionDefinition> GetFunctionDefinitions(ToolAvailabilityContext? context = null);

    /// <summary>
    /// Get function definition for a specific tool.
    /// </summary>
    /// <param name="toolId">Tool ID.</param>
    /// <returns>Function definition, or null if tool not found.</returns>
    FunctionDefinition? GetFunctionDefinition(string toolId);

    #endregion

    #region Events

    /// <summary>
    /// Event raised when the registry changes.
    /// </summary>
    /// <remarks>
    /// Raised when a tool is added, removed, or updated.
    /// Useful for invalidating cached function definitions.
    /// </remarks>
    event EventHandler<ToolRegistryChangedEventArgs>? ToolsChanged;

    #endregion
}
```

### 2. ToolAvailabilityContext.cs

**Location**: `src/AIntern.Core/Tools/ToolAvailabilityContext.cs`

```csharp
namespace AIntern.Core.Tools;

/// <summary>
/// Context for filtering available tools.
/// </summary>
/// <remarks>
/// <para>
/// The availability context allows filtering tools based on:
/// </para>
/// <list type="bullet">
/// <item><b>Whitelist/Blacklist</b>: Explicit tool ID inclusion/exclusion</item>
/// <item><b>Risk Level</b>: Maximum allowed risk level</item>
/// <item><b>Categories</b>: Include or exclude tool categories</item>
/// <item><b>Tags</b>: Require specific tags</item>
/// <item><b>Context</b>: Filter based on available resources (workspace, terminal, etc.)</item>
/// </list>
/// <para>
/// Filters are applied in order:
/// </para>
/// <list type="number">
/// <item>Whitelist (if set, only those tools)</item>
/// <item>Blacklist (remove specific tools)</item>
/// <item>Risk level filter</item>
/// <item>Category filters</item>
/// <item>Tag filters</item>
/// <item>Context availability filters</item>
/// </list>
/// </remarks>
public sealed class ToolAvailabilityContext
{
    #region Whitelist/Blacklist

    /// <summary>
    /// Tool IDs to include (whitelist).
    /// </summary>
    /// <remarks>
    /// If set, only tools in this set are considered.
    /// Other filters are still applied.
    /// </remarks>
    public IReadOnlySet<string>? EnabledToolIds { get; init; }

    /// <summary>
    /// Tool IDs to exclude (blacklist).
    /// </summary>
    /// <remarks>
    /// Tools in this set are always excluded, even if in the whitelist.
    /// </remarks>
    public IReadOnlySet<string>? DisabledToolIds { get; init; }

    #endregion

    #region Risk Filtering

    /// <summary>
    /// Maximum risk level to include.
    /// </summary>
    /// <remarks>
    /// Tools with DefaultRiskLevel &gt; MaxRiskLevel are excluded.
    /// </remarks>
    public RiskLevel? MaxRiskLevel { get; init; }

    #endregion

    #region Category Filtering

    /// <summary>
    /// Categories to include.
    /// </summary>
    /// <remarks>
    /// If set, only tools in these categories are included.
    /// </remarks>
    public IReadOnlySet<ToolCategory>? IncludedCategories { get; init; }

    /// <summary>
    /// Categories to exclude.
    /// </summary>
    /// <remarks>
    /// Tools in these categories are excluded.
    /// </remarks>
    public IReadOnlySet<ToolCategory>? ExcludedCategories { get; init; }

    #endregion

    #region Tag Filtering

    /// <summary>
    /// Required tags.
    /// </summary>
    /// <remarks>
    /// If set, only tools that have ALL of these tags are included.
    /// </remarks>
    public IReadOnlySet<string>? RequiredTags { get; init; }

    #endregion

    #region Context Availability

    /// <summary>
    /// Whether a workspace is open.
    /// </summary>
    /// <remarks>
    /// When false, tools in the Workspace category are excluded.
    /// </remarks>
    public bool HasWorkspace { get; init; } = true;

    /// <summary>
    /// Whether a terminal is available.
    /// </summary>
    /// <remarks>
    /// When false, tools in the Terminal category are excluded.
    /// </remarks>
    public bool HasTerminal { get; init; } = true;

    /// <summary>
    /// Whether an editor is available.
    /// </summary>
    /// <remarks>
    /// When false, tools in the Editor category are excluded.
    /// </remarks>
    public bool HasEditor { get; init; } = true;

    /// <summary>
    /// Whether a Git repository is available.
    /// </summary>
    /// <remarks>
    /// When false, tools in the Git category are excluded.
    /// </remarks>
    public bool HasGitRepository { get; init; } = true;

    #endregion

    #region Factory Methods

    /// <summary>
    /// Create a default context (all tools available).
    /// </summary>
    public static ToolAvailabilityContext Default => new();

    /// <summary>
    /// Create a context with no workspace.
    /// </summary>
    public static ToolAvailabilityContext NoWorkspace => new()
    {
        HasWorkspace = false,
        HasGitRepository = false
    };

    /// <summary>
    /// Create a context with only safe tools.
    /// </summary>
    public static ToolAvailabilityContext SafeOnly => new()
    {
        MaxRiskLevel = RiskLevel.Safe
    };

    /// <summary>
    /// Create a context with only low-risk tools.
    /// </summary>
    public static ToolAvailabilityContext LowRiskOnly => new()
    {
        MaxRiskLevel = RiskLevel.Low
    };

    /// <summary>
    /// Create a context with only file system tools.
    /// </summary>
    public static ToolAvailabilityContext FileSystemOnly => new()
    {
        IncludedCategories = new HashSet<ToolCategory> { ToolCategory.FileSystem }
    };

    /// <summary>
    /// Create a context with only read-only tools.
    /// </summary>
    public static ToolAvailabilityContext ReadOnly => new()
    {
        RequiredTags = new HashSet<string> { "read-only" }
    };

    /// <summary>
    /// Create a builder for custom contexts.
    /// </summary>
    public static ToolAvailabilityContextBuilder Create() => new();

    #endregion

    /// <summary>
    /// Create a copy with modified properties.
    /// </summary>
    public ToolAvailabilityContext With(
        IReadOnlySet<string>? enabledToolIds = null,
        IReadOnlySet<string>? disabledToolIds = null,
        RiskLevel? maxRiskLevel = null,
        bool? hasWorkspace = null,
        bool? hasTerminal = null,
        bool? hasEditor = null,
        bool? hasGitRepository = null)
    {
        return new ToolAvailabilityContext
        {
            EnabledToolIds = enabledToolIds ?? EnabledToolIds,
            DisabledToolIds = disabledToolIds ?? DisabledToolIds,
            MaxRiskLevel = maxRiskLevel ?? MaxRiskLevel,
            IncludedCategories = IncludedCategories,
            ExcludedCategories = ExcludedCategories,
            RequiredTags = RequiredTags,
            HasWorkspace = hasWorkspace ?? HasWorkspace,
            HasTerminal = hasTerminal ?? HasTerminal,
            HasEditor = hasEditor ?? HasEditor,
            HasGitRepository = hasGitRepository ?? HasGitRepository
        };
    }
}

/// <summary>
/// Builder for <see cref="ToolAvailabilityContext"/>.
/// </summary>
public sealed class ToolAvailabilityContextBuilder
{
    private HashSet<string>? _enabledToolIds;
    private HashSet<string>? _disabledToolIds;
    private RiskLevel? _maxRiskLevel;
    private HashSet<ToolCategory>? _includedCategories;
    private HashSet<ToolCategory>? _excludedCategories;
    private HashSet<string>? _requiredTags;
    private bool _hasWorkspace = true;
    private bool _hasTerminal = true;
    private bool _hasEditor = true;
    private bool _hasGitRepository = true;

    /// <summary>
    /// Enable specific tools (whitelist).
    /// </summary>
    public ToolAvailabilityContextBuilder EnableTools(params string[] toolIds)
    {
        _enabledToolIds ??= new HashSet<string>();
        foreach (var id in toolIds)
            _enabledToolIds.Add(id);
        return this;
    }

    /// <summary>
    /// Disable specific tools (blacklist).
    /// </summary>
    public ToolAvailabilityContextBuilder DisableTools(params string[] toolIds)
    {
        _disabledToolIds ??= new HashSet<string>();
        foreach (var id in toolIds)
            _disabledToolIds.Add(id);
        return this;
    }

    /// <summary>
    /// Set maximum risk level.
    /// </summary>
    public ToolAvailabilityContextBuilder WithMaxRiskLevel(RiskLevel level)
    {
        _maxRiskLevel = level;
        return this;
    }

    /// <summary>
    /// Include only specific categories.
    /// </summary>
    public ToolAvailabilityContextBuilder IncludeCategories(params ToolCategory[] categories)
    {
        _includedCategories ??= new HashSet<ToolCategory>();
        foreach (var cat in categories)
            _includedCategories.Add(cat);
        return this;
    }

    /// <summary>
    /// Exclude specific categories.
    /// </summary>
    public ToolAvailabilityContextBuilder ExcludeCategories(params ToolCategory[] categories)
    {
        _excludedCategories ??= new HashSet<ToolCategory>();
        foreach (var cat in categories)
            _excludedCategories.Add(cat);
        return this;
    }

    /// <summary>
    /// Require specific tags.
    /// </summary>
    public ToolAvailabilityContextBuilder RequireTags(params string[] tags)
    {
        _requiredTags ??= new HashSet<string>();
        foreach (var tag in tags)
            _requiredTags.Add(tag);
        return this;
    }

    /// <summary>
    /// Set workspace availability.
    /// </summary>
    public ToolAvailabilityContextBuilder WithWorkspace(bool hasWorkspace)
    {
        _hasWorkspace = hasWorkspace;
        return this;
    }

    /// <summary>
    /// Set terminal availability.
    /// </summary>
    public ToolAvailabilityContextBuilder WithTerminal(bool hasTerminal)
    {
        _hasTerminal = hasTerminal;
        return this;
    }

    /// <summary>
    /// Set editor availability.
    /// </summary>
    public ToolAvailabilityContextBuilder WithEditor(bool hasEditor)
    {
        _hasEditor = hasEditor;
        return this;
    }

    /// <summary>
    /// Set Git repository availability.
    /// </summary>
    public ToolAvailabilityContextBuilder WithGitRepository(bool hasGitRepository)
    {
        _hasGitRepository = hasGitRepository;
        return this;
    }

    /// <summary>
    /// Build the context.
    /// </summary>
    public ToolAvailabilityContext Build() => new()
    {
        EnabledToolIds = _enabledToolIds,
        DisabledToolIds = _disabledToolIds,
        MaxRiskLevel = _maxRiskLevel,
        IncludedCategories = _includedCategories,
        ExcludedCategories = _excludedCategories,
        RequiredTags = _requiredTags,
        HasWorkspace = _hasWorkspace,
        HasTerminal = _hasTerminal,
        HasEditor = _hasEditor,
        HasGitRepository = _hasGitRepository
    };

    /// <summary>
    /// Implicit conversion to context.
    /// </summary>
    public static implicit operator ToolAvailabilityContext(ToolAvailabilityContextBuilder builder) =>
        builder.Build();
}
```

### 3. FunctionDefinition.cs

**Location**: `src/AIntern.Core/Tools/FunctionDefinition.cs`

```csharp
namespace AIntern.Core.Tools;

using System.Text.Json;
using System.Text.Json.Serialization;

/// <summary>
/// Function definition for LLM function calling APIs.
/// </summary>
/// <remarks>
/// <para>
/// Represents a function that can be called by the LLM. The format is
/// compatible with the OpenAI function calling specification.
/// </para>
/// <para>
/// Function definitions are generated from <see cref="ITool"/> instances
/// using <see cref="FromTool"/>.
/// </para>
/// </remarks>
public sealed class FunctionDefinition
{
    /// <summary>
    /// Function name (tool ID).
    /// </summary>
    /// <remarks>
    /// Must match the tool ID exactly. Used by the LLM to invoke the tool.
    /// </remarks>
    [JsonPropertyName("name")]
    public string Name { get; init; } = string.Empty;

    /// <summary>
    /// Function description.
    /// </summary>
    /// <remarks>
    /// Detailed description for the LLM to understand when and how to use
    /// this function.
    /// </remarks>
    [JsonPropertyName("description")]
    public string Description { get; init; } = string.Empty;

    /// <summary>
    /// Parameter schema.
    /// </summary>
    /// <remarks>
    /// JSON Schema defining the expected parameters.
    /// </remarks>
    [JsonPropertyName("parameters")]
    public JsonSchema Parameters { get; init; } = JsonSchema.Empty;

    /// <summary>
    /// Whether this function can operate without parameters.
    /// </summary>
    /// <remarks>
    /// True when the schema has no required parameters.
    /// </remarks>
    [JsonIgnore]
    public bool CanCallWithoutParameters =>
        Parameters.Required.Count == 0;

    #region Factory Methods

    /// <summary>
    /// Create a function definition from a tool.
    /// </summary>
    /// <param name="tool">Tool to create definition from.</param>
    /// <returns>Function definition for the tool.</returns>
    public static FunctionDefinition FromTool(ITool tool) => new()
    {
        Name = tool.Id,
        Description = tool.Description,
        Parameters = tool.InputSchema
    };

    /// <summary>
    /// Create a function definition from a tool with enhanced description.
    /// </summary>
    /// <param name="tool">Tool to create definition from.</param>
    /// <param name="additionalContext">Additional context to append to description.</param>
    /// <returns>Function definition with enhanced description.</returns>
    public static FunctionDefinition FromToolWithContext(ITool tool, string additionalContext) => new()
    {
        Name = tool.Id,
        Description = $"{tool.Description}\n\n{additionalContext}",
        Parameters = tool.InputSchema
    };

    #endregion

    #region Serialization

    private static readonly JsonSerializerOptions _serializerOptions = new()
    {
        WriteIndented = false,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    private static readonly JsonSerializerOptions _prettySerializerOptions = new()
    {
        WriteIndented = true,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    /// <summary>
    /// Serialize to JSON.
    /// </summary>
    /// <returns>Compact JSON string.</returns>
    public string ToJson() => JsonSerializer.Serialize(this, _serializerOptions);

    /// <summary>
    /// Serialize to indented JSON.
    /// </summary>
    /// <returns>Pretty-printed JSON string.</returns>
    public string ToPrettyJson() => JsonSerializer.Serialize(this, _prettySerializerOptions);

    /// <summary>
    /// Serialize to OpenAI tool format.
    /// </summary>
    /// <returns>JSON object with type and function fields.</returns>
    public string ToOpenAIToolJson()
    {
        var toolObj = new
        {
            type = "function",
            function = this
        };
        return JsonSerializer.Serialize(toolObj, _serializerOptions);
    }

    /// <summary>
    /// Serialize multiple definitions to OpenAI tools array.
    /// </summary>
    /// <param name="definitions">Function definitions.</param>
    /// <returns>JSON array of tool objects.</returns>
    public static string ToOpenAIToolsJson(IEnumerable<FunctionDefinition> definitions)
    {
        var tools = definitions.Select(d => new
        {
            type = "function",
            function = d
        });
        return JsonSerializer.Serialize(tools, _serializerOptions);
    }

    #endregion

    /// <inheritdoc />
    public override string ToString() => $"FunctionDefinition({Name})";
}
```

### 4. ToolRegistryChangedEventArgs.cs

**Location**: `src/AIntern.Core/Tools/ToolRegistryChangedEventArgs.cs`

```csharp
namespace AIntern.Core.Tools;

/// <summary>
/// Event arguments for tool registry changes.
/// </summary>
/// <remarks>
/// Raised when tools are added, removed, or updated in the registry.
/// Useful for invalidating cached function definitions.
/// </remarks>
public sealed class ToolRegistryChangedEventArgs : EventArgs
{
    /// <summary>
    /// Type of change that occurred.
    /// </summary>
    public ToolRegistryChangeType ChangeType { get; init; }

    /// <summary>
    /// The tool that was affected.
    /// </summary>
    public ITool Tool { get; init; } = null!;

    /// <summary>
    /// Timestamp of the change.
    /// </summary>
    public DateTime Timestamp { get; init; } = DateTime.UtcNow;

    #region Factory Methods

    /// <summary>
    /// Create event args for tool added.
    /// </summary>
    public static ToolRegistryChangedEventArgs Added(ITool tool) => new()
    {
        ChangeType = ToolRegistryChangeType.Added,
        Tool = tool
    };

    /// <summary>
    /// Create event args for tool removed.
    /// </summary>
    public static ToolRegistryChangedEventArgs Removed(ITool tool) => new()
    {
        ChangeType = ToolRegistryChangeType.Removed,
        Tool = tool
    };

    /// <summary>
    /// Create event args for tool updated.
    /// </summary>
    public static ToolRegistryChangedEventArgs Updated(ITool tool) => new()
    {
        ChangeType = ToolRegistryChangeType.Updated,
        Tool = tool
    };

    #endregion
}

/// <summary>
/// Type of registry change.
/// </summary>
public enum ToolRegistryChangeType
{
    /// <summary>
    /// A tool was added to the registry.
    /// </summary>
    Added,

    /// <summary>
    /// A tool was removed from the registry.
    /// </summary>
    Removed,

    /// <summary>
    /// A tool was updated (re-registered with same ID).
    /// </summary>
    Updated
}
```

---

## Directory Structure

```
src/AIntern.Core/
├── Interfaces/
│   └── IToolRegistry.cs                   (NEW)
└── Tools/
    ├── ToolAvailabilityContext.cs         (NEW)
    ├── FunctionDefinition.cs              (NEW)
    └── ToolRegistryChangedEventArgs.cs    (NEW)
```

---

## Unit Test Plan

| Test Class | Test | Description |
|------------|------|-------------|
| **ToolAvailabilityContextTests** | | |
| | `Default_HasAllFlagsTrue` | Default context allows all |
| | `NoWorkspace_DisablesWorkspaceAndGit` | Factory method |
| | `SafeOnly_SetsMaxRiskLevel` | Factory method |
| | `With_CreatesModifiedCopy` | Immutable copy |
| | `Builder_EnableTools_AddsToWhitelist` | Builder whitelist |
| | `Builder_DisableTools_AddsToBlacklist` | Builder blacklist |
| | `Builder_WithMaxRiskLevel_SetsLevel` | Builder risk |
| | `Builder_IncludeCategories_SetsCategories` | Builder include |
| | `Builder_ExcludeCategories_SetsCategories` | Builder exclude |
| | `Builder_RequireTags_SetsTags` | Builder tags |
| | `Builder_ImplicitConversion_Works` | Implicit conversion |
| **FunctionDefinitionTests** | | |
| | `FromTool_SetsName` | Name from tool ID |
| | `FromTool_SetsDescription` | Description from tool |
| | `FromTool_SetsParameters` | Schema from tool |
| | `CanCallWithoutParameters_NoRequired_ReturnsTrue` | No required params |
| | `CanCallWithoutParameters_HasRequired_ReturnsFalse` | Has required params |
| | `ToJson_ProducesValidJson` | JSON serialization |
| | `ToPrettyJson_IsIndented` | Pretty printing |
| | `ToOpenAIToolJson_HasTypeAndFunction` | OpenAI format |
| | `ToOpenAIToolsJson_ProducesArray` | Array format |
| **ToolRegistryChangedEventArgsTests** | | |
| | `Added_SetsChangeType` | Factory method |
| | `Removed_SetsChangeType` | Factory method |
| | `Updated_SetsChangeType` | Factory method |
| | `Timestamp_IsPopulated` | Has timestamp |

**Total Tests**: 24

---

## Usage Examples

### Creating Availability Context

```csharp
// Default context (all tools)
var all = ToolAvailabilityContext.Default;

// Safe tools only
var safe = ToolAvailabilityContext.SafeOnly;

// Custom context using builder
var custom = ToolAvailabilityContext.Create()
    .WithMaxRiskLevel(RiskLevel.Medium)
    .ExcludeCategories(ToolCategory.Network)
    .DisableTools("terminal-execute")
    .WithWorkspace(true)
    .WithTerminal(false)
    .Build();
```

### Getting Function Definitions

```csharp
// Get all available functions
var allFunctions = registry.GetFunctionDefinitions();

// Get functions with context
var context = ToolAvailabilityContext.Create()
    .WithMaxRiskLevel(RiskLevel.Low)
    .Build();
var safeFunctions = registry.GetFunctionDefinitions(context);

// Convert to OpenAI format
var toolsJson = FunctionDefinition.ToOpenAIToolsJson(safeFunctions);
```

---

## File Summary

### Files to Create

| File | Location | Lines | Purpose |
|------|----------|-------|---------|
| `IToolRegistry.cs` | `Core/Interfaces/` | ~130 | Registry interface |
| `ToolAvailabilityContext.cs` | `Core/Tools/` | ~280 | Context and builder |
| `FunctionDefinition.cs` | `Core/Tools/` | ~150 | Function definition |
| `ToolRegistryChangedEventArgs.cs` | `Core/Tools/` | ~80 | Event args |
| **Total** | | **~640** | |

### Files to Modify

None.

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | `IToolRegistry` defines all required operations |
| AC-2 | `ToolAvailabilityContext` supports all filter types |
| AC-3 | `ToolAvailabilityContextBuilder` provides fluent API |
| AC-4 | `FunctionDefinition.FromTool` creates valid definitions |
| AC-5 | `FunctionDefinition.ToOpenAIToolJson` produces correct format |
| AC-6 | `ToolRegistryChangedEventArgs` supports all change types |
| AC-7 | Factory methods work correctly for all types |
| AC-8 | All 24 unit tests pass |

---

## Changelog Entry

```markdown
## v0.6.1g - Tool Registry Interface

### Added
- `IToolRegistry` interface with:
  - Registration: RegisterTool, TryRegisterTool, UnregisterTool
  - Lookup: GetTool, HasTool
  - Filtering: GetAvailableTools, GetToolsByCategory, GetToolsByTag,
    GetToolsByRiskLevel, SearchTools
  - Function definitions: GetFunctionDefinitions, GetFunctionDefinition
  - Events: ToolsChanged

- `ToolAvailabilityContext` with:
  - Whitelist/blacklist: EnabledToolIds, DisabledToolIds
  - Risk filtering: MaxRiskLevel
  - Category filtering: IncludedCategories, ExcludedCategories
  - Tag filtering: RequiredTags
  - Context availability: HasWorkspace, HasTerminal, HasEditor, HasGitRepository
  - Factory methods: Default, NoWorkspace, SafeOnly, LowRiskOnly, ReadOnly
  - Fluent builder pattern

- `FunctionDefinition` with:
  - OpenAI function calling format: Name, Description, Parameters
  - Factory method: FromTool, FromToolWithContext
  - Serialization: ToJson, ToPrettyJson, ToOpenAIToolJson, ToOpenAIToolsJson

- `ToolRegistryChangedEventArgs` with:
  - Change types: Added, Removed, Updated
  - Factory methods for each change type
```

---

## Timeline Estimate

| Task | Estimated Effort |
|------|------------------|
| IToolRegistry | 0.15 day |
| ToolAvailabilityContext + Builder | 0.35 day |
| FunctionDefinition | 0.2 day |
| ToolRegistryChangedEventArgs | 0.1 day |
| Unit Tests | 0.3 day |
| **Total** | **1.1 days** |
