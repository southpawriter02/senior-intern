# Design Specification: AIntern v0.6.4d "IPermissionManager Interface"

## Overview

**Version**: v0.6.4d
**Parent**: v0.6.4 Safety & Approval
**Focus**: Comprehensive interface definition for the permission management system

### Purpose

Define the complete interface for permission management that:
1. Provides permission checking API for tool calls
2. Supports approval request workflow with UI integration
3. Manages remembered decisions (session and persistent)
4. Exposes policy management operations
5. Provides audit log access for querying
6. Exposes rate limit status monitoring
7. Uses events for loose coupling with UI layer

### Dependencies

**From v0.6.4a (Permission Policy Models)**:
- `PermissionPolicy`, `PolicyMode`
- `ToolPermissionOverride`, `OverrideAction`

**From v0.6.4b (Risk Classification Engine)**:
- `RiskClassificationResult`, `RiskFactor`

**From v0.6.4c (Permission Check System)**:
- `PermissionCheckResult`, `PermissionSource`
- `ApprovalDecision`, `RememberOption`
- `RateLimitStatus`

**From v0.6.1 (Tool Framework)**:
- `ITool`, `ToolCallRequest`

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.6.4d IPermissionManager Architecture                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  IPermissionManager                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Permission Checking                                                │  │ │
│  │  │ ├── CheckPermissionAsync(request, tool)                           │  │ │
│  │  │ │   → PermissionCheckResult (Allowed/NeedsApproval/Blocked)       │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ └── ClassifyRisk(request, tool)                                   │  │ │
│  │  │     → RiskClassificationResult                                    │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Approval Workflow                                                  │  │ │
│  │  │ ├── RequestApprovalAsync(request, classification, ct)             │  │ │
│  │  │ │   → ApprovalDecision                                            │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ ├── event ApprovalRequested                                       │  │ │
│  │  │ │   → ApprovalRequestedEventArgs (raised for UI to handle)        │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ └── SubmitDecision(requestId, decision)                           │  │ │
│  │  │     → Completes pending approval request                          │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Decision Memory                                                    │  │ │
│  │  │ ├── RememberDecisionAsync(toolId, decision)                       │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ ├── ClearRememberedDecisionsAsync(toolId?)                        │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ └── GetRememberedDecisions()                                      │  │ │
│  │  │     → IReadOnlyList<CachedDecision>                               │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Policy Management                                                  │  │ │
│  │  │ ├── GetPolicy() → PermissionPolicy                                │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ ├── UpdatePolicyAsync(policy)                                     │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ └── event PolicyChanged                                           │  │ │
│  │  │     → PolicyChangedEventArgs                                      │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Audit & Monitoring                                                 │  │ │
│  │  │ ├── RecordAuditAsync(entry)                                       │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ ├── GetAuditLogAsync(query, ct)                                   │  │ │
│  │  │ │   → IReadOnlyList<AuditLogEntry>                                │  │ │
│  │  │ │                                                                  │  │ │
│  │  │ └── GetRateLimitStatus() → RateLimitStatus                        │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Event-Based Approval Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    Approval Request Event Flow                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  AgentService                        PermissionManager              UI Layer │
│      │                                      │                           │    │
│      │ CheckPermissionAsync()               │                           │    │
│      │─────────────────────────────────────>│                           │    │
│      │                                      │                           │    │
│      │  PermissionCheckResult               │                           │    │
│      │  { RequiresApproval = true }         │                           │    │
│      │<─────────────────────────────────────│                           │    │
│      │                                      │                           │    │
│      │ RequestApprovalAsync()               │                           │    │
│      │─────────────────────────────────────>│                           │    │
│      │                                      │                           │    │
│      │                                      │ ApprovalRequested event   │    │
│      │                                      │──────────────────────────>│    │
│      │                                      │                           │    │
│      │                                      │                  [Show Dialog] │
│      │                    (awaiting)        │                           │    │
│      │                                      │                           │    │
│      │                                      │         SubmitDecision()  │    │
│      │                                      │<──────────────────────────│    │
│      │                                      │                           │    │
│      │                                      │ Complete TCS              │    │
│      │  ApprovalDecision                    │                           │    │
│      │<─────────────────────────────────────│                           │    │
│      │                                      │                           │    │
│  [Execute or Skip based on decision]        │                           │    │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ApprovalRequestedEventArgs:                                                 │
│  ├── RequestId: Guid (unique for this request)                              │
│  ├── ToolRequest: ToolCallRequest                                           │
│  ├── Tool: ITool                                                            │
│  ├── Classification: RiskClassificationResult                               │
│  ├── DecisionTask: TaskCompletionSource<ApprovalDecision>                   │
│  ├── Timeout: TimeSpan                                                      │
│  └── RequestedAt: DateTime                                                  │
│                                                                              │
│  UI calls DecisionTask.SetResult(decision) to complete the approval.        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Policy Change Events

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       Policy Change Notification                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Settings UI                       PermissionManager           Subscribers   │
│      │                                    │                         │        │
│      │ UpdatePolicyAsync(newPolicy)       │                         │        │
│      │───────────────────────────────────>│                         │        │
│      │                                    │                         │        │
│      │                                    │ [Compare old/new]       │        │
│      │                                    │                         │        │
│      │                                    │ [Save to settings]      │        │
│      │                                    │                         │        │
│      │                                    │ PolicyChanged event     │        │
│      │                                    │────────────────────────>│        │
│      │                                    │                         │        │
│      │  (completed)                       │          [React to change]       │
│      │<───────────────────────────────────│                         │        │
│      │                                    │                         │        │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  PolicyChangedEventArgs:                                                     │
│  ├── OldPolicy: PermissionPolicy                                            │
│  ├── NewPolicy: PermissionPolicy                                            │
│  └── ChangeType: PolicyChangeType (flags enum)                              │
│      ├── Mode                                                               │
│      ├── Threshold                                                          │
│      ├── ToolOverrides                                                      │
│      ├── BlockedPatterns                                                    │
│      ├── ProtectedPaths                                                     │
│      ├── RateLimits                                                         │
│      └── Other                                                              │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. IPermissionManager.cs

**Location**: `src/SeniorIntern.Core/Interfaces/IPermissionManager.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Models.Permissions;
using SeniorIntern.Core.Tools;

/// <summary>
/// Manages permissions for tool execution.
/// Handles risk classification, approval workflows, and decision caching.
/// </summary>
/// <remarks>
/// <para>
/// The permission manager is the central coordinator for the safety system.
/// It integrates:
/// </para>
/// <list type="bullet">
/// <item>Risk classification</item>
/// <item>Rate limiting</item>
/// <item>Session and persistent decision caching</item>
/// <item>Policy evaluation</item>
/// <item>Audit logging</item>
/// </list>
/// <para>
/// UI layers subscribe to events for loose coupling.
/// </para>
/// </remarks>
public interface IPermissionManager
{
    #region Permission Checking

    /// <summary>
    /// Check if a tool call is allowed, requires approval, or is blocked.
    /// </summary>
    /// <param name="request">The tool call request to check.</param>
    /// <param name="tool">The tool being invoked.</param>
    /// <returns>Permission check result indicating the decision.</returns>
    /// <remarks>
    /// Evaluation order:
    /// <list type="number">
    /// <item>Rate limit check</item>
    /// <item>Policy mode check (Disabled → block)</item>
    /// <item>Risk classification</item>
    /// <item>Blocked tool/pattern check</item>
    /// <item>Trusted tool check</item>
    /// <item>Session cache check</item>
    /// <item>Persistent override check</item>
    /// <item>Policy mode evaluation (AutoApprove/AlwaysAsk/AskForRisky)</item>
    /// </list>
    /// </remarks>
    Task<PermissionCheckResult> CheckPermissionAsync(
        ToolCallRequest request,
        ITool tool);

    /// <summary>
    /// Classify the risk of a tool call without making a permission decision.
    /// </summary>
    /// <param name="request">The tool call request to classify.</param>
    /// <param name="tool">The tool being invoked.</param>
    /// <returns>Risk classification result.</returns>
    RiskClassificationResult ClassifyRisk(ToolCallRequest request, ITool tool);

    #endregion

    #region Approval Workflow

    /// <summary>
    /// Request approval from the user for a tool call.
    /// Returns when user approves, denies, or timeout occurs.
    /// </summary>
    /// <param name="request">The tool call request.</param>
    /// <param name="classificationResult">Risk classification result.</param>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>User's approval decision.</returns>
    /// <remarks>
    /// <para>
    /// This method raises the <see cref="ApprovalRequested"/> event and waits
    /// for the UI to call <see cref="SubmitDecision"/> or for timeout.
    /// </para>
    /// <para>
    /// Timeout is determined by <see cref="PermissionPolicy.ApprovalTimeoutSeconds"/>.
    /// </para>
    /// </remarks>
    Task<ApprovalDecision> RequestApprovalAsync(
        ToolCallRequest request,
        RiskClassificationResult classificationResult,
        CancellationToken ct = default);

    /// <summary>
    /// Submit a decision for a pending approval request.
    /// </summary>
    /// <param name="requestId">The approval request ID.</param>
    /// <param name="decision">The user's decision.</param>
    /// <remarks>
    /// Called by UI when user makes a decision in the approval dialog.
    /// </remarks>
    void SubmitDecision(Guid requestId, ApprovalDecision decision);

    /// <summary>
    /// Cancel a pending approval request.
    /// </summary>
    /// <param name="requestId">The approval request ID.</param>
    void CancelApproval(Guid requestId);

    /// <summary>
    /// Get pending approval requests.
    /// </summary>
    IReadOnlyList<ApprovalRequestedEventArgs> GetPendingApprovals();

    #endregion

    #region Decision Memory

    /// <summary>
    /// Remember a user's approval decision for future calls.
    /// </summary>
    /// <param name="toolId">Tool ID.</param>
    /// <param name="decision">The decision to remember.</param>
    /// <remarks>
    /// Based on <see cref="ApprovalDecision.RememberChoice"/>:
    /// <list type="bullet">
    /// <item><see cref="RememberOption.ForSession"/>: Stored in session cache</item>
    /// <item><see cref="RememberOption.Always"/>: Stored in settings file</item>
    /// </list>
    /// </remarks>
    Task RememberDecisionAsync(string toolId, ApprovalDecision decision);

    /// <summary>
    /// Clear remembered decisions.
    /// </summary>
    /// <param name="toolId">Optional tool ID to clear; null clears all.</param>
    Task ClearRememberedDecisionsAsync(string? toolId = null);

    /// <summary>
    /// Get all remembered decisions (session and persistent).
    /// </summary>
    IReadOnlyList<CachedDecision> GetRememberedDecisions();

    #endregion

    #region Policy Management

    /// <summary>
    /// Get the current permission policy.
    /// </summary>
    PermissionPolicy GetPolicy();

    /// <summary>
    /// Update the permission policy.
    /// </summary>
    /// <param name="policy">New policy settings.</param>
    /// <remarks>
    /// Raises <see cref="PolicyChanged"/> event after successful update.
    /// Policy is persisted to settings file.
    /// </remarks>
    Task UpdatePolicyAsync(PermissionPolicy policy);

    /// <summary>
    /// Update a specific tool override.
    /// </summary>
    /// <param name="override">The tool override to set.</param>
    Task SetToolOverrideAsync(ToolPermissionOverride @override);

    /// <summary>
    /// Remove a tool override.
    /// </summary>
    /// <param name="toolId">Tool ID to remove override for.</param>
    Task RemoveToolOverrideAsync(string toolId);

    /// <summary>
    /// Add a tool to the trusted list.
    /// </summary>
    /// <param name="toolId">Tool ID to trust.</param>
    Task TrustToolAsync(string toolId);

    /// <summary>
    /// Remove a tool from the trusted list.
    /// </summary>
    /// <param name="toolId">Tool ID to untrust.</param>
    Task UntrustToolAsync(string toolId);

    /// <summary>
    /// Add a tool to the blocked list.
    /// </summary>
    /// <param name="toolId">Tool ID to block.</param>
    Task BlockToolAsync(string toolId);

    /// <summary>
    /// Remove a tool from the blocked list.
    /// </summary>
    /// <param name="toolId">Tool ID to unblock.</param>
    Task UnblockToolAsync(string toolId);

    #endregion

    #region Audit & Monitoring

    /// <summary>
    /// Record a tool execution in the audit log.
    /// </summary>
    /// <param name="entry">Audit log entry.</param>
    Task RecordAuditAsync(AuditLogEntry entry);

    /// <summary>
    /// Query the audit log.
    /// </summary>
    /// <param name="query">Query parameters.</param>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>Matching audit log entries.</returns>
    Task<IReadOnlyList<AuditLogEntry>> GetAuditLogAsync(
        AuditLogQuery? query = null,
        CancellationToken ct = default);

    /// <summary>
    /// Get the count of audit log entries matching a query.
    /// </summary>
    Task<int> GetAuditLogCountAsync(AuditLogQuery? query = null);

    /// <summary>
    /// Get current rate limit status.
    /// </summary>
    RateLimitStatus GetRateLimitStatus();

    /// <summary>
    /// Reset rate limit counters.
    /// </summary>
    void ResetRateLimits();

    #endregion

    #region Events

    /// <summary>
    /// Event fired when approval is needed.
    /// UI should subscribe to show approval dialog.
    /// </summary>
    event EventHandler<ApprovalRequestedEventArgs>? ApprovalRequested;

    /// <summary>
    /// Event fired when policy changes.
    /// </summary>
    event EventHandler<PolicyChangedEventArgs>? PolicyChanged;

    /// <summary>
    /// Event fired when a decision is remembered.
    /// </summary>
    event EventHandler<DecisionRememberedEventArgs>? DecisionRemembered;

    #endregion
}
```

### 2. ApprovalRequestedEventArgs.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/ApprovalRequestedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using SeniorIntern.Core.Tools;

/// <summary>
/// Event arguments when approval is requested.
/// </summary>
/// <remarks>
/// <para>
/// UI subscribes to <see cref="IPermissionManager.ApprovalRequested"/> and
/// receives this event when a tool call requires user approval.
/// </para>
/// <para>
/// To complete the approval, UI calls <see cref="DecisionTask"/>.SetResult()
/// or <see cref="IPermissionManager.SubmitDecision"/>.
/// </para>
/// </remarks>
public sealed class ApprovalRequestedEventArgs : EventArgs
{
    /// <summary>
    /// Unique ID for this approval request.
    /// </summary>
    public Guid RequestId { get; init; }

    /// <summary>
    /// The tool call request.
    /// </summary>
    public ToolCallRequest ToolRequest { get; init; } = null!;

    /// <summary>
    /// The tool being invoked.
    /// </summary>
    public ITool Tool { get; init; } = null!;

    /// <summary>
    /// Risk classification result.
    /// </summary>
    public RiskClassificationResult Classification { get; init; } = null!;

    /// <summary>
    /// Task completion source for the approval decision.
    /// UI should call SetResult with the decision.
    /// </summary>
    /// <remarks>
    /// Alternative: Use <see cref="IPermissionManager.SubmitDecision"/>
    /// </remarks>
    public TaskCompletionSource<ApprovalDecision> DecisionTask { get; init; } = new();

    /// <summary>
    /// Timeout for the approval.
    /// </summary>
    public TimeSpan Timeout { get; init; }

    /// <summary>
    /// When the request was created.
    /// </summary>
    public DateTime RequestedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Conversation ID for context.
    /// </summary>
    public string? ConversationId { get; init; }

    /// <summary>
    /// Whether parameter editing is allowed.
    /// </summary>
    public bool AllowParameterEditing { get; init; }

    /// <summary>
    /// Whether to show detailed parameters.
    /// </summary>
    public bool ShowParameters { get; init; }

    /// <summary>
    /// Time remaining before timeout.
    /// </summary>
    public TimeSpan TimeRemaining =>
        Timeout - (DateTime.UtcNow - RequestedAt);

    /// <summary>
    /// Whether the request has timed out.
    /// </summary>
    public bool HasTimedOut => TimeRemaining <= TimeSpan.Zero;

    /// <summary>
    /// Approve the request.
    /// </summary>
    /// <param name="remember">How to remember this decision.</param>
    /// <param name="modifiedParams">Optional modified parameters.</param>
    public void Approve(
        RememberOption remember = RememberOption.None,
        System.Text.Json.JsonElement? modifiedParams = null)
    {
        DecisionTask.TrySetResult(ApprovalDecision.Approved(
            ToolRequest.ToolId,
            RequestId,
            remember,
            modifiedParams));
    }

    /// <summary>
    /// Deny the request.
    /// </summary>
    /// <param name="remember">How to remember this decision.</param>
    /// <param name="reason">Optional reason for denial.</param>
    public void Deny(
        RememberOption remember = RememberOption.None,
        string? reason = null)
    {
        DecisionTask.TrySetResult(ApprovalDecision.Denied(
            ToolRequest.ToolId,
            RequestId,
            remember,
            reason));
    }

    /// <summary>
    /// Cancel the request.
    /// </summary>
    public void Cancel()
    {
        DecisionTask.TrySetResult(ApprovalDecision.Cancelled(
            ToolRequest.ToolId,
            RequestId));
    }
}
```

### 3. PolicyChangedEventArgs.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/PolicyChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

/// <summary>
/// Event arguments when policy changes.
/// </summary>
public sealed class PolicyChangedEventArgs : EventArgs
{
    /// <summary>
    /// The previous policy.
    /// </summary>
    public PermissionPolicy OldPolicy { get; init; } = null!;

    /// <summary>
    /// The new policy.
    /// </summary>
    public PermissionPolicy NewPolicy { get; init; } = null!;

    /// <summary>
    /// What aspects of the policy changed.
    /// </summary>
    public PolicyChangeType ChangeType { get; init; }

    /// <summary>
    /// When the change occurred.
    /// </summary>
    public DateTime ChangedAt { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Who made the change (if available).
    /// </summary>
    public string? ChangedBy { get; init; }

    /// <summary>
    /// Check if a specific type of change occurred.
    /// </summary>
    public bool HasChange(PolicyChangeType type) =>
        (ChangeType & type) != PolicyChangeType.None;
}

/// <summary>
/// Types of policy changes.
/// </summary>
[Flags]
public enum PolicyChangeType
{
    /// <summary>No change.</summary>
    None = 0,

    /// <summary>Policy mode changed.</summary>
    Mode = 1,

    /// <summary>Approval threshold changed.</summary>
    Threshold = 2,

    /// <summary>Tool overrides changed.</summary>
    ToolOverrides = 4,

    /// <summary>Blocked patterns changed.</summary>
    BlockedPatterns = 8,

    /// <summary>Protected paths changed.</summary>
    ProtectedPaths = 16,

    /// <summary>Rate limits changed.</summary>
    RateLimits = 32,

    /// <summary>Blocked tools changed.</summary>
    BlockedTools = 64,

    /// <summary>Trusted tools changed.</summary>
    TrustedTools = 128,

    /// <summary>Audit settings changed.</summary>
    AuditSettings = 256,

    /// <summary>UI settings changed.</summary>
    UISettings = 512,

    /// <summary>Other/unspecified change.</summary>
    Other = 1024
}
```

### 4. DecisionRememberedEventArgs.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/DecisionRememberedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

/// <summary>
/// Event arguments when a decision is remembered.
/// </summary>
public sealed class DecisionRememberedEventArgs : EventArgs
{
    /// <summary>
    /// Tool ID the decision applies to.
    /// </summary>
    public string ToolId { get; init; } = string.Empty;

    /// <summary>
    /// The decision that was remembered.
    /// </summary>
    public ApprovalDecision Decision { get; init; } = null!;

    /// <summary>
    /// How the decision was remembered.
    /// </summary>
    public RememberOption RememberOption { get; init; }

    /// <summary>
    /// Whether this replaces a previous decision.
    /// </summary>
    public bool ReplacedExisting { get; init; }

    /// <summary>
    /// When the decision was remembered.
    /// </summary>
    public DateTime RememberedAt { get; init; } = DateTime.UtcNow;
}
```

### 5. AuditLogQuery.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/AuditLogQuery.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using SeniorIntern.Core.Tools;

/// <summary>
/// Query parameters for audit log searches.
/// </summary>
public sealed class AuditLogQuery
{
    /// <summary>
    /// Filter by tool ID.
    /// </summary>
    public string? ToolId { get; init; }

    /// <summary>
    /// Filter by conversation ID.
    /// </summary>
    public string? ConversationId { get; init; }

    /// <summary>
    /// Filter by decision type.
    /// </summary>
    public AuditDecision? Decision { get; init; }

    /// <summary>
    /// Filter by risk level (minimum).
    /// </summary>
    public RiskLevel? MinRiskLevel { get; init; }

    /// <summary>
    /// Filter by start date.
    /// </summary>
    public DateTime? FromDate { get; init; }

    /// <summary>
    /// Filter by end date.
    /// </summary>
    public DateTime? ToDate { get; init; }

    /// <summary>
    /// Maximum number of results.
    /// </summary>
    public int? Limit { get; init; }

    /// <summary>
    /// Number of results to skip (for pagination).
    /// </summary>
    public int? Offset { get; init; }

    /// <summary>
    /// Order by field.
    /// </summary>
    public AuditLogOrderBy OrderBy { get; init; } = AuditLogOrderBy.Timestamp;

    /// <summary>
    /// Order direction.
    /// </summary>
    public bool Descending { get; init; } = true;

    /// <summary>
    /// Whether to include entries with errors.
    /// </summary>
    public bool IncludeErrors { get; init; } = true;

    /// <summary>
    /// Search text (searches tool ID, parameters).
    /// </summary>
    public string? SearchText { get; init; }

    /// <summary>
    /// Create a query for today's entries.
    /// </summary>
    public static AuditLogQuery Today() => new()
    {
        FromDate = DateTime.UtcNow.Date,
        ToDate = DateTime.UtcNow.Date.AddDays(1)
    };

    /// <summary>
    /// Create a query for a specific tool.
    /// </summary>
    public static AuditLogQuery ForTool(string toolId) => new()
    {
        ToolId = toolId
    };

    /// <summary>
    /// Create a query for a specific conversation.
    /// </summary>
    public static AuditLogQuery ForConversation(string conversationId) => new()
    {
        ConversationId = conversationId
    };
}

/// <summary>
/// Fields to order audit log by.
/// </summary>
public enum AuditLogOrderBy
{
    /// <summary>Order by timestamp.</summary>
    Timestamp,

    /// <summary>Order by tool ID.</summary>
    ToolId,

    /// <summary>Order by risk level.</summary>
    RiskLevel,

    /// <summary>Order by decision.</summary>
    Decision
}

/// <summary>
/// Decision recorded in audit log.
/// </summary>
public enum AuditDecision
{
    /// <summary>Tool call was allowed.</summary>
    Allowed,

    /// <summary>Tool call was denied by user.</summary>
    Denied,

    /// <summary>Tool call was blocked by policy.</summary>
    Blocked,

    /// <summary>Tool call timed out waiting for approval.</summary>
    TimedOut,

    /// <summary>Tool call was cancelled.</summary>
    Cancelled,

    /// <summary>Tool call failed during execution.</summary>
    Error
}
```

### 6. AuditLogEntry.cs (Preview)

**Location**: `src/SeniorIntern.Core/Models/Permissions/AuditLogEntry.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using System.Text.Json;
using SeniorIntern.Core.Tools;

/// <summary>
/// An entry in the audit log.
/// </summary>
/// <remarks>
/// Full implementation in v0.6.4f. This is a preview of the interface.
/// </remarks>
public sealed class AuditLogEntry
{
    /// <summary>
    /// Unique ID for this entry.
    /// </summary>
    public Guid Id { get; init; } = Guid.NewGuid();

    /// <summary>
    /// When the tool call occurred.
    /// </summary>
    public DateTime Timestamp { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Tool ID that was invoked.
    /// </summary>
    public string ToolId { get; init; } = string.Empty;

    /// <summary>
    /// Tool name for display.
    /// </summary>
    public string ToolName { get; init; } = string.Empty;

    /// <summary>
    /// The decision made.
    /// </summary>
    public AuditDecision Decision { get; init; }

    /// <summary>
    /// Risk level at time of call.
    /// </summary>
    public RiskLevel RiskLevel { get; init; }

    /// <summary>
    /// Parameters passed to the tool (may be redacted).
    /// </summary>
    public JsonElement? Parameters { get; init; }

    /// <summary>
    /// Conversation ID for context.
    /// </summary>
    public string? ConversationId { get; init; }

    /// <summary>
    /// Source of the permission decision.
    /// </summary>
    public PermissionSource Source { get; init; }

    /// <summary>
    /// Error message if execution failed.
    /// </summary>
    public string? ErrorMessage { get; init; }

    /// <summary>
    /// Duration of tool execution (if completed).
    /// </summary>
    public TimeSpan? Duration { get; init; }
}
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `IPermissionManager.cs` | `Core/Interfaces/` | Main interface | ~220 |
| `ApprovalRequestedEventArgs.cs` | `Core/Models/Permissions/` | Approval event args | ~100 |
| `PolicyChangedEventArgs.cs` | `Core/Models/Permissions/` | Policy change event args | ~70 |
| `DecisionRememberedEventArgs.cs` | `Core/Models/Permissions/` | Decision remembered event | ~35 |
| `AuditLogQuery.cs` | `Core/Models/Permissions/` | Query model | ~95 |
| `AuditLogEntry.cs` | `Core/Models/Permissions/` | Audit entry (preview) | ~55 |

---

## Interface Method Summary

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    IPermissionManager Method Summary                          │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Permission Checking (2 methods):                                            │
│  ├── CheckPermissionAsync(request, tool) → PermissionCheckResult            │
│  └── ClassifyRisk(request, tool) → RiskClassificationResult                 │
│                                                                              │
│  Approval Workflow (4 methods):                                              │
│  ├── RequestApprovalAsync(request, classification, ct) → ApprovalDecision   │
│  ├── SubmitDecision(requestId, decision) → void                             │
│  ├── CancelApproval(requestId) → void                                       │
│  └── GetPendingApprovals() → IReadOnlyList<ApprovalRequestedEventArgs>      │
│                                                                              │
│  Decision Memory (3 methods):                                                │
│  ├── RememberDecisionAsync(toolId, decision) → Task                         │
│  ├── ClearRememberedDecisionsAsync(toolId?) → Task                          │
│  └── GetRememberedDecisions() → IReadOnlyList<CachedDecision>               │
│                                                                              │
│  Policy Management (8 methods):                                              │
│  ├── GetPolicy() → PermissionPolicy                                         │
│  ├── UpdatePolicyAsync(policy) → Task                                       │
│  ├── SetToolOverrideAsync(override) → Task                                  │
│  ├── RemoveToolOverrideAsync(toolId) → Task                                 │
│  ├── TrustToolAsync(toolId) → Task                                          │
│  ├── UntrustToolAsync(toolId) → Task                                        │
│  ├── BlockToolAsync(toolId) → Task                                          │
│  └── UnblockToolAsync(toolId) → Task                                        │
│                                                                              │
│  Audit & Monitoring (5 methods):                                             │
│  ├── RecordAuditAsync(entry) → Task                                         │
│  ├── GetAuditLogAsync(query, ct) → IReadOnlyList<AuditLogEntry>             │
│  ├── GetAuditLogCountAsync(query) → int                                     │
│  ├── GetRateLimitStatus() → RateLimitStatus                                 │
│  └── ResetRateLimits() → void                                               │
│                                                                              │
│  Events (3 events):                                                          │
│  ├── ApprovalRequested → ApprovalRequestedEventArgs                         │
│  ├── PolicyChanged → PolicyChangedEventArgs                                 │
│  └── DecisionRemembered → DecisionRememberedEventArgs                       │
│                                                                              │
│  Total: 22 methods + 3 events                                                │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `IPermissionManager_CheckPermission_ReturnsResult` | Interface contract |
| `ApprovalRequestedEventArgs_Approve_SetsResult` | Helper method |
| `ApprovalRequestedEventArgs_Deny_SetsResult` | Helper method |
| `ApprovalRequestedEventArgs_TimeRemaining_Calculates` | Timeout calculation |
| `PolicyChangedEventArgs_HasChange_WorksWithFlags` | Flag checking |
| `PolicyChangeType_Flags_CombineCorrectly` | Flag enum |
| `AuditLogQuery_Today_SetsCorrectDates` | Factory method |
| `AuditLogQuery_ForTool_SetsToolId` | Factory method |
| `DecisionRememberedEventArgs_HasCorrectFields` | Model properties |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | IPermissionManager defines complete contract |
| AC-2 | Approval workflow is event-based for UI integration |
| AC-3 | Policy updates notify subscribers |
| AC-4 | Audit log access is async and queryable |

---

## Changelog Entry

```markdown
## v0.6.4d - IPermissionManager Interface

### Added
- `IPermissionManager` interface with 22 methods and 3 events
  - Permission checking: CheckPermissionAsync, ClassifyRisk
  - Approval workflow: RequestApprovalAsync, SubmitDecision,
    CancelApproval, GetPendingApprovals
  - Decision memory: RememberDecisionAsync,
    ClearRememberedDecisionsAsync, GetRememberedDecisions
  - Policy management: GetPolicy, UpdatePolicyAsync,
    SetToolOverrideAsync, RemoveToolOverrideAsync,
    TrustToolAsync, UntrustToolAsync, BlockToolAsync, UnblockToolAsync
  - Audit & monitoring: RecordAuditAsync, GetAuditLogAsync,
    GetAuditLogCountAsync, GetRateLimitStatus, ResetRateLimits
- `ApprovalRequestedEventArgs` for UI integration
  - Convenience methods: Approve(), Deny(), Cancel()
  - TimeRemaining and HasTimedOut properties
  - TaskCompletionSource for async approval
- `PolicyChangedEventArgs` for policy change notification
  - PolicyChangeType flags for granular change detection
  - HasChange() helper method
- `DecisionRememberedEventArgs` for decision tracking
- `AuditLogQuery` for flexible audit log searching
  - Factory methods: Today(), ForTool(), ForConversation()
  - Pagination support (Limit, Offset)
  - Ordering options
- `AuditLogEntry` preview (full implementation in v0.6.4f)
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.4d | 0.5 day |
