# Design Specification: AIntern v0.6.2b "Semantic Kernel Configuration"

## Overview

**Version**: v0.6.2b
**Parent**: v0.6.2 Semantic Kernel Integration
**Focus**: Configuration model, validation, prompt templates, and settings integration

### Purpose

This sub-version defines the configuration infrastructure for Semantic Kernel:
1. Create `SemanticKernelConfiguration` with all agent behavior settings
2. Create `SemanticKernelConfigurationValidator` for validation logic
3. Create `PromptTemplates` for customizable system prompts
4. Create `AgentBehaviorSettings` for runtime behavior controls
5. Integrate with existing `ISettingsService` infrastructure
6. Support JSON serialization for persistence
7. Provide sensible defaults for all settings

### Dependencies

**From v0.6.2a**:
- Semantic Kernel packages installed
- `SemanticKernelVersions` for version constants

**Future Consumers**:
- v0.6.2h: IAgentService Interface
- v0.6.2i: AgentService Implementation
- v0.6.5: Settings UI

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                v0.6.2b Semantic Kernel Configuration Architecture             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  src/SeniorIntern.Services/AI/                                               │
│  ├─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  SemanticKernelConfiguration                                             │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  Orchestration                                                       ││ │
│  │  │  ├── Enabled: bool                    (enable/disable SK)           ││ │
│  │  │  ├── MaxAgentIterations: int          (loop limit: 1-100)           ││ │
│  │  │  ├── MaxParallelToolCalls: int        (concurrency: 1-10)           ││ │
│  │  │  └── IterationDelay: TimeSpan         (throttling)                  ││ │
│  │  │                                                                      ││ │
│  │  │  Timeouts                                                            ││ │
│  │  │  ├── ToolExecutionTimeout: TimeSpan   (per-tool limit)              ││ │
│  │  │  └── AgentRequestTimeout: TimeSpan    (overall limit)               ││ │
│  │  │                                                                      ││ │
│  │  │  History                                                             ││ │
│  │  │  ├── IncludeToolResultsInHistory: bool                               ││ │
│  │  │  └── MaxToolResultTokens: int         (truncation limit)            ││ │
│  │  │                                                                      ││ │
│  │  │  Behavior                                                            ││ │
│  │  │  ├── AutoRetryFailedTools: bool                                      ││ │
│  │  │  ├── EnableStreaming: bool                                            ││ │
│  │  │  └── StreamingBufferSize: int                                        ││ │
│  │  │                                                                      ││ │
│  │  │  Prompts → PromptTemplates                                           ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  │  PromptTemplates                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  ├── ToolUseSystemPrompt: string      (instructions for tool use)  ││ │
│  │  │  ├── ToolDefinitionFormat: string     ({name}, {description}, etc.) ││ │
│  │  │  ├── ToolCallFormat: string           (JSON block format)           ││ │
│  │  │  ├── ToolResultFormat: string         (result formatting)           ││ │
│  │  │  └── ErrorMessageFormat: string       (error formatting)            ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  │  SemanticKernelConfigurationValidator                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  ├── Validate(config) → bool                                        ││ │
│  │  │  ├── ValidateOrThrow(config)                                        ││ │
│  │  │  ├── Errors: IReadOnlyList<ValidationError>                         ││ │
│  │  │  └── IsValid: bool                                                   ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Integration with existing settings:                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  ISettingsService                                                        │ │
│  │  └── SemanticKernelConfiguration SemanticKernel { get; set; }           │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Configuration Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      Configuration Loading Flow                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Application Start                                                           │
│        │                                                                     │
│        ▼                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Load settings.json                                                   │   │
│  │  ├── "semanticKernel": { ... }                                        │   │
│  │  └── Deserialize to SemanticKernelConfiguration                       │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                          │
│                                   ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  SemanticKernelConfigurationValidator.Validate(config)                │   │
│  │  ├── Check numeric ranges                                             │   │
│  │  ├── Check timeout relationships                                      │   │
│  │  ├── Check prompt templates not empty                                 │   │
│  │  └── Return ValidationResult                                          │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                          │
│           ┌───────────────────────┴───────────────────────┐                  │
│           │                                               │                  │
│           ▼                                               ▼                  │
│  ┌─────────────────────┐                     ┌─────────────────────────┐    │
│  │  Validation Passed  │                     │  Validation Failed      │    │
│  │  Use configuration  │                     │  Log errors             │    │
│  └─────────────────────┘                     │  Use defaults + warning │    │
│                                              └─────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. SemanticKernelConfiguration.cs

**Location**: `src/SeniorIntern.Services/AI/SemanticKernelConfiguration.cs`

```csharp
namespace SeniorIntern.Services.AI;

using System.Text.Json.Serialization;

/// <summary>
/// Configuration settings for Semantic Kernel integration and agent behavior.
/// </summary>
/// <remarks>
/// <para>
/// This configuration controls all aspects of the agentic AI behavior:
/// </para>
/// <list type="bullet">
/// <item>Agent loop iteration limits and delays</item>
/// <item>Tool execution timeouts and parallelism</item>
/// <item>Conversation history management</item>
/// <item>Prompt templates for tool instructions</item>
/// <item>Streaming behavior</item>
/// </list>
/// <para>
/// Settings are persisted in the application settings file and can be
/// modified through the settings UI (v0.6.5).
/// </para>
/// </remarks>
public sealed class SemanticKernelConfiguration
{
    #region Orchestration Settings

    /// <summary>
    /// Whether Semantic Kernel orchestration is enabled.
    /// </summary>
    /// <remarks>
    /// When disabled, the application falls back to basic chat without tools.
    /// Useful for troubleshooting or when tool access should be restricted.
    /// </remarks>
    [JsonPropertyName("enabled")]
    public bool Enabled { get; set; } = true;

    /// <summary>
    /// Maximum iterations for the agent loop before forcing completion.
    /// </summary>
    /// <remarks>
    /// <para>
    /// Each iteration allows one LLM generation + tool execution cycle.
    /// This limit prevents infinite loops when the LLM repeatedly calls tools.
    /// </para>
    /// <para>
    /// Recommended values:
    /// </para>
    /// <list type="bullet">
    /// <item>5-10: Simple tasks with few tool calls</item>
    /// <item>10-20: Complex multi-step tasks</item>
    /// <item>20-50: Very complex workflows (use with caution)</item>
    /// </list>
    /// </remarks>
    [JsonPropertyName("maxAgentIterations")]
    public int MaxAgentIterations { get; set; } = 10;

    /// <summary>
    /// Maximum number of parallel tool calls per iteration.
    /// </summary>
    /// <remarks>
    /// When the LLM requests multiple tools at once, this limits concurrency.
    /// Higher values may improve throughput but increase resource usage.
    /// </remarks>
    [JsonPropertyName("maxParallelToolCalls")]
    public int MaxParallelToolCalls { get; set; } = 3;

    /// <summary>
    /// Delay between agent iterations.
    /// </summary>
    /// <remarks>
    /// Prevents overwhelming the system during rapid tool calling.
    /// Set to zero for maximum speed, or higher for rate limiting.
    /// </remarks>
    [JsonPropertyName("iterationDelayMs")]
    public int IterationDelayMs { get; set; } = 100;

    /// <summary>
    /// Gets the iteration delay as a TimeSpan.
    /// </summary>
    [JsonIgnore]
    public TimeSpan IterationDelay => TimeSpan.FromMilliseconds(IterationDelayMs);

    #endregion

    #region Timeout Settings

    /// <summary>
    /// Timeout for single tool execution in seconds.
    /// </summary>
    /// <remarks>
    /// Tools exceeding this timeout are cancelled with an error result.
    /// Long-running tools (like terminal commands) may need higher values.
    /// </remarks>
    [JsonPropertyName("toolExecutionTimeoutSeconds")]
    public int ToolExecutionTimeoutSeconds { get; set; } = 120;

    /// <summary>
    /// Gets the tool execution timeout as a TimeSpan.
    /// </summary>
    [JsonIgnore]
    public TimeSpan ToolExecutionTimeout => TimeSpan.FromSeconds(ToolExecutionTimeoutSeconds);

    /// <summary>
    /// Overall timeout for entire agent request in seconds.
    /// </summary>
    /// <remarks>
    /// Includes all iterations, tool calls, and LLM generations.
    /// Must be greater than or equal to ToolExecutionTimeout.
    /// </remarks>
    [JsonPropertyName("agentRequestTimeoutSeconds")]
    public int AgentRequestTimeoutSeconds { get; set; } = 600;

    /// <summary>
    /// Gets the agent request timeout as a TimeSpan.
    /// </summary>
    [JsonIgnore]
    public TimeSpan AgentRequestTimeout => TimeSpan.FromSeconds(AgentRequestTimeoutSeconds);

    #endregion

    #region History Settings

    /// <summary>
    /// Whether to include tool results in conversation history.
    /// </summary>
    /// <remarks>
    /// Required for the LLM to see and reason about tool outputs.
    /// Disabling this breaks multi-step reasoning but reduces context size.
    /// </remarks>
    [JsonPropertyName("includeToolResultsInHistory")]
    public bool IncludeToolResultsInHistory { get; set; } = true;

    /// <summary>
    /// Maximum tokens from tool results to include in history.
    /// </summary>
    /// <remarks>
    /// Large tool outputs are truncated with a note about truncation.
    /// This prevents context overflow from verbose tool outputs.
    /// </remarks>
    [JsonPropertyName("maxToolResultTokens")]
    public int MaxToolResultTokens { get; set; } = 4096;

    /// <summary>
    /// Maximum characters for tool result truncation.
    /// </summary>
    /// <remarks>
    /// Approximate conversion: ~4 chars per token.
    /// </remarks>
    [JsonIgnore]
    public int MaxToolResultCharacters => MaxToolResultTokens * 4;

    #endregion

    #region Behavior Settings

    /// <summary>
    /// Whether to automatically retry failed tool calls once.
    /// </summary>
    /// <remarks>
    /// Useful for transient failures (network timeouts, file locks).
    /// May waste resources on deterministic failures.
    /// </remarks>
    [JsonPropertyName("autoRetryFailedTools")]
    public bool AutoRetryFailedTools { get; set; } = false;

    /// <summary>
    /// Maximum retry attempts for failed tools when auto-retry is enabled.
    /// </summary>
    [JsonPropertyName("maxToolRetryAttempts")]
    public int MaxToolRetryAttempts { get; set; } = 1;

    /// <summary>
    /// Delay before retrying a failed tool in milliseconds.
    /// </summary>
    [JsonPropertyName("toolRetryDelayMs")]
    public int ToolRetryDelayMs { get; set; } = 500;

    /// <summary>
    /// Gets the tool retry delay as a TimeSpan.
    /// </summary>
    [JsonIgnore]
    public TimeSpan ToolRetryDelay => TimeSpan.FromMilliseconds(ToolRetryDelayMs);

    /// <summary>
    /// Whether to stream LLM output tokens as they arrive.
    /// </summary>
    /// <remarks>
    /// Enables real-time display of LLM thinking.
    /// Disable for batch processing or testing scenarios.
    /// </remarks>
    [JsonPropertyName("enableStreaming")]
    public bool EnableStreaming { get; set; } = true;

    /// <summary>
    /// Minimum tokens to buffer before emitting a streaming event.
    /// </summary>
    /// <remarks>
    /// Higher values reduce event frequency but increase latency.
    /// Set to 1 for immediate streaming, higher for smoother display.
    /// </remarks>
    [JsonPropertyName("streamingBufferSize")]
    public int StreamingBufferSize { get; set; } = 1;

    #endregion

    #region Prompt Templates

    /// <summary>
    /// Prompt templates for tool-related instructions.
    /// </summary>
    [JsonPropertyName("prompts")]
    public PromptTemplates Prompts { get; set; } = new();

    #endregion

    #region Factory Methods

    /// <summary>
    /// Create a configuration with default values.
    /// </summary>
    public static SemanticKernelConfiguration Default => new();

    /// <summary>
    /// Create a configuration optimized for speed.
    /// </summary>
    public static SemanticKernelConfiguration Fast => new()
    {
        IterationDelayMs = 0,
        MaxParallelToolCalls = 5,
        StreamingBufferSize = 1
    };

    /// <summary>
    /// Create a configuration optimized for safety/reliability.
    /// </summary>
    public static SemanticKernelConfiguration Safe => new()
    {
        MaxAgentIterations = 5,
        MaxParallelToolCalls = 1,
        AutoRetryFailedTools = false,
        ToolExecutionTimeoutSeconds = 60
    };

    /// <summary>
    /// Create a minimal configuration for testing.
    /// </summary>
    public static SemanticKernelConfiguration Minimal => new()
    {
        MaxAgentIterations = 3,
        MaxParallelToolCalls = 1,
        EnableStreaming = false,
        IncludeToolResultsInHistory = true
    };

    #endregion

    /// <summary>
    /// Create a deep copy of this configuration.
    /// </summary>
    public SemanticKernelConfiguration Clone() => new()
    {
        Enabled = Enabled,
        MaxAgentIterations = MaxAgentIterations,
        MaxParallelToolCalls = MaxParallelToolCalls,
        IterationDelayMs = IterationDelayMs,
        ToolExecutionTimeoutSeconds = ToolExecutionTimeoutSeconds,
        AgentRequestTimeoutSeconds = AgentRequestTimeoutSeconds,
        IncludeToolResultsInHistory = IncludeToolResultsInHistory,
        MaxToolResultTokens = MaxToolResultTokens,
        AutoRetryFailedTools = AutoRetryFailedTools,
        MaxToolRetryAttempts = MaxToolRetryAttempts,
        ToolRetryDelayMs = ToolRetryDelayMs,
        EnableStreaming = EnableStreaming,
        StreamingBufferSize = StreamingBufferSize,
        Prompts = Prompts.Clone()
    };
}
```

### 2. PromptTemplates.cs

**Location**: `src/SeniorIntern.Services/AI/PromptTemplates.cs`

```csharp
namespace SeniorIntern.Services.AI;

using System.Text.Json.Serialization;

/// <summary>
/// Customizable prompt templates for tool-related LLM instructions.
/// </summary>
/// <remarks>
/// <para>
/// These templates control how tools are presented to the LLM and how
/// tool calls should be formatted. Customization allows:
/// </para>
/// <list type="bullet">
/// <item>Adjusting for different LLM models</item>
/// <item>Changing tool call syntax</item>
/// <item>Adding project-specific instructions</item>
/// </list>
/// <para>
/// Templates support placeholders that are replaced at runtime:
/// </para>
/// <list type="bullet">
/// <item>{name} - Tool name/ID</item>
/// <item>{description} - Tool description</item>
/// <item>{parameters} - JSON schema of parameters</item>
/// <item>{result} - Tool execution result</item>
/// <item>{error} - Error message</item>
/// </list>
/// </remarks>
public sealed class PromptTemplates
{
    /// <summary>
    /// System prompt additions for tool use instructions.
    /// </summary>
    /// <remarks>
    /// Appended to the base system prompt when tools are available.
    /// Should explain how and when to use tools.
    /// </remarks>
    [JsonPropertyName("toolUseSystemPrompt")]
    public string ToolUseSystemPrompt { get; set; } = """
        You are an AI assistant with access to tools that can help you complete tasks.
        When you need to perform an action, use the appropriate tool.
        Always explain what you're doing and why before using a tool.
        After using a tool, interpret the results for the user.
        If a tool fails, explain the error and suggest alternatives.

        Important guidelines:
        - Prefer reading files before modifying them
        - Break complex tasks into smaller steps
        - Ask for confirmation before destructive operations
        - Summarize changes after completing a task
        """;

    /// <summary>
    /// Format string for tool definitions in prompts.
    /// </summary>
    /// <remarks>
    /// Uses placeholders: {name}, {description}, {parameters}
    /// </remarks>
    [JsonPropertyName("toolDefinitionFormat")]
    public string ToolDefinitionFormat { get; set; } = """
        ## {name}
        {description}

        Parameters:
        ```json
        {parameters}
        ```
        """;

    /// <summary>
    /// Instructions for how to format tool call requests.
    /// </summary>
    /// <remarks>
    /// Tells the LLM the exact syntax for invoking tools.
    /// </remarks>
    [JsonPropertyName("toolCallFormat")]
    public string ToolCallFormat { get; set; } = """
        To use a tool, respond with a JSON block in this format:
        ```tool_call
        {
          "tool": "tool_id",
          "parameters": { ... }
        }
        ```

        You may include text before or after the tool call to explain your reasoning.
        Wait for the tool result before continuing with your response.
        """;

    /// <summary>
    /// Format for presenting tool results to the LLM.
    /// </summary>
    /// <remarks>
    /// Uses placeholders: {name}, {result}, {duration}
    /// </remarks>
    [JsonPropertyName("toolResultFormat")]
    public string ToolResultFormat { get; set; } = """
        Tool `{name}` completed in {duration}ms:
        ```
        {result}
        ```
        """;

    /// <summary>
    /// Format for presenting tool errors to the LLM.
    /// </summary>
    /// <remarks>
    /// Uses placeholders: {name}, {error}, {errorCode}
    /// </remarks>
    [JsonPropertyName("toolErrorFormat")]
    public string ToolErrorFormat { get; set; } = """
        Tool `{name}` failed with error ({errorCode}):
        {error}
        """;

    /// <summary>
    /// Header for the tools section in the system prompt.
    /// </summary>
    [JsonPropertyName("toolsSectionHeader")]
    public string ToolsSectionHeader { get; set; } = """
        # Available Tools

        You have access to the following tools:
        """;

    /// <summary>
    /// Message when no tools are available.
    /// </summary>
    [JsonPropertyName("noToolsAvailableMessage")]
    public string NoToolsAvailableMessage { get; set; } = 
        "No tools are currently available. Respond using only your knowledge.";

    /// <summary>
    /// Message when tool is denied by user.
    /// </summary>
    [JsonPropertyName("toolDeniedMessage")]
    public string ToolDeniedMessage { get; set; } = 
        "The user denied permission to run this tool. Please suggest an alternative approach.";

    /// <summary>
    /// Message when max iterations reached.
    /// </summary>
    [JsonPropertyName("maxIterationsMessage")]
    public string MaxIterationsMessage { get; set; } = 
        "Maximum tool call iterations reached. Please provide a final response with your current progress.";

    #region Factory Methods

    /// <summary>
    /// Create default prompt templates.
    /// </summary>
    public static PromptTemplates Default => new();

    /// <summary>
    /// Create concise templates for models with smaller context windows.
    /// </summary>
    public static PromptTemplates Concise => new()
    {
        ToolUseSystemPrompt = "You have access to tools. Use them when needed.",
        ToolDefinitionFormat = "- {name}: {description}",
        ToolResultFormat = "Result: {result}",
        ToolErrorFormat = "Error: {error}"
    };

    #endregion

    /// <summary>
    /// Create a deep copy of this templates object.
    /// </summary>
    public PromptTemplates Clone() => new()
    {
        ToolUseSystemPrompt = ToolUseSystemPrompt,
        ToolDefinitionFormat = ToolDefinitionFormat,
        ToolCallFormat = ToolCallFormat,
        ToolResultFormat = ToolResultFormat,
        ToolErrorFormat = ToolErrorFormat,
        ToolsSectionHeader = ToolsSectionHeader,
        NoToolsAvailableMessage = NoToolsAvailableMessage,
        ToolDeniedMessage = ToolDeniedMessage,
        MaxIterationsMessage = MaxIterationsMessage
    };

    /// <summary>
    /// Format a tool definition using the template.
    /// </summary>
    public string FormatToolDefinition(string name, string description, string parameters) =>
        ToolDefinitionFormat
            .Replace("{name}", name)
            .Replace("{description}", description)
            .Replace("{parameters}", parameters);

    /// <summary>
    /// Format a tool result using the template.
    /// </summary>
    public string FormatToolResult(string name, string result, long durationMs) =>
        ToolResultFormat
            .Replace("{name}", name)
            .Replace("{result}", result)
            .Replace("{duration}", durationMs.ToString());

    /// <summary>
    /// Format a tool error using the template.
    /// </summary>
    public string FormatToolError(string name, string error, string errorCode) =>
        ToolErrorFormat
            .Replace("{name}", name)
            .Replace("{error}", error)
            .Replace("{errorCode}", errorCode);
}
```

### 3. SemanticKernelConfigurationValidator.cs

**Location**: `src/SeniorIntern.Services/AI/SemanticKernelConfigurationValidator.cs`

```csharp
namespace SeniorIntern.Services.AI;

/// <summary>
/// Validates Semantic Kernel configuration settings.
/// </summary>
/// <remarks>
/// <para>
/// Validation ensures all configuration values are within acceptable ranges
/// and that related settings are consistent (e.g., request timeout >= tool timeout).
/// </para>
/// <para>
/// Validation is performed:
/// </para>
/// <list type="bullet">
/// <item>At application startup when loading settings</item>
/// <item>Before saving configuration changes</item>
/// <item>In the settings UI before applying changes</item>
/// </list>
/// </remarks>
public sealed class SemanticKernelConfigurationValidator
{
    private readonly List<ConfigurationValidationError> _errors = new();

    /// <summary>
    /// Validation error messages.
    /// </summary>
    public IReadOnlyList<ConfigurationValidationError> Errors => _errors;

    /// <summary>
    /// Whether the configuration is valid.
    /// </summary>
    public bool IsValid => _errors.Count == 0;

    /// <summary>
    /// Get errors as simple string list.
    /// </summary>
    public IEnumerable<string> ErrorMessages => _errors.Select(e => e.Message);

    /// <summary>
    /// Validates the configuration and populates error list.
    /// </summary>
    /// <param name="config">Configuration to validate.</param>
    /// <returns>True if configuration is valid.</returns>
    public bool Validate(SemanticKernelConfiguration config)
    {
        _errors.Clear();

        ValidateOrchestrationSettings(config);
        ValidateTimeoutSettings(config);
        ValidateHistorySettings(config);
        ValidateBehaviorSettings(config);
        ValidatePromptTemplates(config.Prompts);

        return IsValid;
    }

    /// <summary>
    /// Validates the configuration and throws if invalid.
    /// </summary>
    /// <param name="config">Configuration to validate.</param>
    /// <exception cref="ConfigurationValidationException">Thrown when validation fails.</exception>
    public void ValidateOrThrow(SemanticKernelConfiguration config)
    {
        if (!Validate(config))
        {
            throw new ConfigurationValidationException(
                "Semantic Kernel configuration is invalid",
                _errors);
        }
    }

    #region Validation Methods

    private void ValidateOrchestrationSettings(SemanticKernelConfiguration config)
    {
        if (config.MaxAgentIterations < 1)
        {
            AddError(
                nameof(config.MaxAgentIterations),
                "MaxAgentIterations must be at least 1",
                ConfigurationErrorSeverity.Error);
        }
        else if (config.MaxAgentIterations > 100)
        {
            AddError(
                nameof(config.MaxAgentIterations),
                "MaxAgentIterations should not exceed 100 (risk of runaway loops)",
                ConfigurationErrorSeverity.Warning);
        }

        if (config.MaxParallelToolCalls < 1)
        {
            AddError(
                nameof(config.MaxParallelToolCalls),
                "MaxParallelToolCalls must be at least 1",
                ConfigurationErrorSeverity.Error);
        }
        else if (config.MaxParallelToolCalls > 10)
        {
            AddError(
                nameof(config.MaxParallelToolCalls),
                "MaxParallelToolCalls should not exceed 10 (resource exhaustion risk)",
                ConfigurationErrorSeverity.Warning);
        }

        if (config.IterationDelayMs < 0)
        {
            AddError(
                nameof(config.IterationDelayMs),
                "IterationDelayMs cannot be negative",
                ConfigurationErrorSeverity.Error);
        }
    }

    private void ValidateTimeoutSettings(SemanticKernelConfiguration config)
    {
        if (config.ToolExecutionTimeoutSeconds < 5)
        {
            AddError(
                nameof(config.ToolExecutionTimeoutSeconds),
                "ToolExecutionTimeout must be at least 5 seconds",
                ConfigurationErrorSeverity.Error);
        }

        if (config.AgentRequestTimeoutSeconds < config.ToolExecutionTimeoutSeconds)
        {
            AddError(
                nameof(config.AgentRequestTimeoutSeconds),
                "AgentRequestTimeout must be >= ToolExecutionTimeout",
                ConfigurationErrorSeverity.Error);
        }

        if (config.AgentRequestTimeoutSeconds > 3600)
        {
            AddError(
                nameof(config.AgentRequestTimeoutSeconds),
                "AgentRequestTimeout exceeds 1 hour - this may indicate a configuration error",
                ConfigurationErrorSeverity.Warning);
        }
    }

    private void ValidateHistorySettings(SemanticKernelConfiguration config)
    {
        if (config.MaxToolResultTokens < 100)
        {
            AddError(
                nameof(config.MaxToolResultTokens),
                "MaxToolResultTokens must be at least 100",
                ConfigurationErrorSeverity.Error);
        }

        if (config.MaxToolResultTokens > 32000)
        {
            AddError(
                nameof(config.MaxToolResultTokens),
                "MaxToolResultTokens exceeds 32000 - may cause context overflow",
                ConfigurationErrorSeverity.Warning);
        }
    }

    private void ValidateBehaviorSettings(SemanticKernelConfiguration config)
    {
        if (config.MaxToolRetryAttempts < 0)
        {
            AddError(
                nameof(config.MaxToolRetryAttempts),
                "MaxToolRetryAttempts cannot be negative",
                ConfigurationErrorSeverity.Error);
        }

        if (config.MaxToolRetryAttempts > 5)
        {
            AddError(
                nameof(config.MaxToolRetryAttempts),
                "MaxToolRetryAttempts should not exceed 5",
                ConfigurationErrorSeverity.Warning);
        }

        if (config.StreamingBufferSize < 1)
        {
            AddError(
                nameof(config.StreamingBufferSize),
                "StreamingBufferSize must be at least 1",
                ConfigurationErrorSeverity.Error);
        }
    }

    private void ValidatePromptTemplates(PromptTemplates prompts)
    {
        if (string.IsNullOrWhiteSpace(prompts.ToolUseSystemPrompt))
        {
            AddError(
                "Prompts.ToolUseSystemPrompt",
                "ToolUseSystemPrompt cannot be empty",
                ConfigurationErrorSeverity.Error);
        }

        if (string.IsNullOrWhiteSpace(prompts.ToolCallFormat))
        {
            AddError(
                "Prompts.ToolCallFormat",
                "ToolCallFormat cannot be empty",
                ConfigurationErrorSeverity.Error);
        }

        if (!prompts.ToolDefinitionFormat.Contains("{name}"))
        {
            AddError(
                "Prompts.ToolDefinitionFormat",
                "ToolDefinitionFormat must contain {name} placeholder",
                ConfigurationErrorSeverity.Warning);
        }
    }

    private void AddError(string property, string message, ConfigurationErrorSeverity severity)
    {
        _errors.Add(new ConfigurationValidationError(property, message, severity));
    }

    #endregion

    /// <summary>
    /// Create a default validator.
    /// </summary>
    public static SemanticKernelConfigurationValidator Create() => new();
}

/// <summary>
/// A single configuration validation error.
/// </summary>
/// <param name="PropertyName">Name of the invalid property.</param>
/// <param name="Message">Error message.</param>
/// <param name="Severity">Error severity level.</param>
public record ConfigurationValidationError(
    string PropertyName,
    string Message,
    ConfigurationErrorSeverity Severity);

/// <summary>
/// Severity level for configuration errors.
/// </summary>
public enum ConfigurationErrorSeverity
{
    /// <summary>Informational message.</summary>
    Info,
    /// <summary>Warning that doesn't prevent use.</summary>
    Warning,
    /// <summary>Error that prevents use.</summary>
    Error
}

/// <summary>
/// Exception thrown when configuration validation fails.
/// </summary>
public class ConfigurationValidationException : Exception
{
    /// <summary>Validation errors.</summary>
    public IReadOnlyList<ConfigurationValidationError> ValidationErrors { get; }

    /// <summary>Create a new validation exception.</summary>
    public ConfigurationValidationException(
        string message,
        IReadOnlyList<ConfigurationValidationError> errors)
        : base(message)
    {
        ValidationErrors = errors;
    }
}
```

### 4. SemanticKernelConfigurationExtensions.cs

**Location**: `src/SeniorIntern.Services/AI/SemanticKernelConfigurationExtensions.cs`

```csharp
namespace SeniorIntern.Services.AI;

using System.Text.Json;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

/// <summary>
/// Extension methods for SemanticKernelConfiguration.
/// </summary>
public static class SemanticKernelConfigurationExtensions
{
    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    /// <summary>
    /// Serialize configuration to JSON.
    /// </summary>
    public static string ToJson(this SemanticKernelConfiguration config) =>
        JsonSerializer.Serialize(config, JsonOptions);

    /// <summary>
    /// Deserialize configuration from JSON.
    /// </summary>
    public static SemanticKernelConfiguration? FromJson(string json) =>
        JsonSerializer.Deserialize<SemanticKernelConfiguration>(json, JsonOptions);

    /// <summary>
    /// Merge another configuration into this one (other takes precedence).
    /// </summary>
    public static SemanticKernelConfiguration Merge(
        this SemanticKernelConfiguration baseConfig,
        SemanticKernelConfiguration? overrides)
    {
        if (overrides == null) return baseConfig.Clone();

        var result = baseConfig.Clone();

        // Only override non-default values (simple approach)
        if (overrides.MaxAgentIterations != 10)
            result.MaxAgentIterations = overrides.MaxAgentIterations;
        if (overrides.MaxParallelToolCalls != 3)
            result.MaxParallelToolCalls = overrides.MaxParallelToolCalls;
        // ... additional properties as needed

        return result;
    }

    /// <summary>
    /// Register SK configuration in DI.
    /// </summary>
    public static IServiceCollection AddSemanticKernelConfiguration(
        this IServiceCollection services,
        SemanticKernelConfiguration? configuration = null)
    {
        services.AddSingleton(configuration ?? SemanticKernelConfiguration.Default);
        services.AddSingleton<SemanticKernelConfigurationValidator>();
        return services;
    }

    /// <summary>
    /// Log configuration summary.
    /// </summary>
    public static void LogConfiguration(
        this SemanticKernelConfiguration config,
        ILogger logger)
    {
        logger.LogInformation(
            "Semantic Kernel Configuration: Enabled={Enabled}, MaxIterations={MaxIter}, " +
            "MaxParallel={MaxParallel}, Streaming={Streaming}",
            config.Enabled,
            config.MaxAgentIterations,
            config.MaxParallelToolCalls,
            config.EnableStreaming);
    }
}
```

---

## File Summary

### Files to Create

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `SemanticKernelConfiguration.cs` | `Services/AI/` | Main configuration class | ~200 |
| `PromptTemplates.cs` | `Services/AI/` | Prompt template strings | ~180 |
| `SemanticKernelConfigurationValidator.cs` | `Services/AI/` | Validation logic | ~180 |
| `SemanticKernelConfigurationExtensions.cs` | `Services/AI/` | Helper extensions | ~70 |

### Files to Modify

| File | Changes |
|------|---------|
| `ISettingsService.cs` | Add `SemanticKernelConfiguration SemanticKernel { get; set; }` |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `SemanticKernelConfiguration_Default_HasExpectedValues` | Verify defaults |
| `SemanticKernelConfiguration_Clone_CreatesDeepCopy` | Clone independence |
| `SemanticKernelConfiguration_ToJson_SerializesCorrectly` | JSON serialization |
| `SemanticKernelConfiguration_FromJson_DeserializesCorrectly` | JSON deserialization |
| `Validator_ValidConfig_ReturnsTrue` | Valid config passes |
| `Validator_MaxIterationsZero_ReturnsError` | Catches invalid iterations |
| `Validator_MaxIterationsTooHigh_ReturnsWarning` | Warns on high values |
| `Validator_TimeoutRelationship_CatchesInvalid` | Request >= tool timeout |
| `Validator_EmptyPrompt_ReturnsError` | Catches empty prompts |
| `PromptTemplates_FormatToolDefinition_ReplacesPlaceholders` | Template formatting |
| `PromptTemplates_FormatToolResult_ReplacesPlaceholders` | Result formatting |
| `PromptTemplates_Clone_CreatesDeepCopy` | Template cloning |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | `SemanticKernelConfiguration` has all documented properties |
| AC-2 | All properties have sensible default values |
| AC-3 | `PromptTemplates` supports all required placeholders |
| AC-4 | Validator catches all invalid configurations |
| AC-5 | Validator distinguishes warnings from errors |
| AC-6 | Configuration serializes to/from JSON correctly |
| AC-7 | Clone creates independent deep copy |
| AC-8 | Factory methods create appropriate presets |
| AC-9 | Integration with ISettingsService documented |

---

## Changelog Entry

```markdown
## v0.6.2b - Semantic Kernel Configuration

### Added
- `SemanticKernelConfiguration` with orchestration, timeout, history, and behavior settings
- `PromptTemplates` for customizable tool-related prompts
- `SemanticKernelConfigurationValidator` with comprehensive validation
- `ConfigurationValidationError` and `ConfigurationValidationException`
- Factory methods: `Default`, `Fast`, `Safe`, `Minimal`
- JSON serialization/deserialization support
- DI registration extensions
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.2b | 0.5 day |
