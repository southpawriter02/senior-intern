# Design Specification: AIntern v0.6.2a "NuGet Package Integration"

## Overview

**Version**: v0.6.2a
**Parent**: v0.6.2 Semantic Kernel Integration
**Focus**: NuGet package references, version compatibility infrastructure, and runtime validation

### Purpose

This sub-version lays the foundational groundwork for the Semantic Kernel integration by:
1. Adding Microsoft Semantic Kernel packages to the central package management system
2. Adding LLamaSharp.SemanticKernel connector for local LLM integration
3. Creating `SemanticKernelVersions` utility for documenting version requirements
4. Creating `SemanticKernelCompatibility` for runtime version validation
5. Creating `PackageLoadException` for specialized error handling
6. Implementing startup validation to detect version mismatches early
7. Providing extension methods for Semantic Kernel diagnostics

### Dependencies

**External Dependencies**:
- `Microsoft.SemanticKernel` (v1.28.0) - Core AI orchestration
- `Microsoft.SemanticKernel.Abstractions` (v1.28.0) - Interface definitions
- `Microsoft.SemanticKernel.Connectors.OpenAI` (v1.28.0) - Function calling format
- `LLamaSharp.SemanticKernel` (v0.17.0) - LLamaSharp bridge

**Internal Dependencies**:
- Existing `LLamaSharp` (v0.17.x) from `ILlmService`
- `Microsoft.Extensions.Logging` for diagnostic output
- `Microsoft.Extensions.DependencyInjection` for service registration

**Future Consumers**:
- v0.6.2b: Semantic Kernel Configuration (uses SK types)
- v0.6.2h: IAgentService Interface (uses Kernel)
- v0.6.2i: AgentService Implementation (full SK integration)

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.6.2a Package Dependency Architecture                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Directory.Packages.props (Central Package Management)                   │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  Microsoft.SemanticKernel                        → 1.28.0           ││ │
│  │  │  Microsoft.SemanticKernel.Abstractions           → 1.28.0           ││ │
│  │  │  Microsoft.SemanticKernel.Connectors.OpenAI      → 1.28.0           ││ │
│  │  │  LLamaSharp.SemanticKernel                       → 0.17.0           ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  SeniorIntern.Services.csproj                                            │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│ │
│  │  │  <PackageReference Include="Microsoft.SemanticKernel" />            ││ │
│  │  │  <PackageReference Include="Microsoft.SemanticKernel.Abstractions" />│ │
│  │  │  <PackageReference Include="Microsoft.SemanticKernel.Connectors..." />│ │
│  │  │  <PackageReference Include="LLamaSharp.SemanticKernel" />           ││ │
│  │  └─────────────────────────────────────────────────────────────────────┘│ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Package Dependency Graph

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Runtime Dependency Resolution                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                      ┌─────────────────────────────┐                         │
│                      │   SeniorIntern.Services     │                         │
│                      └──────────────┬──────────────┘                         │
│                                     │                                        │
│           ┌─────────────────────────┼─────────────────────────┐              │
│           │                         │                         │              │
│           ▼                         ▼                         ▼              │
│  ┌────────────────┐    ┌────────────────────┐    ┌───────────────────────┐  │
│  │ Microsoft.     │    │ Microsoft.         │    │ LLamaSharp.           │  │
│  │ SemanticKernel │    │ SemanticKernel.    │    │ SemanticKernel        │  │
│  │   (1.28.0)     │    │ Connectors.OpenAI  │    │   (0.17.0)            │  │
│  └───────┬────────┘    │   (1.28.0)         │    └───────────┬───────────┘  │
│          │             └─────────┬──────────┘                │              │
│          │                       │                           │              │
│          ▼                       ▼                           ▼              │
│  ┌─────────────────────────────────────────┐     ┌───────────────────────┐  │
│  │ Microsoft.SemanticKernel.Abstractions   │     │     LLamaSharp        │  │
│  │              (1.28.0)                   │     │      (0.17.x)         │  │
│  │                                         │     │ (Existing Dependency) │  │
│  │  Key Types:                             │     └───────────────────────┘  │
│  │  ├── Kernel                             │                                │
│  │  ├── KernelFunction                     │                                │
│  │  ├── KernelArguments                    │                                │
│  │  ├── IChatCompletionService             │                                │
│  │  ├── ChatMessageContent                 │                                │
│  │  ├── FunctionCallContent                │                                │
│  │  └── FunctionResultContent              │                                │
│  └─────────────────────────────────────────┘                                │
│                                                                              │
│  Transitive Dependencies (resolved automatically):                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Microsoft.Extensions.DependencyInjection.Abstractions  (8.0+)          │ │
│  │  Microsoft.Extensions.Logging.Abstractions              (8.0+)          │ │
│  │  System.Text.Json                                       (8.0+)          │ │
│  │  Microsoft.Bcl.AsyncInterfaces                          (8.0+)          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Version Compatibility Matrix

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Version Compatibility Matrix                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  LLamaSharp Version  │  LLamaSharp.SK Version  │  Min SK Version  │ Status   │
│  ────────────────────┼─────────────────────────┼──────────────────┼────────  │
│  0.17.x              │  0.17.0                 │  1.25.0+         │ ✅ Used  │
│  0.16.x              │  0.16.x                 │  1.20.0+         │ ❌ Old   │
│  0.18.x              │  0.18.x (future)        │  1.30.0+         │ ⏳ Future│
│                                                                              │
│  Note: LLamaSharp.SemanticKernel major.minor MUST match LLamaSharp version   │
│  Example: LLamaSharp 0.17.x requires LLamaSharp.SemanticKernel 0.17.x        │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Semantic Kernel Version  │  API Changes                    │  Compatible    │
│  ─────────────────────────┼─────────────────────────────────┼──────────────  │
│  1.25.0 - 1.27.x          │  Stable function calling        │  ✅ Yes        │
│  1.28.0                   │  Target version, enhanced       │  ✅ Target     │
│  1.29.0+                  │  May have breaking changes      │  ⚠️ Verify     │
│  < 1.25.0                 │  Old function calling API       │  ❌ No         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Startup Validation Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Startup Validation Sequence                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Application Start                                                           │
│        │                                                                     │
│        ▼                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  SemanticKernelCompatibility.ValidateOnStartup(IServiceProvider)     │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                          │
│        ┌──────────────────────────┼──────────────────────────────┐           │
│        │                          │                              │           │
│        ▼                          ▼                              ▼           │
│  ┌────────────────┐    ┌────────────────────────┐    ┌──────────────────┐   │
│  │ Load SK        │    │ Load LLamaSharp.SK     │    │ Verify Version   │   │
│  │ Assembly       │    │ Assembly               │    │ Alignment        │   │
│  └───────┬────────┘    └──────────┬─────────────┘    └────────┬─────────┘   │
│          │                        │                           │              │
│          ▼                        ▼                           ▼              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    Version Check Results                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │  SK Version >= 1.28.0?                                          │  │ │
│  │  │  ├── Yes → Continue                                             │  │ │
│  │  │  └── No  → Log Warning, Continue with degraded functionality    │  │ │
│  │  ├─────────────────────────────────────────────────────────────────┤  │ │
│  │  │  LLamaSharp.SK Version == LLamaSharp Version (major.minor)?     │  │ │
│  │  │  ├── Yes → Continue                                             │  │ │
│  │  │  └── No  → Log Error, Agentic features may not work             │  │ │
│  │  ├─────────────────────────────────────────────────────────────────┤  │ │
│  │  │  Can instantiate LLamaSharpChatCompletion?                      │  │ │
│  │  │  ├── Yes → Full functionality available                         │  │ │
│  │  │  └── No  → PackageLoadException, critical failure               │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                   │                                          │
│                                   ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Result: CompatibilityReport                                          │   │
│  │  ├── IsFullyCompatible: bool                                          │   │
│  │  ├── Warnings: List<string>                                           │   │
│  │  ├── Errors: List<string>                                             │   │
│  │  └── LoadedVersions: Dictionary<string, Version>                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. Directory.Packages.props Updates

**Location**: `Directory.Packages.props` (Repository Root)

*Note: XML snippet to merge into existing `<ItemGroup>`:*

```xml
<ItemGroup>
  <!-- Existing packages above... -->

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- v0.6.2a: Semantic Kernel Integration Packages                           -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  
  <!-- 
    Microsoft Semantic Kernel - AI Orchestration Framework
    Provides: Kernel, KernelFunction, function calling pipeline
    Requires: .NET 8.0+
    Release Notes: https://github.com/microsoft/semantic-kernel/releases/tag/v1.28.0
  -->
  <PackageVersion Include="Microsoft.SemanticKernel" Version="1.28.0" />
  
  <!--
    Semantic Kernel Abstractions
    Provides: IChatCompletionService, ChatMessageContent, FunctionCallContent
    Note: Typically pulled transitively, but explicit for clarity
  -->
  <PackageVersion Include="Microsoft.SemanticKernel.Abstractions" Version="1.28.0" />
  
  <!--
    OpenAI Connectors (used for function calling format compatibility)
    Provides: OpenAIPromptExecutionSettings with function_call support
    Note: We use local LLMs but need the function calling format
  -->
  <PackageVersion Include="Microsoft.SemanticKernel.Connectors.OpenAI" Version="1.28.0" />
  
  <!--
    LLamaSharp Semantic Kernel Connector
    Provides: LLamaSharpChatCompletion, bridges SK to local LLamaSharp models
    CRITICAL: Version MUST match LLamaSharp version (0.17.x)
  -->
  <PackageVersion Include="LLamaSharp.SemanticKernel" Version="0.17.0" />
</ItemGroup>
```

### 2. SeniorIntern.Services.csproj Updates

**Location**: `src/SeniorIntern.Services/SeniorIntern.Services.csproj`

*Note: XML snippet to merge into existing `<ItemGroup>`:*

```xml
<ItemGroup>
  <!-- Existing package references above... -->

  <!-- Semantic Kernel Integration (v0.6.2a) -->
  <PackageReference Include="Microsoft.SemanticKernel" />
  <PackageReference Include="Microsoft.SemanticKernel.Abstractions" />
  <PackageReference Include="Microsoft.SemanticKernel.Connectors.OpenAI" />
  <PackageReference Include="LLamaSharp.SemanticKernel" />
</ItemGroup>
```

### 3. SemanticKernelVersions.cs

**Location**: `src/SeniorIntern.Services/AI/SemanticKernelVersions.cs`

```csharp
namespace SeniorIntern.Services.AI;

/// <summary>
/// Documents and provides version constants for Semantic Kernel integration.
/// </summary>
/// <remarks>
/// <para>
/// This class serves as the single source of truth for version requirements
/// across the Semantic Kernel integration. It provides:
/// </para>
/// <list type="bullet">
/// <item>Minimum version constants for compatibility</item>
/// <item>Target version constants for tested configurations</item>
/// <item>Assembly names for runtime loading</item>
/// <item>Version parsing utilities</item>
/// </list>
/// <para>
/// Version policy: We target specific versions that have been tested together.
/// Minor version increases are generally safe; major version requires verification.
/// </para>
/// </remarks>
public static class SemanticKernelVersions
{
    #region Version Constants

    /// <summary>
    /// Target Semantic Kernel version (tested configuration).
    /// </summary>
    /// <remarks>
    /// This is the version used during development and testing.
    /// The integration is verified to work with this exact version.
    /// </remarks>
    public const string TargetSkVersion = "1.28.0";

    /// <summary>
    /// Minimum supported Semantic Kernel version.
    /// </summary>
    /// <remarks>
    /// Versions below this may lack required APIs for function calling.
    /// The stable function calling API was introduced in 1.25.0.
    /// </remarks>
    public const string MinimumSkVersion = "1.25.0";

    /// <summary>
    /// Maximum known compatible Semantic Kernel version.
    /// </summary>
    /// <remarks>
    /// Versions above this have not been tested and may have breaking changes.
    /// Set to the target version initially; update after testing newer versions.
    /// </remarks>
    public const string MaximumTestedSkVersion = "1.28.0";

    /// <summary>
    /// Target LLamaSharp.SemanticKernel version.
    /// </summary>
    /// <remarks>
    /// MUST match the LLamaSharp version used in ILlmService.
    /// Mismatched versions will cause runtime failures.
    /// </remarks>
    public const string TargetLLamaSharpSkVersion = "0.17.0";

    /// <summary>
    /// Expected LLamaSharp core version.
    /// </summary>
    /// <remarks>
    /// The LLamaSharp.SemanticKernel connector requires this version.
    /// </remarks>
    public const string ExpectedLLamaSharpVersion = "0.17.0";

    #endregion

    #region Assembly Names

    /// <summary>
    /// Semantic Kernel core assembly name.
    /// </summary>
    public const string SkAssemblyName = "Microsoft.SemanticKernel";

    /// <summary>
    /// Semantic Kernel abstractions assembly name.
    /// </summary>
    public const string SkAbstractionsAssemblyName = "Microsoft.SemanticKernel.Abstractions";

    /// <summary>
    /// LLamaSharp.SemanticKernel connector assembly name.
    /// </summary>
    public const string LLamaSharpSkAssemblyName = "LLamaSharp.SemanticKernel";

    /// <summary>
    /// LLamaSharp core assembly name.
    /// </summary>
    public const string LLamaSharpAssemblyName = "LLamaSharp";

    #endregion

    #region Key Types

    /// <summary>
    /// Fully qualified name of the Kernel type.
    /// </summary>
    /// <remarks>
    /// Used for runtime type loading verification.
    /// </remarks>
    public const string KernelTypeName = "Microsoft.SemanticKernel.Kernel";

    /// <summary>
    /// Fully qualified name of the LLamaSharp chat completion type.
    /// </summary>
    public const string LLamaSharpChatCompletionTypeName = 
        "LLamaSharp.SemanticKernel.ChatCompletion.LLamaSharpChatCompletion";

    #endregion

    #region Utility Methods

    /// <summary>
    /// Parse a version string safely.
    /// </summary>
    /// <param name="versionString">Version string (e.g., "1.28.0").</param>
    /// <returns>Parsed Version, or null if parsing fails.</returns>
    public static Version? TryParseVersion(string? versionString)
    {
        if (string.IsNullOrWhiteSpace(versionString))
            return null;

        // Handle versions with extra segments (e.g., "1.28.0.0")
        var normalized = NormalizeVersionString(versionString);
        
        return Version.TryParse(normalized, out var version) ? version : null;
    }

    /// <summary>
    /// Normalize a version string to standard format.
    /// </summary>
    /// <param name="versionString">Input version string.</param>
    /// <returns>Normalized version string.</returns>
    private static string NormalizeVersionString(string versionString)
    {
        // Remove any prerelease suffix (e.g., "-preview.1")
        var dashIndex = versionString.IndexOf('-');
        if (dashIndex > 0)
        {
            versionString = versionString[..dashIndex];
        }

        // Remove any '+' metadata suffix
        var plusIndex = versionString.IndexOf('+');
        if (plusIndex > 0)
        {
            versionString = versionString[..plusIndex];
        }

        return versionString.Trim();
    }

    /// <summary>
    /// Get the target version as a Version object.
    /// </summary>
    public static Version TargetSkVersionParsed => Version.Parse(TargetSkVersion);

    /// <summary>
    /// Get the minimum version as a Version object.
    /// </summary>
    public static Version MinimumSkVersionParsed => Version.Parse(MinimumSkVersion);

    /// <summary>
    /// Check if a version is within the supported range.
    /// </summary>
    /// <param name="version">Version to check.</param>
    /// <returns>True if the version is supported.</returns>
    public static bool IsSkVersionSupported(Version version)
    {
        var min = MinimumSkVersionParsed;
        var max = Version.Parse(MaximumTestedSkVersion);

        return version >= min && version <= max;
    }

    /// <summary>
    /// Check if a version is compatible (meets minimum, may exceed tested).
    /// </summary>
    /// <param name="version">Version to check.</param>
    /// <returns>True if the version meets minimum requirements.</returns>
    public static bool IsSkVersionCompatible(Version version)
    {
        return version >= MinimumSkVersionParsed;
    }

    #endregion
}
```

### 4. SemanticKernelCompatibility.cs

**Location**: `src/SeniorIntern.Services/AI/SemanticKernelCompatibility.cs`

```csharp
namespace SeniorIntern.Services.AI;

using System.Reflection;
using Microsoft.Extensions.Logging;

/// <summary>
/// Runtime compatibility validation for Semantic Kernel packages.
/// </summary>
/// <remarks>
/// <para>
/// This class performs runtime validation of loaded assemblies to ensure
/// version compatibility. It should be called during application startup
/// to detect issues early.
/// </para>
/// <para>
/// Validation includes:
/// </para>
/// <list type="bullet">
/// <item>Verifying Semantic Kernel version meets minimum requirements</item>
/// <item>Verifying LLamaSharp.SemanticKernel version matches LLamaSharp</item>
/// <item>Testing type loading for critical classes</item>
/// <item>Checking for assembly binding issues</item>
/// </list>
/// </remarks>
public static class SemanticKernelCompatibility
{
    #region Public API

    /// <summary>
    /// Validate package compatibility at startup.
    /// </summary>
    /// <param name="logger">Logger for reporting results.</param>
    /// <returns>Compatibility report with validation results.</returns>
    public static CompatibilityReport ValidateOnStartup(ILogger logger)
    {
        var report = new CompatibilityReport();

        logger.LogDebug("Starting Semantic Kernel compatibility validation...");

        // Validate Semantic Kernel version
        ValidateSemanticKernelVersion(logger, report);

        // Validate LLamaSharp.SemanticKernel version
        ValidateLLamaSharpConnectorVersion(logger, report);

        // Validate version alignment between LLamaSharp components
        ValidateLLamaSharpAlignment(logger, report);

        // Try loading critical types
        ValidateTypeLoading(logger, report);

        // Log summary
        LogValidationSummary(logger, report);

        return report;
    }

    /// <summary>
    /// Get the currently loaded Semantic Kernel version.
    /// </summary>
    /// <returns>Version if loaded, null otherwise.</returns>
    public static Version? GetLoadedSkVersion()
    {
        try
        {
            var assembly = Assembly.Load(SemanticKernelVersions.SkAssemblyName);
            return assembly.GetName().Version;
        }
        catch
        {
            return null;
        }
    }

    /// <summary>
    /// Get the currently loaded LLamaSharp.SemanticKernel version.
    /// </summary>
    /// <returns>Version if loaded, null otherwise.</returns>
    public static Version? GetLoadedLLamaSharpSkVersion()
    {
        try
        {
            var assembly = Assembly.Load(SemanticKernelVersions.LLamaSharpSkAssemblyName);
            return assembly.GetName().Version;
        }
        catch
        {
            return null;
        }
    }

    /// <summary>
    /// Get the currently loaded LLamaSharp core version.
    /// </summary>
    /// <returns>Version if loaded, null otherwise.</returns>
    public static Version? GetLoadedLLamaSharpVersion()
    {
        try
        {
            var assembly = Assembly.Load(SemanticKernelVersions.LLamaSharpAssemblyName);
            return assembly.GetName().Version;
        }
        catch
        {
            return null;
        }
    }

    #endregion

    #region Validation Methods

    private static void ValidateSemanticKernelVersion(ILogger logger, CompatibilityReport report)
    {
        try
        {
            var assembly = Assembly.Load(SemanticKernelVersions.SkAssemblyName);
            var version = assembly.GetName().Version;

            if (version == null)
            {
                report.AddWarning($"Could not determine {SemanticKernelVersions.SkAssemblyName} version");
                return;
            }

            report.SetLoadedVersion(SemanticKernelVersions.SkAssemblyName, version);

            var minimum = SemanticKernelVersions.MinimumSkVersionParsed;

            if (version < minimum)
            {
                report.AddError(
                    $"Semantic Kernel version {version} is below minimum required {minimum}. " +
                    "Function calling may not work correctly.");
            }
            else if (SemanticKernelVersions.IsSkVersionSupported(version))
            {
                logger.LogDebug(
                    "Semantic Kernel version {Version} is fully supported (target: {Target})",
                    version, SemanticKernelVersions.TargetSkVersion);
            }
            else
            {
                report.AddWarning(
                    $"Semantic Kernel version {version} is above tested version " +
                    $"{SemanticKernelVersions.MaximumTestedSkVersion}. " +
                    "Functionality should work but has not been verified.");
            }
        }
        catch (Exception ex)
        {
            report.AddError($"Failed to load {SemanticKernelVersions.SkAssemblyName}: {ex.Message}");
        }
    }

    private static void ValidateLLamaSharpConnectorVersion(ILogger logger, CompatibilityReport report)
    {
        try
        {
            var assembly = Assembly.Load(SemanticKernelVersions.LLamaSharpSkAssemblyName);
            var version = assembly.GetName().Version;

            if (version == null)
            {
                report.AddWarning($"Could not determine {SemanticKernelVersions.LLamaSharpSkAssemblyName} version");
                return;
            }

            report.SetLoadedVersion(SemanticKernelVersions.LLamaSharpSkAssemblyName, version);

            var expected = SemanticKernelVersions.TryParseVersion(
                SemanticKernelVersions.TargetLLamaSharpSkVersion);

            if (expected != null && version.Major == expected.Major && version.Minor == expected.Minor)
            {
                logger.LogDebug(
                    "LLamaSharp.SemanticKernel version {Version} matches expected {Expected}",
                    version, expected);
            }
            else
            {
                report.AddWarning(
                    $"LLamaSharp.SemanticKernel version {version} differs from expected " +
                    $"{SemanticKernelVersions.TargetLLamaSharpSkVersion}. This may cause issues.");
            }
        }
        catch (Exception ex)
        {
            report.AddError(
                $"Failed to load {SemanticKernelVersions.LLamaSharpSkAssemblyName}: {ex.Message}");
        }
    }

    private static void ValidateLLamaSharpAlignment(ILogger logger, CompatibilityReport report)
    {
        try
        {
            var llamaSharpAsm = Assembly.Load(SemanticKernelVersions.LLamaSharpAssemblyName);
            var llamaSharpSkAsm = Assembly.Load(SemanticKernelVersions.LLamaSharpSkAssemblyName);

            var llamaSharpVer = llamaSharpAsm.GetName().Version;
            var llamaSharpSkVer = llamaSharpSkAsm.GetName().Version;

            if (llamaSharpVer != null && llamaSharpSkVer != null)
            {
                report.SetLoadedVersion(SemanticKernelVersions.LLamaSharpAssemblyName, llamaSharpVer);

                // Major.Minor must match
                if (llamaSharpVer.Major == llamaSharpSkVer.Major &&
                    llamaSharpVer.Minor == llamaSharpSkVer.Minor)
                {
                    logger.LogDebug(
                        "LLamaSharp versions aligned: Core={Core}, SK={Sk}",
                        llamaSharpVer, llamaSharpSkVer);
                }
                else
                {
                    report.AddError(
                        $"LLamaSharp version mismatch! Core: {llamaSharpVer}, " +
                        $"SemanticKernel: {llamaSharpSkVer}. " +
                        "These MUST have matching major.minor versions.");
                }
            }
        }
        catch (Exception ex)
        {
            report.AddWarning($"Could not verify LLamaSharp version alignment: {ex.Message}");
        }
    }

    private static void ValidateTypeLoading(ILogger logger, CompatibilityReport report)
    {
        // Test loading the Kernel type
        try
        {
            var kernelType = Type.GetType(
                $"{SemanticKernelVersions.KernelTypeName}, {SemanticKernelVersions.SkAssemblyName}");
            
            if (kernelType != null)
            {
                logger.LogDebug("Successfully loaded Kernel type");
            }
            else
            {
                report.AddWarning("Could not load Kernel type - it may be loaded lazily");
            }
        }
        catch (Exception ex)
        {
            report.AddError($"Failed to load Kernel type: {ex.Message}");
        }

        // Test loading the LLamaSharpChatCompletion type
        try
        {
            var chatType = Type.GetType(
                $"{SemanticKernelVersions.LLamaSharpChatCompletionTypeName}, " +
                $"{SemanticKernelVersions.LLamaSharpSkAssemblyName}");

            if (chatType != null)
            {
                logger.LogDebug("Successfully loaded LLamaSharpChatCompletion type");
                report.CanLoadLLamaSharpChatCompletion = true;
            }
            else
            {
                report.AddWarning(
                    "Could not load LLamaSharpChatCompletion type - it may be loaded lazily");
            }
        }
        catch (Exception ex)
        {
            report.AddError($"Failed to load LLamaSharpChatCompletion type: {ex.Message}");
        }
    }

    private static void LogValidationSummary(ILogger logger, CompatibilityReport report)
    {
        if (report.IsFullyCompatible)
        {
            logger.LogInformation(
                "Semantic Kernel compatibility validation passed. " +
                "Loaded versions: SK={SkVersion}, LLamaSharp.SK={LlamaSkVersion}",
                report.LoadedVersions.GetValueOrDefault(SemanticKernelVersions.SkAssemblyName),
                report.LoadedVersions.GetValueOrDefault(SemanticKernelVersions.LLamaSharpSkAssemblyName));
        }
        else
        {
            if (report.Errors.Count > 0)
            {
                logger.LogError(
                    "Semantic Kernel compatibility validation failed with {ErrorCount} error(s):\n{Errors}",
                    report.Errors.Count,
                    string.Join("\n", report.Errors.Select(e => $"  - {e}")));
            }

            if (report.Warnings.Count > 0)
            {
                logger.LogWarning(
                    "Semantic Kernel compatibility validation completed with {WarningCount} warning(s):\n{Warnings}",
                    report.Warnings.Count,
                    string.Join("\n", report.Warnings.Select(w => $"  - {w}")));
            }
        }
    }

    #endregion
}

/// <summary>
/// Result of compatibility validation.
/// </summary>
public sealed class CompatibilityReport
{
    private readonly List<string> _warnings = new();
    private readonly List<string> _errors = new();
    private readonly Dictionary<string, Version> _loadedVersions = new();

    /// <summary>
    /// Whether all compatibility checks passed without errors.
    /// </summary>
    public bool IsFullyCompatible => _errors.Count == 0 && _warnings.Count == 0;

    /// <summary>
    /// Whether the system is functional (no critical errors).
    /// </summary>
    public bool IsFunctional => _errors.Count == 0;

    /// <summary>
    /// Warning messages from validation.
    /// </summary>
    public IReadOnlyList<string> Warnings => _warnings;

    /// <summary>
    /// Error messages from validation.
    /// </summary>
    public IReadOnlyList<string> Errors => _errors;

    /// <summary>
    /// Versions of loaded assemblies.
    /// </summary>
    public IReadOnlyDictionary<string, Version> LoadedVersions => _loadedVersions;

    /// <summary>
    /// Whether LLamaSharpChatCompletion type could be loaded.
    /// </summary>
    public bool CanLoadLLamaSharpChatCompletion { get; set; }

    internal void AddWarning(string message) => _warnings.Add(message);
    internal void AddError(string message) => _errors.Add(message);
    internal void SetLoadedVersion(string assembly, Version version) => _loadedVersions[assembly] = version;

    /// <summary>
    /// Get a summary string for logging.
    /// </summary>
    public override string ToString()
    {
        if (IsFullyCompatible)
            return "Fully compatible";

        var parts = new List<string>();
        if (_errors.Count > 0)
            parts.Add($"{_errors.Count} error(s)");
        if (_warnings.Count > 0)
            parts.Add($"{_warnings.Count} warning(s)");

        return $"Compatibility issues: {string.Join(", ", parts)}";
    }
}
```

### 5. PackageLoadException.cs

**Location**: `src/SeniorIntern.Services/AI/PackageLoadException.cs`

```csharp
namespace SeniorIntern.Services.AI;

/// <summary>
/// Exception thrown when a required package cannot be loaded or is incompatible.
/// </summary>
/// <remarks>
/// <para>
/// This exception is thrown during startup validation when critical packages
/// are missing or have incompatible versions. It provides detailed information
/// about the package issue for troubleshooting.
/// </para>
/// <para>
/// Common causes:
/// </para>
/// <list type="bullet">
/// <item>Missing NuGet package reference</item>
/// <item>Version mismatch between related packages</item>
/// <item>Assembly binding redirect issues</item>
/// <item>Native dependency not found</item>
/// </list>
/// </remarks>
public class PackageLoadException : Exception
{
    /// <summary>
    /// Name of the package that failed to load.
    /// </summary>
    public string PackageName { get; }

    /// <summary>
    /// Expected version of the package (if known).
    /// </summary>
    public string? ExpectedVersion { get; }

    /// <summary>
    /// Actual loaded version (if any was loaded).
    /// </summary>
    public string? ActualVersion { get; }

    /// <summary>
    /// Suggested resolution steps.
    /// </summary>
    public IReadOnlyList<string> Suggestions { get; }

    /// <summary>
    /// Create a new PackageLoadException.
    /// </summary>
    /// <param name="packageName">Name of the failing package.</param>
    /// <param name="message">Error message.</param>
    public PackageLoadException(string packageName, string message)
        : base(message)
    {
        PackageName = packageName;
        Suggestions = Array.Empty<string>();
    }

    /// <summary>
    /// Create a new PackageLoadException with version details.
    /// </summary>
    /// <param name="packageName">Name of the failing package.</param>
    /// <param name="message">Error message.</param>
    /// <param name="expectedVersion">Expected version.</param>
    /// <param name="actualVersion">Actual version found.</param>
    public PackageLoadException(
        string packageName,
        string message,
        string? expectedVersion,
        string? actualVersion)
        : base(message)
    {
        PackageName = packageName;
        ExpectedVersion = expectedVersion;
        ActualVersion = actualVersion;
        Suggestions = GenerateSuggestions(packageName, expectedVersion, actualVersion);
    }

    /// <summary>
    /// Create a new PackageLoadException from an inner exception.
    /// </summary>
    /// <param name="packageName">Name of the failing package.</param>
    /// <param name="message">Error message.</param>
    /// <param name="innerException">Original exception.</param>
    public PackageLoadException(string packageName, string message, Exception innerException)
        : base(message, innerException)
    {
        PackageName = packageName;
        Suggestions = GenerateSuggestionsFromException(packageName, innerException);
    }

    private static List<string> GenerateSuggestions(
        string packageName,
        string? expectedVersion,
        string? actualVersion)
    {
        var suggestions = new List<string>();

        if (actualVersion == null)
        {
            suggestions.Add($"Ensure {packageName} is installed: dotnet add package {packageName}");
            
            if (expectedVersion != null)
            {
                suggestions.Add($"Specific version: dotnet add package {packageName} --version {expectedVersion}");
            }
        }
        else
        {
            suggestions.Add($"Update {packageName} to version {expectedVersion}:");
            suggestions.Add($"  dotnet add package {packageName} --version {expectedVersion}");
            suggestions.Add("Then rebuild the solution: dotnet build --no-incremental");
        }

        suggestions.Add("Clear NuGet cache if issues persist: dotnet nuget locals all --clear");

        return suggestions;
    }

    private static List<string> GenerateSuggestionsFromException(
        string packageName,
        Exception innerException)
    {
        var suggestions = new List<string>();

        if (innerException is FileNotFoundException)
        {
            suggestions.Add($"Package {packageName} assembly not found");
            suggestions.Add($"Run: dotnet restore");
            suggestions.Add($"Then rebuild: dotnet build --no-incremental");
        }
        else if (innerException is TypeLoadException)
        {
            suggestions.Add($"Type loading failed - possible version mismatch");
            suggestions.Add($"Check that all Semantic Kernel packages have matching versions");
            suggestions.Add($"Clear obj/bin folders and rebuild");
        }
        else
        {
            suggestions.Add($"Reinstall package: dotnet remove package {packageName}");
            suggestions.Add($"Then: dotnet add package {packageName}");
        }

        return suggestions;
    }

    /// <summary>
    /// Get a detailed error message for logging.
    /// </summary>
    public string GetDetailedMessage()
    {
        var lines = new List<string>
        {
            $"Package Load Error: {PackageName}",
            $"Message: {Message}"
        };

        if (ExpectedVersion != null)
            lines.Add($"Expected Version: {ExpectedVersion}");

        if (ActualVersion != null)
            lines.Add($"Actual Version: {ActualVersion}");

        if (Suggestions.Count > 0)
        {
            lines.Add("Suggestions:");
            foreach (var suggestion in Suggestions)
            {
                lines.Add($"  - {suggestion}");
            }
        }

        return string.Join(Environment.NewLine, lines);
    }
}
```

### 6. SemanticKernelExtensions.cs

**Location**: `src/SeniorIntern.Services/AI/SemanticKernelExtensions.cs`

```csharp
namespace SeniorIntern.Services.AI;

using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

/// <summary>
/// Extension methods for Semantic Kernel service registration and diagnostics.
/// </summary>
/// <remarks>
/// <para>
/// Provides helper methods for:
/// </para>
/// <list type="bullet">
/// <item>Registering SK compatibility validation as a startup task</item>
/// <item>Adding SK version information to diagnostics</item>
/// <item>Configuring SK-related services</item>
/// </list>
/// </remarks>
public static class SemanticKernelExtensions
{
    /// <summary>
    /// Add Semantic Kernel compatibility validation to health checks.
    /// </summary>
    /// <param name="services">Service collection.</param>
    /// <returns>Service collection for chaining.</returns>
    public static IServiceCollection AddSemanticKernelCompatibilityCheck(
        this IServiceCollection services)
    {
        services.AddSingleton<CompatibilityReport>(sp =>
        {
            var logger = sp.GetRequiredService<ILoggerFactory>()
                .CreateLogger("SemanticKernelCompatibility");
            return SemanticKernelCompatibility.ValidateOnStartup(logger);
        });

        return services;
    }

    /// <summary>
    /// Validate Semantic Kernel compatibility and throw if critical issues.
    /// </summary>
    /// <param name="serviceProvider">Service provider.</param>
    /// <param name="throwOnWarnings">Whether to throw on warnings (default: false).</param>
    /// <exception cref="PackageLoadException">Thrown when compatibility check fails.</exception>
    public static void ValidateSemanticKernelOrThrow(
        this IServiceProvider serviceProvider,
        bool throwOnWarnings = false)
    {
        var logger = serviceProvider.GetRequiredService<ILoggerFactory>()
            .CreateLogger("SemanticKernelCompatibility");

        var report = SemanticKernelCompatibility.ValidateOnStartup(logger);

        if (!report.IsFunctional)
        {
            throw new PackageLoadException(
                SemanticKernelVersions.SkAssemblyName,
                $"Semantic Kernel compatibility check failed: {string.Join("; ", report.Errors)}");
        }

        if (throwOnWarnings && report.Warnings.Count > 0)
        {
            throw new PackageLoadException(
                SemanticKernelVersions.SkAssemblyName,
                $"Semantic Kernel compatibility warnings: {string.Join("; ", report.Warnings)}");
        }
    }

    /// <summary>
    /// Get version information for diagnostics display.
    /// </summary>
    /// <returns>Dictionary of assembly names to version strings.</returns>
    public static Dictionary<string, string> GetSemanticKernelVersionInfo()
    {
        var info = new Dictionary<string, string>();

        var skVersion = SemanticKernelCompatibility.GetLoadedSkVersion();
        if (skVersion != null)
            info["Semantic Kernel"] = skVersion.ToString();

        var llamaSkVersion = SemanticKernelCompatibility.GetLoadedLLamaSharpSkVersion();
        if (llamaSkVersion != null)
            info["LLamaSharp.SemanticKernel"] = llamaSkVersion.ToString();

        var llamaVersion = SemanticKernelCompatibility.GetLoadedLLamaSharpVersion();
        if (llamaVersion != null)
            info["LLamaSharp"] = llamaVersion.ToString();

        // Add target versions for comparison
        info["Target SK Version"] = SemanticKernelVersions.TargetSkVersion;
        info["Target LLamaSharp.SK Version"] = SemanticKernelVersions.TargetLLamaSharpSkVersion;

        return info;
    }

    /// <summary>
    /// Log all Semantic Kernel version information.
    /// </summary>
    /// <param name="logger">Logger to use.</param>
    public static void LogVersionInfo(ILogger logger)
    {
        var info = GetSemanticKernelVersionInfo();

        logger.LogInformation("Semantic Kernel Version Information:");
        foreach (var (key, value) in info)
        {
            logger.LogInformation("  {Component}: {Version}", key, value);
        }
    }
}
```

---

## File Summary

### Files to Create

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `SemanticKernelVersions.cs` | `Services/AI/` | Version constants and utilities | ~130 |
| `SemanticKernelCompatibility.cs` | `Services/AI/` | Runtime validation | ~280 |
| `CompatibilityReport.cs` | `Services/AI/` | Validation result model | (in above) |
| `PackageLoadException.cs` | `Services/AI/` | Custom exception | ~120 |
| `SemanticKernelExtensions.cs` | `Services/AI/` | DI and diagnostics | ~90 |

### Files to Modify

| File | Changes |
|------|---------|
| `Directory.Packages.props` | Add 4 new `<PackageVersion>` entries |
| `SeniorIntern.Services.csproj` | Add 4 new `<PackageReference>` entries |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `SemanticKernelVersions_TryParseVersion_ValidVersion_ReturnsVersion` | Basic version parsing |
| `SemanticKernelVersions_TryParseVersion_PreReleaseVersion_ReturnsVersion` | Strips prerelease suffix |
| `SemanticKernelVersions_TryParseVersion_InvalidVersion_ReturnsNull` | Handles invalid input |
| `SemanticKernelVersions_TryParseVersion_NullOrEmpty_ReturnsNull` | Handles null/empty input |
| `SemanticKernelVersions_IsSkVersionSupported_WithinRange_ReturnsTrue` | Version range check |
| `SemanticKernelVersions_IsSkVersionSupported_BelowMinimum_ReturnsFalse` | Below minimum fails |
| `SemanticKernelVersions_IsSkVersionSupported_AboveMaxTested_ReturnsFalse` | Above maximum fails |
| `SemanticKernelVersions_IsSkVersionCompatible_AtMinimum_ReturnsTrue` | Meets minimum |
| `SemanticKernelVersions_TargetSkVersionParsed_ReturnsExpectedVersion` | Constant validation |
| `SemanticKernelCompatibility_ValidateOnStartup_ReturnsReport` | Basic validation flow |
| `SemanticKernelCompatibility_GetLoadedSkVersion_ReturnsVersionOrNull` | Version retrieval |
| `SemanticKernelCompatibility_GetLoadedLLamaSharpSkVersion_ReturnsVersionOrNull` | Connector version |
| `CompatibilityReport_NoIssues_IsFullyCompatible` | Clean report is compatible |
| `CompatibilityReport_WithWarnings_IsFunctionalButNotFullyCompatible` | Warnings don't fail |
| `CompatibilityReport_WithErrors_IsNotFunctional` | Errors are critical |
| `CompatibilityReport_SetLoadedVersion_StoresVersion` | Version storage |
| `PackageLoadException_Constructor_SetsPackageName` | Exception construction |
| `PackageLoadException_WithVersions_GeneratesSuggestions` | Suggestion generation |
| `PackageLoadException_GetDetailedMessage_FormatsCorrectly` | Message formatting |
| `SemanticKernelExtensions_GetVersionInfo_ReturnsDictionary` | Info retrieval |
| `Integration_PackageReferences_RestoreSuccessfully` | NuGet restore works |
| `Integration_AssembliesLoad_WithoutErrors` | Runtime loading |
| `Integration_SkTypesAccessible_FromServices` | Type accessibility |

**Total Tests**: 23

---

## Verification

### Package Verification

```bash
# Restore packages and verify no conflicts
dotnet restore src/SeniorIntern.Services/SeniorIntern.Services.csproj --verbosity detailed

# Check for package vulnerabilities
dotnet list src/SeniorIntern.Services/SeniorIntern.Services.csproj package --vulnerable

# Check for outdated packages
dotnet list src/SeniorIntern.Services/SeniorIntern.Services.csproj package --outdated

# Verify all packages resolve
dotnet list src/SeniorIntern.Services/SeniorIntern.Services.csproj package
```

### Build Verification

```bash
# Clean build to verify package integration
dotnet build src/SeniorIntern.Services/SeniorIntern.Services.csproj --no-incremental

# Check for any assembly binding issues in output
dotnet build src/SeniorIntern.Services/SeniorIntern.Services.csproj -warnaserror
```

### Runtime Verification

```bash
# Run unit tests
dotnet test --filter "FullyQualifiedName~SemanticKernel"

# Verify runtime loading (if applicable)
dotnet run --project src/SeniorIntern.App -- --validate-packages
```

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | `Microsoft.SemanticKernel` (1.28.0) is referenced in `Directory.Packages.props` |
| AC-2 | `Microsoft.SemanticKernel.Abstractions` (1.28.0) is referenced in `Directory.Packages.props` |
| AC-3 | `Microsoft.SemanticKernel.Connectors.OpenAI` (1.28.0) is referenced in `Directory.Packages.props` |
| AC-4 | `LLamaSharp.SemanticKernel` (0.17.0) is referenced in `Directory.Packages.props` |
| AC-5 | `SeniorIntern.Services` project builds successfully with new references |
| AC-6 | No NuGet downgrade warnings or conflict errors during restore |
| AC-7 | `SemanticKernelVersions` class exists with version constants |
| AC-8 | `SemanticKernelCompatibility` can validate loaded versions |
| AC-9 | `CompatibilityReport` captures validation results |
| AC-10 | `PackageLoadException` provides detailed error information |
| AC-11 | All unit tests pass |
| AC-12 | Runtime assembly loading works without errors |

---

## Implementation Notes

### Why These Specific Versions?

| Package | Version | Rationale |
|---------|---------|-----------|
| SK 1.28.0 | Stable release with mature function calling APIs. Not the latest, but thoroughly tested. |
| SK Abstractions 1.28.0 | Must match core SK version exactly to avoid assembly conflicts. |
| SK Connectors.OpenAI 1.28.0 | Provides `OpenAIPromptExecutionSettings` which defines the function calling format. |
| LLamaSharp.SK 0.17.0 | Must match existing LLamaSharp 0.17.x. Version mismatch causes `MissingMethodException`. |

### Common Issues and Mitigations

| Issue | Mitigation |
|-------|------------|
| Version mismatch between LLamaSharp and connector | `SemanticKernelCompatibility` detects and logs early |
| SK version too old | `IsSkVersionCompatible` check with clear error message |
| Assembly binding redirect problems | Clear obj/bin and rebuild; use explicit versions |
| Native LLamaSharp.Native missing | Not covered here (pre-existing dependency) |

---

## Changelog Entry

```markdown
## v0.6.2a - NuGet Package Integration

### Added
- Added `Microsoft.SemanticKernel` (1.28.0) package reference
- Added `Microsoft.SemanticKernel.Abstractions` (1.28.0) package reference
- Added `Microsoft.SemanticKernel.Connectors.OpenAI` (1.28.0) package reference
- Added `LLamaSharp.SemanticKernel` (0.17.0) package reference
- Created `SemanticKernelVersions` utility for version constants and parsing
- Created `SemanticKernelCompatibility` for runtime version validation
- Created `CompatibilityReport` model for validation results
- Created `PackageLoadException` for package-related errors
- Created `SemanticKernelExtensions` for DI registration and diagnostics

### Infrastructure
- Updated `Directory.Packages.props` with new package versions
- Updated `SeniorIntern.Services.csproj` with package references
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.2a | 0.5 day |
