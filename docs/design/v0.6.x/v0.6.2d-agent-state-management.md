# Design Specification: AIntern v0.6.2d "Agent State Management"

## Overview

**Version**: v0.6.2d
**Parent**: v0.6.2 Semantic Kernel Integration
**Focus**: State machine, state transitions, and event emission for agent execution tracking

### Purpose

This sub-version defines the state management infrastructure for agent execution:
1. Create `AgentState` enum with all execution states
2. Create `AgentStateTransition` enum defining valid transitions
3. Create `AgentStateChangedEventArgs` for state change notifications
4. Create `AgentStateMachine` for managing transitions and validation
5. Create `AgentStateExtensions` for state querying helpers
6. Create `StateTransitionException` for invalid transitions
7. Support UI updates via state change events
8. Track iteration counts and timing information

### Dependencies

**From v0.6.2c**:
- `AgentRequest` triggers state machine start
- `ToolPermission` influences approval state transitions

**Future Consumers**:
- v0.6.2e: Agent Event System (uses state for context)
- v0.6.2h: IAgentService Interface (uses state machine)
- v0.6.2i: AgentService Implementation (drives state transitions)
- UI Layer: Updates based on state change events

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                v0.6.2d Agent State Management Architecture                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  src/SeniorIntern.Core/Models/                                               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  AgentState                              AgentStateTransition            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Idle                  â”‚             â”‚  Start                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Initializing          â”‚             â”‚  BeginThinking             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Thinking              â”‚             â”‚  DetectToolCall            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ParsingToolCall       â”‚             â”‚  RequestApproval           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  WaitingForApproval    â”‚             â”‚  ApprovalGranted           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ExecutingTool         â”‚             â”‚  ApprovalDenied            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ProcessingResult      â”‚             â”‚  ToolComplete              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Responding            â”‚             â”‚  NoToolCalls               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Cancelled             â”‚             â”‚  Complete                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Error                 â”‚             â”‚  Cancel                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Completed             â”‚             â”‚  Fail                      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  AgentStateChangedEventArgs                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚  PreviousState: AgentState           (where we came from)           â”‚â”‚ â”‚
â”‚  â”‚  â”‚  CurrentState: AgentState            (where we are now)             â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Transition: AgentStateTransition    (how we got here)              â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Timestamp: DateTime                 (when it happened)             â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Context: string?                    (additional info)              â”‚â”‚ â”‚
â”‚  â”‚  â”‚  IterationNumber: int                (loop iteration)               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Duration: TimeSpan?                 (time in previous state)       â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  src/SeniorIntern.Services/AI/                                               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  AgentStateMachine                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚  Properties                                                          â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ CurrentState: AgentState                                        â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ IterationNumber: int                                            â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ IsTerminalState: bool                                           â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€ CanAcceptInput: bool                                            â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                      â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Methods                                                              â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ TryTransition(transition, context?) â†’ bool                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Transition(transition, context?)    (throws on invalid)        â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ CanTransition(transition) â†’ bool                                â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ GetValidTransitions() â†’ IEnumerable<AgentStateTransition>      â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Reset()                                                         â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                      â”‚â”‚ â”‚
â”‚  â”‚  â”‚  Events                                                               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€ StateChanged: EventHandler<AgentStateChangedEventArgs>          â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Machine Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Agent State Machine Diagram                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                              â”‚  Idle   â”‚                                     â”‚
â”‚                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                   â”‚ Start                                    â”‚
â”‚                                   â–¼                                          â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                           â”‚ Initializing â”‚                                   â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                  â”‚ BeginThinking                             â”‚
â”‚                                  â–¼                                           â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚           â”‚                                                  â”‚              â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚  Thinking  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚   â”‚       â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚   â”‚       â”‚        â”‚                                                        â”‚
â”‚   â”‚       â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚       â”‚        â”‚ DetectToolCall                  â”‚ NoToolCalls          â”‚
â”‚   â”‚       â”‚        â–¼                                 â–¼                      â”‚
â”‚   â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚       â”‚  â”‚ ParsingToolCall â”‚             â”‚ Responding â”‚                 â”‚
â”‚   â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚   â”‚       â”‚           â”‚                            â”‚                        â”‚
â”‚   â”‚       â”‚           â”‚                            â”‚ Complete               â”‚
â”‚   â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â–¼                        â”‚
â”‚   â”‚       â”‚  â”‚                     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚       â”‚  â”‚ RequestApproval     â”‚         â”‚ Completed â”‚                  â”‚
â”‚   â”‚       â”‚  â”‚       (if needed)   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚   â”‚       â”‚  â”‚                     â”‚                                        â”‚
â”‚   â”‚       â”‚  â–¼                     â”‚ ApprovalGranted                        â”‚
â”‚   â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ (auto-approved)                        â”‚
â”‚   â”‚       â”‚  â”‚WaitingForApprovalâ”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                          â”‚             â”‚
â”‚   â”‚       â”‚           â”‚            â”‚                          â”‚             â”‚
â”‚   â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚             â”‚
â”‚   â”‚       â”‚  â”‚ ApprovalDenied      â”‚ ApprovalGranted          â”‚             â”‚
â”‚   â”‚       â”‚  â”‚                     â”‚                          â–¼             â”‚
â”‚   â”‚       â”‚  â”‚                     â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚       â””â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ ExecutingTool â”‚     â”‚
â”‚   â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚   â”‚                                                           â”‚             â”‚
â”‚   â”‚                                                           â”‚ ToolCompleteâ”‚
â”‚   â”‚                                                           â–¼             â”‚
â”‚   â”‚                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                   â”‚ProcessingResultâ”‚    â”‚
â”‚   â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚   â”‚                                                           â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                               BeginThinking                                  â”‚
â”‚                                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  Special transitions (from any state):                                       â”‚
â”‚                                                                              â”‚
â”‚    [Any State] â”€â”€Cancelâ”€â”€â–º [Cancelled]                                       â”‚
â”‚    [Any State] â”€â”€Failâ”€â”€â”€â”€â–º [Error]                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Specifications

### 1. AgentState.cs

**Location**: `src/SeniorIntern.Core/Models/AgentState.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Current state of the agent during request processing.
/// </summary>
/// <remarks>
/// <para>
/// The agent state machine tracks execution progress through these states.
/// States are designed for accurate UI representation of agent activity.
/// </para>
/// <para>
/// State categories:
/// </para>
/// <list type="bullet">
/// <item><b>Ready</b>: Idle - waiting for input</item>
/// <item><b>Active</b>: Initializing, Thinking, ParsingToolCall, ExecutingTool, ProcessingResult, Responding</item>
/// <item><b>Waiting</b>: WaitingForApproval - blocked on user</item>
/// <item><b>Terminal</b>: Completed, Cancelled, Error - processing done</item>
/// </list>
/// </remarks>
public enum AgentState
{
    /// <summary>
    /// Agent is not processing any request.
    /// </summary>
    /// <remarks>
    /// Initial state. Ready to accept new requests.
    /// Valid transitions: Start â†’ Initializing
    /// </remarks>
    Idle = 0,

    /// <summary>
    /// Agent is initializing request processing.
    /// </summary>
    /// <remarks>
    /// Building prompts, preparing context, loading tools.
    /// Valid transitions: BeginThinking â†’ Thinking
    /// </remarks>
    Initializing = 1,

    /// <summary>
    /// LLM is generating a response.
    /// </summary>
    /// <remarks>
    /// Active generation phase. May produce text or tool call requests.
    /// This is where streaming tokens appear.
    /// Valid transitions: DetectToolCall â†’ ParsingToolCall, NoToolCalls â†’ Responding
    /// </remarks>
    Thinking = 2,

    /// <summary>
    /// Agent detected a tool call in LLM output.
    /// </summary>
    /// <remarks>
    /// Parsing and validating the tool request.
    /// Checking if approval is needed.
    /// Valid transitions: RequestApproval â†’ WaitingForApproval, ApprovalGranted â†’ ExecutingTool
    /// </remarks>
    ParsingToolCall = 3,

    /// <summary>
    /// Tool call is waiting for user approval.
    /// </summary>
    /// <remarks>
    /// Agent is paused until user responds to approval prompt.
    /// UI should show approval dialog.
    /// Valid transitions: ApprovalGranted â†’ ExecutingTool, ApprovalDenied â†’ Thinking
    /// </remarks>
    WaitingForApproval = 4,

    /// <summary>
    /// Tool is currently executing.
    /// </summary>
    /// <remarks>
    /// May report progress during execution.
    /// UI should show execution indicator.
    /// Valid transitions: ToolComplete â†’ ProcessingResult
    /// </remarks>
    ExecutingTool = 5,

    /// <summary>
    /// Processing tool result for next iteration.
    /// </summary>
    /// <remarks>
    /// Formatting result for LLM consumption.
    /// Preparing for next thinking iteration.
    /// Valid transitions: BeginThinking â†’ Thinking
    /// </remarks>
    ProcessingResult = 6,

    /// <summary>
    /// Agent is completing the response.
    /// </summary>
    /// <remarks>
    /// Final text generation without tools.
    /// No more tool calls will be made.
    /// Valid transitions: Complete â†’ Completed
    /// </remarks>
    Responding = 7,

    /// <summary>
    /// Request was cancelled by user.
    /// </summary>
    /// <remarks>
    /// Terminal state. Any state can transition here via Cancel.
    /// </remarks>
    Cancelled = 8,

    /// <summary>
    /// An error occurred during processing.
    /// </summary>
    /// <remarks>
    /// Terminal state. Any state can transition here via Fail.
    /// Error details available in AgentResponse.
    /// </remarks>
    Error = 9,

    /// <summary>
    /// Request completed successfully.
    /// </summary>
    /// <remarks>
    /// Terminal state. Response is ready.
    /// </remarks>
    Completed = 10
}

/// <summary>
/// Valid state transitions for the agent state machine.
/// </summary>
/// <remarks>
/// <para>
/// Each transition represents a meaningful change in execution flow.
/// Invalid transitions are rejected by the state machine.
/// </para>
/// </remarks>
public enum AgentStateTransition
{
    /// <summary>
    /// Begin processing a new request.
    /// Idle â†’ Initializing
    /// </summary>
    Start,

    /// <summary>
    /// Begin/continue LLM generation.
    /// Initializing â†’ Thinking, ProcessingResult â†’ Thinking
    /// </summary>
    BeginThinking,

    /// <summary>
    /// Detected a tool call in LLM output.
    /// Thinking â†’ ParsingToolCall
    /// </summary>
    DetectToolCall,

    /// <summary>
    /// Tool requires user approval.
    /// ParsingToolCall â†’ WaitingForApproval
    /// </summary>
    RequestApproval,

    /// <summary>
    /// User or system approved the tool call.
    /// WaitingForApproval â†’ ExecutingTool, ParsingToolCall â†’ ExecutingTool (auto)
    /// </summary>
    ApprovalGranted,

    /// <summary>
    /// User denied the tool call.
    /// WaitingForApproval â†’ Thinking (with denial context)
    /// </summary>
    ApprovalDenied,

    /// <summary>
    /// Tool execution finished.
    /// ExecutingTool â†’ ProcessingResult
    /// </summary>
    ToolComplete,

    /// <summary>
    /// LLM finished without requesting tools.
    /// Thinking â†’ Responding
    /// </summary>
    NoToolCalls,

    /// <summary>
    /// Response generation complete.
    /// Responding â†’ Completed
    /// </summary>
    Complete,

    /// <summary>
    /// Cancel the current request.
    /// Any â†’ Cancelled
    /// </summary>
    Cancel,

    /// <summary>
    /// Processing failed with error.
    /// Any â†’ Error
    /// </summary>
    Fail
}
```

### 2. AgentStateChangedEventArgs.cs

**Location**: `src/SeniorIntern.Core/Models/AgentStateChangedEventArgs.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Event arguments for agent state changes.
/// </summary>
/// <remarks>
/// <para>
/// State change events enable UI updates during agent execution:
/// </para>
/// <list type="bullet">
/// <item>Progress indicators based on state</item>
/// <item>Appropriate UI for each phase</item>
/// <item>Timing information for debugging</item>
/// </list>
/// </remarks>
public sealed class AgentStateChangedEventArgs : EventArgs
{
    /// <summary>
    /// Previous state before transition.
    /// </summary>
    public AgentState PreviousState { get; init; }

    /// <summary>
    /// New current state.
    /// </summary>
    public AgentState CurrentState { get; init; }

    /// <summary>
    /// The transition that caused this change.
    /// </summary>
    public AgentStateTransition Transition { get; init; }

    /// <summary>
    /// When the transition occurred.
    /// </summary>
    public DateTime Timestamp { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Additional context about the transition.
    /// </summary>
    /// <remarks>
    /// Examples:
    /// - Tool name when entering ExecutingTool
    /// - Error message when entering Error
    /// - Denial reason when ApprovalDenied
    /// </remarks>
    public string? Context { get; init; }

    /// <summary>
    /// Current iteration number in the agent loop.
    /// </summary>
    /// <remarks>
    /// Increments each time we enter Thinking from ProcessingResult.
    /// First thinking phase is iteration 1.
    /// </remarks>
    public int IterationNumber { get; init; }

    /// <summary>
    /// Time spent in the previous state.
    /// </summary>
    /// <remarks>
    /// Null for the first transition (from Idle).
    /// Useful for performance tracking.
    /// </remarks>
    public TimeSpan? Duration { get; init; }

    /// <summary>
    /// Request ID this state change belongs to.
    /// </summary>
    public Guid RequestId { get; init; }

    #region Computed Properties

    /// <summary>
    /// Whether this is a transition to a terminal state.
    /// </summary>
    public bool IsTerminalTransition => CurrentState.IsTerminal();

    /// <summary>
    /// Whether this is a transition to an active processing state.
    /// </summary>
    public bool IsActiveTransition => CurrentState.IsActive();

    /// <summary>
    /// Whether the agent is now waiting for user input.
    /// </summary>
    public bool IsWaitingForUser => CurrentState == AgentState.WaitingForApproval;

    /// <summary>
    /// Display-friendly description of the current state.
    /// </summary>
    public string StateDescription => CurrentState.ToDisplayString();

    #endregion

    /// <inheritdoc />
    public override string ToString() =>
        $"StateChange: {PreviousState} -> {CurrentState} via {Transition} " +
        $"[Iter: {IterationNumber}, Duration: {Duration?.TotalMilliseconds:F0}ms]";
}
```

### 3. AgentStateExtensions.cs

**Location**: `src/SeniorIntern.Core/Models/AgentStateExtensions.cs`

```csharp
namespace SeniorIntern.Core.Models;

/// <summary>
/// Extension methods for AgentState and AgentStateTransition.
/// </summary>
public static class AgentStateExtensions
{
    #region State Category Checks

    /// <summary>
    /// Whether the state is a terminal state (processing complete).
    /// </summary>
    public static bool IsTerminal(this AgentState state) => state is
        AgentState.Completed or AgentState.Cancelled or AgentState.Error;

    /// <summary>
    /// Whether the state is an active processing state.
    /// </summary>
    public static bool IsActive(this AgentState state) => state is
        AgentState.Initializing or AgentState.Thinking or
        AgentState.ParsingToolCall or AgentState.ExecutingTool or
        AgentState.ProcessingResult or AgentState.Responding;

    /// <summary>
    /// Whether the state is waiting for external input.
    /// </summary>
    public static bool IsWaiting(this AgentState state) => state is
        AgentState.Idle or AgentState.WaitingForApproval;

    /// <summary>
    /// Whether the state involves LLM generation.
    /// </summary>
    public static bool IsGenerating(this AgentState state) => state is
        AgentState.Thinking or AgentState.Responding;

    /// <summary>
    /// Whether the state involves tool activity.
    /// </summary>
    public static bool IsToolRelated(this AgentState state) => state is
        AgentState.ParsingToolCall or AgentState.WaitingForApproval or
        AgentState.ExecutingTool or AgentState.ProcessingResult;

    /// <summary>
    /// Whether new requests can be accepted in this state.
    /// </summary>
    public static bool CanAcceptRequest(this AgentState state) =>
        state == AgentState.Idle;

    /// <summary>
    /// Whether user input is expected (approval/denial).
    /// </summary>
    public static bool AwaitingUserInput(this AgentState state) =>
        state == AgentState.WaitingForApproval;

    /// <summary>
    /// Whether cancellation is meaningful in this state.
    /// </summary>
    public static bool IsCancellable(this AgentState state) =>
        state.IsActive() || state.AwaitingUserInput();

    #endregion

    #region Display Helpers

    /// <summary>
    /// Get a user-friendly display string for the state.
    /// </summary>
    public static string ToDisplayString(this AgentState state) => state switch
    {
        AgentState.Idle => "Ready",
        AgentState.Initializing => "Preparing...",
        AgentState.Thinking => "Thinking...",
        AgentState.ParsingToolCall => "Analyzing tool call...",
        AgentState.WaitingForApproval => "Waiting for approval",
        AgentState.ExecutingTool => "Running tool...",
        AgentState.ProcessingResult => "Processing result...",
        AgentState.Responding => "Composing response...",
        AgentState.Cancelled => "Cancelled",
        AgentState.Error => "Error",
        AgentState.Completed => "Complete",
        _ => state.ToString()
    };

    /// <summary>
    /// Get an icon/emoji for the state.
    /// </summary>
    public static string ToIcon(this AgentState state) => state switch
    {
        AgentState.Idle => "â¸ï¸",
        AgentState.Initializing => "ğŸ”„",
        AgentState.Thinking => "ğŸ¤”",
        AgentState.ParsingToolCall => "ğŸ”",
        AgentState.WaitingForApproval => "â“",
        AgentState.ExecutingTool => "âš™ï¸",
        AgentState.ProcessingResult => "ğŸ“Š",
        AgentState.Responding => "âœï¸",
        AgentState.Cancelled => "â›”",
        AgentState.Error => "âŒ",
        AgentState.Completed => "âœ…",
        _ => "â”"
    };

    /// <summary>
    /// Get a spinner state for the UI.
    /// </summary>
    public static bool ShowsSpinner(this AgentState state) =>
        state.IsActive();

    #endregion

    #region Transition Helpers

    /// <summary>
    /// Get a description of what the transition does.
    /// </summary>
    public static string ToDescription(this AgentStateTransition transition) => transition switch
    {
        AgentStateTransition.Start => "Starting request processing",
        AgentStateTransition.BeginThinking => "Beginning LLM generation",
        AgentStateTransition.DetectToolCall => "Tool call detected",
        AgentStateTransition.RequestApproval => "Requesting user approval",
        AgentStateTransition.ApprovalGranted => "Approval granted",
        AgentStateTransition.ApprovalDenied => "Approval denied",
        AgentStateTransition.ToolComplete => "Tool execution complete",
        AgentStateTransition.NoToolCalls => "No tools needed",
        AgentStateTransition.Complete => "Response complete",
        AgentStateTransition.Cancel => "Request cancelled",
        AgentStateTransition.Fail => "Processing failed",
        _ => transition.ToString()
    };

    /// <summary>
    /// Whether this transition is a success path.
    /// </summary>
    public static bool IsSuccessTransition(this AgentStateTransition transition) =>
        transition is AgentStateTransition.Complete or
        AgentStateTransition.ApprovalGranted or AgentStateTransition.ToolComplete;

    /// <summary>
    /// Whether this transition is a failure/abort path.
    /// </summary>
    public static bool IsFailureTransition(this AgentStateTransition transition) =>
        transition is AgentStateTransition.Cancel or AgentStateTransition.Fail;

    #endregion
}
```

### 4. AgentStateMachine.cs

**Location**: `src/SeniorIntern.Services/AI/AgentStateMachine.cs`

```csharp
namespace SeniorIntern.Services.AI;

using SeniorIntern.Core.Models;
using Microsoft.Extensions.Logging;

/// <summary>
/// Manages agent state transitions and validates state changes.
/// </summary>
/// <remarks>
/// <para>
/// The state machine ensures valid transitions and emits events for UI updates.
/// It is thread-safe and tracks timing information.
/// </para>
/// <para>
/// Important behaviors:
/// </para>
/// <list type="bullet">
/// <item>Only valid transitions are allowed</item>
/// <item>Cancel and Fail work from any non-terminal state</item>
/// <item>Iteration counter increments on BeginThinking</item>
/// <item>Timing is tracked automatically</item>
/// </list>
/// </remarks>
public sealed class AgentStateMachine
{
    #region Valid Transitions Table

    /// <summary>
    /// Map of (CurrentState, Transition) -> NextState for valid transitions.
    /// </summary>
    private static readonly Dictionary<(AgentState, AgentStateTransition), AgentState> ValidTransitions = new()
    {
        // Starting up
        [(AgentState.Idle, AgentStateTransition.Start)] = AgentState.Initializing,
        [(AgentState.Initializing, AgentStateTransition.BeginThinking)] = AgentState.Thinking,

        // Tool detection and execution
        [(AgentState.Thinking, AgentStateTransition.DetectToolCall)] = AgentState.ParsingToolCall,
        [(AgentState.ParsingToolCall, AgentStateTransition.RequestApproval)] = AgentState.WaitingForApproval,
        [(AgentState.WaitingForApproval, AgentStateTransition.ApprovalGranted)] = AgentState.ExecutingTool,
        [(AgentState.WaitingForApproval, AgentStateTransition.ApprovalDenied)] = AgentState.Thinking,
        [(AgentState.ExecutingTool, AgentStateTransition.ToolComplete)] = AgentState.ProcessingResult,
        [(AgentState.ProcessingResult, AgentStateTransition.BeginThinking)] = AgentState.Thinking,

        // Completion
        [(AgentState.Thinking, AgentStateTransition.NoToolCalls)] = AgentState.Responding,
        [(AgentState.Responding, AgentStateTransition.Complete)] = AgentState.Completed,

        // Auto-approval path (skip WaitingForApproval)
        [(AgentState.ParsingToolCall, AgentStateTransition.ApprovalGranted)] = AgentState.ExecutingTool,
    };

    #endregion

    private readonly ILogger<AgentStateMachine>? _logger;
    private readonly object _lock = new();

    private AgentState _currentState = AgentState.Idle;
    private int _iterationNumber;
    private DateTime _stateEnteredAt = DateTime.UtcNow;
    private Guid _requestId;

    /// <summary>
    /// Create a new state machine.
    /// </summary>
    public AgentStateMachine(ILogger<AgentStateMachine>? logger = null)
    {
        _logger = logger;
    }

    #region Properties

    /// <summary>
    /// Current state of the agent.
    /// </summary>
    public AgentState CurrentState
    {
        get { lock (_lock) return _currentState; }
    }

    /// <summary>
    /// Current iteration number in the agent loop.
    /// </summary>
    public int IterationNumber
    {
        get { lock (_lock) return _iterationNumber; }
    }

    /// <summary>
    /// Whether the agent is in a terminal state.
    /// </summary>
    public bool IsTerminalState => CurrentState.IsTerminal();

    /// <summary>
    /// Whether the agent can accept new requests.
    /// </summary>
    public bool CanAcceptRequest => CurrentState.CanAcceptRequest();

    /// <summary>
    /// Whether the agent can accept user input (approval).
    /// </summary>
    public bool CanAcceptInput => CurrentState is
        AgentState.Idle or AgentState.WaitingForApproval;

    /// <summary>
    /// Time spent in current state.
    /// </summary>
    public TimeSpan TimeInCurrentState
    {
        get { lock (_lock) return DateTime.UtcNow - _stateEnteredAt; }
    }

    /// <summary>
    /// Current request ID being processed.
    /// </summary>
    public Guid RequestId
    {
        get { lock (_lock) return _requestId; }
    }

    #endregion

    #region Events

    /// <summary>
    /// Raised when the state changes.
    /// </summary>
    public event EventHandler<AgentStateChangedEventArgs>? StateChanged;

    #endregion

    #region Transition Methods

    /// <summary>
    /// Attempt a state transition.
    /// </summary>
    /// <param name="transition">The transition to attempt.</param>
    /// <param name="context">Optional context string.</param>
    /// <returns>True if transition succeeded.</returns>
    public bool TryTransition(AgentStateTransition transition, string? context = null)
    {
        lock (_lock)
        {
            // Cancel and Fail can occur from any non-terminal state
            if (transition == AgentStateTransition.Cancel)
            {
                if (_currentState.IsTerminal()) return false;
                return ChangeState(AgentState.Cancelled, transition, context);
            }

            if (transition == AgentStateTransition.Fail)
            {
                if (_currentState.IsTerminal()) return false;
                return ChangeState(AgentState.Error, transition, context);
            }

            // Check for valid transition
            if (!ValidTransitions.TryGetValue((_currentState, transition), out var newState))
            {
                _logger?.LogWarning(
                    "Invalid transition {Transition} from state {CurrentState}",
                    transition, _currentState);
                return false;
            }

            return ChangeState(newState, transition, context);
        }
    }

    /// <summary>
    /// Perform a state transition, throwing if invalid.
    /// </summary>
    /// <exception cref="StateTransitionException">Thrown for invalid transitions.</exception>
    public void Transition(AgentStateTransition transition, string? context = null)
    {
        if (!TryTransition(transition, context))
        {
            throw new StateTransitionException(_currentState, transition, context);
        }
    }

    /// <summary>
    /// Check if a transition is valid from the current state.
    /// </summary>
    public bool CanTransition(AgentStateTransition transition)
    {
        lock (_lock)
        {
            if (transition is AgentStateTransition.Cancel or AgentStateTransition.Fail)
            {
                return !_currentState.IsTerminal();
            }

            return ValidTransitions.ContainsKey((_currentState, transition));
        }
    }

    /// <summary>
    /// Get all valid transitions from the current state.
    /// </summary>
    public IEnumerable<AgentStateTransition> GetValidTransitions()
    {
        lock (_lock)
        {
            var transitions = new List<AgentStateTransition>();

            foreach (var ((state, transition), _) in ValidTransitions)
            {
                if (state == _currentState)
                {
                    transitions.Add(transition);
                }
            }

            // Add universal transitions if not terminal
            if (!_currentState.IsTerminal())
            {
                transitions.Add(AgentStateTransition.Cancel);
                transitions.Add(AgentStateTransition.Fail);
            }

            return transitions;
        }
    }

    #endregion

    #region Lifecycle Methods

    /// <summary>
    /// Start processing a new request.
    /// </summary>
    /// <param name="requestId">ID of the request being processed.</param>
    /// <exception cref="InvalidOperationException">If not in Idle state.</exception>
    public void Start(Guid requestId)
    {
        lock (_lock)
        {
            if (_currentState != AgentState.Idle)
            {
                throw new InvalidOperationException(
                    $"Cannot start new request: agent is in state {_currentState}");
            }

            _requestId = requestId;
            Transition(AgentStateTransition.Start);
        }
    }

    /// <summary>
    /// Reset the state machine to Idle.
    /// </summary>
    public void Reset()
    {
        lock (_lock)
        {
            var previousState = _currentState;
            _currentState = AgentState.Idle;
            _iterationNumber = 0;
            _stateEnteredAt = DateTime.UtcNow;
            _requestId = Guid.Empty;

            _logger?.LogDebug("State machine reset from {PreviousState}", previousState);
        }
    }

    #endregion

    #region Private Methods

    private bool ChangeState(AgentState newState, AgentStateTransition transition, string? context)
    {
        var previousState = _currentState;
        var now = DateTime.UtcNow;
        var duration = now - _stateEnteredAt;

        _currentState = newState;
        _stateEnteredAt = now;

        // Track iteration on BeginThinking
        if (transition == AgentStateTransition.BeginThinking)
        {
            _iterationNumber++;
        }

        _logger?.LogDebug(
            "State transition: {Previous} -> {Current} via {Transition} (iter: {Iter}, {Duration}ms)",
            previousState, newState, transition, _iterationNumber, duration.TotalMilliseconds);

        // Raise event
        StateChanged?.Invoke(this, new AgentStateChangedEventArgs
        {
            PreviousState = previousState,
            CurrentState = newState,
            Transition = transition,
            Timestamp = now,
            Context = context,
            IterationNumber = _iterationNumber,
            Duration = previousState == AgentState.Idle ? null : duration,
            RequestId = _requestId
        });

        return true;
    }

    #endregion
}

/// <summary>
/// Exception thrown when an invalid state transition is attempted.
/// </summary>
public class StateTransitionException : InvalidOperationException
{
    /// <summary>
    /// The state when the transition was attempted.
    /// </summary>
    public AgentState FromState { get; }

    /// <summary>
    /// The transition that was attempted.
    /// </summary>
    public AgentStateTransition Transition { get; }

    /// <summary>
    /// Additional context provided with the transition.
    /// </summary>
    public string? Context { get; }

    public StateTransitionException(
        AgentState fromState,
        AgentStateTransition transition,
        string? context = null)
        : base($"Invalid transition '{transition}' from state '{fromState}'" +
               (context != null ? $": {context}" : ""))
    {
        FromState = fromState;
        Transition = transition;
        Context = context;
    }
}
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `AgentState.cs` | `Core/Models/` | State and transition enums | ~140 |
| `AgentStateChangedEventArgs.cs` | `Core/Models/` | State change events | ~80 |
| `AgentStateExtensions.cs` | `Core/Models/` | Helper methods | ~130 |
| `AgentStateMachine.cs` | `Services/AI/` | State machine logic | ~220 |
| `StateTransitionException.cs` | `Services/AI/` | (in above file) | ~25 |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `AgentStateMachine_InitialState_IsIdle` | Starts in Idle |
| `AgentStateMachine_Start_MovesToInitializing` | Start transition works |
| `AgentStateMachine_InvalidTransition_ReturnsFalse` | Invalid transition rejected |
| `AgentStateMachine_Transition_ThrowsOnInvalid` | Throws for invalid |
| `AgentStateMachine_Cancel_WorksFromAnyActiveState` | Universal cancel |
| `AgentStateMachine_Fail_WorksFromAnyActiveState` | Universal fail |
| `AgentStateMachine_Cancel_FailsFromTerminalState` | Can't cancel completed |
| `AgentStateMachine_BeginThinking_IncrementsIteration` | Iteration tracking |
| `AgentStateMachine_StateChanged_RaisesEvent` | Event emission |
| `AgentStateMachine_Duration_TracksTimeInState` | Timing tracked |
| `AgentStateMachine_Reset_ReturnsToIdle` | Reset works |
| `AgentState_IsTerminal_CorrectForStates` | Extension method |
| `AgentState_IsActive_CorrectForStates` | Extension method |
| `AgentState_ToDisplayString_FormatsCorrectly` | Display strings |
| `AgentStateTransition_ToDescription_FormatsCorrectly` | Descriptions |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | All agent states are clearly defined |
| AC-2 | State transitions are validated |
| AC-3 | State machine enforces valid transitions only |
| AC-4 | Cancel/fail can occur from any non-terminal state |
| AC-5 | State changes emit events for UI updates |
| AC-6 | Iteration counter increments on BeginThinking |
| AC-7 | Timing information is tracked |
| AC-8 | State machine is thread-safe |

---

## Changelog Entry

```markdown
## v0.6.2d - Agent State Management

### Added
- `AgentState` enum with 11 states covering complete agent lifecycle
- `AgentStateTransition` enum with 11 valid transitions
- `AgentStateChangedEventArgs` for rich state change events
- `AgentStateExtensions` with display helpers and state queries
- `AgentStateMachine` with validated transitions and events
- `StateTransitionException` for invalid transition handling
- Thread-safe state management with timing information
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.2d | 0.5 day |
