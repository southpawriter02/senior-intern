# Design Specification: AIntern v0.6.5g "Keyboard Shortcuts System"

## Overview

**Version**: v0.6.5g
**Parent**: v0.6.5 Agent Loop & Polish
**Focus**: Global keyboard shortcuts for efficient agent interaction

### Purpose

Implement the keyboard shortcuts system that:
1. Provides global keyboard shortcuts for agent control
2. Enables quick tool approval/denial via keyboard
3. Supports contextual shortcuts (only active when conditions met)
4. Integrates with the MVVM messaging system
5. Displays a help dialog with all available shortcuts

### Dependencies

**From CommunityToolkit.Mvvm**:
- `IMessenger` for messaging
- `WeakReferenceMessenger.Default`

**From Avalonia**:
- `KeyGesture`, `KeyEventArgs`, `KeyModifiers`

**From v0.6.5c (Agent Activity ViewModel)**:
- `AgentState` enum

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    v0.6.5g Keyboard Shortcuts Architecture                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  System Overview:                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  MainWindow.KeyDown                                                      │ │
│  │         │                                                                │ │
│  │         ▼                                                                │ │
│  │  IKeyboardShortcutService.HandleKeyEventAsync(e, context)               │ │
│  │         │                                                                │ │
│  │         ├── Build KeyGesture from KeyEventArgs                          │ │
│  │         ├── Look up ShortcutAction in dictionary                        │ │
│  │         ├── Check context requirements:                                 │ │
│  │         │   ├── RequiresAgentActive → context.IsAgentActive            │ │
│  │         │   └── RequiresApprovalPending → context.IsApprovalPending    │ │
│  │         │                                                                │ │
│  │         ▼                                                                │ │
│  │  ShortcutAction.ExecuteAsync()                                          │ │
│  │         │                                                                │ │
│  │         ▼                                                                │ │
│  │  IMessenger.Send<TMessage>()                                            │ │
│  │         │                                                                │ │
│  │         ▼                                                                │ │
│  │  ChatViewModel receives and handles message                             │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Class Structure:                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  IKeyboardShortcutService                                                │ │
│  │  ├── IsEnabled: bool                                                    │ │
│  │  ├── Register(KeyGesture, ShortcutAction)                               │ │
│  │  ├── Unregister(KeyGesture)                                             │ │
│  │  ├── HandleKeyEventAsync(KeyEventArgs, ShortcutContext): Task<bool>    │ │
│  │  └── GetAllShortcuts(): IReadOnlyDictionary                             │ │
│  │                                                                          │ │
│  │  KeyboardShortcutService : IKeyboardShortcutService                     │ │
│  │  ├── _shortcuts: Dictionary<KeyGesture, ShortcutAction>                 │ │
│  │  ├── _messenger: IMessenger                                             │ │
│  │  ├── RegisterDefaultShortcuts()                                         │ │
│  │  └── GetShortcutsByCategory(ShortcutCategory)                          │ │
│  │                                                                          │ │
│  │  ShortcutAction                                                          │ │
│  │  ├── Name: string                                                       │ │
│  │  ├── Category: ShortcutCategory                                         │ │
│  │  ├── RequiresAgentActive: bool                                          │ │
│  │  ├── RequiresApprovalPending: bool                                      │ │
│  │  └── ExecuteAsync(): Task                                               │ │
│  │                                                                          │ │
│  │  ShortcutContext                                                         │ │
│  │  ├── IsAgentActive: bool                                                │ │
│  │  ├── IsApprovalPending: bool                                            │ │
│  │  └── IsChatInputFocused: bool                                           │ │
│  │                                                                          │ │
│  │  ShortcutCategory (enum)                                                 │ │
│  │  └── Agent, Approval, Navigation, Help                                  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Default Shortcuts

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Default Keyboard Shortcuts                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Category: Agent                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Shortcut         │ Action               │ Context Required             │ │
│  │───────────────────│──────────────────────│──────────────────────────────│ │
│  │  Ctrl+Shift+A     │ Toggle Agent Mode    │ None                         │ │
│  │  Escape           │ Cancel Execution     │ IsAgentActive = true         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Category: Approval                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Shortcut         │ Action               │ Context Required             │ │
│  │───────────────────│──────────────────────│──────────────────────────────│ │
│  │  Enter            │ Approve Tool         │ IsApprovalPending = true     │ │
│  │  Ctrl+Enter       │ Approve & Remember   │ IsApprovalPending = true     │ │
│  │  Backspace        │ Deny Tool            │ IsApprovalPending = true     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Category: Navigation                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Shortcut         │ Action               │ Context Required             │ │
│  │───────────────────│──────────────────────│──────────────────────────────│ │
│  │  Ctrl+L           │ Focus Chat Input     │ None                         │ │
│  │  Ctrl+Shift+,     │ Open Agent Settings  │ None                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Category: Help                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Shortcut         │ Action               │ Context Required             │ │
│  │───────────────────│──────────────────────│──────────────────────────────│ │
│  │  Ctrl+Shift+?     │ Show Shortcut Help   │ None                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Message Flow:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  Shortcut                    Message Sent                                │ │
│  │  ───────────────────────     ─────────────────────────────────────────  │ │
│  │  Ctrl+Shift+A           →    ToggleAgentModeMessage                     │ │
│  │  Escape                 →    CancelAgentExecutionMessage                │ │
│  │  Enter                  →    ApproveToolCallMessage(remember: false)    │ │
│  │  Ctrl+Enter             →    ApproveToolCallMessage(remember: true)     │ │
│  │  Backspace              →    DenyToolCallMessage                        │ │
│  │  Ctrl+L                 →    FocusChatInputMessage                      │ │
│  │  Ctrl+Shift+,           →    OpenAgentSettingsMessage                   │ │
│  │  Ctrl+Shift+?           →    ShowShortcutHelpMessage                    │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. IKeyboardShortcutService.cs

**Location**: `src/SeniorIntern.Desktop/Services/IKeyboardShortcutService.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

using System.Collections.Generic;
using System.Threading.Tasks;
using Avalonia.Input;

/// <summary>
/// Interface for the keyboard shortcut handling service.
/// </summary>
public interface IKeyboardShortcutService
{
    /// <summary>
    /// Whether keyboard shortcut handling is enabled.
    /// </summary>
    /// <remarks>
    /// When disabled, no shortcuts will be processed.
    /// </remarks>
    bool IsEnabled { get; set; }

    /// <summary>
    /// Register a keyboard shortcut.
    /// </summary>
    /// <param name="gesture">The key gesture to register.</param>
    /// <param name="action">The action to execute when the gesture is pressed.</param>
    void Register(KeyGesture gesture, ShortcutAction action);

    /// <summary>
    /// Unregister a keyboard shortcut.
    /// </summary>
    /// <param name="gesture">The key gesture to unregister.</param>
    void Unregister(KeyGesture gesture);

    /// <summary>
    /// Handle a key event, executing the associated shortcut if found.
    /// </summary>
    /// <param name="e">The key event arguments.</param>
    /// <param name="context">The current context for evaluating conditions.</param>
    /// <returns>True if a shortcut was executed, false otherwise.</returns>
    Task<bool> HandleKeyEventAsync(KeyEventArgs e, ShortcutContext context);

    /// <summary>
    /// Get all registered shortcuts.
    /// </summary>
    /// <returns>Read-only dictionary of gestures to actions.</returns>
    IReadOnlyDictionary<KeyGesture, ShortcutAction> GetAllShortcuts();

    /// <summary>
    /// Get shortcuts by category.
    /// </summary>
    /// <param name="category">The category to filter by.</param>
    /// <returns>Enumerable of gesture-action pairs in the category.</returns>
    IEnumerable<(KeyGesture Gesture, ShortcutAction Action)> GetShortcutsByCategory(ShortcutCategory category);
}
```

### 2. KeyboardShortcutService.cs

**Location**: `src/SeniorIntern.Desktop/Services/KeyboardShortcutService.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Avalonia.Input;
using CommunityToolkit.Mvvm.Messaging;
using Microsoft.Extensions.Logging;
using SeniorIntern.Desktop.Messages;

/// <summary>
/// Service for handling global keyboard shortcuts.
/// </summary>
/// <remarks>
/// <para>
/// This service manages a dictionary of keyboard shortcuts and their associated
/// actions. It supports contextual shortcuts that are only active under certain
/// conditions (e.g., agent active, approval pending).
/// </para>
/// <para>
/// Shortcuts are executed by sending messages via the MVVM Messenger pattern,
/// allowing decoupled handling by ViewModels.
/// </para>
/// </remarks>
public sealed class KeyboardShortcutService : IKeyboardShortcutService
{
    private readonly Dictionary<KeyGesture, ShortcutAction> _shortcuts = new(new KeyGestureComparer());
    private readonly IMessenger _messenger;
    private readonly ILogger<KeyboardShortcutService> _logger;
    private bool _isEnabled = true;

    #region Constructor

    /// <summary>
    /// Initializes a new instance of the KeyboardShortcutService.
    /// </summary>
    public KeyboardShortcutService(IMessenger messenger, ILogger<KeyboardShortcutService> logger)
    {
        _messenger = messenger ?? throw new ArgumentNullException(nameof(messenger));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));

        RegisterDefaultShortcuts();

        _logger.LogInformation("KeyboardShortcutService initialized with {Count} shortcuts", _shortcuts.Count);
    }

    #endregion

    #region Properties

    /// <summary>
    /// Enable or disable keyboard shortcut handling.
    /// </summary>
    public bool IsEnabled
    {
        get => _isEnabled;
        set
        {
            _isEnabled = value;
            _logger.LogDebug("Keyboard shortcuts {State}", value ? "enabled" : "disabled");
        }
    }

    #endregion

    #region Default Shortcuts

    /// <summary>
    /// Register all default keyboard shortcuts.
    /// </summary>
    private void RegisterDefaultShortcuts()
    {
        // ========================================
        // Category: Agent
        // ========================================

        // Toggle Agent Mode: Ctrl+Shift+A
        Register(
            new KeyGesture(Key.A, KeyModifiers.Control | KeyModifiers.Shift),
            new ShortcutAction(
                name: "Toggle Agent Mode",
                category: ShortcutCategory.Agent,
                description: "Enable or disable agent mode",
                execute: () =>
                {
                    _messenger.Send(new ToggleAgentModeMessage());
                    return Task.CompletedTask;
                }));

        // Cancel Agent Execution: Escape
        Register(
            new KeyGesture(Key.Escape),
            new ShortcutAction(
                name: "Cancel Execution",
                category: ShortcutCategory.Agent,
                description: "Cancel the current agent execution",
                execute: () =>
                {
                    _messenger.Send(new CancelAgentExecutionMessage());
                    return Task.CompletedTask;
                },
                requiresAgentActive: true));

        // ========================================
        // Category: Approval
        // ========================================

        // Approve Pending Tool Call: Enter
        Register(
            new KeyGesture(Key.Enter),
            new ShortcutAction(
                name: "Approve Tool",
                category: ShortcutCategory.Approval,
                description: "Approve the pending tool call",
                execute: () =>
                {
                    _messenger.Send(new ApproveToolCallMessage(remember: false));
                    return Task.CompletedTask;
                },
                requiresApprovalPending: true));

        // Approve and Remember: Ctrl+Enter
        Register(
            new KeyGesture(Key.Enter, KeyModifiers.Control),
            new ShortcutAction(
                name: "Approve & Remember",
                category: ShortcutCategory.Approval,
                description: "Approve and remember for this session",
                execute: () =>
                {
                    _messenger.Send(new ApproveToolCallMessage(remember: true));
                    return Task.CompletedTask;
                },
                requiresApprovalPending: true));

        // Deny Pending Tool Call: Backspace
        Register(
            new KeyGesture(Key.Back),
            new ShortcutAction(
                name: "Deny Tool",
                category: ShortcutCategory.Approval,
                description: "Deny the pending tool call",
                execute: () =>
                {
                    _messenger.Send(new DenyToolCallMessage());
                    return Task.CompletedTask;
                },
                requiresApprovalPending: true));

        // ========================================
        // Category: Navigation
        // ========================================

        // Focus Chat Input: Ctrl+L
        Register(
            new KeyGesture(Key.L, KeyModifiers.Control),
            new ShortcutAction(
                name: "Focus Input",
                category: ShortcutCategory.Navigation,
                description: "Focus the chat input field",
                execute: () =>
                {
                    _messenger.Send(new FocusChatInputMessage());
                    return Task.CompletedTask;
                }));

        // Open Agent Settings: Ctrl+Shift+,
        Register(
            new KeyGesture(Key.OemComma, KeyModifiers.Control | KeyModifiers.Shift),
            new ShortcutAction(
                name: "Agent Settings",
                category: ShortcutCategory.Navigation,
                description: "Open the agent settings panel",
                execute: () =>
                {
                    _messenger.Send(new OpenAgentSettingsMessage());
                    return Task.CompletedTask;
                }));

        // ========================================
        // Category: Help
        // ========================================

        // Show Shortcut Help: Ctrl+Shift+?
        Register(
            new KeyGesture(Key.OemQuestion, KeyModifiers.Control | KeyModifiers.Shift),
            new ShortcutAction(
                name: "Show Shortcuts",
                category: ShortcutCategory.Help,
                description: "Show the keyboard shortcuts help dialog",
                execute: () =>
                {
                    _messenger.Send(new ShowShortcutHelpMessage());
                    return Task.CompletedTask;
                }));
    }

    #endregion

    #region Registration

    /// <summary>
    /// Register a keyboard shortcut.
    /// </summary>
    public void Register(KeyGesture gesture, ShortcutAction action)
    {
        ArgumentNullException.ThrowIfNull(gesture);
        ArgumentNullException.ThrowIfNull(action);

        _shortcuts[gesture] = action;
        _logger.LogDebug("Registered shortcut: {Gesture} -> {Action}", gesture, action.Name);
    }

    /// <summary>
    /// Unregister a keyboard shortcut.
    /// </summary>
    public void Unregister(KeyGesture gesture)
    {
        ArgumentNullException.ThrowIfNull(gesture);

        if (_shortcuts.Remove(gesture))
        {
            _logger.LogDebug("Unregistered shortcut: {Gesture}", gesture);
        }
    }

    #endregion

    #region Event Handling

    /// <summary>
    /// Handle a key event, executing the associated shortcut if found.
    /// </summary>
    public async Task<bool> HandleKeyEventAsync(KeyEventArgs e, ShortcutContext context)
    {
        if (!IsEnabled)
            return false;

        ArgumentNullException.ThrowIfNull(e);
        ArgumentNullException.ThrowIfNull(context);

        // Build gesture from event
        var gesture = new KeyGesture(e.Key, e.KeyModifiers);

        // Look up shortcut
        if (!_shortcuts.TryGetValue(gesture, out var action))
            return false;

        // Check context requirements
        if (action.RequiresAgentActive && !context.IsAgentActive)
        {
            _logger.LogTrace("Shortcut {Name} skipped: agent not active", action.Name);
            return false;
        }

        if (action.RequiresApprovalPending && !context.IsApprovalPending)
        {
            _logger.LogTrace("Shortcut {Name} skipped: no approval pending", action.Name);
            return false;
        }

        // Check if input is focused and shortcut conflicts
        if (context.IsChatInputFocused && action.ConflictsWithTextInput)
        {
            _logger.LogTrace("Shortcut {Name} skipped: conflicts with text input", action.Name);
            return false;
        }

        // Execute the shortcut
        try
        {
            _logger.LogDebug("Executing shortcut: {Name}", action.Name);
            await action.ExecuteAsync();
            e.Handled = true;
            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error executing shortcut: {Name}", action.Name);
            return false;
        }
    }

    #endregion

    #region Query Methods

    /// <summary>
    /// Get all registered shortcuts.
    /// </summary>
    public IReadOnlyDictionary<KeyGesture, ShortcutAction> GetAllShortcuts() => _shortcuts;

    /// <summary>
    /// Get shortcuts by category.
    /// </summary>
    public IEnumerable<(KeyGesture Gesture, ShortcutAction Action)> GetShortcutsByCategory(ShortcutCategory category)
    {
        foreach (var (gesture, action) in _shortcuts)
        {
            if (action.Category == category)
                yield return (gesture, action);
        }
    }

    #endregion
}

/// <summary>
/// Comparer for KeyGesture to use as dictionary key.
/// </summary>
internal sealed class KeyGestureComparer : IEqualityComparer<KeyGesture>
{
    public bool Equals(KeyGesture? x, KeyGesture? y)
    {
        if (x is null && y is null) return true;
        if (x is null || y is null) return false;
        return x.Key == y.Key && x.KeyModifiers == y.KeyModifiers;
    }

    public int GetHashCode(KeyGesture obj)
    {
        return HashCode.Combine(obj.Key, obj.KeyModifiers);
    }
}
```

### 3. ShortcutAction.cs

**Location**: `src/SeniorIntern.Desktop/Services/ShortcutAction.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

using System;
using System.Threading.Tasks;

/// <summary>
/// Action associated with a keyboard shortcut.
/// </summary>
/// <remarks>
/// <para>
/// Encapsulates the action to execute when a shortcut is triggered,
/// along with metadata like name, category, and context requirements.
/// </para>
/// </remarks>
public sealed class ShortcutAction
{
    private readonly Func<Task> _execute;

    #region Properties

    /// <summary>
    /// Display name of the shortcut.
    /// </summary>
    public string Name { get; }

    /// <summary>
    /// Description of what the shortcut does.
    /// </summary>
    public string Description { get; }

    /// <summary>
    /// Category for grouping in the help dialog.
    /// </summary>
    public ShortcutCategory Category { get; }

    /// <summary>
    /// Whether this shortcut requires the agent to be active.
    /// </summary>
    /// <remarks>
    /// If true, the shortcut will only execute when IsAgentActive is true.
    /// </remarks>
    public bool RequiresAgentActive { get; }

    /// <summary>
    /// Whether this shortcut requires an approval to be pending.
    /// </summary>
    /// <remarks>
    /// If true, the shortcut will only execute when IsApprovalPending is true.
    /// </remarks>
    public bool RequiresApprovalPending { get; }

    /// <summary>
    /// Whether this shortcut conflicts with text input.
    /// </summary>
    /// <remarks>
    /// Shortcuts like Enter or Backspace conflict with normal typing
    /// when the chat input is focused.
    /// </remarks>
    public bool ConflictsWithTextInput { get; }

    #endregion

    #region Constructor

    /// <summary>
    /// Create a new shortcut action.
    /// </summary>
    public ShortcutAction(
        string name,
        ShortcutCategory category,
        Func<Task> execute,
        string description = "",
        bool requiresAgentActive = false,
        bool requiresApprovalPending = false,
        bool conflictsWithTextInput = false)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Category = category;
        Description = description ?? string.Empty;
        _execute = execute ?? throw new ArgumentNullException(nameof(execute));
        RequiresAgentActive = requiresAgentActive;
        RequiresApprovalPending = requiresApprovalPending;

        // Auto-detect conflict for common keys
        ConflictsWithTextInput = conflictsWithTextInput ||
            (requiresApprovalPending && !requiresAgentActive);
    }

    #endregion

    #region Execution

    /// <summary>
    /// Execute the shortcut action.
    /// </summary>
    public Task ExecuteAsync() => _execute();

    #endregion
}

/// <summary>
/// Categories for organizing shortcuts in the help dialog.
/// </summary>
public enum ShortcutCategory
{
    /// <summary>
    /// Agent control shortcuts (toggle, cancel).
    /// </summary>
    Agent,

    /// <summary>
    /// Tool approval shortcuts (approve, deny).
    /// </summary>
    Approval,

    /// <summary>
    /// Navigation shortcuts (focus, settings).
    /// </summary>
    Navigation,

    /// <summary>
    /// Help shortcuts (show help).
    /// </summary>
    Help
}

/// <summary>
/// Extension methods for ShortcutCategory.
/// </summary>
public static class ShortcutCategoryExtensions
{
    /// <summary>
    /// Get display name for the category.
    /// </summary>
    public static string GetDisplayName(this ShortcutCategory category) => category switch
    {
        ShortcutCategory.Agent => "Agent",
        ShortcutCategory.Approval => "Tool Approval",
        ShortcutCategory.Navigation => "Navigation",
        ShortcutCategory.Help => "Help",
        _ => category.ToString()
    };

    /// <summary>
    /// Get sort order for displaying categories.
    /// </summary>
    public static int GetSortOrder(this ShortcutCategory category) => category switch
    {
        ShortcutCategory.Agent => 1,
        ShortcutCategory.Approval => 2,
        ShortcutCategory.Navigation => 3,
        ShortcutCategory.Help => 4,
        _ => 99
    };
}
```

### 4. ShortcutContext.cs

**Location**: `src/SeniorIntern.Desktop/Services/ShortcutContext.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

/// <summary>
/// Context for evaluating shortcut conditions.
/// </summary>
/// <remarks>
/// <para>
/// This context is built from the current application state and passed
/// to the keyboard shortcut service to determine which shortcuts are active.
/// </para>
/// </remarks>
public sealed class ShortcutContext
{
    /// <summary>
    /// Whether the agent is currently active (not idle).
    /// </summary>
    public bool IsAgentActive { get; init; }

    /// <summary>
    /// Whether an approval dialog is pending.
    /// </summary>
    public bool IsApprovalPending { get; init; }

    /// <summary>
    /// Whether the chat input field is currently focused.
    /// </summary>
    public bool IsChatInputFocused { get; init; }

    /// <summary>
    /// Whether any text input is currently focused.
    /// </summary>
    public bool IsAnyTextInputFocused { get; init; }

    /// <summary>
    /// Whether a modal dialog is open.
    /// </summary>
    public bool IsModalOpen { get; init; }

    /// <summary>
    /// Create an empty context (no conditions met).
    /// </summary>
    public static ShortcutContext Empty => new();

    /// <summary>
    /// Create a context with agent active.
    /// </summary>
    public static ShortcutContext AgentActive(bool approvalPending = false) => new()
    {
        IsAgentActive = true,
        IsApprovalPending = approvalPending
    };
}
```

### 5. ShortcutMessages.cs

**Location**: `src/SeniorIntern.Desktop/Messages/ShortcutMessages.cs`

```csharp
namespace SeniorIntern.Desktop.Messages;

/// <summary>
/// Message to toggle agent mode on/off.
/// </summary>
public sealed class ToggleAgentModeMessage { }

/// <summary>
/// Message to cancel the current agent execution.
/// </summary>
public sealed class CancelAgentExecutionMessage { }

/// <summary>
/// Message to approve a pending tool call.
/// </summary>
public sealed class ApproveToolCallMessage
{
    /// <summary>
    /// Whether to remember the approval decision for this session.
    /// </summary>
    public bool Remember { get; }

    /// <summary>
    /// Create an approve message.
    /// </summary>
    /// <param name="remember">Whether to remember the decision.</param>
    public ApproveToolCallMessage(bool remember = false)
    {
        Remember = remember;
    }
}

/// <summary>
/// Message to deny a pending tool call.
/// </summary>
public sealed class DenyToolCallMessage
{
    /// <summary>
    /// Optional reason for denial.
    /// </summary>
    public string? Reason { get; init; }
}

/// <summary>
/// Message to focus the chat input field.
/// </summary>
public sealed class FocusChatInputMessage { }

/// <summary>
/// Message to open the agent settings panel.
/// </summary>
public sealed class OpenAgentSettingsMessage { }

/// <summary>
/// Message to show the shortcut help dialog.
/// </summary>
public sealed class ShowShortcutHelpMessage { }
```

### 6. ShortcutHelpDialog.axaml

**Location**: `src/SeniorIntern.Desktop/Views/ShortcutHelpDialog.axaml`

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="450" d:DesignHeight="500"
        x:Class="SeniorIntern.Desktop.Views.ShortcutHelpDialog"
        Title="Keyboard Shortcuts"
        Width="450"
        SizeToContent="Height"
        WindowStartupLocation="CenterOwner"
        CanResize="False">

    <Window.Styles>
        <!-- Keyboard key badge -->
        <Style Selector="Border.key-badge">
            <Setter Property="Background" Value="{DynamicResource SurfaceBackgroundAlt}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="MinWidth" Value="40" />
            <Setter Property="HorizontalAlignment" Value="Right" />
        </Style>

        <!-- Key text -->
        <Style Selector="Border.key-badge > TextBlock">
            <Setter Property="FontFamily" Value="{StaticResource MonoFont}" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="HorizontalAlignment" Value="Center" />
        </Style>

        <!-- Section header -->
        <Style Selector="TextBlock.section-header">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Margin" Value="0,0,0,8" />
        </Style>

        <!-- Shortcut row -->
        <Style Selector="Grid.shortcut-row">
            <Setter Property="Margin" Value="0,4" />
        </Style>
    </Window.Styles>

    <StackPanel Spacing="16" Padding="24">

        <!-- Title -->
        <TextBlock Text="Keyboard Shortcuts"
                   FontSize="18"
                   FontWeight="SemiBold" />

        <!-- ============================================== -->
        <!-- Agent Shortcuts                                -->
        <!-- ============================================== -->
        <StackPanel Spacing="4">
            <TextBlock Text="Agent" Classes="section-header" />

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <TextBlock Text="Toggle Agent Mode" VerticalAlignment="Center" />
                <Border Classes="key-badge">
                    <TextBlock Text="Ctrl+Shift+A" />
                </Border>
            </Grid>

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <StackPanel>
                    <TextBlock Text="Cancel Execution" />
                    <TextBlock Text="Only when agent is active"
                               FontSize="10"
                               Foreground="{DynamicResource TextMuted}" />
                </StackPanel>
                <Border Classes="key-badge">
                    <TextBlock Text="Escape" />
                </Border>
            </Grid>
        </StackPanel>

        <Separator />

        <!-- ============================================== -->
        <!-- Approval Shortcuts                             -->
        <!-- ============================================== -->
        <StackPanel Spacing="4">
            <TextBlock Text="Tool Approval" Classes="section-header" />

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <StackPanel>
                    <TextBlock Text="Approve Tool" />
                    <TextBlock Text="When approval is pending"
                               FontSize="10"
                               Foreground="{DynamicResource TextMuted}" />
                </StackPanel>
                <Border Classes="key-badge">
                    <TextBlock Text="Enter" />
                </Border>
            </Grid>

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <TextBlock Text="Approve &amp; Remember" VerticalAlignment="Center" />
                <Border Classes="key-badge">
                    <TextBlock Text="Ctrl+Enter" />
                </Border>
            </Grid>

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <TextBlock Text="Deny Tool" VerticalAlignment="Center" />
                <Border Classes="key-badge">
                    <TextBlock Text="Backspace" />
                </Border>
            </Grid>
        </StackPanel>

        <Separator />

        <!-- ============================================== -->
        <!-- Navigation Shortcuts                           -->
        <!-- ============================================== -->
        <StackPanel Spacing="4">
            <TextBlock Text="Navigation" Classes="section-header" />

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <TextBlock Text="Focus Input" VerticalAlignment="Center" />
                <Border Classes="key-badge">
                    <TextBlock Text="Ctrl+L" />
                </Border>
            </Grid>

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <TextBlock Text="Agent Settings" VerticalAlignment="Center" />
                <Border Classes="key-badge">
                    <TextBlock Text="Ctrl+Shift+," />
                </Border>
            </Grid>

            <Grid ColumnDefinitions="*, Auto" Classes="shortcut-row">
                <TextBlock Text="Show This Help" VerticalAlignment="Center" />
                <Border Classes="key-badge">
                    <TextBlock Text="Ctrl+Shift+?" />
                </Border>
            </Grid>
        </StackPanel>

        <!-- Close Button -->
        <Button Content="Close"
                HorizontalAlignment="Right"
                Padding="24,8"
                Click="OnCloseClick" />

    </StackPanel>
</Window>
```

### 7. ShortcutHelpDialog.axaml.cs

**Location**: `src/SeniorIntern.Desktop/Views/ShortcutHelpDialog.axaml.cs`

```csharp
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;
using Avalonia.Interactivity;

/// <summary>
/// Dialog showing all available keyboard shortcuts.
/// </summary>
public partial class ShortcutHelpDialog : Window
{
    /// <summary>
    /// Initializes a new instance of the ShortcutHelpDialog.
    /// </summary>
    public ShortcutHelpDialog()
    {
        InitializeComponent();
    }

    /// <summary>
    /// Handle close button click.
    /// </summary>
    private void OnCloseClick(object? sender, RoutedEventArgs e)
    {
        Close();
    }
}
```

### 8. MainWindow Integration

**Location**: `src/SeniorIntern.Desktop/Views/MainWindow.axaml.cs` (modification)

```csharp
// Add to MainWindow.axaml.cs

using SeniorIntern.Desktop.Services;
using Microsoft.Extensions.DependencyInjection;

public partial class MainWindow : Window
{
    private readonly IKeyboardShortcutService _shortcutService;

    public MainWindow()
    {
        InitializeComponent();

        // Get shortcut service from DI
        _shortcutService = App.Current.Services.GetRequiredService<IKeyboardShortcutService>();

        // Subscribe to key events
        KeyDown += OnMainWindowKeyDown;
    }

    /// <summary>
    /// Handle key down events for global shortcuts.
    /// </summary>
    private async void OnMainWindowKeyDown(object? sender, KeyEventArgs e)
    {
        // Skip if already handled
        if (e.Handled) return;

        // Build context from current state
        var viewModel = DataContext as MainWindowViewModel;
        var context = new ShortcutContext
        {
            IsAgentActive = viewModel?.IsAgentActive ?? false,
            IsApprovalPending = viewModel?.IsApprovalPending ?? false,
            IsChatInputFocused = viewModel?.IsChatInputFocused ?? false,
            IsAnyTextInputFocused = FocusManager.GetFocusedElement(this) is TextBox,
            IsModalOpen = false // Could check for open dialogs
        };

        // Handle the key event
        await _shortcutService.HandleKeyEventAsync(e, context);
    }
}
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `IKeyboardShortcutService.cs` | `Services/` | Service interface | ~50 |
| `KeyboardShortcutService.cs` | `Services/` | Service implementation | ~250 |
| `ShortcutAction.cs` | `Services/` | Action class and enums | ~130 |
| `ShortcutContext.cs` | `Services/` | Context model | ~50 |
| `ShortcutMessages.cs` | `Messages/` | Message classes | ~55 |
| `ShortcutHelpDialog.axaml` | `Views/` | Help dialog XAML | ~150 |
| `ShortcutHelpDialog.axaml.cs` | `Views/` | Help dialog code-behind | ~25 |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | KeyboardShortcutService registers default shortcuts |
| AC-2 | Ctrl+Shift+A toggles agent mode |
| AC-3 | Escape cancels agent execution (when agent active) |
| AC-4 | Enter approves pending tool call (when approval pending) |
| AC-5 | Ctrl+Enter approves and remembers |
| AC-6 | Backspace denies tool call (when approval pending) |
| AC-7 | Context conditions evaluated correctly |
| AC-8 | Shortcut help dialog displays all shortcuts |
| AC-9 | Shortcuts can be enabled/disabled |

---

## Changelog Entry

```markdown
## v0.6.5g - Keyboard Shortcuts System

### Added
- `IKeyboardShortcutService` interface
  - IsEnabled property
  - Register/Unregister methods
  - HandleKeyEventAsync(KeyEventArgs, ShortcutContext)
  - GetAllShortcuts(), GetShortcutsByCategory()
- `KeyboardShortcutService` implementation
  - Dictionary-based gesture lookup with KeyGestureComparer
  - Default shortcuts registration
  - Context-aware execution
  - Logging integration
- `ShortcutAction` class
  - Properties: Name, Description, Category
  - Requirements: RequiresAgentActive, RequiresApprovalPending, ConflictsWithTextInput
  - ExecuteAsync() method
- `ShortcutCategory` enum (Agent, Approval, Navigation, Help)
- `ShortcutContext` class
  - Properties: IsAgentActive, IsApprovalPending, IsChatInputFocused, IsAnyTextInputFocused, IsModalOpen
  - Factory methods: Empty, AgentActive()
- Message classes:
  - ToggleAgentModeMessage
  - CancelAgentExecutionMessage
  - ApproveToolCallMessage (with Remember property)
  - DenyToolCallMessage (with optional Reason)
  - FocusChatInputMessage
  - OpenAgentSettingsMessage
  - ShowShortcutHelpMessage
- `ShortcutHelpDialog` window
  - Organized by category (Agent, Approval, Navigation)
  - Key badges with monospace font
  - Context notes for conditional shortcuts
- MainWindow integration
  - KeyDown event handler
  - Context building from ViewModel state

### Default Shortcuts
| Shortcut | Action | Condition |
|----------|--------|-----------|
| Ctrl+Shift+A | Toggle Agent Mode | - |
| Escape | Cancel Execution | Agent active |
| Enter | Approve Tool | Approval pending |
| Ctrl+Enter | Approve & Remember | Approval pending |
| Backspace | Deny Tool | Approval pending |
| Ctrl+L | Focus Input | - |
| Ctrl+Shift+, | Agent Settings | - |
| Ctrl+Shift+? | Show Shortcuts | - |
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.5g | 0.5 day |
