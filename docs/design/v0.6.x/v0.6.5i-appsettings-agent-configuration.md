# Design Specification: AIntern v0.6.5i "AppSettings Agent Configuration"

## Overview

**Version**: v0.6.5i
**Parent**: v0.6.5 Agent Loop & Polish
**Focus**: Add agent settings to the application settings persistence system

### Purpose

Integrate agent settings with the application settings system:
1. Extend `ISettingsService` with agent settings methods
2. Add `AgentSettings` property to `AppSettings` model
3. Implement persistence in `SettingsService`
4. Support JSON serialization for settings storage
5. Provide migration for existing installations

### Dependencies

**From v0.6.5e (Agent Settings ViewModel)**:
- `AgentSettings` model

**From v0.6.4 (Safety & Approval)**:
- `PolicyMode` enum
- `RiskLevel` enum

**From Existing Infrastructure**:
- `ISettingsService` interface
- `SettingsService` implementation
- `AppSettings` model
- JSON file-based storage

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    v0.6.5i AppSettings Agent Configuration                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Settings Hierarchy:                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  AppSettings                                                             │ │
│  │  ├── General                                                            │ │
│  │  │   ├── Theme: string                                                  │ │
│  │  │   ├── Language: string                                               │ │
│  │  │   └── ...                                                            │ │
│  │  │                                                                       │ │
│  │  ├── LLM                                                                 │ │
│  │  │   ├── ModelPath: string                                              │ │
│  │  │   ├── ContextSize: int                                               │ │
│  │  │   └── ...                                                            │ │
│  │  │                                                                       │ │
│  │  ├── Agent  ← NEW                                                       │ │
│  │  │   ├── PolicyMode: PolicyMode                                         │ │
│  │  │   ├── ApprovalThreshold: RiskLevel                                   │ │
│  │  │   ├── MaxIterations: int                                             │ │
│  │  │   ├── ToolTimeout: TimeSpan                                          │ │
│  │  │   ├── RateLimitPerMinute: int                                        │ │
│  │  │   ├── RateLimitPerHour: int                                          │ │
│  │  │   ├── AuditAllExecutions: bool                                       │ │
│  │  │   ├── AuditIncludeParameters: bool                                   │ │
│  │  │   ├── AuditIncludeResults: bool                                      │ │
│  │  │   ├── AuditRetentionDays: int                                        │ │
│  │  │   ├── ProtectedPaths: List<string>                                   │ │
│  │  │   ├── ToolEnabled: Dictionary<string, bool>                          │ │
│  │  │   └── ToolOverrides: Dictionary<string, ToolOverrideAction>          │ │
│  │  │                                                                       │ │
│  │  └── Workspace                                                           │ │
│  │      ├── RecentWorkspaces: List<string>                                 │ │
│  │      └── ...                                                            │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Service Architecture:                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  ISettingsService                                                        │ │
│  │  ├── GetSettingsAsync(): Task<AppSettings>                              │ │
│  │  ├── SaveSettingsAsync(AppSettings): Task                               │ │
│  │  ├── GetAgentSettingsAsync(): Task<AgentSettings>  ← NEW                │ │
│  │  ├── SaveAgentSettingsAsync(AgentSettings): Task   ← NEW                │ │
│  │  └── ResetAgentSettingsAsync(): Task               ← NEW                │ │
│  │                                                                          │ │
│  │  SettingsService : ISettingsService                                     │ │
│  │  ├── _settingsPath: string                                              │ │
│  │  ├── _cachedSettings: AppSettings?                                      │ │
│  │  ├── _lock: SemaphoreSlim                                               │ │
│  │  ├── LoadSettingsAsync()                                                │ │
│  │  ├── SaveSettingsInternalAsync()                                        │ │
│  │  ├── GetAgentSettingsAsync()                                            │ │
│  │  ├── SaveAgentSettingsAsync()                                           │ │
│  │  └── MigrateSettings()                                                  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Settings File Structure

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Settings JSON Structure                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  File Location: ~/.seniorintern/settings.json                               │
│                                                                              │
│  {                                                                           │
│    "version": "0.6.5",                                                       │
│    "general": {                                                              │
│      "theme": "dark",                                                        │
│      "language": "en-US"                                                     │
│    },                                                                        │
│    "llm": {                                                                  │
│      "modelPath": "/path/to/model.gguf",                                     │
│      "contextSize": 4096                                                     │
│    },                                                                        │
│    "agent": {                         ← NEW SECTION                          │
│      "policyMode": "AskForRisky",                                           │
│      "approvalThreshold": "Medium",                                          │
│      "maxIterations": 10,                                                    │
│      "toolTimeoutSeconds": 60,                                               │
│      "rateLimitPerMinute": 30,                                               │
│      "rateLimitPerHour": 200,                                                │
│      "auditAllExecutions": true,                                             │
│      "auditIncludeParameters": true,                                         │
│      "auditIncludeResults": true,                                            │
│      "auditRetentionDays": 30,                                               │
│      "protectedPaths": [                                                     │
│        "~/.ssh",                                                             │
│        "~/.aws",                                                             │
│        "~/.gnupg"                                                            │
│      ],                                                                      │
│      "toolEnabled": {                                                        │
│        "DeleteFile": false                                                   │
│      },                                                                      │
│      "toolOverrides": {                                                      │
│        "RunCommand": "AlwaysAsk"                                             │
│      }                                                                       │
│    },                                                                        │
│    "workspace": {                                                            │
│      "recentWorkspaces": []                                                  │
│    }                                                                         │
│  }                                                                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. ISettingsService.cs (Extension)

**Location**: `src/SeniorIntern.Core/Interfaces/ISettingsService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using System.Threading.Tasks;
using SeniorIntern.Core.Models;

/// <summary>
/// Service interface for managing application settings.
/// </summary>
public interface ISettingsService
{
    #region General Settings

    /// <summary>
    /// Get the current application settings.
    /// </summary>
    /// <returns>Current settings or defaults if not set.</returns>
    Task<AppSettings> GetSettingsAsync();

    /// <summary>
    /// Save application settings.
    /// </summary>
    /// <param name="settings">Settings to save.</param>
    Task SaveSettingsAsync(AppSettings settings);

    /// <summary>
    /// Reset all settings to defaults.
    /// </summary>
    Task ResetAllSettingsAsync();

    #endregion

    #region Agent Settings

    /// <summary>
    /// Get agent-specific settings.
    /// </summary>
    /// <returns>Current agent settings or defaults.</returns>
    Task<AgentSettings> GetAgentSettingsAsync();

    /// <summary>
    /// Save agent-specific settings.
    /// </summary>
    /// <param name="settings">Agent settings to save.</param>
    Task SaveAgentSettingsAsync(AgentSettings settings);

    /// <summary>
    /// Reset agent settings to defaults.
    /// </summary>
    Task ResetAgentSettingsAsync();

    #endregion

    #region Events

    /// <summary>
    /// Event raised when settings change.
    /// </summary>
    event EventHandler<SettingsChangedEventArgs>? SettingsChanged;

    #endregion
}

/// <summary>
/// Event args for settings changes.
/// </summary>
public class SettingsChangedEventArgs : EventArgs
{
    /// <summary>
    /// The section that changed.
    /// </summary>
    public SettingsSection Section { get; init; }

    /// <summary>
    /// Create event args for a section change.
    /// </summary>
    public static SettingsChangedEventArgs ForSection(SettingsSection section) =>
        new() { Section = section };
}

/// <summary>
/// Sections of settings that can change.
/// </summary>
public enum SettingsSection
{
    /// <summary>
    /// All settings changed.
    /// </summary>
    All,

    /// <summary>
    /// General settings changed.
    /// </summary>
    General,

    /// <summary>
    /// LLM settings changed.
    /// </summary>
    LLM,

    /// <summary>
    /// Agent settings changed.
    /// </summary>
    Agent,

    /// <summary>
    /// Workspace settings changed.
    /// </summary>
    Workspace
}
```

### 2. AppSettings.cs (Extension)

**Location**: `src/SeniorIntern.Core/Models/AppSettings.cs`

```csharp
namespace SeniorIntern.Core.Models;

using System;
using System.Text.Json.Serialization;

/// <summary>
/// Root application settings model.
/// </summary>
/// <remarks>
/// <para>
/// All application settings are organized under this root model,
/// persisted as JSON to the user's settings directory.
/// </para>
/// </remarks>
public class AppSettings
{
    /// <summary>
    /// Settings file version for migration support.
    /// </summary>
    public string Version { get; set; } = "0.6.5";

    /// <summary>
    /// General application settings.
    /// </summary>
    public GeneralSettings General { get; set; } = new();

    /// <summary>
    /// LLM configuration settings.
    /// </summary>
    public LLMSettings LLM { get; set; } = new();

    /// <summary>
    /// Agent configuration settings.
    /// </summary>
    public AgentSettings Agent { get; set; } = new();

    /// <summary>
    /// Workspace settings.
    /// </summary>
    public WorkspaceSettings Workspace { get; set; } = new();

    /// <summary>
    /// Create default settings.
    /// </summary>
    public static AppSettings Default => new();

    /// <summary>
    /// Clone the settings.
    /// </summary>
    public AppSettings Clone()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(this);
        return System.Text.Json.JsonSerializer.Deserialize<AppSettings>(json) ?? new();
    }
}

/// <summary>
/// General application settings.
/// </summary>
public class GeneralSettings
{
    /// <summary>
    /// Application theme.
    /// </summary>
    public string Theme { get; set; } = "dark";

    /// <summary>
    /// Application language.
    /// </summary>
    public string Language { get; set; } = "en-US";

    /// <summary>
    /// Whether to check for updates on startup.
    /// </summary>
    public bool CheckForUpdates { get; set; } = true;

    /// <summary>
    /// Whether to minimize to system tray.
    /// </summary>
    public bool MinimizeToTray { get; set; } = false;
}

/// <summary>
/// LLM configuration settings.
/// </summary>
public class LLMSettings
{
    /// <summary>
    /// Path to the model file.
    /// </summary>
    public string? ModelPath { get; set; }

    /// <summary>
    /// Context window size.
    /// </summary>
    public int ContextSize { get; set; } = 4096;

    /// <summary>
    /// Number of GPU layers to use.
    /// </summary>
    public int GpuLayers { get; set; } = 0;

    /// <summary>
    /// Temperature for generation.
    /// </summary>
    public float Temperature { get; set; } = 0.7f;
}

/// <summary>
/// Workspace settings.
/// </summary>
public class WorkspaceSettings
{
    /// <summary>
    /// Recent workspace paths.
    /// </summary>
    public List<string> RecentWorkspaces { get; set; } = new();

    /// <summary>
    /// Maximum recent workspaces to remember.
    /// </summary>
    public int MaxRecentWorkspaces { get; set; } = 10;

    /// <summary>
    /// Whether to restore last workspace on startup.
    /// </summary>
    public bool RestoreLastWorkspace { get; set; } = true;
}
```

### 3. AgentSettingsDto.cs

**Location**: `src/SeniorIntern.Core/Models/AgentSettingsDto.cs`

```csharp
namespace SeniorIntern.Core.Models;

using System;
using System.Collections.Generic;
using System.Text.Json.Serialization;
using SeniorIntern.Core.Tools;
using SeniorIntern.Desktop.Models;

/// <summary>
/// Data transfer object for serializing agent settings to JSON.
/// </summary>
/// <remarks>
/// <para>
/// This DTO handles the conversion between <see cref="AgentSettings"/>
/// and JSON, managing TimeSpan serialization and enum string conversion.
/// </para>
/// </remarks>
public class AgentSettingsDto
{
    /// <summary>
    /// Policy mode for tool approval.
    /// </summary>
    [JsonConverter(typeof(JsonStringEnumConverter))]
    public PolicyMode PolicyMode { get; set; } = PolicyMode.AskForRisky;

    /// <summary>
    /// Risk level threshold for approval.
    /// </summary>
    [JsonConverter(typeof(JsonStringEnumConverter))]
    public RiskLevel ApprovalThreshold { get; set; } = RiskLevel.Medium;

    /// <summary>
    /// Maximum iterations per request.
    /// </summary>
    public int MaxIterations { get; set; } = 10;

    /// <summary>
    /// Tool timeout in seconds (simpler than TimeSpan for JSON).
    /// </summary>
    public int ToolTimeoutSeconds { get; set; } = 60;

    /// <summary>
    /// Rate limit per minute.
    /// </summary>
    public int RateLimitPerMinute { get; set; } = 30;

    /// <summary>
    /// Rate limit per hour.
    /// </summary>
    public int RateLimitPerHour { get; set; } = 200;

    /// <summary>
    /// Whether to audit all executions.
    /// </summary>
    public bool AuditAllExecutions { get; set; } = true;

    /// <summary>
    /// Whether to include parameters in audit log.
    /// </summary>
    public bool AuditIncludeParameters { get; set; } = true;

    /// <summary>
    /// Whether to include results in audit log.
    /// </summary>
    public bool AuditIncludeResults { get; set; } = true;

    /// <summary>
    /// Days to retain audit log entries.
    /// </summary>
    public int AuditRetentionDays { get; set; } = 30;

    /// <summary>
    /// Protected paths that tools cannot access.
    /// </summary>
    public List<string> ProtectedPaths { get; set; } = new()
    {
        "~/.ssh",
        "~/.aws",
        "~/.gnupg",
        "~/.config/secrets"
    };

    /// <summary>
    /// Per-tool enabled state (only stores disabled tools).
    /// </summary>
    public Dictionary<string, bool> ToolEnabled { get; set; } = new();

    /// <summary>
    /// Per-tool override actions (only stores non-default overrides).
    /// </summary>
    [JsonConverter(typeof(JsonStringEnumConverter))]
    public Dictionary<string, ToolOverrideAction> ToolOverrides { get; set; } = new();

    #region Conversion

    /// <summary>
    /// Convert from domain model to DTO.
    /// </summary>
    public static AgentSettingsDto FromAgentSettings(AgentSettings settings)
    {
        return new AgentSettingsDto
        {
            PolicyMode = settings.PolicyMode,
            ApprovalThreshold = settings.ApprovalThreshold,
            MaxIterations = settings.MaxIterations,
            ToolTimeoutSeconds = (int)settings.ToolTimeout.TotalSeconds,
            RateLimitPerMinute = settings.RateLimitPerMinute,
            RateLimitPerHour = settings.RateLimitPerHour,
            AuditAllExecutions = settings.AuditAllExecutions,
            AuditIncludeParameters = settings.AuditIncludeParameters,
            AuditIncludeResults = settings.AuditIncludeResults,
            AuditRetentionDays = settings.AuditRetentionDays,
            ProtectedPaths = settings.ProtectedPaths.ToList(),
            ToolEnabled = new Dictionary<string, bool>(settings.GetAllToolEnabledStates()),
            ToolOverrides = new Dictionary<string, ToolOverrideAction>(settings.GetAllToolOverrides())
        };
    }

    /// <summary>
    /// Convert from DTO to domain model.
    /// </summary>
    public AgentSettings ToAgentSettings()
    {
        var settings = new AgentSettings
        {
            PolicyMode = PolicyMode,
            ApprovalThreshold = ApprovalThreshold,
            MaxIterations = MaxIterations,
            ToolTimeout = TimeSpan.FromSeconds(ToolTimeoutSeconds),
            RateLimitPerMinute = RateLimitPerMinute,
            RateLimitPerHour = RateLimitPerHour,
            AuditAllExecutions = AuditAllExecutions,
            AuditIncludeParameters = AuditIncludeParameters,
            AuditIncludeResults = AuditIncludeResults,
            AuditRetentionDays = AuditRetentionDays,
            ProtectedPaths = ProtectedPaths.ToList()
        };

        // Apply tool enabled states
        foreach (var (toolId, enabled) in ToolEnabled)
        {
            settings.SetToolEnabled(toolId, enabled);
        }

        // Apply tool overrides
        foreach (var (toolId, action) in ToolOverrides)
        {
            settings.SetToolOverride(toolId, action);
        }

        return settings;
    }

    #endregion
}
```

### 4. SettingsService.cs (Implementation)

**Location**: `src/SeniorIntern.Services/SettingsService.cs`

```csharp
namespace SeniorIntern.Services;

using System;
using System.IO;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;

/// <summary>
/// Service for managing application settings persistence.
/// </summary>
/// <remarks>
/// <para>
/// Settings are stored as JSON in the user's application data directory.
/// The service uses caching and a semaphore to ensure thread-safe access.
/// </para>
/// </remarks>
public class SettingsService : ISettingsService, IDisposable
{
    private readonly string _settingsPath;
    private readonly ILogger<SettingsService> _logger;
    private readonly SemaphoreSlim _lock = new(1, 1);
    private readonly JsonSerializerOptions _jsonOptions;

    private AppSettings? _cachedSettings;
    private bool _disposed;

    /// <summary>
    /// Event raised when settings change.
    /// </summary>
    public event EventHandler<SettingsChangedEventArgs>? SettingsChanged;

    #region Constructor

    /// <summary>
    /// Initializes a new instance of the SettingsService.
    /// </summary>
    public SettingsService(ILogger<SettingsService> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));

        // Determine settings path
        var appDataPath = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var settingsDir = Path.Combine(appDataPath, "SeniorIntern");
        Directory.CreateDirectory(settingsDir);
        _settingsPath = Path.Combine(settingsDir, "settings.json");

        // Configure JSON options
        _jsonOptions = new JsonSerializerOptions
        {
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
            PropertyNameCaseInsensitive = true
        };

        _logger.LogInformation("SettingsService initialized. Path: {Path}", _settingsPath);
    }

    #endregion

    #region General Settings

    /// <summary>
    /// Get the current application settings.
    /// </summary>
    public async Task<AppSettings> GetSettingsAsync()
    {
        await _lock.WaitAsync();
        try
        {
            if (_cachedSettings is not null)
                return _cachedSettings;

            _cachedSettings = await LoadSettingsAsync();
            return _cachedSettings;
        }
        finally
        {
            _lock.Release();
        }
    }

    /// <summary>
    /// Save application settings.
    /// </summary>
    public async Task SaveSettingsAsync(AppSettings settings)
    {
        ArgumentNullException.ThrowIfNull(settings);

        await _lock.WaitAsync();
        try
        {
            await SaveSettingsInternalAsync(settings);
            _cachedSettings = settings;
            OnSettingsChanged(SettingsSection.All);
        }
        finally
        {
            _lock.Release();
        }
    }

    /// <summary>
    /// Reset all settings to defaults.
    /// </summary>
    public async Task ResetAllSettingsAsync()
    {
        await SaveSettingsAsync(AppSettings.Default);
        _logger.LogInformation("All settings reset to defaults");
    }

    #endregion

    #region Agent Settings

    /// <summary>
    /// Get agent-specific settings.
    /// </summary>
    public async Task<AgentSettings> GetAgentSettingsAsync()
    {
        var settings = await GetSettingsAsync();
        return settings.Agent;
    }

    /// <summary>
    /// Save agent-specific settings.
    /// </summary>
    public async Task SaveAgentSettingsAsync(AgentSettings agentSettings)
    {
        ArgumentNullException.ThrowIfNull(agentSettings);

        await _lock.WaitAsync();
        try
        {
            var settings = _cachedSettings ?? await LoadSettingsAsync();
            settings.Agent = agentSettings;

            await SaveSettingsInternalAsync(settings);
            _cachedSettings = settings;
            OnSettingsChanged(SettingsSection.Agent);

            _logger.LogInformation("Agent settings saved. PolicyMode: {Mode}", agentSettings.PolicyMode);
        }
        finally
        {
            _lock.Release();
        }
    }

    /// <summary>
    /// Reset agent settings to defaults.
    /// </summary>
    public async Task ResetAgentSettingsAsync()
    {
        await SaveAgentSettingsAsync(new AgentSettings());
        _logger.LogInformation("Agent settings reset to defaults");
    }

    #endregion

    #region Internal Methods

    /// <summary>
    /// Load settings from disk.
    /// </summary>
    private async Task<AppSettings> LoadSettingsAsync()
    {
        try
        {
            if (!File.Exists(_settingsPath))
            {
                _logger.LogDebug("Settings file not found, using defaults");
                return AppSettings.Default;
            }

            var json = await File.ReadAllTextAsync(_settingsPath);
            var settings = JsonSerializer.Deserialize<AppSettings>(json, _jsonOptions);

            if (settings is null)
            {
                _logger.LogWarning("Failed to deserialize settings, using defaults");
                return AppSettings.Default;
            }

            // Migrate if needed
            settings = await MigrateSettingsAsync(settings);

            _logger.LogDebug("Settings loaded successfully");
            return settings;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading settings, using defaults");
            return AppSettings.Default;
        }
    }

    /// <summary>
    /// Save settings to disk.
    /// </summary>
    private async Task SaveSettingsInternalAsync(AppSettings settings)
    {
        try
        {
            var json = JsonSerializer.Serialize(settings, _jsonOptions);
            await File.WriteAllTextAsync(_settingsPath, json);
            _logger.LogDebug("Settings saved to disk");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error saving settings");
            throw;
        }
    }

    /// <summary>
    /// Migrate settings from older versions.
    /// </summary>
    private async Task<AppSettings> MigrateSettingsAsync(AppSettings settings)
    {
        if (string.IsNullOrEmpty(settings.Version))
        {
            // Pre-versioned settings, migrate to 0.6.5
            settings.Version = "0.6.5";
            settings.Agent ??= new AgentSettings();
            await SaveSettingsInternalAsync(settings);
            _logger.LogInformation("Settings migrated to version 0.6.5");
        }

        // Add future migrations here as needed
        // if (Version.Parse(settings.Version) < Version.Parse("0.7.0"))
        // {
        //     // Migrate to 0.7.0
        // }

        return settings;
    }

    /// <summary>
    /// Raise the SettingsChanged event.
    /// </summary>
    private void OnSettingsChanged(SettingsSection section)
    {
        SettingsChanged?.Invoke(this, SettingsChangedEventArgs.ForSection(section));
    }

    #endregion

    #region IDisposable

    /// <summary>
    /// Dispose resources.
    /// </summary>
    public void Dispose()
    {
        if (_disposed) return;

        _lock.Dispose();
        _disposed = true;

        GC.SuppressFinalize(this);
    }

    #endregion
}
```

### 5. AppSettingsJsonContext.cs (Source Generator Support)

**Location**: `src/SeniorIntern.Core/Models/AppSettingsJsonContext.cs`

```csharp
namespace SeniorIntern.Core.Models;

using System.Text.Json.Serialization;

/// <summary>
/// JSON serialization context for AOT/trimming support.
/// </summary>
[JsonSerializable(typeof(AppSettings))]
[JsonSerializable(typeof(AgentSettings))]
[JsonSerializable(typeof(AgentSettingsDto))]
[JsonSerializable(typeof(GeneralSettings))]
[JsonSerializable(typeof(LLMSettings))]
[JsonSerializable(typeof(WorkspaceSettings))]
[JsonSourceGenerationOptions(
    PropertyNamingPolicy = JsonKnownNamingPolicy.CamelCase,
    WriteIndented = true)]
public partial class AppSettingsJsonContext : JsonSerializerContext
{
}
```

---

## Settings Migration Strategy

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Settings Migration Strategy                            │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Version Tracking:                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  settings.json                                                           │ │
│  │  {                                                                       │ │
│  │    "version": "0.6.5",  ← Version field for migration detection          │ │
│  │    ...                                                                   │ │
│  │  }                                                                       │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Migration Flow:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  1. Load settings from disk                                              │ │
│  │  2. Check version field                                                  │ │
│  │  3. If null or older: apply migrations sequentially                     │ │
│  │  4. Update version to current                                           │ │
│  │  5. Save migrated settings                                              │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Migration: Pre-0.6.5 → 0.6.5                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  • Add "agent" section with defaults                                     │ │
│  │  • Set version to "0.6.5"                                               │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Default Values (new installations):                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  PolicyMode: AskForRisky                                                 │ │
│  │  ApprovalThreshold: Medium                                               │ │
│  │  MaxIterations: 10                                                       │ │
│  │  ToolTimeout: 60 seconds                                                 │ │
│  │  RateLimitPerMinute: 30                                                  │ │
│  │  RateLimitPerHour: 200                                                   │ │
│  │  AuditAllExecutions: true                                                │ │
│  │  AuditIncludeParameters: true                                            │ │
│  │  AuditIncludeResults: true                                               │ │
│  │  AuditRetentionDays: 30                                                  │ │
│  │  ProtectedPaths: [~/.ssh, ~/.aws, ~/.gnupg, ~/.config/secrets]          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `ISettingsService.cs` | `Core/Interfaces/` | Extended interface | ~85 |
| `AppSettings.cs` | `Core/Models/` | Root settings model | ~100 |
| `AgentSettingsDto.cs` | `Core/Models/` | JSON serialization DTO | ~130 |
| `SettingsService.cs` | `Services/` | Implementation | ~200 |
| `AppSettingsJsonContext.cs` | `Core/Models/` | AOT support | ~20 |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `GetAgentSettingsAsync_ReturnsDefaults_WhenNoFile` | Default values |
| `GetAgentSettingsAsync_LoadsFromFile` | File loading |
| `SaveAgentSettingsAsync_PersistsToFile` | File saving |
| `SaveAgentSettingsAsync_UpdatesCache` | Cache update |
| `GetAgentSettingsAsync_ReturnsCached` | Cache hit |
| `Settings_SurviveRestart` | Persistence verification |
| `MigrateSettings_AddsAgentSection` | Migration |
| `MigrateSettings_PreservesExisting` | Migration safety |
| `AgentSettingsDto_RoundTrip` | DTO conversion |
| `SettingsChanged_RaisedOnSave` | Event firing |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | AgentSettings included in AppSettings |
| AC-2 | GetAgentSettingsAsync returns current settings |
| AC-3 | SaveAgentSettingsAsync persists settings |
| AC-4 | Default values applied for new installations |
| AC-5 | Settings survive application restart |

---

## Changelog Entry

```markdown
## v0.6.5i - AppSettings Agent Configuration

### Added
- `ISettingsService` interface extensions
  - GetAgentSettingsAsync(): Task<AgentSettings>
  - SaveAgentSettingsAsync(AgentSettings): Task
  - ResetAgentSettingsAsync(): Task
  - SettingsChanged event
  - SettingsChangedEventArgs class
  - SettingsSection enum (All, General, LLM, Agent, Workspace)
- `AppSettings` model
  - Version property for migration
  - Agent property: AgentSettings
  - General, LLM, Workspace sections
  - Clone() method
- `AgentSettingsDto` class
  - JSON-friendly serialization
  - TimeSpan → int seconds conversion
  - Enum string conversion
  - FromAgentSettings() / ToAgentSettings() methods
- `SettingsService` implementation
  - Thread-safe with SemaphoreSlim
  - File-based JSON persistence
  - Settings caching
  - Migration support (versioned)
  - SettingsChanged event
- `AppSettingsJsonContext` for AOT support

### Settings Location
- ~/.seniorintern/settings.json (cross-platform)

### Migration
- Pre-0.6.5 → 0.6.5: Adds agent section with defaults
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.5i | 0.5 day |
