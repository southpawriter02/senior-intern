# Design Specification: AIntern v0.6.4i "Approval Dialog ViewModel"

## Overview

**Version**: v0.6.4i
**Parent**: v0.6.4 Safety & Approval
**Focus**: ViewModel for the approval dialog handling user interactions

### Purpose

Implement the ViewModel for the approval dialog that:
1. Initializes with tool request data and classification
2. Manages timeout countdown with visual feedback
3. Handles Allow/Deny commands with result building
4. Supports parameter editing with JSON validation
5. Captures remember options for decision persistence
6. Provides computed properties for risk-based styling
7. Signals dialog close when decision is made

### Dependencies

**From v0.6.4b (Risk Classification Engine)**:
- `RiskClassificationResult`, `RiskFactor`
- `RiskLevel`

**From v0.6.4c (Permission Check System)**:
- `ApprovalDecision`, `RememberOption`

**From v0.6.4h (Approval Dialog UI)**:
- `RiskIcons` geometries
- Color palette

**From v0.6.1 (Tool Framework)**:
- `ITool`, `ToolCategory`, `ToolCallRequest`

**From Existing UI Layer**:
- `ViewModelBase`
- MVVM Toolkit (`ObservableProperty`, `RelayCommand`)
- Avalonia `DispatcherTimer`

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                  v0.6.4i Approval Dialog ViewModel Architecture               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ToolApprovalViewModel                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  Constructor Input:                                                      │ │
│  │  ├── ToolCallRequest request                                            │ │
│  │  ├── ITool tool                                                         │ │
│  │  ├── RiskClassificationResult classification                            │ │
│  │  ├── TimeSpan timeout                                                   │ │
│  │  └── bool allowEditing                                                  │ │
│  │                                                                          │ │
│  │  Observable Properties:                                                  │ │
│  │  ├── ToolName, CategoryText, RiskLevelText                              │ │
│  │  ├── RiskLevelBrush, RiskIconData                                       │ │
│  │  ├── ExecutionSummary, ParametersJson                                   │ │
│  │  ├── RiskFactors, HasRiskFactors                                        │ │
│  │  ├── RememberForSession, RememberAlways                                 │ │
│  │  ├── IsDetailsExpanded, IsEditingParameters                             │ │
│  │  ├── CanEditParameters, CanRememberPermanently                          │ │
│  │  ├── EditButtonText, ParameterValidationError                           │ │
│  │  └── TimeoutText, TimeoutProgress, TimeoutBrush                         │ │
│  │                                                                          │ │
│  │  Computed Properties (for styling):                                      │ │
│  │  ├── IsSafe, IsLow, IsMedium, IsHigh, IsCritical                        │ │
│  │                                                                          │ │
│  │  Commands:                                                               │ │
│  │  ├── AllowCommand      → Build approval, close dialog                   │ │
│  │  ├── DenyCommand       → Build denial, close dialog                     │ │
│  │  ├── ToggleEditCommand → Toggle edit mode with validation               │ │
│  │  └── CopyParametersCommand → Copy to clipboard                          │ │
│  │                                                                          │ │
│  │  Events:                                                                 │ │
│  │  └── DialogCloseRequested(ApprovalDecision?)                            │ │
│  │                                                                          │ │
│  │  Result:                                                                 │ │
│  │  └── ApprovalDecision? Result { get; }                                  │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## State Transitions

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     ViewModel State Transitions                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Initial State                                                               │
│      │                                                                       │
│      ▼                                                                       │
│  ┌─────────────────────────────────────────┐                                 │
│  │ Awaiting Decision                        │                                 │
│  │ - Timer running                         │                                 │
│  │ - TimeoutProgress: 100→0                │                                 │
│  │ - Result: null                          │                                 │
│  └────────────────┬────────────────────────┘                                 │
│                   │                                                           │
│       ┌───────────┼───────────┬───────────────────┐                          │
│       ▼           ▼           ▼                   ▼                          │
│  [User Allows] [User Denies] [Timeout]   [Edit Parameters]                  │
│       │           │           │                   │                          │
│       │           │           │                   ▼                          │
│       │           │           │          ┌─────────────────────┐             │
│       │           │           │          │ Editing Mode        │             │
│       │           │           │          │ - IsEditingParameters: true      │
│       │           │           │          │ - EditButtonText: "Done"         │
│       │           │           │          └─────────┬───────────┘             │
│       │           │           │                    │                          │
│       │           │           │          ┌─────────┴───────────┐             │
│       │           │           │          ▼                     ▼             │
│       │           │           │     [Done: Valid]       [Done: Invalid]     │
│       │           │           │          │                     │             │
│       │           │           │          ▼                     ▼             │
│       │           │           │    Exit edit mode      Show error            │
│       │           │           │          │             Stay in edit          │
│       │           │           │          │                                   │
│       ▼           ▼           ▼          │                                   │
│  ┌─────────────────────────────────────────┐                                 │
│  │ Decision Made                           │                                 │
│  │ - Timer stopped                        │                                 │
│  │ - Result: ApprovalDecision             │                                 │
│  │ - DialogCloseRequested raised          │                                 │
│  └─────────────────────────────────────────┘                                 │
│                                                                              │
│  Decision Building:                                                           │
│  ┌──────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  Allow:                                                                  ││
│  │  ApprovalDecision {                                                      ││
│  │    IsApproved = true,                                                    ││
│  │    RememberChoice = RememberForSession ? ForSession                      ││
│  │                   : RememberAlways ? Always                              ││
│  │                   : None,                                                ││
│  │    ModifiedParameters = (if edited) parsed JSON,                         ││
│  │    ToolId, RequestId                                                     ││
│  │  }                                                                       ││
│  │                                                                          ││
│  │  Deny:                                                                   ││
│  │  ApprovalDecision {                                                      ││
│  │    IsApproved = false,                                                   ││
│  │    IsDenied = true,                                                      ││
│  │    Reason = "User denied",                                               ││
│  │    RememberChoice = RememberForSession ? ForSession : None,              ││
│  │    ToolId, RequestId                                                     ││
│  │  }                                                                       ││
│  │                                                                          ││
│  │  Timeout:                                                                ││
│  │  ApprovalDecision {                                                      ││
│  │    IsApproved = false,                                                   ││
│  │    IsTimedOut = true,                                                    ││
│  │    Reason = "Approval timed out",                                        ││
│  │    ToolId, RequestId                                                     ││
│  │  }                                                                       ││
│  │                                                                          ││
│  └──────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Timeout Timer Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Timeout Timer Operation                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Timer Configuration:                                                        │
│  ├── Interval: 100ms (smooth progress updates)                              │
│  ├── Started: In constructor                                                 │
│  └── Stopped: On decision or timeout                                         │
│                                                                              │
│  OnTimeoutTick():                                                            │
│  ┌─────────────────────────────────────────┐                                 │
│  │ 1. Calculate elapsed time               │                                 │
│  │    elapsed = DateTime.UtcNow - _start   │                                 │
│  └────────────────┬────────────────────────┘                                 │
│                   │                                                           │
│                   ▼                                                           │
│  ┌─────────────────────────────────────────┐                                 │
│  │ 2. Calculate remaining time             │                                 │
│  │    remaining = _timeout - elapsed       │                                 │
│  └────────────────┬────────────────────────┘                                 │
│                   │                                                           │
│         ┌─────────┴─────────┐                                                │
│         ▼                   ▼                                                │
│     remaining ≤ 0       remaining > 0                                        │
│         │                   │                                                │
│         ▼                   ▼                                                │
│  ┌─────────────────┐  ┌─────────────────────────────────────┐               │
│  │ Handle Timeout  │  │ Update Display                      │               │
│  │ - Stop timer    │  │ - TimeoutProgress = % remaining    │               │
│  │ - Result = deny │  │ - TimeoutText = format time        │               │
│  │ - Close dialog  │  │ - TimeoutBrush = color by %        │               │
│  └─────────────────┘  └─────────────────────────────────────┘               │
│                                                                              │
│  TimeoutProgress Calculation:                                                │
│  progress = (remaining / timeout) * 100                                      │
│                                                                              │
│  TimeoutText Format:                                                         │
│  ├── > 60 seconds: "1:30" (minutes:seconds)                                 │
│  └── ≤ 60 seconds: "45s" (seconds only)                                     │
│                                                                              │
│  Color Thresholds:                                                           │
│  ├── > 50%: Green (#22C55E)                                                 │
│  ├── 25-50%: Orange (#F59E0B)                                               │
│  └── < 25%: Red (#EF4444)                                                   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. ToolApprovalViewModel.cs

**Location**: `src/SeniorIntern.Desktop/ViewModels/ToolApprovalViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using System.Collections.ObjectModel;
using System.Text.Json;
using Avalonia.Media;
using Avalonia.Threading;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Models.Permissions;
using SeniorIntern.Core.Tools;
using SeniorIntern.Desktop.Resources;

/// <summary>
/// ViewModel for the tool approval dialog.
/// </summary>
/// <remarks>
/// <para>
/// Manages the approval dialog state including:
/// </para>
/// <list type="bullet">
/// <item>Display data initialization from request/tool</item>
/// <item>Timeout countdown with visual feedback</item>
/// <item>Allow/Deny command handling</item>
/// <item>Parameter editing with JSON validation</item>
/// <item>Remember option capture</item>
/// </list>
/// </remarks>
public partial class ToolApprovalViewModel : ViewModelBase, IDisposable
{
    #region Private Fields

    private readonly ToolCallRequest _request;
    private readonly ITool _tool;
    private readonly RiskClassificationResult _classification;
    private readonly TimeSpan _timeout;
    private readonly DateTime _requestedAt;
    private readonly DispatcherTimer _timeoutTimer;
    private bool _disposed;

    #endregion

    #region Observable Properties - Tool Information

    /// <summary>
    /// Tool display name.
    /// </summary>
    [ObservableProperty]
    private string _toolName = string.Empty;

    /// <summary>
    /// Tool category display text.
    /// </summary>
    [ObservableProperty]
    private string _categoryText = string.Empty;

    /// <summary>
    /// Risk level display text.
    /// </summary>
    [ObservableProperty]
    private string _riskLevelText = string.Empty;

    /// <summary>
    /// Brush for risk level coloring.
    /// </summary>
    [ObservableProperty]
    private IBrush _riskLevelBrush = Brushes.Gray;

    /// <summary>
    /// Icon geometry for risk level.
    /// </summary>
    [ObservableProperty]
    private StreamGeometry? _riskIconData;

    #endregion

    #region Observable Properties - Execution Details

    /// <summary>
    /// Human-readable execution summary.
    /// </summary>
    [ObservableProperty]
    private string _executionSummary = string.Empty;

    /// <summary>
    /// Formatted JSON parameters.
    /// </summary>
    [ObservableProperty]
    private string _parametersJson = "{}";

    /// <summary>
    /// Risk factors identified for this request.
    /// </summary>
    [ObservableProperty]
    private ObservableCollection<RiskFactorViewModel> _riskFactors = new();

    /// <summary>
    /// Whether there are risk factors to display.
    /// </summary>
    [ObservableProperty]
    private bool _hasRiskFactors;

    #endregion

    #region Observable Properties - Remember Options

    /// <summary>
    /// Whether to remember this decision for the session.
    /// </summary>
    [ObservableProperty]
    private bool _rememberForSession;

    /// <summary>
    /// Whether to always remember this decision.
    /// </summary>
    [ObservableProperty]
    private bool _rememberAlways;

    /// <summary>
    /// Whether permanent remember is allowed (based on risk level).
    /// </summary>
    [ObservableProperty]
    private bool _canRememberPermanently;

    #endregion

    #region Observable Properties - Edit Mode

    /// <summary>
    /// Whether the details expander is open.
    /// </summary>
    [ObservableProperty]
    private bool _isDetailsExpanded;

    /// <summary>
    /// Whether parameters are being edited.
    /// </summary>
    [ObservableProperty]
    private bool _isEditingParameters;

    /// <summary>
    /// Text for the edit toggle button.
    /// </summary>
    [ObservableProperty]
    private string _editButtonText = "Edit";

    /// <summary>
    /// Whether parameter editing is allowed.
    /// </summary>
    [ObservableProperty]
    private bool _canEditParameters;

    /// <summary>
    /// Validation error message for parameters.
    /// </summary>
    [ObservableProperty]
    private string? _parameterValidationError;

    /// <summary>
    /// Whether there's a parameter validation error.
    /// </summary>
    [ObservableProperty]
    private bool _hasValidationError;

    #endregion

    #region Observable Properties - Timeout

    /// <summary>
    /// Formatted timeout remaining text.
    /// </summary>
    [ObservableProperty]
    private string _timeoutText = string.Empty;

    /// <summary>
    /// Timeout progress (100 = full, 0 = expired).
    /// </summary>
    [ObservableProperty]
    private double _timeoutProgress = 100;

    /// <summary>
    /// Brush for timeout progress coloring.
    /// </summary>
    [ObservableProperty]
    private IBrush _timeoutBrush = Brushes.Green;

    #endregion

    #region Computed Properties - Risk Level Flags

    /// <summary>
    /// Whether risk level is Safe.
    /// </summary>
    public bool IsSafe => _classification.FinalRisk == RiskLevel.Safe;

    /// <summary>
    /// Whether risk level is Low.
    /// </summary>
    public bool IsLow => _classification.FinalRisk == RiskLevel.Low;

    /// <summary>
    /// Whether risk level is Medium.
    /// </summary>
    public bool IsMedium => _classification.FinalRisk == RiskLevel.Medium;

    /// <summary>
    /// Whether risk level is High.
    /// </summary>
    public bool IsHigh => _classification.FinalRisk == RiskLevel.High;

    /// <summary>
    /// Whether risk level is Critical.
    /// </summary>
    public bool IsCritical => _classification.FinalRisk == RiskLevel.Critical;

    #endregion

    #region Result

    /// <summary>
    /// The decision made by the user.
    /// </summary>
    public ApprovalDecision? Result { get; private set; }

    #endregion

    #region Events

    /// <summary>
    /// Raised when the dialog should be closed.
    /// </summary>
    public event EventHandler<ApprovalDecision?>? DialogCloseRequested;

    #endregion

    #region Constructor

    public ToolApprovalViewModel(
        ToolCallRequest request,
        ITool tool,
        RiskClassificationResult classification,
        TimeSpan timeout,
        bool allowEditing = true)
    {
        _request = request ?? throw new ArgumentNullException(nameof(request));
        _tool = tool ?? throw new ArgumentNullException(nameof(tool));
        _classification = classification ?? throw new ArgumentNullException(nameof(classification));
        _timeout = timeout;
        _requestedAt = DateTime.UtcNow;

        // Initialize display values
        InitializeToolInfo();
        InitializeExecutionDetails();
        InitializeRememberOptions();
        InitializeEditMode(allowEditing);
        InitializeTimeout();

        // Start timeout timer
        _timeoutTimer = new DispatcherTimer
        {
            Interval = TimeSpan.FromMilliseconds(100)
        };
        _timeoutTimer.Tick += OnTimeoutTick;
        _timeoutTimer.Start();
    }

    #endregion

    #region Initialization

    private void InitializeToolInfo()
    {
        ToolName = _tool.Name;
        CategoryText = FormatCategory(_tool.Category);
        RiskLevelText = FormatRiskLevel(_classification.FinalRisk);
        RiskLevelBrush = GetRiskBrush(_classification.FinalRisk);
        RiskIconData = RiskIcons.GetIcon(_classification.FinalRisk);
    }

    private void InitializeExecutionDetails()
    {
        ExecutionSummary = _request.ExecutionSummary;
        ParametersJson = FormatParameters(_request.Parameters);

        RiskFactors = new ObservableCollection<RiskFactorViewModel>(
            _classification.Factors.Select(f => new RiskFactorViewModel(f)));

        HasRiskFactors = RiskFactors.Count > 0;
    }

    private void InitializeRememberOptions()
    {
        // Only allow permanent remember for Medium or lower risk
        CanRememberPermanently = _classification.FinalRisk <= RiskLevel.Medium;
    }

    private void InitializeEditMode(bool allowEditing)
    {
        // Allow editing only for safe/low risk tools
        CanEditParameters = allowEditing && _classification.FinalRisk <= RiskLevel.Low;
    }

    private void InitializeTimeout()
    {
        TimeoutProgress = 100;
        TimeoutBrush = new SolidColorBrush(Color.Parse("#22C55E")); // Green
        UpdateTimeoutDisplay();
    }

    #endregion

    #region Timeout Handling

    private void OnTimeoutTick(object? sender, EventArgs e)
    {
        var elapsed = DateTime.UtcNow - _requestedAt;
        var remaining = _timeout - elapsed;

        if (remaining <= TimeSpan.Zero)
        {
            HandleTimeout();
            return;
        }

        // Update progress
        TimeoutProgress = remaining.TotalMilliseconds / _timeout.TotalMilliseconds * 100;

        // Update display text
        UpdateTimeoutDisplay();

        // Update color based on remaining time
        TimeoutBrush = TimeoutProgress switch
        {
            > 50 => new SolidColorBrush(Color.Parse("#22C55E")),  // Green
            > 25 => new SolidColorBrush(Color.Parse("#F59E0B")),  // Orange
            _ => new SolidColorBrush(Color.Parse("#EF4444"))      // Red
        };
    }

    private void UpdateTimeoutDisplay()
    {
        var remaining = _timeout - (DateTime.UtcNow - _requestedAt);

        if (remaining.TotalSeconds > 60)
        {
            TimeoutText = $"{(int)remaining.TotalMinutes}:{remaining.Seconds:D2}";
        }
        else if (remaining.TotalSeconds > 0)
        {
            TimeoutText = $"{Math.Max(0, (int)remaining.TotalSeconds)}s";
        }
        else
        {
            TimeoutText = "0s";
        }
    }

    private void HandleTimeout()
    {
        _timeoutTimer.Stop();

        Result = ApprovalDecision.TimedOut(_request.ToolId, _request.RequestId);

        DialogCloseRequested?.Invoke(this, Result);
    }

    #endregion

    #region Commands

    /// <summary>
    /// Allow the tool execution.
    /// </summary>
    [RelayCommand]
    private void Allow()
    {
        _timeoutTimer.Stop();

        // Validate and parse modified parameters if editing
        JsonElement? modifiedParams = null;
        if (IsEditingParameters)
        {
            if (!TryParseParameters(out modifiedParams))
            {
                // Invalid JSON - stay in dialog
                return;
            }
        }

        // Determine remember option
        var rememberChoice = RememberOption.None;
        if (RememberAlways)
            rememberChoice = RememberOption.Always;
        else if (RememberForSession)
            rememberChoice = RememberOption.ForSession;

        Result = new ApprovalDecision
        {
            ToolId = _request.ToolId,
            RequestId = _request.RequestId,
            IsApproved = true,
            RememberChoice = rememberChoice,
            ModifiedParameters = modifiedParams,
            Reason = null
        };

        DialogCloseRequested?.Invoke(this, Result);
    }

    /// <summary>
    /// Deny the tool execution.
    /// </summary>
    [RelayCommand]
    private void Deny()
    {
        _timeoutTimer.Stop();

        // Determine remember option (only session for denials)
        var rememberChoice = RememberForSession
            ? RememberOption.ForSession
            : RememberOption.None;

        Result = new ApprovalDecision
        {
            ToolId = _request.ToolId,
            RequestId = _request.RequestId,
            IsApproved = false,
            IsDenied = true,
            RememberChoice = rememberChoice,
            Reason = "User denied"
        };

        DialogCloseRequested?.Invoke(this, Result);
    }

    /// <summary>
    /// Toggle parameter editing mode.
    /// </summary>
    [RelayCommand]
    private void ToggleEdit()
    {
        if (IsEditingParameters)
        {
            // Validate JSON before exiting edit mode
            if (TryParseParameters(out _))
            {
                IsEditingParameters = false;
                EditButtonText = "Edit";
                HasValidationError = false;
                ParameterValidationError = null;
            }
            // If invalid, stay in edit mode with error displayed
        }
        else
        {
            IsEditingParameters = true;
            EditButtonText = "Done";
            IsDetailsExpanded = true; // Auto-expand when editing
        }
    }

    /// <summary>
    /// Reset parameters to original values.
    /// </summary>
    [RelayCommand]
    private void ResetParameters()
    {
        ParametersJson = FormatParameters(_request.Parameters);
        HasValidationError = false;
        ParameterValidationError = null;
    }

    /// <summary>
    /// Copy parameters to clipboard.
    /// </summary>
    [RelayCommand]
    private async Task CopyParametersAsync()
    {
        try
        {
            var clipboard = Avalonia.Application.Current?.Clipboard;
            if (clipboard != null)
            {
                await clipboard.SetTextAsync(ParametersJson);
            }
        }
        catch
        {
            // Ignore clipboard errors
        }
    }

    #endregion

    #region Parameter Validation

    private bool TryParseParameters(out JsonElement? result)
    {
        result = null;

        try
        {
            using var doc = JsonDocument.Parse(ParametersJson);
            result = doc.RootElement.Clone();
            HasValidationError = false;
            ParameterValidationError = null;
            return true;
        }
        catch (JsonException ex)
        {
            HasValidationError = true;
            ParameterValidationError = $"Invalid JSON: {ex.Message}";
            return false;
        }
    }

    #endregion

    #region Formatting Helpers

    private static string FormatCategory(ToolCategory category) => category switch
    {
        ToolCategory.FileSystem => "File System",
        ToolCategory.Terminal => "Terminal",
        ToolCategory.Git => "Git",
        ToolCategory.Network => "Network",
        ToolCategory.Custom => "Custom",
        _ => category.ToString()
    };

    private static string FormatRiskLevel(RiskLevel level) => level switch
    {
        RiskLevel.Safe => "Safe",
        RiskLevel.Low => "Low Risk",
        RiskLevel.Medium => "Medium Risk",
        RiskLevel.High => "High Risk",
        RiskLevel.Critical => "Critical",
        _ => level.ToString()
    };

    private static string FormatParameters(JsonElement parameters)
    {
        try
        {
            return JsonSerializer.Serialize(
                parameters,
                new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return "{}";
        }
    }

    private static IBrush GetRiskBrush(RiskLevel level) => level switch
    {
        RiskLevel.Safe => new SolidColorBrush(Color.Parse("#22C55E")),
        RiskLevel.Low => new SolidColorBrush(Color.Parse("#84CC16")),
        RiskLevel.Medium => new SolidColorBrush(Color.Parse("#F59E0B")),
        RiskLevel.High => new SolidColorBrush(Color.Parse("#EF4444")),
        RiskLevel.Critical => new SolidColorBrush(Color.Parse("#7C2D12")),
        _ => Brushes.Gray
    };

    #endregion

    #region IDisposable

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    protected virtual void Dispose(bool disposing)
    {
        if (_disposed)
            return;

        if (disposing)
        {
            _timeoutTimer.Stop();
            _timeoutTimer.Tick -= OnTimeoutTick;
        }

        _disposed = true;
    }

    #endregion
}
```

### 2. RiskFactorViewModel.cs

**Location**: `src/SeniorIntern.Desktop/ViewModels/RiskFactorViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using Avalonia.Media;
using SeniorIntern.Core.Models.Permissions;

/// <summary>
/// ViewModel wrapper for RiskFactor with UI-specific properties.
/// </summary>
public class RiskFactorViewModel
{
    private readonly RiskFactor _factor;

    public RiskFactorViewModel(RiskFactor factor)
    {
        _factor = factor ?? throw new ArgumentNullException(nameof(factor));
    }

    /// <summary>
    /// Description of the risk factor.
    /// </summary>
    public string Description => _factor.Description;

    /// <summary>
    /// Risk contribution level (1-5).
    /// </summary>
    public int Contribution => _factor.Contribution;

    /// <summary>
    /// Category of the risk factor.
    /// </summary>
    public string Category => _factor.Category.ToString();

    /// <summary>
    /// Additional details about the risk.
    /// </summary>
    public string? Details => _factor.Details;

    /// <summary>
    /// Whether there are additional details.
    /// </summary>
    public bool HasDetails => !string.IsNullOrEmpty(Details);

    /// <summary>
    /// Brush color based on contribution level.
    /// </summary>
    public IBrush ContributionBrush => Contribution switch
    {
        >= 4 => new SolidColorBrush(Color.Parse("#EF4444")), // Red
        3 => new SolidColorBrush(Color.Parse("#F59E0B")),    // Amber
        2 => new SolidColorBrush(Color.Parse("#F59E0B")),    // Amber
        1 => new SolidColorBrush(Color.Parse("#84CC16")),    // Lime
        _ => new SolidColorBrush(Color.Parse("#22C55E"))     // Green
    };
}
```

### 3. ApprovalDialogService.cs

**Location**: `src/SeniorIntern.Desktop/Services/ApprovalDialogService.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

using Avalonia.Controls;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models.Permissions;
using SeniorIntern.Core.Tools;
using SeniorIntern.Desktop.ViewModels;
using SeniorIntern.Desktop.Views.Dialogs;

/// <summary>
/// Service for showing approval dialogs.
/// </summary>
public sealed class ApprovalDialogService : IApprovalDialogService
{
    private readonly Func<Window?> _getMainWindow;
    private readonly IPermissionManager _permissionManager;

    public ApprovalDialogService(
        Func<Window?> getMainWindow,
        IPermissionManager permissionManager)
    {
        _getMainWindow = getMainWindow;
        _permissionManager = permissionManager;
    }

    /// <summary>
    /// Initialize the service by subscribing to approval requests.
    /// </summary>
    public void Initialize()
    {
        _permissionManager.ApprovalRequested += OnApprovalRequested;
    }

    private async void OnApprovalRequested(object? sender, ApprovalRequestedEventArgs e)
    {
        try
        {
            var decision = await ShowApprovalDialogAsync(
                e.ToolRequest,
                e.Tool!,
                e.Classification,
                e.Timeout);

            // Submit the decision back to the permission manager
            _permissionManager.SubmitDecision(e.RequestId, decision ?? ApprovalDecision.Cancelled(
                e.ToolRequest.ToolId, e.RequestId));
        }
        catch (Exception ex)
        {
            // On error, deny the request
            _permissionManager.SubmitDecision(e.RequestId, new ApprovalDecision
            {
                ToolId = e.ToolRequest.ToolId,
                RequestId = e.RequestId,
                IsApproved = false,
                Reason = $"Dialog error: {ex.Message}"
            });
        }
    }

    /// <summary>
    /// Show the approval dialog and return the user's decision.
    /// </summary>
    public async Task<ApprovalDecision?> ShowApprovalDialogAsync(
        ToolCallRequest request,
        ITool tool,
        RiskClassificationResult classification,
        TimeSpan timeout,
        bool allowEditing = true)
    {
        var mainWindow = _getMainWindow();
        if (mainWindow == null)
        {
            // No UI available - auto-deny
            return ApprovalDecision.Cancelled(request.ToolId, request.RequestId);
        }

        var viewModel = new ToolApprovalViewModel(
            request,
            tool,
            classification,
            timeout,
            allowEditing);

        return await ToolApprovalDialog.ShowAsync(mainWindow, viewModel);
    }

    /// <summary>
    /// Cleanup resources.
    /// </summary>
    public void Dispose()
    {
        _permissionManager.ApprovalRequested -= OnApprovalRequested;
    }
}

/// <summary>
/// Interface for approval dialog service.
/// </summary>
public interface IApprovalDialogService : IDisposable
{
    void Initialize();

    Task<ApprovalDecision?> ShowApprovalDialogAsync(
        ToolCallRequest request,
        ITool tool,
        RiskClassificationResult classification,
        TimeSpan timeout,
        bool allowEditing = true);
}
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `ToolApprovalViewModel.cs` | `ViewModels/` | Main dialog ViewModel | ~420 |
| `RiskFactorViewModel.cs` | `ViewModels/` | Risk factor wrapper | ~55 |
| `ApprovalDialogService.cs` | `Services/` | Dialog service integration | ~95 |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `Constructor_InitializesToolInfo` | Tool name, category set |
| `Constructor_InitializesRiskInfo` | Risk level, factors set |
| `Constructor_StartsTimer` | Timer starts on create |
| `TimeoutTick_UpdatesProgress` | Progress decrements |
| `TimeoutTick_UpdatesColor` | Color changes by threshold |
| `TimeoutTick_Timeout_DeniesAutomatically` | Auto-deny on timeout |
| `TimeoutTick_Timeout_RaisesCloseEvent` | Event raised |
| `Allow_StopsTimer` | Timer stopped |
| `Allow_SetsIsApproved` | Result correct |
| `Allow_CapturesRememberSession` | Session flag |
| `Allow_CapturesRememberAlways` | Always flag |
| `Allow_ParsesModifiedParameters` | Edited params |
| `Allow_InvalidJson_DoesNotClose` | Validation blocks |
| `Deny_StopsTimer` | Timer stopped |
| `Deny_SetsIsDenied` | Result correct |
| `Deny_CapturesReason` | Reason set |
| `ToggleEdit_TogglesMode` | Edit mode toggles |
| `ToggleEdit_ValidatesOnExit` | JSON validated |
| `ResetParameters_RestoresOriginal` | Reset works |
| `CanRememberPermanently_FalseForHighRisk` | Safety check |
| `CanEditParameters_FalseForHighRisk` | Safety check |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | ViewModel initializes with request data |
| AC-2 | Timeout countdown works correctly |
| AC-3 | Allow/Deny commands close dialog with result |
| AC-4 | Parameter editing validates JSON |
| AC-5 | Remember options are captured in result |
| AC-6 | Automatic denial on timeout |

---

## Changelog Entry

```markdown
## v0.6.4i - Approval Dialog ViewModel

### Added
- `ToolApprovalViewModel` with full dialog logic
  - Observable properties for all UI bindings
  - Computed properties for risk-based styling (IsSafe...IsCritical)
  - Timeout countdown with 100ms tick interval
  - Progress and color updates based on remaining time
  - Auto-deny when timeout expires
- Commands
  - `AllowCommand` - Build approval decision, validate params
  - `DenyCommand` - Build denial decision
  - `ToggleEditCommand` - Toggle edit mode with JSON validation
  - `ResetParametersCommand` - Restore original parameters
  - `CopyParametersCommand` - Copy to clipboard
- Parameter editing
  - JSON validation on exit
  - Error display for invalid JSON
  - Modified parameters captured in decision
- Remember options
  - Session and Always flags
  - Permanent remember blocked for High/Critical risk
- `RiskFactorViewModel` wrapper for UI display
  - ContributionBrush based on severity
  - Category and details access
- `ApprovalDialogService` for integration
  - Subscribes to IPermissionManager.ApprovalRequested
  - Shows dialog and submits decision back
  - Error handling with fallback denial
- `IApprovalDialogService` interface
- IDisposable implementation
  - Timer cleanup
  - Event unsubscription
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.4i | 0.75 day |
