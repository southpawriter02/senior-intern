# Design Specification: AIntern v0.6.4f "Audit Log Models"

## Overview

**Version**: v0.6.4f
**Parent**: v0.6.4 Safety & Approval
**Focus**: Audit log entry model and query support for tracking tool execution

### Purpose

Define the audit log models that:
1. Capture comprehensive information about tool calls
2. Record permission decisions with context
3. Track execution results and timing
4. Support redaction of sensitive parameters
5. Provide factory methods for common scenarios
6. Enable flexible querying and reporting

### Dependencies

**From v0.6.4a (Permission Policy Models)**:
- `PermissionPolicy` (audit settings)

**From v0.6.4b (Risk Classification Engine)**:
- `RiskFactor`
- `RiskLevel`

**From v0.6.4c (Permission Check System)**:
- `PermissionSource`

**From v0.6.1 (Tool Framework)**:
- `ITool`, `ToolCategory`
- `ToolCallRequest`, `ToolResult`

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     v0.6.4f Audit Log Model Architecture                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  AuditLogEntry                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                          │ │
│  │  Identification                                                          │ │
│  │  ├── Id: Guid                                                           │ │
│  │  ├── Timestamp: DateTime                                                │ │
│  │  ├── ConversationId: Guid?                                              │ │
│  │  └── RequestId: Guid?                                                   │ │
│  │                                                                          │ │
│  │  Tool Information                                                        │ │
│  │  ├── ToolId: string                                                     │ │
│  │  ├── ToolName: string                                                   │ │
│  │  └── ToolCategory: ToolCategory                                         │ │
│  │                                                                          │ │
│  │  Risk & Decision                                                         │ │
│  │  ├── RiskLevel: RiskLevel                                               │ │
│  │  ├── RiskFactors: IReadOnlyList<RiskFactor>?                            │ │
│  │  ├── Decision: AuditDecision                                            │ │
│  │  ├── PermissionSource: PermissionSource                                 │ │
│  │  └── DenialReason: string?                                              │ │
│  │                                                                          │ │
│  │  Parameters & Summary                                                    │ │
│  │  ├── Parameters: JsonElement (may be redacted)                          │ │
│  │  └── ExecutionSummary: string                                           │ │
│  │                                                                          │ │
│  │  Execution Results (populated after execution)                           │ │
│  │  ├── ExecutionSuccess: bool?                                            │ │
│  │  ├── ExecutionError: string?                                            │ │
│  │  ├── ExecutionDuration: TimeSpan?                                       │ │
│  │  └── ResultSummary: string?                                             │ │
│  │                                                                          │ │
│  │  Factory Methods:                                                        │ │
│  │  ├── ForExecution(request, tool, classification, source, result, ...)   │ │
│  │  ├── ForDenial(request, tool, classification, reason, wasBlocked, ...)  │ │
│  │  ├── ForTimeout(request, tool, classification, ...)                     │ │
│  │  └── ForError(request, tool, error, ...)                                │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  AuditDecision (enum)                                                        │
│  ├── AutoApproved = 0    (Policy/trusted auto-approved)                    │
│  ├── UserApproved = 1    (User approved in dialog)                         │
│  ├── UserDenied = 2      (User denied in dialog)                           │
│  ├── PolicyBlocked = 3   (Blocked by policy/pattern)                       │
│  ├── RateLimited = 4     (Blocked by rate limiter)                         │
│  ├── TimedOut = 5        (Approval request timed out)                      │
│  └── Error = 6           (Error during processing)                         │
│                                                                              │
│  AuditLogQuery                                                               │
│  ├── Date filtering (StartDate, EndDate)                                   │
│  ├── Tool filtering (ToolId, Category)                                     │
│  ├── Decision filtering (Decision, MinRiskLevel)                           │
│  ├── Context filtering (ConversationId, OnlyFailures)                      │
│  ├── Text search (SearchText)                                              │
│  └── Pagination (Skip, Take, SortOrder)                                    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Audit Entry Lifecycle

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      Audit Entry Creation Lifecycle                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Tool Call Request                                                           │
│      │                                                                       │
│      ▼                                                                       │
│  ┌─────────────────────────────────────┐                                     │
│  │ Permission Check                    │                                     │
│  │ CheckPermissionAsync()              │                                     │
│  └─────────────────┬───────────────────┘                                     │
│                    │                                                          │
│      ┌─────────────┼─────────────┬─────────────────┐                         │
│      ▼             ▼             ▼                 ▼                         │
│  [Allowed]     [NeedsApproval]  [Blocked]     [RateLimited]                 │
│      │             │             │                 │                         │
│      │             ▼             │                 │                         │
│      │    ┌───────────────┐      │                 │                         │
│      │    │ User Approval │      │                 │                         │
│      │    └───────┬───────┘      │                 │                         │
│      │            │              │                 │                         │
│      │   ┌────────┼────────┐     │                 │                         │
│      │   ▼        ▼        ▼     │                 │                         │
│      │ [Approve] [Deny] [Timeout]│                 │                         │
│      │   │        │        │     │                 │                         │
│      ▼   ▼        ▼        ▼     ▼                 ▼                         │
│  Execute    ForDenial  ForTimeout  ForDenial   ForDenial                     │
│      │      (reason)   (reason)    (blocked)   (rate limited)               │
│      │                                                                       │
│      ▼                                                                       │
│  ┌─────────────────────────────────────┐                                     │
│  │ Tool Execution                      │                                     │
│  │ tool.ExecuteAsync()                 │                                     │
│  └─────────────────┬───────────────────┘                                     │
│                    │                                                          │
│      ┌─────────────┴─────────────┐                                           │
│      ▼                           ▼                                           │
│  [Success]                   [Error]                                         │
│      │                           │                                           │
│      ▼                           ▼                                           │
│  ForExecution                ForError                                        │
│  (result, duration)          (error message)                                 │
│                                                                              │
│  All paths → RecordAuditAsync(entry)                                         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Parameter Redaction

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Parameter Redaction Strategy                          │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Sensitive Fields (always redacted):                                         │
│  ├── password, secret, token, key, credential                               │
│  ├── api_key, apiKey, auth, authorization                                   │
│  └── cookie, session                                                         │
│                                                                              │
│  Sensitive File Patterns (path redacted):                                    │
│  ├── ~/.ssh/*, ~/.aws/*, ~/.azure/*                                         │
│  ├── **/.env, **/secrets/**                                                 │
│  └── **/*.pem, **/*.key                                                     │
│                                                                              │
│  Original Parameters:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ {                                                                        │ │
│  │   "path": "/home/user/.ssh/id_rsa",                                     │ │
│  │   "content": "-----BEGIN RSA PRIVATE KEY-----...",                      │ │
│  │   "api_key": "sk-1234567890abcdef"                                      │ │
│  │ }                                                                        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Redacted Parameters:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ {                                                                        │ │
│  │   "path": "[REDACTED: sensitive path]",                                 │ │
│  │   "content": "[REDACTED: 2048 bytes]",                                  │ │
│  │   "api_key": "[REDACTED]"                                               │ │
│  │ }                                                                        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. AuditLogEntry.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/AuditLogEntry.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using System.Text.Json;
using System.Text.RegularExpressions;
using SeniorIntern.Core.Tools;

/// <summary>
/// A single entry in the audit log.
/// Records tool execution decisions and outcomes.
/// </summary>
/// <remarks>
/// <para>
/// Audit entries capture the complete lifecycle of a tool call:
/// </para>
/// <list type="bullet">
/// <item>Request identification and context</item>
/// <item>Risk assessment and decision</item>
/// <item>Parameters (potentially redacted)</item>
/// <item>Execution results and timing</item>
/// </list>
/// </remarks>
public sealed class AuditLogEntry
{
    #region Identification

    /// <summary>
    /// Unique identifier for this entry.
    /// </summary>
    public Guid Id { get; init; } = Guid.NewGuid();

    /// <summary>
    /// When this event occurred.
    /// </summary>
    public DateTime Timestamp { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// Associated conversation ID for context.
    /// </summary>
    public Guid? ConversationId { get; init; }

    /// <summary>
    /// Request ID within the agent loop.
    /// </summary>
    public Guid? RequestId { get; init; }

    #endregion

    #region Tool Information

    /// <summary>
    /// ID of the tool involved.
    /// </summary>
    public string ToolId { get; init; } = string.Empty;

    /// <summary>
    /// Display name of the tool.
    /// </summary>
    public string ToolName { get; init; } = string.Empty;

    /// <summary>
    /// Category of the tool.
    /// </summary>
    public ToolCategory ToolCategory { get; init; }

    #endregion

    #region Risk & Decision

    /// <summary>
    /// Risk level at the time of the call.
    /// </summary>
    public RiskLevel RiskLevel { get; init; }

    /// <summary>
    /// Risk factors identified during classification.
    /// </summary>
    public IReadOnlyList<RiskFactor>? RiskFactors { get; init; }

    /// <summary>
    /// Decision that was made.
    /// </summary>
    public AuditDecision Decision { get; init; }

    /// <summary>
    /// Source of the permission decision.
    /// </summary>
    public PermissionSource PermissionSource { get; init; }

    /// <summary>
    /// Reason for denial (if denied or blocked).
    /// </summary>
    public string? DenialReason { get; init; }

    #endregion

    #region Parameters & Summary

    /// <summary>
    /// Tool parameters (may be redacted for sensitive data).
    /// </summary>
    public JsonElement Parameters { get; init; }

    /// <summary>
    /// Human-readable summary of the operation.
    /// </summary>
    public string ExecutionSummary { get; init; } = string.Empty;

    #endregion

    #region Execution Results

    /// <summary>
    /// Whether execution succeeded (null if not executed).
    /// </summary>
    public bool? ExecutionSuccess { get; init; }

    /// <summary>
    /// Error message if execution failed.
    /// </summary>
    public string? ExecutionError { get; init; }

    /// <summary>
    /// How long execution took.
    /// </summary>
    public TimeSpan? ExecutionDuration { get; init; }

    /// <summary>
    /// Brief description of the result.
    /// </summary>
    public string? ResultSummary { get; init; }

    #endregion

    #region Computed Properties

    /// <summary>
    /// Whether the tool was executed.
    /// </summary>
    public bool WasExecuted => ExecutionSuccess.HasValue;

    /// <summary>
    /// Whether the request was approved (auto or user).
    /// </summary>
    public bool WasApproved => Decision is AuditDecision.AutoApproved or AuditDecision.UserApproved;

    /// <summary>
    /// Whether the request was denied or blocked.
    /// </summary>
    public bool WasDenied => Decision is AuditDecision.UserDenied or AuditDecision.PolicyBlocked
        or AuditDecision.RateLimited or AuditDecision.TimedOut;

    #endregion

    #region Factory Methods

    /// <summary>
    /// Create an entry for a permitted and executed tool call.
    /// </summary>
    /// <param name="request">The tool call request.</param>
    /// <param name="tool">The tool that was invoked.</param>
    /// <param name="classification">Risk classification result.</param>
    /// <param name="source">Source of the permission decision.</param>
    /// <param name="result">Execution result.</param>
    /// <param name="duration">How long execution took.</param>
    /// <param name="conversationId">Optional conversation context.</param>
    /// <param name="redactParameters">Whether to redact sensitive parameters.</param>
    public static AuditLogEntry ForExecution(
        ToolCallRequest request,
        ITool tool,
        RiskClassificationResult classification,
        PermissionSource source,
        ToolResult result,
        TimeSpan duration,
        Guid? conversationId = null,
        bool redactParameters = true) => new()
    {
        ToolId = tool.Id,
        ToolName = tool.Name,
        ToolCategory = tool.Category,
        RiskLevel = classification.FinalRisk,
        RiskFactors = classification.Factors.ToList(),
        Decision = DetermineDecision(source, wasApproved: true),
        PermissionSource = source,
        Parameters = redactParameters
            ? RedactSensitiveParameters(request.Parameters)
            : request.Parameters,
        ExecutionSummary = GenerateSummary(tool, request),
        ConversationId = conversationId,
        RequestId = request.RequestId,
        ExecutionSuccess = result.IsSuccess,
        ExecutionError = result.ErrorMessage,
        ExecutionDuration = duration,
        ResultSummary = TruncateSummary(result.Message, 200)
    };

    /// <summary>
    /// Create an entry for a denied tool call.
    /// </summary>
    /// <param name="request">The tool call request.</param>
    /// <param name="tool">The tool that was denied.</param>
    /// <param name="classification">Risk classification result.</param>
    /// <param name="reason">Reason for denial.</param>
    /// <param name="wasBlocked">Whether it was blocked by policy (vs user denied).</param>
    /// <param name="conversationId">Optional conversation context.</param>
    /// <param name="redactParameters">Whether to redact sensitive parameters.</param>
    public static AuditLogEntry ForDenial(
        ToolCallRequest request,
        ITool tool,
        RiskClassificationResult classification,
        string reason,
        bool wasBlocked,
        Guid? conversationId = null,
        bool redactParameters = true) => new()
    {
        ToolId = tool.Id,
        ToolName = tool.Name,
        ToolCategory = tool.Category,
        RiskLevel = classification.FinalRisk,
        RiskFactors = classification.Factors.ToList(),
        Decision = wasBlocked ? AuditDecision.PolicyBlocked : AuditDecision.UserDenied,
        PermissionSource = PermissionSource.Policy,
        DenialReason = reason,
        Parameters = redactParameters
            ? RedactSensitiveParameters(request.Parameters)
            : request.Parameters,
        ExecutionSummary = GenerateSummary(tool, request),
        ConversationId = conversationId,
        RequestId = request.RequestId
    };

    /// <summary>
    /// Create an entry for a timed out approval request.
    /// </summary>
    public static AuditLogEntry ForTimeout(
        ToolCallRequest request,
        ITool tool,
        RiskClassificationResult classification,
        TimeSpan timeout,
        Guid? conversationId = null) => new()
    {
        ToolId = tool.Id,
        ToolName = tool.Name,
        ToolCategory = tool.Category,
        RiskLevel = classification.FinalRisk,
        RiskFactors = classification.Factors.ToList(),
        Decision = AuditDecision.TimedOut,
        PermissionSource = PermissionSource.Policy,
        DenialReason = $"Approval request timed out after {timeout.TotalSeconds:F0} seconds",
        Parameters = RedactSensitiveParameters(request.Parameters),
        ExecutionSummary = GenerateSummary(tool, request),
        ConversationId = conversationId,
        RequestId = request.RequestId
    };

    /// <summary>
    /// Create an entry for a rate-limited request.
    /// </summary>
    public static AuditLogEntry ForRateLimited(
        ToolCallRequest request,
        ITool tool,
        string reason,
        Guid? conversationId = null) => new()
    {
        ToolId = tool.Id,
        ToolName = tool.Name,
        ToolCategory = tool.Category,
        RiskLevel = RiskLevel.Medium,
        Decision = AuditDecision.RateLimited,
        PermissionSource = PermissionSource.RateLimit,
        DenialReason = reason,
        Parameters = RedactSensitiveParameters(request.Parameters),
        ExecutionSummary = GenerateSummary(tool, request),
        ConversationId = conversationId,
        RequestId = request.RequestId
    };

    /// <summary>
    /// Create an entry for an error during processing.
    /// </summary>
    public static AuditLogEntry ForError(
        ToolCallRequest request,
        ITool tool,
        string errorMessage,
        Guid? conversationId = null) => new()
    {
        ToolId = tool.Id,
        ToolName = tool.Name,
        ToolCategory = tool.Category,
        RiskLevel = RiskLevel.Medium,
        Decision = AuditDecision.Error,
        PermissionSource = PermissionSource.Policy,
        DenialReason = errorMessage,
        ExecutionSuccess = false,
        ExecutionError = errorMessage,
        Parameters = RedactSensitiveParameters(request.Parameters),
        ExecutionSummary = GenerateSummary(tool, request),
        ConversationId = conversationId,
        RequestId = request.RequestId
    };

    #endregion

    #region Helper Methods

    /// <summary>
    /// Determine the audit decision based on source and approval.
    /// </summary>
    private static AuditDecision DetermineDecision(PermissionSource source, bool wasApproved)
    {
        if (!wasApproved)
            return AuditDecision.UserDenied;

        return source switch
        {
            PermissionSource.TrustedTool => AuditDecision.AutoApproved,
            PermissionSource.Policy => AuditDecision.AutoApproved,
            PermissionSource.SessionCache => AuditDecision.UserApproved,
            PermissionSource.Persistent => AuditDecision.UserApproved,
            PermissionSource.ToolOverride => AuditDecision.AutoApproved,
            _ => AuditDecision.UserApproved
        };
    }

    /// <summary>
    /// Generate a human-readable execution summary.
    /// </summary>
    private static string GenerateSummary(ITool tool, ToolCallRequest request)
    {
        try
        {
            // Try to generate tool-specific summary
            if (request.Parameters.TryGetProperty("path", out var path))
                return $"{tool.Name}: {path.GetString()}";

            if (request.Parameters.TryGetProperty("command", out var cmd))
                return $"{tool.Name}: {TruncateSummary(cmd.GetString(), 50)}";

            if (request.Parameters.TryGetProperty("pattern", out var pattern))
                return $"{tool.Name}: {pattern.GetString()}";

            return tool.Name;
        }
        catch
        {
            return tool.Name;
        }
    }

    /// <summary>
    /// Truncate a string for summary display.
    /// </summary>
    private static string? TruncateSummary(string? value, int maxLength)
    {
        if (string.IsNullOrEmpty(value))
            return value;

        return value.Length <= maxLength
            ? value
            : value[..(maxLength - 3)] + "...";
    }

    /// <summary>
    /// Redact sensitive parameters from JSON.
    /// </summary>
    private static JsonElement RedactSensitiveParameters(JsonElement parameters)
    {
        try
        {
            using var stream = new MemoryStream();
            using var writer = new Utf8JsonWriter(stream);

            RedactObject(parameters, writer);

            writer.Flush();
            stream.Position = 0;

            using var doc = JsonDocument.Parse(stream);
            return doc.RootElement.Clone();
        }
        catch
        {
            // Return empty object on error
            return JsonDocument.Parse("{}").RootElement;
        }
    }

    /// <summary>
    /// Sensitive parameter names to redact.
    /// </summary>
    private static readonly HashSet<string> SensitiveNames = new(StringComparer.OrdinalIgnoreCase)
    {
        "password", "secret", "token", "key", "credential",
        "api_key", "apiKey", "apikey", "auth", "authorization",
        "cookie", "session", "private_key", "privateKey"
    };

    /// <summary>
    /// Sensitive path patterns.
    /// </summary>
    private static readonly Regex SensitivePathPattern = new(
        @"(\.ssh|\.aws|\.azure|\.kube|\.docker|\.gnupg|\.env|secrets|credentials|\.pem|\.key|id_rsa)",
        RegexOptions.Compiled | RegexOptions.IgnoreCase);

    /// <summary>
    /// Recursively redact sensitive values.
    /// </summary>
    private static void RedactObject(JsonElement element, Utf8JsonWriter writer)
    {
        switch (element.ValueKind)
        {
            case JsonValueKind.Object:
                writer.WriteStartObject();
                foreach (var property in element.EnumerateObject())
                {
                    writer.WritePropertyName(property.Name);

                    if (SensitiveNames.Contains(property.Name))
                    {
                        writer.WriteStringValue("[REDACTED]");
                    }
                    else if (property.Name.Equals("path", StringComparison.OrdinalIgnoreCase) ||
                             property.Name.Equals("source", StringComparison.OrdinalIgnoreCase) ||
                             property.Name.Equals("destination", StringComparison.OrdinalIgnoreCase))
                    {
                        var pathValue = property.Value.GetString();
                        if (pathValue != null && SensitivePathPattern.IsMatch(pathValue))
                        {
                            writer.WriteStringValue("[REDACTED: sensitive path]");
                        }
                        else
                        {
                            property.Value.WriteTo(writer);
                        }
                    }
                    else if (property.Name.Equals("content", StringComparison.OrdinalIgnoreCase))
                    {
                        var contentLength = property.Value.GetString()?.Length ?? 0;
                        writer.WriteStringValue($"[REDACTED: {contentLength} bytes]");
                    }
                    else
                    {
                        RedactObject(property.Value, writer);
                    }
                }
                writer.WriteEndObject();
                break;

            case JsonValueKind.Array:
                writer.WriteStartArray();
                foreach (var item in element.EnumerateArray())
                {
                    RedactObject(item, writer);
                }
                writer.WriteEndArray();
                break;

            default:
                element.WriteTo(writer);
                break;
        }
    }

    #endregion
}
```

### 2. AuditDecision.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/AuditDecision.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

/// <summary>
/// The decision made for an audited tool call.
/// </summary>
public enum AuditDecision
{
    /// <summary>
    /// Automatically approved by policy (safe/trusted).
    /// </summary>
    /// <remarks>
    /// Includes:
    /// <list type="bullet">
    /// <item>Tools in TrustedTools list</item>
    /// <item>Risk level below threshold in AskForRisky mode</item>
    /// <item>All tools in AutoApprove mode</item>
    /// </list>
    /// </remarks>
    AutoApproved = 0,

    /// <summary>
    /// Approved by user in approval dialog.
    /// </summary>
    /// <remarks>
    /// User explicitly clicked Approve.
    /// May have used "Remember for session" or "Always allow".
    /// </remarks>
    UserApproved = 1,

    /// <summary>
    /// Denied by user in approval dialog.
    /// </summary>
    /// <remarks>
    /// User explicitly clicked Deny.
    /// May have used "Remember for session" or "Always deny".
    /// </remarks>
    UserDenied = 2,

    /// <summary>
    /// Blocked by policy (blocked tool, pattern, or category).
    /// </summary>
    /// <remarks>
    /// Includes:
    /// <list type="bullet">
    /// <item>Tool in BlockedTools list</item>
    /// <item>Tool category in DisabledCategories</item>
    /// <item>Command matched BlockedCommandPattern</item>
    /// <item>Tool override set to Block</item>
    /// </list>
    /// </remarks>
    PolicyBlocked = 3,

    /// <summary>
    /// Blocked by rate limiter.
    /// </summary>
    /// <remarks>
    /// Too many tool calls in the time window.
    /// Either per-minute or per-hour limit exceeded.
    /// </remarks>
    RateLimited = 4,

    /// <summary>
    /// Approval request timed out waiting for user response.
    /// </summary>
    /// <remarks>
    /// User did not respond within ApprovalTimeoutSeconds.
    /// </remarks>
    TimedOut = 5,

    /// <summary>
    /// Error occurred during permission check or execution.
    /// </summary>
    Error = 6
}

/// <summary>
/// Extension methods for AuditDecision.
/// </summary>
public static class AuditDecisionExtensions
{
    /// <summary>
    /// Get a human-readable display name.
    /// </summary>
    public static string GetDisplayName(this AuditDecision decision) => decision switch
    {
        AuditDecision.AutoApproved => "Auto-Approved",
        AuditDecision.UserApproved => "User Approved",
        AuditDecision.UserDenied => "User Denied",
        AuditDecision.PolicyBlocked => "Blocked",
        AuditDecision.RateLimited => "Rate Limited",
        AuditDecision.TimedOut => "Timed Out",
        AuditDecision.Error => "Error",
        _ => decision.ToString()
    };

    /// <summary>
    /// Get icon for decision (for UI).
    /// </summary>
    public static string GetIcon(this AuditDecision decision) => decision switch
    {
        AuditDecision.AutoApproved => "✓",
        AuditDecision.UserApproved => "✓",
        AuditDecision.UserDenied => "✗",
        AuditDecision.PolicyBlocked => "⛔",
        AuditDecision.RateLimited => "⏱",
        AuditDecision.TimedOut => "⏰",
        AuditDecision.Error => "⚠",
        _ => "?"
    };

    /// <summary>
    /// Whether this decision represents an approved action.
    /// </summary>
    public static bool IsApproved(this AuditDecision decision) =>
        decision is AuditDecision.AutoApproved or AuditDecision.UserApproved;

    /// <summary>
    /// Whether this decision represents a denied/blocked action.
    /// </summary>
    public static bool IsDenied(this AuditDecision decision) =>
        !decision.IsApproved();
}
```

### 3. AuditLogQuery.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/AuditLogQuery.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using SeniorIntern.Core.Tools;

/// <summary>
/// Query parameters for searching the audit log.
/// </summary>
public sealed class AuditLogQuery
{
    #region Date Filtering

    /// <summary>
    /// Start of date range (inclusive).
    /// </summary>
    public DateTime? StartDate { get; init; }

    /// <summary>
    /// End of date range (exclusive).
    /// </summary>
    public DateTime? EndDate { get; init; }

    #endregion

    #region Tool Filtering

    /// <summary>
    /// Filter by tool ID.
    /// </summary>
    public string? ToolId { get; init; }

    /// <summary>
    /// Filter by multiple tool IDs.
    /// </summary>
    public IReadOnlyList<string>? ToolIds { get; init; }

    /// <summary>
    /// Filter by tool category.
    /// </summary>
    public ToolCategory? Category { get; init; }

    #endregion

    #region Decision Filtering

    /// <summary>
    /// Filter by decision type.
    /// </summary>
    public AuditDecision? Decision { get; init; }

    /// <summary>
    /// Filter by multiple decision types.
    /// </summary>
    public IReadOnlyList<AuditDecision>? Decisions { get; init; }

    /// <summary>
    /// Filter by minimum risk level.
    /// </summary>
    public RiskLevel? MinRiskLevel { get; init; }

    /// <summary>
    /// Filter by permission source.
    /// </summary>
    public PermissionSource? PermissionSource { get; init; }

    #endregion

    #region Context Filtering

    /// <summary>
    /// Filter by conversation ID.
    /// </summary>
    public Guid? ConversationId { get; init; }

    /// <summary>
    /// Only include failed executions.
    /// </summary>
    public bool? OnlyFailures { get; init; }

    /// <summary>
    /// Only include entries that were executed.
    /// </summary>
    public bool? OnlyExecuted { get; init; }

    /// <summary>
    /// Only include denied/blocked entries.
    /// </summary>
    public bool? OnlyDenied { get; init; }

    #endregion

    #region Text Search

    /// <summary>
    /// Search in execution summary.
    /// </summary>
    public string? SearchText { get; init; }

    #endregion

    #region Pagination

    /// <summary>
    /// Number of entries to skip.
    /// </summary>
    public int Skip { get; init; }

    /// <summary>
    /// Maximum entries to return.
    /// </summary>
    public int Take { get; init; } = 100;

    /// <summary>
    /// Sort order.
    /// </summary>
    public AuditLogSortOrder SortOrder { get; init; } = AuditLogSortOrder.NewestFirst;

    #endregion

    #region Factory Methods

    /// <summary>
    /// Create a query for today's entries.
    /// </summary>
    public static AuditLogQuery Today() => new()
    {
        StartDate = DateTime.UtcNow.Date,
        EndDate = DateTime.UtcNow.Date.AddDays(1)
    };

    /// <summary>
    /// Create a query for the last N days.
    /// </summary>
    public static AuditLogQuery LastDays(int days) => new()
    {
        StartDate = DateTime.UtcNow.Date.AddDays(-days)
    };

    /// <summary>
    /// Create a query for a specific tool.
    /// </summary>
    public static AuditLogQuery ForTool(string toolId) => new()
    {
        ToolId = toolId
    };

    /// <summary>
    /// Create a query for a specific conversation.
    /// </summary>
    public static AuditLogQuery ForConversation(Guid conversationId) => new()
    {
        ConversationId = conversationId
    };

    /// <summary>
    /// Create a query for denied/blocked entries.
    /// </summary>
    public static AuditLogQuery Denied() => new()
    {
        OnlyDenied = true
    };

    /// <summary>
    /// Create a query for high-risk operations.
    /// </summary>
    public static AuditLogQuery HighRisk() => new()
    {
        MinRiskLevel = RiskLevel.High
    };

    /// <summary>
    /// Create a query for failed executions.
    /// </summary>
    public static AuditLogQuery Failures() => new()
    {
        OnlyFailures = true
    };

    #endregion

    #region Builder Methods

    /// <summary>
    /// Add date range filter.
    /// </summary>
    public AuditLogQuery WithDateRange(DateTime start, DateTime end) =>
        this with { StartDate = start, EndDate = end };

    /// <summary>
    /// Add tool filter.
    /// </summary>
    public AuditLogQuery WithTool(string toolId) =>
        this with { ToolId = toolId };

    /// <summary>
    /// Add decision filter.
    /// </summary>
    public AuditLogQuery WithDecision(AuditDecision decision) =>
        this with { Decision = decision };

    /// <summary>
    /// Add pagination.
    /// </summary>
    public AuditLogQuery WithPaging(int skip, int take) =>
        this with { Skip = skip, Take = take };

    /// <summary>
    /// Add sort order.
    /// </summary>
    public AuditLogQuery WithSort(AuditLogSortOrder order) =>
        this with { SortOrder = order };

    #endregion
}

/// <summary>
/// Sort order for audit log queries.
/// </summary>
public enum AuditLogSortOrder
{
    /// <summary>Newest entries first.</summary>
    NewestFirst,

    /// <summary>Oldest entries first.</summary>
    OldestFirst,

    /// <summary>Highest risk level first.</summary>
    RiskLevelDesc,

    /// <summary>Longest duration first.</summary>
    DurationDesc,

    /// <summary>By tool ID alphabetically.</summary>
    ToolIdAsc
}
```

### 4. AuditLogStatistics.cs

**Location**: `src/SeniorIntern.Core/Models/Permissions/AuditLogStatistics.cs`

```csharp
namespace SeniorIntern.Core.Models.Permissions;

using SeniorIntern.Core.Tools;

/// <summary>
/// Summary statistics for the audit log.
/// </summary>
public sealed class AuditLogStatistics
{
    /// <summary>
    /// Total number of entries in the query range.
    /// </summary>
    public int TotalEntries { get; init; }

    /// <summary>
    /// Number of auto-approved entries.
    /// </summary>
    public int AutoApprovedCount { get; init; }

    /// <summary>
    /// Number of user-approved entries.
    /// </summary>
    public int UserApprovedCount { get; init; }

    /// <summary>
    /// Number of user-denied entries.
    /// </summary>
    public int UserDeniedCount { get; init; }

    /// <summary>
    /// Number of policy-blocked entries.
    /// </summary>
    public int PolicyBlockedCount { get; init; }

    /// <summary>
    /// Number of rate-limited entries.
    /// </summary>
    public int RateLimitedCount { get; init; }

    /// <summary>
    /// Number of timed-out entries.
    /// </summary>
    public int TimedOutCount { get; init; }

    /// <summary>
    /// Number of error entries.
    /// </summary>
    public int ErrorCount { get; init; }

    /// <summary>
    /// Number of failed executions.
    /// </summary>
    public int FailedExecutionsCount { get; init; }

    /// <summary>
    /// Tool usage counts (tool ID -> count).
    /// </summary>
    public Dictionary<string, int> ToolUsageCounts { get; init; } = new();

    /// <summary>
    /// Risk level distribution.
    /// </summary>
    public Dictionary<RiskLevel, int> RiskLevelCounts { get; init; } = new();

    /// <summary>
    /// Category usage counts.
    /// </summary>
    public Dictionary<ToolCategory, int> CategoryCounts { get; init; } = new();

    /// <summary>
    /// Average execution duration.
    /// </summary>
    public TimeSpan? AverageExecutionDuration { get; init; }

    /// <summary>
    /// Time period covered by statistics.
    /// </summary>
    public DateTime? FromDate { get; init; }

    /// <summary>
    /// End of time period.
    /// </summary>
    public DateTime? ToDate { get; init; }

    #region Computed Properties

    /// <summary>
    /// Total approved (auto + user).
    /// </summary>
    public int TotalApproved => AutoApprovedCount + UserApprovedCount;

    /// <summary>
    /// Total denied (user denied + blocked + rate limited + timed out).
    /// </summary>
    public int TotalDenied =>
        UserDeniedCount + PolicyBlockedCount + RateLimitedCount + TimedOutCount;

    /// <summary>
    /// Approval rate as percentage.
    /// </summary>
    public double ApprovalRate =>
        TotalEntries > 0
            ? (double)TotalApproved / TotalEntries * 100
            : 0;

    /// <summary>
    /// Most used tool.
    /// </summary>
    public string? MostUsedTool =>
        ToolUsageCounts.Count > 0
            ? ToolUsageCounts.MaxBy(kvp => kvp.Value).Key
            : null;

    /// <summary>
    /// Number of unique tools used.
    /// </summary>
    public int UniqueToolsUsed => ToolUsageCounts.Count;

    #endregion
}
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `AuditLogEntry.cs` | `Core/Models/Permissions/` | Audit entry model with factory methods | ~350 |
| `AuditDecision.cs` | `Core/Models/Permissions/` | Decision enum with extensions | ~90 |
| `AuditLogQuery.cs` | `Core/Models/Permissions/` | Query model with builders | ~180 |
| `AuditLogStatistics.cs` | `Core/Models/Permissions/` | Statistics model | ~95 |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `AuditLogEntry_ForExecution_SetsAllFields` | Factory method |
| `AuditLogEntry_ForDenial_SetsBlockedDecision` | Blocked entries |
| `AuditLogEntry_ForTimeout_SetsTimedOutDecision` | Timeout entries |
| `AuditLogEntry_ForRateLimited_SetsRateLimitedDecision` | Rate limited |
| `AuditLogEntry_ForError_SetsErrorDecision` | Error entries |
| `AuditLogEntry_RedactSensitiveParameters_RedactsPasswords` | Redaction |
| `AuditLogEntry_RedactSensitiveParameters_RedactsSshPaths` | Path redaction |
| `AuditLogEntry_GenerateSummary_IncludesPath` | Summary generation |
| `AuditDecision_IsApproved_ReturnsTrueForApproved` | Extension method |
| `AuditDecision_IsDenied_ReturnsTrueForDenied` | Extension method |
| `AuditLogQuery_Today_SetsCorrectDates` | Factory method |
| `AuditLogQuery_LastDays_SetsStartDate` | Factory method |
| `AuditLogQuery_WithPaging_SetsPagination` | Builder method |
| `AuditLogStatistics_ApprovalRate_CalculatesCorrectly` | Computed property |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | AuditLogEntry captures all relevant information |
| AC-2 | Factory methods simplify entry creation |
| AC-3 | Query model supports comprehensive filtering |
| AC-4 | Parameters can be stored as JSON |
| AC-5 | Sensitive parameters are redacted |

---

## Changelog Entry

```markdown
## v0.6.4f - Audit Log Models

### Added
- `AuditLogEntry` model for comprehensive audit tracking
  - Identification: Id, Timestamp, ConversationId, RequestId
  - Tool info: ToolId, ToolName, ToolCategory
  - Risk & decision: RiskLevel, RiskFactors, Decision, PermissionSource
  - Parameters with automatic redaction
  - Execution results: Success, Error, Duration, ResultSummary
  - Factory methods: ForExecution, ForDenial, ForTimeout,
    ForRateLimited, ForError
  - Automatic parameter redaction for sensitive data
- `AuditDecision` enum with 7 decision types
  - AutoApproved, UserApproved, UserDenied
  - PolicyBlocked, RateLimited, TimedOut, Error
  - Extension methods: GetDisplayName, GetIcon, IsApproved, IsDenied
- `AuditLogQuery` for flexible searching
  - Date, tool, decision, risk, context filtering
  - Text search in execution summary
  - Pagination and sorting
  - Factory methods: Today, LastDays, ForTool, ForConversation,
    Denied, HighRisk, Failures
  - Builder methods for fluent API
- `AuditLogStatistics` for reporting
  - Decision counts by type
  - Tool and category usage
  - Risk level distribution
  - Computed properties: ApprovalRate, MostUsedTool
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.4f | 0.5 day |
