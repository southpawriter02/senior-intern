# Design Specification: AIntern v0.6.5e "Agent Settings ViewModel"

## Overview

**Version**: v0.6.5e
**Parent**: v0.6.5 Agent Loop & Polish
**Focus**: ViewModel implementation for the agent settings panel with full configuration management

### Purpose

Implement the ViewModel that:
1. Loads and saves agent settings to/from storage
2. Manages policy mode and risk threshold settings
3. Provides filtered tool list with search capability
4. Handles execution limit configuration
5. Manages audit logging settings and operations
6. Supports protected path management

### Dependencies

**From v0.6.5d (Agent Settings Panel XAML)**:
- Bound to by the settings panel UI
- Uses `ToolPermissionItem`, `RiskLevelDescription`, `ProtectedPathItem`

**From v0.6.4 (Safety & Approval)**:
- `PolicyMode`, `RiskLevel` enums
- `IAuditLogRepository` interface

**From v0.6.1 (Tool Framework)**:
- `IToolRegistry` for tool enumeration

**From Core Services**:
- `ISettingsService` for persistence
- `IDialogService` for user interactions

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    v0.6.5e Agent Settings ViewModel Architecture              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Class Diagram:                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                    AgentSettingsViewModel                                │ │
│  │  (inherits ViewModelBase)                                               │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                          │ │
│  │  Dependencies:                                                           │ │
│  │  ├── ISettingsService _settingsService                                  │ │
│  │  ├── IToolRegistry _toolRegistry                                        │ │
│  │  ├── IAuditLogRepository _auditLogRepository                            │ │
│  │  └── IDialogService _dialogService                                      │ │
│  │                                                                          │ │
│  │  Policy Settings:                                                        │ │
│  │  ├── PolicyMode: PolicyMode (→ IsRiskThresholdVisible)                  │ │
│  │  ├── RiskThresholdValue: int (→ RiskThresholdText, RiskThresholdBrush)  │ │
│  │  └── RiskLevelDescriptions: RiskLevelDescription[]                      │ │
│  │                                                                          │ │
│  │  Execution Limits:                                                       │ │
│  │  ├── MaxIterations: int                                                 │ │
│  │  ├── ToolTimeoutSeconds: int                                            │ │
│  │  ├── RateLimitPerMinute: int                                            │ │
│  │  └── RateLimitPerHour: int                                              │ │
│  │                                                                          │ │
│  │  Audit Settings:                                                         │ │
│  │  ├── AuditAllExecutions: bool (→ AuditLogStats)                         │ │
│  │  ├── AuditIncludeParameters: bool                                       │ │
│  │  └── AuditIncludeResults: bool                                          │ │
│  │                                                                          │ │
│  │  Tool Permissions:                                                       │ │
│  │  ├── Tools: ObservableCollection<ToolPermissionItem>                    │ │
│  │  ├── ToolSearchText: string (→ FilteredTools)                           │ │
│  │  └── FilteredTools: ObservableCollection<ToolPermissionItem>            │ │
│  │                                                                          │ │
│  │  Protected Paths:                                                        │ │
│  │  └── ProtectedPaths: ObservableCollection<ProtectedPathItem>            │ │
│  │                                                                          │ │
│  │  Commands:                                                               │ │
│  │  ├── SaveSettingsCommand                                                │ │
│  │  ├── ResetToolPermissionsCommand                                        │ │
│  │  ├── ViewAuditLogCommand                                                │ │
│  │  ├── ExportAuditLogCommand                                              │ │
│  │  ├── ClearAuditLogCommand                                               │ │
│  │  ├── AddProtectedPathCommand                                            │ │
│  │  └── RemoveProtectedPathCommand                                         │ │
│  │                                                                          │ │
│  │  Methods:                                                                │ │
│  │  ├── LoadSettingsAsync()                                                │ │
│  │  └── LoadAuditStatsAsync()                                              │ │
│  │                                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Data Flow:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  LoadSettingsAsync()                                                     │ │
│  │         │                                                                │ │
│  │         ├──→ ISettingsService.GetAgentSettingsAsync()                   │ │
│  │         │         └──→ Populate all observable properties               │ │
│  │         │                                                                │ │
│  │         ├──→ IToolRegistry.GetAllTools()                                │ │
│  │         │         └──→ Populate Tools collection                        │ │
│  │         │                                                                │ │
│  │         └──→ LoadAuditStatsAsync()                                      │ │
│  │                   └──→ Update AuditLogStats                             │ │
│  │                                                                          │ │
│  │  SaveSettingsAsync()                                                     │ │
│  │         │                                                                │ │
│  │         ├──→ Build AgentSettings from properties                        │ │
│  │         ├──→ ISettingsService.SaveAgentSettingsAsync()                  │ │
│  │         └──→ IDialogService.ShowInfoAsync()                             │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Settings Data Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Settings Data Flow                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Load Flow:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  Storage (JSON)                                                          ││
│  │       │                                                                  ││
│  │       ▼                                                                  ││
│  │  ISettingsService.GetAgentSettingsAsync()                                ││
│  │       │                                                                  ││
│  │       ▼                                                                  ││
│  │  AgentSettings (Domain Model)                                            ││
│  │       │                                                                  ││
│  │       ├──→ PolicyMode → _policyMode                                     ││
│  │       ├──→ ApprovalThreshold → _riskThresholdValue                      ││
│  │       ├──→ MaxIterations → _maxIterations                               ││
│  │       ├──→ ToolTimeout → _toolTimeoutSeconds                            ││
│  │       ├──→ RateLimitPerMinute → _rateLimitPerMinute                     ││
│  │       ├──→ RateLimitPerHour → _rateLimitPerHour                         ││
│  │       ├──→ AuditAllExecutions → _auditAllExecutions                     ││
│  │       ├──→ AuditIncludeParameters → _auditIncludeParameters             ││
│  │       ├──→ AuditIncludeResults → _auditIncludeResults                   ││
│  │       └──→ ProtectedPaths → ProtectedPaths collection                   ││
│  │       │                                                                  ││
│  │  IToolRegistry.GetAllTools()                                             ││
│  │       │                                                                  ││
│  │       └──→ Map to ToolPermissionItem[]                                  ││
│  │            ├── Apply GetToolEnabled(id) → IsEnabled                     ││
│  │            └── Apply GetToolOverride(id) → OverrideAction               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Save Flow:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  ViewModel Properties                                                    ││
│  │       │                                                                  ││
│  │       ▼                                                                  ││
│  │  Build AgentSettings                                                     ││
│  │       ├── PolicyMode ← _policyMode                                      ││
│  │       ├── ApprovalThreshold ← (RiskLevel)_riskThresholdValue            ││
│  │       ├── MaxIterations ← _maxIterations                                ││
│  │       ├── ToolTimeout ← TimeSpan.FromSeconds(_toolTimeoutSeconds)       ││
│  │       ├── RateLimitPerMinute ← _rateLimitPerMinute                      ││
│  │       ├── RateLimitPerHour ← _rateLimitPerHour                          ││
│  │       ├── AuditAllExecutions ← _auditAllExecutions                      ││
│  │       ├── AuditIncludeParameters ← _auditIncludeParameters              ││
│  │       ├── AuditIncludeResults ← _auditIncludeResults                    ││
│  │       ├── ProtectedPaths ← ProtectedPaths.Select(p => p.Path)           ││
│  │       │                                                                  ││
│  │       └── For each Tool:                                                ││
│  │            ├── SetToolEnabled(id, IsEnabled)                            ││
│  │            └── SetToolOverride(id, OverrideAction)                      ││
│  │       │                                                                  ││
│  │       ▼                                                                  ││
│  │  ISettingsService.SaveAgentSettingsAsync(settings)                       ││
│  │       │                                                                  ││
│  │       ▼                                                                  ││
│  │  Storage (JSON)                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## File Specifications

### 1. AgentSettingsViewModel.cs

**Location**: `src/SeniorIntern.Desktop/ViewModels/AgentSettingsViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;
using Avalonia.Media;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Core.Tools;
using SeniorIntern.Desktop.Models;
using SeniorIntern.Desktop.Services;

/// <summary>
/// ViewModel for the agent settings panel.
/// </summary>
/// <remarks>
/// <para>
/// This ViewModel manages all agent configuration settings, including
/// policy mode, risk thresholds, tool permissions, execution limits,
/// audit logging, and protected paths.
/// </para>
/// <para>
/// Settings are loaded from and saved to persistent storage via
/// <see cref="ISettingsService"/>.
/// </para>
/// </remarks>
public partial class AgentSettingsViewModel : ViewModelBase
{
    private readonly ISettingsService _settingsService;
    private readonly IToolRegistry _toolRegistry;
    private readonly IAuditLogRepository _auditLogRepository;
    private readonly IDialogService _dialogService;

    private int _totalAuditEntries;
    private long _auditLogSizeBytes;
    private DateTime? _oldestEntry;

    #region Observable Properties - Policy Settings

    /// <summary>
    /// Current policy mode for tool approval.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(IsRiskThresholdVisible))]
    private PolicyMode _policyMode = PolicyMode.AskForRisky;

    /// <summary>
    /// Risk threshold value (0-4 mapping to RiskLevel enum).
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(RiskThresholdText))]
    [NotifyPropertyChangedFor(nameof(RiskThresholdBrush))]
    [NotifyPropertyChangedFor(nameof(RiskThreshold))]
    private int _riskThresholdValue = 2;

    #endregion

    #region Observable Properties - Execution Limits

    /// <summary>
    /// Maximum iterations per agent request.
    /// </summary>
    [ObservableProperty]
    private int _maxIterations = 10;

    /// <summary>
    /// Tool execution timeout in seconds.
    /// </summary>
    [ObservableProperty]
    private int _toolTimeoutSeconds = 60;

    /// <summary>
    /// Rate limit per minute.
    /// </summary>
    [ObservableProperty]
    private int _rateLimitPerMinute = 30;

    /// <summary>
    /// Rate limit per hour.
    /// </summary>
    [ObservableProperty]
    private int _rateLimitPerHour = 200;

    #endregion

    #region Observable Properties - Audit Settings

    /// <summary>
    /// Whether to audit all tool executions.
    /// </summary>
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(AuditLogStats))]
    private bool _auditAllExecutions = true;

    /// <summary>
    /// Whether to include parameters in audit log.
    /// </summary>
    [ObservableProperty]
    private bool _auditIncludeParameters = true;

    /// <summary>
    /// Whether to include results in audit log.
    /// </summary>
    [ObservableProperty]
    private bool _auditIncludeResults = true;

    #endregion

    #region Observable Properties - Tool Permissions

    /// <summary>
    /// Search text for tool filtering.
    /// </summary>
    [ObservableProperty]
    private string _toolSearchText = string.Empty;

    /// <summary>
    /// All available tools with their permission settings.
    /// </summary>
    [ObservableProperty]
    private ObservableCollection<ToolPermissionItem> _tools = new();

    #endregion

    #region Observable Properties - Protected Paths

    /// <summary>
    /// Protected paths that tools cannot access.
    /// </summary>
    [ObservableProperty]
    private ObservableCollection<ProtectedPathItem> _protectedPaths = new();

    #endregion

    #region Computed Properties

    /// <summary>
    /// Whether the risk threshold section should be visible.
    /// </summary>
    /// <remarks>
    /// Only visible when PolicyMode is AskForRisky, since that's the
    /// only mode where the threshold matters.
    /// </remarks>
    public bool IsRiskThresholdVisible => PolicyMode == PolicyMode.AskForRisky;

    /// <summary>
    /// The current risk threshold as a RiskLevel enum.
    /// </summary>
    public RiskLevel RiskThreshold => (RiskLevel)RiskThresholdValue;

    /// <summary>
    /// Text representation of current risk threshold.
    /// </summary>
    public string RiskThresholdText => RiskThreshold.ToString();

    /// <summary>
    /// Brush color for the risk threshold badge.
    /// </summary>
    public IBrush RiskThresholdBrush => RiskThresholdValue switch
    {
        0 => new SolidColorBrush(Color.Parse("#10B981")),  // Safe - Green
        1 => new SolidColorBrush(Color.Parse("#6B7280")),  // Low - Gray
        2 => new SolidColorBrush(Color.Parse("#F59E0B")),  // Medium - Amber
        3 => new SolidColorBrush(Color.Parse("#EF4444")),  // High - Red
        4 => new SolidColorBrush(Color.Parse("#7F1D1D")),  // Critical - Dark Red
        _ => Brushes.Gray
    };

    /// <summary>
    /// Filtered tools based on search text.
    /// </summary>
    public IEnumerable<ToolPermissionItem> FilteredTools
    {
        get
        {
            if (string.IsNullOrWhiteSpace(ToolSearchText))
                return Tools;

            return Tools.Where(t =>
                t.Name.Contains(ToolSearchText, StringComparison.OrdinalIgnoreCase) ||
                t.Description.Contains(ToolSearchText, StringComparison.OrdinalIgnoreCase) ||
                t.Category.ToString().Contains(ToolSearchText, StringComparison.OrdinalIgnoreCase));
        }
    }

    /// <summary>
    /// Risk level descriptions for the legend.
    /// </summary>
    public RiskLevelDescription[] RiskLevelDescriptions { get; } =
        Models.RiskLevelDescription.GetAll();

    /// <summary>
    /// Audit log statistics text.
    /// </summary>
    public string AuditLogStats
    {
        get
        {
            if (!AuditAllExecutions)
                return "Audit logging disabled";

            if (_totalAuditEntries == 0)
                return "No audit entries";

            var sizeText = FormatFileSize(_auditLogSizeBytes);
            var dateText = _oldestEntry.HasValue
                ? $" | Oldest: {_oldestEntry.Value:d}"
                : string.Empty;

            return $"{_totalAuditEntries:N0} entries | {sizeText}{dateText}";
        }
    }

    #endregion

    #region Constructor

    /// <summary>
    /// Initializes a new instance of the AgentSettingsViewModel.
    /// </summary>
    public AgentSettingsViewModel(
        ISettingsService settingsService,
        IToolRegistry toolRegistry,
        IAuditLogRepository auditLogRepository,
        IDialogService dialogService)
    {
        _settingsService = settingsService ?? throw new ArgumentNullException(nameof(settingsService));
        _toolRegistry = toolRegistry ?? throw new ArgumentNullException(nameof(toolRegistry));
        _auditLogRepository = auditLogRepository ?? throw new ArgumentNullException(nameof(auditLogRepository));
        _dialogService = dialogService ?? throw new ArgumentNullException(nameof(dialogService));
    }

    #endregion

    #region Initialization

    /// <summary>
    /// Load settings from storage.
    /// </summary>
    public async Task LoadSettingsAsync()
    {
        var settings = await _settingsService.GetAgentSettingsAsync();

        // Load policy settings
        PolicyMode = settings.PolicyMode;
        RiskThresholdValue = (int)settings.ApprovalThreshold;

        // Load execution limits
        MaxIterations = settings.MaxIterations;
        ToolTimeoutSeconds = (int)settings.ToolTimeout.TotalSeconds;
        RateLimitPerMinute = settings.RateLimitPerMinute;
        RateLimitPerHour = settings.RateLimitPerHour;

        // Load audit settings
        AuditAllExecutions = settings.AuditAllExecutions;
        AuditIncludeParameters = settings.AuditIncludeParameters;
        AuditIncludeResults = settings.AuditIncludeResults;

        // Load tools from registry with saved permissions
        await LoadToolsAsync(settings);

        // Load protected paths
        ProtectedPaths = new ObservableCollection<ProtectedPathItem>(
            settings.ProtectedPaths.Select(p => ProtectedPathItem.FromPath(p)));

        // Load audit statistics
        await LoadAuditStatsAsync();
    }

    /// <summary>
    /// Load tools from registry with permission settings.
    /// </summary>
    private async Task LoadToolsAsync(AgentSettings settings)
    {
        var tools = await Task.Run(() => _toolRegistry.GetAllTools());

        Tools = new ObservableCollection<ToolPermissionItem>(
            tools.Select(t => new ToolPermissionItem
            {
                Id = t.Id,
                Name = t.Name,
                Description = t.Description,
                Category = t.Category,
                RiskLevel = t.DefaultRiskLevel,
                IsEnabled = settings.GetToolEnabled(t.Id),
                OverrideAction = settings.GetToolOverride(t.Id)
            }));
    }

    /// <summary>
    /// Load audit log statistics.
    /// </summary>
    private async Task LoadAuditStatsAsync()
    {
        try
        {
            var stats = await _auditLogRepository.GetStatisticsAsync();
            _totalAuditEntries = stats.TotalEntries;
            _auditLogSizeBytes = stats.SizeBytes;
            _oldestEntry = stats.OldestEntry;
        }
        catch
        {
            _totalAuditEntries = 0;
            _auditLogSizeBytes = 0;
            _oldestEntry = null;
        }

        OnPropertyChanged(nameof(AuditLogStats));
    }

    #endregion

    #region Property Changed Handlers

    /// <summary>
    /// Handle search text changes to update filtered list.
    /// </summary>
    partial void OnToolSearchTextChanged(string value)
    {
        OnPropertyChanged(nameof(FilteredTools));
    }

    #endregion

    #region Commands - Settings

    /// <summary>
    /// Save all settings to storage.
    /// </summary>
    [RelayCommand]
    private async Task SaveSettingsAsync()
    {
        try
        {
            var settings = BuildSettingsFromProperties();
            await _settingsService.SaveAgentSettingsAsync(settings);
            await _dialogService.ShowInfoAsync("Settings Saved", "Agent settings have been saved successfully.");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("Save Failed", $"Failed to save settings: {ex.Message}");
        }
    }

    /// <summary>
    /// Build AgentSettings from current property values.
    /// </summary>
    private AgentSettings BuildSettingsFromProperties()
    {
        var settings = new AgentSettings
        {
            PolicyMode = PolicyMode,
            ApprovalThreshold = RiskThreshold,
            MaxIterations = MaxIterations,
            ToolTimeout = TimeSpan.FromSeconds(ToolTimeoutSeconds),
            RateLimitPerMinute = RateLimitPerMinute,
            RateLimitPerHour = RateLimitPerHour,
            AuditAllExecutions = AuditAllExecutions,
            AuditIncludeParameters = AuditIncludeParameters,
            AuditIncludeResults = AuditIncludeResults,
            ProtectedPaths = ProtectedPaths.Select(p => p.Path).ToList()
        };

        // Apply tool permissions
        foreach (var tool in Tools)
        {
            settings.SetToolEnabled(tool.Id, tool.IsEnabled);
            settings.SetToolOverride(tool.Id, tool.OverrideAction);
        }

        return settings;
    }

    #endregion

    #region Commands - Tool Permissions

    /// <summary>
    /// Reset all tool permissions to their defaults.
    /// </summary>
    [RelayCommand]
    private async Task ResetToolPermissionsAsync()
    {
        var confirmed = await _dialogService.ShowConfirmAsync(
            "Reset Tool Permissions",
            "Are you sure you want to reset all tool permissions to their defaults?");

        if (!confirmed) return;

        foreach (var tool in Tools)
        {
            tool.IsEnabled = true;
            tool.OverrideAction = ToolOverrideAction.Default;
        }
    }

    #endregion

    #region Commands - Audit Log

    /// <summary>
    /// Open the audit log viewer dialog.
    /// </summary>
    [RelayCommand]
    private async Task ViewAuditLogAsync()
    {
        await _dialogService.ShowAuditLogViewerAsync();
    }

    /// <summary>
    /// Export the audit log to a file.
    /// </summary>
    [RelayCommand]
    private async Task ExportAuditLogAsync()
    {
        var filters = new[]
        {
            new FileDialogFilter { Name = "JSON files", Extensions = { "json" } },
            new FileDialogFilter { Name = "CSV files", Extensions = { "csv" } }
        };

        var path = await _dialogService.ShowSaveFileDialogAsync(
            "Export Audit Log",
            $"audit_log_{DateTime.Now:yyyyMMdd_HHmmss}.json",
            filters);

        if (string.IsNullOrEmpty(path)) return;

        try
        {
            var entries = await _auditLogRepository.GetAllAsync();

            if (path.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
            {
                await ExportAsJsonAsync(path, entries);
            }
            else if (path.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
            {
                await ExportAsCsvAsync(path, entries);
            }

            await _dialogService.ShowInfoAsync("Export Complete", $"Audit log exported to:\n{path}");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("Export Failed", $"Failed to export audit log: {ex.Message}");
        }
    }

    /// <summary>
    /// Export audit entries as JSON.
    /// </summary>
    private static async Task ExportAsJsonAsync(string path, IEnumerable<AuditLogEntry> entries)
    {
        var options = new JsonSerializerOptions
        {
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };

        var json = JsonSerializer.Serialize(entries, options);
        await File.WriteAllTextAsync(path, json);
    }

    /// <summary>
    /// Export audit entries as CSV.
    /// </summary>
    private static async Task ExportAsCsvAsync(string path, IEnumerable<AuditLogEntry> entries)
    {
        var lines = new List<string>
        {
            "Timestamp,ToolId,ToolName,RiskLevel,Decision,ExecutionSuccess,DurationMs,ConversationId"
        };

        foreach (var entry in entries)
        {
            var durationMs = entry.ExecutionDuration?.TotalMilliseconds.ToString("F0") ?? "";
            lines.Add(string.Join(",",
                entry.Timestamp.ToString("O"),
                EscapeCsv(entry.ToolId),
                EscapeCsv(entry.ToolName),
                entry.RiskLevel,
                entry.Decision,
                entry.ExecutionSuccess,
                durationMs,
                entry.ConversationId));
        }

        await File.WriteAllLinesAsync(path, lines);
    }

    /// <summary>
    /// Escape a value for CSV format.
    /// </summary>
    private static string EscapeCsv(string value)
    {
        if (string.IsNullOrEmpty(value)) return "";
        if (value.Contains(',') || value.Contains('"') || value.Contains('\n'))
        {
            return $"\"{value.Replace("\"", "\"\"")}\"";
        }
        return value;
    }

    /// <summary>
    /// Clear the audit log after confirmation.
    /// </summary>
    [RelayCommand]
    private async Task ClearAuditLogAsync()
    {
        var confirmed = await _dialogService.ShowConfirmAsync(
            "Clear Audit Log",
            "Are you sure you want to clear the audit log?\n\nThis action cannot be undone.",
            isDangerous: true);

        if (!confirmed) return;

        try
        {
            await _auditLogRepository.ClearAsync();
            await LoadAuditStatsAsync();
            await _dialogService.ShowInfoAsync("Audit Log Cleared", "The audit log has been cleared.");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("Clear Failed", $"Failed to clear audit log: {ex.Message}");
        }
    }

    #endregion

    #region Commands - Protected Paths

    /// <summary>
    /// Add a new protected path via folder picker.
    /// </summary>
    [RelayCommand]
    private async Task AddProtectedPathAsync()
    {
        var path = await _dialogService.ShowFolderPickerAsync("Select Protected Path");

        if (string.IsNullOrEmpty(path)) return;

        // Check for duplicates
        if (ProtectedPaths.Any(p => p.Path.Equals(path, StringComparison.OrdinalIgnoreCase)))
        {
            await _dialogService.ShowWarningAsync(
                "Path Already Protected",
                "This path is already in the protected list.");
            return;
        }

        ProtectedPaths.Add(ProtectedPathItem.FromPath(path));
    }

    /// <summary>
    /// Remove a protected path.
    /// </summary>
    [RelayCommand]
    private void RemoveProtectedPath(ProtectedPathItem item)
    {
        if (item is null) return;

        // Prevent removing system paths
        if (item.IsSystem)
        {
            _ = _dialogService.ShowWarningAsync(
                "Cannot Remove",
                "System-protected paths cannot be removed.");
            return;
        }

        ProtectedPaths.Remove(item);
    }

    #endregion

    #region Helpers

    /// <summary>
    /// Format bytes as human-readable file size.
    /// </summary>
    private static string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;

        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }

        return $"{len:0.#} {sizes[order]}";
    }

    #endregion
}

/// <summary>
/// File dialog filter for save dialogs.
/// </summary>
public class FileDialogFilter
{
    /// <summary>
    /// Display name for the filter.
    /// </summary>
    public string Name { get; init; } = string.Empty;

    /// <summary>
    /// File extensions (without leading dot).
    /// </summary>
    public List<string> Extensions { get; init; } = new();
}
```

### 2. AgentSettings.cs

**Location**: `src/SeniorIntern.Core/Models/AgentSettings.cs`

```csharp
namespace SeniorIntern.Core.Models;

using System;
using System.Collections.Generic;
using SeniorIntern.Core.Tools;
using SeniorIntern.Desktop.Models;

/// <summary>
/// Agent configuration settings model.
/// </summary>
/// <remarks>
/// <para>
/// This model holds all configurable settings for the agent, including
/// policy mode, execution limits, audit settings, and per-tool permissions.
/// </para>
/// <para>
/// Settings are persisted via <see cref="ISettingsService"/> and loaded
/// on application startup.
/// </para>
/// </remarks>
public sealed class AgentSettings
{
    #region Policy Settings

    /// <summary>
    /// Policy mode for tool approval.
    /// </summary>
    public PolicyMode PolicyMode { get; set; } = PolicyMode.AskForRisky;

    /// <summary>
    /// Risk level threshold for approval in AskForRisky mode.
    /// </summary>
    /// <remarks>
    /// Tools at or above this risk level will require user approval.
    /// </remarks>
    public RiskLevel ApprovalThreshold { get; set; } = RiskLevel.Medium;

    #endregion

    #region Execution Limits

    /// <summary>
    /// Maximum iterations per agent request.
    /// </summary>
    /// <remarks>
    /// One iteration = one LLM call that may include tool calls.
    /// </remarks>
    public int MaxIterations { get; set; } = 10;

    /// <summary>
    /// Timeout for individual tool executions.
    /// </summary>
    public TimeSpan ToolTimeout { get; set; } = TimeSpan.FromSeconds(60);

    /// <summary>
    /// Maximum tool calls per minute.
    /// </summary>
    public int RateLimitPerMinute { get; set; } = 30;

    /// <summary>
    /// Maximum tool calls per hour.
    /// </summary>
    public int RateLimitPerHour { get; set; } = 200;

    #endregion

    #region Audit Settings

    /// <summary>
    /// Whether to log all tool executions to the audit log.
    /// </summary>
    public bool AuditAllExecutions { get; set; } = true;

    /// <summary>
    /// Whether to include tool parameters in audit log entries.
    /// </summary>
    /// <remarks>
    /// Parameters may contain sensitive data. Consider disabling
    /// for highly sensitive environments.
    /// </remarks>
    public bool AuditIncludeParameters { get; set; } = true;

    /// <summary>
    /// Whether to include tool results in audit log entries.
    /// </summary>
    public bool AuditIncludeResults { get; set; } = true;

    /// <summary>
    /// Number of days to retain audit log entries.
    /// </summary>
    public int AuditRetentionDays { get; set; } = 30;

    #endregion

    #region Protected Paths

    /// <summary>
    /// Paths that tools cannot access or modify.
    /// </summary>
    public List<string> ProtectedPaths { get; set; } = new()
    {
        "~/.ssh",
        "~/.aws",
        "~/.gnupg",
        "~/.config/secrets"
    };

    #endregion

    #region Tool Permissions

    /// <summary>
    /// Per-tool enabled state.
    /// </summary>
    private readonly Dictionary<string, bool> _toolEnabled = new();

    /// <summary>
    /// Per-tool override actions.
    /// </summary>
    private readonly Dictionary<string, ToolOverrideAction> _toolOverrides = new();

    /// <summary>
    /// Get whether a tool is enabled.
    /// </summary>
    /// <param name="toolId">Tool identifier.</param>
    /// <returns>True if enabled (default), false if disabled.</returns>
    public bool GetToolEnabled(string toolId) =>
        _toolEnabled.GetValueOrDefault(toolId, true);

    /// <summary>
    /// Set whether a tool is enabled.
    /// </summary>
    /// <param name="toolId">Tool identifier.</param>
    /// <param name="enabled">Whether the tool is enabled.</param>
    public void SetToolEnabled(string toolId, bool enabled)
    {
        if (enabled)
            _toolEnabled.Remove(toolId); // Default is enabled
        else
            _toolEnabled[toolId] = false;
    }

    /// <summary>
    /// Get the override action for a tool.
    /// </summary>
    /// <param name="toolId">Tool identifier.</param>
    /// <returns>Override action (Default if not set).</returns>
    public ToolOverrideAction GetToolOverride(string toolId) =>
        _toolOverrides.GetValueOrDefault(toolId, ToolOverrideAction.Default);

    /// <summary>
    /// Set the override action for a tool.
    /// </summary>
    /// <param name="toolId">Tool identifier.</param>
    /// <param name="action">Override action.</param>
    public void SetToolOverride(string toolId, ToolOverrideAction action)
    {
        if (action == ToolOverrideAction.Default)
            _toolOverrides.Remove(toolId); // Don't store default
        else
            _toolOverrides[toolId] = action;
    }

    /// <summary>
    /// Get all tool overrides (non-default only).
    /// </summary>
    public IReadOnlyDictionary<string, ToolOverrideAction> GetAllToolOverrides() =>
        _toolOverrides;

    /// <summary>
    /// Get all disabled tools.
    /// </summary>
    public IReadOnlyDictionary<string, bool> GetAllToolEnabledStates() =>
        _toolEnabled;

    #endregion

    #region Validation

    /// <summary>
    /// Validate settings and return any errors.
    /// </summary>
    public IEnumerable<string> Validate()
    {
        if (MaxIterations < 1)
            yield return "Max iterations must be at least 1";
        if (MaxIterations > 100)
            yield return "Max iterations cannot exceed 100";

        if (ToolTimeout < TimeSpan.FromSeconds(5))
            yield return "Tool timeout must be at least 5 seconds";
        if (ToolTimeout > TimeSpan.FromMinutes(30))
            yield return "Tool timeout cannot exceed 30 minutes";

        if (RateLimitPerMinute < 1)
            yield return "Rate limit per minute must be at least 1";
        if (RateLimitPerHour < RateLimitPerMinute)
            yield return "Hourly rate limit must be at least equal to minute rate limit";

        if (AuditRetentionDays < 1)
            yield return "Audit retention must be at least 1 day";
    }

    /// <summary>
    /// Check if settings are valid.
    /// </summary>
    public bool IsValid => !Validate().Any();

    #endregion

    #region Factory

    /// <summary>
    /// Create default settings.
    /// </summary>
    public static AgentSettings Default => new();

    /// <summary>
    /// Create settings with all audit features enabled.
    /// </summary>
    public static AgentSettings WithFullAudit() => new()
    {
        AuditAllExecutions = true,
        AuditIncludeParameters = true,
        AuditIncludeResults = true
    };

    /// <summary>
    /// Create high-security settings.
    /// </summary>
    public static AgentSettings HighSecurity() => new()
    {
        PolicyMode = PolicyMode.AlwaysAsk,
        ApprovalThreshold = RiskLevel.Low,
        MaxIterations = 5,
        RateLimitPerMinute = 10,
        RateLimitPerHour = 50
    };

    #endregion
}
```

### 3. ISettingsService.cs

**Location**: `src/SeniorIntern.Core/Interfaces/ISettingsService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using System.Threading.Tasks;
using SeniorIntern.Core.Models;

/// <summary>
/// Service for managing application settings persistence.
/// </summary>
public interface ISettingsService
{
    /// <summary>
    /// Get agent settings from storage.
    /// </summary>
    /// <returns>Current agent settings or defaults if not set.</returns>
    Task<AgentSettings> GetAgentSettingsAsync();

    /// <summary>
    /// Save agent settings to storage.
    /// </summary>
    /// <param name="settings">Settings to save.</param>
    Task SaveAgentSettingsAsync(AgentSettings settings);

    /// <summary>
    /// Reset agent settings to defaults.
    /// </summary>
    Task ResetAgentSettingsAsync();
}
```

---

## File Summary

| File | Location | Purpose | Lines |
|------|----------|---------|-------|
| `AgentSettingsViewModel.cs` | `ViewModels/` | Settings panel ViewModel | ~450 |
| `AgentSettings.cs` | `Core/Models/` | Settings domain model | ~200 |
| `ISettingsService.cs` | `Core/Interfaces/` | Settings persistence interface | ~25 |

---

## Unit Test Plan

| Test | Description |
|------|-------------|
| `LoadSettingsAsync_PopulatesAllProperties` | Property population |
| `LoadSettingsAsync_LoadsToolsFromRegistry` | Tool loading |
| `LoadSettingsAsync_AppliesToolPermissions` | Permission application |
| `SaveSettingsAsync_BuildsCorrectModel` | Model building |
| `SaveSettingsAsync_PersistsViaService` | Service call |
| `FilteredTools_NoSearch_ReturnsAll` | Search filter (no filter) |
| `FilteredTools_WithSearch_FiltersCorrectly` | Search filter (with filter) |
| `RiskThresholdBrush_ReturnsCorrectColor` | Color mapping |
| `IsRiskThresholdVisible_TrueForAskForRisky` | Visibility logic |
| `IsRiskThresholdVisible_FalseForOtherModes` | Visibility logic |
| `ResetToolPermissionsAsync_ResetsAll` | Reset logic |
| `ExportAsJsonAsync_ProducesValidJson` | JSON export |
| `ExportAsCsvAsync_ProducesValidCsv` | CSV export |
| `AddProtectedPathAsync_AddsToPaths` | Path addition |
| `AddProtectedPathAsync_RejectsDuplicates` | Duplicate detection |
| `RemoveProtectedPath_RemovesFromList` | Path removal |
| `AgentSettings_Validate_DetectsErrors` | Validation |
| `AgentSettings_SetToolEnabled_TracksState` | Tool state |
| `AgentSettings_SetToolOverride_TracksOverride` | Override tracking |
| `FormatFileSize_FormatsCorrectly` | Size formatting |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Settings loaded from storage on initialization |
| AC-2 | Policy mode changes reflected in UI |
| AC-3 | Risk threshold updates text and brush |
| AC-4 | Tool search filters the list |
| AC-5 | Save command persists all settings |
| AC-6 | Reset tool permissions confirms before resetting |
| AC-7 | Audit log export supports JSON and CSV |
| AC-8 | Protected path management works correctly |

---

## Changelog Entry

```markdown
## v0.6.5e - Agent Settings ViewModel

### Added
- `AgentSettingsViewModel` class
  - Dependencies: ISettingsService, IToolRegistry, IAuditLogRepository, IDialogService
  - Policy properties: PolicyMode, RiskThresholdValue
  - Computed: IsRiskThresholdVisible, RiskThresholdText, RiskThresholdBrush
  - Execution limits: MaxIterations, ToolTimeoutSeconds, RateLimitPerMinute, RateLimitPerHour
  - Audit settings: AuditAllExecutions, AuditIncludeParameters, AuditIncludeResults
  - Tool permissions: Tools collection, ToolSearchText, FilteredTools
  - Protected paths: ProtectedPaths collection
  - Commands:
    - SaveSettingsCommand - Persists all settings
    - ResetToolPermissionsCommand - Resets to defaults
    - ViewAuditLogCommand - Opens viewer dialog
    - ExportAuditLogCommand - Export to JSON/CSV
    - ClearAuditLogCommand - Clears with confirmation
    - AddProtectedPathCommand - Folder picker
    - RemoveProtectedPathCommand - Removes path
  - Methods: LoadSettingsAsync(), LoadAuditStatsAsync()
- `AgentSettings` class
  - Policy: PolicyMode, ApprovalThreshold
  - Limits: MaxIterations, ToolTimeout, RateLimitPerMinute, RateLimitPerHour
  - Audit: AuditAllExecutions, AuditIncludeParameters, AuditIncludeResults, AuditRetentionDays
  - Protected paths: ProtectedPaths list with defaults
  - Tool permissions: GetToolEnabled/SetToolEnabled, GetToolOverride/SetToolOverride
  - Validation: Validate() method, IsValid property
  - Factories: Default, WithFullAudit(), HighSecurity()
- `ISettingsService` interface
  - GetAgentSettingsAsync()
  - SaveAgentSettingsAsync()
  - ResetAgentSettingsAsync()
- `FileDialogFilter` class for save dialogs
```

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.6.5e | 0.75 day |
