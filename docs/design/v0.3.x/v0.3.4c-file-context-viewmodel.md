# Design Specification: The Senior Intern v0.3.4c "File Context ViewModel"

## Executive Summary

This document provides a detailed implementation specification for v0.3.4c, which implements the `FileContextViewModel` - the ViewModel for attached file contexts that manages display state, preview content, and user interactions. This ViewModel bridges the core `FileContext` model with the UI layer, providing computed properties for display labels, icons, badges, and previews.

### v0.3.4c Scope

- Create `ContextAttachmentType` enum (File, Selection, Clipboard)
- Create `FileContextViewModel` with observable properties
- Implement factory methods (FromFile, FromSelection, FromClipboard)
- Implement computed display properties (DisplayLabel, ShortLabel, PreviewContent)
- Implement icon and badge logic based on language and type
- Implement conversion back to core `FileContext` model

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ContextAttachmentType | Enum for attachment types |
| FileContextViewModel | Full ViewModel implementation |
| FromFile factory | Create from file path |
| FromSelection factory | Create from editor selection |
| FromClipboard factory | Create from clipboard |
| ToFileContext | Convert to core model |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.3.4c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ContextAttachmentType (enum)                                     │
│  ├── File       → Entire file attached                           │
│  ├── Selection  → Code selection from editor                     │
│  └── Clipboard  → Content from clipboard                         │
│                                                                   │
│  FileContextViewModel : ViewModelBase                             │
│  ├── Observable Properties                                       │
│  │   ├── Id: Guid = Guid.NewGuid()                              │
│  │   ├── FilePath: string                                       │
│  │   ├── FileName: string                                       │
│  │   ├── Language: string?                                      │
│  │   ├── Content: string                                        │
│  │   ├── EstimatedTokens: int                                   │
│  │   ├── LineCount: int                                         │
│  │   ├── StartLine: int? (for selections)                       │
│  │   ├── EndLine: int? (for selections)                         │
│  │   ├── AttachmentType: ContextAttachmentType                  │
│  │   ├── IsExpanded: bool (preview state)                       │
│  │   ├── AttachedAt: DateTime                                   │
│  │   └── IsHovered: bool (UI state)                             │
│  │                                                                │
│  ├── Computed Properties                                         │
│  │   ├── DisplayLabel → "filename.cs" or "file.cs:10-25"       │
│  │   ├── ShortLabel → truncated to 20 chars                    │
│  │   ├── PreviewContent → first 15 lines, max 500 chars        │
│  │   ├── IsPartialContent → true if StartLine/EndLine set      │
│  │   ├── Tooltip → "file.cs • csharp • 50 lines • ~200 tokens" │
│  │   ├── IconKey → language-based icon resource key            │
│  │   └── Badge → "C#", "JS", "SEL", "CLIP"                     │
│  │                                                                │
│  ├── Factory Methods (static)                                    │
│  │   ├── FromFile(filePath, content, tokens)                    │
│  │   ├── FromSelection(filePath, content, start, end, tokens)   │
│  │   └── FromClipboard(content, language?, tokens)              │
│  │                                                                │
│  └── Conversion                                                  │
│      └── ToFileContext() → FileContext (core model)             │
│                                                                   │
│  Constants                                                        │
│  ├── MaxPreviewLength = 500 chars                               │
│  └── MaxPreviewLines = 15 lines                                 │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### ViewModel Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                    FileContextViewModel Structure                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                   FileContextViewModel                      │  │
│  │                                                             │  │
│  │  STORED PROPERTIES (Observable)                            │  │
│  │  ┌─────────────────────────────────────────────────────┐   │  │
│  │  │ Id            │ Guid (auto-generated)                │   │  │
│  │  │ FilePath      │ "/path/to/UserService.cs"           │   │  │
│  │  │ FileName      │ "UserService.cs"                    │   │  │
│  │  │ Language      │ "csharp"                            │   │  │
│  │  │ Content       │ "public class UserService..."       │   │  │
│  │  │ EstimatedTokens│ 156                                │   │  │
│  │  │ LineCount     │ 45                                  │   │  │
│  │  │ StartLine     │ null (or 10 for selection)          │   │  │
│  │  │ EndLine       │ null (or 25 for selection)          │   │  │
│  │  │ AttachmentType│ File | Selection | Clipboard        │   │  │
│  │  │ IsExpanded    │ false                               │   │  │
│  │  │ AttachedAt    │ DateTime.UtcNow                     │   │  │
│  │  │ IsHovered     │ false                               │   │  │
│  │  └─────────────────────────────────────────────────────┘   │  │
│  │                                                             │  │
│  │  COMPUTED PROPERTIES (get-only)                            │  │
│  │  ┌─────────────────────────────────────────────────────┐   │  │
│  │  │ DisplayLabel     │ "UserService.cs" or               │   │  │
│  │  │                  │ "UserService.cs:10-25"            │   │  │
│  │  │ ShortLabel       │ "UserService.cs" (max 20 chars)  │   │  │
│  │  │ PreviewContent   │ First 15 lines + "N more..."     │   │  │
│  │  │ IsPartialContent │ true if selection                │   │  │
│  │  │ Tooltip          │ Full metadata string             │   │  │
│  │  │ IconKey          │ "CSharpIcon"                     │   │  │
│  │  │ Badge            │ "C#"                             │   │  │
│  │  └─────────────────────────────────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Factory Method Flows

```
┌─────────────────────────────────────────────────────────────────┐
│                    Factory Method Flows                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FromFile("/path/to/file.cs", content, 156)                      │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 1. fileName = Path.GetFileName(filePath)  → "file.cs"     │  │
│  │ 2. language = LanguageDetector.Detect()   → "csharp"      │  │
│  │ 3. lineCount = content.Split('\n').Length → 45            │  │
│  │ 4. AttachmentType = File                                  │  │
│  │ 5. Return new FileContextViewModel                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│  FromSelection("/path/to/file.cs", content, 10, 25, 45)          │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 1. fileName = Path.GetFileName(filePath)  → "file.cs"     │  │
│  │ 2. language = LanguageDetector.Detect()   → "csharp"      │  │
│  │ 3. lineCount = endLine - startLine + 1    → 16            │  │
│  │ 4. StartLine = 10, EndLine = 25                           │  │
│  │ 5. AttachmentType = Selection                             │  │
│  │ 6. Return new FileContextViewModel                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│  FromClipboard(content, "python", 30)                            │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 1. fileName = "Clipboard"                                 │  │
│  │ 2. language = "python" (or null)                          │  │
│  │ 3. lineCount = content.Split('\n').Length                 │  │
│  │ 4. AttachmentType = Clipboard                             │  │
│  │ 5. Return new FileContextViewModel                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Display Property Examples

```
┌─────────────────────────────────────────────────────────────────┐
│                    Display Property Examples                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FILE ATTACHMENT                                                 │
│  ───────────────                                                 │
│  DisplayLabel:  "UserService.cs"                                 │
│  ShortLabel:    "UserService.cs"                                 │
│  Badge:         "C#"                                             │
│  IconKey:       "CSharpIcon"                                     │
│  Tooltip:       "UserService.cs • csharp • 45 lines • ~156 tokens"│
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│  SELECTION ATTACHMENT                                            │
│  ────────────────────                                            │
│  DisplayLabel:  "Program.cs:15-30"                               │
│  ShortLabel:    "Program.cs:15-30"                               │
│  Badge:         "SEL"                                            │
│  IconKey:       "SelectionIcon"                                  │
│  Tooltip:       "Program.cs:15-30 • csharp • 16 lines • ~45 tokens"│
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│  CLIPBOARD ATTACHMENT                                            │
│  ────────────────────                                            │
│  DisplayLabel:  "Clipboard"                                      │
│  ShortLabel:    "Clipboard"                                      │
│  Badge:         "CLIP"                                           │
│  IconKey:       "ClipboardIcon"                                  │
│  Tooltip:       "Clipboard • 5 lines • ~30 tokens"               │
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│  LONG FILENAME (ShortLabel truncation)                           │
│  ─────────────────────────────────────                           │
│  FileName:      "VeryLongServiceImplementation.cs"               │
│  ShortLabel:    "VeryLongServiceI..."                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
└── ViewModels/
    └── FileContextViewModel.cs                       (NEW)
```

---

## Implementation Details

### Task 1: Create ContextAttachmentType Enum

**File:** `src/SeniorIntern.Desktop/ViewModels/FileContextViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

/// <summary>
/// Type of context attachment.
/// </summary>
public enum ContextAttachmentType
{
    /// <summary>
    /// Entire file attached.
    /// </summary>
    File,

    /// <summary>
    /// Code selection from editor.
    /// </summary>
    Selection,

    /// <summary>
    /// Content from clipboard.
    /// </summary>
    Clipboard
}
```

### Task 2: Create FileContextViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/FileContextViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using System;
using System.Collections.Generic;
using System.IO;
using CommunityToolkit.Mvvm.ComponentModel;
using SeniorIntern.Core.Models;
using SeniorIntern.Core.Utilities;

/// <summary>
/// ViewModel for an attached file context.
/// </summary>
public partial class FileContextViewModel : ViewModelBase
{
    private const int MaxPreviewLength = 500;
    private const int MaxPreviewLines = 15;

    #region Observable Properties

    /// <summary>
    /// Unique identifier for this context.
    /// </summary>
    [ObservableProperty]
    private Guid _id = Guid.NewGuid();

    /// <summary>
    /// Full path to the file (empty for clipboard content).
    /// </summary>
    [ObservableProperty]
    private string _filePath = string.Empty;

    /// <summary>
    /// File name for display.
    /// </summary>
    [ObservableProperty]
    private string _fileName = string.Empty;

    /// <summary>
    /// Detected language identifier.
    /// </summary>
    [ObservableProperty]
    private string? _language;

    /// <summary>
    /// Full content of the context.
    /// </summary>
    [ObservableProperty]
    private string _content = string.Empty;

    /// <summary>
    /// Estimated token count.
    /// </summary>
    [ObservableProperty]
    private int _estimatedTokens;

    /// <summary>
    /// Total line count.
    /// </summary>
    [ObservableProperty]
    private int _lineCount;

    /// <summary>
    /// Starting line number (for selections).
    /// </summary>
    [ObservableProperty]
    private int? _startLine;

    /// <summary>
    /// Ending line number (for selections).
    /// </summary>
    [ObservableProperty]
    private int? _endLine;

    /// <summary>
    /// Type of attachment.
    /// </summary>
    [ObservableProperty]
    private ContextAttachmentType _attachmentType = ContextAttachmentType.File;

    /// <summary>
    /// Whether the preview is expanded.
    /// </summary>
    [ObservableProperty]
    private bool _isExpanded;

    /// <summary>
    /// When the context was attached.
    /// </summary>
    [ObservableProperty]
    private DateTime _attachedAt = DateTime.UtcNow;

    /// <summary>
    /// Whether this context is currently being hovered.
    /// </summary>
    [ObservableProperty]
    private bool _isHovered;

    #endregion

    #region Computed Properties

    /// <summary>
    /// Label for display (includes line range for selections).
    /// </summary>
    public string DisplayLabel
    {
        get
        {
            if (AttachmentType == ContextAttachmentType.Clipboard)
                return "Clipboard";

            if (StartLine.HasValue && EndLine.HasValue)
                return $"{FileName}:{StartLine}-{EndLine}";

            return FileName;
        }
    }

    /// <summary>
    /// Short label for compact display (max 20 chars).
    /// </summary>
    public string ShortLabel
    {
        get
        {
            var name = FileName;
            if (name.Length > 20)
                name = name[..17] + "...";

            if (StartLine.HasValue)
                return $"{name}:{StartLine}-{EndLine}";

            return name;
        }
    }

    /// <summary>
    /// Preview content (truncated to MaxPreviewLines and MaxPreviewLength).
    /// </summary>
    public string PreviewContent
    {
        get
        {
            if (string.IsNullOrEmpty(Content))
                return "(empty)";

            var lines = Content.Split('\n');
            if (lines.Length <= MaxPreviewLines && Content.Length <= MaxPreviewLength)
                return Content;

            var preview = string.Join('\n', lines.Take(MaxPreviewLines));
            if (preview.Length > MaxPreviewLength)
                preview = preview[..MaxPreviewLength];

            var remainingLines = lines.Length - MaxPreviewLines;
            if (remainingLines > 0)
                preview += $"\n// ... ({remainingLines} more lines)";
            else if (Content.Length > preview.Length)
                preview += "...";

            return preview;
        }
    }

    /// <summary>
    /// Whether this is a partial selection (not full file).
    /// </summary>
    public bool IsPartialContent => StartLine.HasValue || EndLine.HasValue;

    /// <summary>
    /// Tooltip text for the context pill.
    /// </summary>
    public string Tooltip
    {
        get
        {
            var parts = new List<string>
            {
                DisplayLabel,
                $"{LineCount} lines",
                $"~{EstimatedTokens} tokens"
            };

            if (!string.IsNullOrEmpty(Language))
                parts.Insert(1, Language);

            if (!string.IsNullOrEmpty(FilePath))
                parts.Add(FilePath);

            return string.Join(" • ", parts);
        }
    }

    /// <summary>
    /// Icon key based on language/type.
    /// </summary>
    public string IconKey
    {
        get
        {
            if (AttachmentType == ContextAttachmentType.Clipboard)
                return "ClipboardIcon";

            if (AttachmentType == ContextAttachmentType.Selection)
                return "SelectionIcon";

            return Language switch
            {
                "csharp" => "CSharpIcon",
                "javascript" or "typescript" => "JavaScriptIcon",
                "python" => "PythonIcon",
                "json" => "JsonIcon",
                "xml" or "html" => "XmlIcon",
                "markdown" => "MarkdownIcon",
                _ => "FileCodeIcon"
            };
        }
    }

    /// <summary>
    /// Badge text (e.g., "C#", "JS", "SEL", "CLIP").
    /// </summary>
    public string Badge
    {
        get
        {
            if (AttachmentType == ContextAttachmentType.Selection)
                return "SEL";

            if (AttachmentType == ContextAttachmentType.Clipboard)
                return "CLIP";

            return Language?.ToUpperInvariant() switch
            {
                "CSHARP" => "C#",
                "JAVASCRIPT" => "JS",
                "TYPESCRIPT" => "TS",
                "PYTHON" => "PY",
                _ => Language?.ToUpperInvariant()?[..Math.Min(4, Language.Length)] ?? "TXT"
            };
        }
    }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a FileContextViewModel from a file path and content.
    /// </summary>
    public static FileContextViewModel FromFile(
        string filePath,
        string content,
        int estimatedTokens)
    {
        var fileName = Path.GetFileName(filePath);
        var language = LanguageDetector.DetectByFileName(fileName);

        return new FileContextViewModel
        {
            FilePath = filePath,
            FileName = fileName,
            Language = language,
            Content = content,
            EstimatedTokens = estimatedTokens,
            LineCount = content.Split('\n').Length,
            AttachmentType = ContextAttachmentType.File
        };
    }

    /// <summary>
    /// Creates a FileContextViewModel from a code selection.
    /// </summary>
    public static FileContextViewModel FromSelection(
        string filePath,
        string content,
        int startLine,
        int endLine,
        int estimatedTokens)
    {
        var fileName = Path.GetFileName(filePath);
        var language = LanguageDetector.DetectByFileName(fileName);

        return new FileContextViewModel
        {
            FilePath = filePath,
            FileName = fileName,
            Language = language,
            Content = content,
            EstimatedTokens = estimatedTokens,
            LineCount = endLine - startLine + 1,
            StartLine = startLine,
            EndLine = endLine,
            AttachmentType = ContextAttachmentType.Selection
        };
    }

    /// <summary>
    /// Creates a FileContextViewModel from clipboard content.
    /// </summary>
    public static FileContextViewModel FromClipboard(
        string content,
        string? language,
        int estimatedTokens)
    {
        return new FileContextViewModel
        {
            FileName = "Clipboard",
            Language = language,
            Content = content,
            EstimatedTokens = estimatedTokens,
            LineCount = content.Split('\n').Length,
            AttachmentType = ContextAttachmentType.Clipboard
        };
    }

    #endregion

    #region Conversion

    /// <summary>
    /// Converts to core FileContext model.
    /// </summary>
    public FileContext ToFileContext()
    {
        return new FileContext
        {
            Id = Id,
            FilePath = FilePath,
            Content = Content,
            Language = Language,
            LineCount = LineCount,
            EstimatedTokens = EstimatedTokens,
            AttachedAt = AttachedAt,
            StartLine = StartLine,
            EndLine = EndLine
        };
    }

    #endregion
}
```

---

## Badge and Icon Reference

### Badge Mappings

| AttachmentType/Language | Badge |
|------------------------|-------|
| Selection | "SEL" |
| Clipboard | "CLIP" |
| csharp | "C#" |
| javascript | "JS" |
| typescript | "TS" |
| python | "PY" |
| Other | First 4 chars uppercase |
| Unknown | "TXT" |

### Icon Mappings

| AttachmentType/Language | IconKey |
|------------------------|---------|
| Clipboard | "ClipboardIcon" |
| Selection | "SelectionIcon" |
| csharp | "CSharpIcon" |
| javascript, typescript | "JavaScriptIcon" |
| python | "PythonIcon" |
| json | "JsonIcon" |
| xml, html | "XmlIcon" |
| markdown | "MarkdownIcon" |
| Other | "FileCodeIcon" |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| FromFile | 3 | Basic, with language, line count |
| FromSelection | 3 | Basic, line range, line count |
| FromClipboard | 2 | With language, without |
| DisplayLabel | 3 | File, selection, clipboard |
| ShortLabel | 2 | Normal, truncated |
| PreviewContent | 4 | Empty, short, long, truncation indicator |
| IsPartialContent | 2 | True for selection, false for file |
| Tooltip | 2 | With language, without |
| IconKey | 4 | Each type |
| Badge | 4 | Each type |
| ToFileContext | 2 | Full conversion, selection |
| **Total** | **31** | |

---

## Files Summary

### Files to Create (1)

| File | Lines |
|------|-------|
| `ViewModels/FileContextViewModel.cs` | 250 |

### Files to Modify (0)

None.

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | FromFile creates context from file path and content |
| AC-2 | FromSelection creates context with correct line range |
| AC-3 | FromClipboard creates context for clipboard content |
| AC-4 | DisplayLabel shows filename for files, with line range for selections |
| AC-5 | ShortLabel truncates filenames over 20 characters |
| AC-6 | PreviewContent limits to 15 lines and 500 characters |
| AC-7 | PreviewContent appends "N more lines" indicator |
| AC-8 | IconKey returns correct icon for each language/type |
| AC-9 | Badge returns correct short text for each language/type |
| AC-10 | ToFileContext converts to core model with all properties |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.1 | FileContext model, LanguageDetector |
| CommunityToolkit.Mvvm | ObservableProperty attribute |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.4c | 0.5 day |
