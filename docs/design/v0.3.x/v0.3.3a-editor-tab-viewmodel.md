# Design Specification: The Senior Intern v0.3.3a "Editor Tab ViewModel"

## Executive Summary

This document provides a detailed implementation specification for v0.3.3a, which implements the `EditorTabViewModel` - the ViewModel for individual editor tabs managing document state, dirty tracking, caret position, encoding detection, and syntax highlighting configuration.

### v0.3.3a Scope

- Create `EditorTabViewModel` with CommunityToolkit.Mvvm
- Integrate with AvaloniaEdit's `TextDocument`
- Implement dirty state tracking via content hash
- Implement caret position and selection tracking
- Detect encoding and line endings
- Provide factory methods for file and new tab creation

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| EditorTabViewModel | ViewModel for individual editor tabs |
| FromFile factory | Creates tab from existing file |
| CreateNew factory | Creates new unsaved tab |
| Dirty state tracking | Hash-based change detection |
| Caret tracking | Line, column, selection length |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.3.3a Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  EditorTabViewModel                                               │
│  ├── Identity                                                    │
│  │   ├── Id: Guid (unique identifier)                           │
│  │   ├── FilePath: string (empty for new files)                 │
│  │   └── FileName: string (display name)                        │
│  │                                                                │
│  ├── Document                                                    │
│  │   ├── Document: TextDocument (AvaloniaEdit)                  │
│  │   ├── Language: string? (e.g., "csharp")                     │
│  │   └── LineCount: int (computed)                              │
│  │                                                                │
│  ├── State                                                       │
│  │   ├── IsDirty: bool (unsaved changes)                        │
│  │   ├── IsActive: bool (currently selected)                    │
│  │   ├── IsReadOnly: bool (file is read-only)                   │
│  │   └── IsNewFile: bool (computed, no FilePath)                │
│  │                                                                │
│  ├── Caret Tracking                                              │
│  │   ├── CaretLine: int (1-based)                               │
│  │   ├── CaretColumn: int (1-based)                             │
│  │   ├── SelectionLength: int (0 if none)                       │
│  │   └── CursorPositionDisplay: string (computed)               │
│  │                                                                │
│  ├── File Metadata                                               │
│  │   ├── Encoding: string ("UTF-8", "UTF-16")                   │
│  │   ├── LineEnding: string ("LF", "CRLF", "CR")                │
│  │   └── Extension: string (e.g., ".cs")                        │
│  │                                                                │
│  ├── Display                                                     │
│  │   └── DisplayTitle: string (FileName + "•" if dirty)         │
│  │                                                                │
│  ├── Factory Methods                                             │
│  │   ├── FromFile(filePath, content) → EditorTabViewModel       │
│  │   └── CreateNew(name?, language?) → EditorTabViewModel       │
│  │                                                                │
│  ├── Methods                                                     │
│  │   ├── MarkAsSaved(newFilePath?) - reset dirty state          │
│  │   ├── GetContent() → string                                  │
│  │   ├── UpdateCaretPosition(line, col, sel)                    │
│  │   ├── GetOffsetForLine(lineNumber) → int                     │
│  │   └── Dispose() - cleanup subscriptions                      │
│  │                                                                │
│  └── Internal                                                    │
│      ├── _savedContentHash: int (for dirty detection)           │
│      ├── OnDocumentTextChanged() - update dirty state           │
│      └── DetectEncodingAndLineEnding() - parse content          │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Dirty State Detection

```
┌─────────────────────────────────────────────────────────────────┐
│                    Dirty State Detection                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  File Opened / Created                                           │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ _savedContentHash = content.GetHashCode()                  │  │
│  │ IsDirty = false                                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Document.TextChanged += OnDocumentTextChanged              │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         │  User edits document                                   │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ OnDocumentTextChanged()                                    │  │
│  │                                                             │  │
│  │ currentHash = Document.Text.GetHashCode()                  │  │
│  │ IsDirty = (currentHash != _savedContentHash)               │  │
│  │                                                             │  │
│  │ • Hash matches saved → Not dirty (undo back to saved)     │  │
│  │ • Hash differs → Dirty (unsaved changes)                  │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         │  User saves                                            │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ MarkAsSaved()                                              │  │
│  │                                                             │  │
│  │ _savedContentHash = Document.Text.GetHashCode()            │  │
│  │ IsDirty = false                                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Key benefit: If user edits and then undoes back to original,   │
│  IsDirty correctly returns to false (hash matches)              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Tab Creation Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Tab Creation Flows                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Opening Existing File                                           │
│  ─────────────────────                                           │
│                                                                  │
│  EditorTabViewModel.FromFile("/path/to/file.cs", content)        │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 1. Set FilePath = "/path/to/file.cs"                       │  │
│  │ 2. Set FileName = "file.cs"                                │  │
│  │ 3. Language = LanguageDetector.DetectByFileName("file.cs") │  │
│  │    → "csharp"                                              │  │
│  │ 4. DetectEncodingAndLineEnding(content)                    │  │
│  │    → LineEnding = "LF" or "CRLF"                          │  │
│  │ 5. Document.Text = content                                 │  │
│  │ 6. _savedContentHash = content.GetHashCode()               │  │
│  │ 7. Subscribe to Document.TextChanged                       │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  Tab ready for display with syntax highlighting                  │
│                                                                  │
│  ═══════════════════════════════════════════════════════════════ │
│                                                                  │
│  Creating New File                                               │
│  ─────────────────                                               │
│                                                                  │
│  EditorTabViewModel.CreateNew("Untitled-1", "javascript")        │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 1. FilePath = "" (empty, new file)                         │  │
│  │ 2. FileName = "Untitled-1"                                 │  │
│  │ 3. Language = "javascript" (if provided)                   │  │
│  │ 4. IsDirty = false (empty file starts clean)              │  │
│  │ 5. _savedContentHash = "".GetHashCode()                    │  │
│  │ 6. Subscribe to Document.TextChanged                       │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  Tab ready - IsNewFile = true (FilePath is empty)               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Caret Position Update

```
┌─────────────────────────────────────────────────────────────────┐
│                    Caret Position Tracking                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  AvaloniaEdit TextEditor                                         │
│         │                                                        │
│         │  Caret moves (click, arrow keys, typing)               │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Editor code-behind captures CaretPositionChanged           │  │
│  │                                                             │  │
│  │ var line = editor.TextArea.Caret.Line;                     │  │
│  │ var col = editor.TextArea.Caret.Column;                    │  │
│  │ var sel = editor.SelectionLength;                          │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  tab.UpdateCaretPosition(line, col, sel)                         │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ CaretLine = 45                                             │  │
│  │ CaretColumn = 12                                           │  │
│  │ SelectionLength = 0 (or N if selecting)                    │  │
│  │                                                             │  │
│  │ CursorPositionDisplay recalculated:                        │  │
│  │ • No selection: "Ln 45, Col 12"                           │  │
│  │ • With selection: "Ln 45, Col 12 (27 selected)"           │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  Status bar binds to CursorPositionDisplay                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
└── ViewModels/
    └── EditorTabViewModel.cs                         (NEW)
```

---

## Implementation Details

### Task 1: Create EditorTabViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/EditorTabViewModel.cs`

```csharp
namespace SeniorIntern.Desktop.ViewModels;

using System;
using System.IO;
using AvaloniaEdit.Document;
using CommunityToolkit.Mvvm.ComponentModel;
using SeniorIntern.Core.Utilities;

/// <summary>
/// ViewModel for a single editor tab representing an open file.
/// </summary>
public partial class EditorTabViewModel : ViewModelBase, IDisposable
{
    #region Observable Properties

    /// <summary>Unique identifier for this tab.</summary>
    [ObservableProperty]
    private Guid _id = Guid.NewGuid();

    /// <summary>Full path to the file on disk. Empty for new unsaved files.</summary>
    [ObservableProperty]
    private string _filePath = string.Empty;

    /// <summary>File name without path (e.g., "main.cs").</summary>
    [ObservableProperty]
    private string _fileName = string.Empty;

    /// <summary>The AvaloniaEdit document containing the text content.</summary>
    [ObservableProperty]
    private TextDocument _document = new();

    /// <summary>Detected language identifier (e.g., "csharp", "javascript").</summary>
    [ObservableProperty]
    private string? _language;

    /// <summary>Whether the document has unsaved changes.</summary>
    [ObservableProperty]
    private bool _isDirty;

    /// <summary>Whether this tab is currently active/focused.</summary>
    [ObservableProperty]
    private bool _isActive;

    /// <summary>Whether the file is read-only.</summary>
    [ObservableProperty]
    private bool _isReadOnly;

    /// <summary>Current caret line number (1-based).</summary>
    [ObservableProperty]
    private int _caretLine = 1;

    /// <summary>Current caret column number (1-based).</summary>
    [ObservableProperty]
    private int _caretColumn = 1;

    /// <summary>Character count of current selection (0 if no selection).</summary>
    [ObservableProperty]
    private int _selectionLength;

    /// <summary>File encoding (e.g., "UTF-8", "UTF-16").</summary>
    [ObservableProperty]
    private string _encoding = "UTF-8";

    /// <summary>Line ending type (e.g., "LF", "CRLF").</summary>
    [ObservableProperty]
    private string _lineEnding = "LF";

    #endregion

    #region Internal State

    /// <summary>Hash of the content when last saved, used for dirty detection.</summary>
    private int _savedContentHash;

    /// <summary>Whether the tab has been disposed.</summary>
    private bool _disposed;

    #endregion

    #region Computed Properties

    /// <summary>Display title for the tab (includes dirty indicator).</summary>
    public string DisplayTitle => IsDirty ? $"{FileName} •" : FileName;

    /// <summary>Whether this is a new file that hasn't been saved yet.</summary>
    public bool IsNewFile => string.IsNullOrEmpty(FilePath);

    /// <summary>Total line count in the document.</summary>
    public int LineCount => Document.LineCount;

    /// <summary>File extension including the dot (e.g., ".cs").</summary>
    public string Extension => Path.GetExtension(FileName);

    /// <summary>Cursor position display string (e.g., "Ln 45, Col 12").</summary>
    public string CursorPositionDisplay => SelectionLength > 0
        ? $"Ln {CaretLine}, Col {CaretColumn} ({SelectionLength} selected)"
        : $"Ln {CaretLine}, Col {CaretColumn}";

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new EditorTabViewModel for an existing file.
    /// </summary>
    /// <param name="filePath">Full path to the file.</param>
    /// <param name="content">File content as string.</param>
    /// <returns>Configured EditorTabViewModel.</returns>
    public static EditorTabViewModel FromFile(string filePath, string content)
    {
        var tab = new EditorTabViewModel
        {
            FilePath = filePath,
            FileName = Path.GetFileName(filePath),
            Language = LanguageDetector.DetectByFileName(Path.GetFileName(filePath)),
        };

        // Detect encoding and line endings from content
        tab.DetectEncodingAndLineEnding(content);

        // Set document content
        tab.Document.Text = content;
        tab._savedContentHash = content.GetHashCode();

        // Subscribe to document changes
        tab.Document.TextChanged += tab.OnDocumentTextChanged;

        return tab;
    }

    /// <summary>
    /// Creates a new EditorTabViewModel for a new unsaved file.
    /// </summary>
    /// <param name="suggestedName">Optional file name (default: "Untitled").</param>
    /// <param name="language">Optional language identifier.</param>
    /// <returns>Configured EditorTabViewModel.</returns>
    public static EditorTabViewModel CreateNew(string? suggestedName = null, string? language = null)
    {
        var fileName = suggestedName ?? "Untitled";

        var tab = new EditorTabViewModel
        {
            FileName = fileName,
            Language = language,
            IsDirty = false, // New empty files start as not dirty
        };

        tab._savedContentHash = string.Empty.GetHashCode();
        tab.Document.TextChanged += tab.OnDocumentTextChanged;

        return tab;
    }

    #endregion

    #region Public Methods

    /// <summary>
    /// Marks the document as saved, resetting dirty state.
    /// </summary>
    /// <param name="newFilePath">Optional new file path (for Save As).</param>
    public void MarkAsSaved(string? newFilePath = null)
    {
        if (!string.IsNullOrEmpty(newFilePath))
        {
            FilePath = newFilePath;
            FileName = Path.GetFileName(newFilePath);
            Language = LanguageDetector.DetectByFileName(FileName);
        }

        _savedContentHash = Document.Text.GetHashCode();
        IsDirty = false;
        OnPropertyChanged(nameof(DisplayTitle));
        OnPropertyChanged(nameof(IsNewFile));
    }

    /// <summary>
    /// Gets the current document content as a string.
    /// </summary>
    public string GetContent() => Document.Text;

    /// <summary>
    /// Updates caret position from the editor.
    /// </summary>
    /// <param name="line">Line number (1-based).</param>
    /// <param name="column">Column number (1-based).</param>
    /// <param name="selectionLength">Number of selected characters.</param>
    public void UpdateCaretPosition(int line, int column, int selectionLength = 0)
    {
        CaretLine = line;
        CaretColumn = column;
        SelectionLength = selectionLength;
        OnPropertyChanged(nameof(CursorPositionDisplay));
    }

    /// <summary>
    /// Gets the document offset for a specific line number.
    /// </summary>
    /// <param name="lineNumber">Line number (1-based).</param>
    /// <returns>Character offset in document.</returns>
    public int GetOffsetForLine(int lineNumber)
    {
        if (lineNumber < 1) lineNumber = 1;
        if (lineNumber > Document.LineCount) lineNumber = Document.LineCount;

        return Document.GetLineByNumber(lineNumber).Offset;
    }

    #endregion

    #region Private Methods

    private void OnDocumentTextChanged(object? sender, EventArgs e)
    {
        var currentHash = Document.Text.GetHashCode();
        var wasDirty = IsDirty;
        IsDirty = currentHash != _savedContentHash;

        if (wasDirty != IsDirty)
        {
            OnPropertyChanged(nameof(DisplayTitle));
        }

        OnPropertyChanged(nameof(LineCount));
    }

    private void DetectEncodingAndLineEnding(string content)
    {
        // Detect line ending
        if (content.Contains("\r\n"))
        {
            LineEnding = "CRLF";
        }
        else if (content.Contains('\r'))
        {
            LineEnding = "CR";
        }
        else
        {
            LineEnding = "LF";
        }

        // Encoding is typically determined when reading the file
        // Default to UTF-8; actual detection happens in FileSystemService
        Encoding = "UTF-8";
    }

    #endregion

    #region IDisposable

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;

        Document.TextChanged -= OnDocumentTextChanged;
    }

    #endregion
}
```

---

## Properties Reference

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| Id | Guid | NewGuid() | Unique tab identifier |
| FilePath | string | "" | Full path (empty for new files) |
| FileName | string | "" | Display name |
| Document | TextDocument | new() | AvaloniaEdit document |
| Language | string? | null | Language identifier |
| IsDirty | bool | false | Has unsaved changes |
| IsActive | bool | false | Currently selected |
| IsReadOnly | bool | false | File is read-only |
| CaretLine | int | 1 | Current line (1-based) |
| CaretColumn | int | 1 | Current column (1-based) |
| SelectionLength | int | 0 | Selected character count |
| Encoding | string | "UTF-8" | File encoding |
| LineEnding | string | "LF" | Line ending type |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| FromFile | 3 | Path, name, language detection |
| CreateNew | 2 | Default name, with language |
| IsDirty tracking | 4 | Edit, undo, save, hash comparison |
| MarkAsSaved | 2 | Reset dirty, update path |
| UpdateCaretPosition | 2 | Position, selection display |
| GetOffsetForLine | 2 | Valid line, bounds checking |
| DisplayTitle | 2 | Clean, dirty indicator |
| LineEnding detection | 3 | LF, CRLF, CR |
| Dispose | 1 | Unsubscribe events |
| **Total** | **21** | |

### Key Test Scenarios

```csharp
[Fact]
public void FromFile_DetectsLanguageFromExtension()
{
    var tab = EditorTabViewModel.FromFile("/path/to/file.cs", "class Foo {}");
    
    Assert.Equal("csharp", tab.Language);
    Assert.Equal("file.cs", tab.FileName);
    Assert.False(tab.IsDirty);
}

[Fact]
public void IsDirty_BecomesTrueOnEdit()
{
    var tab = EditorTabViewModel.FromFile("/test.txt", "original");
    
    tab.Document.Text = "modified";
    
    Assert.True(tab.IsDirty);
    Assert.Equal("test.txt •", tab.DisplayTitle);
}

[Fact]
public void IsDirty_BecomesFalseOnUndoToOriginal()
{
    var tab = EditorTabViewModel.FromFile("/test.txt", "original");
    tab.Document.Text = "modified";
    
    tab.Document.Text = "original"; // Undo back
    
    Assert.False(tab.IsDirty); // Hash matches saved
}

[Fact]
public void MarkAsSaved_ResetsStateAndUpdatesPath()
{
    var tab = EditorTabViewModel.CreateNew("Untitled-1");
    tab.Document.Text = "content";
    
    tab.MarkAsSaved("/new/path/file.js");
    
    Assert.Equal("/new/path/file.js", tab.FilePath);
    Assert.Equal("file.js", tab.FileName);
    Assert.Equal("javascript", tab.Language);
    Assert.False(tab.IsDirty);
}

[Fact]
public void DetectsLineEnding_CRLF()
{
    var tab = EditorTabViewModel.FromFile("/test.txt", "line1\r\nline2");
    
    Assert.Equal("CRLF", tab.LineEnding);
}
```

---

## Files Summary

| File | Lines |
|------|-------|
| `ViewModels/EditorTabViewModel.cs` | 200 |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | FromFile creates tab with correct path and name |
| AC-2 | FromFile detects language from extension |
| AC-3 | CreateNew creates tab with suggested name |
| AC-4 | IsDirty becomes true when document edited |
| AC-5 | IsDirty becomes false when undone to saved state |
| AC-6 | MarkAsSaved resets dirty and updates path |
| AC-7 | UpdateCaretPosition updates display string |
| AC-8 | DisplayTitle includes "•" when dirty |
| AC-9 | LineEnding correctly detected (LF/CRLF) |
| AC-10 | Dispose unsubscribes from document events |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.1c | LanguageDetector for language detection |
| AvaloniaEdit | TextDocument class |
| CommunityToolkit.Mvvm | ObservableProperty |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.3a | 0.5 day |
