# Design Specification: The Senior Intern v0.3.3c "Syntax Highlighting Service"

## Executive Summary

This document provides a detailed implementation specification for v0.3.3c, which implements the `SyntaxHighlightingService` - a TextMate-based syntax highlighting service that provides support for 40+ programming languages, theme switching, and proper lifecycle management of editor installations.

### v0.3.3c Scope

- Create `SyntaxHighlightingService` using TextMateSharp
- Build language-to-scope mapping for 40+ languages
- Implement `ApplyHighlighting()` for editor registration
- Implement `SetLanguage()` for grammar switching
- Implement `ChangeTheme()` for theme switching across all editors
- Manage TextMate installation lifecycle with proper cleanup

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| SyntaxHighlightingService | Main service for TextMate integration |
| Language-to-scope map | 40+ language mappings |
| Theme support | 7 built-in TextMate themes |
| Installation management | Track and cleanup editor installations |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.3.3c Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  SyntaxHighlightingService                                        │
│  ├── Constructor                                                 │
│  │   ├── useDarkTheme: bool (default: true)                     │
│  │   ├── Initializes RegistryOptions with theme                 │
│  │   └── Builds language-to-scope map                           │
│  │                                                                │
│  ├── Properties                                                  │
│  │   ├── AvailableThemes: IReadOnlyList<ThemeName> (static)     │
│  │   ├── CurrentTheme: ThemeName                                │
│  │   ├── RegistryOptions: RegistryOptions                       │
│  │   └── SupportedLanguages: IReadOnlyList<string>              │
│  │                                                                │
│  ├── Core Methods                                                │
│  │   ├── ApplyHighlighting(editor, language)                    │
│  │   │   ├── Remove existing installation                       │
│  │   │   ├── Create new TextMate installation                   │
│  │   │   ├── Set grammar for language                           │
│  │   │   └── Track in _installations dictionary                 │
│  │   │                                                           │
│  │   ├── SetLanguage(editor, language)                          │
│  │   │   ├── Find existing installation                         │
│  │   │   └── Update grammar without recreation                  │
│  │   │                                                           │
│  │   ├── ChangeTheme(theme)                                     │
│  │   │   ├── Skip if same theme                                 │
│  │   │   ├── Create new registry options                        │
│  │   │   └── Re-apply to all registered editors                 │
│  │   │                                                           │
│  │   ├── RemoveHighlighting(editor)                             │
│  │   │   ├── Dispose installation                               │
│  │   │   └── Remove from tracking dictionary                    │
│  │   │                                                           │
│  │   └── GetScopeForLanguage(language) → string?                │
│  │                                                                │
│  ├── Language Support (40+ languages)                            │
│  │   ├── .NET: csharp, fsharp, vb                               │
│  │   ├── Web: javascript, typescript, html, css, vue           │
│  │   ├── Systems: c, cpp, rust, go, swift                       │
│  │   ├── Scripting: python, ruby, php, perl, lua                │
│  │   ├── JVM: java, kotlin, scala, groovy                       │
│  │   ├── Shell: bash, powershell, bat                           │
│  │   ├── Data: json, xml, yaml, toml, sql                       │
│  │   ├── Markup: markdown, latex                                │
│  │   └── Other: dockerfile, makefile, cmake, diff               │
│  │                                                                │
│  ├── Theme Support (7 themes)                                    │
│  │   ├── DarkPlus (default dark)                                │
│  │   ├── LightPlus (default light)                              │
│  │   ├── Monokai                                                │
│  │   ├── SolarizedDark                                          │
│  │   ├── SolarizedLight                                         │
│  │   ├── HighContrastDark                                       │
│  │   └── HighContrastLight                                      │
│  │                                                                │
│  ├── Internal State                                              │
│  │   ├── _registryOptions: RegistryOptions                      │
│  │   ├── _languageToScope: Dictionary<string, string>           │
│  │   ├── _installations: Dictionary<TextEditor, Installation>  │
│  │   └── _currentTheme: ThemeName                               │
│  │                                                                │
│  └── IDisposable                                                 │
│      └── Dispose() - cleanup all installations                  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### TextMate Integration Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    TextMate Integration                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  NuGet Packages                                                  │
│  ──────────────────────────────────────────────────────────────  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐  │
│  │   AvaloniaEdit   │  │ TextMateSharp    │  │ TextMateSharp  │  │
│  │                  │  │                  │  │   .Grammars    │  │
│  │ • TextEditor     │  │ • Registry       │  │                │  │
│  │ • TextMate ext   │  │ • RegistryOpts   │  │ • Pre-bundled  │  │
│  │ • Installation   │  │ • ThemeName     │  │   grammars     │  │
│  └────────┬─────────┘  └────────┬─────────┘  └───────┬────────┘  │
│           │                     │                    │           │
│           └─────────────────────┴────────────────────┘           │
│                                 │                                │
│                                 ▼                                │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │              SyntaxHighlightingService                     │  │
│  │                                                             │  │
│  │  ┌────────────────────────────────────────────────────┐    │  │
│  │  │ _registryOptions = new RegistryOptions(theme)      │    │  │
│  │  │                                                     │    │  │
│  │  │ Contains:                                           │    │  │
│  │  │ • Theme colors and styles                          │    │  │
│  │  │ • Grammar loading logic                            │    │  │
│  │  │ • Pre-bundled TextMate grammars                    │    │  │
│  │  └────────────────────────────────────────────────────┘    │  │
│  │                                                             │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Apply Highlighting Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Apply Highlighting Flow                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ApplyHighlighting(editor, "csharp")                             │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Check for existing installation                            │  │
│  │                                                             │  │
│  │ if (_installations.TryGetValue(editor, out existing))      │  │
│  │ {                                                           │  │
│  │     existing.Dispose();                                    │  │
│  │     _installations.Remove(editor);                         │  │
│  │ }                                                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Create new TextMate installation                           │  │
│  │                                                             │  │
│  │ var installation = editor.InstallTextMate(_registryOptions);│  │
│  │                                                             │  │
│  │ This:                                                       │  │
│  │ • Hooks into editor rendering                              │  │
│  │ • Sets up tokenization                                     │  │
│  │ • Applies theme colors                                     │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Set grammar for language                                   │  │
│  │                                                             │  │
│  │ if (_languageToScope.TryGetValue("csharp", out scope))     │  │
│  │ {                                                           │  │
│  │     // scope = "source.cs"                                 │  │
│  │     installation.SetGrammar(scope);                        │  │
│  │ }                                                           │  │
│  │                                                             │  │
│  │ Grammar defines:                                            │  │
│  │ • Token patterns (keywords, strings, comments)             │  │
│  │ • Scope names (for theme coloring)                         │  │
│  │ • Nested grammar rules                                     │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Track installation                                         │  │
│  │                                                             │  │
│  │ _installations[editor] = installation;                     │  │
│  │                                                             │  │
│  │ return installation;                                       │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  Editor now displays syntax highlighting for C#                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Theme Change Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Theme Change Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ChangeTheme(ThemeName.Monokai)                                  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ if (_currentTheme == theme) return; // Skip same theme     │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ _currentTheme = theme;                                     │  │
│  │ var newOptions = new RegistryOptions(theme);               │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ For each registered editor:                                │  │
│  │                                                             │  │
│  │ foreach (var (editor, installation) in _installations)     │  │
│  │ {                                                           │  │
│  │     // Remember current language/scope                     │  │
│  │     var currentScope = GetCurrentScope(installation);      │  │
│  │                                                             │  │
│  │     // Dispose old installation                            │  │
│  │     installation.Dispose();                                │  │
│  │     _installations.Remove(editor);                         │  │
│  │                                                             │  │
│  │     // Create new with new theme                           │  │
│  │     var newInstallation = editor.InstallTextMate(newOpts); │  │
│  │                                                             │  │
│  │     // Re-apply grammar                                    │  │
│  │     if (!string.IsNullOrEmpty(currentScope))              │  │
│  │         newInstallation.SetGrammar(currentScope);          │  │
│  │                                                             │  │
│  │     _installations[editor] = newInstallation;              │  │
│  │ }                                                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  All editors now display with Monokai colors                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
└── Services/
    └── SyntaxHighlightingService.cs                  (NEW)
```

---

## Implementation Details

### Task 1: Create SyntaxHighlightingService

**File:** `src/SeniorIntern.Desktop/Services/SyntaxHighlightingService.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

using System;
using System.Collections.Generic;
using System.Linq;
using AvaloniaEdit;
using AvaloniaEdit.TextMate;
using TextMateSharp.Grammars;

/// <summary>
/// Provides syntax highlighting using TextMate grammars.
/// </summary>
public sealed class SyntaxHighlightingService : IDisposable
{
    private readonly RegistryOptions _registryOptions;
    private readonly Dictionary<string, string> _languageToScope;
    private readonly Dictionary<TextEditor, TextMate.Installation> _installations = new();
    private ThemeName _currentTheme;
    private bool _disposed;

    /// <summary>
    /// Initializes a new SyntaxHighlightingService with the specified theme.
    /// </summary>
    /// <param name="useDarkTheme">Whether to use dark theme (default: true).</param>
    public SyntaxHighlightingService(bool useDarkTheme = true)
    {
        _currentTheme = useDarkTheme ? ThemeName.DarkPlus : ThemeName.LightPlus;
        _registryOptions = new RegistryOptions(_currentTheme);
        _languageToScope = BuildLanguageScopeMap();
    }

    #region Properties

    /// <summary>
    /// Available themes for syntax highlighting.
    /// </summary>
    public static IReadOnlyList<ThemeName> AvailableThemes { get; } = new[]
    {
        ThemeName.DarkPlus,
        ThemeName.LightPlus,
        ThemeName.Monokai,
        ThemeName.SolarizedDark,
        ThemeName.SolarizedLight,
        ThemeName.HighContrastDark,
        ThemeName.HighContrastLight,
    };

    /// <summary>
    /// Currently active theme.
    /// </summary>
    public ThemeName CurrentTheme => _currentTheme;

    /// <summary>
    /// Gets the TextMate registry options.
    /// </summary>
    public RegistryOptions RegistryOptions => _registryOptions;

    /// <summary>
    /// Gets all supported languages.
    /// </summary>
    public IReadOnlyList<string> SupportedLanguages => _languageToScope.Keys.ToList();

    /// <summary>
    /// Number of editors currently registered.
    /// </summary>
    public int RegisteredEditorCount => _installations.Count;

    #endregion

    #region Core Methods

    /// <summary>
    /// Applies syntax highlighting to an editor for the specified language.
    /// </summary>
    /// <param name="editor">The TextEditor to apply highlighting to.</param>
    /// <param name="language">Language identifier (e.g., "csharp", "javascript").</param>
    /// <returns>The TextMate installation for further configuration.</returns>
    public TextMate.Installation ApplyHighlighting(TextEditor editor, string? language)
    {
        if (editor == null) throw new ArgumentNullException(nameof(editor));

        // Remove existing installation if any
        if (_installations.TryGetValue(editor, out var existing))
        {
            existing.Dispose();
            _installations.Remove(editor);
        }

        // Create new installation
        var installation = editor.InstallTextMate(_registryOptions);

        // Set grammar if language is specified
        if (!string.IsNullOrEmpty(language) && _languageToScope.TryGetValue(language, out var scope))
        {
            try
            {
                installation.SetGrammar(scope);
            }
            catch (Exception)
            {
                // Grammar not found, continue without highlighting
            }
        }

        _installations[editor] = installation;
        return installation;
    }

    /// <summary>
    /// Updates the grammar for an existing editor installation.
    /// </summary>
    /// <param name="editor">The TextEditor to update.</param>
    /// <param name="language">Language identifier (null to clear).</param>
    public void SetLanguage(TextEditor editor, string? language)
    {
        if (!_installations.TryGetValue(editor, out var installation)) return;

        if (string.IsNullOrEmpty(language))
        {
            installation.SetGrammar(null);
            return;
        }

        if (_languageToScope.TryGetValue(language, out var scope))
        {
            try
            {
                installation.SetGrammar(scope);
            }
            catch (Exception)
            {
                // Grammar not found
            }
        }
    }

    /// <summary>
    /// Changes the theme for all registered editors.
    /// </summary>
    /// <param name="theme">The new theme to apply.</param>
    public void ChangeTheme(ThemeName theme)
    {
        if (_currentTheme == theme) return;

        _currentTheme = theme;
        var newOptions = new RegistryOptions(theme);

        // Re-apply to all editors
        foreach (var (editor, installation) in _installations.ToArray())
        {
            // Remember current grammar (if tracking is implemented)
            var currentScope = TryGetCurrentScope(installation);

            installation.Dispose();
            _installations.Remove(editor);

            var newInstallation = editor.InstallTextMate(newOptions);
            if (!string.IsNullOrEmpty(currentScope))
            {
                try
                {
                    newInstallation.SetGrammar(currentScope);
                }
                catch { }
            }

            _installations[editor] = newInstallation;
        }
    }

    /// <summary>
    /// Removes syntax highlighting from an editor.
    /// </summary>
    /// <param name="editor">The TextEditor to remove highlighting from.</param>
    public void RemoveHighlighting(TextEditor editor)
    {
        if (_installations.TryGetValue(editor, out var installation))
        {
            installation.Dispose();
            _installations.Remove(editor);
        }
    }

    /// <summary>
    /// Gets the scope name for a language identifier.
    /// </summary>
    /// <param name="language">Language identifier.</param>
    /// <returns>TextMate scope name, or null if not found.</returns>
    public string? GetScopeForLanguage(string language)
    {
        return _languageToScope.TryGetValue(language, out var scope) ? scope : null;
    }

    /// <summary>
    /// Checks if a language is supported.
    /// </summary>
    public bool IsLanguageSupported(string language)
    {
        return _languageToScope.ContainsKey(language);
    }

    #endregion

    #region Language Scope Mapping

    private static Dictionary<string, string> BuildLanguageScopeMap()
    {
        return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            // .NET Languages
            ["csharp"] = "source.cs",
            ["fsharp"] = "source.fsharp",
            ["vb"] = "source.asp.vb.net",

            // Web Languages
            ["javascript"] = "source.js",
            ["javascriptreact"] = "source.js.jsx",
            ["typescript"] = "source.ts",
            ["typescriptreact"] = "source.tsx",
            ["html"] = "text.html.basic",
            ["css"] = "source.css",
            ["scss"] = "source.css.scss",
            ["less"] = "source.css.less",
            ["vue"] = "source.vue",

            // Systems Languages
            ["c"] = "source.c",
            ["cpp"] = "source.cpp",
            ["rust"] = "source.rust",
            ["go"] = "source.go",
            ["swift"] = "source.swift",
            ["objective-c"] = "source.objc",

            // Scripting Languages
            ["python"] = "source.python",
            ["ruby"] = "source.ruby",
            ["php"] = "source.php",
            ["perl"] = "source.perl",
            ["lua"] = "source.lua",
            ["r"] = "source.r",

            // JVM Languages
            ["java"] = "source.java",
            ["kotlin"] = "source.kotlin",
            ["scala"] = "source.scala",
            ["groovy"] = "source.groovy",

            // Shell/Scripts
            ["shellscript"] = "source.shell",
            ["bash"] = "source.shell",
            ["powershell"] = "source.powershell",
            ["bat"] = "source.batchfile",

            // Data/Config
            ["json"] = "source.json",
            ["jsonc"] = "source.json.comments",
            ["xml"] = "text.xml",
            ["yaml"] = "source.yaml",
            ["toml"] = "source.toml",
            ["ini"] = "source.ini",
            ["properties"] = "source.ini",

            // Markup
            ["markdown"] = "text.html.markdown",
            ["latex"] = "text.tex.latex",
            ["restructuredtext"] = "text.restructuredtext",

            // Database
            ["sql"] = "source.sql",

            // Build/Config
            ["dockerfile"] = "source.dockerfile",
            ["makefile"] = "source.makefile",
            ["cmake"] = "source.cmake",

            // Other
            ["diff"] = "source.diff",
            ["gitignore"] = "source.ignore",
        };
    }

    #endregion

    #region Helpers

    private static string? TryGetCurrentScope(TextMate.Installation installation)
    {
        // TextMate.Installation doesn't expose current scope directly
        // Would need to track separately if needed
        return null;
    }

    #endregion

    #region IDisposable

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;

        foreach (var installation in _installations.Values)
        {
            installation.Dispose();
        }
        _installations.Clear();
    }

    #endregion
}
```

---

## Language Support Reference

| Category | Languages | Count |
|----------|-----------|-------|
| **.NET** | C#, F#, VB.NET | 3 |
| **Web** | JavaScript, TypeScript, JSX, TSX, HTML, CSS, SCSS, Less, Vue | 9 |
| **Systems** | C, C++, Rust, Go, Swift, Objective-C | 6 |
| **Scripting** | Python, Ruby, PHP, Perl, Lua, R | 6 |
| **JVM** | Java, Kotlin, Scala, Groovy | 4 |
| **Shell** | Bash, PowerShell, Batch | 3 |
| **Data/Config** | JSON, JSONC, XML, YAML, TOML, INI | 6 |
| **Markup** | Markdown, LaTeX, reStructuredText | 3 |
| **Database** | SQL | 1 |
| **Build** | Dockerfile, Makefile, CMake | 3 |
| **Other** | Diff, .gitignore | 2 |
| **Total** | | **46** |

---

## Theme Reference

| Theme | Description | Use Case |
|-------|-------------|----------|
| DarkPlus | VS Code default dark | Default for dark mode |
| LightPlus | VS Code default light | Default for light mode |
| Monokai | Classic Monokai colors | High contrast |
| SolarizedDark | Solarized dark palette | Eye comfort |
| SolarizedLight | Solarized light palette | Eye comfort |
| HighContrastDark | Accessibility dark | Accessibility |
| HighContrastLight | Accessibility light | Accessibility |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| Constructor | 2 | Dark theme, light theme |
| ApplyHighlighting | 4 | Valid language, null language, existing editor, unknown language |
| SetLanguage | 3 | Change language, clear language, invalid editor |
| ChangeTheme | 3 | Same theme skip, theme switch, grammar preservation |
| RemoveHighlighting | 2 | Existing editor, non-existent |
| GetScopeForLanguage | 2 | Found, not found |
| IsLanguageSupported | 2 | Supported, not supported |
| SupportedLanguages | 1 | All languages returned |
| Dispose | 2 | Cleanup, multiple dispose |
| **Total** | **21** | |

---

## Files Summary

| File | Lines |
|------|-------|
| `Services/SyntaxHighlightingService.cs` | 240 |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | SyntaxHighlightingService initializes with TextMate registry |
| AC-2 | ApplyHighlighting applies C# highlighting correctly |
| AC-3 | ApplyHighlighting applies TypeScript highlighting correctly |
| AC-4 | SetLanguage changes grammar without reinstallation |
| AC-5 | ChangeTheme updates all registered editors |
| AC-6 | Unsupported languages degrade gracefully (no crash) |
| AC-7 | SupportedLanguages returns all 46 languages |
| AC-8 | Dispose cleans up all installations |
| AC-9 | Same theme skip optimization works |
| AC-10 | RemoveHighlighting properly disposes installation |

---

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| AvaloniaEdit | 11.1.0 | TextEditor control |
| TextMateSharp | 1.0.63 | TextMate engine |
| TextMateSharp.Grammars | 1.0.63 | Pre-bundled grammars |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.3c | 0.5 day |
