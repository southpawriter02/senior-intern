# Design Specification: The Senior Intern v0.3.4h "Message History Integration"

## Executive Summary

This document provides a detailed implementation specification for v0.3.4h, the final part of the Context Attachment feature. This part integrates attached contexts into the message history system - storing contexts with messages in the database, displaying them in past conversations, and enabling expand/collapse for viewing attached code in historical messages.

### v0.3.4h Scope

- Update `ChatMessage` model with `AttachedContexts` property
- Update `ChatMessageViewModel` with context display properties
- Update `ChatViewModel` with full context management
- Update message UI templates to display attached contexts
- Update database entities for context persistence
- Update repository for saving/loading contexts

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ChatMessage.AttachedContexts | Core model update |
| ChatMessageViewModel context properties | Display state management |
| ChatViewModel context management | Attach, remove, clear, preview |
| Message UI template | Collapsible context display |
| MessageEntity update | Database persistence |
| Repository update | Save/load contexts |

---

## Feature Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     v0.3.4h Feature Tree                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ChatMessage (Core Model)                                         â”‚
â”‚  â”œâ”€â”€ Id: Guid                                                    â”‚
â”‚  â”œâ”€â”€ Role: MessageRole                                           â”‚
â”‚  â”œâ”€â”€ Content: string                                             â”‚
â”‚  â”œâ”€â”€ Timestamp: DateTime                                         â”‚
â”‚  â”œâ”€â”€ AttachedContexts: IReadOnlyList<FileContext>  â† NEW        â”‚
â”‚  â””â”€â”€ HasAttachedContexts: bool (computed)          â† NEW        â”‚
â”‚                                                                   â”‚
â”‚  ChatMessageViewModel                                             â”‚
â”‚  â”œâ”€â”€ Existing properties...                                      â”‚
â”‚  â”œâ”€â”€ AttachedContexts: ObservableCollection      â† NEW          â”‚
â”‚  â”œâ”€â”€ IsContextExpanded: bool                     â† NEW          â”‚
â”‚  â”œâ”€â”€ HasAttachedContexts: bool                   â† NEW          â”‚
â”‚  â”œâ”€â”€ AttachedContextCount: int                   â† NEW          â”‚
â”‚  â”œâ”€â”€ TotalAttachedTokens: int                    â† NEW          â”‚
â”‚  â””â”€â”€ ToggleContextExpandedCommand                â† NEW          â”‚
â”‚                                                                   â”‚
â”‚  ChatViewModel Context Management                                 â”‚
â”‚  â”œâ”€â”€ Properties                                                  â”‚
â”‚  â”‚   â”œâ”€â”€ AttachedContexts: ObservableCollection                 â”‚
â”‚  â”‚   â”œâ”€â”€ SelectedPreviewContext: FileContextViewModel?          â”‚
â”‚  â”‚   â”œâ”€â”€ IsPreviewOpen: bool                                    â”‚
â”‚  â”‚   â”œâ”€â”€ TotalContextTokens: int                                â”‚
â”‚  â”‚   â”œâ”€â”€ MaxContextTokens: int (default 8000)                   â”‚
â”‚  â”‚   â”œâ”€â”€ HasAttachedContexts: bool                              â”‚
â”‚  â”‚   â”œâ”€â”€ HasMultipleContexts: bool                              â”‚
â”‚  â”‚   â”œâ”€â”€ IsNearTokenLimit: bool (>80%)                          â”‚
â”‚  â”‚   â”œâ”€â”€ IsOverTokenLimit: bool (>100%)                         â”‚
â”‚  â”‚   â””â”€â”€ CanSendMessage: bool                                   â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ Commands                                                    â”‚
â”‚  â”‚   â”œâ”€â”€ AttachFileAsync(string filePath)                       â”‚
â”‚  â”‚   â”œâ”€â”€ AttachSelection(SelectionInfo selection)               â”‚
â”‚  â”‚   â”œâ”€â”€ RemoveContext(FileContextViewModel context)            â”‚
â”‚  â”‚   â”œâ”€â”€ ClearAllContexts()                                     â”‚
â”‚  â”‚   â”œâ”€â”€ ShowPreview(FileContextViewModel context)              â”‚
â”‚  â”‚   â””â”€â”€ HidePreview()                                          â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€â”€ SendMessage Flow                                            â”‚
â”‚      â”œâ”€â”€ Build context-enhanced prompt                          â”‚
â”‚      â”œâ”€â”€ Create message with AttachedContexts                   â”‚
â”‚      â”œâ”€â”€ Clear AttachedContexts after send                      â”‚
â”‚      â””â”€â”€ Save conversation to database                          â”‚
â”‚                                                                   â”‚
â”‚  Message UI Template                                              â”‚
â”‚  â”œâ”€â”€ Context Summary (collapsed)                                â”‚
â”‚  â”‚   â”œâ”€â”€ Attachment icon                                        â”‚
â”‚  â”‚   â”œâ”€â”€ "{N} file(s) attached â€¢ ~{tokens} tokens"             â”‚
â”‚  â”‚   â””â”€â”€ Expand/Collapse button                                 â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€â”€ Expanded Context List                                      â”‚
â”‚      â””â”€â”€ For each context:                                      â”‚
â”‚          â”œâ”€â”€ DisplayLabel + Language                            â”‚
â”‚          â””â”€â”€ PreviewContent in code block                       â”‚
â”‚                                                                   â”‚
â”‚  Database Entities                                                â”‚
â”‚  â”œâ”€â”€ MessageEntity                                               â”‚
â”‚  â”‚   â””â”€â”€ AttachedContextsJson: string (JSON serialized)         â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€â”€ AttachedContextEntity (optional, for full relations)       â”‚
â”‚      â”œâ”€â”€ Id: Guid                                               â”‚
â”‚      â”œâ”€â”€ MessageId: Guid                                        â”‚
â”‚      â”œâ”€â”€ FilePath, FileName, Language                           â”‚
â”‚      â”œâ”€â”€ Content, EstimatedTokens, LineCount                    â”‚
â”‚      â””â”€â”€ StartLine, EndLine                                     â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture Diagrams

### Send Message with Context Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Send Message with Context                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  User types message + has attached contexts                      â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼ User clicks Send                                      â”‚
â”‚         â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ChatViewModel.SendMessageAsync()                           â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ // 1. Capture attached contexts                            â”‚  â”‚
â”‚  â”‚ var attachedContextsList = AttachedContexts.ToList();      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ // 2. Format contexts for LLM prompt                       â”‚  â”‚
â”‚  â”‚ var fileContexts = attachedContextsList                    â”‚  â”‚
â”‚  â”‚     .Select(c => c.ToFileContext()).ToList();              â”‚  â”‚
â”‚  â”‚ var contextPrompt = _contextFormatter.FormatForPrompt(...);â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ // 3. Build full prompt                                    â”‚  â”‚
â”‚  â”‚ var fullPrompt = contextPrompt + userInput;                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ // 4. Create user message WITH contexts                    â”‚  â”‚
â”‚  â”‚ var userMessage = new ChatMessage {                        â”‚  â”‚
â”‚  â”‚     Role = MessageRole.User,                               â”‚  â”‚
â”‚  â”‚     Content = userInput,  // Just the text, not context   â”‚  â”‚
â”‚  â”‚     AttachedContexts = fileContexts,                       â”‚  â”‚
â”‚  â”‚     Timestamp = DateTime.UtcNow                            â”‚  â”‚
â”‚  â”‚ };                                                          â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ Messages.Add(new ChatMessageViewModel(userMessage));       â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ // 5. Clear current contexts (they're now in message)      â”‚  â”‚
â”‚  â”‚ AttachedContexts.Clear();                                  â”‚  â”‚
â”‚  â”‚ UpdateTotalTokens();                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ // 6. Send to LLM with full prompt (includes context)     â”‚  â”‚
â”‚  â”‚ var response = await _llmService.SendAsync(fullPrompt);    â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ // 7. Save to database                                     â”‚  â”‚
â”‚  â”‚ await SaveConversationAsync();                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Message History Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Message History Display                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Conversation loaded from database                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Chat Messages View                        â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ USER MESSAGE (with contexts, collapsed)              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ ğŸ“ 2 file(s) attached â€¢ ~245 tokens  [Expand] â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Can you explain how this service works?              â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ USER MESSAGE (with contexts, expanded)               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ ğŸ“ 2 file(s) attached â€¢ ~245 tokens [Collapse]â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ UserService.cs (csharp)                        â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ public class UserService : IUserService  â”‚   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ {                                         â”‚   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”‚     public async Task<User> GetById...   â”‚   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ // ... (12 more lines)                   â”‚   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ Program.cs:15-22 (csharp)                      â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ services.AddScoped<IUserService>();      â”‚   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Can you explain how this service works?              â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database Schema Update                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Option A: JSON Serialization (Simpler)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MessageEntity                                              â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Id: Guid (PK)                                         â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ ConversationId: Guid (FK)                             â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Role: int                                             â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Content: string                                       â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Timestamp: DateTime                                   â”‚  â”‚
â”‚  â”‚ â””â”€â”€ AttachedContextsJson: string? â† NEW (JSON)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  JSON Example:                                                   â”‚
â”‚  [                                                               â”‚
â”‚    {                                                             â”‚
â”‚      "Id": "a1b2c3...",                                         â”‚
â”‚      "FilePath": "/path/to/file.cs",                            â”‚
â”‚      "FileName": "file.cs",                                     â”‚
â”‚      "Language": "csharp",                                      â”‚
â”‚      "Content": "public class...",                              â”‚
â”‚      "EstimatedTokens": 156,                                    â”‚
â”‚      "LineCount": 45,                                           â”‚
â”‚      "StartLine": null,                                         â”‚
â”‚      "EndLine": null                                            â”‚
â”‚    }                                                             â”‚
â”‚  ]                                                               â”‚
â”‚                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                  â”‚
â”‚  Option B: Separate Entity (Normalized)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AttachedContextEntity                                      â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Id: Guid (PK)                                         â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ MessageId: Guid (FK â†’ MessageEntity)                  â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ FilePath: string                                      â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ FileName: string                                      â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Language: string?                                     â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Content: string                                       â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ EstimatedTokens: int                                  â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ LineCount: int                                        â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ StartLine: int?                                       â”‚  â”‚
â”‚  â”‚ â””â”€â”€ EndLine: int?                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Recommended: Option A (JSON) for simplicity                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Directory Structure

```
src/SeniorIntern.Core/
â””â”€â”€ Models/
    â””â”€â”€ ChatMessage.cs                                (MODIFY)

src/SeniorIntern.Desktop/
â”œâ”€â”€ ViewModels/
â”‚   â”œâ”€â”€ ChatViewModel.cs                              (MODIFY)
â”‚   â””â”€â”€ ChatMessageViewModel.cs                       (MODIFY)
â””â”€â”€ Views/
    â””â”€â”€ ChatView.axaml                                (MODIFY)

src/SeniorIntern.Data/
â”œâ”€â”€ Entities/
â”‚   â””â”€â”€ MessageEntity.cs                              (MODIFY)
â””â”€â”€ Repositories/
    â””â”€â”€ ConversationRepository.cs                     (MODIFY)
```

---

## Implementation Details

### Task 1: Update ChatMessage Model

**File:** `src/SeniorIntern.Core/Models/ChatMessage.cs` (additions)

```csharp
public sealed class ChatMessage
{
    public Guid Id { get; init; } = Guid.NewGuid();
    public MessageRole Role { get; init; }
    public string Content { get; init; } = string.Empty;
    public DateTime Timestamp { get; init; } = DateTime.UtcNow;

    /// <summary>
    /// File contexts attached to this message.
    /// </summary>
    public IReadOnlyList<FileContext> AttachedContexts { get; init; } = Array.Empty<FileContext>();

    /// <summary>
    /// Whether this message has attached contexts.
    /// </summary>
    public bool HasAttachedContexts => AttachedContexts.Count > 0;
}
```

### Task 2: Update ChatMessageViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/ChatMessageViewModel.cs` (additions)

```csharp
public partial class ChatMessageViewModel : ViewModelBase
{
    // ... existing properties ...

    /// <summary>
    /// Contexts attached to this message.
    /// </summary>
    [ObservableProperty]
    private ObservableCollection<FileContextViewModel> _attachedContexts = new();

    /// <summary>
    /// Whether the context list is expanded.
    /// </summary>
    [ObservableProperty]
    private bool _isContextExpanded = false;

    /// <summary>
    /// Whether this message has attached contexts.
    /// </summary>
    public bool HasAttachedContexts => AttachedContexts.Count > 0;

    /// <summary>
    /// Number of attached contexts.
    /// </summary>
    public int AttachedContextCount => AttachedContexts.Count;

    /// <summary>
    /// Total tokens across all attached contexts.
    /// </summary>
    public int TotalAttachedTokens => AttachedContexts.Sum(c => c.EstimatedTokens);

    public ChatMessageViewModel(ChatMessage message)
    {
        Id = message.Id;
        Role = message.Role;
        Content = message.Content;
        Timestamp = message.Timestamp;

        // Convert attached contexts to ViewModels
        foreach (var ctx in message.AttachedContexts)
        {
            AttachedContexts.Add(new FileContextViewModel
            {
                Id = ctx.Id,
                FilePath = ctx.FilePath,
                FileName = ctx.FileName,
                Language = ctx.Language,
                Content = ctx.Content,
                EstimatedTokens = ctx.EstimatedTokens,
                LineCount = ctx.LineCount,
                StartLine = ctx.StartLine,
                EndLine = ctx.EndLine,
                AttachmentType = ctx.IsPartialContent
                    ? ContextAttachmentType.Selection
                    : ContextAttachmentType.File
            });
        }
    }

    /// <summary>
    /// Toggles the context expansion state.
    /// </summary>
    [RelayCommand]
    private void ToggleContextExpanded()
    {
        IsContextExpanded = !IsContextExpanded;
    }
}
```

### Task 3: Update ChatViewModel

**File:** `src/SeniorIntern.Desktop/ViewModels/ChatViewModel.cs` (additions)

```csharp
// Add these fields
private readonly ITokenEstimationService _tokenEstimationService;
private readonly IContextFormatter _contextFormatter;
private readonly IFileSystemService _fileSystemService;

// Add these properties
[ObservableProperty]
private ObservableCollection<FileContextViewModel> _attachedContexts = new();

[ObservableProperty]
private FileContextViewModel? _selectedPreviewContext;

[ObservableProperty]
private bool _isPreviewOpen;

[ObservableProperty]
private int _totalContextTokens;

[ObservableProperty]
private int _maxContextTokens = 8000;

public bool HasAttachedContexts => AttachedContexts.Count > 0;
public bool HasMultipleContexts => AttachedContexts.Count > 1;
public bool IsNearTokenLimit => TotalContextTokens > MaxContextTokens * 0.8;
public bool IsOverTokenLimit => TotalContextTokens > MaxContextTokens;
public bool CanSendMessage => !string.IsNullOrWhiteSpace(UserInput) && !IsOverTokenLimit;

// Property change handler
partial void OnAttachedContextsChanged(ObservableCollection<FileContextViewModel> value)
{
    UpdateTotalTokens();
    OnPropertyChanged(nameof(HasAttachedContexts));
    OnPropertyChanged(nameof(HasMultipleContexts));
    OnPropertyChanged(nameof(CanSendMessage));
}

private void UpdateTotalTokens()
{
    TotalContextTokens = AttachedContexts.Sum(c => c.EstimatedTokens);
    OnPropertyChanged(nameof(IsNearTokenLimit));
    OnPropertyChanged(nameof(IsOverTokenLimit));
    OnPropertyChanged(nameof(CanSendMessage));
}

// Commands
[RelayCommand]
public async Task AttachFileAsync(string filePath)
{
    if (!await _fileSystemService.FileExistsAsync(filePath)) return;

    var fileSize = _fileSystemService.GetFileSize(filePath);
    if (fileSize > _settings.ContextLimits.MaxFileSizeBytes) return;

    if (AttachedContexts.Any(c => c.FilePath == filePath)) return;

    var content = await _fileSystemService.ReadFileAsync(filePath);
    var tokens = _tokenEstimationService.EstimateTokens(content);

    if (tokens > _settings.ContextLimits.MaxTokensPerFile)
    {
        content = _tokenEstimationService.TruncateToTokenLimit(
            content, _settings.ContextLimits.MaxTokensPerFile);
        tokens = _settings.ContextLimits.MaxTokensPerFile;
    }

    if (TotalContextTokens + tokens > MaxContextTokens) return;

    var context = FileContextViewModel.FromFile(filePath, content, tokens);
    AttachedContexts.Add(context);
    UpdateTotalTokens();
}

[RelayCommand]
public void AttachSelection(SelectionInfo selection)
{
    var tokens = _tokenEstimationService.EstimateTokens(selection.Content);
    if (TotalContextTokens + tokens > MaxContextTokens) return;

    var context = selection.IsFullFile
        ? FileContextViewModel.FromFile(selection.FilePath, selection.Content, tokens)
        : FileContextViewModel.FromSelection(
            selection.FilePath, selection.Content,
            selection.StartLine, selection.EndLine, tokens);

    AttachedContexts.Add(context);
    UpdateTotalTokens();
}

[RelayCommand]
public void RemoveContext(FileContextViewModel context)
{
    AttachedContexts.Remove(context);
    UpdateTotalTokens();
    if (SelectedPreviewContext == context) HidePreview();
}

[RelayCommand]
public void ClearAllContexts()
{
    AttachedContexts.Clear();
    UpdateTotalTokens();
    HidePreview();
}

[RelayCommand]
public void ShowPreview(FileContextViewModel context)
{
    SelectedPreviewContext = context;
    IsPreviewOpen = true;
}

[RelayCommand]
public void HidePreview()
{
    IsPreviewOpen = false;
    SelectedPreviewContext = null;
}

// Updated SendMessage
[RelayCommand]
private async Task SendMessageAsync()
{
    if (!CanSendMessage) return;

    var userInput = UserInput.Trim();
    UserInput = string.Empty;

    // Build context-enhanced prompt
    var contextPrompt = string.Empty;
    var attachedContextsList = AttachedContexts.ToList();

    if (attachedContextsList.Count > 0)
    {
        var fileContexts = attachedContextsList.Select(c => c.ToFileContext()).ToList();
        contextPrompt = _contextFormatter.FormatForPrompt(fileContexts);
    }

    var fullPrompt = string.IsNullOrEmpty(contextPrompt)
        ? userInput
        : contextPrompt + userInput;

    // Create message with attached contexts
    var userMessage = new ChatMessage
    {
        Role = MessageRole.User,
        Content = userInput,
        AttachedContexts = attachedContextsList.Select(c => c.ToFileContext()).ToList(),
        Timestamp = DateTime.UtcNow
    };

    Messages.Add(new ChatMessageViewModel(userMessage));

    // Clear contexts after sending
    AttachedContexts.Clear();
    UpdateTotalTokens();

    // Send to LLM
    IsGenerating = true;
    try
    {
        var response = await _llmService.SendAsync(fullPrompt, CurrentConversation);
        var assistantMessage = new ChatMessage
        {
            Role = MessageRole.Assistant,
            Content = response,
            Timestamp = DateTime.UtcNow
        };
        Messages.Add(new ChatMessageViewModel(assistantMessage));
        await SaveConversationAsync();
    }
    finally
    {
        IsGenerating = false;
    }
}
```

### Task 4: Update Message UI Template

**File:** `src/SeniorIntern.Desktop/Views/ChatView.axaml` (additions)

```xml
<DataTemplate x:Key="UserMessageTemplate" x:DataType="vm:ChatMessageViewModel">
    <Border Classes="message user-message" Margin="0,8">
        <StackPanel Spacing="8">
            <!-- Attached Context Summary (collapsed) -->
            <Border Background="{DynamicResource ContextSummaryBackgroundBrush}"
                    CornerRadius="4"
                    Padding="8"
                    IsVisible="{Binding HasAttachedContexts}">
                <Grid ColumnDefinitions="Auto, *, Auto">
                    <PathIcon Grid.Column="0"
                              Data="{StaticResource AttachmentIcon}"
                              Width="12" Height="12"
                              Margin="0,0,6,0"
                              Foreground="{DynamicResource TextMutedBrush}" />

                    <TextBlock Grid.Column="1" FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}">
                        <Run Text="{Binding AttachedContextCount}" />
                        <Run Text="file(s) attached â€¢" />
                        <Run Text="~" />
                        <Run Text="{Binding TotalAttachedTokens}" />
                        <Run Text="tokens" />
                    </TextBlock>

                    <Button Grid.Column="2"
                            Classes="link-button"
                            Command="{Binding ToggleContextExpandedCommand}"
                            FontSize="11">
                        <Button.Content>
                            <TextBlock>
                                <TextBlock.Text>
                                    <Binding Path="IsContextExpanded">
                                        <Binding.Converter>
                                            <conv:BoolToStringConverter TrueValue="Collapse" FalseValue="Expand" />
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Text>
                            </TextBlock>
                        </Button.Content>
                    </Button>
                </Grid>
            </Border>

            <!-- Expanded Context List -->
            <ItemsControl ItemsSource="{Binding AttachedContexts}"
                          IsVisible="{Binding IsContextExpanded}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:FileContextViewModel">
                        <Border Background="{DynamicResource ContextBlockBackgroundBrush}"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,4">
                            <StackPanel Spacing="4">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="{Binding DisplayLabel}"
                                               FontWeight="SemiBold"
                                               FontSize="12" />
                                    <TextBlock Text="{Binding Language}"
                                               FontSize="11"
                                               Foreground="{DynamicResource TextMutedBrush}" />
                                </StackPanel>
                                <Border Background="{DynamicResource CodeBlockBackgroundBrush}"
                                        CornerRadius="4"
                                        Padding="8">
                                    <TextBlock Text="{Binding PreviewContent}"
                                               FontFamily="Cascadia Code, Consolas"
                                               FontSize="11"
                                               TextWrapping="NoWrap" />
                                </Border>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Message Content -->
            <TextBlock Text="{Binding Content}" TextWrapping="Wrap" />
        </StackPanel>
    </Border>
</DataTemplate>
```

### Task 5: Update MessageEntity

**File:** `src/SeniorIntern.Data/Entities/MessageEntity.cs` (additions)

```csharp
public class MessageEntity
{
    public Guid Id { get; set; }
    public Guid ConversationId { get; set; }
    public int Role { get; set; }
    public string Content { get; set; } = string.Empty;
    public DateTime Timestamp { get; set; }

    /// <summary>
    /// JSON-serialized attached contexts.
    /// </summary>
    public string? AttachedContextsJson { get; set; }

    // Navigation
    public ConversationEntity? Conversation { get; set; }
}
```

### Task 6: Update Repository

**File:** `src/SeniorIntern.Data/Repositories/ConversationRepository.cs` (additions)

```csharp
// In SaveMessageAsync:
private async Task SaveMessageAsync(ChatMessage message, Guid conversationId)
{
    var entity = new MessageEntity
    {
        Id = message.Id,
        ConversationId = conversationId,
        Role = (int)message.Role,
        Content = message.Content,
        Timestamp = message.Timestamp,
        AttachedContextsJson = message.HasAttachedContexts
            ? JsonSerializer.Serialize(message.AttachedContexts)
            : null
    };

    await _context.Messages.AddAsync(entity);
    await _context.SaveChangesAsync();
}

// In LoadMessagesAsync:
private ChatMessage MapToMessage(MessageEntity entity)
{
    var contexts = string.IsNullOrEmpty(entity.AttachedContextsJson)
        ? Array.Empty<FileContext>()
        : JsonSerializer.Deserialize<FileContext[]>(entity.AttachedContextsJson)
            ?? Array.Empty<FileContext>();

    return new ChatMessage
    {
        Id = entity.Id,
        Role = (MessageRole)entity.Role,
        Content = entity.Content,
        Timestamp = entity.Timestamp,
        AttachedContexts = contexts
    };
}
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| ChatMessage.AttachedContexts | 2 | Empty, with contexts |
| ChatMessageViewModel | 4 | Construction, toggle, counts |
| ChatViewModel.AttachFileAsync | 4 | Valid, too large, duplicate, over limit |
| ChatViewModel.AttachSelection | 2 | Full file, selection |
| ChatViewModel.RemoveContext | 2 | Remove, clear preview |
| ChatViewModel.ClearAllContexts | 1 | Clears all |
| ChatViewModel.SendMessageAsync | 3 | With context, without, clears after |
| MessageEntity serialization | 2 | Save, load |
| Repository save/load | 3 | With contexts, without, empty |
| **Total** | **23** | |

---

## Files Summary

### Files to Create (0)

None - modifications only.

### Files to Modify (6)

| File | Changes |
|------|---------|
| `Core/Models/ChatMessage.cs` | Add AttachedContexts property |
| `Desktop/ViewModels/ChatViewModel.cs` | Add full context management |
| `Desktop/ViewModels/ChatMessageViewModel.cs` | Add context display |
| `Desktop/Views/ChatView.axaml` | Update message templates |
| `Data/Entities/MessageEntity.cs` | Add AttachedContextsJson |
| `Data/Repositories/ConversationRepository.cs` | Save/load contexts |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Attached contexts included in message sent to LLM |
| AC-2 | Contexts cleared from input area after sending |
| AC-3 | Past messages show context summary with file count |
| AC-4 | Expand button reveals attached context details |
| AC-5 | Collapse button hides context details |
| AC-6 | Contexts persisted to database with message |
| AC-7 | Contexts restored when loading conversation |
| AC-8 | Token count displayed correctly in summary |
| AC-9 | Preview content shows truncated code |
| AC-10 | Messages without contexts display normally |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.4a | ITokenEstimationService for token counting |
| v0.3.4b | IContextFormatter for prompt building |
| v0.3.4c | FileContextViewModel for display |
| v0.3.4d | ChatContextBar for input area display |
| v0.2.1 | Database infrastructure |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.4h | 1 day |
