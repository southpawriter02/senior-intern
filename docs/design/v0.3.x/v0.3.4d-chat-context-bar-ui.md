# Design Specification: The Senior Intern v0.3.4d "Chat Context Bar UI"

## Executive Summary

This document provides a detailed implementation specification for v0.3.4d, which implements the `ChatContextBar` - a visual component that displays attached contexts as interactive pills above the chat input area. It shows token counts, warning/error states for token limits, and provides management actions like remove and clear all.

### v0.3.4d Scope

- Create `ChatContextBar.axaml` with context pill layout
- Create `ChatContextBar.axaml.cs` with pointer event handling
- Create `TokenCountConverter` for token display formatting
- Define context pill styles (background, hover, selection accent)
- Implement token count header with limit display
- Implement warning/error messages for token limits
- Add theme resources for context bar styling

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ChatContextBar.axaml | Main context bar UI |
| ChatContextBar.axaml.cs | Pointer event handlers |
| TokenCountConverter | Token number formatting |
| Context pill styles | Hover, selection, badges |
| Token limit warnings | Near limit, over limit |
| Theme resources | Colors for context bar |

---

## Feature Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     v0.3.4d Feature Tree                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ChatContextBar.axaml                                             â”‚
â”‚  â”œâ”€â”€ Visibility                                                  â”‚
â”‚  â”‚   â””â”€â”€ IsVisible="{Binding HasAttachedContexts}"              â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ Header Row                                                  â”‚
â”‚  â”‚   â”œâ”€â”€ Attachment icon + "Attached Context" label             â”‚
â”‚  â”‚   â”œâ”€â”€ Token count: "~1,650 / 8,000 tokens"                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ .token-warning class when near limit               â”‚
â”‚  â”‚   â”‚   â””â”€â”€ .token-danger class when over limit                â”‚
â”‚  â”‚   â””â”€â”€ Clear All button (visible if > 1 context)              â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ Context Pills (ItemsControl + WrapPanel)                    â”‚
â”‚  â”‚   â””â”€â”€ Per-pill template:                                     â”‚
â”‚  â”‚       â”œâ”€â”€ Border.context-pill                                â”‚
â”‚  â”‚       â”‚   â””â”€â”€ .selection class for selections               â”‚
â”‚  â”‚       â”œâ”€â”€ Language badge (e.g., "C#", "JS", "SEL")           â”‚
â”‚  â”‚       â”œâ”€â”€ Short label (filename or filename:lines)           â”‚
â”‚  â”‚       â”œâ”€â”€ Token count (~156)                                 â”‚
â”‚  â”‚       â””â”€â”€ Close button (X)                                   â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€â”€ Warning Messages                                            â”‚
â”‚      â”œâ”€â”€ Near limit warning (80-100%)                           â”‚
â”‚      â”‚   â””â”€â”€ "Approaching context limit..."                     â”‚
â”‚      â””â”€â”€ Over limit error (>100%)                               â”‚
â”‚          â””â”€â”€ "Context limit exceeded..."                        â”‚
â”‚                                                                   â”‚
â”‚  ChatContextBar.axaml.cs                                          â”‚
â”‚  â”œâ”€â”€ OnContextPillPressed(sender, e)                             â”‚
â”‚  â”‚   â”œâ”€â”€ Left click â†’ ShowPreviewCommand                        â”‚
â”‚  â”‚   â””â”€â”€ Middle click â†’ RemoveContextCommand                    â”‚
â”‚  â”œâ”€â”€ OnContextPillEntered(sender, e)                             â”‚
â”‚  â”‚   â””â”€â”€ context.IsHovered = true                               â”‚
â”‚  â””â”€â”€ OnContextPillExited(sender, e)                              â”‚
â”‚      â””â”€â”€ context.IsHovered = false                              â”‚
â”‚                                                                   â”‚
â”‚  TokenCountConverter                                              â”‚
â”‚  â””â”€â”€ Convert(value) â†’ formatted string with commas              â”‚
â”‚                                                                   â”‚
â”‚  Theme Resources                                                  â”‚
â”‚  â”œâ”€â”€ ContextBarBackgroundBrush (#1E1E1E)                        â”‚
â”‚  â”œâ”€â”€ ContextPillBackgroundBrush (#2D2D2D)                       â”‚
â”‚  â”œâ”€â”€ ContextPillBorderBrush (#3E3E3E)                           â”‚
â”‚  â”œâ”€â”€ ContextPillHoverBrush (#383838)                            â”‚
â”‚  â”œâ”€â”€ SelectionAccentBrush (#569CD6)                             â”‚
â”‚  â”œâ”€â”€ BadgeBackgroundBrush (#3E3E3E)                             â”‚
â”‚  â”œâ”€â”€ WarningBrush (#DDB700)                                     â”‚
â”‚  â””â”€â”€ ErrorBrush (#F14C4C)                                       â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture Diagrams

### Context Bar Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Context Bar Layout                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     ChatContextBar                          â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“ Attached Context              ~1,650 / 8,000 tokens â”‚  â”‚
â”‚  â”‚  â”‚                                           [Clear All] â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Context Pills (WrapPanel):                           â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ C# â”‚ UserService.cs ~156 âœ• â”‚ â”‚ JS â”‚ app.tsx:10-25 ~45 âœ• â”‚  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ PY â”‚ utils.py ~200 âœ• â”‚                              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ âš  Approaching context limit. Consider removing...   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Context Pill Anatomy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Context Pill Anatomy                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                                          â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”            â”‚     â”‚
â”‚  â”‚  â”‚ C# â”‚ â”‚ UserService.cs    â”‚ â”‚ ~156 â”‚ â”‚ âœ• â”‚            â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”˜            â”‚     â”‚
â”‚  â”‚    â”‚           â”‚                  â”‚        â”‚            â”‚     â”‚
â”‚  â”‚    â”‚           â”‚                  â”‚        â””â”€ Close     â”‚     â”‚
â”‚  â”‚    â”‚           â”‚                  â””â”€ Token count        â”‚     â”‚
â”‚  â”‚    â”‚           â””â”€ ShortLabel                            â”‚     â”‚
â”‚  â”‚    â””â”€ Badge (language or type)                          â”‚     â”‚
â”‚  â”‚                                                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  States:                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Normal:     Background: #2D2D2D, Border: #3E3E3E        â”‚     â”‚
â”‚  â”‚ Hover:      Background: #383838                          â”‚     â”‚
â”‚  â”‚ Selection:  Border: #569CD6 (blue accent)               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Limit States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Token Limit States                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  NORMAL (< 80%)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚  ~1,650 / 8,000 tokens                                           â”‚
â”‚      â”‚                                                           â”‚
â”‚      â””â”€ Default text color                                      â”‚
â”‚                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                  â”‚
â”‚  WARNING (80-100%)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  ~7,200 / 8,000 tokens  â† Yellow warning color                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âš  Approaching context limit. Consider removing some files.â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚      â””â”€ Yellow background (#332D00)                             â”‚
â”‚                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                  â”‚
â”‚  ERROR (> 100%)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  ~9,500 / 8,000 tokens  â† Red error color                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â›” Context limit exceeded. Remove some files to send.      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚      â””â”€ Red background (#331111)                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ ChatContextBar.axaml                          (NEW)
â”‚   â””â”€â”€ ChatContextBar.axaml.cs                       (NEW)
â”œâ”€â”€ Converters/
â”‚   â””â”€â”€ TokenCountConverter.cs                        (NEW)
â”œâ”€â”€ Themes/
â”‚   â””â”€â”€ Dark.axaml                                    (MODIFY)
â””â”€â”€ Assets/
    â””â”€â”€ Icons.axaml                                   (MODIFY)
```

---

## Implementation Details

### Task 1: Create ChatContextBar.axaml

**File:** `src/SeniorIntern.Desktop/Views/ChatContextBar.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             xmlns:conv="using:SeniorIntern.Desktop.Converters"
             x:Class="SeniorIntern.Desktop.Views.ChatContextBar"
             x:DataType="vm:ChatViewModel">

    <UserControl.Resources>
        <conv:TokenCountConverter x:Key="TokenCountConverter" />
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Context Pill Style -->
        <Style Selector="Border.context-pill">
            <Setter Property="Background" Value="{DynamicResource ContextPillBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource ContextPillBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="8,4,4,4" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <Style Selector="Border.context-pill:pointerover">
            <Setter Property="Background" Value="{DynamicResource ContextPillHoverBrush}" />
        </Style>

        <Style Selector="Border.context-pill.selection">
            <Setter Property="BorderBrush" Value="{DynamicResource SelectionAccentBrush}" />
        </Style>

        <!-- Close Button Style -->
        <Style Selector="Button.pill-close">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="4" />
            <Setter Property="CornerRadius" Value="10" />
            <Setter Property="Width" Value="20" />
            <Setter Property="Height" Value="20" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>

        <Style Selector="Button.pill-close:pointerover">
            <Setter Property="Background" Value="{DynamicResource CloseButtonHoverBrush}" />
            <Setter Property="Opacity" Value="1" />
        </Style>

        <!-- Token Warning/Danger Styles -->
        <Style Selector="TextBlock.token-warning">
            <Setter Property="Foreground" Value="{DynamicResource WarningBrush}" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <Style Selector="TextBlock.token-danger">
            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
            <Setter Property="FontWeight" Value="Bold" />
        </Style>
    </UserControl.Styles>

    <!-- Main Container - Only visible when contexts attached -->
    <Border Background="{DynamicResource ContextBarBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="0,0,0,1"
            Padding="12,8"
            IsVisible="{Binding HasAttachedContexts}">

        <Grid RowDefinitions="Auto, Auto, Auto">
            <!-- Header Row -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto, Auto" Margin="0,0,0,8">
                <!-- Icon and Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="6">
                    <PathIcon Data="{StaticResource AttachmentIcon}"
                              Width="14" Height="14"
                              Foreground="{DynamicResource TextSecondaryBrush}" />
                    <TextBlock Text="Attached Context"
                               FontWeight="SemiBold"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                </StackPanel>

                <!-- Token Count -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" Margin="0,0,12,0">
                    <TextBlock Text="~"
                               FontSize="11"
                               Foreground="{DynamicResource TextMutedBrush}" />
                    <TextBlock Text="{Binding TotalContextTokens, Converter={StaticResource TokenCountConverter}}"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Classes.token-warning="{Binding IsNearTokenLimit}"
                               Classes.token-danger="{Binding IsOverTokenLimit}" />
                    <TextBlock Text="/"
                               FontSize="11"
                               Foreground="{DynamicResource TextMutedBrush}" />
                    <TextBlock Text="{Binding MaxContextTokens, Converter={StaticResource TokenCountConverter}}"
                               FontSize="11"
                               Foreground="{DynamicResource TextMutedBrush}" />
                    <TextBlock Text="tokens"
                               FontSize="11"
                               Foreground="{DynamicResource TextMutedBrush}" />
                </StackPanel>

                <!-- Clear All Button -->
                <Button Grid.Column="3"
                        Content="Clear All"
                        Classes="link-button"
                        FontSize="11"
                        Command="{Binding ClearAllContextsCommand}"
                        IsVisible="{Binding HasMultipleContexts}" />
            </Grid>

            <!-- Context Pills -->
            <ItemsControl Grid.Row="1" ItemsSource="{Binding AttachedContexts}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:FileContextViewModel">
                        <Border Classes="context-pill"
                                Classes.selection="{Binding IsPartialContent}"
                                Margin="0,0,6,6"
                                ToolTip.Tip="{Binding Tooltip}"
                                PointerPressed="OnContextPillPressed"
                                PointerEntered="OnContextPillEntered"
                                PointerExited="OnContextPillExited">

                            <Grid ColumnDefinitions="Auto, Auto, Auto, Auto">
                                <!-- Language Badge -->
                                <Border Grid.Column="0"
                                        Background="{DynamicResource BadgeBackgroundBrush}"
                                        CornerRadius="4"
                                        Padding="4,2"
                                        Margin="0,0,6,0"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Badge}"
                                               FontSize="9"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource BadgeForegroundBrush}" />
                                </Border>

                                <!-- File Name -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding ShortLabel}"
                                           FontSize="12"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource TextPrimaryBrush}" />

                                <!-- Token Count -->
                                <TextBlock Grid.Column="2"
                                           Text="{Binding EstimatedTokens, StringFormat='~{0}'}"
                                           FontSize="10"
                                           Margin="6,0"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource TextMutedBrush}" />

                                <!-- Close Button -->
                                <Button Grid.Column="3"
                                        Classes="pill-close"
                                        Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).RemoveContextCommand}"
                                        CommandParameter="{Binding}"
                                        VerticalAlignment="Center">
                                    <PathIcon Data="{StaticResource CloseIcon}"
                                              Width="8" Height="8" />
                                </Button>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Warning Messages -->
            <StackPanel Grid.Row="2" Margin="0,4,0,0">
                <!-- Near limit warning -->
                <Border Background="{DynamicResource WarningBackgroundBrush}"
                        CornerRadius="4"
                        Padding="8,4"
                        IsVisible="{Binding IsNearTokenLimit}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <PathIcon Data="{StaticResource WarningIcon}"
                                  Width="12" Height="12"
                                  Foreground="{DynamicResource WarningBrush}" />
                        <TextBlock Text="Approaching context limit. Consider removing some files."
                                   FontSize="11"
                                   Foreground="{DynamicResource WarningBrush}" />
                    </StackPanel>
                </Border>

                <!-- Over limit error -->
                <Border Background="{DynamicResource ErrorBackgroundBrush}"
                        CornerRadius="4"
                        Padding="8,4"
                        IsVisible="{Binding IsOverTokenLimit}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <PathIcon Data="{StaticResource ErrorIcon}"
                                  Width="12" Height="12"
                                  Foreground="{DynamicResource ErrorBrush}" />
                        <TextBlock Text="Context limit exceeded. Remove some files to send message."
                                   FontSize="11"
                                   Foreground="{DynamicResource ErrorBrush}" />
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
```

### Task 2: Create ChatContextBar.axaml.cs

**File:** `src/SeniorIntern.Desktop/Views/ChatContextBar.axaml.cs`

```csharp
namespace SeniorIntern.Desktop.Views;

using Avalonia.Controls;
using Avalonia.Input;
using SeniorIntern.Desktop.ViewModels;

public partial class ChatContextBar : UserControl
{
    public ChatContextBar()
    {
        InitializeComponent();
    }

    private void OnContextPillPressed(object? sender, PointerPressedEventArgs e)
    {
        if (sender is not Border border) return;
        if (border.DataContext is not FileContextViewModel context) return;

        var viewModel = DataContext as ChatViewModel;
        if (viewModel == null) return;

        var point = e.GetCurrentPoint(border);

        // Left click: show preview
        if (point.Properties.IsLeftButtonPressed)
        {
            viewModel.ShowPreviewCommand.Execute(context);
        }
        // Middle click: remove
        else if (point.Properties.IsMiddleButtonPressed)
        {
            viewModel.RemoveContextCommand.Execute(context);
        }
    }

    private void OnContextPillEntered(object? sender, PointerEventArgs e)
    {
        if (sender is Border border && border.DataContext is FileContextViewModel context)
        {
            context.IsHovered = true;
        }
    }

    private void OnContextPillExited(object? sender, PointerEventArgs e)
    {
        if (sender is Border border && border.DataContext is FileContextViewModel context)
        {
            context.IsHovered = false;
        }
    }
}
```

### Task 3: Create TokenCountConverter

**File:** `src/SeniorIntern.Desktop/Converters/TokenCountConverter.cs`

```csharp
namespace SeniorIntern.Desktop.Converters;

using System;
using System.Globalization;
using Avalonia.Data.Converters;

/// <summary>
/// Converts token count integers to formatted strings with thousands separators.
/// </summary>
public class TokenCountConverter : IValueConverter
{
    public static TokenCountConverter Instance { get; } = new();

    public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is int count)
        {
            return count.ToString("N0", culture); // e.g., 1,650
        }

        if (value is long longCount)
        {
            return longCount.ToString("N0", culture);
        }

        return value?.ToString() ?? "0";
    }

    public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
    {
        if (value is string str && int.TryParse(str.Replace(",", ""), out var result))
        {
            return result;
        }
        return 0;
    }
}
```

### Task 4: Add Theme Resources

**File:** `src/SeniorIntern.Desktop/Themes/Dark.axaml` (additions)

```xml
<!-- Context Bar Colors -->
<SolidColorBrush x:Key="ContextBarBackgroundBrush" Color="#1E1E1E" />
<SolidColorBrush x:Key="ContextPillBackgroundBrush" Color="#2D2D2D" />
<SolidColorBrush x:Key="ContextPillBorderBrush" Color="#3E3E3E" />
<SolidColorBrush x:Key="ContextPillHoverBrush" Color="#383838" />
<SolidColorBrush x:Key="SelectionAccentBrush" Color="#569CD6" />
<SolidColorBrush x:Key="CloseButtonHoverBrush" Color="#4E4E4E" />

<!-- Badge Colors -->
<SolidColorBrush x:Key="BadgeBackgroundBrush" Color="#3E3E3E" />
<SolidColorBrush x:Key="BadgeForegroundBrush" Color="#CCCCCC" />

<!-- Warning/Error Colors -->
<SolidColorBrush x:Key="WarningBrush" Color="#DDB700" />
<SolidColorBrush x:Key="WarningBackgroundBrush" Color="#332D00" />
<SolidColorBrush x:Key="ErrorBrush" Color="#F14C4C" />
<SolidColorBrush x:Key="ErrorBackgroundBrush" Color="#331111" />
```

---

## ChatViewModel Bindings Required

The context bar binds to these properties on `ChatViewModel`:

| Property | Type | Description |
|----------|------|-------------|
| HasAttachedContexts | bool | True if any contexts attached |
| HasMultipleContexts | bool | True if > 1 context (for Clear All) |
| AttachedContexts | ObservableCollection\<FileContextViewModel\> | Collection of contexts |
| TotalContextTokens | int | Sum of all EstimatedTokens |
| MaxContextTokens | int | Maximum allowed tokens (8000) |
| IsNearTokenLimit | bool | True if 80-100% of limit |
| IsOverTokenLimit | bool | True if > 100% of limit |
| RemoveContextCommand | ICommand | Remove single context |
| ClearAllContextsCommand | ICommand | Remove all contexts |
| ShowPreviewCommand | ICommand | Show context preview |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| TokenCountConverter | 3 | Int, long, format |
| OnContextPillPressed | 2 | Left click, middle click |
| OnContextPillEntered | 1 | Sets IsHovered |
| OnContextPillExited | 1 | Clears IsHovered |
| Context pill styles | 3 | Normal, hover, selection |
| Token display | 3 | Normal, warning, danger |
| Warning visibility | 2 | Near limit, over limit |
| Clear All visibility | 2 | Single, multiple contexts |
| **Total** | **17** | |

---

## Files Summary

### Files to Create (3)

| File | Lines |
|------|-------|
| `Views/ChatContextBar.axaml` | 150 |
| `Views/ChatContextBar.axaml.cs` | 50 |
| `Converters/TokenCountConverter.cs` | 35 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `Themes/Dark.axaml` | Add context bar color resources |
| `Assets/Icons.axaml` | Add AttachmentIcon, WarningIcon |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Context bar only visible when contexts attached |
| AC-2 | Context pills display for each attached context |
| AC-3 | Language badge shows correct abbreviation |
| AC-4 | Token count displays per-pill and total with formatting |
| AC-5 | Close button removes individual context |
| AC-6 | Clear All button removes all contexts |
| AC-7 | Clear All only visible when multiple contexts |
| AC-8 | Warning shows when near token limit (80-100%) |
| AC-9 | Error shows when over token limit (>100%) |
| AC-10 | Clicking pill triggers ShowPreviewCommand |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.4c | FileContextViewModel for pill data |
| ChatViewModel | Properties and commands for binding |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.4d | 0.5 day |
