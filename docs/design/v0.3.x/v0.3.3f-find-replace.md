# Design Specification: The Senior Intern v0.3.3f "Find & Replace"

## Executive Summary

This document provides a detailed implementation specification for v0.3.3f, which integrates AvaloniaEdit's built-in `SearchPanel` for find and replace functionality. This includes a centralized `EditorSearchManager` for managing search panels across editors, selection-based search initialization, and comprehensive keyboard shortcuts.

### v0.3.3f Scope

- Create `EditorSearchManager` static utility class
- Integrate AvaloniaEdit's `SearchPanel` for find/replace
- Implement selection-based search text initialization
- Wire up search keyboard shortcuts (F3, Shift+F3)
- Support match case, whole word, and regex options
- Handle search panel lifecycle (install, open, close, uninstall)

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| EditorSearchManager | Static manager for search panels |
| OpenFind | Open search panel in find mode |
| OpenReplace | Open search panel in replace mode |
| FindNext/FindPrevious | Navigate between matches |
| Selection auto-fill | Use selected text as search pattern |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.3.3f Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  EditorSearchManager (static class)                               │
│  ├── State                                                       │
│  │   └── _searchPanels: Dictionary<TextEditor, SearchPanel>     │
│  │                                                                │
│  ├── Core Methods                                                │
│  │   ├── OpenFind(editor) → SearchPanel                         │
│  │   │   ├── Get or create SearchPanel                          │
│  │   │   ├── panel.Open()                                       │
│  │   │   └── Auto-fill with selected text                       │
│  │   │                                                           │
│  │   ├── OpenReplace(editor) → SearchPanel                      │
│  │   │   ├── Call OpenFind()                                    │
│  │   │   └── panel.IsReplaceMode = true                         │
│  │   │                                                           │
│  │   ├── FindNext(editor)                                       │
│  │   │   └── panel.FindNext()                                   │
│  │   │                                                           │
│  │   ├── FindPrevious(editor)                                   │
│  │   │   └── panel.FindPrevious()                               │
│  │   │                                                           │
│  │   ├── Close(editor)                                          │
│  │   │   └── panel.Close()                                      │
│  │   │                                                           │
│  │   └── Uninstall(editor)                                      │
│  │       ├── panel.Uninstall()                                  │
│  │       └── Remove from _searchPanels                          │
│  │                                                                │
│  └── Private Methods                                             │
│      └── GetOrCreatePanel(editor) → SearchPanel                 │
│          └── SearchPanel.Install(editor) if not exists          │
│                                                                   │
│  AvaloniaEdit SearchPanel Features                                │
│  ├── Find                                                        │
│  │   ├── SearchPattern text box                                 │
│  │   ├── Highlight all matches                                  │
│  │   ├── Next/Previous navigation                               │
│  │   └── Match count display                                    │
│  │                                                                │
│  ├── Replace                                                     │
│  │   ├── ReplacementText text box                               │
│  │   ├── Replace button (current match)                         │
│  │   └── Replace All button                                     │
│  │                                                                │
│  └── Options                                                     │
│      ├── UseRegex (regex patterns)                              │
│      ├── WholeWords (whole word match)                          │
│      └── MatchCase (case sensitive)                             │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Search Panel Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                    Search Panel Layout                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Find Mode (Ctrl+F):                                             │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ ┌────────────────────────────────┐  [◀] [▶]  [X]           │  │
│  │ │ Search pattern...              │   ↑   ↑    ↑            │  │
│  │ └────────────────────────────────┘ prev next close         │  │
│  │                                                             │  │
│  │ [.*] [Aa] [ab]    "3 of 42 matches"                        │  │
│  │  ↑    ↑    ↑                                               │  │
│  │ regex case whole                                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Replace Mode (Ctrl+H):                                          │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ ┌────────────────────────────────┐  [◀] [▶]  [X]           │  │
│  │ │ Search pattern...              │                          │  │
│  │ └────────────────────────────────┘                          │  │
│  │ ┌────────────────────────────────┐                          │  │
│  │ │ Replacement text...            │  [Replace] [Replace All] │  │
│  │ └────────────────────────────────┘                          │  │
│  │                                                             │  │
│  │ [.*] [Aa] [ab]    "3 of 42 matches"                        │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Open Find Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Open Find Flow                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User presses Ctrl+F                                             │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ EditorPanelViewModel.FindCommand.Execute()                 │  │
│  │ → raises FindRequested event                               │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ EditorPanel.OnFindRequested()                              │  │
│  │ → EditorSearchManager.OpenFind(Editor)                     │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ EditorSearchManager.OpenFind(editor)                       │  │
│  │                                                             │  │
│  │ 1. GetOrCreatePanel(editor)                                │  │
│  │    └── If not in _searchPanels:                            │  │
│  │        panel = SearchPanel.Install(editor)                 │  │
│  │        _searchPanels[editor] = panel                       │  │
│  │                                                             │  │
│  │ 2. panel.Open()                                            │  │
│  │    └── Shows search bar at top of editor                   │  │
│  │                                                             │  │
│  │ 3. Check for selection                                     │  │
│  │    └── if (!editor.Selection.IsEmpty)                      │  │
│  │        && (selectedText is single line)                    │  │
│  │        panel.SearchPattern = selectedText                  │  │
│  └────────────────────────────────────────────────────────────┘  │
│         │                                                        │
│         ▼                                                        │
│  Search panel opens, focused on search box                       │
│  (with selection pre-filled if applicable)                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Find Navigation Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Find Navigation Flow                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User types "function" in search box                             │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ SearchPanel automatically:                                  │  │
│  │ • Searches document for matches                            │  │
│  │ • Highlights all matches                                   │  │
│  │ • Shows "N of M matches"                                   │  │
│  │ • Jumps caret to first match                               │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  User presses F3 (Find Next)                                     │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ EditorSearchManager.FindNext(editor)                       │  │
│  │ → panel.FindNext()                                         │  │
│  │ → Caret moves to next match                                │  │
│  │ → Updates "N of M matches" display                         │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  User presses Shift+F3 (Find Previous)                           │
│         │                                                        │
│         ▼                                                        │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ EditorSearchManager.FindPrevious(editor)                   │  │
│  │ → panel.FindPrevious()                                     │  │
│  │ → Caret moves to previous match                            │  │
│  │ → Wraps around at document boundaries                      │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
├── Services/
│   └── EditorSearchManager.cs                        (NEW)
└── Views/
    └── EditorPanel.axaml.cs                          (MODIFY)
```

---

## Implementation Details

### Task 1: Create EditorSearchManager

**File:** `src/SeniorIntern.Desktop/Services/EditorSearchManager.cs`

```csharp
namespace SeniorIntern.Desktop.Services;

using System.Collections.Generic;
using AvaloniaEdit;
using AvaloniaEdit.Search;

/// <summary>
/// Manages the search panel for TextEditor instances.
/// </summary>
public static class EditorSearchManager
{
    private static readonly Dictionary<TextEditor, SearchPanel> _searchPanels = new();

    /// <summary>
    /// Opens the search panel for find operations.
    /// </summary>
    /// <param name="editor">The TextEditor to search in.</param>
    /// <returns>The SearchPanel instance.</returns>
    public static SearchPanel OpenFind(TextEditor editor)
    {
        var panel = GetOrCreatePanel(editor);
        panel.Open();

        // If there's a selection, use it as the search text
        if (!editor.TextArea.Selection.IsEmpty)
        {
            var selectedText = editor.TextArea.Selection.GetText();
            // Only use selection if it's a single line
            if (!string.IsNullOrEmpty(selectedText) && !selectedText.Contains('\n'))
            {
                panel.SearchPattern = selectedText;
            }
        }

        return panel;
    }

    /// <summary>
    /// Opens the search panel with replace visible.
    /// </summary>
    /// <param name="editor">The TextEditor to search in.</param>
    /// <returns>The SearchPanel instance in replace mode.</returns>
    public static SearchPanel OpenReplace(TextEditor editor)
    {
        var panel = OpenFind(editor);
        panel.IsReplaceMode = true;
        return panel;
    }

    /// <summary>
    /// Finds the next occurrence.
    /// </summary>
    /// <param name="editor">The TextEditor to search in.</param>
    public static void FindNext(TextEditor editor)
    {
        var panel = GetOrCreatePanel(editor);
        panel.FindNext();
    }

    /// <summary>
    /// Finds the previous occurrence.
    /// </summary>
    /// <param name="editor">The TextEditor to search in.</param>
    public static void FindPrevious(TextEditor editor)
    {
        var panel = GetOrCreatePanel(editor);
        panel.FindPrevious();
    }

    /// <summary>
    /// Closes the search panel.
    /// </summary>
    /// <param name="editor">The TextEditor.</param>
    public static void Close(TextEditor editor)
    {
        if (_searchPanels.TryGetValue(editor, out var panel))
        {
            panel.Close();
        }
    }

    /// <summary>
    /// Checks if search panel is open for the editor.
    /// </summary>
    /// <param name="editor">The TextEditor.</param>
    /// <returns>True if search panel is open.</returns>
    public static bool IsOpen(TextEditor editor)
    {
        if (_searchPanels.TryGetValue(editor, out var panel))
        {
            return panel.IsClosed == false;
        }
        return false;
    }

    /// <summary>
    /// Gets the current search pattern for the editor.
    /// </summary>
    /// <param name="editor">The TextEditor.</param>
    /// <returns>The current search pattern, or null.</returns>
    public static string? GetSearchPattern(TextEditor editor)
    {
        if (_searchPanels.TryGetValue(editor, out var panel))
        {
            return panel.SearchPattern;
        }
        return null;
    }

    /// <summary>
    /// Sets the search pattern for the editor.
    /// </summary>
    /// <param name="editor">The TextEditor.</param>
    /// <param name="pattern">The search pattern to set.</param>
    public static void SetSearchPattern(TextEditor editor, string pattern)
    {
        var panel = GetOrCreatePanel(editor);
        panel.SearchPattern = pattern;
    }

    /// <summary>
    /// Removes the search panel from an editor.
    /// </summary>
    /// <param name="editor">The TextEditor.</param>
    public static void Uninstall(TextEditor editor)
    {
        if (_searchPanels.TryGetValue(editor, out var panel))
        {
            panel.Uninstall();
            _searchPanels.Remove(editor);
        }
    }

    private static SearchPanel GetOrCreatePanel(TextEditor editor)
    {
        if (!_searchPanels.TryGetValue(editor, out var panel))
        {
            panel = SearchPanel.Install(editor);
            _searchPanels[editor] = panel;
        }
        return panel;
    }
}
```

### Task 2: Update EditorPanel.axaml.cs

**File:** `src/SeniorIntern.Desktop/Views/EditorPanel.axaml.cs` (additions)

```csharp
// Update the existing OnFindRequested and OnReplaceRequested methods:

private void OnFindRequested(object? sender, EventArgs e)
{
    EditorSearchManager.OpenFind(Editor);
}

private void OnReplaceRequested(object? sender, EventArgs e)
{
    EditorSearchManager.OpenReplace(Editor);
}

// Add F3 and Shift+F3 handling in OnKeyDown:

protected override void OnKeyDown(KeyEventArgs e)
{
    base.OnKeyDown(e);

    // F3 / Shift+F3 for find next/previous
    if (e.Key == Key.F3)
    {
        if (e.KeyModifiers.HasFlag(KeyModifiers.Shift))
            EditorSearchManager.FindPrevious(Editor);
        else
            EditorSearchManager.FindNext(Editor);
        e.Handled = true;
        return;
    }

    // Existing Ctrl+ shortcuts...
    if (e.KeyModifiers == KeyModifiers.Control)
    {
        // ... existing code ...
    }
}

// Add cleanup in OnUnloaded:

protected override void OnUnloaded(RoutedEventArgs e)
{
    base.OnUnloaded(e);

    // Uninstall search panel
    EditorSearchManager.Uninstall(Editor);

    // ... existing cleanup ...
}
```

---

## Keyboard Shortcuts Reference

| Shortcut | Action | Handler |
|----------|--------|---------|
| Ctrl+F | Open Find | `EditorSearchManager.OpenFind()` |
| Ctrl+H | Open Find & Replace | `EditorSearchManager.OpenReplace()` |
| F3 | Find Next | `EditorSearchManager.FindNext()` |
| Shift+F3 | Find Previous | `EditorSearchManager.FindPrevious()` |
| Escape | Close Search Panel | Built-in `SearchPanel` |
| Enter | Find Next (in search box) | Built-in `SearchPanel` |
| Alt+R | Toggle Replace Mode | Built-in `SearchPanel` |
| Alt+C | Toggle Match Case | Built-in `SearchPanel` |
| Alt+W | Toggle Whole Word | Built-in `SearchPanel` |
| Alt+E | Toggle Regex | Built-in `SearchPanel` |

---

## SearchPanel Options

| Option | Property | Description |
|--------|----------|-------------|
| Match Case | `MatchCase` | Case-sensitive matching |
| Whole Words | `WholeWords` | Match whole words only |
| Use Regex | `UseRegex` | Enable regex patterns |
| Replace Mode | `IsReplaceMode` | Show replace input |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| OpenFind | 3 | Install panel, open, selection auto-fill |
| OpenReplace | 2 | Replace mode, inherits find behavior |
| FindNext | 2 | Navigate, wrap around |
| FindPrevious | 2 | Navigate backward, wrap |
| Close | 1 | Panel closes |
| IsOpen | 2 | Open state, closed state |
| GetSearchPattern | 2 | Has pattern, no pattern |
| SetSearchPattern | 1 | Pattern set |
| Uninstall | 2 | Cleanup, remove from dict |
| GetOrCreatePanel | 2 | Create new, return existing |
| **Total** | **19** | |

---

## Files Summary

### Files to Create (1)

| File | Lines |
|------|-------|
| `Services/EditorSearchManager.cs` | 120 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `Views/EditorPanel.axaml.cs` | Add F3/Shift+F3, use SearchManager |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Ctrl+F opens search panel |
| AC-2 | Ctrl+H opens search panel in replace mode |
| AC-3 | Selected text auto-fills search box |
| AC-4 | F3 finds next occurrence |
| AC-5 | Shift+F3 finds previous occurrence |
| AC-6 | Replace button replaces current match |
| AC-7 | Replace All replaces all matches |
| AC-8 | Escape closes search panel |
| AC-9 | Match case option works |
| AC-10 | Whole word and regex options work |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.3e | EditorPanel.axaml.cs for wiring |
| AvaloniaEdit | SearchPanel class |

---

## AvaloniaEdit SearchPanel Features

The built-in `SearchPanel` provides:

| Feature | Description |
|---------|-------------|
| **Pattern Matching** | Search for text or regex patterns |
| **Highlight All** | Highlights all matches in document |
| **Match Count** | Shows "N of M matches" |
| **Navigation** | Next/Previous buttons and keyboard |
| **Replace** | Single and Replace All |
| **Options Toggle** | Case, whole word, regex buttons |
| **Wrap Around** | Wraps at document boundaries |
| **Escape to Close** | Standard keyboard behavior |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.3f | 0.5 day |
