# Design Specification: The Senior Intern v0.3.0 "Workspace Awareness"

## Executive Summary

This document provides a comprehensive design specification for v0.3.0, which transforms The Senior Intern from a standalone chat application into a workspace-aware coding assistant. This phase introduces file system integration, a syntax-highlighting code editor, and the ability to attach file context to conversations.

### v0.3.0 Scope (from ROADMAP.md)
- Add a **File Explorer** sidebar to open local project folders
- Integrate **AvalonEdit**: A syntax-highlighting code editor as the main central view
- "Read Context" feature: A button to "attach" the currently open file to the LLM prompt

---

## Sub-Version Breakdown

| Version | Name | Focus |
|---------|------|-------|
| v0.3.1 | Workspace Service | Workspace model, file system service, recent workspaces |
| v0.3.2 | File Explorer | Tree view UI, file/folder operations, context menus |
| v0.3.3 | Code Editor Integration | AvalonEdit setup, syntax highlighting, editor tabs |
| v0.3.4 | Context Attachment | Attach files to chat, context preview, token estimation |
| v0.3.5 | Polish & Integration | Multi-file context, workspace settings, final testing |

---

## v0.3.1: Workspace Service

### Objective
Establish the workspace abstraction layer that manages open project folders, tracks file state, and provides a clean interface for file system operations.

### New NuGet Packages

| Package | Version | Project | Purpose |
|---------|---------|---------|---------|
| AvaloniaEdit | 11.1.0 | Desktop | Syntax-highlighting code editor |
| TextMateSharp | 1.0.x | Desktop | TextMate grammar support for syntax highlighting |
| TextMateSharp.Grammars | 1.0.x | Desktop | Language grammar definitions |

### Core Models

#### Workspace Model
```csharp
namespace SeniorIntern.Core.Models;

public sealed class Workspace
{
    public Guid Id { get; init; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string RootPath { get; init; } = string.Empty;
    public DateTime OpenedAt { get; init; } = DateTime.UtcNow;
    public DateTime LastAccessedAt { get; set; } = DateTime.UtcNow;

    // Workspace state
    public IReadOnlyList<string> OpenFiles { get; set; } = Array.Empty<string>();
    public string? ActiveFilePath { get; set; }
    public IReadOnlyList<string> ExpandedFolders { get; set; } = Array.Empty<string>();

    // Computed properties
    public string DisplayName => string.IsNullOrEmpty(Name)
        ? Path.GetFileName(RootPath)
        : Name;
}
```

#### FileSystemItem Model
```csharp
namespace SeniorIntern.Core.Models;

public sealed class FileSystemItem
{
    public string Path { get; init; } = string.Empty;
    public string Name { get; init; } = string.Empty;
    public FileSystemItemType Type { get; init; }
    public long? Size { get; init; }
    public DateTime ModifiedAt { get; init; }
    public bool IsHidden { get; init; }
    public bool IsReadOnly { get; init; }

    // For directories
    public bool HasChildren { get; init; }
    public bool IsExpanded { get; set; }
    public IReadOnlyList<FileSystemItem>? Children { get; set; }

    // For files
    public string Extension => System.IO.Path.GetExtension(Path);
    public string? Language => LanguageDetector.DetectByExtension(Extension);
}

public enum FileSystemItemType
{
    File,
    Directory,
    SymbolicLink
}
```

#### FileContext Model (for attaching to chat)
```csharp
namespace SeniorIntern.Core.Models;

public sealed class FileContext
{
    public Guid Id { get; init; } = Guid.NewGuid();
    public string FilePath { get; init; } = string.Empty;
    public string FileName => Path.GetFileName(FilePath);
    public string Content { get; init; } = string.Empty;
    public string? Language { get; init; }
    public int LineCount { get; init; }
    public int EstimatedTokens { get; init; }
    public DateTime AttachedAt { get; init; } = DateTime.UtcNow;

    // Selection context (optional)
    public int? StartLine { get; init; }
    public int? EndLine { get; init; }
    public string? SelectionContent { get; init; }

    public bool IsPartialContent => StartLine.HasValue || EndLine.HasValue;
}
```

### Service Interfaces

#### IWorkspaceService
```csharp
namespace SeniorIntern.Core.Interfaces;

public interface IWorkspaceService
{
    // Current state
    Workspace? CurrentWorkspace { get; }
    bool HasOpenWorkspace { get; }

    // Workspace operations
    Task<Workspace> OpenWorkspaceAsync(string folderPath, CancellationToken ct = default);
    Task CloseWorkspaceAsync();
    Task<IReadOnlyList<Workspace>> GetRecentWorkspacesAsync(int count = 10);
    Task RemoveFromRecentAsync(Guid workspaceId);
    Task ClearRecentWorkspacesAsync();

    // State persistence
    Task SaveWorkspaceStateAsync();
    Task<Workspace?> RestoreLastWorkspaceAsync();

    // Events
    event EventHandler<WorkspaceChangedEventArgs>? WorkspaceChanged;
    event EventHandler<WorkspaceStateChangedEventArgs>? StateChanged;
}

public sealed class WorkspaceChangedEventArgs : EventArgs
{
    public Workspace? PreviousWorkspace { get; init; }
    public Workspace? CurrentWorkspace { get; init; }
    public WorkspaceChangeType ChangeType { get; init; }
}

public enum WorkspaceChangeType
{
    Opened,
    Closed,
    Refreshed
}
```

#### IFileSystemService
```csharp
namespace SeniorIntern.Core.Interfaces;

public interface IFileSystemService
{
    // Directory operations
    Task<IReadOnlyList<FileSystemItem>> GetDirectoryContentsAsync(
        string path,
        bool includeHidden = false,
        CancellationToken ct = default);

    Task<FileSystemItem> GetItemInfoAsync(string path, CancellationToken ct = default);

    // File operations
    Task<string> ReadFileAsync(string path, CancellationToken ct = default);
    Task WriteFileAsync(string path, string content, CancellationToken ct = default);
    Task<bool> FileExistsAsync(string path);
    Task<bool> DirectoryExistsAsync(string path);

    // File watching
    IDisposable WatchDirectory(string path, Action<FileSystemChangeEvent> onChange);

    // Utilities
    string GetRelativePath(string fullPath, string basePath);
    bool IsTextFile(string path);
    long GetFileSize(string path);

    // Ignore patterns (.gitignore support)
    bool ShouldIgnore(string path, IReadOnlyList<string> ignorePatterns);
    Task<IReadOnlyList<string>> LoadGitIgnorePatternsAsync(string workspacePath);
}

public sealed class FileSystemChangeEvent
{
    public string Path { get; init; } = string.Empty;
    public FileSystemChangeType ChangeType { get; init; }
    public DateTime Timestamp { get; init; }
}

public enum FileSystemChangeType
{
    Created,
    Modified,
    Deleted,
    Renamed
}
```

### Database Schema Updates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RecentWorkspaces                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Id              GUID PRIMARY KEY                                 â”‚
â”‚ Name            TEXT NULLABLE                                    â”‚
â”‚ RootPath        TEXT NOT NULL UNIQUE                             â”‚
â”‚ LastAccessedAt  DATETIME NOT NULL                                â”‚
â”‚ OpenFiles       TEXT NULLABLE (JSON array)                       â”‚
â”‚ ActiveFilePath  TEXT NULLABLE                                    â”‚
â”‚ ExpandedFolders TEXT NULLABLE (JSON array)                       â”‚
â”‚ IsPinned        BOOLEAN NOT NULL DEFAULT 0                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FileContextHistory                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Id              GUID PRIMARY KEY                                 â”‚
â”‚ ConversationId  GUID NOT NULL (FK â†’ Conversations.Id)           â”‚
â”‚ MessageId       GUID NOT NULL (FK â†’ Messages.Id)                â”‚
â”‚ FilePath        TEXT NOT NULL                                    â”‚
â”‚ FileName        TEXT NOT NULL                                    â”‚
â”‚ Language        TEXT NULLABLE                                    â”‚
â”‚ ContentHash     TEXT NOT NULL (for detecting changes)            â”‚
â”‚ LineCount       INTEGER NOT NULL                                 â”‚
â”‚ StartLine       INTEGER NULLABLE                                 â”‚
â”‚ EndLine         INTEGER NULLABLE                                 â”‚
â”‚ AttachedAt      DATETIME NOT NULL                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Settings Updates

```csharp
public sealed class AppSettings
{
    // ... existing properties ...

    // Workspace settings (v0.3.0)
    public bool RestoreLastWorkspace { get; set; } = true;
    public bool ShowHiddenFiles { get; set; } = false;
    public bool UseGitIgnore { get; set; } = true;
    public int MaxRecentWorkspaces { get; set; } = 10;
    public IReadOnlyList<string> CustomIgnorePatterns { get; set; } = Array.Empty<string>();

    // Editor settings
    public bool WordWrap { get; set; } = false;
    public int TabSize { get; set; } = 4;
    public bool ShowLineNumbers { get; set; } = true;
    public bool HighlightCurrentLine { get; set; } = true;
    public string EditorFontFamily { get; set; } = "Cascadia Code, Consolas, monospace";
    public int EditorFontSize { get; set; } = 14;
}
```

### Language Detection Utility

```csharp
namespace SeniorIntern.Core.Utilities;

public static class LanguageDetector
{
    private static readonly Dictionary<string, string> ExtensionMap = new(StringComparer.OrdinalIgnoreCase)
    {
        // Common languages
        [".cs"] = "csharp",
        [".csx"] = "csharp",
        [".js"] = "javascript",
        [".jsx"] = "javascriptreact",
        [".ts"] = "typescript",
        [".tsx"] = "typescriptreact",
        [".py"] = "python",
        [".rb"] = "ruby",
        [".go"] = "go",
        [".rs"] = "rust",
        [".java"] = "java",
        [".kt"] = "kotlin",
        [".swift"] = "swift",
        [".cpp"] = "cpp",
        [".c"] = "c",
        [".h"] = "c",
        [".hpp"] = "cpp",

        // Web
        [".html"] = "html",
        [".htm"] = "html",
        [".css"] = "css",
        [".scss"] = "scss",
        [".less"] = "less",
        [".vue"] = "vue",
        [".svelte"] = "svelte",

        // Data/Config
        [".json"] = "json",
        [".xml"] = "xml",
        [".yaml"] = "yaml",
        [".yml"] = "yaml",
        [".toml"] = "toml",
        [".ini"] = "ini",

        // Shell/Scripts
        [".sh"] = "shellscript",
        [".bash"] = "shellscript",
        [".ps1"] = "powershell",
        [".bat"] = "bat",
        [".cmd"] = "bat",

        // Markup
        [".md"] = "markdown",
        [".mdx"] = "mdx",
        [".rst"] = "restructuredtext",
        [".tex"] = "latex",

        // .NET specific
        [".csproj"] = "xml",
        [".fsproj"] = "xml",
        [".vbproj"] = "xml",
        [".sln"] = "text",
        [".props"] = "xml",
        [".targets"] = "xml",
        [".axaml"] = "xml",
        [".xaml"] = "xml",

        // Other
        [".sql"] = "sql",
        [".dockerfile"] = "dockerfile",
        [".dockerignore"] = "ignore",
        [".gitignore"] = "ignore",
        [".env"] = "properties",
    };

    public static string? DetectByExtension(string extension)
    {
        return ExtensionMap.TryGetValue(extension, out var language) ? language : null;
    }

    public static string? DetectByFileName(string fileName)
    {
        // Special files without extensions
        return fileName.ToLowerInvariant() switch
        {
            "dockerfile" => "dockerfile",
            "makefile" => "makefile",
            "rakefile" => "ruby",
            "gemfile" => "ruby",
            "cmakelists.txt" => "cmake",
            _ => DetectByExtension(Path.GetExtension(fileName))
        };
    }
}
```

### Files to Create (v0.3.1)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Core/Models/Workspace.cs` | Workspace model |
| `src/SeniorIntern.Core/Models/FileSystemItem.cs` | File/folder model |
| `src/SeniorIntern.Core/Models/FileContext.cs` | Attached file context |
| `src/SeniorIntern.Core/Interfaces/IWorkspaceService.cs` | Workspace service interface |
| `src/SeniorIntern.Core/Interfaces/IFileSystemService.cs` | File system service interface |
| `src/SeniorIntern.Core/Events/WorkspaceEvents.cs` | Workspace event args |
| `src/SeniorIntern.Core/Utilities/LanguageDetector.cs` | Language detection |
| `src/SeniorIntern.Services/WorkspaceService.cs` | Workspace service implementation |
| `src/SeniorIntern.Services/FileSystemService.cs` | File system service implementation |
| `src/SeniorIntern.Core/Entities/RecentWorkspaceEntity.cs` | Database entity |
| `src/SeniorIntern.Core/Entities/FileContextEntity.cs` | Database entity |
| `src/SeniorIntern.Data/Configurations/RecentWorkspaceConfiguration.cs` | EF config |
| `src/SeniorIntern.Data/Configurations/FileContextConfiguration.cs` | EF config |
| `src/SeniorIntern.Data/Repositories/IWorkspaceRepository.cs` | Repository interface |
| `src/SeniorIntern.Data/Repositories/WorkspaceRepository.cs` | Repository implementation |

### Files to Modify (v0.3.1)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Core/Models/AppSettings.cs` | Add workspace/editor settings |
| `src/SeniorIntern.Data/SeniorInternDbContext.cs` | Add new DbSets |
| `Directory.Packages.props` | Add AvaloniaEdit packages |

### Testing Strategy (v0.3.1)
- Unit tests for WorkspaceService
- Unit tests for FileSystemService (using temp directories)
- Unit tests for LanguageDetector
- Test .gitignore pattern matching
- Test file watching functionality

---

## v0.3.2: File Explorer

### Objective
Implement a full-featured file explorer sidebar with tree view, context menus, and file operations.

### UI Layout

#### Main Window with File Explorer
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              The Senior Intern                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Sidebar     â”‚                      Main Content Area                          â”‚
â”‚    (280px)     â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  Tab Bar: [main.cs Ã—] [app.axaml Ã—] [+]                  â”‚   â”‚
â”‚ â”‚   Model    â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚  Selector  â”‚ â”‚  â”‚                                                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚                    Code Editor                           â”‚   â”‚
â”‚                â”‚  â”‚                  (AvaloniaEdit)                          â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚                                                          â”‚   â”‚
â”‚ â”‚   Files    â”‚ â”‚  â”‚                                                          â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚                                                          â”‚   â”‚
â”‚ â”‚ â–¾ myproj   â”‚ â”‚  â”‚                                                          â”‚   â”‚
â”‚ â”‚  â”œâ–¸ src    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”‚  â”‚ â”œ main  â”‚ â”‚                                                                 â”‚
â”‚ â”‚  â”‚ â”” app   â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚  â”œâ–¸ tests  â”‚ â”‚  â”‚                      Chat Panel                          â”‚   â”‚
â”‚ â”‚  â”œ .git*   â”‚ â”‚  â”‚  [Collapse â–²]                                            â”‚   â”‚
â”‚ â”‚  â”” README  â”‚ â”‚  â”‚                                                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  Context: [main.cs Ã—]                                    â”‚   â”‚
â”‚                â”‚  â”‚                                                          â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  [Message input...]                     [Send]           â”‚   â”‚
â”‚ â”‚   Chats    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”‚  (v0.2.0)  â”‚ â”‚                                                                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Status: myproj â”‚ main.cs â”‚ C# â”‚ Ln 45, Col 12 â”‚ UTF-8 â”‚ LF â”‚ Model: llama.gguf â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Explorer ViewModels

#### FileExplorerViewModel
```csharp
public partial class FileExplorerViewModel : ViewModelBase
{
    private readonly IWorkspaceService _workspaceService;
    private readonly IFileSystemService _fileSystemService;

    [ObservableProperty]
    private ObservableCollection<FileTreeItemViewModel> _rootItems = new();

    [ObservableProperty]
    private FileTreeItemViewModel? _selectedItem;

    [ObservableProperty]
    private bool _isLoading;

    [ObservableProperty]
    private string? _workspaceName;

    [ObservableProperty]
    private bool _hasWorkspace;

    [ObservableProperty]
    private string _searchFilter = string.Empty;

    // Commands
    [RelayCommand]
    private Task OpenWorkspaceAsync();

    [RelayCommand]
    private Task CloseWorkspaceAsync();

    [RelayCommand]
    private Task RefreshAsync();

    [RelayCommand]
    private Task OpenFileAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task ExpandFolderAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task CollapseFolderAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task NewFileAsync(FileTreeItemViewModel? parentFolder);

    [RelayCommand]
    private Task NewFolderAsync(FileTreeItemViewModel? parentFolder);

    [RelayCommand]
    private Task RenameAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task DeleteAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task CopyPathAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task RevealInFinderAsync(FileTreeItemViewModel item);

    [RelayCommand]
    private Task AttachToContextAsync(FileTreeItemViewModel item);
}
```

#### FileTreeItemViewModel
```csharp
public partial class FileTreeItemViewModel : ViewModelBase
{
    [ObservableProperty]
    private string _name = string.Empty;

    [ObservableProperty]
    private string _path = string.Empty;

    [ObservableProperty]
    private FileSystemItemType _itemType;

    [ObservableProperty]
    private bool _isExpanded;

    [ObservableProperty]
    private bool _isSelected;

    [ObservableProperty]
    private bool _isLoading;

    [ObservableProperty]
    private bool _isRenaming;

    [ObservableProperty]
    private string _editingName = string.Empty;

    [ObservableProperty]
    private ObservableCollection<FileTreeItemViewModel> _children = new();

    [ObservableProperty]
    private string? _iconKey;

    [ObservableProperty]
    private bool _isModified;

    // Computed
    public bool IsDirectory => ItemType == FileSystemItemType.Directory;
    public bool IsFile => ItemType == FileSystemItemType.File;
    public string Extension => Path.GetExtension(Path);
    public string? Language => LanguageDetector.DetectByExtension(Extension);

    // For filtering
    public bool MatchesFilter(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter)) return true;
        return Name.Contains(filter, StringComparison.OrdinalIgnoreCase);
    }
}
```

### File Explorer UI (FileExplorerView.axaml)

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             x:Class="SeniorIntern.Desktop.Views.FileExplorerView"
             x:DataType="vm:FileExplorerViewModel">

    <Grid RowDefinitions="Auto, Auto, *">
        <!-- Header -->
        <Border Grid.Row="0" Padding="12,8"
                Background="{DynamicResource SidebarBackground}">
            <Grid ColumnDefinitions="*, Auto, Auto, Auto">
                <TextBlock Text="Explorer" FontWeight="SemiBold"
                           VerticalAlignment="Center" />
                <Button Grid.Column="1" Command="{Binding NewFileCommand}"
                        ToolTip.Tip="New File" Classes="icon-button">
                    <PathIcon Data="{StaticResource NewFileIcon}" />
                </Button>
                <Button Grid.Column="2" Command="{Binding NewFolderCommand}"
                        ToolTip.Tip="New Folder" Classes="icon-button">
                    <PathIcon Data="{StaticResource NewFolderIcon}" />
                </Button>
                <Button Grid.Column="3" Command="{Binding RefreshCommand}"
                        ToolTip.Tip="Refresh" Classes="icon-button">
                    <PathIcon Data="{StaticResource RefreshIcon}" />
                </Button>
            </Grid>
        </Border>

        <!-- Search/Filter -->
        <TextBox Grid.Row="1"
                 Text="{Binding SearchFilter}"
                 Watermark="Filter files..."
                 Margin="8,4" />

        <!-- Tree View -->
        <TreeView Grid.Row="2"
                  ItemsSource="{Binding RootItems}"
                  SelectedItem="{Binding SelectedItem}"
                  DoubleTapped="OnItemDoubleTapped">
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}">
                    <Grid ColumnDefinitions="Auto, *, Auto">
                        <!-- Icon -->
                        <PathIcon Data="{Binding IconKey, Converter={StaticResource FileIconConverter}}"
                                  Width="16" Height="16" Margin="0,0,6,0" />

                        <!-- Name (or editing textbox) -->
                        <TextBlock Grid.Column="1" Text="{Binding Name}"
                                   IsVisible="{Binding !IsRenaming}" />
                        <TextBox Grid.Column="1" Text="{Binding EditingName}"
                                 IsVisible="{Binding IsRenaming}"
                                 KeyDown="OnRenameKeyDown"
                                 LostFocus="OnRenameLostFocus" />

                        <!-- Modified indicator -->
                        <Ellipse Grid.Column="2" Width="6" Height="6"
                                 Fill="{DynamicResource AccentBrush}"
                                 IsVisible="{Binding IsModified}"
                                 Margin="4,0" />
                    </Grid>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>

        <!-- No workspace state -->
        <StackPanel Grid.Row="2"
                    IsVisible="{Binding !HasWorkspace}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="16">
            <TextBlock Text="No folder opened"
                       HorizontalAlignment="Center"
                       Foreground="{DynamicResource TextMuted}" />
            <Button Command="{Binding OpenWorkspaceCommand}"
                    Content="Open Folder"
                    HorizontalAlignment="Center" />
        </StackPanel>
    </Grid>
</UserControl>
```

### Context Menu

```xml
<TreeView.ContextMenu>
    <ContextMenu>
        <!-- File operations -->
        <MenuItem Header="Open" Command="{Binding OpenFileCommand}"
                  IsVisible="{Binding SelectedItem.IsFile}" />
        <MenuItem Header="Attach to Context" Command="{Binding AttachToContextCommand}"
                  IsVisible="{Binding SelectedItem.IsFile}">
            <MenuItem.Icon>
                <PathIcon Data="{StaticResource AttachIcon}" />
            </MenuItem.Icon>
        </MenuItem>
        <Separator IsVisible="{Binding SelectedItem.IsFile}" />

        <!-- Create operations -->
        <MenuItem Header="New File" Command="{Binding NewFileCommand}" />
        <MenuItem Header="New Folder" Command="{Binding NewFolderCommand}" />
        <Separator />

        <!-- Edit operations -->
        <MenuItem Header="Rename" Command="{Binding RenameCommand}"
                  InputGesture="F2" />
        <MenuItem Header="Delete" Command="{Binding DeleteCommand}"
                  InputGesture="Delete" />
        <Separator />

        <!-- Path operations -->
        <MenuItem Header="Copy Path" Command="{Binding CopyPathCommand}" />
        <MenuItem Header="Copy Relative Path" Command="{Binding CopyRelativePathCommand}" />
        <MenuItem Header="Reveal in Finder" Command="{Binding RevealInFinderCommand}" />
    </ContextMenu>
</TreeView.ContextMenu>
```

### File Icons

```csharp
public static class FileIconProvider
{
    private static readonly Dictionary<string, string> IconMap = new(StringComparer.OrdinalIgnoreCase)
    {
        // Folders
        ["folder"] = "M10 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V8a2 2 0 00-2-2h-8l-2-2z",
        ["folder-open"] = "M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v2H5v8l2-6h16l-2 8a2 2 0 01-2 2z",

        // Common file types
        ["file-code"] = "M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z M14 2v6h6",
        ["file-text"] = "M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z",
        ["file-json"] = "...",
        ["file-image"] = "...",
        ["file-git"] = "...",
    };

    public static string GetIconForItem(FileSystemItem item)
    {
        if (item.Type == FileSystemItemType.Directory)
            return item.IsExpanded ? "folder-open" : "folder";

        return GetIconForExtension(item.Extension);
    }

    public static string GetIconForExtension(string extension)
    {
        return extension.ToLowerInvariant() switch
        {
            ".cs" or ".csx" => "file-csharp",
            ".js" or ".jsx" or ".ts" or ".tsx" => "file-javascript",
            ".py" => "file-python",
            ".json" => "file-json",
            ".md" => "file-markdown",
            ".gitignore" or ".gitattributes" => "file-git",
            ".png" or ".jpg" or ".gif" or ".svg" => "file-image",
            _ => "file-code"
        };
    }
}
```

### Keyboard Shortcuts (File Explorer)

| Shortcut | Action |
|----------|--------|
| Enter | Open selected file / Expand folder |
| F2 | Rename selected item |
| Delete | Delete selected item |
| Ctrl+C | Copy path |
| Ctrl+Shift+C | Copy relative path |
| Ctrl+N | New file in current folder |
| Ctrl+Shift+N | New folder |
| Ctrl+R | Refresh tree |

### Files to Create (v0.3.2)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/FileExplorerViewModel.cs` | Explorer ViewModel |
| `src/SeniorIntern.Desktop/ViewModels/FileTreeItemViewModel.cs` | Tree item ViewModel |
| `src/SeniorIntern.Desktop/Views/FileExplorerView.axaml` | Explorer UI |
| `src/SeniorIntern.Desktop/Views/FileExplorerView.axaml.cs` | Code-behind |
| `src/SeniorIntern.Desktop/Converters/FileIconConverter.cs` | Icon converter |
| `src/SeniorIntern.Desktop/Assets/FileIcons.axaml` | Icon resources |

### Files to Modify (v0.3.2)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add File Explorer to sidebar |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add FileExplorerViewModel |
| `src/SeniorIntern.Desktop/Themes/Dark.axaml` | Add file explorer styles |

### Testing Strategy (v0.3.2)
- Test tree view expand/collapse
- Test file filtering
- Test context menu operations
- Test keyboard navigation
- Test drag-and-drop (if implemented)
- Test file watching and auto-refresh

---

## v0.3.3: Code Editor Integration

### Objective
Integrate AvaloniaEdit as the primary code editor with syntax highlighting, multiple tabs, and standard editor features.

### AvaloniaEdit Configuration

```csharp
public static class EditorConfiguration
{
    public static void ConfigureEditor(TextEditor editor, AppSettings settings)
    {
        // Basic settings
        editor.ShowLineNumbers = settings.ShowLineNumbers;
        editor.WordWrap = settings.WordWrap;
        editor.FontFamily = new FontFamily(settings.EditorFontFamily);
        editor.FontSize = settings.EditorFontSize;

        // Tab settings
        editor.Options.ConvertTabsToSpaces = true;
        editor.Options.IndentationSize = settings.TabSize;

        // Visual settings
        editor.Options.HighlightCurrentLine = settings.HighlightCurrentLine;
        editor.Options.ShowEndOfLine = false;
        editor.Options.ShowSpaces = false;
        editor.Options.ShowTabs = false;

        // Enable code folding
        editor.Options.EnableFolding = true;

        // Search panel
        editor.Options.EnableHyperlinks = true;
    }
}
```

### Syntax Highlighting with TextMate

```csharp
public class SyntaxHighlightingService
{
    private readonly RegistryOptions _registryOptions;
    private readonly Registry _registry;
    private readonly Dictionary<string, IGrammar> _grammarCache = new();

    public SyntaxHighlightingService()
    {
        _registryOptions = new RegistryOptions(ThemeName.DarkPlus);
        _registry = new Registry(_registryOptions);
    }

    public void ApplyHighlighting(TextEditor editor, string language)
    {
        var grammar = GetGrammar(language);
        if (grammar == null) return;

        var highlighting = new TextMateColoringTransformer(grammar, _registryOptions);
        editor.TextArea.TextView.LineTransformers.Add(highlighting);
    }

    private IGrammar? GetGrammar(string language)
    {
        if (_grammarCache.TryGetValue(language, out var cached))
            return cached;

        var scopeName = GetScopeName(language);
        var grammar = _registry.LoadGrammar(scopeName);

        if (grammar != null)
            _grammarCache[language] = grammar;

        return grammar;
    }

    private string GetScopeName(string language)
    {
        return language switch
        {
            "csharp" => "source.cs",
            "javascript" => "source.js",
            "typescript" => "source.ts",
            "python" => "source.python",
            "json" => "source.json",
            "xml" => "text.xml",
            "html" => "text.html.basic",
            "css" => "source.css",
            "markdown" => "text.html.markdown",
            _ => "source.txt"
        };
    }
}
```

### Editor Tab System

#### EditorTabViewModel
```csharp
public partial class EditorTabViewModel : ViewModelBase
{
    [ObservableProperty]
    private string _filePath = string.Empty;

    [ObservableProperty]
    private string _fileName = string.Empty;

    [ObservableProperty]
    private string _content = string.Empty;

    [ObservableProperty]
    private string? _language;

    [ObservableProperty]
    private bool _isDirty;

    [ObservableProperty]
    private bool _isActive;

    [ObservableProperty]
    private int _caretLine = 1;

    [ObservableProperty]
    private int _caretColumn = 1;

    [ObservableProperty]
    private string _encoding = "UTF-8";

    [ObservableProperty]
    private string _lineEnding = "LF";

    [ObservableProperty]
    private bool _isReadOnly;

    // Original content for dirty detection
    private string _originalContent = string.Empty;

    public string DisplayTitle => IsDirty ? $"{FileName} â€¢" : FileName;

    partial void OnContentChanged(string value)
    {
        IsDirty = value != _originalContent;
    }

    public void MarkAsSaved()
    {
        _originalContent = Content;
        IsDirty = false;
    }
}
```

#### EditorPanelViewModel
```csharp
public partial class EditorPanelViewModel : ViewModelBase
{
    private readonly IFileSystemService _fileSystemService;
    private readonly SyntaxHighlightingService _syntaxService;

    [ObservableProperty]
    private ObservableCollection<EditorTabViewModel> _tabs = new();

    [ObservableProperty]
    private EditorTabViewModel? _activeTab;

    [ObservableProperty]
    private bool _hasUnsavedChanges;

    // Commands
    [RelayCommand]
    private Task OpenFileAsync(string filePath);

    [RelayCommand]
    private Task SaveAsync();

    [RelayCommand]
    private Task SaveAsAsync();

    [RelayCommand]
    private Task SaveAllAsync();

    [RelayCommand]
    private Task CloseTabAsync(EditorTabViewModel tab);

    [RelayCommand]
    private Task CloseAllTabsAsync();

    [RelayCommand]
    private Task CloseOtherTabsAsync(EditorTabViewModel keepTab);

    [RelayCommand]
    private void GoToLine();

    [RelayCommand]
    private void Find();

    [RelayCommand]
    private void Replace();

    // Tab management
    public async Task<EditorTabViewModel?> OpenFileAsync(string filePath)
    {
        // Check if already open
        var existingTab = Tabs.FirstOrDefault(t => t.FilePath == filePath);
        if (existingTab != null)
        {
            ActiveTab = existingTab;
            return existingTab;
        }

        // Load file
        var content = await _fileSystemService.ReadFileAsync(filePath);
        var language = LanguageDetector.DetectByFileName(Path.GetFileName(filePath));

        var tab = new EditorTabViewModel
        {
            FilePath = filePath,
            FileName = Path.GetFileName(filePath),
            Content = content,
            Language = language
        };
        tab.MarkAsSaved();

        Tabs.Add(tab);
        ActiveTab = tab;

        return tab;
    }
}
```

### Editor UI (EditorPanel.axaml)

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ae="using:AvaloniaEdit"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             x:Class="SeniorIntern.Desktop.Views.EditorPanel"
             x:DataType="vm:EditorPanelViewModel">

    <Grid RowDefinitions="Auto, *">
        <!-- Tab Bar -->
        <Border Grid.Row="0" Background="{DynamicResource TabBarBackground}">
            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding Tabs}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Classes="editor-tab"
                                    Classes.active="{Binding IsActive}"
                                    Command="{Binding $parent[UserControl].DataContext.ActivateTabCommand}"
                                    CommandParameter="{Binding}">
                                <Grid ColumnDefinitions="Auto, *, Auto">
                                    <!-- Language icon -->
                                    <PathIcon Grid.Column="0"
                                              Data="{Binding Language, Converter={StaticResource LanguageIconConverter}}"
                                              Width="14" Height="14" Margin="0,0,6,0" />

                                    <!-- File name -->
                                    <TextBlock Grid.Column="1" Text="{Binding DisplayTitle}" />

                                    <!-- Close button -->
                                    <Button Grid.Column="2"
                                            Classes="tab-close"
                                            Command="{Binding $parent[UserControl].DataContext.CloseTabCommand}"
                                            CommandParameter="{Binding}">
                                        <PathIcon Data="{StaticResource CloseIcon}" Width="10" Height="10" />
                                    </Button>
                                </Grid>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Editor Area -->
        <ae:TextEditor Grid.Row="1"
                       x:Name="Editor"
                       Document="{Binding ActiveTab.Document}"
                       IsReadOnly="{Binding ActiveTab.IsReadOnly}"
                       IsVisible="{Binding ActiveTab, Converter={x:Static ObjectConverters.IsNotNull}}" />

        <!-- No file open state -->
        <StackPanel Grid.Row="1"
                    IsVisible="{Binding !Tabs.Count}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="16">
            <TextBlock Text="No file open"
                       FontSize="18"
                       HorizontalAlignment="Center"
                       Foreground="{DynamicResource TextMuted}" />
            <TextBlock Text="Open a file from the Explorer or drag and drop here"
                       HorizontalAlignment="Center"
                       Foreground="{DynamicResource TextMuted}" />
        </StackPanel>
    </Grid>
</UserControl>
```

### Editor Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| Ctrl+S | Save current file |
| Ctrl+Shift+S | Save all files |
| Ctrl+W | Close current tab |
| Ctrl+Tab | Next tab |
| Ctrl+Shift+Tab | Previous tab |
| Ctrl+G | Go to line |
| Ctrl+F | Find |
| Ctrl+H | Find and replace |
| Ctrl+/ | Toggle line comment |
| Ctrl+D | Duplicate line |
| Ctrl+Shift+K | Delete line |
| Alt+Up | Move line up |
| Alt+Down | Move line down |

### Unsaved Changes Handling

```csharp
public async Task<bool> PromptSaveChangesAsync(EditorTabViewModel tab)
{
    if (!tab.IsDirty) return true;

    var result = await ShowConfirmDialogAsync(
        "Unsaved Changes",
        $"Do you want to save changes to {tab.FileName}?",
        new[] { "Save", "Don't Save", "Cancel" }
    );

    return result switch
    {
        "Save" => await SaveTabAsync(tab),
        "Don't Save" => true,
        _ => false
    };
}
```

### Files to Create (v0.3.3)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/EditorPanelViewModel.cs` | Editor panel ViewModel |
| `src/SeniorIntern.Desktop/ViewModels/EditorTabViewModel.cs` | Tab ViewModel |
| `src/SeniorIntern.Desktop/Views/EditorPanel.axaml` | Editor UI |
| `src/SeniorIntern.Desktop/Views/EditorPanel.axaml.cs` | Code-behind |
| `src/SeniorIntern.Desktop/Services/SyntaxHighlightingService.cs` | TextMate integration |
| `src/SeniorIntern.Desktop/Services/EditorConfiguration.cs` | Editor setup |

### Files to Modify (v0.3.3)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add editor panel to main content |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add EditorPanelViewModel |
| `src/SeniorIntern.Desktop/ViewModels/FileExplorerViewModel.cs` | Wire up file opening |

### Testing Strategy (v0.3.3)
- Test file open/save cycle
- Test syntax highlighting for multiple languages
- Test tab management (open, close, switch)
- Test dirty state detection
- Test unsaved changes prompts
- Test large file handling (performance)

---

## v0.3.4: Context Attachment

### Objective
Enable attaching files or code selections to chat messages, with visual previews and token estimation.

### Context Attachment Flow

```
1. User selects code in editor (or right-clicks file in explorer)
2. User clicks "Attach to Context" button
3. Context appears in chat input area as pill/badge
4. User types question/instruction
5. Context is prepended to LLM prompt with file metadata
6. LLM response considers the attached context
7. Context is stored with message for history
```

### Updated Chat UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Chat Panel                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  [User Message with Context]                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“ main.cs (lines 45-67) â€¢ C# â€¢ ~150 tokens              â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ public async Task<Result> ProcessAsync()           â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ {                                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     var data = await _repo.GetAsync();             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚     // ... (collapsed)                              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ }                                                   â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  How can I optimize this method for better performance?          â”‚
â”‚                                                                  â”‚
â”‚  [Assistant Response]                                            â”‚
â”‚  Looking at your `ProcessAsync` method, I notice several...      â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Attached Context:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [ğŸ“„ main.cs (selection) Ã—] [ğŸ“„ helper.cs Ã—]  [+ Add File] â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  Total: ~320 tokens                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Your message...]                                    [Send]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Context Attachment ViewModels

#### FileContextViewModel
```csharp
public partial class FileContextViewModel : ViewModelBase
{
    [ObservableProperty]
    private Guid _id;

    [ObservableProperty]
    private string _filePath = string.Empty;

    [ObservableProperty]
    private string _fileName = string.Empty;

    [ObservableProperty]
    private string? _language;

    [ObservableProperty]
    private string _content = string.Empty;

    [ObservableProperty]
    private int _estimatedTokens;

    [ObservableProperty]
    private int? _startLine;

    [ObservableProperty]
    private int? _endLine;

    [ObservableProperty]
    private bool _isExpanded = false;

    // Computed
    public string DisplayLabel => StartLine.HasValue
        ? $"{FileName} (lines {StartLine}-{EndLine})"
        : FileName;

    public string PreviewContent => Content.Length > 200
        ? Content[..200] + "..."
        : Content;
}
```

#### Updated ChatViewModel
```csharp
public partial class ChatViewModel : ViewModelBase
{
    // ... existing properties ...

    [ObservableProperty]
    private ObservableCollection<FileContextViewModel> _attachedContexts = new();

    [ObservableProperty]
    private int _totalContextTokens;

    [RelayCommand]
    private void AttachFile(string filePath);

    [RelayCommand]
    private void AttachSelection(string filePath, string content, int startLine, int endLine);

    [RelayCommand]
    private void RemoveContext(FileContextViewModel context);

    [RelayCommand]
    private void ClearAllContexts();

    [RelayCommand]
    private void ExpandContext(FileContextViewModel context);

    // Token estimation
    private int EstimateTokens(string content)
    {
        // Rough estimate: ~4 characters per token
        return (int)Math.Ceiling(content.Length / 4.0);
    }

    // Updated send to include context
    private async Task SendMessageWithContextAsync()
    {
        var contextPrompt = BuildContextPrompt(AttachedContexts);
        var fullPrompt = string.IsNullOrEmpty(contextPrompt)
            ? UserInput
            : $"{contextPrompt}\n\n{UserInput}";

        // ... rest of send logic
    }
}
```

### Context Prompt Formatting

```csharp
public static class ContextFormatter
{
    public static string FormatContext(IEnumerable<FileContext> contexts)
    {
        var sb = new StringBuilder();

        foreach (var ctx in contexts)
        {
            sb.AppendLine($"--- File: {ctx.FileName} ({ctx.Language ?? "text"}) ---");

            if (ctx.StartLine.HasValue)
            {
                sb.AppendLine($"Lines {ctx.StartLine}-{ctx.EndLine}:");
            }

            sb.AppendLine("```" + (ctx.Language ?? ""));
            sb.AppendLine(ctx.Content);
            sb.AppendLine("```");
            sb.AppendLine();
        }

        return sb.ToString();
    }
}
```

### Context Attachment UI (ChatContextBar.axaml)

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             x:Class="SeniorIntern.Desktop.Views.ChatContextBar">

    <Border Background="{DynamicResource ControlBackground}"
            CornerRadius="8"
            Padding="8"
            IsVisible="{Binding AttachedContexts.Count}">
        <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*, Auto">
                <TextBlock Text="Attached Context"
                           FontWeight="SemiBold" FontSize="12" />
                <Button Grid.Column="1"
                        Content="Clear All"
                        Classes="link-button"
                        Command="{Binding ClearAllContextsCommand}" />
            </Grid>

            <ItemsControl ItemsSource="{Binding AttachedContexts}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Classes="context-pill"
                                Margin="0,0,4,4"
                                PointerPressed="OnContextPillPressed">
                            <Grid ColumnDefinitions="Auto, *, Auto">
                                <PathIcon Data="{StaticResource FileIcon}"
                                          Width="12" Height="12" Margin="0,0,4,0" />
                                <TextBlock Grid.Column="1"
                                           Text="{Binding DisplayLabel}"
                                           FontSize="12" />
                                <Button Grid.Column="2"
                                        Command="{Binding $parent[UserControl].DataContext.RemoveContextCommand}"
                                        CommandParameter="{Binding}"
                                        Classes="pill-close">
                                    <PathIcon Data="{StaticResource CloseIcon}"
                                              Width="8" Height="8" />
                                </Button>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <TextBlock Text="{Binding TotalContextTokens, StringFormat='~{0} tokens'}"
                       FontSize="11"
                       Foreground="{DynamicResource TextMuted}" />
        </StackPanel>
    </Border>
</UserControl>
```

### Context Preview Popup

```xml
<Popup x:Name="ContextPreviewPopup"
       PlacementMode="Bottom"
       StaysOpen="False">
    <Border Background="{DynamicResource PopupBackground}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="12"
            MaxWidth="500"
            MaxHeight="300">
        <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*, Auto">
                <TextBlock Text="{Binding SelectedContext.DisplayLabel}"
                           FontWeight="SemiBold" />
                <TextBlock Grid.Column="1"
                           Text="{Binding SelectedContext.Language}"
                           Foreground="{DynamicResource TextMuted}" />
            </Grid>

            <ScrollViewer MaxHeight="200">
                <SelectableTextBlock Text="{Binding SelectedContext.Content}"
                                     FontFamily="Cascadia Code, Consolas"
                                     FontSize="12" />
            </ScrollViewer>

            <TextBlock Text="{Binding SelectedContext.EstimatedTokens, StringFormat='~{0} tokens'}"
                       FontSize="11"
                       Foreground="{DynamicResource TextMuted}" />
        </StackPanel>
    </Border>
</Popup>
```

### Editor Integration (Selection to Context)

```csharp
// In EditorPanel.axaml.cs
private void OnAttachSelectionRequested()
{
    if (ActiveTab == null) return;

    var selection = Editor.TextArea.Selection;
    if (selection.IsEmpty) return;

    var startLine = selection.StartPosition.Line;
    var endLine = selection.EndPosition.Line;
    var content = selection.GetText();

    _chatViewModel.AttachSelection(
        ActiveTab.FilePath,
        content,
        startLine,
        endLine
    );
}
```

### Files to Create (v0.3.4)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/FileContextViewModel.cs` | Context ViewModel |
| `src/SeniorIntern.Desktop/Views/ChatContextBar.axaml` | Context bar UI |
| `src/SeniorIntern.Desktop/Views/ChatContextBar.axaml.cs` | Code-behind |
| `src/SeniorIntern.Desktop/Views/ContextPreviewPopup.axaml` | Preview popup |
| `src/SeniorIntern.Core/Utilities/ContextFormatter.cs` | Context formatting |
| `src/SeniorIntern.Core/Utilities/TokenEstimator.cs` | Token estimation |

### Files to Modify (v0.3.4)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/ChatViewModel.cs` | Add context attachment |
| `src/SeniorIntern.Desktop/Views/ChatView.axaml` | Add context bar |
| `src/SeniorIntern.Desktop/Views/EditorPanel.axaml.cs` | Add selection attachment |
| `src/SeniorIntern.Services/LlmService.cs` | Include context in prompt |

### Testing Strategy (v0.3.4)
- Test file attachment from explorer
- Test selection attachment from editor
- Test context removal
- Test token estimation accuracy
- Test context formatting in prompts
- Test large file handling (truncation)

---

## v0.3.5: Polish & Integration

### Objective
Final integration of all workspace features, multi-file context support, workspace settings, and comprehensive testing.

### Multi-File Context

#### Context Limits
```csharp
public static class ContextLimits
{
    public const int MaxFilesAttached = 10;
    public const int MaxTokensPerFile = 4000;
    public const int MaxTotalTokens = 8000;
    public const int MaxFileSizeBytes = 500_000; // 500KB

    public static bool CanAttachFile(IReadOnlyList<FileContext> existing, FileContext newContext)
    {
        if (existing.Count >= MaxFilesAttached)
            return false;

        var totalTokens = existing.Sum(c => c.EstimatedTokens) + newContext.EstimatedTokens;
        return totalTokens <= MaxTotalTokens;
    }
}
```

### Workspace Settings Panel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Workspace Settings                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  File Explorer                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â˜‘ Restore last workspace on startup                            â”‚
â”‚  â˜‘ Show hidden files and folders                                â”‚
â”‚  â˜‘ Respect .gitignore patterns                                  â”‚
â”‚                                                                  â”‚
â”‚  Custom ignore patterns:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ node_modules/                                               â”‚ â”‚
â”‚  â”‚ bin/                                                        â”‚ â”‚
â”‚  â”‚ obj/                                                        â”‚ â”‚
â”‚  â”‚ .vs/                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  Editor                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Font:     [Cascadia Code           â–¾] Size: [14 â–¾]             â”‚
â”‚  Tab size: [4 â–¾]                                                â”‚
â”‚                                                                  â”‚
â”‚  â˜‘ Show line numbers                                            â”‚
â”‚  â˜‘ Highlight current line                                       â”‚
â”‚  â˜ Word wrap                                                    â”‚
â”‚                                                                  â”‚
â”‚  Context Attachment                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Max files:    [10    ] â”‚ Max tokens per file: [4000  ]         â”‚
â”‚  Max total tokens: [8000  ]                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Status Bar Updates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ myproject â”‚ main.cs â”‚ C# â”‚ Ln 45, Col 12 â”‚ UTF-8 â”‚ LF â”‚ âœ“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Status bar segments:
1. **Workspace name** (clickable â†’ open workspace)
2. **Active file** (clickable â†’ go to file)
3. **Language** (clickable â†’ change language mode)
4. **Cursor position** (clickable â†’ go to line)
5. **Encoding** (clickable â†’ change encoding)
6. **Line ending** (clickable â†’ change EOL)
7. **Sync indicator** (file watcher status)

### Drag and Drop Support

```csharp
// In MainWindow.axaml.cs
private async void OnDrop(object sender, DragEventArgs e)
{
    if (e.Data.Contains(DataFormats.FileNames))
    {
        var files = e.Data.GetFileNames();
        foreach (var file in files)
        {
            if (Directory.Exists(file))
            {
                await _workspaceService.OpenWorkspaceAsync(file);
            }
            else if (File.Exists(file))
            {
                await _editorPanel.OpenFileAsync(file);
            }
        }
    }
}
```

### Recent Workspaces Menu

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File  Edit  View  Help                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Open Folder...       â”‚                                        â”‚
â”‚  â”‚ Open Recent        â–¸ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Close Folder         â”‚ â”‚ ğŸ“ senior-intern                    â”‚â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚    ~/Documents/GitHub/senior-intern â”‚â”‚
â”‚  â”‚ Save          Ctrl+S â”‚ â”‚ ğŸ“ my-app                           â”‚â”‚
â”‚  â”‚ Save All   Ctrl+S+S  â”‚ â”‚    ~/Projects/my-app                â”‚â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ ğŸ“ api-project                      â”‚â”‚
â”‚  â”‚ Exit                 â”‚ â”‚    ~/Work/api-project               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚â”‚
â”‚                           â”‚ Clear Recent Workspaces              â”‚â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Keyboard Shortcuts (Complete List)

| Category | Shortcut | Action |
|----------|----------|--------|
| **Workspace** | Ctrl+O | Open folder |
| | Ctrl+Shift+O | Open file |
| | Ctrl+K Ctrl+O | Open recent workspace |
| **Editor** | Ctrl+S | Save |
| | Ctrl+Shift+S | Save all |
| | Ctrl+W | Close tab |
| | Ctrl+Tab | Next tab |
| | Ctrl+Shift+Tab | Previous tab |
| | Ctrl+G | Go to line |
| | Ctrl+P | Quick open file |
| **Chat** | Ctrl+Enter | Send message |
| | Ctrl+Shift+A | Attach current file |
| | Ctrl+Shift+E | Attach selection |
| | Escape | Clear context |
| **Explorer** | F2 | Rename |
| | Delete | Delete |
| | Enter | Open file |

### Files to Create (v0.3.5)

| File | Purpose |
|------|---------|
| `src/SeniorIntern.Desktop/ViewModels/WorkspaceSettingsViewModel.cs` | Settings ViewModel |
| `src/SeniorIntern.Desktop/Views/WorkspaceSettingsPanel.axaml` | Settings UI |
| `src/SeniorIntern.Desktop/Views/RecentWorkspacesMenu.axaml` | Recent menu |
| `src/SeniorIntern.Desktop/Views/QuickOpenDialog.axaml` | Quick file open |
| `src/SeniorIntern.Core/Utilities/ContextLimits.cs` | Context limits |

### Files to Modify (v0.3.5)

| File | Changes |
|------|---------|
| `src/SeniorIntern.Desktop/Views/MainWindow.axaml` | Add drag-drop, menus |
| `src/SeniorIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Add workspace settings |
| `src/SeniorIntern.Desktop/Views/StatusBar.axaml` | Add all segments |
| `src/SeniorIntern.Desktop/App.axaml.cs` | Restore workspace on startup |

### Testing Strategy (v0.3.5)
- End-to-end workspace flow tests
- Multi-file context tests
- Performance tests with large workspaces
- Drag-and-drop tests
- Keyboard shortcut coverage
- Settings persistence tests

---

## Architecture Summary

### Project Structure After v0.3.0

```
SeniorIntern/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ SeniorIntern.Core/
â”‚   â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatMessage.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ Conversation.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ AppSettings.cs (updated)
â”‚   â”‚   â”‚   â”œâ”€â”€ Workspace.cs                    [NEW]
â”‚   â”‚   â”‚   â”œâ”€â”€ FileSystemItem.cs               [NEW]
â”‚   â”‚   â”‚   â””â”€â”€ FileContext.cs                  [NEW]
â”‚   â”‚   â”œâ”€â”€ Entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ RecentWorkspaceEntity.cs        [NEW]
â”‚   â”‚   â”‚   â””â”€â”€ FileContextEntity.cs            [NEW]
â”‚   â”‚   â”œâ”€â”€ Interfaces/
â”‚   â”‚   â”‚   â”œâ”€â”€ IWorkspaceService.cs            [NEW]
â”‚   â”‚   â”‚   â””â”€â”€ IFileSystemService.cs           [NEW]
â”‚   â”‚   â”œâ”€â”€ Events/
â”‚   â”‚   â”‚   â””â”€â”€ WorkspaceEvents.cs              [NEW]
â”‚   â”‚   â””â”€â”€ Utilities/
â”‚   â”‚       â”œâ”€â”€ LanguageDetector.cs             [NEW]
â”‚   â”‚       â”œâ”€â”€ ContextFormatter.cs             [NEW]
â”‚   â”‚       â”œâ”€â”€ TokenEstimator.cs               [NEW]
â”‚   â”‚       â””â”€â”€ ContextLimits.cs                [NEW]
â”‚   â”‚
â”‚   â”œâ”€â”€ SeniorIntern.Data/
â”‚   â”‚   â”œâ”€â”€ Configurations/
â”‚   â”‚   â”‚   â”œâ”€â”€ RecentWorkspaceConfiguration.cs [NEW]
â”‚   â”‚   â”‚   â””â”€â”€ FileContextConfiguration.cs     [NEW]
â”‚   â”‚   â””â”€â”€ Repositories/
â”‚   â”‚       â”œâ”€â”€ IWorkspaceRepository.cs         [NEW]
â”‚   â”‚       â””â”€â”€ WorkspaceRepository.cs          [NEW]
â”‚   â”‚
â”‚   â”œâ”€â”€ SeniorIntern.Services/
â”‚   â”‚   â”œâ”€â”€ WorkspaceService.cs                 [NEW]
â”‚   â”‚   â””â”€â”€ FileSystemService.cs                [NEW]
â”‚   â”‚
â”‚   â””â”€â”€ SeniorIntern.Desktop/
â”‚       â”œâ”€â”€ ViewModels/
â”‚       â”‚   â”œâ”€â”€ FileExplorerViewModel.cs        [NEW]
â”‚       â”‚   â”œâ”€â”€ FileTreeItemViewModel.cs        [NEW]
â”‚       â”‚   â”œâ”€â”€ EditorPanelViewModel.cs         [NEW]
â”‚       â”‚   â”œâ”€â”€ EditorTabViewModel.cs           [NEW]
â”‚       â”‚   â”œâ”€â”€ FileContextViewModel.cs         [NEW]
â”‚       â”‚   â””â”€â”€ WorkspaceSettingsViewModel.cs   [NEW]
â”‚       â”œâ”€â”€ Views/
â”‚       â”‚   â”œâ”€â”€ FileExplorerView.axaml          [NEW]
â”‚       â”‚   â”œâ”€â”€ EditorPanel.axaml               [NEW]
â”‚       â”‚   â”œâ”€â”€ ChatContextBar.axaml            [NEW]
â”‚       â”‚   â”œâ”€â”€ ContextPreviewPopup.axaml       [NEW]
â”‚       â”‚   â”œâ”€â”€ WorkspaceSettingsPanel.axaml    [NEW]
â”‚       â”‚   â”œâ”€â”€ RecentWorkspacesMenu.axaml      [NEW]
â”‚       â”‚   â””â”€â”€ QuickOpenDialog.axaml           [NEW]
â”‚       â”œâ”€â”€ Services/
â”‚       â”‚   â”œâ”€â”€ SyntaxHighlightingService.cs    [NEW]
â”‚       â”‚   â””â”€â”€ EditorConfiguration.cs          [NEW]
â”‚       â”œâ”€â”€ Converters/
â”‚       â”‚   â”œâ”€â”€ FileIconConverter.cs            [NEW]
â”‚       â”‚   â””â”€â”€ LanguageIconConverter.cs        [NEW]
â”‚       â””â”€â”€ Assets/
â”‚           â””â”€â”€ FileIcons.axaml                 [NEW]
```

### New NuGet Packages (v0.3.0)

| Package | Version | Purpose |
|---------|---------|---------|
| AvaloniaEdit | 11.1.0 | Code editor |
| TextMateSharp | 1.0.x | TextMate grammars |
| TextMateSharp.Grammars | 1.0.x | Language definitions |

### Dependency Flow

```
SeniorIntern.Core (no dependencies)
       â†‘
SeniorIntern.Data (â†’ Core, EF Core)
       â†‘
SeniorIntern.Services (â†’ Core, Data, LLamaSharp)
       â†‘
SeniorIntern.Desktop (â†’ Core, Services, Avalonia, AvaloniaEdit)
```

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| AvaloniaEdit compatibility | Low | High | Test early, fallback to basic editor |
| Large file performance | Medium | Medium | Lazy loading, virtual scrolling |
| File watcher reliability | Medium | Low | Debounce events, manual refresh |
| Cross-platform path handling | Medium | Medium | Use Path.Combine, normalize paths |
| Context token overflow | Low | Medium | Hard limits, user warnings |
| Syntax highlighting lag | Medium | Low | Background processing, caching |

---

## Acceptance Criteria

### v0.3.1
- [ ] Workspace model and service implemented
- [ ] Recent workspaces persist across sessions
- [ ] File system service handles read/write
- [ ] Language detection works for common languages

### v0.3.2
- [ ] File explorer displays folder tree
- [ ] Files can be expanded/collapsed
- [ ] Context menu operations work
- [ ] .gitignore patterns are respected
- [ ] File filtering works

### v0.3.3
- [ ] AvaloniaEdit integrated and working
- [ ] Syntax highlighting for 10+ languages
- [ ] Multiple tabs supported
- [ ] Save/save all works
- [ ] Dirty state tracked correctly

### v0.3.4
- [ ] Files can be attached to chat
- [ ] Selection can be attached to chat
- [ ] Context displays in chat input
- [ ] Token estimation shown
- [ ] Context included in LLM prompt

### v0.3.5
- [ ] Multi-file context works
- [ ] Context limits enforced
- [ ] Workspace settings panel complete
- [ ] Drag-and-drop works
- [ ] All keyboard shortcuts work

---

## Timeline Estimate

| Version | Estimated Effort | Key Deliverables |
|---------|------------------|------------------|
| v0.3.1 | 2-3 days | Workspace service, file system service |
| v0.3.2 | 3-4 days | File explorer UI, tree view |
| v0.3.3 | 4-5 days | AvaloniaEdit, syntax highlighting, tabs |
| v0.3.4 | 2-3 days | Context attachment, token estimation |
| v0.3.5 | 2-3 days | Multi-file, settings, polish |
| **Total** | **13-18 days** | Complete v0.3.0 |

---

## References

- [AvaloniaEdit Documentation](https://github.com/AvaloniaUI/AvaloniaEdit)
- [TextMateSharp](https://github.com/danipen/TextMateSharp)
- [VSCode Language Identifiers](https://code.visualstudio.com/docs/languages/identifiers)
- [Avalonia TreeView](https://docs.avaloniaui.net/docs/controls/treeview)
- [File System Watcher Best Practices](https://docs.microsoft.com/en-us/dotnet/api/system.io.filesystemwatcher)
