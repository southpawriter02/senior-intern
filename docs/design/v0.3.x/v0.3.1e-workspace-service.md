# Design Specification: The Senior Intern v0.3.1e "Workspace Service"

## Executive Summary

This document provides a detailed implementation specification for v0.3.1e, which implements the workspace service for managing workspace lifecycle, state persistence, auto-save, and event notifications. This is the primary service layer for workspace operations.

### v0.3.1e Scope (from v0.3.1 Design Document)

- Create `IWorkspaceService` interface
- Implement workspace open/close operations
- Implement recent workspaces management (pin, rename, clear)
- Implement state management (open files, expanded folders)
- Implement auto-save timer (30 second interval)
- Implement workspace restoration on startup
- Create workspace event system

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| IWorkspaceService | Interface for workspace operations |
| WorkspaceService | Full implementation with auto-save |
| WorkspaceChangedEventArgs | Event data for open/close |
| WorkspaceStateChangedEventArgs | Event data for state changes |
| WorkspaceChangeType | Enum: Opened, Closed, Refreshed |
| WorkspaceStateChangeType | Enum: OpenFilesChanged, etc. |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.3.1e Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  IWorkspaceService                                                │
│  ├── Properties                                                   │
│  │   ├── CurrentWorkspace → Workspace?                           │
│  │   └── HasOpenWorkspace → bool                                 │
│  │                                                                │
│  ├── Workspace Operations                                         │
│  │   ├── OpenWorkspaceAsync(folderPath)                          │
│  │   │   ├── Normalize path to absolute                          │
│  │   │   ├── Close current workspace if any                      │
│  │   │   ├── Restore or create workspace                         │
│  │   │   ├── Load .gitignore patterns                            │
│  │   │   ├── Start file watcher                                  │
│  │   │   └── Raise WorkspaceChanged event                        │
│  │   │                                                            │
│  │   ├── CloseWorkspaceAsync()                                   │
│  │   │   ├── Save state before closing                           │
│  │   │   ├── Stop file watcher                                   │
│  │   │   └── Raise WorkspaceChanged event                        │
│  │   │                                                            │
│  │   ├── GetRecentWorkspacesAsync(count)                         │
│  │   │   ├── Filter out non-existent paths                       │
│  │   │   └── Clean up invalid entries in background             │
│  │   │                                                            │
│  │   ├── RemoveFromRecentAsync(workspaceId)                      │
│  │   ├── ClearRecentWorkspacesAsync()                            │
│  │   ├── SetPinnedAsync(workspaceId, isPinned)                   │
│  │   └── RenameWorkspaceAsync(workspaceId, newName)              │
│  │                                                                │
│  ├── State Management                                             │
│  │   ├── SaveWorkspaceStateAsync()                               │
│  │   ├── RestoreLastWorkspaceAsync()                             │
│  │   │   ├── Check settings.RestoreLastWorkspace                 │
│  │   │   └── Open most recent workspace if exists                │
│  │   │                                                            │
│  │   ├── UpdateOpenFiles(openFiles, activeFile)                  │
│  │   └── UpdateExpandedFolders(expandedFolders)                  │
│  │                                                                │
│  └── Events                                                       │
│      ├── WorkspaceChanged (EventHandler<WorkspaceChangedArgs>)   │
│      └── StateChanged (EventHandler<WorkspaceStateChangedArgs>)  │
│                                                                   │
│  Auto-Save Behavior                                               │
│  ├── 30-second timer interval                                     │
│  ├── Only saves if _stateChanged = true                          │
│  └── Resets flag after successful save                           │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Workspace Lifecycle

```
┌─────────────────────────────────────────────────────────────────┐
│                    Workspace Lifecycle                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Application Start                                               │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ 1. RestoreLastWorkspaceAsync()                             │  │
│  │    ├── Check settings.RestoreLastWorkspace = true?         │  │
│  │    ├── Get most recent workspace from repository           │  │
│  │    ├── Verify folder still exists                          │  │
│  │    └── OpenWorkspaceAsync(path) or return null             │  │
│  └────────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  User Interaction                                                │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ User selects folder → OpenWorkspaceAsync("/path/project")  │  │
│  │                                                             │  │
│  │ 1. await _lock.WaitAsync()     // Thread safety            │  │
│  │ 2. Close current workspace if any                          │  │
│  │ 3. Check repository for existing workspace by path         │  │
│  │ 4. Restore existing OR create new Workspace                │  │
│  │ 5. Load .gitignore patterns via IFileSystemService         │  │
│  │ 6. Save to repository                                      │  │
│  │ 7. Start FileSystemWatcher                                 │  │
│  │ 8. Set _currentWorkspace                                   │  │
│  │ 9. Raise WorkspaceChanged(Opened)                          │  │
│  │ 10. Release lock                                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  During Session                                                  │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ UpdateOpenFiles() / UpdateExpandedFolders()                │  │
│  │    ├── Update Workspace properties                         │  │
│  │    ├── Set _stateChanged = true                            │  │
│  │    └── Raise StateChanged event                            │  │
│  │                                                             │  │
│  │ Auto-Save Timer (every 30 seconds)                         │  │
│  │    ├── Check _stateChanged && _currentWorkspace != null    │  │
│  │    ├── SaveWorkspaceStateAsync()                           │  │
│  │    └── Set _stateChanged = false                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  Close Workspace                                                 │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ CloseWorkspaceAsync()                                      │  │
│  │ 1. Save state to repository                                │  │
│  │ 2. Dispose FileSystemWatcher                               │  │
│  │ 3. Set _currentWorkspace = null                            │  │
│  │ 4. Raise WorkspaceChanged(Closed)                          │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Event Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Event Flow Diagram                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  WorkspaceService                                                │
│       │                                                          │
│       │ OpenWorkspaceAsync()                                     │
│       ├─────────────────────────────────────────────────────────►│
│       │                                                          │
│       │  WorkspaceChanged event                                  │
│       │  ┌───────────────────────────────────────────────────┐   │
│       │  │ PreviousWorkspace: null (or previous)             │   │
│       │  │ CurrentWorkspace:  Workspace { RootPath, ... }    │   │
│       │  │ ChangeType:        WorkspaceChangeType.Opened     │   │
│       │  └───────────────────────────────────────────────────┘   │
│       │                                     │                    │
│       │                                     ▼                    │
│       │                    ┌────────────────────────────────┐    │
│       │                    │ MainWindowViewModel            │    │
│       │                    │   • Update title bar           │    │
│       │                    │   • Load file tree             │    │
│       │                    │   • Enable workspace commands  │    │
│       │                    └────────────────────────────────┘    │
│       │                                                          │
│       │ UpdateOpenFiles()                                        │
│       ├─────────────────────────────────────────────────────────►│
│       │                                                          │
│       │  StateChanged event                                      │
│       │  ┌───────────────────────────────────────────────────┐   │
│       │  │ Workspace:   current workspace                    │   │
│       │  │ ChangeType:  WorkspaceStateChangeType.OpenFiles   │   │
│       │  └───────────────────────────────────────────────────┘   │
│       │                                     │                    │
│       │                                     ▼                    │
│       │                    ┌────────────────────────────────┐    │
│       │                    │ EditorTabsViewModel            │    │
│       │                    │   • Sync tab state             │    │
│       │                    │   • Update active tab          │    │
│       │                    └────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Thread Safety Model

```
┌─────────────────────────────────────────────────────────────────┐
│                    Thread Safety Model                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SemaphoreSlim _lock (max: 1)                                    │
│                                                                  │
│  Protected Operations:                                           │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ OpenWorkspaceAsync()      ← acquires lock                  │  │
│  │ CloseWorkspaceAsync()     ← acquires lock                  │  │
│  │ SaveWorkspaceStateAsync() ← acquires lock                  │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Unprotected (UI thread only):                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ UpdateOpenFiles()         ← fast, synchronous              │  │
│  │ UpdateExpandedFolders()   ← fast, synchronous              │  │
│  │ CurrentWorkspace          ← read-only property             │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Background:                                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ Auto-save timer           ← calls SaveWorkspaceStateAsync  │  │
│  │ Cleanup invalid workspaces← Task.Run in background         │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
├── Interfaces/
│   └── IWorkspaceService.cs                          (NEW)
└── Events/
    └── WorkspaceEvents.cs                            (NEW)

src/SeniorIntern.Services/
└── WorkspaceService.cs                               (NEW)
```

---

## Implementation Details

### Task 1: Create IWorkspaceService Interface

**File:** `src/SeniorIntern.Core/Interfaces/IWorkspaceService.cs`

```csharp
namespace SeniorIntern.Core.Interfaces;

using SeniorIntern.Core.Events;
using SeniorIntern.Core.Models;

/// <summary>
/// Manages workspace lifecycle and state.
/// </summary>
public interface IWorkspaceService
{
    #region Properties

    /// <summary>The currently open workspace, or null if none.</summary>
    Workspace? CurrentWorkspace { get; }

    /// <summary>Whether a workspace is currently open.</summary>
    bool HasOpenWorkspace { get; }

    #endregion

    #region Workspace Operations

    /// <summary>Opens a workspace from a folder path.</summary>
    Task<Workspace> OpenWorkspaceAsync(
        string folderPath,
        CancellationToken cancellationToken = default);

    /// <summary>Closes the current workspace.</summary>
    Task CloseWorkspaceAsync();

    /// <summary>Gets the list of recently opened workspaces.</summary>
    Task<IReadOnlyList<Workspace>> GetRecentWorkspacesAsync(
        int count = 10,
        CancellationToken cancellationToken = default);

    /// <summary>Removes a workspace from the recent list.</summary>
    Task RemoveFromRecentAsync(Guid workspaceId);

    /// <summary>Clears all recent workspaces.</summary>
    Task ClearRecentWorkspacesAsync();

    /// <summary>Pins or unpins a workspace in the recent list.</summary>
    Task SetPinnedAsync(Guid workspaceId, bool isPinned);

    /// <summary>Updates the workspace custom name.</summary>
    Task RenameWorkspaceAsync(Guid workspaceId, string newName);

    #endregion

    #region State Management

    /// <summary>Saves the current workspace state to database.</summary>
    Task SaveWorkspaceStateAsync();

    /// <summary>Restores the last opened workspace on startup.</summary>
    Task<Workspace?> RestoreLastWorkspaceAsync();

    /// <summary>Updates the list of open files in the current workspace.</summary>
    void UpdateOpenFiles(IReadOnlyList<string> openFiles, string? activeFile);

    /// <summary>Updates the list of expanded folders in the file tree.</summary>
    void UpdateExpandedFolders(IReadOnlyList<string> expandedFolders);

    #endregion

    #region Events

    /// <summary>Raised when workspace changes (opened, closed, refreshed).</summary>
    event EventHandler<WorkspaceChangedEventArgs>? WorkspaceChanged;

    /// <summary>Raised when workspace state changes (files, folders).</summary>
    event EventHandler<WorkspaceStateChangedEventArgs>? StateChanged;

    #endregion
}
```

---

### Task 2: Create Workspace Events

**File:** `src/SeniorIntern.Core/Events/WorkspaceEvents.cs`

```csharp
namespace SeniorIntern.Core.Events;

using SeniorIntern.Core.Models;

/// <summary>Event args for workspace open/close/refresh events.</summary>
public sealed class WorkspaceChangedEventArgs : EventArgs
{
    /// <summary>Workspace before the change (null if opening first).</summary>
    public Workspace? PreviousWorkspace { get; init; }

    /// <summary>Workspace after the change (null if closing).</summary>
    public Workspace? CurrentWorkspace { get; init; }

    /// <summary>The type of change that occurred.</summary>
    public required WorkspaceChangeType ChangeType { get; init; }
}

/// <summary>Type of workspace change.</summary>
public enum WorkspaceChangeType
{
    /// <summary>A workspace was opened.</summary>
    Opened,

    /// <summary>The workspace was closed.</summary>
    Closed,

    /// <summary>The workspace was refreshed (files reloaded).</summary>
    Refreshed
}

/// <summary>Event args for workspace state changes.</summary>
public sealed class WorkspaceStateChangedEventArgs : EventArgs
{
    /// <summary>The workspace whose state changed.</summary>
    public required Workspace Workspace { get; init; }

    /// <summary>The type of state change.</summary>
    public required WorkspaceStateChangeType ChangeType { get; init; }
}

/// <summary>Type of workspace state change.</summary>
public enum WorkspaceStateChangeType
{
    /// <summary>Open files list changed.</summary>
    OpenFilesChanged,

    /// <summary>Active/focused file changed.</summary>
    ActiveFileChanged,

    /// <summary>Expanded folders in tree changed.</summary>
    ExpandedFoldersChanged
}
```

---

### Task 3: Create WorkspaceService Implementation

**File:** `src/SeniorIntern.Services/WorkspaceService.cs`

```csharp
namespace SeniorIntern.Services;

using Microsoft.Extensions.Logging;
using SeniorIntern.Core.Events;
using SeniorIntern.Core.Interfaces;
using SeniorIntern.Core.Models;
using SeniorIntern.Data.Repositories;

public sealed class WorkspaceService : IWorkspaceService, IDisposable
{
    private readonly IWorkspaceRepository _repository;
    private readonly IFileSystemService _fileSystemService;
    private readonly ISettingsService _settingsService;
    private readonly ILogger<WorkspaceService> _logger;

    private Workspace? _currentWorkspace;
    private IDisposable? _fileWatcher;
    private readonly SemaphoreSlim _lock = new(1, 1);
    private readonly System.Timers.Timer _autoSaveTimer;
    private bool _stateChanged;

    public Workspace? CurrentWorkspace => _currentWorkspace;
    public bool HasOpenWorkspace => _currentWorkspace != null;

    public event EventHandler<WorkspaceChangedEventArgs>? WorkspaceChanged;
    public event EventHandler<WorkspaceStateChangedEventArgs>? StateChanged;

    public WorkspaceService(
        IWorkspaceRepository repository,
        IFileSystemService fileSystemService,
        ISettingsService settingsService,
        ILogger<WorkspaceService> logger)
    {
        _repository = repository;
        _fileSystemService = fileSystemService;
        _settingsService = settingsService;
        _logger = logger;

        // Auto-save workspace state every 30 seconds
        _autoSaveTimer = new System.Timers.Timer(30_000);
        _autoSaveTimer.Elapsed += async (s, e) => await AutoSaveStateAsync();
        _autoSaveTimer.Start();
    }

    #region Workspace Operations

    public async Task<Workspace> OpenWorkspaceAsync(
        string folderPath,
        CancellationToken cancellationToken = default)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(folderPath);

        folderPath = Path.GetFullPath(folderPath);

        if (!Directory.Exists(folderPath))
            throw new DirectoryNotFoundException($"Folder not found: {folderPath}");

        await _lock.WaitAsync(cancellationToken);
        try
        {
            _logger.LogInformation("Opening workspace: {Path}", folderPath);

            // Close current workspace if any
            if (_currentWorkspace != null)
                await CloseWorkspaceInternalAsync();

            // Check if workspace exists in recent
            var existing = await _repository.GetByPathAsync(folderPath, cancellationToken);

            Workspace workspace;
            if (existing != null)
            {
                workspace = existing;
                workspace.LastAccessedAt = DateTime.UtcNow;
            }
            else
            {
                workspace = new Workspace
                {
                    RootPath = folderPath,
                    OpenedAt = DateTime.UtcNow,
                    LastAccessedAt = DateTime.UtcNow
                };
            }

            // Load .gitignore patterns
            var ignorePatterns = await _fileSystemService.LoadGitIgnorePatternsAsync(
                folderPath, cancellationToken);
            workspace.GitIgnorePatterns = ignorePatterns;

            // Save to recent
            await _repository.AddOrUpdateAsync(workspace, cancellationToken);

            // Start file watcher
            _fileWatcher = _fileSystemService.WatchDirectory(
                folderPath,
                OnFileSystemChange,
                includeSubdirectories: true);

            _currentWorkspace = workspace;

            // Raise event
            WorkspaceChanged?.Invoke(this, new WorkspaceChangedEventArgs
            {
                PreviousWorkspace = null,
                CurrentWorkspace = workspace,
                ChangeType = WorkspaceChangeType.Opened
            });

            _logger.LogInformation("Opened workspace: {Name} at {Path}",
                workspace.DisplayName, workspace.RootPath);

            return workspace;
        }
        finally
        {
            _lock.Release();
        }
    }

    public async Task CloseWorkspaceAsync()
    {
        await _lock.WaitAsync();
        try
        {
            await CloseWorkspaceInternalAsync();
        }
        finally
        {
            _lock.Release();
        }
    }

    private async Task CloseWorkspaceInternalAsync()
    {
        if (_currentWorkspace == null) return;

        _logger.LogInformation("Closing workspace: {Name}", _currentWorkspace.DisplayName);

        // Save state before closing
        await SaveWorkspaceStateInternalAsync();

        // Stop file watcher
        _fileWatcher?.Dispose();
        _fileWatcher = null;

        var previousWorkspace = _currentWorkspace;
        _currentWorkspace = null;

        // Raise event
        WorkspaceChanged?.Invoke(this, new WorkspaceChangedEventArgs
        {
            PreviousWorkspace = previousWorkspace,
            CurrentWorkspace = null,
            ChangeType = WorkspaceChangeType.Closed
        });
    }

    public async Task<IReadOnlyList<Workspace>> GetRecentWorkspacesAsync(
        int count = 10,
        CancellationToken cancellationToken = default)
    {
        var workspaces = await _repository.GetRecentAsync(count, cancellationToken);

        // Filter out workspaces that no longer exist
        var validWorkspaces = workspaces
            .Where(w => Directory.Exists(w.RootPath))
            .ToList();

        // Clean up invalid entries in background
        var invalidIds = workspaces
            .Where(w => !Directory.Exists(w.RootPath))
            .Select(w => w.Id)
            .ToList();

        if (invalidIds.Count > 0)
        {
            _ = Task.Run(async () =>
            {
                foreach (var id in invalidIds)
                    await _repository.RemoveAsync(id);
            });
        }

        return validWorkspaces;
    }

    public async Task RemoveFromRecentAsync(Guid workspaceId)
    {
        await _repository.RemoveAsync(workspaceId);
        _logger.LogInformation("Removed workspace from recent: {Id}", workspaceId);
    }

    public async Task ClearRecentWorkspacesAsync()
    {
        await _repository.ClearAllAsync();
        _logger.LogInformation("Cleared all recent workspaces");
    }

    public async Task SetPinnedAsync(Guid workspaceId, bool isPinned)
    {
        await _repository.SetPinnedAsync(workspaceId, isPinned);
        _logger.LogInformation("Set workspace {Id} pinned: {IsPinned}", workspaceId, isPinned);
    }

    public async Task RenameWorkspaceAsync(Guid workspaceId, string newName)
    {
        await _repository.RenameAsync(workspaceId, newName);
        _logger.LogInformation("Renamed workspace {Id} to: {Name}", workspaceId, newName);
    }

    #endregion

    #region State Management

    public async Task SaveWorkspaceStateAsync()
    {
        await _lock.WaitAsync();
        try
        {
            await SaveWorkspaceStateInternalAsync();
        }
        finally
        {
            _lock.Release();
        }
    }

    private async Task SaveWorkspaceStateInternalAsync()
    {
        if (_currentWorkspace == null) return;

        await _repository.AddOrUpdateAsync(_currentWorkspace);
        _stateChanged = false;
        _logger.LogDebug("Saved workspace state: {Name}", _currentWorkspace.DisplayName);
    }

    public async Task<Workspace?> RestoreLastWorkspaceAsync()
    {
        var settings = await _settingsService.GetSettingsAsync();

        if (!settings.RestoreLastWorkspace)
        {
            _logger.LogDebug("Workspace restoration disabled in settings");
            return null;
        }

        var recent = await _repository.GetRecentAsync(1);
        if (recent.Count == 0)
        {
            _logger.LogDebug("No recent workspaces to restore");
            return null;
        }

        var last = recent[0];
        if (!Directory.Exists(last.RootPath))
        {
            _logger.LogWarning("Last workspace no longer exists: {Path}", last.RootPath);
            return null;
        }

        _logger.LogInformation("Restoring last workspace: {Path}", last.RootPath);
        return await OpenWorkspaceAsync(last.RootPath);
    }

    public void UpdateOpenFiles(IReadOnlyList<string> openFiles, string? activeFile)
    {
        if (_currentWorkspace == null) return;

        _currentWorkspace.OpenFiles = openFiles;
        _currentWorkspace.ActiveFilePath = activeFile;
        _stateChanged = true;

        StateChanged?.Invoke(this, new WorkspaceStateChangedEventArgs
        {
            Workspace = _currentWorkspace,
            ChangeType = WorkspaceStateChangeType.OpenFilesChanged
        });
    }

    public void UpdateExpandedFolders(IReadOnlyList<string> expandedFolders)
    {
        if (_currentWorkspace == null) return;

        _currentWorkspace.ExpandedFolders = expandedFolders;
        _stateChanged = true;

        StateChanged?.Invoke(this, new WorkspaceStateChangedEventArgs
        {
            Workspace = _currentWorkspace,
            ChangeType = WorkspaceStateChangeType.ExpandedFoldersChanged
        });
    }

    private async Task AutoSaveStateAsync()
    {
        if (!_stateChanged || _currentWorkspace == null) return;

        try
        {
            await SaveWorkspaceStateAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to auto-save workspace state");
        }
    }

    #endregion

    #region File Watcher Handler

    private void OnFileSystemChange(FileSystemChangeEvent e)
    {
        _logger.LogDebug("File system change: {Type} - {Path}", e.ChangeType, e.Path);
        // Could raise an event here for UI file tree refresh
    }

    #endregion

    public void Dispose()
    {
        _autoSaveTimer.Stop();
        _autoSaveTimer.Dispose();
        _fileWatcher?.Dispose();
        _lock.Dispose();
    }
}
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| OpenWorkspaceAsync | 5 | New, existing, close previous |
| CloseWorkspaceAsync | 3 | Save state, dispose watcher |
| GetRecentWorkspacesAsync | 3 | Filter invalid, background cleanup |
| State Management | 4 | Update, auto-save, restore |
| Events | 4 | WorkspaceChanged, StateChanged |
| SetPinned/Rename | 2 | Repository calls |
| Thread Safety | 2 | Concurrent operations |
| **Total** | **23** | |

### Key Test Scenarios

```csharp
// Open Workspace
[Fact]
public async Task OpenWorkspaceAsync_NewWorkspace_CreatesAndSaves()
{
    var path = CreateTempDirectory();
    
    var workspace = await _service.OpenWorkspaceAsync(path);
    
    Assert.NotNull(workspace);
    Assert.Equal(path, workspace.RootPath);
    _mockRepository.Verify(r => r.AddOrUpdateAsync(It.IsAny<Workspace>(), It.IsAny<CancellationToken>()), Times.Once);
}

[Fact]
public async Task OpenWorkspaceAsync_ExistingWorkspace_RestoresState()
{
    var existing = new Workspace { RootPath = "/project", OpenFiles = ["file.cs"] };
    _mockRepository.Setup(r => r.GetByPathAsync(It.IsAny<string>(), It.IsAny<CancellationToken>()))
        .ReturnsAsync(existing);

    var workspace = await _service.OpenWorkspaceAsync("/project");

    Assert.Single(workspace.OpenFiles);
    Assert.Equal("file.cs", workspace.OpenFiles[0]);
}

[Fact]
public async Task OpenWorkspaceAsync_RaisesWorkspaceChangedEvent()
{
    WorkspaceChangedEventArgs? eventArgs = null;
    _service.WorkspaceChanged += (s, e) => eventArgs = e;
    
    await _service.OpenWorkspaceAsync(CreateTempDirectory());
    
    Assert.NotNull(eventArgs);
    Assert.Equal(WorkspaceChangeType.Opened, eventArgs.ChangeType);
    Assert.NotNull(eventArgs.CurrentWorkspace);
}

// Close Workspace
[Fact]
public async Task CloseWorkspaceAsync_SavesStateBeforeClosing()
{
    await _service.OpenWorkspaceAsync(CreateTempDirectory());
    _service.UpdateOpenFiles(["file.cs"], "file.cs");
    
    await _service.CloseWorkspaceAsync();
    
    _mockRepository.Verify(r => r.AddOrUpdateAsync(
        It.Is<Workspace>(w => w.OpenFiles.Contains("file.cs")),
        It.IsAny<CancellationToken>()));
}

// Recent Workspaces
[Fact]
public async Task GetRecentWorkspacesAsync_FiltersNonExistentPaths()
{
    var workspaces = new[]
    {
        new Workspace { RootPath = "/exists" },
        new Workspace { RootPath = "/does-not-exist" }
    };
    _mockRepository.Setup(r => r.GetRecentAsync(It.IsAny<int>(), It.IsAny<CancellationToken>()))
        .ReturnsAsync(workspaces);
    Directory.CreateDirectory("/exists"); // Mock this

    var result = await _service.GetRecentWorkspacesAsync();
    
    Assert.Single(result);
    Assert.Equal("/exists", result[0].RootPath);
}

// State Updates
[Fact]
public void UpdateOpenFiles_SetsStateChangedFlag_AndRaisesEvent()
{
    _service.OpenWorkspaceAsync(CreateTempDirectory()).Wait();
    WorkspaceStateChangedEventArgs? eventArgs = null;
    _service.StateChanged += (s, e) => eventArgs = e;

    _service.UpdateOpenFiles(["new.cs"], "new.cs");

    Assert.Equal(WorkspaceStateChangeType.OpenFilesChanged, eventArgs?.ChangeType);
}

// Auto-Save (integration test)
[Fact]
public async Task AutoSave_OnlyTriggersWhenStateChanged()
{
    // Would need to expose internals or use reflection
    // Or test via timer callback
}
```

---

## Files Summary

### Files to Create (3)

| File | Lines (approx) |
|------|----------------|
| `Interfaces/IWorkspaceService.cs` | 80 |
| `Events/WorkspaceEvents.cs` | 60 |
| `Services/WorkspaceService.cs` | 250 |

### Files to Modify (0)

No files need modification for v0.3.1e.

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | OpenWorkspaceAsync creates or restores workspace |
| AC-2 | OpenWorkspaceAsync closes previous workspace first |
| AC-3 | OpenWorkspaceAsync starts file watcher |
| AC-4 | CloseWorkspaceAsync saves state before closing |
| AC-5 | GetRecentWorkspacesAsync filters non-existent paths |
| AC-6 | Auto-save triggers every 30 seconds when changed |
| AC-7 | RestoreLastWorkspaceAsync respects settings |
| AC-8 | WorkspaceChanged event fires on open/close |
| AC-9 | StateChanged event fires on state updates |
| AC-10 | Thread-safe operations with SemaphoreSlim |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| 30-second auto-save | Balance between data safety and I/O |
| Dirty flag pattern | Avoid unnecessary saves |
| SemaphoreSlim | Async-compatible locking |
| Background cleanup | Don't block UI for stale entries |
| Events for state changes | Decouple UI updates from service |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.1a | Workspace model |
| v0.3.1d | IFileSystemService for watching and gitignore |
| v0.3.1f | IWorkspaceRepository for persistence |
| Existing | ISettingsService for RestoreLastWorkspace |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.1e | 1 day |
