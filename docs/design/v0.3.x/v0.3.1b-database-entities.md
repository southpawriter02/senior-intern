# Design Specification: The Senior Intern v0.3.1b "Database Entities"

## Executive Summary

This document provides a detailed implementation specification for v0.3.1b, which creates the database entities and migrations for persisting workspace and file context data. These entities enable storing recent workspaces with their UI state and tracking file content attached to chat messages.

### v0.3.1b Scope (from v0.3.1 Design Document)

- Create `RecentWorkspaceEntity` for workspace persistence
- Create `FileContextEntity` for file context history
- Create EF Core configurations for both entities
- Create database migration for new tables
- Update DbContext with new DbSets

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| RecentWorkspaceEntity | Database entity for workspace state |
| FileContextEntity | Database entity for file attachments |
| RecentWorkspaceConfiguration | EF Core fluent configuration |
| FileContextConfiguration | EF Core fluent configuration |
| AddWorkspaceEntities Migration | Database schema migration |

---

## Feature Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     v0.3.1b Feature Tree                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  RecentWorkspaceEntity (Table: RecentWorkspaces)                  │
│  ├── Columns                                                      │
│  │   ├── Id (Guid, PK)                                            │
│  │   ├── Name (string?, 256) - custom workspace name             │
│  │   ├── RootPath (string, 1024, UNIQUE) - absolute path         │
│  │   ├── LastAccessedAt (DateTime, INDEX DESC)                   │
│  │   ├── OpenFilesJson (TEXT) - JSON array of relative paths     │
│  │   ├── ActiveFilePath (string?, 1024) - current file          │
│  │   ├── ExpandedFoldersJson (TEXT) - JSON array                 │
│  │   └── IsPinned (bool, default: false)                         │
│  │                                                                │
│  └── Methods                                                      │
│      ├── ToWorkspace() → Workspace                                │
│      └── FromWorkspace(workspace) → RecentWorkspaceEntity         │
│                                                                   │
│  FileContextEntity (Table: FileContextHistory)                    │
│  ├── Columns                                                      │
│  │   ├── Id (Guid, PK)                                            │
│  │   ├── ConversationId (Guid, FK, INDEX)                        │
│  │   ├── MessageId (Guid, FK, INDEX)                             │
│  │   ├── FilePath (string, 1024) - absolute path                 │
│  │   ├── FileName (string, 256) - for display                    │
│  │   ├── Language (string?, 50)                                   │
│  │   ├── ContentHash (string, 64) - SHA256 prefix                │
│  │   ├── LineCount (int)                                          │
│  │   ├── EstimatedTokens (int)                                    │
│  │   ├── StartLine (int?) - for selections                       │
│  │   ├── EndLine (int?) - for selections                         │
│  │   └── AttachedAt (DateTime, INDEX)                            │
│  │                                                                │
│  └── Navigation Properties                                        │
│      ├── Conversation → ConversationEntity (CASCADE)             │
│      └── Message → MessageEntity (CASCADE)                       │
│                                                                   │
│  Indexes                                                          │
│  ├── RecentWorkspaces                                             │
│  │   ├── IX_RecentWorkspaces_RootPath (UNIQUE)                   │
│  │   └── IX_RecentWorkspaces_LastAccessedAt (DESC)               │
│  │                                                                │
│  └── FileContextHistory                                           │
│      ├── IX_FileContextHistory_ConversationId                    │
│      ├── IX_FileContextHistory_MessageId                         │
│      └── IX_FileContextHistory_AttachedAt                        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagrams

### Database Schema

```
┌─────────────────────────────────────────────────────────────────┐
│                      Database Schema                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ RecentWorkspaces                                           │   │
│  ├───────────────────────────────────────────────────────────┤   │
│  │ Id               GUID        PK                            │   │
│  │ Name             TEXT(256)   NULL                          │   │
│  │ RootPath         TEXT(1024)  NOT NULL, UNIQUE              │   │
│  │ LastAccessedAt   TEXT        NOT NULL   ──┐ INDEX DESC     │   │
│  │ OpenFilesJson    TEXT        NULL         │                │   │
│  │ ActiveFilePath   TEXT(1024)  NULL         │                │   │
│  │ ExpandedFoldersJson TEXT     NULL         │                │   │
│  │ IsPinned         INTEGER     DEFAULT 0    │                │   │
│  └───────────────────────────────────────────┴───────────────┘   │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ FileContextHistory                                         │   │
│  ├───────────────────────────────────────────────────────────┤   │
│  │ Id               GUID        PK                            │   │
│  │ ConversationId   GUID        FK → Conversations ──┐ INDEX  │   │
│  │ MessageId        GUID        FK → Messages ───────┤ INDEX  │   │
│  │ FilePath         TEXT(1024)  NOT NULL             │        │   │
│  │ FileName         TEXT(256)   NOT NULL             │        │   │
│  │ Language         TEXT(50)    NULL                 │        │   │
│  │ ContentHash      TEXT(64)    NOT NULL             │        │   │
│  │ LineCount        INTEGER     NOT NULL             │        │   │
│  │ EstimatedTokens  INTEGER     NOT NULL             │        │   │
│  │ StartLine        INTEGER     NULL                 │        │   │
│  │ EndLine          INTEGER     NULL                 │        │   │
│  │ AttachedAt       TEXT        NOT NULL   ──────────┴ INDEX  │   │
│  └───────────────────────────────────────────────────────────┘   │
│                           │                                      │
│                           │ FK (CASCADE)                         │
│                           ▼                                      │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Conversations (existing)                                   │   │
│  ├───────────────────────────────────────────────────────────┤   │
│  │ Id               GUID        PK                            │   │
│  │ Title            TEXT        ...                           │   │
│  │ ...                                                        │   │
│  └───────────────────────────────────────────────────────────┘   │
│                           │                                      │
│                           │ FK (CASCADE)                         │
│                           ▼                                      │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Messages (existing)                                        │   │
│  ├───────────────────────────────────────────────────────────┤   │
│  │ Id               GUID        PK                            │   │
│  │ ConversationId   GUID        FK                            │   │
│  │ Content          TEXT        ...                           │   │
│  │ ...                                                        │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Entity Mapping Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Entity Mapping Flow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Domain Model              Entity              Database          │
│                                                                  │
│  ┌──────────────┐     ┌──────────────────┐    ┌────────────┐    │
│  │  Workspace   │────►│ RecentWorkspace  │───►│ Recent     │    │
│  │              │     │ Entity           │    │ Workspaces │    │
│  │ .OpenFiles   │     │ .OpenFilesJson   │    │ (TABLE)    │    │
│  │ (List<str>)  │     │ (JSON string)    │    │            │    │
│  └──────────────┘     └──────────────────┘    └────────────┘    │
│         ▲                     │                                  │
│         │                     │                                  │
│         └─────────────────────┘                                  │
│           ToWorkspace() / FromWorkspace()                        │
│                                                                  │
│  ┌──────────────┐     ┌──────────────────┐    ┌────────────┐    │
│  │  FileContext │────►│ FileContext      │───►│ FileContext│    │
│  │              │     │ Entity           │    │ History    │    │
│  │              │     │                  │    │ (TABLE)    │    │
│  │ (no Content) │     │ (no Content)     │    │            │    │
│  └──────────────┘     └──────────────────┘    └────────────┘    │
│                                                                  │
│  Note: FileContext.Content is NOT persisted to database.         │
│  Only metadata is stored; content must be re-read from file.     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
src/SeniorIntern.Core/
└── Entities/
    ├── RecentWorkspaceEntity.cs                      (NEW)
    └── FileContextEntity.cs                          (NEW)

src/SeniorIntern.Data/
├── Configurations/
│   ├── RecentWorkspaceConfiguration.cs               (NEW)
│   └── FileContextConfiguration.cs                   (NEW)
├── Migrations/
│   └── XXXXXXXX_AddWorkspaceEntities.cs              (NEW)
└── SeniorInternDbContext.cs                          (UPDATE)
```

---

## Implementation Details

### Task 1: Create RecentWorkspaceEntity

**File:** `src/SeniorIntern.Core/Entities/RecentWorkspaceEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

using SeniorIntern.Core.Models;
using System.Text.Json;

/// <summary>
/// Database entity for storing recent workspace information.
/// </summary>
public sealed class RecentWorkspaceEntity
{
    /// <summary>Unique identifier.</summary>
    public Guid Id { get; set; }

    /// <summary>Optional custom name for the workspace.</summary>
    public string? Name { get; set; }

    /// <summary>Absolute path to workspace root. Must be unique.</summary>
    public required string RootPath { get; set; }

    /// <summary>When the workspace was last accessed.</summary>
    public DateTime LastAccessedAt { get; set; }

    /// <summary>JSON array of open file paths (relative to RootPath).</summary>
    public string? OpenFilesJson { get; set; }

    /// <summary>Currently active file path (relative to RootPath).</summary>
    public string? ActiveFilePath { get; set; }

    /// <summary>JSON array of expanded folder paths (relative to RootPath).</summary>
    public string? ExpandedFoldersJson { get; set; }

    /// <summary>Whether this workspace is pinned in the recent list.</summary>
    public bool IsPinned { get; set; }

    /// <summary>Converts entity to domain model.</summary>
    public Workspace ToWorkspace()
    {
        return new Workspace
        {
            Id = Id,
            Name = Name ?? string.Empty,
            RootPath = RootPath,
            LastAccessedAt = LastAccessedAt,
            OpenFiles = DeserializeStringList(OpenFilesJson),
            ActiveFilePath = ActiveFilePath,
            ExpandedFolders = DeserializeStringList(ExpandedFoldersJson),
            IsPinned = IsPinned
        };
    }

    /// <summary>Creates entity from domain model.</summary>
    public static RecentWorkspaceEntity FromWorkspace(Workspace workspace)
    {
        return new RecentWorkspaceEntity
        {
            Id = workspace.Id,
            Name = string.IsNullOrWhiteSpace(workspace.Name) ? null : workspace.Name,
            RootPath = workspace.RootPath,
            LastAccessedAt = workspace.LastAccessedAt,
            OpenFilesJson = SerializeStringList(workspace.OpenFiles),
            ActiveFilePath = workspace.ActiveFilePath,
            ExpandedFoldersJson = SerializeStringList(workspace.ExpandedFolders),
            IsPinned = workspace.IsPinned
        };
    }

    /// <summary>Updates entity from domain model (preserves Id).</summary>
    public void UpdateFrom(Workspace workspace)
    {
        Name = string.IsNullOrWhiteSpace(workspace.Name) ? null : workspace.Name;
        LastAccessedAt = workspace.LastAccessedAt;
        OpenFilesJson = SerializeStringList(workspace.OpenFiles);
        ActiveFilePath = workspace.ActiveFilePath;
        ExpandedFoldersJson = SerializeStringList(workspace.ExpandedFolders);
        IsPinned = workspace.IsPinned;
    }

    private static string? SerializeStringList(IReadOnlyList<string> list)
    {
        if (list.Count == 0) return null;
        return JsonSerializer.Serialize(list);
    }

    private static IReadOnlyList<string> DeserializeStringList(string? json)
    {
        if (string.IsNullOrEmpty(json)) return [];
        try
        {
            return JsonSerializer.Deserialize<List<string>>(json) ?? [];
        }
        catch
        {
            return [];
        }
    }
}
```

---

### Task 2: Create FileContextEntity

**File:** `src/SeniorIntern.Core/Entities/FileContextEntity.cs`

```csharp
namespace SeniorIntern.Core.Entities;

using SeniorIntern.Core.Models;

/// <summary>
/// Database entity for file context history attached to messages.
/// Note: File content is NOT stored; only metadata for reference.
/// </summary>
public sealed class FileContextEntity
{
    /// <summary>Unique identifier.</summary>
    public Guid Id { get; set; }

    /// <summary>The conversation this context belongs to.</summary>
    public Guid ConversationId { get; set; }

    /// <summary>The message this context was attached to.</summary>
    public Guid MessageId { get; set; }

    /// <summary>Absolute file path at time of attachment.</summary>
    public required string FilePath { get; set; }

    /// <summary>File name (preserved for display if file moves/deletes).</summary>
    public required string FileName { get; set; }

    /// <summary>Detected programming language.</summary>
    public string? Language { get; set; }

    /// <summary>Hash of content at time of attachment.</summary>
    public required string ContentHash { get; set; }

    /// <summary>Line count of attached content.</summary>
    public int LineCount { get; set; }

    /// <summary>Estimated token count.</summary>
    public int EstimatedTokens { get; set; }

    /// <summary>Starting line if partial content (1-indexed).</summary>
    public int? StartLine { get; set; }

    /// <summary>Ending line if partial content (1-indexed, inclusive).</summary>
    public int? EndLine { get; set; }

    /// <summary>When the context was attached.</summary>
    public DateTime AttachedAt { get; set; }

    // Navigation properties
    public ConversationEntity? Conversation { get; set; }
    public MessageEntity? Message { get; set; }

    /// <summary>Whether this was a partial file (selection).</summary>
    public bool IsPartialContent => StartLine.HasValue || EndLine.HasValue;

    /// <summary>Display label for UI.</summary>
    public string DisplayLabel => IsPartialContent
        ? $"{FileName} (lines {StartLine}-{EndLine})"
        : FileName;

    /// <summary>Creates entity from FileContext domain model.</summary>
    public static FileContextEntity FromFileContext(
        FileContext context,
        Guid conversationId,
        Guid messageId)
    {
        return new FileContextEntity
        {
            Id = context.Id,
            ConversationId = conversationId,
            MessageId = messageId,
            FilePath = context.FilePath,
            FileName = context.FileName,
            Language = context.Language,
            ContentHash = context.ContentHash,
            LineCount = context.LineCount,
            EstimatedTokens = context.EstimatedTokens,
            StartLine = context.StartLine,
            EndLine = context.EndLine,
            AttachedAt = context.AttachedAt
        };
    }

    /// <summary>
    /// Creates a FileContext stub (without content).
    /// Use IFileSystemService to reload content if needed.
    /// </summary>
    public FileContextStub ToFileContextStub()
    {
        return new FileContextStub
        {
            Id = Id,
            FilePath = FilePath,
            FileName = FileName,
            Language = Language,
            ContentHash = ContentHash,
            LineCount = LineCount,
            EstimatedTokens = EstimatedTokens,
            StartLine = StartLine,
            EndLine = EndLine,
            AttachedAt = AttachedAt
        };
    }
}

/// <summary>
/// Lightweight representation of FileContext without content.
/// Used when loading history where content must be re-read from disk.
/// </summary>
public sealed class FileContextStub
{
    public Guid Id { get; init; }
    public required string FilePath { get; init; }
    public required string FileName { get; init; }
    public string? Language { get; init; }
    public required string ContentHash { get; init; }
    public int LineCount { get; init; }
    public int EstimatedTokens { get; init; }
    public int? StartLine { get; init; }
    public int? EndLine { get; init; }
    public DateTime AttachedAt { get; init; }

    public bool IsPartialContent => StartLine.HasValue || EndLine.HasValue;
    public string DisplayLabel => IsPartialContent
        ? $"{FileName} (lines {StartLine}-{EndLine})"
        : FileName;

    /// <summary>Whether the file still exists on disk.</summary>
    public bool FileExists => File.Exists(FilePath);
}
```

---

### Task 3: Create RecentWorkspaceConfiguration

**File:** `src/SeniorIntern.Data/Configurations/RecentWorkspaceConfiguration.cs`

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

public sealed class RecentWorkspaceConfiguration : IEntityTypeConfiguration<RecentWorkspaceEntity>
{
    public void Configure(EntityTypeBuilder<RecentWorkspaceEntity> builder)
    {
        builder.ToTable("RecentWorkspaces");

        builder.HasKey(e => e.Id);

        // RootPath must be unique (can't have same workspace twice)
        builder.Property(e => e.RootPath)
            .IsRequired()
            .HasMaxLength(1024);

        builder.HasIndex(e => e.RootPath)
            .IsUnique();

        // Index for sorting by most recently accessed
        builder.HasIndex(e => e.LastAccessedAt)
            .IsDescending();

        builder.Property(e => e.Name)
            .HasMaxLength(256);

        builder.Property(e => e.ActiveFilePath)
            .HasMaxLength(1024);

        // JSON columns stored as TEXT
        builder.Property(e => e.OpenFilesJson)
            .HasColumnType("TEXT");

        builder.Property(e => e.ExpandedFoldersJson)
            .HasColumnType("TEXT");

        builder.Property(e => e.IsPinned)
            .HasDefaultValue(false);
    }
}
```

---

### Task 4: Create FileContextConfiguration

**File:** `src/SeniorIntern.Data/Configurations/FileContextConfiguration.cs`

```csharp
namespace SeniorIntern.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using SeniorIntern.Core.Entities;

public sealed class FileContextConfiguration : IEntityTypeConfiguration<FileContextEntity>
{
    public void Configure(EntityTypeBuilder<FileContextEntity> builder)
    {
        builder.ToTable("FileContextHistory");

        builder.HasKey(e => e.Id);

        builder.Property(e => e.FilePath)
            .IsRequired()
            .HasMaxLength(1024);

        builder.Property(e => e.FileName)
            .IsRequired()
            .HasMaxLength(256);

        builder.Property(e => e.Language)
            .HasMaxLength(50);

        builder.Property(e => e.ContentHash)
            .IsRequired()
            .HasMaxLength(64);

        // Indexes for querying
        builder.HasIndex(e => e.ConversationId);
        builder.HasIndex(e => e.MessageId);
        builder.HasIndex(e => e.AttachedAt);

        // Foreign key relationships with cascade delete
        builder.HasOne(e => e.Conversation)
            .WithMany()
            .HasForeignKey(e => e.ConversationId)
            .OnDelete(DeleteBehavior.Cascade);

        builder.HasOne(e => e.Message)
            .WithMany()
            .HasForeignKey(e => e.MessageId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}
```

---

### Task 5: Create Migration

**File:** `src/SeniorIntern.Data/Migrations/XXXXXXXX_AddWorkspaceEntities.cs`

```csharp
namespace SeniorIntern.Data.Migrations;

using Microsoft.EntityFrameworkCore.Migrations;

public partial class AddWorkspaceEntities : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // Create RecentWorkspaces table
        migrationBuilder.CreateTable(
            name: "RecentWorkspaces",
            columns: table => new
            {
                Id = table.Column<Guid>(type: "TEXT", nullable: false),
                Name = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),
                RootPath = table.Column<string>(type: "TEXT", maxLength: 1024, nullable: false),
                LastAccessedAt = table.Column<DateTime>(type: "TEXT", nullable: false),
                OpenFilesJson = table.Column<string>(type: "TEXT", nullable: true),
                ActiveFilePath = table.Column<string>(type: "TEXT", maxLength: 1024, nullable: true),
                ExpandedFoldersJson = table.Column<string>(type: "TEXT", nullable: true),
                IsPinned = table.Column<bool>(type: "INTEGER", nullable: false, defaultValue: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_RecentWorkspaces", x => x.Id);
            });

        migrationBuilder.CreateIndex(
            name: "IX_RecentWorkspaces_RootPath",
            table: "RecentWorkspaces",
            column: "RootPath",
            unique: true);

        migrationBuilder.CreateIndex(
            name: "IX_RecentWorkspaces_LastAccessedAt",
            table: "RecentWorkspaces",
            column: "LastAccessedAt",
            descending: new[] { true });

        // Create FileContextHistory table
        migrationBuilder.CreateTable(
            name: "FileContextHistory",
            columns: table => new
            {
                Id = table.Column<Guid>(type: "TEXT", nullable: false),
                ConversationId = table.Column<Guid>(type: "TEXT", nullable: false),
                MessageId = table.Column<Guid>(type: "TEXT", nullable: false),
                FilePath = table.Column<string>(type: "TEXT", maxLength: 1024, nullable: false),
                FileName = table.Column<string>(type: "TEXT", maxLength: 256, nullable: false),
                Language = table.Column<string>(type: "TEXT", maxLength: 50, nullable: true),
                ContentHash = table.Column<string>(type: "TEXT", maxLength: 64, nullable: false),
                LineCount = table.Column<int>(type: "INTEGER", nullable: false),
                EstimatedTokens = table.Column<int>(type: "INTEGER", nullable: false),
                StartLine = table.Column<int>(type: "INTEGER", nullable: true),
                EndLine = table.Column<int>(type: "INTEGER", nullable: true),
                AttachedAt = table.Column<DateTime>(type: "TEXT", nullable: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_FileContextHistory", x => x.Id);
                table.ForeignKey(
                    name: "FK_FileContextHistory_Conversations_ConversationId",
                    column: x => x.ConversationId,
                    principalTable: "Conversations",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
                table.ForeignKey(
                    name: "FK_FileContextHistory_Messages_MessageId",
                    column: x => x.MessageId,
                    principalTable: "Messages",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateIndex(
            name: "IX_FileContextHistory_ConversationId",
            table: "FileContextHistory",
            column: "ConversationId");

        migrationBuilder.CreateIndex(
            name: "IX_FileContextHistory_MessageId",
            table: "FileContextHistory",
            column: "MessageId");

        migrationBuilder.CreateIndex(
            name: "IX_FileContextHistory_AttachedAt",
            table: "FileContextHistory",
            column: "AttachedAt");
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropTable(name: "FileContextHistory");
        migrationBuilder.DropTable(name: "RecentWorkspaces");
    }
}
```

---

### Task 6: Update DbContext

**File:** `src/SeniorIntern.Data/SeniorInternDbContext.cs` (add to existing)

```csharp
// Add to SeniorInternDbContext class

public DbSet<RecentWorkspaceEntity> RecentWorkspaces => Set<RecentWorkspaceEntity>();
public DbSet<FileContextEntity> FileContextHistory => Set<FileContextEntity>();

// In OnModelCreating, add:
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);
    
    // ... existing configurations ...
    
    modelBuilder.ApplyConfiguration(new RecentWorkspaceConfiguration());
    modelBuilder.ApplyConfiguration(new FileContextConfiguration());
}
```

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| RecentWorkspaceEntity | 4 | ToWorkspace, FromWorkspace, JSON |
| FileContextEntity | 3 | FromFileContext, ToFileContextStub |
| Configurations | 4 | Index creation, FK constraints |
| Migration | 2 | Up creates tables, Down drops |
| **Total** | **13** | |

### Key Test Scenarios

```csharp
// RecentWorkspaceEntity Tests
[Fact]
public void ToWorkspace_DeserializesOpenFiles()
{
    var entity = new RecentWorkspaceEntity
    {
        Id = Guid.NewGuid(),
        RootPath = "/project",
        OpenFilesJson = "[\"src/file1.cs\",\"src/file2.cs\"]",
        LastAccessedAt = DateTime.UtcNow
    };

    var workspace = entity.ToWorkspace();

    Assert.Equal(2, workspace.OpenFiles.Count);
    Assert.Contains("src/file1.cs", workspace.OpenFiles);
}

[Fact]
public void FromWorkspace_SerializesOpenFiles()
{
    var workspace = new Workspace
    {
        RootPath = "/project",
        OpenFiles = ["file1.cs", "file2.cs"]
    };

    var entity = RecentWorkspaceEntity.FromWorkspace(workspace);

    Assert.NotNull(entity.OpenFilesJson);
    Assert.Contains("file1.cs", entity.OpenFilesJson);
}

[Fact]
public void ToWorkspace_HandlesNullJson()
{
    var entity = new RecentWorkspaceEntity
    {
        Id = Guid.NewGuid(),
        RootPath = "/project",
        OpenFilesJson = null,
        ExpandedFoldersJson = null,
        LastAccessedAt = DateTime.UtcNow
    };

    var workspace = entity.ToWorkspace();

    Assert.Empty(workspace.OpenFiles);
    Assert.Empty(workspace.ExpandedFolders);
}

// FileContextEntity Tests
[Fact]
public void FromFileContext_MapsAllProperties()
{
    var context = FileContext.FromFile("/path/test.cs", "content here");
    var conversationId = Guid.NewGuid();
    var messageId = Guid.NewGuid();

    var entity = FileContextEntity.FromFileContext(context, conversationId, messageId);

    Assert.Equal(context.Id, entity.Id);
    Assert.Equal(conversationId, entity.ConversationId);
    Assert.Equal(messageId, entity.MessageId);
    Assert.Equal("test.cs", entity.FileName);
}

[Fact]
public void ToFileContextStub_CreatesLightweightObject()
{
    var entity = new FileContextEntity
    {
        Id = Guid.NewGuid(),
        FilePath = "/path/test.cs",
        FileName = "test.cs",
        ContentHash = "ABC123",
        LineCount = 50,
        EstimatedTokens = 100,
        StartLine = 10,
        EndLine = 25,
        AttachedAt = DateTime.UtcNow
    };

    var stub = entity.ToFileContextStub();

    Assert.True(stub.IsPartialContent);
    Assert.Equal("test.cs (lines 10-25)", stub.DisplayLabel);
}
```

---

## Files Summary

### Files to Create (5)

| File | Lines (approx) |
|------|----------------|
| `Entities/RecentWorkspaceEntity.cs` | 90 |
| `Entities/FileContextEntity.cs` | 120 |
| `Configurations/RecentWorkspaceConfiguration.cs` | 40 |
| `Configurations/FileContextConfiguration.cs` | 45 |
| `Migrations/XXXXXXXX_AddWorkspaceEntities.cs` | 100 |

### Files to Modify (1)

| File | Changes |
|------|---------|
| `SeniorInternDbContext.cs` | Add DbSets, apply configurations |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | RecentWorkspaceEntity serializes OpenFiles to JSON |
| AC-2 | RecentWorkspaceEntity deserializes JSON to list |
| AC-3 | RootPath has unique constraint |
| AC-4 | LastAccessedAt has descending index |
| AC-5 | FileContextEntity has FK to Conversations |
| AC-6 | FileContextEntity has FK to Messages |
| AC-7 | Cascade delete removes file contexts with message |
| AC-8 | FileContextStub provides lightweight representation |
| AC-9 | Migration creates both tables with indexes |
| AC-10 | Migration Down drops tables in correct order |

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| JSON for OpenFiles/ExpandedFolders | Flexible array storage, no join table |
| No Content in FileContextEntity | Avoid storing large blobs; re-read from disk |
| FileContextStub | Lightweight for history queries |
| Cascade delete | Clean up contexts when conversation/message deleted |
| Unique RootPath | Prevent duplicate workspace entries |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.1a | Workspace model (for entity mapping) |
| v0.3.1a | FileContext model (for entity mapping) |
| v0.2.1 | ConversationEntity, MessageEntity (FK targets) |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.1b | 0.5 day |
