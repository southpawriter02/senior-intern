# Design Specification: The Senior Intern v0.3.4e "Context Preview"

## Executive Summary

This document provides a detailed implementation specification for v0.3.4e, which implements the `ContextPreviewPopup` - a modal popup that displays the full content of an attached context with syntax highlighting, metadata, and action buttons. This allows users to review attached content before sending their message.

### v0.3.4e Scope

- Create `ContextPreviewPopup.axaml` with header, content, and footer
- Create `ContextPreviewPopup.axaml.cs` with command handling
- Integrate AvaloniaEdit for syntax-highlighted read-only preview
- Implement "Open in Editor", "Copy", and "Remove" actions
- Add modal backdrop with click-to-close
- Integrate preview overlay into ChatView
- Handle Escape key to close preview

### Key Deliverables

| Deliverable | Description |
|-------------|-------------|
| ContextPreviewPopup.axaml | Main preview popup UI |
| ContextPreviewPopup.axaml.cs | Code-behind with commands |
| Preview overlay in ChatView | Modal backdrop and positioning |
| Syntax highlighting | TextMate-based code coloring |
| Action buttons | Open in Editor, Copy, Remove |

---

## Feature Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     v0.3.4e Feature Tree                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ContextPreviewPopup.axaml                                        â”‚
â”‚  â”œâ”€â”€ Header                                                      â”‚
â”‚  â”‚   â”œâ”€â”€ File icon (based on IconKey)                           â”‚
â”‚  â”‚   â”œâ”€â”€ DisplayLabel (filename or filename:lines)              â”‚
â”‚  â”‚   â”œâ”€â”€ FilePath (truncated with ellipsis)                     â”‚
â”‚  â”‚   â”œâ”€â”€ Language badge                                         â”‚
â”‚  â”‚   â””â”€â”€ Close button (X)                                       â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ Content Area                                                â”‚
â”‚  â”‚   â”œâ”€â”€ AvaloniaEdit TextEditor (read-only)                    â”‚
â”‚  â”‚   â”œâ”€â”€ Syntax highlighting via SyntaxHighlightingService      â”‚
â”‚  â”‚   â”œâ”€â”€ Line numbers enabled                                   â”‚
â”‚  â”‚   â””â”€â”€ Scroll bars (horizontal and vertical)                  â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€â”€ Footer                                                      â”‚
â”‚      â”œâ”€â”€ Stats: "{LineCount} lines" and "~{Tokens} tokens"      â”‚
â”‚      â”œâ”€â”€ "Open in Editor" link button (if file has path)        â”‚
â”‚      â”œâ”€â”€ "Copy" link button â†’ copy to clipboard                 â”‚
â”‚      â””â”€â”€ "Remove" link button (danger) â†’ remove context         â”‚
â”‚                                                                   â”‚
â”‚  ContextPreviewPopup.axaml.cs                                     â”‚
â”‚  â”œâ”€â”€ Styled Properties                                           â”‚
â”‚  â”‚   â”œâ”€â”€ CloseCommand: ICommand                                 â”‚
â”‚  â”‚   â”œâ”€â”€ OpenInEditorCommand: ICommand                          â”‚
â”‚  â”‚   â””â”€â”€ RemoveCommand: ICommand                                â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ CopyContentCommand: RelayCommand (internal)                 â”‚
â”‚  â”‚   â””â”€â”€ Copies Content to clipboard                            â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ Initialize(SyntaxHighlightingService)                       â”‚
â”‚  â”‚   â””â”€â”€ Stores reference for highlighting                      â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€â”€ OnDataContextChanged(sender, e)                             â”‚
â”‚  â”‚   â”œâ”€â”€ Sets PreviewEditor.Text                                â”‚
â”‚  â”‚   â”œâ”€â”€ Applies syntax highlighting                            â”‚
â”‚  â”‚   â””â”€â”€ Scrolls to StartLine (if selection)                    â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€â”€ OnKeyDown(e)                                                â”‚
â”‚      â””â”€â”€ Escape â†’ CloseCommand.Execute()                        â”‚
â”‚                                                                   â”‚
â”‚  ChatView Preview Integration                                     â”‚
â”‚  â”œâ”€â”€ Panel with backdrop (semi-transparent black)               â”‚
â”‚  â”œâ”€â”€ IsVisible="{Binding IsPreviewOpen}"                        â”‚
â”‚  â”œâ”€â”€ ZIndex="100" (above all content)                           â”‚
â”‚  â”œâ”€â”€ Backdrop click â†’ HidePreviewCommand                        â”‚
â”‚  â””â”€â”€ ContextPreviewPopup centered with margin                   â”‚
â”‚                                                                   â”‚
â”‚  ChatViewModel Properties Required                                â”‚
â”‚  â”œâ”€â”€ IsPreviewOpen: bool                                        â”‚
â”‚  â”œâ”€â”€ SelectedPreviewContext: FileContextViewModel?              â”‚
â”‚  â”œâ”€â”€ ShowPreviewCommand: ICommand                               â”‚
â”‚  â”œâ”€â”€ HidePreviewCommand: ICommand                               â”‚
â”‚  â”œâ”€â”€ OpenContextFileCommand: ICommand                           â”‚
â”‚  â””â”€â”€ RemoveSelectedContextCommand: ICommand                     â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture Diagrams

### Preview Popup Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Context Preview Popup                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   ContextPreviewPopup                       â”‚  â”‚
â”‚  â”‚                   (400-700px wide, max 500px tall)          â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ HEADER (darker background, rounded top corners)      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“„ UserService.cs                        [csharp] [âœ•] â”‚   â”‚  â”‚
â”‚  â”‚  â”‚    src/Services/UserService.cs                       â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ CONTENT (AvaloniaEdit TextEditor)                    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  1 â”‚ using System;                                   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  2 â”‚ using System.Threading.Tasks;                   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  3 â”‚                                                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  4 â”‚ namespace SeniorIntern.Services;                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  5 â”‚                                                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  6 â”‚ public class UserService : IUserService         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  7 â”‚ {                                                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  8 â”‚     private readonly IRepository _repo;         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  9 â”‚                                                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 10 â”‚     public async Task<User> GetByIdAsync(int id)â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 11 â”‚     {                                            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 12 â”‚         return await _repo.FindAsync(id);       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 13 â”‚     }                                            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 14 â”‚ }                                                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚    â–¼ (scrollable)                                    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ FOOTER (darker background, rounded bottom corners)   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 45 lines  ~156 tokens    [Open in Editor] [Copy] [Remove]â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Preview Modal Overlay

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Preview Modal Overlay                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      ChatView                               â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Chat Messages (behind overlay, not interactive)      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ User: Can you explain this code?                     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ AI: Sure! This code implements a service...          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ BACKDROP (50% black, ZIndex: 100) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚                             â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  ContextPreviewPopup       â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  (centered, 40px margin)   â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚                             â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  Click backdrop â†’ HidePreviewCommand                        â”‚  â”‚
â”‚  â”‚  Press Escape  â†’ HidePreviewCommand                        â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Preview Data Flow                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  User clicks context pill                                        â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ChatContextBar.OnContextPillPressed()                      â”‚  â”‚
â”‚  â”‚ â†’ viewModel.ShowPreviewCommand.Execute(context)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ChatViewModel.ShowPreview(context):                        â”‚  â”‚
â”‚  â”‚   SelectedPreviewContext = context                         â”‚  â”‚
â”‚  â”‚   IsPreviewOpen = true                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ XAML Binding triggers:                                     â”‚  â”‚
â”‚  â”‚   Panel.IsVisible = true                                   â”‚  â”‚
â”‚  â”‚   ContextPreviewPopup.DataContext = SelectedPreviewContext â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ContextPreviewPopup.OnDataContextChanged():                â”‚  â”‚
â”‚  â”‚   PreviewEditor.Text = context.Content                     â”‚  â”‚
â”‚  â”‚   _syntaxService.ApplyHighlighting(editor, language)       â”‚  â”‚
â”‚  â”‚   Scroll to StartLine (if selection)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  Preview is now visible with highlighted content                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Directory Structure

```
src/SeniorIntern.Desktop/
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ ContextPreviewPopup.axaml                     (NEW)
â”‚   â”œâ”€â”€ ContextPreviewPopup.axaml.cs                  (NEW)
â”‚   â””â”€â”€ ChatView.axaml                                (MODIFY)
â””â”€â”€ Themes/
    â””â”€â”€ Dark.axaml                                    (MODIFY)
```

---

## Implementation Details

### Task 1: Create ContextPreviewPopup.axaml

**File:** `src/SeniorIntern.Desktop/Views/ContextPreviewPopup.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ae="using:AvaloniaEdit"
             xmlns:vm="using:SeniorIntern.Desktop.ViewModels"
             x:Class="SeniorIntern.Desktop.Views.ContextPreviewPopup"
             x:DataType="vm:FileContextViewModel">

    <Border Background="{DynamicResource PopupBackgroundBrush}"
            BorderBrush="{DynamicResource PopupBorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            MinWidth="400"
            MaxWidth="700"
            MaxHeight="500"
            BoxShadow="0 4 16 0 #40000000">

        <Grid RowDefinitions="Auto, *, Auto">
            <!-- Header -->
            <Border Grid.Row="0"
                    Background="{DynamicResource PopupHeaderBrush}"
                    CornerRadius="8,8,0,0"
                    Padding="12,8">
                <Grid ColumnDefinitions="Auto, *, Auto, Auto">
                    <!-- File Icon -->
                    <PathIcon Grid.Column="0"
                              Data="{Binding IconKey, Converter={StaticResource IconKeyConverter}}"
                              Width="16" Height="16"
                              Margin="0,0,8,0"
                              Foreground="{DynamicResource TextSecondaryBrush}" />

                    <!-- File Name and Path -->
                    <StackPanel Grid.Column="1" Spacing="2">
                        <TextBlock Text="{Binding DisplayLabel}"
                                   FontWeight="SemiBold"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                        <TextBlock Text="{Binding FilePath}"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   IsVisible="{Binding FilePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   TextTrimming="CharacterEllipsis" />
                    </StackPanel>

                    <!-- Language Badge -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource BadgeBackgroundBrush}"
                            CornerRadius="4"
                            Padding="6,2"
                            Margin="8,0"
                            VerticalAlignment="Center"
                            IsVisible="{Binding Language, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding Language}"
                                   FontSize="10"
                                   Foreground="{DynamicResource BadgeForegroundBrush}" />
                    </Border>

                    <!-- Close Button -->
                    <Button Grid.Column="3"
                            Classes="icon-button"
                            Command="{Binding $parent[UserControl].CloseCommand}"
                            ToolTip.Tip="Close (Escape)">
                        <PathIcon Data="{StaticResource CloseIcon}"
                                  Width="12" Height="12" />
                    </Button>
                </Grid>
            </Border>

            <!-- Content Area -->
            <Border Grid.Row="1" Padding="1">
                <ae:TextEditor x:Name="PreviewEditor"
                               IsReadOnly="True"
                               ShowLineNumbers="True"
                               FontFamily="Cascadia Code, Consolas, monospace"
                               FontSize="12"
                               Background="{DynamicResource EditorBackgroundBrush}"
                               Foreground="{DynamicResource EditorForegroundBrush}"
                               HorizontalScrollBarVisibility="Auto"
                               VerticalScrollBarVisibility="Auto" />
            </Border>

            <!-- Footer -->
            <Border Grid.Row="2"
                    Background="{DynamicResource PopupFooterBrush}"
                    CornerRadius="0,0,8,8"
                    Padding="12,8">
                <Grid ColumnDefinitions="*, Auto, Auto, Auto">
                    <!-- Stats -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                        <TextBlock FontSize="11" Foreground="{DynamicResource TextMutedBrush}">
                            <Run Text="{Binding LineCount}" />
                            <Run Text="lines" />
                        </TextBlock>
                        <TextBlock FontSize="11" Foreground="{DynamicResource TextMutedBrush}">
                            <Run Text="~" />
                            <Run Text="{Binding EstimatedTokens}" />
                            <Run Text="tokens" />
                        </TextBlock>
                    </StackPanel>

                    <!-- Actions -->
                    <Button Grid.Column="1"
                            Content="Open in Editor"
                            Classes="link-button"
                            FontSize="11"
                            Command="{Binding $parent[UserControl].OpenInEditorCommand}"
                            IsVisible="{Binding FilePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            Margin="0,0,12,0" />

                    <Button Grid.Column="2"
                            Content="Copy"
                            Classes="link-button"
                            FontSize="11"
                            Command="{Binding $parent[UserControl].CopyContentCommand}"
                            Margin="0,0,12,0" />

                    <Button Grid.Column="3"
                            Content="Remove"
                            Classes="link-button danger"
                            FontSize="11"
                            Command="{Binding $parent[UserControl].RemoveCommand}" />
                </Grid>
            </Border>
        </Grid>
    </Border>
</UserControl>
```

### Task 2: Create ContextPreviewPopup.axaml.cs

**File:** `src/SeniorIntern.Desktop/Views/ContextPreviewPopup.axaml.cs`

```csharp
namespace SeniorIntern.Desktop.Views;

using System;
using System.Windows.Input;
using Avalonia;
using Avalonia.Controls;
using Avalonia.Input;
using CommunityToolkit.Mvvm.Input;
using SeniorIntern.Desktop.Services;
using SeniorIntern.Desktop.ViewModels;

public partial class ContextPreviewPopup : UserControl
{
    private SyntaxHighlightingService? _syntaxService;

    #region Styled Properties

    public static readonly StyledProperty<ICommand?> CloseCommandProperty =
        AvaloniaProperty.Register<ContextPreviewPopup, ICommand?>(nameof(CloseCommand));

    public static readonly StyledProperty<ICommand?> OpenInEditorCommandProperty =
        AvaloniaProperty.Register<ContextPreviewPopup, ICommand?>(nameof(OpenInEditorCommand));

    public static readonly StyledProperty<ICommand?> RemoveCommandProperty =
        AvaloniaProperty.Register<ContextPreviewPopup, ICommand?>(nameof(RemoveCommand));

    public ICommand? CloseCommand
    {
        get => GetValue(CloseCommandProperty);
        set => SetValue(CloseCommandProperty, value);
    }

    public ICommand? OpenInEditorCommand
    {
        get => GetValue(OpenInEditorCommandProperty);
        set => SetValue(OpenInEditorCommandProperty, value);
    }

    public ICommand? RemoveCommand
    {
        get => GetValue(RemoveCommandProperty);
        set => SetValue(RemoveCommandProperty, value);
    }

    #endregion

    public ICommand CopyContentCommand { get; }

    public ContextPreviewPopup()
    {
        InitializeComponent();

        CopyContentCommand = new RelayCommand(CopyContent);
        DataContextChanged += OnDataContextChanged;
    }

    /// <summary>
    /// Initializes the preview popup with the syntax highlighting service.
    /// </summary>
    public void Initialize(SyntaxHighlightingService syntaxService)
    {
        _syntaxService = syntaxService;
    }

    private void OnDataContextChanged(object? sender, EventArgs e)
    {
        if (DataContext is not FileContextViewModel context) return;

        // Set content
        PreviewEditor.Text = context.Content;

        // Apply syntax highlighting
        if (_syntaxService != null && !string.IsNullOrEmpty(context.Language))
        {
            _syntaxService.ApplyHighlighting(PreviewEditor, context.Language);
        }

        // Scroll to start
        PreviewEditor.TextArea.Caret.Offset = 0;

        // If selection, scroll to the start line
        if (context.StartLine.HasValue && context.EndLine.HasValue)
        {
            var lineNumber = Math.Min(context.StartLine.Value, PreviewEditor.Document.LineCount);
            var line = PreviewEditor.Document.GetLineByNumber(lineNumber);
            PreviewEditor.TextArea.Caret.Offset = line.Offset;
            PreviewEditor.TextArea.Caret.BringCaretToView();
        }
    }

    private async void CopyContent()
    {
        if (DataContext is not FileContextViewModel context) return;

        var clipboard = TopLevel.GetTopLevel(this)?.Clipboard;
        if (clipboard != null)
        {
            await clipboard.SetTextAsync(context.Content);
        }
    }

    protected override void OnKeyDown(KeyEventArgs e)
    {
        base.OnKeyDown(e);

        if (e.Key == Key.Escape)
        {
            CloseCommand?.Execute(null);
            e.Handled = true;
        }
    }
}
```

### Task 3: Add Preview Overlay to ChatView

**File:** `src/SeniorIntern.Desktop/Views/ChatView.axaml` (additions)

```xml
<!-- Add as last child in the root Grid, spanning all rows -->

<!-- Context Preview Overlay -->
<Panel Grid.Row="0" Grid.RowSpan="3"
       IsVisible="{Binding IsPreviewOpen}"
       ZIndex="100">

    <!-- Backdrop (semi-transparent, click to close) -->
    <Border Background="#80000000"
            PointerPressed="OnPreviewBackdropPressed" />

    <!-- Preview Popup (centered) -->
    <views:ContextPreviewPopup x:Name="PreviewPopup"
                               DataContext="{Binding SelectedPreviewContext}"
                               CloseCommand="{Binding HidePreviewCommand}"
                               OpenInEditorCommand="{Binding OpenContextFileCommand}"
                               RemoveCommand="{Binding RemoveSelectedContextCommand}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Margin="40" />
</Panel>
```

**Add to ChatView.axaml.cs:**

```csharp
private void OnPreviewBackdropPressed(object? sender, PointerPressedEventArgs e)
{
    if (DataContext is ChatViewModel viewModel)
    {
        viewModel.HidePreviewCommand.Execute(null);
    }
}

protected override void OnLoaded(RoutedEventArgs e)
{
    base.OnLoaded(e);

    // Initialize preview popup with syntax service
    var syntaxService = // Get from DI
    PreviewPopup.Initialize(syntaxService);
}
```

### Task 4: Add Theme Resources

**File:** `src/SeniorIntern.Desktop/Themes/Dark.axaml` (additions)

```xml
<!-- Popup Colors -->
<SolidColorBrush x:Key="PopupBackgroundBrush" Color="#252526" />
<SolidColorBrush x:Key="PopupBorderBrush" Color="#454545" />
<SolidColorBrush x:Key="PopupHeaderBrush" Color="#2D2D2D" />
<SolidColorBrush x:Key="PopupFooterBrush" Color="#2D2D2D" />

<!-- Danger link button style -->
<Style Selector="Button.link-button.danger">
    <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}" />
</Style>

<Style Selector="Button.link-button.danger:pointerover">
    <Setter Property="Foreground" Value="#FF6B6B" />
</Style>
```

---

## ChatViewModel Properties/Commands Required

| Member | Type | Description |
|--------|------|-------------|
| IsPreviewOpen | bool | Controls preview visibility |
| SelectedPreviewContext | FileContextViewModel? | Context being previewed |
| ShowPreviewCommand | RelayCommand\<FileContextViewModel\> | Opens preview for context |
| HidePreviewCommand | RelayCommand | Closes preview |
| OpenContextFileCommand | RelayCommand | Opens file in editor |
| RemoveSelectedContextCommand | RelayCommand | Removes context and closes |

---

## Unit Testing Requirements

| Component | Test Count | Focus Areas |
|-----------|------------|-------------|
| OnDataContextChanged | 3 | Sets text, applies highlighting, scrolls |
| CopyContentCommand | 2 | Copies to clipboard, handles null |
| OnKeyDown | 2 | Escape closes, other keys ignored |
| Styled properties | 3 | CloseCommand, OpenInEditor, Remove |
| ChatView integration | 2 | Backdrop click, visibility binding |
| **Total** | **12** | |

---

## Files Summary

### Files to Create (2)

| File | Lines |
|------|-------|
| `Views/ContextPreviewPopup.axaml` | 100 |
| `Views/ContextPreviewPopup.axaml.cs` | 100 |

### Files to Modify (2)

| File | Changes |
|------|---------|
| `Views/ChatView.axaml` | Add preview overlay panel |
| `Themes/Dark.axaml` | Add popup colors, danger link style |

---

## Acceptance Criteria

| ID | Criterion |
|----|-----------|
| AC-1 | Preview shows full content with syntax highlighting |
| AC-2 | Header shows file name, path, and language badge |
| AC-3 | Footer shows line count and token estimate |
| AC-4 | Close button closes preview |
| AC-5 | Escape key closes preview |
| AC-6 | Clicking backdrop closes preview |
| AC-7 | Copy button copies content to clipboard |
| AC-8 | Open in Editor opens file in editor panel |
| AC-9 | Remove button removes context and closes preview |
| AC-10 | Preview scrolls to StartLine for selections |

---

## Dependencies

| Part | Dependency Description |
|------|------------------------|
| v0.3.3c | SyntaxHighlightingService for code coloring |
| v0.3.4c | FileContextViewModel for data binding |
| AvaloniaEdit | TextEditor control for content display |

---

## Timeline Estimate

| Version | Estimated Effort |
|---------|------------------|
| v0.3.4e | 0.5 day |
