<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:conv="using:AIntern.Desktop.Converters"
             x:Class="AIntern.Desktop.Controls.CommandBlockControl"
             x:DataType="vm:CommandBlockViewModel">
    
    <!--
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║ COMMAND BLOCK CONTROL (v0.5.4f)                                            ║
    ║ Renders command blocks in chat messages with action buttons.               ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
    
    Visual Layout:
    ┌────────────────────────────────────────────────────────────────────┐
    │ Row 0: Description + Language Badge + Status Badge                 │
    ├────────────────────────────────────────────────────────────────────┤
    │ Row 1: $ command text here                                         │
    ├────────────────────────────────────────────────────────────────────┤
    │ Row 2: [Copy] [Send] | [Run]    Status Message                     │
    ├────────────────────────────────────────────────────────────────────┤
    │ Row 3: Danger Warning Panel (conditional)                          │
    └────────────────────────────────────────────────────────────────────┘
    -->

    <UserControl.Resources>
        <conv:EqualityConverter x:Key="EqualityConverter" />
        <conv:BoolToTextConverter x:Key="BoolToTextConverter" />
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- ═══════════════════════════════════════════════════════════════════
             MAIN CONTAINER STYLES
             ═══════════════════════════════════════════════════════════════════ -->
        
        <!-- Main Container -->
        <Style Selector="Border.command-block">
            <Setter Property="Background" Value="{DynamicResource CommandBlockBackground}" />
            <Setter Property="BorderBrush" Value="{DynamicResource CommandBlockBorder}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0,8" />
        </Style>

        <!-- Dangerous Command Border (red) -->
        <Style Selector="Border.command-block.dangerous">
            <Setter Property="BorderBrush" Value="{DynamicResource DangerBrush}" />
            <Setter Property="BorderThickness" Value="2" />
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════════
             CODE CONTENT AREA STYLES
             ═══════════════════════════════════════════════════════════════════ -->
        
        <Style Selector="Border.command-content">
            <Setter Property="Background" Value="{DynamicResource CodeBlockBackground}" />
            <Setter Property="Padding" Value="12,8" />
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════════
             STATUS BADGE STYLES
             ═══════════════════════════════════════════════════════════════════ -->
        
        <Style Selector="Border.status-badge">
            <Setter Property="Background" Value="{DynamicResource StatusBadgeBackground}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="6,2" />
        </Style>

        <Style Selector="Border.status-badge.success">
            <Setter Property="Background" Value="{DynamicResource SuccessBrush}" />
        </Style>

        <Style Selector="Border.status-badge.error">
            <Setter Property="Background" Value="{DynamicResource ErrorBrush}" />
        </Style>

        <Style Selector="Border.status-badge.warning">
            <Setter Property="Background" Value="{DynamicResource WarningBrush}" />
        </Style>

        <Style Selector="Border.status-badge.running">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
        </Style>

        <Style Selector="Border.status-badge.info">
            <Setter Property="Background" Value="{DynamicResource InfoBrush}" />
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════════
             DANGER WARNING PANEL STYLES
             ═══════════════════════════════════════════════════════════════════ -->
        
        <Style Selector="Border.danger-warning">
            <Setter Property="Background" Value="{DynamicResource DangerBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource DangerBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="12,0,12,12" />
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════════
             ACTION BUTTON STYLES
             ═══════════════════════════════════════════════════════════════════ -->
        
        <Style Selector="Button.command-action">
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="MinWidth" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>

        <Style Selector="Button.command-action:pointerover">
            <Setter Property="Background" Value="{DynamicResource HoverBrush}" />
        </Style>

        <!-- Run Button (accent color) -->
        <Style Selector="Button.run-button">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <Style Selector="Button.run-button:disabled">
            <Setter Property="Opacity" Value="0.6" />
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════════
             SPINNING ANIMATION (for loading spinner)
             ═══════════════════════════════════════════════════════════════════ -->
        
        <Style Selector="PathIcon.spinning">
            <Style.Animations>
                <Animation Duration="0:0:1" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>

    <!-- ═══════════════════════════════════════════════════════════════════════
         CONTROL CONTENT
         ═══════════════════════════════════════════════════════════════════════ -->
    
    <Border Classes="command-block"
            Classes.dangerous="{Binding IsDangerous}">
        <Grid RowDefinitions="Auto,Auto,Auto,Auto">

            <!-- ───────────────────────────────────────────────────────────────
                 ROW 0: Header (Description + Language Badge + Status)
                 ─────────────────────────────────────────────────────────────── -->
            <Grid Grid.Row="0"
                  ColumnDefinitions="*,Auto,Auto"
                  Margin="12,8"
                  IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">

                <!-- Description Text -->
                <TextBlock Grid.Column="0"
                           Text="{Binding Description}"
                           FontSize="12"
                           Foreground="{DynamicResource TextMuted}"
                           TextWrapping="Wrap"
                           TextTrimming="CharacterEllipsis"
                           MaxLines="2" />

                <!-- Language Badge (BASH, PowerShell, etc.) -->
                <Border Grid.Column="1"
                        IsVisible="{Binding LanguageBadge, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                        Background="{DynamicResource BadgeBackground}"
                        CornerRadius="3"
                        Padding="6,2"
                        Margin="8,0"
                        VerticalAlignment="Top">
                    <TextBlock Text="{Binding LanguageBadge}"
                               FontSize="10"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource BadgeForeground}" />
                </Border>

                <!-- Status Badge (Executed, Running, Failed, etc.) -->
                <Border Grid.Column="2"
                        Classes="status-badge"
                        Classes.success="{Binding StatusClass, Converter={StaticResource EqualityConverter}, ConverterParameter=success}"
                        Classes.error="{Binding StatusClass, Converter={StaticResource EqualityConverter}, ConverterParameter=error}"
                        Classes.warning="{Binding StatusClass, Converter={StaticResource EqualityConverter}, ConverterParameter=warning}"
                        Classes.running="{Binding StatusClass, Converter={StaticResource EqualityConverter}, ConverterParameter=running}"
                        Classes.info="{Binding StatusClass, Converter={StaticResource EqualityConverter}, ConverterParameter=info}"
                        IsVisible="{Binding ShowStatus}"
                        VerticalAlignment="Top">
                    <TextBlock Text="{Binding StatusText}"
                               FontSize="10"
                               Foreground="White" />
                </Border>
            </Grid>

            <!-- ───────────────────────────────────────────────────────────────
                 ROW 1: Command Content ($ prompt + command text)
                 ─────────────────────────────────────────────────────────────── -->
            <Border Grid.Row="1" Classes="command-content">
                <Grid ColumnDefinitions="Auto,*">
                    <!-- Prompt Symbol -->
                    <TextBlock Grid.Column="0"
                               Text="$"
                               FontFamily="{StaticResource MonospaceFont}"
                               Foreground="{DynamicResource TerminalPromptColor}"
                               Margin="0,0,8,0"
                               VerticalAlignment="Top" />

                    <!-- Command Text (selectable) -->
                    <SelectableTextBlock Grid.Column="1"
                                         Text="{Binding CommandText}"
                                         FontFamily="{StaticResource MonospaceFont}"
                                         FontSize="13"
                                         TextWrapping="Wrap"
                                         Foreground="{DynamicResource CodeForeground}" />
                </Grid>
            </Border>

            <!-- ───────────────────────────────────────────────────────────────
                 ROW 2: Action Buttons (Copy, Send, Run) + Status Message
                 ─────────────────────────────────────────────────────────────── -->
            <StackPanel Grid.Row="2"
                        Orientation="Horizontal"
                        Spacing="4"
                        Margin="12,8">

                <!-- Copy Button -->
                <Button Classes="command-action"
                        Command="{Binding CopyCommand}"
                        ToolTip.Tip="Copy to clipboard">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="{StaticResource CopyIcon}"
                                  Width="14" Height="14" />
                        <TextBlock Text="Copy" FontSize="12" />
                    </StackPanel>
                </Button>

                <!-- Send to Terminal Button -->
                <Button Classes="command-action"
                        Command="{Binding SendToTerminalCommand}"
                        ToolTip.Tip="Send to terminal (doesn't execute)"
                        IsEnabled="{Binding HasActiveTerminal}">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="{StaticResource TerminalIcon}"
                                  Width="14" Height="14" />
                        <TextBlock Text="Send" FontSize="12" />
                    </StackPanel>
                </Button>

                <!-- Separator -->
                <Border Width="1"
                        Height="16"
                        Background="{DynamicResource BorderBrush}"
                        Margin="4,0"
                        VerticalAlignment="Center" />

                <!-- Run Button -->
                <Button Classes="command-action run-button"
                        Command="{Binding ExecuteCommand}"
                        IsEnabled="{Binding CanExecute}"
                        ToolTip.Tip="Execute in terminal">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <!-- Play Icon (when not executing) -->
                        <PathIcon Data="{StaticResource PlayIcon}"
                                  Width="14" Height="14"
                                  IsVisible="{Binding !IsExecuting}" />
                        <!-- Spinner Icon (when executing) -->
                        <PathIcon Data="{StaticResource SpinnerIcon}"
                                  Width="14" Height="14"
                                  IsVisible="{Binding IsExecuting}"
                                  Classes="spinning"
                                  RenderTransform="rotate(0)" />
                        <TextBlock Text="{Binding IsExecuting, Converter={StaticResource BoolToTextConverter}, ConverterParameter=Running...|Run}"
                                   FontSize="12" />
                    </StackPanel>
                </Button>

                <!-- Line Count Badge (for multi-line commands) -->
                <Border IsVisible="{Binding IsMultiLine}"
                        Background="{DynamicResource BadgeBackground}"
                        CornerRadius="3"
                        Padding="6,2"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center">
                    <TextBlock Text="{Binding AdditionalLinesText}"
                               FontSize="10"
                               Foreground="{DynamicResource TextMuted}" />
                </Border>

                <!-- Status Message (transient, e.g., "Copied to clipboard") -->
                <TextBlock Text="{Binding StatusMessage}"
                           IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                           FontSize="11"
                           Foreground="{DynamicResource TextMuted}"
                           VerticalAlignment="Center"
                           Margin="8,0,0,0" />
            </StackPanel>

            <!-- ───────────────────────────────────────────────────────────────
                 ROW 3: Danger Warning Panel (conditional)
                 ─────────────────────────────────────────────────────────────── -->
            <Border Grid.Row="3"
                    Classes="danger-warning"
                    IsVisible="{Binding ShowDangerWarning}">
                <StackPanel Spacing="8">
                    <!-- Warning Header -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="{StaticResource WarningIcon}"
                                  Width="16" Height="16"
                                  Foreground="{DynamicResource DangerBrush}" />
                        <TextBlock Text="Warning: Potentially Dangerous Command"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource DangerBrush}" />
                    </StackPanel>

                    <!-- Warning Message -->
                    <TextBlock Text="{Binding DangerWarning}"
                               TextWrapping="Wrap"
                               FontSize="12"
                               Foreground="{DynamicResource TextPrimary}" />

                    <!-- Action Buttons -->
                    <StackPanel Orientation="Horizontal"
                                Spacing="8"
                                Margin="0,4,0,0"
                                HorizontalAlignment="Right">
                        <Button Content="Cancel"
                                Command="{Binding CancelDangerCommand}"
                                Padding="12,6"
                                CornerRadius="4" />
                        <Button Content="I understand, proceed"
                                Command="{Binding ConfirmDangerCommand}"
                                Background="{DynamicResource DangerBrush}"
                                Foreground="White"
                                Padding="12,6"
                                CornerRadius="4" />
                    </StackPanel>
                </StackPanel>
            </Border>

        </Grid>
    </Border>
</UserControl>
