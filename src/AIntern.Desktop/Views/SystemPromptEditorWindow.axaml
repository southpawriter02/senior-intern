<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AIntern.Desktop.ViewModels"
        x:Class="AIntern.Desktop.Views.SystemPromptEditorWindow"
        x:DataType="vm:SystemPromptEditorViewModel"
        Title="System Prompt Editor"
        Width="900" Height="650"
        MinWidth="700" MinHeight="500"
        Background="{DynamicResource WindowBackground}">

    <Grid>
        <!-- Main Content -->
        <Grid ColumnDefinitions="260, Auto, *">
            <!-- Left Sidebar -->
            <Border Grid.Column="0"
                    Background="{DynamicResource SidebarBackground}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,1,0">
                <DockPanel>
                    <!-- Header -->
                    <Border DockPanel.Dock="Top" Padding="16,12">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="System Prompts"
                                       FontWeight="SemiBold"
                                       FontSize="14"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextPrimary}" />
                            <Button Grid.Column="1"
                                    Command="{Binding CreateNewPromptCommand}"
                                    ToolTip.Tip="New Prompt (Ctrl+N)"
                                    Theme="{StaticResource SubtleButton}">
                                <PathIcon Data="M12,2 L12,22 M2,12 L22,12"
                                          Width="12" Height="12"
                                          Foreground="{DynamicResource TextPrimary}" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Scrollable Content -->
                    <ScrollViewer>
                        <StackPanel Spacing="16" Margin="8,8,8,16">
                            <!-- My Prompts Section -->
                            <StackPanel>
                                <TextBlock Text="MY PROMPTS"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextMuted}"
                                           Margin="8,0,0,8" />

                                <!-- Empty State -->
                                <TextBlock Text="No custom prompts yet"
                                           IsVisible="{Binding !UserPrompts.Count}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextMuted}"
                                           Margin="8,4" />

                                <!-- User Prompts List -->
                                <ItemsControl ItemsSource="{Binding UserPrompts}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="vm:SystemPromptViewModel">
                                            <Button Command="{Binding $parent[ItemsControl].((vm:SystemPromptEditorViewModel)DataContext).SelectPromptCommand}"
                                                    CommandParameter="{Binding}"
                                                    Theme="{StaticResource PromptItemButton}"
                                                    Margin="0,2">
                                                <Grid ColumnDefinitions="Auto, *, Auto">
                                                    <!-- Default Star -->
                                                    <TextBlock Text="*"
                                                               IsVisible="{Binding IsDefault}"
                                                               Foreground="{DynamicResource AccentBrush}"
                                                               FontWeight="Bold"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,6,0"
                                                               ToolTip.Tip="Default prompt" />

                                                    <!-- Name -->
                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding Name}"
                                                               TextTrimming="CharacterEllipsis"
                                                               VerticalAlignment="Center"
                                                               Foreground="{DynamicResource TextPrimary}" />

                                                    <!-- Usage Count -->
                                                    <TextBlock Grid.Column="2"
                                                               Text="{Binding UsageCount}"
                                                               IsVisible="{Binding UsageCount}"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource TextMuted}"
                                                               VerticalAlignment="Center"
                                                               Margin="8,0,0,0" />
                                                </Grid>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>

                            <!-- Templates Section -->
                            <StackPanel>
                                <TextBlock Text="TEMPLATES"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextMuted}"
                                           Margin="8,0,0,8" />

                                <!-- Templates List -->
                                <ItemsControl ItemsSource="{Binding Templates}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="vm:SystemPromptViewModel">
                                            <Button Command="{Binding $parent[ItemsControl].((vm:SystemPromptEditorViewModel)DataContext).LoadTemplateCommand}"
                                                    CommandParameter="{Binding}"
                                                    Theme="{StaticResource PromptItemButton}"
                                                    Margin="0,2">
                                                <StackPanel Spacing="2">
                                                    <!-- Name and Category -->
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <TextBlock Text="{Binding Name}"
                                                                   FontWeight="Medium"
                                                                   Foreground="{DynamicResource TextPrimary}" />
                                                        <Border Background="{DynamicResource ControlBackground}"
                                                                CornerRadius="2"
                                                                Padding="4,1">
                                                            <TextBlock Text="{Binding Category}"
                                                                       FontSize="10"
                                                                       Foreground="{DynamicResource TextMuted}" />
                                                        </Border>
                                                    </StackPanel>

                                                    <!-- Description -->
                                                    <TextBlock Text="{Binding Description}"
                                                               TextTrimming="CharacterEllipsis"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource TextMuted}"
                                                               IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1"
                          Width="4"
                          Background="Transparent"
                          ResizeDirection="Columns" />

            <!-- Right Panel: Editor -->
            <DockPanel Grid.Column="2" Margin="24">
                <!-- Read-only Badge (for templates) -->
                <Border DockPanel.Dock="Top"
                        IsVisible="{Binding !CanEdit}"
                        Background="{DynamicResource WarningBackground}"
                        CornerRadius="4"
                        Padding="12,8"
                        Margin="0,0,0,16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Read-only Template"
                                   Foreground="{DynamicResource WarningForeground}"
                                   VerticalAlignment="Center" />
                        <Button Content="Create Editable Copy"
                                Command="{Binding DuplicatePromptCommand}"
                                Theme="{StaticResource LinkButton}"
                                VerticalAlignment="Center" />
                    </StackPanel>
                </Border>

                <!-- Action Bar (Bottom) -->
                <Border DockPanel.Dock="Bottom"
                        Margin="0,16,0,0">
                    <Grid ColumnDefinitions="Auto, Auto, Auto, *, Auto, Auto">
                        <!-- Left actions -->
                        <Button Grid.Column="0"
                                Content="Delete"
                                Command="{Binding DeletePromptCommand}"
                                Theme="{StaticResource DangerButton}"
                                IsVisible="{Binding CanDelete}" />
                        <Button Grid.Column="1"
                                Content="Duplicate"
                                Command="{Binding DuplicatePromptCommand}"
                                Theme="{StaticResource SubtleButton}"
                                Margin="8,0,0,0" />
                        <Button Grid.Column="2"
                                Content="Set as Default"
                                Command="{Binding SetAsDefaultCommand}"
                                Theme="{StaticResource SubtleButton}"
                                IsVisible="{Binding CanSetDefault}"
                                Margin="8,0,0,0" />

                        <!-- Right actions -->
                        <Button Grid.Column="4"
                                Content="Discard Changes"
                                Command="{Binding DiscardChangesCommand}"
                                Theme="{StaticResource SubtleButton}"
                                IsVisible="{Binding IsDirty}" />
                        <Button Grid.Column="5"
                                Content="Save"
                                Command="{Binding SavePromptCommand}"
                                Theme="{StaticResource PrimaryButton}"
                                Margin="8,0,0,0" />
                    </Grid>
                </Border>

                <!-- Stats Footer -->
                <Border DockPanel.Dock="Bottom"
                        Background="{DynamicResource ControlBackground}"
                        CornerRadius="0,0,4,4"
                        Padding="12,8"
                        Margin="0,0,0,0">
                    <Grid ColumnDefinitions="Auto, *, Auto, Auto">
                        <TextBlock Text="{Binding CharacterCountText}"
                                   Foreground="{DynamicResource TextMuted}"
                                   FontSize="12" />
                        <TextBlock Grid.Column="2"
                                   Text="{Binding TokenCountText}"
                                   Foreground="{DynamicResource TextMuted}"
                                   FontSize="12" />
                        <TextBlock Grid.Column="3"
                                   Text=" | Modified"
                                   IsVisible="{Binding IsDirty}"
                                   Foreground="{DynamicResource AccentBrush}"
                                   FontSize="12" />
                    </Grid>
                </Border>

                <!-- Editor Fields -->
                <StackPanel>
                    <!-- Name Field -->
                    <StackPanel Spacing="4" Margin="0,0,0,16">
                        <TextBlock Text="Name"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimary}" />
                        <TextBox Text="{Binding PromptName}"
                                 IsEnabled="{Binding CanEdit}"
                                 Watermark="Enter prompt name..."
                                 MaxLength="100"
                                 Background="{DynamicResource InputBackground}"
                                 Foreground="{DynamicResource TextPrimary}" />
                    </StackPanel>

                    <!-- Description Field -->
                    <StackPanel Spacing="4" Margin="0,0,0,16">
                        <TextBlock Text="Description (optional)"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimary}" />
                        <TextBox Text="{Binding PromptDescription}"
                                 IsEnabled="{Binding CanEdit}"
                                 Watermark="Brief description..."
                                 MaxLength="500"
                                 Background="{DynamicResource InputBackground}"
                                 Foreground="{DynamicResource TextPrimary}" />
                    </StackPanel>

                    <!-- Content Field -->
                    <StackPanel Spacing="4">
                        <TextBlock Text="Content"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimary}" />
                        <TextBox Text="{Binding EditorContent}"
                                 Theme="{StaticResource CodeEditorTextBox}"
                                 IsEnabled="{Binding CanEdit}"
                                 Watermark="Enter system prompt content..."
                                 MinHeight="200"
                                 MaxHeight="400" />
                    </StackPanel>
                </StackPanel>
            </DockPanel>
        </Grid>

        <!-- Error Banner Overlay -->
        <Border VerticalAlignment="Top"
                IsVisible="{Binding ValidationError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource ErrorBackground}"
                Padding="16"
                Margin="260,0,0,0">
            <Grid ColumnDefinitions="*, Auto">
                <TextBlock Text="{Binding ValidationError}"
                           Foreground="{DynamicResource ErrorForeground}"
                           TextWrapping="Wrap"
                           VerticalAlignment="Center" />
                <Button Grid.Column="1"
                        Content="X"
                        Command="{Binding ClearValidationErrorCommand}"
                        Theme="{StaticResource SubtleButton}"
                        Foreground="{DynamicResource ErrorForeground}"
                        VerticalAlignment="Center" />
            </Grid>
        </Border>

        <!-- Loading Overlay -->
        <Border IsVisible="{Binding IsLoading}"
                Background="#80000000">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="16">
                <ProgressBar IsIndeterminate="True"
                             Width="100"
                             Height="4" />
                <TextBlock Text="Loading..."
                           Foreground="White"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>

</Window>
