<!--
    MainWindow.axaml - Main Application Window

    Version: v0.2.5g

    Layout:
    - SplitView with collapsible sidebar pane
    - Sidebar contains: ModelSelectorView + InferenceSettingsPanel + ConversationListView
    - Content area contains: ChatView
    - Status bar at bottom with model info, preset indicator, and token statistics

    Keyboard Shortcuts:
    - Ctrl+N: Create new conversation
    - Ctrl+S: Save current conversation
    - Ctrl+B: Toggle sidebar visibility
    - Ctrl+F: Focus search box
    - Ctrl+K: Open search dialog (v0.2.5e)
    - Ctrl+E: Open export dialog (v0.2.5f)
    - Ctrl+,: Toggle inference settings panel (v0.2.5g)
    - Ctrl+P: Open system prompt editor (v0.2.5g)
    - Ctrl+Shift+S: Force save (v0.2.5g)
-->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AIntern.Desktop.ViewModels"
        xmlns:views="using:AIntern.Desktop.Views"
        xmlns:converters="using:AIntern.Desktop.Converters"
        x:Class="AIntern.Desktop.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="The Senior Intern"
        Width="1200" Height="800"
        MinWidth="800" MinHeight="600"
        Background="{DynamicResource WindowBackground}">

    <!--
        Keyboard Bindings for Global Commands
        These shortcuts are available regardless of focus state.
    -->
    <Window.KeyBindings>
        <!-- Ctrl+N: Create new conversation -->
        <KeyBinding Gesture="Ctrl+N" Command="{Binding NewConversationCommand}" />
        <!-- Ctrl+S: Save current conversation (v0.2.2e) -->
        <KeyBinding Gesture="Ctrl+S" Command="{Binding ChatViewModel.SaveCommand}" />
        <!-- Ctrl+B: Toggle sidebar visibility -->
        <KeyBinding Gesture="Ctrl+B" Command="{Binding ToggleSidebarCommand}" />
        <!-- Ctrl+F: Focus search box in conversation list -->
        <KeyBinding Gesture="Ctrl+F" Command="{Binding FocusSearchCommand}" />
        <!-- Ctrl+K: Open search dialog (v0.2.5e) -->
        <KeyBinding Gesture="Ctrl+K" Command="{Binding OpenSearchCommand}" />
        <!-- Ctrl+E: Open export dialog (v0.2.5f) -->
        <KeyBinding Gesture="Ctrl+E" Command="{Binding OpenExportCommand}" />
        <!-- Ctrl+,: Toggle inference settings panel (v0.2.5g) -->
        <KeyBinding Gesture="Ctrl+OemComma" Command="{Binding ToggleSettingsPanelCommand}" />
        <!-- Ctrl+P: Open system prompt editor (v0.2.5g) -->
        <KeyBinding Gesture="Ctrl+P" Command="{Binding OpenSystemPromptEditorCommand}" />
        <!-- Ctrl+Shift+S: Force save (v0.2.5g) -->
        <KeyBinding Gesture="Ctrl+Shift+S" Command="{Binding ChatViewModel.SaveCommand}" />
    </Window.KeyBindings>

    <Grid RowDefinitions="*, Auto">
        <!--
            Main Content Area using SplitView

            SplitView provides:
            - Built-in pane open/close behavior
            - Smooth animations (when enabled)
            - Proper focus management

            DisplayMode="Inline" means:
            - Pane pushes content when open
            - No overlay behavior
            - Consistent with desktop app conventions
        -->
        <SplitView Grid.Row="0"
                   IsPaneOpen="{Binding IsSidebarVisible}"
                   DisplayMode="Inline"
                   OpenPaneLength="{Binding SidebarWidth}"
                   CompactPaneLength="0"
                   PanePlacement="Left">

            <!--
                Sidebar Pane
                Contains model selector at top and conversation list below.
            -->
            <SplitView.Pane>
                <Border Background="{DynamicResource SidebarBackground}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,1,0">
                    <Grid RowDefinitions="Auto, Auto, *">
                        <!--
                            Model Selector
                            Allows user to select and load GGUF model files.
                        -->
                        <views:ModelSelectorView Grid.Row="0"
                                                 DataContext="{Binding ModelSelectorViewModel}" />

                        <!--
                            Inference Settings Panel (v0.2.3e)
                            Provides parameter sliders and preset management.
                            Collapsible to save sidebar space when not actively tuning.
                        -->
                        <views:InferenceSettingsPanel Grid.Row="1"
                                                       DataContext="{Binding InferenceSettingsViewModel}" />

                        <!--
                            Conversation List
                            Shows conversation history grouped by date.
                            Provides search, rename, delete, and pin functionality.
                        -->
                        <views:ConversationListView Grid.Row="2"
                                                    DataContext="{Binding ConversationListViewModel}" />
                    </Grid>
                </Border>
            </SplitView.Pane>

            <!--
                Main Content Area
                Contains the chat view and sidebar toggle button when sidebar is hidden.
            -->
            <SplitView.Content>
                <Grid>
                    <!--
                        Welcome Screen (v0.3.5h)
                        Shown when no workspace is open.
                    -->
                    <views:WelcomeView IsVisible="{Binding ShowWelcome}" />

                    <!--
                        Chat View
                        Main chat interface with message display and input area.
                    -->
                    <views:ChatView DataContext="{Binding ChatViewModel}" />

                    <!--
                        Sidebar Toggle Button
                        Only visible when sidebar is hidden.
                        Allows user to restore sidebar visibility.
                    -->
                    <Button HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Margin="8"
                            Command="{Binding ToggleSidebarCommand}"
                            IsVisible="{Binding !IsSidebarVisible}"
                            Classes="IconButton"
                            ToolTip.Tip="Show Sidebar (Ctrl+B)">
                        <PathIcon Data="{StaticResource MenuIcon}"
                                  Width="16" Height="16" />
                    </Button>
                </Grid>
            </SplitView.Content>
        </SplitView>

        <!--
            Status Bar (v0.2.5g)
            Shows model state, preset info, token statistics, save state, and generation progress.
            Clickable elements: Model name opens model selector, Temperature opens settings panel.
        -->
        <Border Grid.Row="1"
                Background="{DynamicResource StatusBarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="12,6">
            <Grid ColumnDefinitions="Auto, Auto, Auto, Auto, Auto, *, Auto">
                <!--
                    Model Name (v0.2.5g)
                    Clickable button that shows the model name with accent/muted coloring.
                    Color indicates model load state: accent when loaded, muted when not.
                    Click opens the model selector by expanding the sidebar.
                -->
                <Button Grid.Column="0"
                        Command="{Binding ToggleSidebarCommand}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="0"
                        Cursor="Hand"
                        ToolTip.Tip="Click to open model selector (Ctrl+B)">
                    <TextBlock Text="{Binding StatusMessage}"
                               VerticalAlignment="Center"
                               Foreground="{Binding IsModelLoaded, Converter={x:Static converters:BoolToAccentColorConverter.Instance}}" />
                </Button>

                <!--
                    Preset Indicator (v0.2.3e)
                    Shows "Preset: {name}" with the active preset name.
                -->
                <TextBlock Grid.Column="1"
                           Text="{Binding InferenceSettingsViewModel.SelectedPreset.Name, StringFormat='Preset: {0}', FallbackValue='Preset: None'}"
                           FontSize="11"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextMuted}"
                           Margin="16,0,0,0" />

                <!--
                    Temperature Indicator (v0.2.5g)
                    Clickable button that shows "T:0.70" for quick reference.
                    Click expands the inference settings panel.
                -->
                <Button Grid.Column="2"
                        Command="{Binding ToggleSettingsPanelCommand}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="0"
                        Margin="16,0,0,0"
                        Cursor="Hand"
                        ToolTip.Tip="Click to open settings (Ctrl+,)">
                    <TextBlock Text="{Binding InferenceSettingsViewModel.Temperature, StringFormat='T:{0:F2}'}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource TextMuted}" />
                </Button>

                <!--
                    Save Status Indicator (v0.2.5g)
                    Color-coded display: Saved (green), Unsaved (yellow), Saving (accent).
                    Uses converters for text and color based on SaveStateChangedEventArgs.
                -->
                <TextBlock Grid.Column="3"
                           Text="{Binding SaveState, Converter={x:Static converters:SaveStatusTextConverter.Instance}}"
                           VerticalAlignment="Center"
                           Foreground="{Binding SaveState, Converter={x:Static converters:SaveStatusColorConverter.Instance}}"
                           Margin="16,0" />

                <!--
                    Token Statistics
                    Shows "Tokens: X (Y.Y tok/s)" during generation.
                -->
                <TextBlock Grid.Column="4"
                           Text="{Binding TokenInfo}"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextMuted}"
                           Margin="16,0" />

                <!--
                    Spacer column to push progress indicator to the right
                -->

                <!--
                    Progress Indicator
                    Indeterminate progress bar shown during generation.
                -->
                <ProgressBar Grid.Column="6"
                             IsVisible="{Binding ChatViewModel.IsGenerating}"
                             IsIndeterminate="True"
                             Width="80"
                             Height="4" />
            </Grid>
        </Border>

        <!--
            Drop Overlay (v0.3.5f)
            Shows visual feedback during file/folder drag-drop operations.
            Covers entire window with semi-transparent overlay and blue drop zone.
        -->
        <Border x:Name="DropOverlay"
                Grid.RowSpan="2"
                Background="#CC1E1E1E"
                IsVisible="False"
                IsHitTestVisible="False"
                ZIndex="1000">
            <Border Background="#402196F3"
                    BorderBrush="#2196F3"
                    BorderThickness="3"
                    CornerRadius="12"
                    Margin="24"
                    Padding="32">
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="16">
                    <PathIcon Data="{StaticResource DropIcon}"
                              Width="48" Height="48"
                              Foreground="#2196F3" />
                    <TextBlock x:Name="DropOverlayText"
                               Text="Drop to open"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Foreground="#2196F3"
                               HorizontalAlignment="Center" />
                </StackPanel>
            </Border>
        </Border>
    </Grid>

</Window>
