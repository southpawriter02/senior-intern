<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:AIntern.Desktop.ViewModels"
        mc:Ignorable="d"
        x:Class="AIntern.Desktop.Views.ApplyChangesDialog"
        x:DataType="vm:ApplyChangesDialogViewModel"
        Title="Apply Changes"
        Width="800"
        Height="550"
        MinWidth="500"
        MinHeight="350"
        WindowStartupLocation="CenterOwner"
        CanResize="True"
        ShowInTaskbar="False">

    <!-- Keyboard Shortcuts -->
    <Window.KeyBindings>
        <KeyBinding Gesture="Escape" Command="{Binding CancelCommand}" />
        <KeyBinding Gesture="Enter" Command="{Binding ApplyCommand}" />
    </Window.KeyBindings>

    <Grid RowDefinitions="Auto, *, Auto">

        <!-- Header -->
        <Border Grid.Row="0"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <!-- File Info -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <TextBlock Text="{Binding FileName}"
                               FontWeight="SemiBold"
                               FontSize="14" />
                    <TextBlock Text="{Binding FilePath}"
                               FontSize="11"
                               Opacity="0.7"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding FilePath}" />
                </StackPanel>

                <!-- Diff Summary -->
                <TextBlock Grid.Column="2"
                           Text="{Binding DiffSummary}"
                           FontSize="12"
                           Opacity="0.7"
                           VerticalAlignment="Center" />
            </Grid>
        </Border>

        <!-- Diff Preview Area -->
        <Border Grid.Row="1" 
                Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                Margin="0">
            <Grid RowDefinitions="Auto, *">
                <!-- Diff Header -->
                <Border Grid.Row="0" 
                        Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                        Padding="12,8">
                    <Grid ColumnDefinitions="*, *, Auto">
                        <TextBlock Grid.Column="0" 
                                   Text="Original" 
                                   FontWeight="SemiBold"
                                   FontSize="12" />
                        <TextBlock Grid.Column="1" 
                                   Text="Proposed Changes" 
                                   FontWeight="SemiBold"
                                   FontSize="12" />
                        <Border Grid.Column="2"
                                IsVisible="{Binding IsNewFile}"
                                Background="#2952A3"
                                CornerRadius="4"
                                Padding="8,4">
                            <TextBlock Text="New File" 
                                       FontSize="11"
                                       Foreground="White" />
                        </Border>
                    </Grid>
                </Border>
                
                <!-- Side-by-Side Content -->
                <Grid Grid.Row="1" ColumnDefinitions="*, *">
                    <!-- Original Content -->
                    <ScrollViewer Grid.Column="0" 
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">
                        <SelectableTextBlock Text="{Binding OriginalContent}"
                                             FontFamily="Consolas, Monaco, 'Courier New', monospace"
                                             FontSize="12"
                                             Padding="12"
                                             TextWrapping="NoWrap" />
                    </ScrollViewer>
                    
                    <!-- Separator -->
                    <Border Grid.Column="0"
                            HorizontalAlignment="Right"
                            Width="1"
                            Background="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" />
                    
                    <!-- Proposed Content -->
                    <ScrollViewer Grid.Column="1"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">
                        <SelectableTextBlock Text="{Binding ProposedContent}"
                                             FontFamily="Consolas, Monaco, 'Courier New', monospace"
                                             FontSize="12"
                                             Padding="12"
                                             TextWrapping="NoWrap" />
                    </ScrollViewer>
                </Grid>
            </Grid>
        </Border>

        <!-- Footer -->
        <Border Grid.Row="2"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,12">
            <Grid ColumnDefinitions="Auto, *, Auto">

                <!-- Left: Options -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="16"
                            VerticalAlignment="Center">

                    <!-- Backup Checkbox -->
                    <CheckBox Content="Create backup"
                              IsChecked="{Binding CreateBackup}"
                              IsEnabled="{Binding !IsApplying}"
                              ToolTip.Tip="Save a backup copy before modifying the file." />

                    <!-- New File Badge -->
                    <Border IsVisible="{Binding IsNewFile}"
                            Padding="8,4"
                            CornerRadius="4"
                            Background="#1E5F3F">
                        <TextBlock Text="New file will be created"
                                   FontSize="12"
                                   Foreground="#4ADE80" />
                    </Border>
                </StackPanel>

                <!-- Center: Error Message -->
                <Border Grid.Column="1"
                        IsVisible="{Binding ShowError}"
                        Background="#3D0D0D"
                        CornerRadius="4"
                        Padding="12,6"
                        Margin="16,0"
                        VerticalAlignment="Center">
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="#EF4444"
                               TextWrapping="Wrap"
                               MaxWidth="300"
                               VerticalAlignment="Center" />
                </Border>

                <!-- Right: Action Buttons -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="8"
                            VerticalAlignment="Center">

                    <!-- Cancel Button -->
                    <Button Content="Cancel"
                            Command="{Binding CancelCommand}"
                            IsEnabled="{Binding CanCancel}"
                            MinWidth="80" />

                    <!-- Apply Button -->
                    <Button Command="{Binding ApplyCommand}"
                            IsEnabled="{Binding CanApply}"
                            MinWidth="120"
                            Classes="accent">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{Binding ApplyButtonText}" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
