<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:views="using:AIntern.Desktop.Views"
             x:Class="AIntern.Desktop.Views.ChatView"
             x:DataType="vm:ChatViewModel"
             Background="{DynamicResource WindowBackground}">

    <Grid RowDefinitions="Auto, *, Auto">
        <!-- Chat Header -->
        <Border Grid.Row="0"
                Background="{DynamicResource SidebarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,8">
            <Grid ColumnDefinitions="*, Auto">
                <TextBlock Text="Chat"
                           FontWeight="SemiBold"
                           FontSize="14"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextPrimary}" />
                <Button Grid.Column="1"
                        Command="{Binding OpenSystemPromptEditorCommand}"
                        ToolTip.Tip="Edit System Prompts"
                        Theme="{StaticResource SubtleButton}">
                    <PathIcon Data="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25zM20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83l3.75,3.75L20.71,7.04z"
                              Width="16" Height="16"
                              Foreground="{DynamicResource TextPrimary}" />
                </Button>
            </Grid>
        </Border>

        <!-- Messages List -->
        <ScrollViewer Grid.Row="1"
                      x:Name="MessagesScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <Panel>
                <!-- Empty State -->
                <StackPanel IsVisible="{Binding !Messages.Count}"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="16">
                    <TextBlock Text="Welcome to AIntern"
                               FontSize="24"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextPrimary}" />
                    <TextBlock Text="Load a model and start chatting!"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextMuted}" />
                </StackPanel>

                <!-- Messages -->
                <ItemsControl ItemsSource="{Binding Messages}"
                              IsVisible="{Binding Messages.Count}"
                              Margin="16">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <views:ChatMessageControl DataContext="{Binding}"
                                                      Margin="0,8" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Panel>
        </ScrollViewer>

        <!-- Error Display -->
        <Border Grid.Row="1"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource ErrorBackground}"
                Padding="16"
                VerticalAlignment="Top"
                Margin="16">
            <TextBlock Text="{Binding ErrorMessage}"
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource ErrorForeground}" />
        </Border>

        <!-- Input Area -->
        <Border Grid.Row="2"
                Background="{DynamicResource SidebarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16">
            <Grid ColumnDefinitions="*, Auto, Auto" RowDefinitions="Auto">
                <TextBox Grid.Column="0"
                         x:Name="InputTextBox"
                         Text="{Binding UserInput}"
                         Watermark="Type your message... (Enter to send)"
                         AcceptsReturn="False"
                         MaxHeight="150"
                         TextWrapping="Wrap"
                         KeyDown="OnInputKeyDown"
                         Background="{DynamicResource InputBackground}"
                         Foreground="{DynamicResource TextPrimary}" />

                <Button Grid.Column="1"
                        Command="{Binding SendMessageCommand}"
                        Content="Send"
                        Theme="{StaticResource PrimaryButton}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding !IsGenerating}"
                        VerticalAlignment="Bottom" />

                <Button Grid.Column="2"
                        Command="{Binding CancelGenerationCommand}"
                        Content="Stop"
                        Theme="{StaticResource DangerButton}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding IsGenerating}"
                        VerticalAlignment="Bottom" />
            </Grid>
        </Border>
    </Grid>

</UserControl>
