<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:views="using:AIntern.Desktop.Views"
             x:Class="AIntern.Desktop.Views.ChatView"
             x:DataType="vm:ChatViewModel"
             DragDrop.AllowDrop="True"
             Background="{DynamicResource WindowBackground}">

    <!--
        ChatView Layout (v0.2.4e):
        ==========================
        Row 0: System Prompt Selector Header (NEW)
        Row 1: System Prompt Display Expander (NEW)
        Row 2: Messages List (existing)
        Row 3: Input Area (existing)
    -->
    <Grid RowDefinitions="Auto, Auto, *, Auto">

        <!-- ================================================================== -->
        <!-- Drop Zone Indicator (v0.3.4g)                                       -->
        <!-- Appears when files are dragged over the chat area                   -->
        <!-- ================================================================== -->
        <Border x:Name="DropZoneIndicator"
                Grid.RowSpan="4"
                Background="#402196F3"
                BorderBrush="#2196F3"
                BorderThickness="2"
                CornerRadius="8"
                IsVisible="False"
                IsHitTestVisible="False"
                ZIndex="50">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="8">
                <PathIcon Data="{StaticResource AttachmentIcon}"
                          Width="32" Height="32"
                          Foreground="#2196F3" />
                <TextBlock Text="Drop files to attach"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="#2196F3" />
            </StackPanel>
        </Border>

        <!-- ================================================================== -->
        <!-- Row 0: System Prompt Selector Header (v0.2.4e)                     -->
        <!-- Provides quick dropdown selection of system prompts in chat header -->
        <!-- ================================================================== -->
        <Border Grid.Row="0"
                Background="{DynamicResource SidebarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="12,8">
            <views:SystemPromptSelector x:Name="PromptSelector"
                                        DataContext="{Binding SystemPromptSelectorViewModel}" />
        </Border>

        <!-- ================================================================== -->
        <!-- Row 1: System Prompt Display Expander (v0.2.4e)                   -->
        <!-- Shows the active system prompt content in a collapsible panel     -->
        <!-- Only visible when a system prompt is selected                     -->
        <!-- ================================================================== -->
        <Border Grid.Row="1"
                IsVisible="{Binding ShowSystemPromptMessage}"
                Background="{DynamicResource SystemPromptBackgroundColor}"
                Padding="12"
                Margin="12,12,12,0"
                CornerRadius="8">
            <Expander IsExpanded="False">
                <!-- Expander Header: Icon + Prompt Name -->
                <Expander.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="{StaticResource PromptIcon}"
                                  Width="16" Height="16"
                                  Foreground="{DynamicResource TextMuted}" />
                        <TextBlock Text="{Binding SystemPromptName, StringFormat='Using: {0}'}"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextMuted}" />
                    </StackPanel>
                </Expander.Header>

                <!-- Expander Content: Full prompt text (read-only) -->
                <TextBlock Text="{Binding SystemPromptContent}"
                           TextWrapping="Wrap"
                           Foreground="{DynamicResource TextMuted}"
                           FontSize="12"
                           Margin="24,8,0,0" />
            </Expander>
        </Border>

        <!-- ================================================================== -->
        <!-- Row 2: Messages List                                              -->
        <!-- ================================================================== -->
        <ScrollViewer Grid.Row="2"
                      x:Name="MessagesScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <Panel>
                <!-- Empty State -->
                <StackPanel IsVisible="{Binding !Messages.Count}"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="16">
                    <TextBlock Text="Welcome to The Senior Intern"
                               FontSize="24"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextPrimary}" />
                    <TextBlock Text="Load a model and start chatting!"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextMuted}" />
                </StackPanel>

                <!-- Messages -->
                <ItemsControl ItemsSource="{Binding Messages}"
                              IsVisible="{Binding Messages.Count}"
                              Margin="16">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <views:ChatMessageControl DataContext="{Binding}"
                                                      Margin="0,8" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Panel>
        </ScrollViewer>

        <!-- ================================================================== -->
        <!-- Error Display                                                     -->
        <!-- ================================================================== -->
        <Border Grid.Row="2"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource ErrorBackground}"
                Padding="16"
                VerticalAlignment="Top"
                Margin="16">
            <TextBlock Text="{Binding ErrorMessage}"
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource ErrorForeground}" />
        </Border>

        <!-- ================================================================== -->
        <!-- Row 3: Input Area                                                 -->
        <!-- ================================================================== -->
        <Border Grid.Row="3"
                Background="{DynamicResource SidebarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16">
            <Grid ColumnDefinitions="*, Auto, Auto" RowDefinitions="Auto">
                <TextBox Grid.Column="0"
                         x:Name="InputTextBox"
                         Text="{Binding UserInput}"
                         Watermark="Type your message... (Enter to send)"
                         AcceptsReturn="False"
                         MaxHeight="150"
                         TextWrapping="Wrap"
                         KeyDown="OnInputKeyDown"
                         Background="{DynamicResource InputBackground}"
                         Foreground="{DynamicResource TextPrimary}" />

                <Button Grid.Column="1"
                        Command="{Binding SendMessageCommand}"
                        Content="Send"
                        Theme="{StaticResource PrimaryButton}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding !IsGenerating}"
                        VerticalAlignment="Bottom" />

                <Button Grid.Column="2"
                        Command="{Binding CancelGenerationCommand}"
                        Content="Stop"
                        Theme="{StaticResource DangerButton}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding IsGenerating}"
                        VerticalAlignment="Bottom" />
            </Grid>
        </Border>
    </Grid>

</UserControl>
