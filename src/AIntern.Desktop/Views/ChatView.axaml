<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:views="using:AIntern.Desktop.Views"
             x:Class="AIntern.Desktop.Views.ChatView"
             x:DataType="vm:ChatViewModel"
             Background="{DynamicResource WindowBackground}">

    <Grid RowDefinitions="Auto, Auto, *, Auto">
        <!-- Row 0: System Prompt Selector -->
        <views:SystemPromptSelector Grid.Row="0"
                                    DataContext="{Binding SystemPromptSelectorViewModel}" />

        <!-- Row 1: System Prompt Display Expander (conditional) -->
        <Border Grid.Row="1"
                IsVisible="{Binding HasSystemPrompt}"
                Background="{DynamicResource SystemPromptBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <Expander>
                <Expander.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="System Prompt:"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextMuted}"
                                   VerticalAlignment="Center" />
                        <TextBlock Text="{Binding CurrentPromptName}"
                                   FontWeight="Medium"
                                   Foreground="{DynamicResource TextPrimary}"
                                   VerticalAlignment="Center" />
                    </StackPanel>
                </Expander.Header>
                <Border Background="{DynamicResource ControlBackground}"
                        CornerRadius="4"
                        Padding="12"
                        Margin="0,8,0,0"
                        MaxHeight="200">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <TextBlock Text="{Binding CurrentPromptContent}"
                                   TextWrapping="Wrap"
                                   FontFamily="Consolas, Menlo, monospace"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextPrimary}" />
                    </ScrollViewer>
                </Border>
            </Expander>
        </Border>

        <!-- Messages List -->
        <ScrollViewer Grid.Row="2"
                      x:Name="MessagesScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <Panel>
                <!-- Empty State -->
                <StackPanel IsVisible="{Binding !Messages.Count}"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="16">
                    <TextBlock Text="Welcome to AIntern"
                               FontSize="24"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextPrimary}" />
                    <TextBlock Text="Load a model and start chatting!"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextMuted}" />
                </StackPanel>

                <!-- Messages -->
                <ItemsControl ItemsSource="{Binding Messages}"
                              IsVisible="{Binding Messages.Count}"
                              Margin="16">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <views:ChatMessageControl DataContext="{Binding}"
                                                      Margin="0,8" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Panel>
        </ScrollViewer>

        <!-- Error Display -->
        <Border Grid.Row="2"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{DynamicResource ErrorBackground}"
                Padding="16"
                VerticalAlignment="Top"
                Margin="16">
            <TextBlock Text="{Binding ErrorMessage}"
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource ErrorForeground}" />
        </Border>

        <!-- Input Area -->
        <Border Grid.Row="3"
                Background="{DynamicResource SidebarBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="16">
            <Grid ColumnDefinitions="*, Auto, Auto" RowDefinitions="Auto">
                <TextBox Grid.Column="0"
                         x:Name="InputTextBox"
                         Text="{Binding UserInput}"
                         Watermark="Type your message... (Enter to send)"
                         AcceptsReturn="False"
                         MaxHeight="150"
                         TextWrapping="Wrap"
                         KeyDown="OnInputKeyDown"
                         Background="{DynamicResource InputBackground}"
                         Foreground="{DynamicResource TextPrimary}" />

                <Button Grid.Column="1"
                        Command="{Binding SendMessageCommand}"
                        Content="Send"
                        Theme="{StaticResource PrimaryButton}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding !IsGenerating}"
                        VerticalAlignment="Bottom" />

                <Button Grid.Column="2"
                        Command="{Binding CancelGenerationCommand}"
                        Content="Stop"
                        Theme="{StaticResource DangerButton}"
                        Margin="8,0,0,0"
                        IsVisible="{Binding IsGenerating}"
                        VerticalAlignment="Bottom" />
            </Grid>
        </Border>
    </Grid>

</UserControl>
