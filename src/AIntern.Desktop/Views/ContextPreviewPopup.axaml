<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ae="using:AvaloniaEdit"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:views="using:AIntern.Desktop.Views"
             x:Class="AIntern.Desktop.Views.ContextPreviewPopup"
             x:DataType="vm:FileContextViewModel"
             Focusable="True">

    <UserControl.Styles>
        <!-- Icon Button Style -->
        <Style Selector="Button.icon-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="6" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Opacity" Value="0.7" />
        </Style>

        <Style Selector="Button.icon-button:pointerover">
            <Setter Property="Background" Value="{DynamicResource ControlBackground}" />
            <Setter Property="Opacity" Value="1" />
        </Style>

        <!-- Link Button Style -->
        <Style Selector="Button.link-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Foreground" Value="{DynamicResource AccentBrush}" />
            <Setter Property="Padding" Value="4,2" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <Style Selector="Button.link-button:pointerover">
            <Setter Property="Foreground" Value="{DynamicResource AccentHoverBrush}" />
        </Style>

        <Style Selector="Button.link-button.danger">
            <Setter Property="Foreground" Value="{DynamicResource DangerBrush}" />
        </Style>

        <Style Selector="Button.link-button.danger:pointerover">
            <Setter Property="Foreground" Value="#FF8888" />
        </Style>
    </UserControl.Styles>

    <Border Background="{DynamicResource PopupBackgroundBrush}"
            BorderBrush="{DynamicResource PopupBorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            MinWidth="400"
            MaxWidth="700"
            MaxHeight="500"
            BoxShadow="0 4 16 0 #40000000">

        <Grid RowDefinitions="Auto, *, Auto">
            <!-- Header -->
            <Border Grid.Row="0"
                    Background="{DynamicResource PopupHeaderBrush}"
                    CornerRadius="8,8,0,0"
                    Padding="12,8">
                <Grid ColumnDefinitions="Auto, *, Auto, Auto">
                    <!-- File Icon -->
                    <PathIcon Grid.Column="0"
                              Data="{StaticResource FileIcon}"
                              Width="16" Height="16"
                              Margin="0,0,8,0"
                              Foreground="{DynamicResource TextSecondaryBrush}" />

                    <!-- File Name and Path -->
                    <StackPanel Grid.Column="1" Spacing="2">
                        <TextBlock Text="{Binding DisplayLabel}"
                                   FontWeight="SemiBold"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                        <TextBlock Text="{Binding FilePath}"
                                   FontSize="11"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   IsVisible="{Binding FilePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="400" />
                    </StackPanel>

                    <!-- Language Badge -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource BadgeBackgroundBrush}"
                            CornerRadius="4"
                            Padding="6,2"
                            Margin="8,0"
                            VerticalAlignment="Center"
                            IsVisible="{Binding Language, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="{Binding Language}"
                                   FontSize="10"
                                   Foreground="{DynamicResource BadgeForegroundBrush}" />
                    </Border>

                    <!-- Close Button -->
                    <Button Grid.Column="3"
                            Classes="icon-button"
                            Command="{Binding $parent[views:ContextPreviewPopup].CloseCommand}"
                            ToolTip.Tip="Close (Escape)">
                        <PathIcon Data="{StaticResource CloseIcon}"
                                  Width="12" Height="12" />
                    </Button>
                </Grid>
            </Border>

            <!-- Content Area -->
            <Border Grid.Row="1" Padding="1" ClipToBounds="True">
                <ae:TextEditor x:Name="PreviewEditor"
                               IsReadOnly="True"
                               ShowLineNumbers="True"
                               FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                               FontSize="12"
                               Background="{DynamicResource EditorBackgroundBrush}"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               HorizontalScrollBarVisibility="Auto"
                               VerticalScrollBarVisibility="Auto" />
            </Border>

            <!-- Footer -->
            <Border Grid.Row="2"
                    Background="{DynamicResource PopupFooterBrush}"
                    CornerRadius="0,0,8,8"
                    Padding="12,8">
                <Grid ColumnDefinitions="*, Auto, Auto, Auto">
                    <!-- Stats -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                        <TextBlock FontSize="11" Foreground="{DynamicResource TextMutedBrush}">
                            <Run Text="{Binding LineCount}" />
                            <Run Text="lines" />
                        </TextBlock>
                        <TextBlock FontSize="11" Foreground="{DynamicResource TextMutedBrush}">
                            <Run Text="~" />
                            <Run Text="{Binding EstimatedTokens}" />
                            <Run Text="tokens" />
                        </TextBlock>
                    </StackPanel>

                    <!-- Actions -->
                    <Button Grid.Column="1"
                            Content="Open in Editor"
                            Classes="link-button"
                            FontSize="11"
                            Command="{Binding $parent[views:ContextPreviewPopup].OpenInEditorCommand}"
                            IsVisible="{Binding FilePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            Margin="0,0,12,0" />

                    <Button Grid.Column="2"
                            Content="Copy"
                            Classes="link-button"
                            FontSize="11"
                            Command="{Binding $parent[views:ContextPreviewPopup].CopyContentCommand}"
                            Margin="0,0,12,0" />

                    <Button Grid.Column="3"
                            Content="Remove"
                            Classes="link-button danger"
                            FontSize="11"
                            Command="{Binding $parent[views:ContextPreviewPopup].RemoveCommand}" />
                </Grid>
            </Border>
        </Grid>
    </Border>
</UserControl>
